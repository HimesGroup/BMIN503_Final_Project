---
title: "A brief epidemiologic examination of selected communicable diseases in the state of California"
subtitle: "BMIN503/EPID600 Final Project"
author: "Fang (Amy) Liu"
date: last-modified #"`r Sys.Date()`"
date-format: "[Last Updated:] MMM DD, YYYY"
embed-resources: true
execute: 
  echo: true 
  warning: false #hide all warnings in the output 
  message: false
format:
  html:
    self-contained: true
    toc: true
    toc-location: left
    number-sections: true
    code-fold: true
    code-tools:
      source: true #hide the source option
      toggle: true #toggle for code visibility
    code-copy: true #option to copy code
    code-overflow: scroll
    df-print: paged
    code-block-bg: true
    code-block-border-left: "#31BAE9"
theme: flatly
---

------------------------------------------------------------------------

```{r loadpackages, include=FALSE}
library(tidyverse)
library(readr)
library(DT)
library(RColorBrewer) #for fun color palettes
library(tigris) #to download boundary shapefiles from the US census bureau
library(sf)

library(DT)

options(tigris_use_cache = TRUE)
options(progress_enabled = FALSE)
```

# Overview

For my final project, I am looking at trends in the case counts and rates of [infectious diseases reported in California](https://catalog.data.gov/dataset/infectious-diseases-by-disease-county-year-and-sex-d8912) from 2001 to 2021. California regulations require cases of [selected communicable diseases](https://www.cdph.ca.gov/Programs/CID/DCDC/CDPH%20Document%20Library/ReportableDiseases.pdf) to be reported (PDF) to the California Department of Public Health (CDPH); CDPH work with and local health departments to monitor cases and to identify, control, and prevent infections. I want to see if there is a increase in the number of diseases in the past two decades and more specifically identify which disease is becoming more frequent; I'd like to look at the spatial distribution of the diseases as well to identify potential hot spots. I spoke with two DBEI faculties (Quy Cao and Haochang Shou), as well as my coworker who is a wonderful data analyst. They provided valuable feedback on what to include and data visualizations, as well as asking questions that helped me dive a bit deeper into the dataset (e.g., doing more research on the diseases, identifying potential reasons for increasing cases, and etc).

[Link to my final project GitHub Repo!](https://github.com/amyfliu/BMIN503_Final_Project)

# Introduction

For some brief background, the California Department of Public Health (CDPH) maintains a passive reporting system for a list of communicable disease cases and outbreaks mandated by state law and regulation. A full list of selected communicable diseases can be found [here](https://www.cdph.ca.gov/Programs/CID/DCDC/CDPH%20Document%20Library/ReportableDiseases.pdf). Healthcare providers are required to report cases of these diseases to local health departments, which in turn report these cases to the CDPH. Tracking and monitor these diseases is very important because it helps us understand the magnitude and burden of specific diseases, quickly identify disease outbreaks, and also help us identify potential risk groups which we can then design targeted intervention strategies and actions, as well as assessing the effectiveness of any control or prevention efforts.

In simple words, surveillance is a fundamental bedrock of public health. Usually when everything is normal and nothing bad happens, the public is unaware of the public surveillance that is occuring in the background. Only when there is a big outbreak will the public then realize the importance of active disease monitoring. Public health surveillance is itself a really interdisciplinary team effort - first you need providers and laboratories reporting these cases to local health departments, which is potentially followed by fieldwork to examine and identify sources of outbreaks, then the Department of Health aggregates these information across regions and entire data analyst teams are dedicated to cleaning and extracting valuable information from the data to identify potential risk factors and inform future prevention planning. This final data project is a great way for me to get some hands-on practice on a actual surveillance dataset to extract patterns and see how data and evidence-based approaches can help us allocate resources to who needs them the most.

# Methods

First, for exploratory analysis, I aggregated data across all years for each reported disease and identified the top 10 diseases by cumulative case count. Next, I looked at the trend more closely year by year for a few selected diseases to see if there has been a drastic decrease or increase in cases over the years. General trends for the diseases are described. In addition, I wanted to look at the spatial distribution for each disease to identify which region or population are affected more. Potential explanations of disease trends are provided when relevant. Knowing the distribution of these diseases can help us with resource allocation and more targeted intervention.

```{r}
# load data dictionary 
dictionary <- readxl::read_excel("~/Desktop/BMIN5030/final_project/data/data_dictionary.xlsx", skip = 1) %>% 
  janitor::clean_names() %>% 
  rename(variable = column_name) %>% 
  select(variable, definition)

# load infectious disease data 
infectious_data <- readr::read_csv("~/Desktop/BMIN5030/final_project/data/infectious_diseases_by_county_year_and_sex.csv") %>% 
  janitor::clean_names()

infectious_data %>% 
  filter(disease == "Malaria") %>% 
  #filter(county == "San Francisco") %>% 
  head(500) %>% 
  datatable(
    caption = htmltools::tags$caption(
    style = 'caption-side: top; text-align: left;',
    'Table 1: Sample of the original data.'),
    options = list(scrollCollapse = T,
                         scrollY = '40vh',  
                         scrollX = "30vh",
                         pageLength = 50)) 
```

| variable   |                                                                                                 definition |
|---------------------------------|--------------------------------------:|
| Disease    |                                                              The name of the Infectious Diseases reported. |
| County     |                         The county in which the case resided when they were diagnosed and State-wide total |
| Year       |         Estimated onset date is the date closest to the time when symptoms first appeared from 2001 - 2021 |
| Sex        |                                                              The patient's sex as reported by the provider |
| Cases      | The \# of cases reported per disease meeting the surveillance case definition by County, Year, and County. |
| Population |          The estimated population size (rounded to the nearest integer) for each County, Year, Sex strata. |
| Rate       |                                               \# of cases per 100,000 population per County, Year, and Sex |

: Data Dictionary

# Results

## Exploratory analysis

> Identify the most common diseases.

```{r}
# total number of cases (2001 - 2021)
total_cases <- infectious_data %>% 
  filter(county == "California") %>% #state level data
  filter(sex == "Total") %>% 
  group_by(disease) %>% 
  summarize(total_cases = sum(cases)) %>% 
  arrange(desc(total_cases)) %>% 
  head(10)

# Create a bar plot using ggplot2
ggplot(total_cases, 
       aes(#x = disease, 
           x = fct_reorder(disease, total_cases),
           y = total_cases)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Top 10 Reportable Communicable Diseases by Cumulative Case Count", 
       subtitle = "California, 2001 - 2021",
       x = "Disease", y = "Total Cases") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels for readability
  coord_flip()  # Flip the plot horizontally
```

**The top 3 diseases by case count is Campylobacteriosis, Salmonellosis, and Coccidioidomycosis.**

> Look at the trend in top diseases in the past two decades.

::: panel-tabset
### Campylobacteriosis

```{r}
# how many cases of each disease per year 
diseases <- infectious_data %>% 
  filter(county == "California") %>% #state level data
  filter(sex == "Total") %>% #across all cases 
  mutate(rate = as.numeric(rate)) %>%  #convert rate to numeric
  filter(cases > 0) %>% 
  select(disease, year, cases) 

# diseases %>% filter(disease == "Campylobacteriosis") %>% 
#   #filter(year < 2019 & year > 2012) %>% 
#   ggplot(aes(x = year, y = cases))+
#   geom_line() +
#   coord_cartesian(ylim = c(0, max(diseases$cases)))  # Set y-axis limits

# Create a bar plot for Campylobacteriosis cases
diseases %>% filter(disease == "Campylobacteriosis") %>% #Campylobacteriosis, Salmonellosis
  #filter(year < 2020 & year > 2012) %>% 
  ggplot(aes(x = year, y = cases)) +
  geom_bar(stat = "identity", fill = "#66c2a5") +
  geom_text(aes(label = signif(cases)), nudge_y = 150, size = 2.8) +
  #geom_line() +
  labs(title = "Campylobacteriosis Cases by Year", x = "Year", y = "Number of Cases") +
  theme_bw()
```

**The number of people who get sick from the Campylobacter bacteria has been increasing steadily since 2004. The significant drop observed in year 2020 is likely impacted by COVID, an timepoint at which most health resources are divested toward controlling the new SARs-Cov2 Virus. Another reason why we see this drop is perhaps less people eating out so there is fewer fewer food-related outbreaks.**

### Salmonellosis

Salmonellosis is an infection with a bacteria called Salmonella, which usually live in the intestinal tracts of animals. Salmonella are usually transmitted to humans by eating foods contaminated with animal feces. Contaminated foods are often of animal origin (e.g., poultry, pork, poultry, etc). Common symptoms include diarrhea, abdominal pain and cramps, and fever.

```{r}
disease_of_interest <- "Salmonellosis"

diseases %>% filter(disease == disease_of_interest) %>% #Campylobacteriosis, Salmonellosis
  #filter(year < 2020 & year > 2012) %>% 
  ggplot(aes(x = year, y = cases)) +
  geom_bar(stat = "identity", fill = "#fc8d62") +
  geom_text(aes(label = signif(cases)), nudge_y = 100, size = 2.8) +
  #geom_line() +
  labs(title = paste0(disease_of_interest, " Cases by Year"), x = "Year", y = "Number of Cases") +
  theme_bw()
```

### Coccidioidomycosis

Cocci or Valley fever is a disease caused by a fungus that grows in the soil and dirt in some areas of California and southwestern US. People get sick when they breathe in dust that contains Valley fever fungus. Valley fever can be serious and fatal. Currently there is no vaccine to prevent cocci but antifungals medications are available.

```{r}
disease_of_interest <- "Coccidioidomycosis"

diseases %>% filter(disease == disease_of_interest) %>% #Campylobacteriosis, Salmonellosis
  #filter(year == 2019) %>% 
  ggplot(aes(x = year, y = cases)) +
  geom_bar(stat = "identity", fill = "#8da0cb") +
  geom_text(aes(label = signif(cases)), nudge_y = 150, size = 2.8) +
  #geom_line() +
  labs(title = paste0(disease_of_interest, " Cases by Year"), x = "Year", y = "Number of Cases") +
  theme_bw()
```
:::

## Spatial distribution of diseases

### Campylobacteriosis

```{r, eval=T}
avg_rates <- infectious_data %>% 
  filter(disease == "Campylobacteriosis") %>% 
  filter(county != "California") %>% #state level data
  filter(sex == "Total") %>% 
  mutate(rate2 = cases * 100000/population) %>% 
  select(county, year, rate2) %>% 
  #filter(county == "Alameda") %>% 
  group_by(county) %>% 
  summarize(avg_rate = round(mean(rate2),3)) %>% 
  arrange(desc(avg_rate))

# table of 95% CI for each lesion
datatable(avg_rates,
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: left;',
            'Table 2: Average annual rate of new campylobacteriosis cases by county.'),
          options = list(scrollCollapse = T,
                         scrollY = '30vh',  
                         scrollX = "30vh",
                         pageLength = 30)) 
```

::: callout-tip
## Findings

**The average annual rate of new campylobacteriosis cases during 2001-2021 was about `r round(mean(avg_rates$avg_rate))` cases per 100,000 people in California. The average rates were highest in San Francisco County (about `r round(mean(head(avg_rates$avg_rate,1)))` cases per 100,000 people) and lowest in Alpine County (`r round(mean(tail(avg_rates$avg_rate,1)))` cases per 100,000 people).**
:::

```{r, eval=T}
# load counties shapefile for CA
ca_2021 <- tigris::counties(state = "CA", year = 2021)

# join two datasets so we have the incidence data for each county 
ca_2021_rates <- inner_join(ca_2021, avg_rates, 
                             by = c("NAME" = "county"))

# static plot
 # ggplot() +
 #   geom_sf(data = tigris::counties(state = "CA", year = 2015))

my_theme <- function() {
  theme_minimal() +  # shorthand for white background color
  theme(axis.line = element_blank(),  # further customization of theme components
        axis.text = element_blank(),  # remove x and y axis text and labels
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  # make grid lines invisible
        legend.key.size = unit(0.8, "cm"),           # increase size of legend
        legend.text = element_text(size = 14),       # increase legend text size
        legend.title = element_text(size = 14))      # increase legend title size
}

# customized plot
myPalette <- colorRampPalette(brewer.pal(9, "PuBu"))  # RColorBrewer palette

# plot a point on the map 
places.df <- data.frame(places = c("San Francisco", "Alpine"), 
                 lat = c(37.7272391,
                         38.6217831), 
                 lon = c(-123.0322294,
                         -119.7983522))

my_locations_sf <- st_as_sf(places.df, coords = c("lon", "lat"), 
                            crs = 4326)

ggplot() +
  geom_sf(data = ca_2021_rates, aes(fill = avg_rate)) +
  geom_sf(data = my_locations_sf, color = "red", alpha = 0.8, size = 1.2) +
  my_theme() + 
  ggtitle("Average Annual Incidence Rates of Campylobacteriosis \nby County, CA, 2001-2021") + 
  scale_fill_gradientn(name = "Rate per \n100,000 Population",      
                    colours = myPalette(100))   
```

### Coccidioidomycosis

```{r, eval=T}
targeted_disease <- "Coccidioidomycosis"

avg_rates <- infectious_data %>% 
  filter(disease == targeted_disease) %>% 
  filter(county != "California") %>% #state level data
  filter(sex == "Total") %>% 
  mutate(rate2 = cases * 100000/population) %>% 
  select(county, year, rate2) %>% 
  group_by(county) %>% 
  summarize(avg_rate = round(mean(rate2),3)) %>% 
  arrange(desc(avg_rate))

# table of 95% CI for each lesion
datatable(avg_rates,
          caption = htmltools::tags$caption(
            style = 'caption-side: top; text-align: left;',
            'Table 2: Average annual rate of new Coccidioidomycosis cases by county.'),
          options = list(scrollCollapse = T,
                         scrollY = '30vh',  
                         scrollX = "30vh",
                         pageLength = 30)) 

# join two datasets so we have the incidence data for each county 
ca_2021_cocci <- inner_join(ca_2021, avg_rates, 
                             by = c("NAME" = "county"))
```

```{r}
# Define the bin breaks and labels for your specific data
bin_breaks <- c(0, 5, 20, 50, 100, Inf)
bin_labels <- c("<5", "5-20", "20-50", "50-100", ">100")

# Create a new column that categorizes avg_rate into bins
ca_2021_cocci$rate_category <- cut(ca_2021_cocci$avg_rate, 
                                   breaks = bin_breaks, 
                                   labels = bin_labels, 
                                   right = FALSE)

# Create a custom color palette for the categories
#custom_palette <- c("#f0f9e8", "#bae4bc", "#7bccc4", "#43a2ca", "#0868ac")
custom_palette <- c("#eff3ff", "#bdd7e7","#6baed6","#3182bd", "#08519c")

# Create the choropleth map with the custom palette
ggplot() +
  geom_sf(data = ca_2021_cocci, aes(fill = rate_category)) +
  my_theme() + 
  ggtitle("Average Annual Incidence Rates of Coccidioidomycosis \nby County, CA, 2001-2021") + 
  scale_fill_manual(name = "Rate per 100,000 Population", 
                    values = setNames(custom_palette, levels(ca_2021_cocci$rate_category)))+
  labs(fill = "Rate Category")
```

**The average annual incidence rate from 2001 to 2021 was highest in Kern County (207 per 100,000), followed by Kings County (114 per 100,000). Overall, most cases of Valley fever in California are reported in people who live in the Central Valley and Central Coast regions.**

# Relevant Links

- [Downloadable data for this project](https://catalog.data.gov/dataset/infectious-diseases-by-disease-county-year-and-sex-d8912) 

- [Epidemiologic Summaries of Selected Communicable Diseases in California](https://www.cdph.ca.gov/Programs/CID/DCDC/Pages/EpiSummariesofCDsCA.aspx)

- [List of reportable communicable diseases for California](https://www.cdph.ca.gov/Programs/CID/DCDC/CDPH%20Document%20Library/ReportableDiseases.pdf)

- [Infectious diseases case report forms](https://www.cdph.ca.gov/Programs/PSB/Pages/CommunicableDiseaseControl.aspx)
