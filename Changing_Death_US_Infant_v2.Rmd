---
title: "Changing Nature of Death in Infany in the United States"
author: "Kevin Dysart"
date: "12/8/2019"
output: 
  html_document:
            toc: true
            toc_depth: 3
            toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading packages, echo=FALSE, warning=FALSE, message=FALSE}
library("tidyverse")
library("urbnmapr")
library("lubridate")
library("survival")
library("survminer")
library("RColorBrewer")
library("knitr")
library("plotrix")
library("ggfortify")
library("broom")
```

## Overview

Using the linked birth and death certificate data collected by the CDC the project aims to evaluate the changing nature of death amongst infants born less than 32 weeks gestation or 1,500g. Increasing use of clinical tools and therapeutic interventions, combined with a perceived shift in parent and clinician attitudes regarding the aggresive pursuit of life in this cohort, may be leading to an increasing time before death over the last 20 years. 

## Introduction

Infants born less than 32 weeks or 1,500g of completed gestation continue to experience high mortality rates. Amongst infants in this category, those of the lowest gestational ages have the highest risk of mortality. Over the last 20 years, the presence of neonatal intensive care units have made intensive care therapies more available to an increasing number of infants. This availability, in combination with more aggressive support for infants at the youngest gestational ages, is leading to a small increase in survival over time. To this point in neonatal medicine, deaths typically occur early in the lives of infants in this cohort as a consequence of the extreme immaturity of their physiology. They simply are not able to be supported by current technologies. While the aforementioned increasing survival is well described, it continues to be poorly studied and understood how these shifts in care paradigms are impacting timing to death in infants that do die in infancy.

Extending the lives of infants before their death has a profound impact on a multitude of people, from parents to caregivers to society itself. Parents face life's greatest challenge, loving and supporting a child through their life and ultimate death. Support systems that currently exist to assist them include parent support groups, social work teams, and in many care settings, psychologic support. A growing pull exists between what often become unrealistic expectations and the realities of what medical care can and cannot offer. Extending the lives of infants in this cohort may represent a growing improvement in care delivery and therapeutic intervention or it may represent futile care that can only extend but not save lives. Continually caring for an infant will not ultimately survive places burdens on parents and medical professionals that have lasting effects. Families must process the trauma resultant from losing a child and care teams must rise to invest the emotional and intellectual energy repeadetly in situations that begin to seem more hopeless over time. Provider burnout and moral injury have many causes, but providing futile care is certainly among them. Lastly society itself is faced with many issues as a result, including lost economic productivity caused by parental time away from work and the growing cost of care for such infants, to name only two.

## Methods
Data files were downloaded from the CDC and the NBER and stored locally. They are read into individual lists of data frames to be used in the subsequent analysis.
### Included Datasets Include: 
- Linked Infant Birth and Death Certificagte Data.
  - Yearly: 1995-2013.
- Infant mortality data from the CDC Wonder query of the linked dataset.
  - Yearly: 1995-2017.
- Infant mortality data from the CDC Wonder query of the linked dataset for ELBW and VLBW infants.
  - Yearly: 1995-2017.
- Infant mortality data from the CDC Wonder query of the linked dataset for the years 2007 through 2017 by race.

### Data Cleaning and Preparation

The majority of the data cleaning and preparation R chunks are presented here for reproducibility. 

```{r reading in dataframes for slides, echo=TRUE, warning=FALSE, message=FALSE}
#Reading CDC Wonder Data Files as a list of data frames.
Wonder_File_Names <- list.files(path = "Linked_Birth_Death_Data/CDC_Wonder_All_Death_By_Year/", pattern = "*.txt")
Wonder_Files <- list.files(path = "Linked_Birth_Death_Data/CDC_Wonder_All_Death_By_Year/", pattern = "*.txt", full.names = T)
Wonder_Files_df <- lapply(Wonder_Files, read.delim)
names(Wonder_Files_df) <- Wonder_File_Names
#Reading Linked Birth and Death Data as a list of data frames.
Linked_Birth_Death_Names <- list.files(path = "Linked_Birth_Death_Data/Linked_Year_CSV_Zip/", pattern = "*.csv.zip")
Linked_Birth_Death_Files <- list.files(path = "Linked_Birth_Death_Data/Linked_Year_CSV_Zip/", pattern = "*.csv.zip", full.names = T)
Linked_Birth_Death_Files_df <- lapply(Linked_Birth_Death_Files, read_csv)
names(Linked_Birth_Death_Files_df) <- Linked_Birth_Death_Names
```

```{r removing Notes column, echo=TRUE, warning=FALSE, message=FALSE}
for (i in 1:length(Wonder_Files_df)) {
  Wonder_Files_df[[i]] <-  Wonder_Files_df[[i]] %>%
                    select(-Notes) %>%
                    slice(1:51)
}
```

```{r Reading in IMR files for VLBW and ELBW, echo=TRUE, warning=FALSE, message=FALSE}
## Reading in IMR files from CDC 1995 through 2017 ELBW VLBW.
IMR_VLBW_ELBW_Names <- list.files(path = "Linked_Birth_Death_Data/IMR_VLBW_ELBW/", pattern = "*.txt")
IMR_VLBW_ELBW_Files <- list.files(path = "Linked_Birth_Death_Data/IMR_VLBW_ELBW/", pattern = "*.txt", full.names = T)
IMR_VLBW_ELBW_df <- lapply(IMR_VLBW_ELBW_Files, read.delim)
names(IMR_VLBW_ELBW_df) <- IMR_VLBW_ELBW_Names
## Cleaning each dataframe in the list. ELBW and VLBW Dataframes are paired down the list.
ELBW_1995 <- IMR_VLBW_ELBW_df[[1]] %>%
                select(-Notes) %>%
                    slice(1:4)
VLBW_1995 <- IMR_VLBW_ELBW_df[[2]] %>%
                select(-Notes) %>%
                    slice(1:4)
ELBW_1999 <- IMR_VLBW_ELBW_df[[3]] %>%
                select(-Notes) %>%
                    slice(1:4)
VLBW_1999 <- IMR_VLBW_ELBW_df[[4]] %>%
                select(-Notes) %>%
                    slice(1:4)
ELBW_2003 <- IMR_VLBW_ELBW_df[[5]] %>%
                select(-Notes) %>%
                    slice(1:4)
VLBW_2003 <- IMR_VLBW_ELBW_df[[6]] %>%
                select(-Notes) %>%
                    slice(1:4)
ELBW_2007 <- IMR_VLBW_ELBW_df[[7]] %>%
                select(-Notes) %>%
                    slice(1:11)
VLBW_2007 <- IMR_VLBW_ELBW_df[[8]] %>%
                select(-Notes) %>%
                    slice(1:11)
All_ELBW_IMR <- do.call("rbind", list(ELBW_1995, ELBW_1999, ELBW_2003, ELBW_2007))
All_VLBW_IMR <- do.call("rbind", list(VLBW_1995, VLBW_1999, VLBW_2003, VLBW_2007))
##Creating a grouping variable for data cohorts
All_VLBW_IMR$Year.Group <- c(rep("1995-1998", 4), rep("1999-2002", 4),
                             rep("2003-2006", 4), rep("2007-2017", 11))
All_ELBW_IMR$Year.Group <- c(rep("1995-1998", 4), rep("1999-2002", 4),
                             rep("2003-2006", 4), rep("2007-2017", 11))
All_ELBW_IMR$Year.Group <- as.factor(All_ELBW_IMR$Year.Group)
All_VLBW_IMR$Year.Group <- as.factor(All_VLBW_IMR$Year.Group)
```

```{r Cleaning Data for IMR Description, echo=TRUE, warning=FALSE, message=FALSE}
## Demographic data cleaning
linked_1995 <- Linked_Birth_Death_Files_df[[1]]
linked_1995_VLBW <- filter(linked_1995, dbirwt<1500)
Percent_1995_IMR_VLBW <- length(linked_1995_VLBW$matchs)/length(linked_1995$matchs)
linked_2017 <- Linked_Birth_Death_Files_df[[19]]
linked_2017_VLBW <- filter(linked_2017, dbwt<1500)
Percent_2017_IMR_VLBW <- length(linked_2017_VLBW$idnumber)/length(linked_2017$idnumber)
linked_1995_ELBW <- filter(linked_1995, dbirwt<1000)
linked_2017_ELBW <- filter(linked_2017, dbwt<1000)
Percent_1995_IMR_ELBW <- length(linked_1995_ELBW$matchs)/length(linked_1995$matchs)
Percent_2017_IMR_ELBW <- length(linked_2017_ELBW$idnumber)/length(linked_2017$idnumber)
linked_1995_lt_23 <- filter(linked_1995, gestat<23)
linked_2017_lt_23 <- filter(linked_2017, combgest<23)
Percent_1995_IMR_lt_23 <- length(linked_1995_lt_23$matchs)/length(linked_1995$matchs)
Percent_2017_IMR_lt_23 <- length(linked_2017_lt_23$idnumber)/length(linked_2017$idnumber)
```

```{r Creating Data Frames for boxplot of age of death, echo=TRUE, warning=FALSE, message=FALSE}

##This chunk creates a large set of data frames for the year of birth for each infant in the linked death and birth certificate data. Because infants less than 22 weeks have not routinely been offered care in the United States unitl recent years. VLBW and ELBW data frames. Unfortunately each data frame needs to be dealt with from the list of data frames separately. Over the approximately 20 year time period variables have been added to the birth or death certificate 

##ELBW Infants
ELBW_1995_linked_ad <- Linked_Birth_Death_Files_df[[1]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_1996_linked_ad <- Linked_Birth_Death_Files_df[[2]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_1997_linked_ad <- Linked_Birth_Death_Files_df[[3]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_1998_linked_ad <- Linked_Birth_Death_Files_df[[4]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_1999_linked_ad <- Linked_Birth_Death_Files_df[[5]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_2000_linked_ad <- Linked_Birth_Death_Files_df[[6]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_2001_linked_ad <- Linked_Birth_Death_Files_df[[7]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_2002_linked_ad <- Linked_Birth_Death_Files_df[[8]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1000) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
ELBW_2003_linked_ad <- Linked_Birth_Death_Files_df[[9]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2004_linked_ad <- Linked_Birth_Death_Files_df[[10]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2005_linked_ad <- Linked_Birth_Death_Files_df[[11]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2006_linked_ad <- Linked_Birth_Death_Files_df[[12]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2007_linked_ad <- Linked_Birth_Death_Files_df[[13]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2008_linked_ad <- Linked_Birth_Death_Files_df[[14]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2009_linked_ad <- Linked_Birth_Death_Files_df[[15]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2010_linked_ad <- Linked_Birth_Death_Files_df[[16]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2011_linked_ad <- Linked_Birth_Death_Files_df[[17]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2012_linked_ad <- Linked_Birth_Death_Files_df[[18]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
ELBW_2013_linked_ad <- Linked_Birth_Death_Files_df[[19]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 

ELBW_rbind_ad <- do.call("rbind", list(ELBW_1995_linked_ad,
                                       ELBW_1996_linked_ad,
                                       ELBW_1997_linked_ad,
                                       ELBW_1998_linked_ad,
                                       ELBW_1999_linked_ad,
                                       ELBW_2000_linked_ad,
                                       ELBW_2001_linked_ad,
                                       ELBW_2002_linked_ad,
                                       ELBW_2003_linked_ad,
                                       ELBW_2004_linked_ad,
                                       ELBW_2005_linked_ad,
                                       ELBW_2006_linked_ad,
                                       ELBW_2007_linked_ad,
                                       ELBW_2008_linked_ad,
                                       ELBW_2009_linked_ad,
                                       ELBW_2010_linked_ad,
                                       ELBW_2011_linked_ad,
                                       ELBW_2012_linked_ad,
                                       ELBW_2013_linked_ad))
ELBW_rbind_ad$Year <- as.factor(ELBW_rbind_ad$Year)
ELBW_rbind_ad_group <- group_by(ELBW_rbind_ad, Year)
##User function to compute standard error.
se <- function(x) {
  sqrt(var(x)/length(x))
}
##Summary table for ELBW Infants
ELBW_rbind_ad_summ <- summarise(ELBW_rbind_ad_group, mean_aged = mean(aged),
                                median_aged = median(aged), 
                                sd_aged = sd(aged),
                                se_aged = se(aged),
                                se_2_aged = std.error(aged),
                                n=n())
##VLBW Infants
VLBW_1995_linked_ad <- Linked_Birth_Death_Files_df[[1]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_1996_linked_ad <- Linked_Birth_Death_Files_df[[2]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_1997_linked_ad <- Linked_Birth_Death_Files_df[[3]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_1998_linked_ad <- Linked_Birth_Death_Files_df[[4]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_1999_linked_ad <- Linked_Birth_Death_Files_df[[5]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_2000_linked_ad <- Linked_Birth_Death_Files_df[[6]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_2001_linked_ad <- Linked_Birth_Death_Files_df[[7]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_2002_linked_ad <- Linked_Birth_Death_Files_df[[8]] %>%
                select(biryr, aged, dbirwt, gestat) %>%
                filter(dbirwt<1500) %>%
                filter(gestat > 22) %>%
                rename(Year=biryr, GA=gestat, BW=dbirwt) 
VLBW_2003_linked_ad <- Linked_Birth_Death_Files_df[[9]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2004_linked_ad <- Linked_Birth_Death_Files_df[[10]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2005_linked_ad <- Linked_Birth_Death_Files_df[[11]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2006_linked_ad <- Linked_Birth_Death_Files_df[[12]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2007_linked_ad <- Linked_Birth_Death_Files_df[[13]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2008_linked_ad <- Linked_Birth_Death_Files_df[[14]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1000) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2009_linked_ad <- Linked_Birth_Death_Files_df[[15]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2010_linked_ad <- Linked_Birth_Death_Files_df[[16]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2011_linked_ad <- Linked_Birth_Death_Files_df[[17]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2012_linked_ad <- Linked_Birth_Death_Files_df[[18]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 
VLBW_2013_linked_ad <- Linked_Birth_Death_Files_df[[19]] %>%
                select(dob_yy, aged, dbwt, combgest) %>%
                filter(dbwt<1500) %>%
                filter(combgest > 22) %>%
                rename(Year=dob_yy, GA=combgest, BW=dbwt) 

VLBW_rbind_ad <- do.call("rbind", list(VLBW_1995_linked_ad,
                                       VLBW_1996_linked_ad,
                                       VLBW_1997_linked_ad,
                                       VLBW_1998_linked_ad,
                                       VLBW_1999_linked_ad,
                                       VLBW_2000_linked_ad,
                                       VLBW_2001_linked_ad,
                                       VLBW_2002_linked_ad,
                                       VLBW_2003_linked_ad,
                                       VLBW_2004_linked_ad,
                                       VLBW_2005_linked_ad,
                                       VLBW_2006_linked_ad,
                                       VLBW_2007_linked_ad,
                                       VLBW_2008_linked_ad,
                                       VLBW_2009_linked_ad,
                                       VLBW_2010_linked_ad,
                                       VLBW_2011_linked_ad,
                                       VLBW_2012_linked_ad,
                                       VLBW_2013_linked_ad))
VLBW_rbind_ad$Year <- as.factor(VLBW_rbind_ad$Year)
VLBW_rbind_ad_group <- group_by(VLBW_rbind_ad, Year)
VLBW_rbind_ad_summ <- summarise(VLBW_rbind_ad_group, mean_aged = mean(aged),
                                median_aged = median(aged), 
                                sd_aged = sd(aged),
                                se_aged = se(aged),
                                n=n())
## Filter the dataframes based on surviving more than 7 days.
ELBW_surv_8d <- filter(ELBW_rbind_ad_group, aged>7)
VLBW_surv_8d <- filter(VLBW_rbind_ad_group, aged>7)
## Create Summary tables for ELBW and VLBW that survive more than 7 days.
ELBW_surv_8d_group <- group_by(ELBW_surv_8d, Year)
VLBW_surv_8d_group <- group_by(VLBW_surv_8d, Year)
ELBW_surv_8d_summ <- summarise(ELBW_surv_8d_group, mean_aged = mean(aged),
                                median_aged = median(aged), 
                                sd_aged = sd(aged),
                                se_aged = se(aged),
                                n=n())
VLBW_surv_8d_summ <- summarise(VLBW_surv_8d_group, mean_aged = mean(aged),
                                median_aged = median(aged), 
                                sd_aged = sd(aged),
                                se_aged = se(aged),
                                n=n())
```

```{r Creating Data frames for Kaplan Meier Analysis, echo=TRUE, warning=FALSE, message=FALSE}
km_infant_deaths_1995_VLBW <- Linked_Birth_Death_Files_df[[1]] %>%
                      dplyr::filter(dbirwt < 1500) %>%
                      dplyr::filter(gestat>22) %>%
                      dplyr::select(aged, biryr, csex, mrace3) %>%
                      dplyr::rename(dob_yy = biryr, sex = csex, mracerec = mrace3) %>%
                      dplyr::mutate(race = ifelse((mracerec==1), "white", 
                                          ifelse((mracerec==3), "black", "other"))) %>%
                      dplyr::mutate(sex=ifelse(sex==1,"M","F")) %>%
                      dplyr::select(-mracerec) %>%
                      dplyr::mutate(status=1)
km_infant_deaths_1995_ELBW <- Linked_Birth_Death_Files_df[[1]] %>%
                      dplyr::filter(dbirwt < 1000) %>%
                      dplyr::filter(gestat>22) %>%
                      dplyr::select(aged, biryr, csex, mrace3) %>%
                      dplyr::rename(dob_yy = biryr, sex = csex, mracerec = mrace3) %>%
                      dplyr::mutate(race = ifelse((mracerec==1), "white", 
                                          ifelse((mracerec==3), "black", "other"))) %>%
                      dplyr::mutate(sex=ifelse(sex==1,"M","F")) %>%
                      dplyr::select(-mracerec) %>%
                      dplyr::mutate(status=1)
km_infant_deaths_2007_VLBW <- Linked_Birth_Death_Files_df[[13]] %>%
                      dplyr::filter(dbwt < 1500) %>%
                      dplyr::filter(combgest > 22) %>%
                      dplyr::select(aged, dob_yy, sex, mracerec) %>%
                      dplyr::mutate(race = ifelse((mracerec==1), "white", 
                                          ifelse((mracerec==2), "black", "other"))) %>%
                      dplyr::select(-mracerec) %>%
                      dplyr::mutate(status=1)
km_infant_deaths_2007_ELBW <- Linked_Birth_Death_Files_df[[13]] %>%
                      dplyr::filter(dbwt < 1000) %>%
                      dplyr::filter(combgest > 22) %>%
                      dplyr::select(aged, dob_yy, sex, mracerec) %>%
                      dplyr::mutate(race = ifelse((mracerec==1), "white", 
                                          ifelse((mracerec==2), "black", "other"))) %>%
                      dplyr::select(-mracerec) %>%
                      dplyr::mutate(status=1)
km_infant_deaths_2013_VLBW <- Linked_Birth_Death_Files_df[[19]] %>%
                      dplyr::filter(dbwt < 1500) %>%
                      dplyr::filter(combgest > 22) %>%
                      dplyr::select(aged, dob_yy, sex, mracerec) %>%
                      dplyr::mutate(race = ifelse((mracerec==1), "white", 
                                          ifelse((mracerec==2), "black", "other"))) %>%
                      dplyr::select(-mracerec) %>%
                      dplyr::mutate(status=1)
km_infant_deaths_2013_ELBW <- Linked_Birth_Death_Files_df[[19]] %>%
                      dplyr::filter(dbwt < 1000) %>%
                      dplyr::filter(combgest > 22) %>%
                      dplyr::select(aged, dob_yy, sex, mracerec) %>%
                      dplyr::mutate(race = ifelse((mracerec==1), "white", 
                                          ifelse((mracerec==2), "black", "other"))) %>%
                      dplyr::select(-mracerec) %>%
                      dplyr::mutate(status=1)

km_infant_deaths_VLBW <- do.call("rbind", list(km_infant_deaths_1995_VLBW, 
                                               km_infant_deaths_2007_VLBW,
                                               km_infant_deaths_2013_VLBW))
km_infant_deaths_ELBW <- do.call("rbind", list(km_infant_deaths_1995_ELBW, 
                                               km_infant_deaths_2007_ELBW,
                                               km_infant_deaths_2013_ELBW))
km_infant_deaths_VLBW$race <- as.factor(km_infant_deaths_VLBW$race)
km_infant_deaths_ELBW$race <- as.factor(km_infant_deaths_ELBW$race)
km_infant_deaths_VLBW$sex <- as.factor(km_infant_deaths_VLBW$sex)
km_infant_deaths_ELBW$sex <- as.factor(km_infant_deaths_ELBW$sex)
```

```{r racial differences in IMR, echo=TRUE, message=FALSE, warning=FALSE}
IMR_By_Race_2014_2017 <- read_delim("Linked_Birth_Death_Data/IMR_By_Race_2014_2017.txt","\t", escape_double = FALSE, trim_ws = TRUE)
black_IMR_14_17 <- IMR_By_Race_2014_2017 %>%
                    select(State, 
                           "Mother's Bridged Race",
                           Births, Deaths) %>%
                    rename(race="Mother's Bridged Race", state_name=State) %>%
                    filter(race == "Black or African American")

black_IMR_14_17$Deaths <- as.numeric(black_IMR_14_17$Deaths)
black_IMR_14_17$IMR <- (black_IMR_14_17$Deaths/black_IMR_14_17$Births)*1000

black_IMR_map_14_17 <- left_join(black_IMR_14_17, states, 
                                 by = "state_name")
white_IMR_14_17 <- IMR_By_Race_2014_2017 %>%
  select(State, 
         "Mother's Bridged Race",
         Births, Deaths) %>%
  rename(race="Mother's Bridged Race", state_name=State) %>%
  filter(race == "White")

white_IMR_14_17$Deaths <- as.numeric(white_IMR_14_17$Deaths)
white_IMR_14_17$IMR <- (white_IMR_14_17$Deaths/white_IMR_14_17$Births)*1000   

white_IMR_map_14_17 <- left_join(white_IMR_14_17, states, 
                                          by = "state_name")
```


### Infant Mortality Rates: 1995, 2007, 2017.
CDC Wonder queries were performed for infant mortality rates (IMR) by year, by state, for every year from 1995 through 2017. 1995, 2007 and 2017 are selceted to demonstrate the consistent decrease in IMR across time. Geospatial maps are developed for each of these years and presented in sequence.

### Racial Differences
CDC Wonder query of IMR rate by state and by racial group recorded from 2014-2017 is used to demonstrate regional and national differences in IMR by race. For purposes here Black race is compared to White race.

### Improvements in IMR
IMR data was queried from the CDC Wonder data set for all infants born both 500-999g and 1,000 to 1,499g. Data was cleaned and columns named to all for a superset of data for all years from 1995 to 2017. Data is ploted as IMR over time cohorted into 4 distinct time epochs correlating with birth certificates.

### Timing Prior to Death in Infancy
The entire linked infant birth and death certificate data was utilized to create a super set of data combining all years from 1995 to 2013, the last year the NBER data sets have been published. Age of death is a recorded variable in all data sets and forms the foundation of this evaluation. Data are visualized as mean with error bars for standard error of the mean (SE). 

### Kaplan-Meier and Cox Proportional-Hazard Model.


## Results

### Infant Mortality Rates: 1995, 2007, 2017.
IMR rates across the United States have continued to improve consistently over the last 20 years. Presented below are three separate geospatial maps presenting the data. IMR is reported in deaths per 1,000 lives births. In the earliest year presented, 1995, peak IMR rates were near 15 per 1,000 live births and that rate has improved dramatically. The increased IMR in the southeast that can be seen with this geographic visualization continues. This region has seen improvements with the rest of the country but continues to lag.

#### 1995

```{r IMR 1995, echo = TRUE, warning=FALSE, fig.align = "center", fig.width=10, fig.height=6}
All_Infant_Death_1995_By_State <- Wonder_Files_df[[1]]
All_Infant_Death_1995_By_State <- rename(All_Infant_Death_1995_By_State, state_name = State)
All_Infant_Death_1995_By_State <- rename(All_Infant_Death_1995_By_State, death_rate = "Death.Rate")

state_data_infant_death_1995 <- left_join(All_Infant_Death_1995_By_State, states, 
                                          by = "state_name")
state_data_infant_death_1995 %>%
  ggplot(aes(long, lat, group = group, fill = death_rate)) +
  ggtitle("Infant Death Rate in the US 1995") +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(fill = "Infant Death Rate")
```

#### 2007

```{r IMR 2007, echo = TRUE, warning=FALSE, fig.align = "center", fig.width=10, fig.height=6}
All_Infant_Death_2007_By_State <- Wonder_Files_df[[13]]
All_Infant_Death_2007_By_State <- rename(All_Infant_Death_2007_By_State, state_name = State)
All_Infant_Death_2007_By_State <- rename(All_Infant_Death_2007_By_State, death_rate = "Death.Rate")

state_data_infant_death_2007 <- left_join(All_Infant_Death_2007_By_State, states, 
                                          by = "state_name")
state_data_infant_death_2007 %>%
  ggplot(aes(long, lat, group = group, fill = death_rate)) +
  ggtitle("Infant Death Rate in the US 2007") +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(fill = "Infant Death Rate")
```

#### 2017

```{r IMR 2017, echo = TRUE, warning=FALSE, fig.align = "center", fig.width=10, fig.height=6}
All_Infant_Death_2017_By_State <- Wonder_Files_df[[23]]
All_Infant_Death_2017_By_State <- rename(All_Infant_Death_2017_By_State, state_name = State)
All_Infant_Death_2017_By_State <- rename(All_Infant_Death_2017_By_State, death_rate = "Death.Rate")

state_data_infant_death_2017 <- left_join(All_Infant_Death_2017_By_State, states, 
                                          by = "state_name")
state_data_infant_death_2017 %>%
  ggplot(aes(long, lat, group = group, fill = death_rate)) +
  ggtitle("Infant Death Rate in the US 2017") +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(fill = "Infant Death Rate")
```


### Racial Differences

A well described phenomena in the United States is the increased IMR among racial minorities. The figures below demonstrate the increased IMR for Black infants as compared to white infants. Of note 4 states have no black infant deaths reported for these 4 years.

```{r white IMR, echo=TRUE, warning=FALSE, message=FALSE}
white_IMR_map_14_17 %>%
  ggplot(aes(long, lat, group = group, fill = IMR)) +
  ggtitle("Infant Mortality Rate Among White Infants in the US 2014-2017") +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  scale_fill_gradient(limits = c(1,15), low = "yellow",high = "red") + 
  labs(fill = "Infant Mortality Rate")
```

```{r black IMR, echo=TRUE, warning=FALSE, message=FALSE}
black_IMR_map_14_17 %>%
  ggplot(aes(long, lat, group = group, fill = IMR)) +
  ggtitle("Infant Mortality Rate Among Black Infants in the US 2014-2017") +
  geom_polygon(color = NA) +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  scale_fill_gradient(limits = c(1,15), low = "yellow",high = "red") + 
  labs(fill = "Infant Mortality Rate")
```

### Descriptive Demographics of IMR.
VLBW and ELBW infants make up a significant portion of infant mortality in the UNited States. In 1995 **`r round(Percent_1995_IMR_VLBW*100, digits=1)`** percent of the IMR in the United States was accounted for by those infants born VLBW and **`r round(Percent_1995_IMR_ELBW*100, digits=1)`** percent from infants born ELBW. By 2017 the percent of US infant mortality accounted for by VLBW infants rose to **`r round(Percent_2017_IMR_VLBW*100, digits=1)`**. Currently a full **`r round(Percent_2017_IMR_ELBW*100, digits=1)`** percent of IMR is now from infants born ELBW.
An interesting aspect of IMR in the United States is that it continues to capture any live born infant given a birth certificate in whom there is a matching death certificate. In 1995 **`r round(Percent_1995_IMR_lt_23*100, digits = 1)`** percent of IMR was accounted for by infants 22 weeks or less and that percent rose to **`r round(Percent_2017_IMR_lt_23*100, digits = 1)`** percent by 2017. Until recently, these infants were considered non-viable and not routinely offered support.

### Improvements in IMR.
As demonstrated above IMR in the US has improved significantly over the last 20 years. A significant portion of that improvement has likely come as a result of improvements in survival for infants born less than 1,500 g and more specifically less than 1,000g. Presented below is a demonstration of that for all infants born from 1995 to 2017. Data is broken down into 4 groupings representing different birth certificate epochs. The grouping for each plot are. One-way anova across the 4 time periods is also perfomed for both VLBW and ELBW infants. 

- 1995-1998
- 1999-2002
- 2003-2006
- 2007-2017

#### Infants 1,000 to 1,499g.

```{r IMR in VLBW, echo = TRUE, warning=FALSE, message=FALSE}
aa <- ggplot(All_VLBW_IMR, aes(x=Year.of.Death, y=Death.Rate))
bb <- aa +geom_point(aes(colour = Year.Group, size=Deaths)) +
      scale_color_brewer(palette="Blues") +
      ggtitle("IMR in Infants 1,000 to 1,499g") + 
      xlab("Year") +
      ylab("IMR per 1,000 live births") +
      labs(Size="Number of Deaths", colour="Year Group") +
      theme_dark()
bb
VLBW_anova <-  aov(Death.Rate ~ Year.Group, data = All_VLBW_IMR)
tidy_VLBW_anova <- tidy(VLBW_anova)
```

#### Infants 500-999g.
```{r IMR in ELBW, echo = TRUE, warning=FALSE, message=FALSE}
cc <- ggplot(All_ELBW_IMR, aes(x=Year.of.Death, y=Death.Rate))
dd <- cc +geom_point(aes(colour = Year.Group, size=Deaths)) +
      scale_color_brewer(palette="Blues") +
      ggtitle("IMR in Infants 500 to 999g") + 
      xlab("Year") +
      ylab("IMR per 1,000 live births") +
      labs(Size="Number of Deaths", colour="Year Group") + 
      theme_dark()
dd
ELBW_anova <-  aov(Death.Rate ~ Year.Group, data = All_ELBW_IMR)
tidy_ELBW_anova <- tidy(ELBW_anova)
```

IMR rates for infants in both birth weight cohorts have significantly improved over the last 20 years. One-way anova for both cohorts demonstrates significant changes over time with both models resulting in p values of less than 0.001.

##### VLBW Anova Model
```{r}
kable((tidy_VLBW_anova))
```

##### ELBW Model
```{r}
kable((tidy_ELBW_anova))
```

### Timing Prior to Death in Infancy

While the above improvements are noteworthy and described in a manner of ways for the whole US birth cohort, the therapies being applied in these groups is also likely changing the nature and timing of death among infants that continue to die during infancy in the US. This has not been described previously.

#### VLBW Infants
```{r VLBW Day Before Death, echo = TRUE, warning=FALSE, message=FALSE}
gg <- ggplot(data=VLBW_rbind_ad_summ, aes(x=Year, y=mean_aged))
hh <- gg + geom_point(color="red") +
        geom_errorbar(aes(ymin=mean_aged-se_aged, ymax=mean_aged+se_aged), width=.1) +
        ggtitle("Mean Age of Death Among VLBW Infants") +
        ylab("Age of Death(Days)") +
        xlab("Year")
hh
```

#### ELBW Infants
```{r ELBW Day Before Death, echo = TRUE, warning=FALSE, message=FALSE}
ee <- ggplot(data=ELBW_rbind_ad_summ, aes(x=Year, y=mean_aged))
ff <- ee + geom_point(color="red")+
        geom_errorbar(aes(ymin=mean_aged-se_aged, ymax=mean_aged+se_aged), width=.1) +
        ggtitle("Mean Age of Death Among ELBW Infants") +
        ylab("Age of Death(Days)") + 
        xlab("Year")
ff
```

Interestingly both groups demonstrate an increasing average time to death through about 2004-2005 then an apparent decline. This decline has persisted for the groups of infants that are less than 1,500 grams. For infants that are less than 1,000 grams at birth however there is seemingly an increasing amount of time before death again.

#### Distribution of Times Before Death.

Below is a visualization of the distribution of times before death. It is understood in neonatal medicine that a large portion of mortality happens early in the life of babies born less than 1,500g. This early death is largely felt to be the result of the extreme physiologic immaturity present at birth. What is clear is that the times are clearly non-normally distributed and the majoirity of death is within the first week of life. 

#### Distribution of Time to Death for the Entire VLBW Cohort.
```{r Distribution of Age of Death VLBW, message=FALSE}
ggplot(data=VLBW_rbind_ad, aes(x=aged)) + 
  geom_histogram(color="darkblue", fill="lightblue") +
  xlab("Aged of Death") + 
  ylab("Number of Deaths") +
  ggtitle("Distribution of Time of Death, Entire VLBW Cohort") + 
  annotate("text", x = 200, y = 62500, label = "- Clearly non-normally distributed.") + 
  annotate("text", x = 200, y = 56250, label = "- Median values between 0-2 days.") +
  annotate("text", x = 200, y = 50000, label = "- ELBW cohort is contained withing the VLBW cohort.")
```

##### Distribution of Time to Death for the Entire ELBW Cohort.

```{r Distribution of Age of Death ELBW, message=FALSE}
ggplot(data=ELBW_rbind_ad, aes(x=aged)) + geom_histogram(color="darkblue", fill="lightblue") +xlab("Aged of Death") + ylab("Number of Deaths") +
  ggtitle("Distribution of Time of Death, Entire ELBW Cohort") + annotate("text", x = 200, y = 62500, label = "- Clearly non-normally distributed.") + annotate("text", x = 200, y = 56250, label = "- Median values between 0-2.")
```

#### Timing Prior to Death for VLBW Infants Survivng More Than 7d.

```{r VLBW  GT 7d Day Before Death, echo = FALSE, warning=FALSE, message=FALSE}
kk <- ggplot(data=VLBW_surv_8d_summ, aes(x=Year, y=mean_aged))
ll <- kk + geom_point(color="red")+
        geom_errorbar(aes(ymin=mean_aged-se_aged, ymax=mean_aged+se_aged), width=.1) +
        ggtitle("Mean Age of Death Among VLBW Infants Surviving > 7d") +
        ylab("Age of Death(Days)") + 
        xlab("Year")
ll
```

#### Timing Prior to Death for ELBW Infants Survivng More Than 7d.

```{r ELBW  GT 7d Day Before Death, echo = FALSE, warning=FALSE, message=FALSE}
ii <- ggplot(data=ELBW_surv_8d_summ, aes(x=Year, y=mean_aged))
jj <- ii + geom_point(color="red")+
        geom_errorbar(aes(ymin=mean_aged-se_aged, ymax=mean_aged+se_aged), width=.1) +
        ggtitle("Mean Age of Death Among ELBW Infants Surviving > 7d") +
        ylab("Age of Death(Days)") + 
        xlab("Year")
jj
```


