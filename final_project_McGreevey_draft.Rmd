---
title: "BMIN503/EPID600 Project Template"
author: "John M" This is a test
output: 
  html_document:
    theme: paper 
    highlight: tango
---


***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, but this is not required.

### Overview
#Give a brief a description of your project and its goal(s), what data you are using to complete it, and what two faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.
Social determinants of health, such as inadequate housing, lack of access to reliable transportation, and insufficient food access, have increasingly been recognized as being factors that adversely impact health outcomes. In this project, with guidance from advisors John Holmes, PhD and Sameh Saleh, MD, I will attempt to determine if there is an observed association between low food access and type 2 diabetes prevalence in the United States for the most recent year for which data about both were available, 2015. I will use the AHRQ Social Determinants of Health dataset for this work.
Link to final project Github repository: https://github.com/mcgreevj/BMIN503_Final_Project


### Introduction 
#Describe the problem addressed, its significance, and some background to motivate the problem.

#Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.
Type 2 diabetes is a major health problem in the United States, with significant morbidity and mortality for the at least 33 million people who suffer with this condition. Additionally, the economic costs of type 2 diabetes in the aggregate are substantial, totaling $327 billion in 2017 (The Cost of Diabetes | ADA). Tragically, type 2 diabetes is largely a preventable disease that has modifiable risk factors (weight, diet, exercise). Increasingly, there has been recognition that social determinants of health can serve as barriers that prevent individuals from being able to successfully modify risk factors. For example, individuals who lack access to insurance and/or reliable transportation may not be able to seek routine medical care for education, prevention, monitoring, and treatment purposes. As noted, diet is a major factor in the development of type 2 diabetes. And while ideal diets to prevent type 2 diabetes have been advised, not every American necessarily has access to food to be able to consume these recommended diets. This is the phenomenon of food insecurity. Food insecurity is formally defined by the US Department of Agriculture as: “the limited or uncertain availability of nutritionally adequate and safe foods, or limited or uncertain ability to acquire acceptable foods in socially acceptable ways.” (USDA ERS - Measurement). One factor that can lead to lack of access to healthy foods is the phenomenon of food deserts – areas that are low income and that have few or no supermarkets or other sources of healthy food options. As formally defined by the USDA, a food desert is: “A census tract that meets both low-income and low-access criteria including: 1. poverty rate is greater than or equal to 20 percent OR median family income does not exceed 80 percent statewide (rural/urban) or metro-area (urban) median family income; 2. at least 500 people or 33 percent of the population located more than 1 mile (urban) or 10 miles (rural) from the nearest supermarket or large grocery store.” In the absence of options for healthy food, individuals residing in these communities may need to resort to convenience and fast foods for some or many of their meals. In doing so, they increase the risk of developing type 2 diabetes. 

This project is interdisciplinary in that it combines census tract, geographical data with health survey data. Notably the AHRQ SDOH database integrates data from multiple surveys and sources. The fields and topics that contribute to understanding of this issue are multiple: public health, clinical medicine, sociology, health disparities, economics, geography, history (in that the reasons many communities have limited access to food involves historical structural decisions, including forms of structural racism such as redlining). Moreover, the findings of this project have social justice, ethical, cultural, economic, and political implications. Based on collaboration with my mentors, I have learned the importance of familiarizing myself with data sources and data definitions, notably the Data Source Documentation guide from AHRQ (AHRQ Social Determinants of Health (SDOH) Database). This step is necessary from an exploratory standpoint to contemplate what kind of project I might do and also from a practical standpoint to understand how to properly and specifically answer my project question with the available data. I have also learned that some questions may be challenging to answer exactly as initially envisioned. For example, when considering this project at first, I had hoped to show changes over time in the association between limited food access and type 2 diabetes prevalence, perhaps including recent data from 2020 or 2021. However, after close inspection of this SDOH data set, I have realized that not all data is available for every year of interest. Thus I have needed to narrow the scope of my project a bit, given that data for limited food access and diabetes prevalence intersect in 2015, which is the most recent year that both types of data are available.

The identification of an independent association between low food access and type 2 diabetes prevalence would help support the case for policies and programs (both at the national and state levels) to improve food access in impacted census tracts. From a social justice standpoint, those with power in society (elected office holders, business and community leaders, members of the health care community including researchers) have a responsibility to seek ways to provide a known and effective preventive therapy (whether a vaccine or a grocery store) to those without such access currently, to prevent disease. There is also a national public health and cost dimension to this topic. People with diabetes suffer complications and morbidity related to diabetes, impairing their ability to support themselves, live independent lives, and contribute to a community’s economic activity and well-being. At the same time, the national cost of providing care for individuals with type 2 diabetes is borne by all Americans, in part because individuals living in low access food areas are more likely to have public (Medicaid, Medicare) insurance, if they have insurance at all, that is funded by all U.S. taxpayers. Indeed, Medicaid and Medicare combined provide health coverage to approximately 36% of Americans today and that percentage continues to rise over time. (Health Insurance Coverage of the Total Population | KFF). Data Note: Three Findings about Access to Care and Health Outcomes in Medicaid (kff.org). “Uncompensated” care for individuals with type 2 diabetes who lack any type of insurance is also a cost borne by individual health care organizations, governments, and ultimately, tax payers. Greater awareness of the relationships between SDOH and health outcomes, combined with a blunt accounting of the costs of inaction on this subject, will hopefully spur actions that can help mitigate SDOH and improve both individual and community health. 


### Methods
For this project, I used the AHRQ Social Determinants of Health database (available at https://www.ahrq.gov/sdoh/data-analytics/sdoh-data.html). I reviewed the data source documentation document (https://www.ahrq.gov/sites/default/files/wysiwyg/sdoh/SDOH-Data-Sources-Documentation-v1-Final.pdf) to learn about potential variables for this project and their availability. Ultimately, I planned to use two main variables available in the SDOH database: CHR_PCT_DM and FARA_TRACT_LILA_HALF_10. 

CHR_PCT_DM is defined as the "percentage of adults with diagnosed diabetes 
(ages 20 and over)." Data for this variable is provided by the CDC Interactive Diabetes Atlas which in turn uses BRFSS data to estimate prevalence by U.S. county. Notably, starting in 2015, BRFSS included both landline and cellphone survey data to obtain diabetes prevalence data. Previously, this data had been collected exclusively via landline surveys.  

FARA_PCT_LA_HALF_10_POP is defined as the "percentage of [healthy food] low access population measured at 1/2 mile for urban areas and 10 miles for rural areas." For this variable, low access to healthy food is defined as being far from a supermarket, supercenter, or large grocery store, so more than 1/2 mile in urban areas and more than 10 miles in rural areas for this variable. #Does low access first require low-income designation for a tract, or is low access independent of low-income status for a tract? That is, a tract could be LA and not be LI?

This variable comes from the Food Access Research Atlas (FARA), created by the Economic Research Service (ERS) at the United States Department of Agriculture. A mapping tool is offered by the ERS and is available here: https://www.ers.usda.gov/data-products/food-access-research-atlas/go-to-the-atlas/. 

In contrast to the diabetes prevalence data, FARA data is provided at the census tract level.

Of note, the following is the ERS methodology for calculating distance to the nearest grocery store, excerpted from the ERS definitions document available at https://www.ers.usda.gov/data-products/food-access-research-atlas/documentation/:

"First, the entire country is divided into ½-kilometer (about 1/3-mile)-square grids, and data on the population are aerially allocated to these grids (see Low-Income and Low-Foodstore-Access Census Tracts, 2015-19 in the link below). Distance to the nearest supermarket is measured for each grid cell by calculating the distance between the geographic center of the ½-kilometer square grid that contains estimates of the population (number of people and other subgroup characteristics) and the center of the grid with the nearest supermarket."

While I had hoped to be able to include recent data for this project, the most recent year that data for both CHR_PCT_DM and FARA_PCT_LA_HALF_10_POP is available is 2015.   

After having consulted with my advisors (Dr. Holmes and Dr. Saleh) and choosing the key variables above, I loaded the appropriate datasets into R.

For CHR_PCT_DIABETES, the 2015 data (by county) was available as an Excel file here: https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fwww.ahrq.gov%2Fsites%2Fdefault%2Ffiles%2Fwysiwyg%2Fsdoh%2FSDOH_2015_COUNTY_1_0.xlsx&wdOrigin=BROWSELINK.

For FARA_PCT_LA_HALF_10_POP, the 2015 data (by tract) was available as an Excel file here: 
https://www.ahrq.gov/downloads/sdoh/sdoh_2015_tract_1_0.xlsx.

Once loaded into R, I manipulated each of these raw datasets so as to limit them to the variables of interest.

For the tract dataset, I mutated it to create a new variable, MEAN_PCT_LA_COUNTY, that reported the mean low access percentage by county, using group by and summarize functions. 

I joined the dataframes containing CHR_PCT_DIABETES and FARA_PCT_LA_HALF_10_POP, respectively, by COUNTYFIPS, which was present in both dataframes.

In preparation for an exploratory data analysis using choropleths, I loaded census county files using practicum code as a guide. 

I created a basic U.S. choropleth of low access percentage by county. Similarly, I created abasic U.S. choropleth of diabetes prevalence by county.

I will plan to create a logistic regression model to determine if there is any relationship between low food access and diabetes prevalence. [Is there any way to graphically demonstrate a relationship]

I will consider adjusting the model for other potentially relevant variables such as income, age, obesity if possible. 

### Results
Result of exploratory data analysis
Result of logistic regression model
Result after adjusting for other variables
[preliminary code below]

Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

Limitations
There was not an evident way to capture purely type 2 diabetes data from available surveys. Interestingly, the CHR_PCT_DIABETES variable counts any diagnosis of diabetes, whether type 1, type 2, or other. In this project, the diabetes of interest is type 2 diabetes given that type 2 diabetes is associated with modifiable lifestyle factors. Still, given that 90-95% of all U.S. diabetes cases are type 2 (https://www.cdc.gov/diabetes/basics/type2.html#:~:text=Healthy%20eating%20is%20your%20recipe,adults%20are%20also%20developing%20it), this project is still capable of providing a reasonably strong estimate of any association between low access and type 2 diabetes prevalence.  


Conclusion

Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 






```{r, eval=TRUE}
library("readxl")
```

```{r, eval=TRUE}
#Read in the 2015 low access data, reported by census tract
Lowaccess_raw<- read_excel("C:\\Users\\McGreevJ\\Desktop\\BMI 5030 Data Science\\BMIN503_Final_Project\\Adjusted datasets\\data.sdoh_2015_tract_1_0.xlsx")
```

```{r, eval=TRUE}
#Read in the 2015 diabetes prevalence data, reported by county
Diabetes_raw<- read_excel("C:\\Users\\McGreevJ\\Desktop\\BMI 5030 Data Science\\BMIN503_Final_Project\\Adjusted datasets\\data.SDOH_2015_COUNTY_1_0.xlsx")
```

```{r}
library(tidyverse)
library(cowplot)
library(dplyr)

#Limiting Lowaccess_raw to include variables of most interest:

Lowaccess<- dplyr::select(Lowaccess_raw, TRACTFIPS, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, ACS_MEDIAN_AGE, ACS_PCT_EMPLOYED, ACS_MEDIAN_HH_INC, ACS_PCT_HH_INC_10000, ACS_PCT_HH_INC_100000, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_MEDICAID_ANY, ACS_PCT_MEDICAID_ANY_BELOW64, ACS_PCT_MEDICARE_ONLY, ACS_PCT_PRIVATE_ANY, ACS_PCT_UNINSURED, FARA_TRACT_LILA_HALF_10, FARA_PCT_LA_HALF_10_POP, HRSA_MUA_CENSUS_TRACT, POS_DIST_ED_TRACT, CEN_AIAN_NH_IND)
str(Lowaccess)

#Limiting Diabetes_raw to include variables of most interest:
Diabetes<- dplyr::select(Diabetes_raw, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, ACS_MEDIAN_AGE, ACS_PCT_EMPLOYED, ACS_MEDIAN_HH_INC, ACS_PCT_HH_INC_10000, ACS_PCT_HH_INC_100000, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_MEDICAID_ANY, ACS_PCT_MEDICAID_ANY_BELOW64, ACS_PCT_MEDICARE_ONLY, ACS_PCT_PRIVATE_ANY, ACS_PCT_UNINSURED, CEN_AIAN_NH_IND, ACS_TOT_HH, ACS_AVG_HH_SIZE, ACS_PCT_CHILD_1FAM, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES)
str(Diabetes)
```





```{r, eval=TRUE}
#Transform low access data that is provided by *census tract* into a dataframe "Lowaccess_county" where FARA_PCT_LA_HALF_10_POP is summarised as a mean value for each county, omitting NA values

Lowaccess_county<- Lowaccess %>% filter(!is.na(FARA_PCT_LA_HALF_10_POP)) %>% dplyr::group_by(COUNTYFIPS) %>% dplyr::summarise(MEAN_PCT_LA_COUNTY = mean(FARA_PCT_LA_HALF_10_POP)) 

str(Lowaccess_county) #3140 variables

str(Lowaccess_county$COUNTYFIPS) #3140 values
str(Diabetes$COUNTYFIPS) #2927 values #why the differences?

Lowaccess_county<- na.omit(Lowaccess_county)
Diabetes<- na.omit(Diabetes)

str(Lowaccess_county$COUNTYFIPS) #3140 values
str(Diabetes$COUNTYFIPS) #2927 values #why the differences?


```

```{r, eval=TRUE}
#Joining Diabetes and Lowaccess_county dataframes 

#which one to use?
#Innerjoin?
test_innerjoin<- inner_join(Diabetes, Lowaccess_county, by = "COUNTYFIPS")
head(test_innerjoin)
str(test_innerjoin$COUNTYFIPS) #how many values? #2925

#Leftjoin?
test_leftjoin<- left_join(Diabetes, Lowaccess_county, by = "COUNTYFIPS")
head(test_leftjoin)
str(test_leftjoin$COUNTYFIPS) #how many values? #2927

#Checking for any evident differences in output between two approaches, at least in headers of each
#Mean PCT LA by county
head(test_innerjoin$MEAN_PCT_LA_COUNTY)
head(test_leftjoin$MEAN_PCT_LA_COUNTY)
#Do not appreciate any differences

#PCT Diabetes
head(test_innerjoin$CHR_PCT_DIABETES)
head(test_leftjoin$CHR_PCT_DIABETES)
#Do not appreciate any differences
```

```{r, eval=True}
#Exploratory data analysis with choropleths:

library(rgdal)
library(leaflet)
library(ggplot2)
library(RColorBrewer)
library(plyr)
library(rgdal)
library(sf)
library(tidycensus)
library(ggsn)
library(leaflet)
library(ggplot2)
library(RColorBrewer)

counties<- readRDS(gzcon(url("https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds")))

st_crs(counties) <- st_crs(counties)

#using base plot function to check that counties contains polygon data: 
plot(counties)
#using ggplot to check that counties contains polygon data:
ggplot() +
    geom_sf(data = counties)



head(test_leftjoin)


###
#Joining combined data set and counties, but first, need to create a common variable by which to join. Will convert State to a 2 digit number in Counties, then mutate State and County into a 5 digit number, a mutated variable in Counties called "COUNTYFIPS" to correspond to "COUNTYFIPS" in the combined data set.

counties$STATE<- str_pad(counties$STATE, width=2, side="left", pad="0")
head(counties)

counties<- counties %>% dplyr::mutate(COUNTYFIPS = paste(STATE, COUNTY, sep = ""))
head(counties)

str(counties$COUNTYFIPS) #3109 values
str(test_leftjoin$COUNTYFIPS) #2927 values, #why the difference?

test_counties_left<- left_join(counties, test_leftjoin, by = 'COUNTYFIPS')
str(test_counties_left) #3109 obs of 33 variables


test_counties_inner<- inner_join
str(test_counties_inner) #2893 obs of 33 variables


#########################
Reference:
  ## Spatial Data 
Let's examine how R handles different types of GIS data, beginning with vector data (i.e. points, lines and polygons) and ending with a brief raster example. We mentioned the `sf` framework, which you can read more about [here](https://r-spatial.github.io/sf/) and download a [cheetsheet](https://github.com/rstudio/cheatsheets/blob/main/sf.pdf). Note that the `sf` framework is compatible with tidyverse (including _ggplot2_). For a broader discussing of using and analyzing spatially distributed data in R, take a look at [rspatialdata](https://rspatialdata.github.io/). 


### Polygon data
We will look at Philadelphia census tracts as an example of polygon data. Census shapefiles are free to download on the [Census website](https://www.census.gov/geo/maps-data/data/tiger-line.html), but we will load a version that has already been converted to an sf object. 

###

#Maybe? library(RColorBrewer)
myPalette <- colorRampPalette(brewer.pal(9, "BuPu"))


my_theme <- function() {
  theme_minimal() +                                  
  theme(axis.line = element_blank(),                 
        axis.text = element_blank(),                 
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  
        legend.key.size = unit(0.5, "cm"),          
        legend.text = element_text(size = 10),       
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))      
}  
myPalette <- colorRampPalette(brewer.pal(9, "YlOrRd")) 



#Low access plot, left, pink/white
ggplot() +
  geom_sf(data = test_counties_left, aes(fill = MEAN_PCT_LA_COUNTY), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with low access to food, by U.S. county, 2015, left, pink scheme") +
  scale_fill_continuous(low = "antiquewhite2", high = "red", guide = "colorbar") +
  north(x.min = -75.28031, y.min = 39.86747,    # add north bar with north()
        x.max = -74.95575, y.max = 40.13793,    # set map boundaries with x.min, y.min, etc..      
        symbol=12,                              # select north arrow symbol
        anchor = c(x = -75, y = 39.93)) +       # set north bar location
  scalebar(x.min = -75.28031, y.min = 39.86747, # add scalebar with scalebar()
           x.max = -74.95575, y.max = 40.13793, # set map boundaries
           dist = 5, dist_unit = 'km',          # set scalebar segment length = 5km
           transform = TRUE,                    # TRUE for decimal degree coordinates
           model = "WGS84")                      # specify CR

#colors
library(leaflet)
# Select a color palette with which to run the palette function
pal_fun <- colorNumeric("BuPu", NULL)       # Blue-Purple from RColorBrewer
pal_fun2 <- colorNumeric("YlOrRd", NULL)    # Yellow-Orange-Red from RColorBrewer
pal_fun3 <- colorNumeric("viridis", NULL)   # viridis from viridis
pal_fun4 <- colorNumeric("inferno", NULL)   # inferno from viridis
pal_fun5 <- colorNumeric("inferno", NULL, reverse=TRUE)  # reverses the color ramp
  
#Low access plot, left, blue:
ggplot() +
  geom_sf(data = test_counties_left, aes(fill = 
        MEAN_PCT_LA_COUNTY), lwd = 0) + 
        my_theme() +
        ggtitle("Percent of population with low access to food, by U.S. county, 2015, left, blue scheme") +
        theme(legend.position = "topright")



#Diabetes plot, left, blue:
ggplot() +
  geom_sf(data = test_counties_left, aes(fill = CHR_PCT_DIABETES), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with diabetes, by U.S. county, 2015, left, blue theme")+
  theme(legend.position = "none")
```



