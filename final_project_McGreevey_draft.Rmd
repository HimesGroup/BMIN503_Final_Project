---
title: "BMIN503/EPID600 Project Template"
author: "John McGreevey" 
output: 
  html_document:
    theme: paper 
    highlight: tango
---


***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, but this is not required.

### Overview
#Give a brief a description of your project and its goal(s), what data you are using to complete it, and what two faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.
Social determinants of health, such as inadequate housing, lack of access to reliable transportation, and insufficient food access, have increasingly been recognized as being factors that adversely impact health outcomes (https://health.gov/healthypeople/priority-areas/social-determinants-health). In this project, with guidance from advisors John Holmes, PhD and Sameh Saleh, MD, I will attempt to determine if there is an observed association between low food access and type 2 diabetes prevalence in the United States for the most recent year for which data about both were available, 2015. It is possible that there is a positive association between decreased food access and type 2 diabetes prevalence, as individuals in low food access areas may have little choice but to rely on convenience foods and fast foods for their nutritional intake, which is likely to increase the risk of developing type 2 diabetes. I will use the AHRQ Social Determinants of Health dataset for this work.

Link to final project Github repository: https://github.com/mcgreevj/BMIN503_Final_Project


### Introduction 
#Describe the problem addressed, its significance, and some background to motivate the problem.

#Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.
Type 2 diabetes is a major health problem in the United States, with significant morbidity and mortality for the at least 33 million people who suffer with this condition. Additionally, the economic costs of type 2 diabetes in the aggregate are substantial, totaling $327 billion in 2017 (The Cost of Diabetes | ADA). Tragically, type 2 diabetes is largely a preventable disease that has modifiable risk factors (weight, diet, exercise). Increasingly, there has been recognition that social determinants of health can serve as barriers that prevent individuals from being able to successfully modify risk factors. For example, individuals who lack access to insurance and/or reliable transportation may not be able to seek routine medical care for education, prevention, monitoring, and treatment purposes. As noted, diet is a major factor in the development of type 2 diabetes. And while ideal diets to prevent type 2 diabetes have been advised, not every American necessarily has access to food to be able to consume these recommended diets. This is the phenomenon of food insecurity. Food insecurity is formally defined by the US Department of Agriculture as: “the limited or uncertain availability of nutritionally adequate and safe foods, or limited or uncertain ability to acquire acceptable foods in socially acceptable ways.” (USDA ERS - Measurement). One factor that can lead to lack of access to healthy foods is the phenomenon of food deserts – areas that are low income and that have few or no supermarkets or other sources of healthy food options. As formally defined by the USDA, a food desert is: “A census tract that meets both low-income and low-access criteria including: 1. poverty rate is greater than or equal to 20 percent OR median family income does not exceed 80 percent statewide (rural/urban) or metro-area (urban) median family income; 2. at least 500 people or 33 percent of the population located more than 1 mile (urban) or 10 miles (rural) from the nearest supermarket or large grocery store.” In the absence of options for healthy food, individuals residing in these communities may need to resort to convenience and fast foods for some or many of their meals. In doing so, they increase the risk of developing type 2 diabetes. 

This project is interdisciplinary in that it combines census tract, geographical data with health survey data. Notably the AHRQ SDOH database integrates data from multiple surveys and sources. The fields and topics that contribute to understanding of this issue are multiple: public health, clinical medicine, sociology, health disparities, economics, geography, history (in that the reasons many communities have limited access to food involves historical structural decisions, including forms of structural racism such as redlining). Moreover, the findings of this project have social justice, ethical, cultural, economic, and political implications. Based on collaboration with my mentors, I have learned the importance of familiarizing myself with data sources and data definitions, notably the Data Source Documentation guide from AHRQ (AHRQ Social Determinants of Health (SDOH) Database). This step is necessary from an exploratory standpoint to contemplate what kind of project I might do and also from a practical standpoint to understand how to properly and specifically answer my project question with the available data. I have also learned that some questions may be challenging to answer exactly as initially envisioned. For example, when considering this project at first, I had hoped to show changes over time in the association between limited food access and type 2 diabetes prevalence, perhaps including recent data from 2020 or 2021. However, after close inspection of this SDOH data set, I have realized that not all data is available for every year of interest. Thus I have needed to narrow the scope of my project a bit, given that data for limited food access and diabetes prevalence intersect in 2015, which is the most recent year that both types of data are available.

The identification of an independent association between low food access and type 2 diabetes prevalence would help support the case for policies and programs (both at the national and state levels) to improve food access in impacted census tracts. From a social justice standpoint, those with power in society (elected office holders, business and community leaders, members of the health care community including researchers) have a responsibility to seek ways to provide a known and effective preventive therapy (whether a vaccine or a grocery store) to those without such access currently, to prevent disease. There is also a national public health and cost dimension to this topic. People with diabetes suffer complications and morbidity related to diabetes, impairing their ability to support themselves, live independent lives, and contribute to a community’s economic activity and well-being. At the same time, the national cost of providing care for individuals with type 2 diabetes is borne by all Americans, in part because individuals living in low access food areas are more likely to have public (Medicaid, Medicare) insurance, if they have insurance at all, that is funded by all U.S. taxpayers. Indeed, Medicaid and Medicare combined provide health coverage to approximately 36% of Americans today and that percentage continues to rise over time. (Health Insurance Coverage of the Total Population | KFF). Data Note: Three Findings about Access to Care and Health Outcomes in Medicaid (kff.org). “Uncompensated” care for individuals with type 2 diabetes who lack any type of insurance is also a cost borne by individual health care organizations, governments, and ultimately, tax payers. Greater awareness of the relationships between SDOH and health outcomes, combined with a blunt accounting of the costs of inaction on this subject, will hopefully spur actions that can help mitigate SDOH and improve both individual and community health. 


### Methods
For this project, I used the AHRQ Social Determinants of Health database (available at https://www.ahrq.gov/sdoh/data-analytics/sdoh-data.html). I reviewed the data source documentation document (https://www.ahrq.gov/sites/default/files/wysiwyg/sdoh/SDOH-Data-Sources-Documentation-v1-Final.pdf) to learn about potential variables for this project and their availability. Ultimately, I planned to use two main variables available in the SDOH database: CHR_PCT_DM and FARA_TRACT_LILA_HALF_10. 

CHR_PCT_DM is defined as the "percentage of adults with diagnosed diabetes 
(ages 20 and over)." Data for this variable is provided by the CDC Interactive Diabetes Atlas which in turn uses BRFSS data to estimate prevalence by U.S. county. Notably, starting in 2015, BRFSS included both landline and cellphone survey data to obtain diabetes prevalence data. Previously, this data had been collected exclusively via landline surveys.  

FARA_PCT_LA_HALF_10_POP is defined as the "percentage of [healthy food] low access population measured at 1/2 mile for urban areas and 10 miles for rural areas." For this variable, low access to healthy food is defined as being far from a supermarket, supercenter, or large grocery store, so more than 1/2 mile in urban areas and more than 10 miles in rural areas for this variable. #Does low access first require low-income designation for a tract, or is low access independent of low-income status for a tract? That is, a tract could be LA and not be LI?

This variable comes from the Food Access Research Atlas (FARA), created by the Economic Research Service (ERS) at the United States Department of Agriculture. A mapping tool is offered by the ERS and is available here: https://www.ers.usda.gov/data-products/food-access-research-atlas/go-to-the-atlas/. 

In contrast to the diabetes prevalence data, FARA data is provided at the census tract level.

Of note, the following is the ERS methodology for calculating distance to the nearest grocery store, excerpted from the ERS definitions document available at https://www.ers.usda.gov/data-products/food-access-research-atlas/documentation/:

"First, the entire country is divided into ½-kilometer (about 1/3-mile)-square grids, and data on the population are aerially allocated to these grids (see Low-Income and Low-Foodstore-Access Census Tracts, 2015-19 in the link below). Distance to the nearest supermarket is measured for each grid cell by calculating the distance between the geographic center of the ½-kilometer square grid that contains estimates of the population (number of people and other subgroup characteristics) and the center of the grid with the nearest supermarket."

While I had hoped to be able to include recent data for this project, the most recent year that data for both CHR_PCT_DM and FARA_PCT_LA_HALF_10_POP is available is 2015.   

After having consulted with my advisors (Dr. Holmes and Dr. Saleh) and choosing the key variables above, I loaded the appropriate datasets into R.

For CHR_PCT_DIABETES, the 2015 data (by county) was available as an Excel file here: https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fwww.ahrq.gov%2Fsites%2Fdefault%2Ffiles%2Fwysiwyg%2Fsdoh%2FSDOH_2015_COUNTY_1_0.xlsx&wdOrigin=BROWSELINK.

For FARA_PCT_LA_HALF_10_POP, the 2015 data (by tract) was available as an Excel file here: 
https://www.ahrq.gov/downloads/sdoh/sdoh_2015_tract_1_0.xlsx.

Once loaded into R, I manipulated each of these raw datasets so as to limit them to the variables of interest.

For the tract dataset, I mutated it to create a new variable, MEAN_PCT_LA_COUNTY, that reported the mean low access percentage by county, using group by and summarize functions. 

I joined the dataframes containing CHR_PCT_DIABETES and FARA_PCT_LA_HALF_10_POP, respectively, by COUNTYFIPS, which was present in both dataframes.

In preparation for an exploratory data analysis using choropleths, I loaded census county files using practicum code as a guide. 

I created a basic U.S. choropleth of low access percentage by county. Similarly, I created abasic U.S. choropleth of diabetes prevalence by county.

I will plan to create a logistic regression model to determine if there is any relationship between low food access and diabetes prevalence. [Is there any way to graphically demonstrate a relationship]

I will consider adjusting the model for other potentially relevant variables such as income, age, obesity if possible. 

### Results
Result of exploratory data analysis
Result of logistic regression model
Result after adjusting for other variables
[preliminary code below]

Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

Limitations
There was not an evident way to capture purely type 2 diabetes data from available surveys. Interestingly, the CHR_PCT_DIABETES variable counts any diagnosis of diabetes, whether type 1, type 2, or other. In this project, the diabetes of interest is type 2 diabetes given that type 2 diabetes is associated with modifiable lifestyle factors. Still, given that 90-95% of all U.S. diabetes cases are type 2 (https://www.cdc.gov/diabetes/basics/type2.html#:~:text=Healthy%20eating%20is%20your%20recipe,adults%20are%20also%20developing%20it), this project is still capable of providing a reasonably strong estimate of any association between low access and type 2 diabetes prevalence.  


Conclusion

[Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.]






```{r, eval=TRUE}
library("readxl")
```

```{r, eval=TRUE}
#Read in the 2015 low access data, reported by census tract
Lowaccess_raw<- read_excel("C:\\Users\\McGreevJ\\Desktop\\BMI 5030 Data Science\\BMIN503_Final_Project\\Adjusted datasets\\data.sdoh_2015_tract_1_0.xlsx")
dim(Lowaccess_raw) #74133 x 405
```

```{r, eval=TRUE}
#Read in the 2015 diabetes prevalence data, reported by county
Diabetes_raw<- read_excel("C:\\Users\\McGreevJ\\Desktop\\BMI 5030 Data Science\\BMIN503_Final_Project\\Adjusted datasets\\data.SDOH_2015_COUNTY_1_0.xlsx")
dim(Diabetes_raw) #3234 x 979
```

```{r}
library(tidyverse)
library(cowplot)
library(dplyr)

#Checking for countyfips discrepancies between raw datasets
setdiff(Lowaccess_raw$COUNTYFIPS, Diabetes_raw$COUNTYFIPS)
#COUNTYFIPS 69085 (Northern Mariana Islands) is the only difference. 69085 is represented in Lowaccess_raw but not in Diabetes_raw.



#Define "Lowaccess" as a subset of "Lowaccess_raw" to include TRACTFIPS, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, FARA_TRACT_LILA_HALF_10, FARA_PCT_LA_HALF_10_POP
Lowaccess<- dplyr::select(Lowaccess_raw, TRACTFIPS, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, FARA_TRACT_LILA_HALF_10, FARA_PCT_LA_HALF_10_POP)
dim(Lowaccess) #74133 x 9
```

```{r}
#Define "Diabetes" as a subset of "Diabetes_raw" to include COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, ACS_MEDIAN_AGE, ACS_PCT_EMPLOYED, ACS_MEDIAN_HH_INC, ACS_PCT_HH_INC_10000, ACS_PCT_HH_INC_100000, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_MEDICAID_ANY, ACS_PCT_MEDICAID_ANY_BELOW64, ACS_PCT_MEDICARE_ONLY, ACS_PCT_PRIVATE_ANY, ACS_PCT_UNINSURED, CEN_AIAN_NH_IND, ACS_TOT_HH, ACS_AVG_HH_SIZE, ACS_PCT_CHILD_1FAM, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES
Diabetes<- dplyr::select(Diabetes_raw, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, ACS_MEDIAN_AGE, ACS_PCT_EMPLOYED, ACS_MEDIAN_HH_INC, ACS_PCT_HH_INC_10000, ACS_PCT_HH_INC_100000, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_MEDICAID_ANY, ACS_PCT_MEDICAID_ANY_BELOW64, ACS_PCT_MEDICARE_ONLY, ACS_PCT_PRIVATE_ANY, ACS_PCT_UNINSURED, CEN_AIAN_NH_IND, ACS_TOT_HH, ACS_AVG_HH_SIZE, ACS_PCT_CHILD_1FAM, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES)
dim(Diabetes) #3234 x 25
```

```{r}
#Rename county population column in Diabetes "ACS_TOT_POP_WT" to "County_Pop" 
Diabetes<- dplyr::rename(Diabetes, "County_Pop" = ACS_TOT_POP_WT)
head(Diabetes)
dim(Diabetes) #3234 x 25
```

```{r}
#Innerjoin Diabetes and Lowaccess
test_innerjoin<- inner_join(Diabetes, Lowaccess, by = "COUNTYFIPS")
head(test_innerjoin)
dim(test_innerjoin) #74132 x 33
```

```{r}
#Inspect to see if Northern Mariana (69085) is present in test_innerjoin - should not be
View(test_innerjoin)
#Search for 69085 in "View(test_innerjoin)" table yields no results, so Northern Mariana is excluded, as desired
```


```{r}
#Create a new column to represent weighted population, "census_tract_pop_wt" which is tract population divided by county population. 

test_innerjoin<- dplyr::mutate(test_innerjoin, "census_tract_pop_wt" = (ACS_TOT_POP_WT/County_Pop))
head(test_innerjoin)
dim(test_innerjoin) #74132 x 34
```

```{r}
#How many NAs are in the FARA_PCT_LA_HALF_10_POP column? 
sum(is.na(test_innerjoin$FARA_PCT_LA_HALF_10_POP))
```

```{r}
#Remove #1625 FARA na's from test_innerjoin

test_innerjoin<- test_innerjoin %>% drop_na(FARA_PCT_LA_HALF_10_POP)
dim(test_innerjoin) #72507 x 34 (so all 1625 NA FARA_PCT_LA_HALF_10_POP values removed)
View(test_innerjoin) #Visual inspection of full data confirms there are no NA values remaining in the FARA_PCT_LA_HALF_10_POP data column 
```


```{r}
#Defining a new dataframe based on test_innerjoin that contains a newly-defined weighted mean column, where results are grouped by COUNTYFIPS (one row per county) and where other variables of interest for the analysis are included
colnames(test_innerjoin)
test_innerjoin_wtmean<- test_innerjoin %>% dplyr::group_by(COUNTYFIPS, COUNTY.x, STATE.x, REGION.x, County_Pop, ACS_MEDIAN_HH_INC, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_UNINSURED, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES) %>% dplyr::summarise(wm_FARA = weighted.mean(FARA_PCT_LA_HALF_10_POP, census_tract_pop_wt)) %>% as.data.frame()
head(test_innerjoin_wtmean)
dim(test_innerjoin_wtmean) #3140 x 13

#Noting that Diabetes had 3234 rows and that test_innerjoin_wtmean has only 3140 rows

setdiff(Diabetes$COUNTYFIPS, test_innerjoin_wtmean$COUNTYFIPS)
#There are 94 counties in Diabetes that are not in test_innerjoin_wtmean
View(Diabetes)
#These counties appear to be in Alaska and U.S. territories. Examples: 02158 (Kusilvak Census Area, AK), 60010 (Am Samoa), 72151 (Puerto Rico), 78030 (US Virgin Islands). Excluding these counties from test_innerjoin_wtmean is acceptable given that we do not have the ability to plot choropleths (see counties rds file below) with these non-continental U.S. counties.
```



```{r, eval=TRUE}
#Loading libraries, county geography data in prep for exploratory data analysis, including choropleths:

library(rgdal)
library(leaflet)
library(ggplot2)
library(RColorBrewer)
library(plyr)
library(rgdal)
library(sf)
library(tidycensus)
library(ggsn)
library(leaflet)
library(ggplot2)
library(RColorBrewer)

counties<- readRDS(gzcon(url("https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds")))

st_crs(counties) <- st_crs(counties)

#using base plot function to check that counties contains polygon data: 
plot(counties)
#using ggplot to check that counties contains polygon data:
ggplot() +
    geom_sf(data = counties)
```

```{r, eval=TRUE}
#Joining test_innerjoin and counties but first need to create a common variable by which to join. Will convert State to a 2 digit number in Counties, then mutate State and County into a 5 digit number, a mutated variable in Counties called "COUNTYFIPS" to correspond to "COUNTYFIPS" in the combined data set, test_innerjoin.

counties$STATE<- str_pad(counties$STATE, width=2, side="left", pad="0")
head(counties)

counties<- counties %>% dplyr::mutate(COUNTYFIPS = paste(STATE, COUNTY, sep = ""))
head(counties)
```

```{r}
#Assessing number of rows in counties and test_innerjoin_wtmean
counties %>% summarise(n_distinct(COUNTYFIPS)) #3109

test_innerjoin_wtmean %>% summarise(n_distinct(COUNTYFIPS)) #3140

#So 31 rows appear to be different between counties and test_innerjoin_wtmean

setdiff(counties$COUNTYFIPS, test_innerjoin_wtmean$COUNTYFIPS)

#Yields 2 countyfips, 46113 and 51515 that are different, both present in counties but not in test_innerjoin_wtmean

#These are:

#Shannon County, SD (FIPS code = 46113) was renamed Oglala Lakota County and assigned anew FIPS code (46102) effective in 2014.

#Bedford City, VA (FIPS code=51515). In 2013, Bedford City, an independent city, merged with Bedford county (FIPS code=51019). Bedford City has a category code in all three of the NCHS schemes. Bedford City category codes are the same as those for Bedford County.

#But what about the other rows that are different? What are those rows?

#Using the alternate sequence for setdiff, with test_innerjoin_wt mean first:
setdiff(test_innerjoin_wtmean$COUNTYFIPS, counties$COUNTYFIPS)
#Yields 33 differences, pasted here, that are present in test_innerjoin_wtmean but not present in counties:
#1 "02013" "02016" "02020" "02050" "02060" "02068"
 #7 "02070" "02090" "02100" "02105" "02110" "02122"
#13 "02130" "02150" "02164" "02170" "02180" "02185"
#19 "02188" "02195" "02198" "02220" "02230" "02240"
#25 "02261" "02275" "02282" "02290" "15001" "15003"
#31 "15005" "15007" "15009"

#These differences are for Alaska (State code 02) and Hawaii (State code 15). These states are not represented in counties.

#An innerjoin of counties and test_innerjoin_wtmean would likely omit the Hawaii and Alaska data that is in test_innerjoin_wtmean.
```

```{r}
test_counties_inner<- inner_join(counties, test_innerjoin_wtmean, by = 'COUNTYFIPS')
str(test_counties_inner) #3107 obs of 20 variables, noting that Hawaii and Alaska data, as well as Shannon County, SD and Bedford City, VA data, have been removed
View(test_counties_inner)
```

```{r, eval=TRUE}
#Exploratory data analysis - sorting data, top/bottom rates and corresponding counties

#Starting with low access...

colnames(test_counties_inner)

#Inspecting a trimmed-down dataframe
selection<- test_counties_inner %>% dplyr::select(COUNTY.x, STATE.x, wm_FARA)
View(selection)
```
#RESUME HERE###
```{r, eval=TRUE}
#Mean low access percentage
mean_LA<- test_counties_inner %>% dplyr::summarise(Mean_LA_County = mean(wm_FARA, na.rm = TRUE))
mean_LA #Mean county low access was 38.16%
```

```{r}
#Median low access percentage
median_LA<- test_counties_inner %>% dplyr::summarise(Median_LA_County = median(wm_FARA, na.rm = TRUE))
median_LA #Median county low access was 36.44%
```

```{r, eval=TRUE}
#How many counties have 100% of population with low access?

y<-test_counties_inner$wm_FARA  

counttoplowaccess<-length(which(y == 100))
counttoplowaccess #55 counties have 100% of the population with low access to food

#Lowest access counties identified

Lowest_access_counties<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, wm_FARA) %>% slice_max(wm_FARA) 
Lowest_access_counties
View(Lowest_access_counties)
```

```{r, eval=TRUE}
#In what counties do more than 75% of the population have low food access?

yseventyfive<- test_counties_inner$wm_FARA
countseventyfive<- length(which(yseventyfive > 75))
countseventyfive #In 165 counties greater than 75% of the population has low food access

Topquartile<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, wm_FARA) %>% filter(wm_FARA > 75)
Topquartile
View(Topquartile)
```


```{r, eval=TRUE}
#What regions have the lowest food access?
Topregions<- Topquartile %>% dplyr::summarise(count(REGION.x)) 
Topregions
Topregions_summary<- dplyr::arrange(Topregions, desc(freq))
Topregions_summary
#Ranked by number of counties with >75% of population with low food access: Midwest with 67 counties; South with 55 counties; West with 42 counties, Northeast with 1 county, for 165 counties total 
```

```{r, eval=TRUE}
#How many counties have 0% of population with low access (that is, they are high food access)?

y1<-test_counties_inner$wm_FARA  
countleastlowaccess<-length(which(y1 == 0))
countleastlowaccess #38 counties have 0% of the population with low access to food

#Highest access counties (0% of population is low access)
Highest_access_counties<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, wm_FARA) %>% slice_min(wm_FARA) 
Highest_access_counties
View(Highest_access_counties)
```

```{r, eval=TRUE}
#Double-checking to make sure there are no counties that are missing low access values
y2<-test_counties_inner$wm_FARA  
countmissinglowaccess<-length(which(is.na(y2)))
countmissinglowaccess #0 counties are missing values for low access
```

```{r, eval=TRUE}
#Continuing exploratory data analysis with diabetes...

#Inspecting a trimmed-down dataframe
selection_dm<- test_counties_inner %>% dplyr::select(COUNTY.x, STATE.x, CHR_PCT_DIABETES)
View(selection_dm)
```

```{r, eval=TRUE}
#Mean percentage of population with diabetes
mean_DM<- test_counties_inner %>% dplyr::summarise(Mean_DM_County = mean(CHR_PCT_DIABETES, na.rm = TRUE))
mean_DM #Across counties, mean percentage of population with diabetes was 11.66%

#Median percentage of population with diabetes
median_DM<- test_counties_inner %>% dplyr::summarise(Median_DM_County = median(CHR_PCT_DIABETES, na.rm = TRUE))
median_DM #Across counties, median perentage of population with diabetes was 11.5%
```

```{r, eval=TRUE}
#What were the top 100 U.S. counties in terms of greatest percentage of population with diabetes in 2015?

Diabetes_high<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, CHR_PCT_DIABETES) %>% slice_max(CHR_PCT_DIABETES, n = 100)
View(Diabetes_high) #Note that search for top 100 actually returns 109 entries given a number of counties are tied in their population percentages with diabetes
```

```{r, eval=TRUE}
#What regions had the greatest number of counties in the top 100 in terms of percentage of population with diabetes in 2015?

Topregions_DM<- Diabetes_high %>% dplyr::summarize(count(REGION.x) %>% dplyr::arrange(desc(freq)))
View(Topregions_DM)
#South and Midwest. #105 of the top 109 counties in terms of highest percentages of diabetes are in the South. 4 are in the Midwest.
```

```{r, eval=TRUE}
#What are the 100 counties with the lowest percentages of their populations with diabetes?

Diabetes_low<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, CHR_PCT_DIABETES) %>% slice_min(CHR_PCT_DIABETES, n = 100)
View(Diabetes_low)  #Note that search for lowest 100 counties actually returns 111 entries given a number of counties are tied in their population percentages with diabetes
```

```{r}
#What regions are represented by the bottom 100 counties, those counties that have the lowest percentage of population with diabetes? 

Bottomregions_DM<- Diabetes_low %>% dplyr::summarize(count(REGION.x) %>% dplyr::arrange(desc(freq)))
View(Bottomregions_DM)
#West (69 counties), Midwest (25 counties), Northeast (9 counties), South (8 counties)
```

```{r, eval=TRUE}
#Double-checking to verify that no counties are missing values for diabetes prevalence

y_dm<-test_counties_inner$CHR_PCT_DIABETES  
countmissingdm<-length(which(is.na(y_dm)))
countmissingdm #0 counties are missing values for diabetes prevalence
```


```{r, eval=TRUE}
#Exploratory data analysis - getting set up for choropleths and leaflets 
library(RColorBrewer)

my_theme <- function() {
  theme_minimal() +                                  
  theme(axis.line = element_blank(),                 
        axis.text = element_blank(),                 
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  
        legend.key.size = unit(0.5, "cm"),          
        legend.text = element_text(size = 10),       
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))      
}  
myPalette <- colorRampPalette(brewer.pal(9, "YlOrRd")) 


#colors
library(leaflet)
# Select a color palette with which to run the palette function
pal_fun <- colorNumeric("BuPu", NULL)       # Blue-Purple from RColorBrewer
pal_fun2 <- colorNumeric("YlOrRd", NULL)    # Yellow-Orange-Red from RColorBrewer
pal_fun3 <- colorNumeric("viridis", NULL)   # viridis from viridis
pal_fun4 <- colorNumeric("inferno", NULL)   # inferno from viridis
pal_fun5 <- colorNumeric("inferno", NULL, reverse=TRUE)  # reverses the color ramp
```

```{r}
#Choropleths (welcome any suggestions for making them prettier, less clunky, noting scalebar overlaying the choropleth)

#Low access choropleth
ggplot() +
  geom_sf(data = test_counties_inner, aes(fill = wm_FARA), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with low access to food, by U.S. county, 2015, left, pink scheme") +
  scale_fill_continuous(low = "antiquewhite2", high = "red", guide = "colorbar") +
  north(x.min = -75.28031, y.min = 39.86747,    # add north bar with north()
        x.max = -74.95575, y.max = 40.13793,    # set map boundaries with x.min, y.min, etc..      
        symbol=12,                              # select north arrow symbol
        anchor = c(x = -75, y = 39.93)) +       # set north bar location
  scalebar(x.min = -75.28031, y.min = 39.86747, # add scalebar with scalebar()
           x.max = -74.95575, y.max = 40.13793, # set map boundaries
           dist = 5, dist_unit = 'km',          # set scalebar segment length = 5km
           transform = TRUE,                    # TRUE for decimal degree coordinates
           model = "WGS84")                      # specify CR
```

```{r}
#Diabetes choropleth
ggplot() +
  geom_sf(data = test_counties_inner, aes(fill = CHR_PCT_DIABETES), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with diabetes, by U.S. county, 2015, left, pink scheme") +
  scale_fill_continuous(low = "antiquewhite2", high = "red", guide = "colorbar") +
  north(x.min = -75.28031, y.min = 39.86747,    # add north bar with north()
        x.max = -74.95575, y.max = 40.13793,    # set map boundaries with x.min, y.min, etc..      
        symbol=12,                              # select north arrow symbol
        anchor = c(x = -75, y = 39.93)) +       # set north bar location
  scalebar(x.min = -75.28031, y.min = 39.86747, # add scalebar with scalebar()
           x.max = -74.95575, y.max = 40.13793, # set map boundaries
           dist = 5, dist_unit = 'km',          # set scalebar segment length = 5km
           transform = TRUE,                    # TRUE for decimal degree coordinates
           model = "WGS84")                      # specify CR

```

```{r}
#Leaflet for low access
#Popup message - low access
pu_message1 <- paste0(test_counties_inner$COUNTY.x, ", ", test_counties_inner$STATE.x, "<br>Low food access percentage 2015: ", round(test_counties_inner$wm_FARA, 1), "%")

#Interactive map with legend and scalebar
leaflet(test_counties_inner) %>%
  addPolygons(fillColor = ~pal_fun3(wm_FARA),   
  popup = pu_message1) %>%             
  addTiles() %>% addLegend("bottomright", pal=pal_fun3,        values = ~wm_FARA,
            title = '2015 Low food access percentages by U.S. county',
            opacity = 1) %>% addScaleBar() 

```

```{r}
#Leaflet for diabetes prevalence

#Popup message - diabetes
pu_message2 <- paste0(test_counties_inner$COUNTY.x, ", ", test_counties_inner$STATE.x, "<br>Diabetes prevalence 2015: ", round(test_counties_inner$CHR_PCT_DIABETES, 1), "%")


#Interactive map with legend and scalebar
leaflet(test_counties_inner) %>%
  addPolygons(fillColor = ~pal_fun3(CHR_PCT_DIABETES),   
  popup = pu_message2) %>%             
  addTiles() %>% addLegend("bottomright", pal=pal_fun3,        values = ~CHR_PCT_DIABETES,
            title = '2015 Diabetes prevalence rates by U.S. county',
            opacity = 1) %>% addScaleBar() 
```

```{r, eval=TRUE}
#Scatterplot, correlation between low access percentage and diabetes percentage

#Which, if any, of the following are worth keeping? Suggestions welcome.

library(modelsummary)
```

```{r}
#Scatterplot
ggplot(test_counties_inner, aes(x = wm_FARA, y = CHR_PCT_DIABETES)) +
    geom_point(color = "darkseagreen3") + ggtitle("Scatterplot: Low food access vs. Diabetes prevalence")
```

```{r}
#Correlation

  #Pearson
cor(test_counties_inner$wm_FARA, test_counties_inner$CHR_PCT_DIABETES, use = "complete.obs") 

  #Spearman
cor(test_counties_inner$wm_FARA, test_counties_inner$CHR_PCT_DIABETES, use = "complete.obs", method = "spearman") #Rank-based correlation
```

```{r}
#Create a logistic model
#Which variable sequence is correct?
LA_DM_lm_fit <- lm(CHR_PCT_DIABETES ~ wm_FARA, data = test_counties_inner)
LA_DM_lm_fit
```

```{r}
#Summarize logistic model
summary_LA_DM_lm_fit <- summary.lm(LA_DM_lm_fit) #Summary of results
summary_LA_DM_lm_fit
```

```{r}
#Retrieving output from summary statistics for model fit
names(summary_LA_DM_lm_fit) 
summary_LA_DM_lm_fit$adj.r.squared
```

```{r}
#Retrieving specific elements from the model statistics
coef(LA_DM_lm_fit) #We recover the intercept and coefficient for x that are expected
confint(LA_DM_lm_fit) #Confidence intervals for fit
ggplot(test_counties_inner, aes(x = wm_FARA, y = CHR_PCT_DIABETES)) +
    geom_point(color = "darkseagreen3") + 
    geom_smooth(method = "lm", color = "green4")
```

```{r}
#Model summary provides a nicer table of output
modelsummary(LA_DM_lm_fit, statistic = "p.value") 
summary(LA_DM_lm_fit)
#How best to interpret these findings? As food access becomes more limited in a county, prevalence of diabetes decreases?
```


```{r, eval=TRUE}
#Assessing other variables that may have a relationship to diabetes prevalence, beyond low access to food...

#Median household income
ggplot(test_counties_inner, aes(x = ACS_MEDIAN_HH_INC, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") + ggtitle("Median household income relationship to diabetes prevalence")
summary((lm(CHR_PCT_DIABETES ~ ACS_MEDIAN_HH_INC, data = test_counties_inner)))
```

```{r}
#Per capita income
ggplot(test_counties_inner, aes(x = ACS_PER_CAPITA_INC, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") + ggtitle("Per capita income relationship to diabetes prevalence")
summary((lm(CHR_PCT_DIABETES ~ ACS_PER_CAPITA_INC, data = test_counties_inner)))
```

```{r}
#Obesity
ggplot(test_counties_inner, aes(x = CHR_PCT_ADULT_OBESITY, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") +
  ggtitle("Obesity rate relationship to diabetes prevalence") 
summary((lm(CHR_PCT_DIABETES ~ CHR_PCT_ADULT_OBESITY, data = test_counties_inner)))
```

```{r}
#Uninsured status
ggplot(test_counties_inner, aes(x = ACS_PCT_UNINSURED, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") + ggtitle("Uninsured status relationship to diabetes prevalence")
summary((lm(CHR_PCT_DIABETES ~ ACS_PCT_UNINSURED, data = test_counties_inner)))
```

```{r, eval=TRUE}
#Combined linear models

#Including median income
lm_medincome <- lm(CHR_PCT_DIABETES ~ wm_FARA + ACS_MEDIAN_HH_INC, data = test_counties_inner)
summary(lm_medincome)
modelsummary(lm_medincome)

#Including per capita income
lm_percapincome <- lm(CHR_PCT_DIABETES ~ wm_FARA + ACS_PER_CAPITA_INC, data = test_counties_inner)
summary(lm_percapincome)

#Including obesity
lm_obesity <- lm(CHR_PCT_DIABETES ~ wm_FARA + CHR_PCT_ADULT_OBESITY, data = test_counties_inner)
summary(lm_obesity)

#Including uninsured status
lm_uninsured <- lm(CHR_PCT_DIABETES ~ wm_FARA + ACS_PCT_UNINSURED, data = test_counties_inner)
summary(lm_uninsured)
```

```{r}
#How about a model that accounts for all of the above variables?
#Trying...
lm_combinedvars<- lm(wm_FARA ~ CHR_PCT_DIABETES + ACS_MEDIAN_HH_INC + ACS_PER_CAPITA_INC + CHR_PCT_ADULT_OBESITY + ACS_PCT_UNINSURED, data = test_counties_inner)

#Which of the following is the best output?
modelsummary(lm_combinedvars, statistic = "p.value")
modelsummary(lm_combinedvars)
lm_combinedvars
summary(lm_combinedvars) #I tend to prefer summary
#How to properly interpret these findings? #How to state conclusions about relationship between Low access and Diabetes prevalence, and these other variables appropriately?
```


#The following are code-writing reference materials (from practicums, homeworks), not part of final project...
##############################################################
#From reference, taken from practicum 5 - does this material help at all to interpret the impact of other variables such as median income, obesity etc.?
#  We might try a combined model to see whether the change in fev1 associated with fvc changes by sex, or whether there is an interaction between fvc and sex. Recall from lecture that the `+ sex` term allows for a potential change in intercept in the line that models `fev1 ~ fvc` for a given sex, while the `+ fvc:sex` term allows for a potential change in slope that models the `fev1 ~ fvc` relationship for a given sex.

lm1 <- lm(fev1 ~ fvc + sex, data = nhanes)
lm2 <- lm(fev1 ~ fvc + sex + fvc:sex, data = nhanes)
modelsummary(list(lm1, lm2), coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             estimate = "{estimate} [{conf.low}, {conf.high}]")
################################################################
```
##############################################################
#Extra content from homework #2 for reference, possible use:

#* How many subjects had wheezing or whistling in their chest in the past year?
{r, eval = TRUE}
x<-nhanesdata$RDQ070
count1<- length(which(x==1))
count1

#* How many adults are part of the study (with adults defined as age of 18 years or greater)?
{r, eval = TRUE}
y<-nhanesdata$RIDAGEYR
countadult<- length(which(y>= 18))
countadult

#From homework #3
#    + How many flights in the dataset had destination of Miami International Airport (MIA)? Which airport had the most departing flights to MIA?
{r, eval=TRUE}
library(nycflights13)
table(flights$dest == "MIA")
    

table(flights$dest == 'MIA', flights$origin)
```    
#    + Of the flights that departed from JFK and LGA with time spent in the air greater than two hours, how many had tail numbers (tailnum) containing JB? Which airlines (carrier) flew these flights, and how many of these flights corresponded to each carrier?
{r, eval = TRUE}    
library(dplyr)
listone<- dplyr::select(flights, -year, - month, -day, -dep_time, -sched_dep_time, -dep_delay, -arr_time, -sched_arr_time, -arr_delay, -flight, -dest, -distance, -hour, -minute)
listtwo<- dplyr::filter(listone, origin == 'JFK' | origin == 'LGA', air_time >120) %>% group_by(tailnum, carrier)
listthree<- dplyr::filter(listtwo, (grepl('JB', tailnum))) %>% group_by(carrier)
listthree %>% count(carrier)
``` 
#    + List the top 10 destinations based on having the most flights to each, along with the number of flights to each destination. Next, list the destination with the most flights per month, along with the corresponding number of flights for each month.
{r, eval=TRUE}
flights %>% count(dest)
destcount<- flights %>% count(dest)
head(destcount)
dplyr::arrange(destcount, desc(n))

flfreq<- flights %>% dplyr::group_by(month, dest) %>% dplyr::summarise(destfreq= n())
flfreq
arrange(flfreq, desc(destfreq))
top_1<- flfreq %>% dplyr::slice_max(destfreq, n = 1)
top_1
```               
    + Was the mean arrival delay (arr_delay) per carrier related to the total number of flights per carrier? The answer should show a plot and use one sentence to address this question qualitatively. That is, there is no need to create a model to formally evaluate a relationship.
    

{r, eval = TRUE}
library(ggplot2)
mean_arr_delay<- flights %>% dplyr::group_by(carrier) %>%
summarise(mean_delay = mean(arr_delay, na.rm = TRUE))
mean_arr_delay

tot_fl_carrier<- flights %>% dplyr::select(carrier, flight) %>%
group_by(carrier) %>%
summarise(totflights = n())
tot_fl_carrier

fulljoin <- dplyr::full_join(mean_arr_delay, tot_fl_carrier)
fulljoin

p <- ggplot(fulljoin, aes(x = totflights, y = mean_delay)) + geom_point() + geom_smooth(method= "lm", color = "red")
p
###########################################################
END OF DRAFT
###