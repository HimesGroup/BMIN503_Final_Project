---
title: "Assessment of the relationship between low food access and type 2 diabetes prevalence in United States counties"
author: "John D. McGreevey III" 
output: 
  html_document:
    theme: paper 
    highlight: tango
---


#Overview

Social determinants of health, such as inadequate housing, lack of access to reliable transportation, and insufficient food access, have increasingly been recognized as being factors that adversely impact health outcomes(1). In this project, with guidance from advisors John Holmes, PhD and Sameh Saleh, MD, I will attempt to determine if there is an observed association between low food access and type 2 diabetes prevalence in the United States for the most recent year for which data about both were available, 2015. It is possible that there is a positive association between decreased food access and type 2 diabetes prevalence, as individuals in low food access areas may have little choice but to rely on convenience foods and fast foods for their nutritional intake, which is likely to increase the risk of developing type 2 diabetes. I will use the AHRQ Social Determinants of Health dataset for this work.

Link to final project Github repository: https://github.com/mcgreevj/BMIN503_Final_Project


#Introduction 

Type 2 diabetes is a major health problem in the United States, with significant morbidity and mortality for the at least 33 million people who suffer with this condition. Additionally, the economic costs of type 2 diabetes in the aggregate are substantial, totaling $327 billion in 2017(2). Tragically, type 2 diabetes is largely a preventable disease that has modifiable risk factors (weight, diet, exercise)(3). Increasingly, there has been recognition that social determinants of health can serve as barriers that prevent individuals from being able to successfully modify risk factors. For example, individuals who lack access to insurance and/or reliable transportation may not be able to seek routine medical care for education, prevention, monitoring, and treatment purposes. As noted, diet is a major factor in the development of type 2 diabetes. And while ideal diets to prevent type 2 diabetes have been advised, not every American necessarily has access to food to be able to consume these recommended diets(4). This is the phenomenon of food insecurity. Food insecurity is formally defined by the US Department of Agriculture as: “the limited or uncertain availability of nutritionally adequate and safe foods, or limited or uncertain ability to acquire acceptable foods in socially acceptable ways.”(5)  One factor that can lead to lack of access to healthy foods is the phenomenon of food deserts – areas that are low income and that have few or no supermarkets or other sources of healthy food options. As formally defined by the USDA, a food desert is: “A census tract that meets both low-income and low-access criteria including: 1. poverty rate is greater than or equal to 20 percent OR median family income does not exceed 80 percent statewide (rural/urban) or metro-area (urban) median family income; 2. at least 500 people or 33 percent of the population located more than 1 mile (urban) or 10 miles (rural) from the nearest supermarket or large grocery store.”(6) In the absence of options for healthy food, individuals residing in these communities may need to resort to convenience and fast foods for some or many of their meals. In doing so, they increase the risk of developing type 2 diabetes.(7) 

This project is interdisciplinary in that it combines census tract, geographical data with health survey data. Notably the AHRQ SDOH database integrates data from multiple surveys and sources. The fields and topics that contribute to understanding of this issue are multiple: public health, clinical medicine, sociology, health disparities, economics, geography, history (in that the reasons many communities have limited access to food involves historical structural decisions, including forms of structural racism such as redlining). Moreover, the findings of this project have social justice, ethical, cultural, economic, and political implications. Based on collaboration with my mentors, I have learned the importance of familiarizing myself with data sources and data definitions, notably the Data Source Documentation guide from AHRQ (AHRQ Social Determinants of Health (SDOH) Database). This step is necessary from an exploratory standpoint to contemplate what kind of project I might do and also from a practical standpoint to understand how to properly and specifically answer my project question with the available data. I have also learned that some questions may be challenging to answer exactly as initially envisioned. For example, when considering this project at first, I had hoped to show changes over time in the association between limited food access and type 2 diabetes prevalence, perhaps including recent data from 2020 or 2021. However, after close inspection of this SDOH data set, I have realized that not all data is available for every year of interest. Thus I have needed to narrow the scope of my project a bit, given that data for limited food access and diabetes prevalence intersect in 2015, which is the most recent year that both types of data are available.

The identification of an independent association between low food access and type 2 diabetes prevalence would help support the case for policies and programs (both at the national and state levels) to improve food access in impacted census tracts. From a social justice standpoint, those with power in society (elected office holders, business and community leaders, members of the health care community including researchers) have a responsibility to seek ways to provide a known and effective preventive therapy (whether a vaccine or a grocery store) to those without such access currently, to prevent disease. There is also a national public health and cost dimension to this topic. People with diabetes suffer complications and morbidity related to diabetes, impairing their ability to support themselves, live independent lives, and contribute to a community’s economic activity and well-being. At the same time, the national cost of providing care for individuals with type 2 diabetes is borne by all Americans, in part because individuals living in low access food areas are more likely to have public (Medicaid, Medicare) insurance, if they have insurance at all, that is funded by all U.S. taxpayers. Indeed, Medicaid and Medicare combined provide health coverage to approximately 36% of Americans today and that percentage continues to rise over time.(8) “Uncompensated” care for individuals with type 2 diabetes who lack any type of insurance is also a cost borne by individual health care organizations, governments, and ultimately, taxpayers. Greater awareness of the relationships between SDOH and health outcomes, combined with a blunt accounting of the costs of inaction on this subject, will hopefully spur actions that can help mitigate SDOH and improve both individual and community health. 

My project attempts a descriptive analysis, that is: adjusting for obesity, uninsured status, and household income, is there an association between food access and diabetes percentage? 

#Methods
For this project, I used the AHRQ Social Determinants of Health database (available at https://www.ahrq.gov/sdoh/data-analytics/sdoh-data.html). I reviewed the data source documentation document (https://www.ahrq.gov/sites/default/files/wysiwyg/sdoh/SDOH-Data-Sources-Documentation-v1-Final.pdf) to learn about potential variables for this project and their availability. Ultimately, I planned to use two main variables available in the SDOH database: CHR_PCT_DM and FARA_PCT_LA_HALF_10_POP. 

CHR_PCT_DIABETES is defined by the data source document above as the "percentage of adults with diagnosed diabetes 
(ages 20 and over)." Data for this variable is provided by the CDC Interactive Diabetes Atlas which in turn uses BRFSS data to estimate prevalence by U.S. county. Notably, starting in 2015, BRFSS included both landline and cellphone survey data to obtain diabetes prevalence data. Previously, this data had been collected exclusively via landline surveys. 

Importantly, CHR_PCT_DIABETES is provided by U.S. county.

FARA_PCT_LA_HALF_10_POP is defined as the "percentage of [healthy food] low access population measured at 1/2 mile for urban areas and 10 miles for rural areas." For this variable, low access to healthy food is defined as being far from a supermarket, supercenter, or large grocery store, so more than 1/2 mile in urban areas and more than 10 miles in rural areas for this variable. 

FARA_PCT_LA_HALF_10_POP comes from the Food Access Research Atlas (FARA), created by the Economic Research Service (ERS) at the United States Department of Agriculture. A mapping tool is offered by the ERS and is available here: https://www.ers.usda.gov/data-products/food-access-research-atlas/go-to-the-atlas/. 

In contrast to CHR_PCT_DIABETES, FARA_PCT_LA_HALF_10_POP is provided at the census tract level.

For further reference, the following is the ERS methodology for calculating distance to the nearest grocery store, excerpted from the ERS definitions document available at https://www.ers.usda.gov/data-products/food-access-research-atlas/documentation/:

"First, the entire country is divided into ½-kilometer (about 1/3-mile)-square grids, and data on the population are aerially allocated to these grids (see Low-Income and Low-Foodstore-Access Census Tracts, 2015-19 in the link below). Distance to the nearest supermarket is measured for each grid cell by calculating the distance between the geographic center of the ½-kilometer square grid that contains estimates of the population (number of people and other subgroup characteristics) and the center of the grid with the nearest supermarket."

While I had hoped to be able to include recent data for this project, the most recent year that data for both CHR_PCT_DIABETES and FARA_PCT_LA_HALF_10_POP is available is 2015.   

After consulting with Drs. Holmes and Saleh about variable choices, I loaded the appropriate datasets into R.

For CHR_PCT_DIABETES, the 2015 data (by county) was available as an Excel file here: https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fwww.ahrq.gov%2Fsites%2Fdefault%2Ffiles%2Fwysiwyg%2Fsdoh%2FSDOH_2015_COUNTY_1_0.xlsx&wdOrigin=BROWSELINK.

For FARA_PCT_LA_HALF_10_POP, the 2015 data (by tract) was available as an Excel file here: 
https://www.ahrq.gov/downloads/sdoh/sdoh_2015_tract_1_0.xlsx.

#Retrieving, inspecting, and cleaning data

#Here I am loading the package readxl that will allow me to read Excel data
```{r, eval=TRUE}
library("readxl")
```
#Read in the 2015 low access data, reported by census tract
```{r, eval=TRUE}
Lowaccess_raw<- read_excel("C:\\Users\\McGreevJ\\Desktop\\BMI 5030 Data Science\\BMIN503_Final_Project\\Adjusted datasets\\data.sdoh_2015_tract_1_0.xlsx")
dim(Lowaccess_raw) #74133 x 405
```

#Read in the 2015 diabetes prevalence data, reported by county
```{r, eval=TRUE}
Diabetes_raw<- read_excel("C:\\Users\\McGreevJ\\Desktop\\BMI 5030 Data Science\\BMIN503_Final_Project\\Adjusted datasets\\data.SDOH_2015_COUNTY_1_0.xlsx")
dim(Diabetes_raw) #3234 x 979
```

#Here I loaded other relevant packages and then checked for differences between the Lowaccess_raw and Diabetes_raw datasets; notably, to see if the same COUNTYFIPS codes were represented in both.
```{r}
library(tidyverse)
library(cowplot)
library(dplyr)


setdiff(Lowaccess_raw$COUNTYFIPS, Diabetes_raw$COUNTYFIPS)
#COUNTYFIPS 69085 (Northern Mariana Islands) is the only difference. 69085 is represented in Lowaccess_raw but not in Diabetes_raw.
```

#Once loaded into R, I manipulated each of these raw datasets so as to limit them to the variables of interest, tracking dimensions of the dataframes as I went along.
```{r}
#Define "Lowaccess" as a subset of "Lowaccess_raw" to include TRACTFIPS, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, FARA_TRACT_LILA_HALF_10, FARA_PCT_LA_HALF_10_POP

Lowaccess<- dplyr::select(Lowaccess_raw, TRACTFIPS, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, FARA_TRACT_LILA_HALF_10, FARA_PCT_LA_HALF_10_POP)
dim(Lowaccess) #74133 x 9
```

```{r}
#Define "Diabetes" as a subset of "Diabetes_raw" to include COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, ACS_MEDIAN_AGE, ACS_PCT_EMPLOYED, ACS_MEDIAN_HH_INC, ACS_PCT_HH_INC_10000, ACS_PCT_HH_INC_100000, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_MEDICAID_ANY, ACS_PCT_MEDICAID_ANY_BELOW64, ACS_PCT_MEDICARE_ONLY, ACS_PCT_PRIVATE_ANY, ACS_PCT_UNINSURED, CEN_AIAN_NH_IND, ACS_TOT_HH, ACS_AVG_HH_SIZE, ACS_PCT_CHILD_1FAM, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES
Diabetes<- dplyr::select(Diabetes_raw, COUNTYFIPS, STATEFIPS, STATE, COUNTY, REGION, ACS_TOT_POP_WT, ACS_MEDIAN_AGE, ACS_PCT_EMPLOYED, ACS_MEDIAN_HH_INC, ACS_PCT_HH_INC_10000, ACS_PCT_HH_INC_100000, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_MEDICAID_ANY, ACS_PCT_MEDICAID_ANY_BELOW64, ACS_PCT_MEDICARE_ONLY, ACS_PCT_PRIVATE_ANY, ACS_PCT_UNINSURED, CEN_AIAN_NH_IND, ACS_TOT_HH, ACS_AVG_HH_SIZE, ACS_PCT_CHILD_1FAM, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES)
dim(Diabetes) #3234 x 25
```

#In anticipation of ultimately needing a county population value in order to calculate a weighted mean of FARA_PCT_LA_HALF_10_POP by county, I renamed ACS_TOT_POP_WT within the Diabetes dataframe to County_Pop. I then confirmed the column had been renamed and checked the dimensions of Diabetes to assure they remained unchanged.
```{r}
Diabetes<- dplyr::rename(Diabetes, "County_Pop" = ACS_TOT_POP_WT)
head(Diabetes)
dim(Diabetes) #3234 x 25
```


#I performed an innerjoin of Diabetes and Lowaccess by the variable that was common to both, COUNTYFIPS, recognizing that this step would only preserve rows that both dataframes had in common. I inspected the header of the joined dataframe and checked its dimensions again, noting the number of rows had been reduced from 74133 to 74132.
```{r}
#Innerjoin Diabetes and Lowaccess
test_innerjoin<- inner_join(Diabetes, Lowaccess, by = "COUNTYFIPS")
head(test_innerjoin)
dim(test_innerjoin) #74132 x 33
```

#I expected the one COUNTYFIPS discrepancy (Northern Mariana Islands, code 69085 as noted previously) to have been excluded from this innerjoined dataframe and checked for its presence.
```{r}
#Inspecting to see if Northern Mariana (69085) is present in test_innerjoin
View(test_innerjoin)
```
#A search of the table above for 69085 yielded no results, so Northern Mariana had been excluded, as desired and as expected.

#I then created a new variable to represent weighted population, census_tract_pop_wt, which is the tract population divided by the county population. Again, I inspected the header to verify the variable had been successfully added. I once again checked dimensions and as expected, noted the number of variables had increased by one, from 33 to 34.
```{r}
test_innerjoin<- dplyr::mutate(test_innerjoin, "census_tract_pop_wt" = (ACS_TOT_POP_WT/County_Pop))
head(test_innerjoin)
dim(test_innerjoin) #74132 x 34
```

#Having visually inspected my data, I noted that some tracts had NA values for FARA_PCT_LA_HALF_10_POP. Recognizing that my weighting calculations would produce an error if I attempted to perform them using NA values, I assessed to see how many NA values were present for this variable.
```{r}
sum(is.na(test_innerjoin$FARA_PCT_LA_HALF_10_POP))
```

#Finding 1625 NA values, I removed these NA values from test_innerjoin so as to allow me to perform the weighting calculations.
```{r}
test_innerjoin<- test_innerjoin %>% drop_na(FARA_PCT_LA_HALF_10_POP)
```

#I then inspected my updated test_innerjoin dataframe dimensions to verify that all 1625 NA values had been removed. Indeed, the rows had decreased from 74132 to 72507 as expected. Visual inspection of test_innerjoin confirmed no remaining NA values for FARA_PCT_LA_HALF_10_POP. 
```{r}
dim(test_innerjoin) 
View(test_innerjoin) 
```

#I created a new dataframe based on test_innerjoin that contained a newly-defined weighted mean variable, wm_FARA, using the weighted.mean function, which was the FARA_PCT_LA_HALF_10_POP for a tract multiplied by census_tract_pop_wt. I summarized wm_FARA and grouped results by COUNTYFIPS (one row per county). Other variables of interest for the analysis were included as well.
```{r}
colnames(test_innerjoin)
test_innerjoin_wtmean<- test_innerjoin %>% dplyr::group_by(COUNTYFIPS, COUNTY.x, STATE.x, REGION.x, County_Pop, ACS_MEDIAN_HH_INC, ACS_PER_CAPITA_INC, ACS_PCT_POV_AIAN, ACS_MEDIAN_HOME_VALUE, ACS_PCT_UNINSURED, CHR_PCT_ADULT_OBESITY, CHR_PCT_DIABETES) %>% dplyr::summarise(wm_FARA = weighted.mean(FARA_PCT_LA_HALF_10_POP, census_tract_pop_wt)) %>% as.data.frame()
```
#Once again, I inspected this new dataframe to verify that I had created wm_FARA successfully and that each county had a single row in the dataframe. I again checked the dimensions of this new dataframe.
```{r}
head(test_innerjoin_wtmean)
dim(test_innerjoin_wtmean) #3140 x 13
```

#I noted that while the earlier county-level dataframe (Diabetes) had 3234 rows, test_innerjoin_wtmean only had 3140 rows. I went about an analysis to understand why there was a difference in row counts starting with setdiff.
```{r}
setdiff(Diabetes$COUNTYFIPS, test_innerjoin_wtmean$COUNTYFIPS)
```
#There were 94 counties in Diabetes that were not in test_innerjoin_wtmean. Using "View(Diabetes)" I visually inspected the Diabetes table again to look for a pattern among these 94 counties in question.

#These counties appeared to be in Alaska and U.S. territories. Examples included: 02158 (Kusilvak Census Area, AK), 60010 (Am Samoa), 72151 (Puerto Rico), 78030 (US Virgin Islands). Excluding these counties from test_innerjoin_wtmean was acceptable given that I did not have the ability to plot choropleths (see counties rds file below) with these non-continental U.S. counties.

#I next began preparing for the exploratory analysis by loading various necessary packages first and then loading county geography data.

```{r, eval=TRUE}
library(rgdal)
library(leaflet)
library(ggplot2)
library(RColorBrewer)
library(plyr)
library(sf)
library(tidycensus)
library(ggsn)


counties<- readRDS(gzcon(url("https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds")))

st_crs(counties) <- st_crs(counties)

#Using base plot function to check that counties contains polygon data: 
plot(counties)

#Using ggplot to check that counties contains polygon data:
ggplot() +
    geom_sf(data = counties)
```

#Here I began the process of joining test_innerjoin_wtmean and counties but first needed to create a common variable by which to join. I converted State to a 2 digit number in counties, then concatenated State and County into a 5 digit number, a mutated variable in counties called "COUNTYFIPS" to correspond to "COUNTYFIPS" in the combined data set, test_innerjoin_wtmean. 
```{r, eval=TRUE}
counties$STATE<- str_pad(counties$STATE, width=2, side="left", pad="0")
head(counties)

counties<- counties %>% dplyr::mutate(COUNTYFIPS = paste(STATE, COUNTY, sep = ""))
head(counties)
```
#Also before joining test_innerjoin_wtmean and counties, I inspected both to verify that the number of COUNTYFIPS codes were the same in each. This process yielded the following results:
```{r}
counties %>% summarise(n_distinct(COUNTYFIPS)) #3109

test_innerjoin_wtmean %>% summarise(n_distinct(COUNTYFIPS)) #3140

#So 31 rows appear to be different between counties and test_innerjoin_wtmean in terms of COUNTYFIPS values

setdiff(counties$COUNTYFIPS, test_innerjoin_wtmean$COUNTYFIPS)

#Yields 2 COUNTYFIPS, 46113 and 51515 that are different, both present in counties but not in test_innerjoin_wtmean

#These 2 COUNTYFIPS are:

#Shannon County, SD (FIPS code = 46113). After investigation, this county was renamed Oglala Lakota County and assigned a new FIPS code (46102) effective in 2014.

#Bedford City, VA (FIPS code=51515). After investigation, I discovered that in 2013, Bedford City, an independent city, merged with Bedford County (FIPS code=51019). Apparently, Bedford City category codes are the same as those for Bedford County.

#However, this prompted me to ask "what about the other rows that are different? What are those rows?"

#Using the alternate sequence for setdiff, with test_innerjoin_wt mean first:
setdiff(test_innerjoin_wtmean$COUNTYFIPS, counties$COUNTYFIPS)
#Yields 33 differences, pasted here, that are present in test_innerjoin_wtmean but not present in counties:
#1 "02013" "02016" "02020" "02050" "02060" "02068"
 #7 "02070" "02090" "02100" "02105" "02110" "02122"
#13 "02130" "02150" "02164" "02170" "02180" "02185"
#19 "02188" "02195" "02198" "02220" "02230" "02240"
#25 "02261" "02275" "02282" "02290" "15001" "15003"
#31 "15005" "15007" "15009"

#These differences are for Alaska (State code 02) and Hawaii (State code 15). These states are not represented in counties.

#Based on this analysis, I concluded that an innerjoin of counties and test_innerjoin_wtmean would likely omit the Hawaii and Alaska data that is in test_innerjoin_wtmean. For purposes of this project, this omission would be acceptable as my choropleth creation tools are limited to the continental United States.
```

#Based on the above analysis, I felt it was safe to proceed with an innerjoin of counties and test_innerjoin_wtmean by COUNTYFIPS, to create a new dataframe, test_counties_inner.
```{r}
test_counties_inner<- inner_join(counties, test_innerjoin_wtmean, by = 'COUNTYFIPS')
```
#I inspected test_counties_inner to verify that Shannon County, Bedford City, Hawaii, and Alaska rows (as described above) had been removed as expected.
```{r}
str(test_counties_inner) #3107 obs of 20 variables, noting that Hawaii and Alaska data, as well as Shannon County, SD and Bedford City, VA data, have been removed
View(test_counties_inner)
```

#Results

#Section 1: Exploratory analsyis

#I began my exploratory analysis, first by inspecting column names in test_counties_inner to verify that all variables needed for this analysis were present.  
```{r, eval=TRUE}
colnames(test_counties_inner)
```

#Before beginning the exploratory analysis, I also double-checked to verify there were no counties that were missing low food access (wm_FARA) values. I determined that in fact, there were no counties missing wm_FARA values.
```{r, eval=TRUE}
y2<-test_counties_inner$wm_FARA  
countmissinglowaccess<-length(which(is.na(y2)))
countmissinglowaccess 
```

#Also before beginning the exploratory analysis, I verified that no counties were missing values for diabetes prevalence.
```{r, eval=TRUE}
y_dm<-test_counties_inner$CHR_PCT_DIABETES  
countmissingdm<-length(which(is.na(y_dm)))
countmissingdm 

#0 counties are missing values for diabetes prevalence
```


#I began for generating summary statistics for the low access data, notably a mean and a median low access (wm_FARA) percentage across U.S. counties.

#Mean low access percentage
```{r, eval=TRUE}
mean_LA<- test_counties_inner %>% dplyr::summarise(Mean_LA_County = mean(wm_FARA, na.rm = TRUE))
mean_LA #Mean county low access was 38.16%
```

#Median low access percentage
```{r}
median_LA<- test_counties_inner %>% dplyr::summarise(Median_LA_County = median(wm_FARA, na.rm = TRUE))
median_LA #Median county low access was 36.44%
```

#Next I calculated the number of counties that had 100% of their population with low access to food and identified them.
```{r, eval=TRUE}
#How many counties have 100% of population with low access?

y<-test_counties_inner$wm_FARA  

counttoplowaccess<-length(which(y == 100))
counttoplowaccess 

#55 counties have 100% of the population with low access to food

#Lowest access counties identified

Lowest_access_counties<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, wm_FARA) %>% slice_max(wm_FARA) 
Lowest_access_counties
View(Lowest_access_counties)
```

#I then calculated the counties where greater than 75% of the population had low food access and identifed these counties. 
```{r, eval=TRUE}
yseventyfive<- test_counties_inner$wm_FARA
countseventyfive<- length(which(yseventyfive > 75))
countseventyfive 

#In 165 counties greater than 75% of the population has low food access

Topquartile<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, wm_FARA) %>% filter(wm_FARA > 75)
Topquartile
View(Topquartile)
```

#Using the 75% of population with low access threshold above, I then determined which regions had the lowest food access.
```{r, eval=TRUE}
Topregions<- Topquartile %>% dplyr::summarise(count(REGION.x)) 
Topregions
Topregions_summary<- dplyr::arrange(Topregions, desc(freq))
Topregions_summary

#Ranked by number of counties with >75% of population with low food access: Midwest with 67 counties; South with 55 counties; West with 42 counties, Northeast with 1 county, for 165 counties total 
```

#I calculated how many counties have 0% of their population with low food access and identified them.
```{r, eval=TRUE}
y1<-test_counties_inner$wm_FARA  
countleastlowaccess<-length(which(y1 == 0))
countleastlowaccess 

#38 counties have 0% of the population with low access to food

Highest_access_counties<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, wm_FARA) %>% slice_min(wm_FARA) 
Highest_access_counties
View(Highest_access_counties)
```

#I continued the exploratory analysis by generating summary statistics about the diabetes prevalence percentage (CHR_PCT_DIABETES) data.

#Mean percentage prevalence of population with diabetes across U.S. counties
```{r, eval=TRUE}
mean_DM<- test_counties_inner %>% dplyr::summarise(Mean_DM_County = mean(CHR_PCT_DIABETES, na.rm = TRUE))
mean_DM 

#Across counties, mean percentage of population with diabetes was 11.66%
```

#Median percentage prevalence of population with diabetes across U.S. counties
```{r, eval=TRUE}
median_DM<- test_counties_inner %>% dplyr::summarise(Median_DM_County = median(CHR_PCT_DIABETES, na.rm = TRUE))
median_DM 

#Across counties, median perentage of population with diabetes was 11.5%
```

#I identified the top 100 counties in terms of greatest percentage of population with diabetes in 2015.
```{r, eval=TRUE}
Diabetes_high<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, CHR_PCT_DIABETES) %>% slice_max(CHR_PCT_DIABETES, n = 100)
View(Diabetes_high) 

#Note that search for the top 100 actually returned 109 entries given a number of counties were tied in their diabetes prevalence percentages.
```

#I determined what regions were represented by these top 109 counties with the greatest percentage of population with diabetes.
```{r, eval=TRUE}
Topregions_DM<- Diabetes_high %>% dplyr::summarize(count(REGION.x) %>% dplyr::arrange(desc(freq)))
View(Topregions_DM)
#South and Midwest. #105 of the top 109 counties in terms of greatest percentages of diabetes are in the South. 4 are in the Midwest.
```

#I determined the 100 counties with the lowest percentage of their population with diabetes in 2015.
```{r, eval=TRUE}
Diabetes_low<- test_counties_inner %>% dplyr::select(COUNTYFIPS, REGION.x, STATE.x, COUNTY.x, CHR_PCT_DIABETES) %>% slice_min(CHR_PCT_DIABETES, n = 100)
View(Diabetes_low)  

#Note that the search for the 100 counties with the lowest percentage of their populations with diabetes actually returns 111 entries given a number of counties are tied in their population percentages with diabetes.
```

#I determined what regions were represented by these 111 counties with the lowest percentage of population with diabetes.
```{r}
Bottomregions_DM<- Diabetes_low %>% dplyr::summarize(count(REGION.x) %>% dplyr::arrange(desc(freq)))
View(Bottomregions_DM)

#West (69 counties), Midwest (25 counties), Northeast (9 counties), South (8 counties)
```

#Here I prepared for another component of the exploratory analysis, choropleth and leaflet creation.
```{r, eval=TRUE}
library(RColorBrewer)

my_theme <- function() {
  theme_minimal() +                                  
  theme(axis.line = element_blank(),                 
        axis.text = element_blank(),                 
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  
        legend.key.size = unit(0.5, "cm"),          
        legend.text = element_text(size = 10),       
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))      
}  
myPalette <- colorRampPalette(brewer.pal(9, "YlOrRd")) 


#colors
library(leaflet)
# Select a color palette with which to run the palette function
pal_fun <- colorNumeric("BuPu", NULL)       # Blue-Purple from RColorBrewer
pal_fun2 <- colorNumeric("YlOrRd", NULL)    # Yellow-Orange-Red from RColorBrewer
pal_fun3 <- colorNumeric("viridis", NULL)   # viridis from viridis
pal_fun4 <- colorNumeric("inferno", NULL)   # inferno from viridis
pal_fun5 <- colorNumeric("inferno", NULL, reverse=TRUE)  # reverses the color ramp
```

#CHECK THIS
```{r}
#Test choropleth based on Sameh suggestions:

#Low access choropleth, and saving same as png
choro_lowaccess<- ggplot() +
  geom_sf(data = test_counties_inner, aes(fill = wm_FARA), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with low food access, by U.S. county, 2015") + 
addPolygons(
fillColor = ~pal(density), 
weight = 2, 
opacity = 1, 
color = "white", 
dashArray = "3",
fillOpacity = 0.7) +
  scale_fill_continuous(type = "viridis", guide = "colorbar") +
  north(x.min = -75.28031, y.min = 39.86747,    # add north bar with north()
        x.max = -74.95575, y.max = 40.13793,    # set map boundaries with x.min, y.min, etc..      
        symbol=12,                              # select north arrow symbol
        anchor = c(x = -75, y = 39.93)) +       # set north bar location
  scalebar(x.min = -75.28031, y.min = 39.86747, # add scalebar with scalebar()
           x.max = -74.95575, y.max = 40.13793, # set map boundaries
           dist = 5, dist_unit = 'km',          # set scalebar segment length = 5km
           transform = TRUE,                    # TRUE for decimal degree coordinates
           model = "WGS84")                      # specify CR

choro_lowaccess
```

#I generated a low food access choropleth.
```{r}
#Choropleths (welcome any suggestions for making them prettier, less clunky, noting scalebar overlaying the choropleth, county colors look a bid faded...)

#Low access choropleth, and saving same as png
choro_lowaccess<- ggplot() +
  geom_sf(data = test_counties_inner, aes(fill = wm_FARA), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with low food access, by U.S. county, 2015") +
  scale_fill_continuous(low = "antiquewhite2", high = "red", guide = "colorbar") +
  north(x.min = -75.28031, y.min = 39.86747,    # add north bar with north()
        x.max = -74.95575, y.max = 40.13793,    # set map boundaries with x.min, y.min, etc..      
        symbol=12,                              # select north arrow symbol
        anchor = c(x = -75, y = 39.93)) +       # set north bar location
  scalebar(x.min = -75.28031, y.min = 39.86747, # add scalebar with scalebar()
           x.max = -74.95575, y.max = 40.13793, # set map boundaries
           dist = 5, dist_unit = 'km',          # set scalebar segment length = 5km
           transform = TRUE,                    # TRUE for decimal degree coordinates
           model = "WGS84")                      # specify CR

choro_lowaccess
```

#I generated a diabetes prevalence percentage choropleth.
```{r}
choro_diabetes<- ggplot() +
  geom_sf(data = test_counties_inner, aes(fill = CHR_PCT_DIABETES), lwd = 0) +
  my_theme() +
  ggtitle("Percent of population with diabetes, by U.S. county, 2015") +
  scale_fill_continuous(low = "antiquewhite2", high = "red", guide = "colorbar") +
  north(x.min = -75.28031, y.min = 39.86747,    # add north bar with north()
        x.max = -74.95575, y.max = 40.13793,    # set map boundaries with x.min, y.min, etc..      
        symbol=12,                              # select north arrow symbol
        anchor = c(x = -75, y = 39.93)) +       # set north bar location
  scalebar(x.min = -75.28031, y.min = 39.86747, # add scalebar with scalebar()
           x.max = -74.95575, y.max = 40.13793, # set map boundaries
           dist = 5, dist_unit = 'km',          # set scalebar segment length = 5km
           transform = TRUE,                    # TRUE for decimal degree coordinates
           model = "WGS84")                      # specify CR

choro_diabetes
```


#I cretaed a leaflet for low food access.
```{r}
#Popup message - low access
pu_message1 <- paste0(test_counties_inner$COUNTY.x, ", ", test_counties_inner$STATE.x, "<br>Low food access percentage 2015: ", round(test_counties_inner$wm_FARA, 1), "%")

#Interactive map with legend and scalebar
leaflet_lowaccess<-leaflet(test_counties_inner) %>%
  addPolygons(fillColor = ~pal_fun3(wm_FARA),   
  popup = pu_message1) %>%             
  addTiles() %>% addLegend("bottomright", pal=pal_fun3,        values = ~wm_FARA,
            title = '2015 Low food access percentages by U.S. county',
            opacity = 1) %>% addScaleBar() 

leaflet_lowaccess
```

#I created a leaflet for diabetes prevalence.
```{r}
#Popup message - diabetes
pu_message2 <- paste0(test_counties_inner$COUNTY.x, ", ", test_counties_inner$STATE.x, "<br>Diabetes prevalence 2015: ", round(test_counties_inner$CHR_PCT_DIABETES, 1), "%")

#Interactive map with legend and scalebar
leaflet_diabetes<- leaflet(test_counties_inner) %>%
  addPolygons(fillColor = ~pal_fun3(CHR_PCT_DIABETES),   
  popup = pu_message2) %>%             
  addTiles() %>% addLegend("bottomright", pal=pal_fun3,        values = ~CHR_PCT_DIABETES,
            title = '2015 Diabetes prevalence rates by U.S. county',
            opacity = 1) %>% addScaleBar() 

leaflet_diabetes
```

#Next, I generated a scatterplot showing the relationship between low food access (wm_FARA) and diabetes prevalence percentage (CHR_PCT_DIABETES).
```{r, eval=TRUE}
library(modelsummary)
#Scatterplot
ggplot(test_counties_inner, aes(x = wm_FARA, y = CHR_PCT_DIABETES)) +
    geom_point(color = "darkseagreen3") + ggtitle("Scatterplot: Low food access vs. Diabetes prevalence")
```

#I calculated the Pearson correlation coefficient for the above relationship, which showed a mild to moderate negative relationship between wm_FARA and CHR_PCT_DIABETES.
```{r}
cor(test_counties_inner$wm_FARA, test_counties_inner$CHR_PCT_DIABETES, use = "complete.obs") 
```

#Section 2. Results of unadjusted linear regression model analysis

#I then created an unadjusted linear regression model to further assess the relationship between wm_FARA and CHR_PCT_DIABETES.
```{r}
LA_DM_lm_fit <- lm(CHR_PCT_DIABETES ~ wm_FARA, data = test_counties_inner)
LA_DM_lm_fit
```

#I then summarized this linear model, LA_DM_lm_fit. #WHICH of the following to keep?. Findings indicated a very small negative relationship that was statistically significant between wm_FARA and CHR_PCT_DIABETES. 

#THis one?
```{r}
#Summarize linear model
summary_LA_DM_lm_fit <- summary.lm(LA_DM_lm_fit) #Summary of results
summary_LA_DM_lm_fit
```
#Or this one?
```{r}
#Retrieving output from summary statistics for model fit
names(summary_LA_DM_lm_fit) 
summary_LA_DM_lm_fit$adj.r.squared
```
#Or maybe this one?
```{r}
#Retrieving specific elements from the model statistics
coef(LA_DM_lm_fit) #We recover the intercept and coefficient for x that are expected
confint(LA_DM_lm_fit) #Confidence intervals for fit
#Scatterplot with bestfit line
ggplot(test_counties_inner, aes(x = wm_FARA, y = CHR_PCT_DIABETES)) +
    geom_point(color = "darkseagreen3") + 
    geom_smooth(method = "lm", color = "green4") + ggtitle("Scatterplot with best fit line: Low food access vs. Diabetes prevalence")
```
#Or maybe this one?
```{r}
#Model summary provides a nicer table of output
modelsummary(LA_DM_lm_fit, statistic = "p.value") 
summary(LA_DM_lm_fit)
#How best to interpret these findings? As food access becomes more limited in a county, prevalence of diabetes decreases?
```

#Section 3. Results of other variable exploration and adjusted, multivariable linear regression model analysis

#Next, I explored potentially confounding variables in the relationship between wm_FARA and CHR_PCT_DIABETES. I started by creating scatterplots showing the relationship between four variables - median household income, per capita income, obesity percentage by county, and percentage of a county population that was uninsured - with diabetes prevalence. I also created linear models to assess the relationship between each of these variables and diabetes prevalence.

#Median household income
```{r, eval=TRUE}
plot_medhhincome<-ggplot(test_counties_inner, aes(x = ACS_MEDIAN_HH_INC, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") + ggtitle("Med. HH income r/t to diabetes")
summary((lm(CHR_PCT_DIABETES ~ ACS_MEDIAN_HH_INC, data = test_counties_inner)))
plot_medhhincome
```

#Per capita income
```{r}
plot_percapincome<-ggplot(test_counties_inner, aes(x = ACS_PER_CAPITA_INC, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") + ggtitle("Per capita income r/t diabetes")
summary((lm(CHR_PCT_DIABETES ~ ACS_PER_CAPITA_INC, data = test_counties_inner)))
plot_percapincome
```

#Obesity
```{r}
plot_obesity<-ggplot(test_counties_inner, aes(x = CHR_PCT_ADULT_OBESITY, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") +
  ggtitle("Obesity pct r/t to diabetes") 
summary((lm(CHR_PCT_DIABETES ~ CHR_PCT_ADULT_OBESITY, data = test_counties_inner)))
plot_obesity
```

#Uninsured status percentage
```{r}
plot_uninsured<-ggplot(test_counties_inner, aes(x = ACS_PCT_UNINSURED, y = CHR_PCT_DIABETES)) +
  geom_point(color = "sienna4") + ggtitle("Uninsured pct r/t to diabetes")
summary((lm(CHR_PCT_DIABETES ~ ACS_PCT_UNINSURED, data = test_counties_inner)))
plot_uninsured
```

#To see all of the above plots at a glance, I created a grid of the above plots.
```{r}
plot_grid(plot_medhhincome, plot_percapincome, plot_obesity, plot_uninsured, labels = "AUTO")
```

#In considering a multivariable linear model to assess the relationship between wm_FARA and CHR_PCT_DIABETES, I needed to give consideration to the likely colinearity of some of the above variables. As such, for example, I limited the multivariable linear models to exclude potentially confounding variables that were likely to be colinear, such as median household income and per capita income. 
```{r}
#In this linear model, I adjust for obesity and uninsured status percentage
lm_2<- lm(CHR_PCT_DIABETES ~ wm_FARA + CHR_PCT_ADULT_OBESITY + ACS_PCT_UNINSURED, data = test_counties_inner)
summary(lm_2)

#In this linear model, I adjust for obesity and median household income
lm_3<- lm(CHR_PCT_DIABETES ~ wm_FARA + CHR_PCT_ADULT_OBESITY + ACS_MEDIAN_HH_INC, data = test_counties_inner)
summary(lm_3)
```

#In these adjusted, multivariable linear models, the small, negative, and statistically significant relationship between wm_FARA and CHR_PCT_DIABETES remains. The other variables assessed also had small but significant relationships with CHR_PCT_DIABETES. 





#Limitations
This project had several limitations. 

There was not an evident way to capture purely type 2 diabetes data from available surveys. Interestingly, the CHR_PCT_DIABETES variable counts any diagnosis of diabetes, whether type 1, type 2, or other. In this project, the diabetes of interest is type 2 diabetes given that type 2 diabetes is associated with modifiable lifestyle factors. Still, given that 90-95% of all U.S. diabetes cases are type 2, this project is still capable of providing a reasonably strong estimate of any association between low access and type 2 diabetes prevalence.(9)  

Given limitations in dataset availability, was only able to do this analysis for the most recent year that both low access and diabetes data were available, 2015; ideally would have had more recent data and been able to inspect changes over several years

While I have used a linear regression model for this descriptive analysis of two continuous variables, in reality, a linear regression model is not optimal for outcomes measured as percentages, as these are bounded by 0 at the low end and 100 at the high end. It is possible that a generalized linear model may be a better fit for this type of data. 

This project did not attempt to perform an exhaustive analysis of all the potentially confounding variables. For example, average or median age by county might have been a potential confounder to the relationship between wm_FARA percentage and diabetes percentage, but this particular variable was not evaluated. 



#Conclusion
 

Correlation coefficient was part of my exploratory analysis and suggested a mild to moderate negative relationship between wm_FARA percentage and diabetes prevalence percentage. This correlation coefficient helps to gauge an initial correlation between the variables.

The most important metrics to track are the coefficient (estimate) for wm_FARA with its standard error and p-value. The R2 value tells us how much of the variance is explained by the variable of interest. These metrics can be reviewed for not only wm_FARA, but for other potentially confounding variables as well. 

For each unit increase in wm_FARA there is a small decrease of about 0.02 in diabetes prevalence percentage. This effect size is small and while statistically significant, it may not be clinically significant. The R2 value (which ranges between 0 and 1 with 1 being ideal) tells us that very little of the variation we are seeing in diabetes prevalence is explained by the model using wm_FARA.  This small effect is seen with an unadjusted model so it is quite possible/likely that other variables may be confounders of the relationship between wm_FARA percentage and diabetes prevalance percentage. A multivariable linear regression would allow us to adjust for potential confounders. 

Having created and reviewed the adjusted, multivariable linear model, there remains a very small but statistically significant negative relationship between wm_FARA and diabetes prevalence, despite accounting for potential confounders (which also had very small but statistically significant relationships with diabetes prevalence percentage) such as median household income, obesity percentage, and uninsured status percentage. This relationship between wm_FARA remains so small as to likely be clinically inconsequential. Effectively then, this project found no meaningful relationship between wm_FARA percentage and diabetes prevalence percentage.

Still, while perhaps there is no meaningful relationship between worsening food access and diabetes prevalence as identified in this project, improving food security in the United States is no less important. Indeed professional societies, including the American College of Physicians, have recently recognized the multiple health consequences of food insecurity and called on government to do more to address these problems.(10)


#References

1. Healthy People 2030. United States Department of Health and Human Services. Available at: https://health.gov/healthypeople/priority-areas/social-determinants-health. Accessed 12/6/22.

2. The cost of diabetes. American Diabetes Association. Available at: https://diabetes.org/about-us/statistics/cost-diabetes#:~:text=People%20with%20diagnosed%20diabetes%20incur,in%20the%20absence%20of%20diabetes. Accessed 12/6/22.

3. Tuomilehto J, Lindström J, Eriksson JG, et al. Prevention of type 2 diabetes mellitus by changes in lifestyle among subjects with impaired glucose tolerance. N Engl J Med. 2001;344(18):1343-1350. doi:10.1056/NEJM200105033441801

4. Tello, M. Healthy lifestyle can prevent diabetes (and even reverse it). Harvard Health Blog. 2018; September 6. Available at: https://www.health.harvard.edu/blog/healthy-lifestyle-can-prevent-diabetes-and-even-reverse-it-2018090514698

5. Food Security in the U.S.: Measurement. Economic Research Service, United States Department of Agriculture. https://www.ers.usda.gov/topics/food-nutrition-assistance/food-security-in-the-u-s/measurement/#insecurity.
Accessed 12/6/22.

6. Mapping Food Deserts in the United States. Economic Research Service, United States Department of Agriculture. https://www.ers.usda.gov/amber-waves/2011/december/data-feature-mapping-food-deserts-in-the-us/. Accessed 12/6/22.

7. Odegaard AO, Koh WP, Yuan JM, Gross MD, Pereira MA. Western-style fast food intake and cardiometabolic risk in an Eastern country. Circulation. 2012;126(2):182-188. doi:10.1161/CIRCULATIONAHA.111.084004

8. State Health Facts: Health Insurance Coverage of the Total Population. Kaiser Family Foundation. Available at: https://www.kff.org/other/state-indicator/total-population/?currentTimeframe=5&selectedDistributions=medicaid--medicare&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D.
Accessed 12/6/22.

9. Type 2 Diabetes. Centers for Disease Control and Prevention. Available at: https://www.cdc.gov/diabetes/basics/type2.html#:~:text=Healthy%20eating%20is%20your%20recipe,adults%20are%20also%20developing%20it. Accessed 12/8/22.

10. Serchen J, Atiq O, Hilden D; Health and Public Policy Committee of the American College of Physicians. Strengthening Food and Nutrition Security to Promote Public Health in the United States: A Position Paper From the American College of Physicians. Ann Intern Med. 2022;175(8):1170-1171. doi:10.7326/M22-0390


