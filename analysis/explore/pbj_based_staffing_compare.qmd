---
title: "Admin Intensity"
author: "David Roberts"
format: html
editor: visual

project:
  execute-dir: project
---

## Purpose

-   Compare daily pbj journal derived staffing ratios to quarterly reports.
-   Construct a measure which attempts to measure diversion of resources to admin duties.
    -   How can I measure this?
-   Test correlation between case-mix and diversion of resources to admin duties.

## Imports

```{r}
library(dplyr)
library(ggplot2)
library(here)
```

## Load Data

```{r}
load(here("data", "interim", "snf_provider_info.Rda"))
#payroll_2021Q4 <- read.csv("E:/NHC/PBJ_Nurse_2021_Q4/Payroll_Based_Journal_Daily_Nurse_Staffing_2021_Q4.csv")
```

## Calculate YOY increases in staffing rating
Landed in 4-5 range is a case
```{r}
staffing_next_yr <- select(snf_level_data, c("federal_provider_number", "staffing_rating", "collection_yr", "adjusted_rn_staffing_hours_per_resident_per_day", "adjusted_total_nurse_staffing_hours_per_resident_per_day")
)
staffing_next_yr$collection_yr = staffing_next_yr$collection_yr - 1
snf_level_data <- snf_level_data %>%
  left_join(staffing_next_yr, by=c("federal_provider_number", "collection_yr"))
staffing_yoy <- select(snf_level_data,
    c("federal_provider_number", "staffing_rating.x", "collection_yr",
       "staffing_rating.y","adjusted_rn_staffing_hours_per_resident_per_day.x", "adjusted_total_nurse_staffing_hours_per_resident_per_day.x",
      "adjusted_rn_staffing_hours_per_resident_per_day.y", "adjusted_total_nurse_staffing_hours_per_resident_per_day.y")
) %>%
  filter(is.na(staffing_rating.y) == FALSE & is.na(staffing_rating.x) == FALSE) %>%
  mutate(star_change=staffing_rating.y - staffing_rating.x) %>%
  mutate(rn_hr_prpd_change=adjusted_rn_staffing_hours_per_resident_per_day.y - adjusted_rn_staffing_hours_per_resident_per_day.x) %>%
  mutate(total_hr_prpd_change=adjusted_total_nurse_staffing_hours_per_resident_per_day.y - adjusted_total_nurse_staffing_hours_per_resident_per_day.x) %>%
  mutate(status=
           ifelse(star_change > 0 & staffing_rating.x < 4 & staffing_rating.y >=4,
          "Case", "Control"))
```


Assess missingness...
To create a clean analysis, probably worth removing observations where an staffing observation is not available. This drops the staffing rating to 1...

Among the cases, it only occurs with +3 and +4 stars...

```{r}
staffing_yoy %>% count(status, star_change)
filter(staffing_yoy, is.na(rn_hr_prpd_change)) %>% count(status, star_change)

staffing_yoy.complete <- filter(staffing_yoy, !(is.na(rn_hr_prpd_change) | is.na(total_hr_prpd_change)))
```

Dropped ~3k observations
```{r}

```