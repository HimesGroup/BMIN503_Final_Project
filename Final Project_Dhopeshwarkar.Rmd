---
title: "BMIN503/EPID600 Project"
author: Neil Dhopeshwarkar
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***

### Overview

This project investigates factors associated with effectiveness of immune checkpoint inhibitors in the treatment of metastatic melanoma.  Using Flatiron Health oncology EHR-derived data, I evaluate the association of different types of factors (e.g., medical conditions and medications) with survival in metastatic melanoma patients being treated with immune checkpoint inhibitors, with an emphasis on immune- and inflammatory-related factors.

I have spoken to the following three faculty:

Sean Hennessy, PharmD, PhD, pharmacoepidemiologist and Professor of Epidemiology.  Dr. Hennessy provided input on the overall design and analysis plan.

Charles Leonard, PharmD, MSCE, pharmacoepidemiologist and Assistant Professor of Epidemiology.  Dr. Leonard provided input on design considerations.

Ronac Mamtani, MD, MSCE, oncologist-epidemiologist and Assistant Professor of Medicine.  Dr. Mamtani provided clinical input on the factors/exposures of interest and outcome, as well as input on use of Flatiron Health.

[Click here for my github repository.](https://github.com/dhopesh6/BMIN503_Final_Project)


### Introduction 

Immune checkpoint inhibitors, drugs that inhibit PD-1,PD-L1, or CTLA-4 to reinvigorate the body's immune antitumor response, have drastically changed the treatment landscape of several types of cancers including advanced melanoma.  Though these treatments have demonstrated marked benefits for cancer outcomes such as progression-free survival (PFS) and overall survival (OS), studies have suggested that certain factors hinder their clinical benefit.  For example, concomitant use of glucocorticoids (due to immunosuppresive effects) or antibiotics (due to disruption of gut microbia) was shown to decrease survival outcomes in patients treated with immune checkpoint inhibitors.  This project will explore the association of a variety of immune- and inflammatory-related patient factors with decreased OS in advanced melanoma patients treated with immune checkpoint inhibitors.

Multiple disciplines can contribute to addressing this research question.  The data science/informatics data manipulation and analysis techniques learned in this class help to develop an analyzable dataset and generate results.  Concepts from epidemiology will help with the interpretation of results and their potential implications. Drs. Hennessy and Leonard provided input on these concepts.  Finally, clinical medicine can link these results to possible biological explanations in order to assess the value in further assessment of one or several of these factors in a causal-aimed study.  Dr. Mamtani can help interpret these results and derive implications.  Overall, this project could elucidate potential factors associated with decreased effectiveness of immune checkpoint inhibitors which may be worth exploring further in the future.


### Methods

For this analysis I used Flatiron Health, an oncology electronic health record (EHR)-derived dataset that contains detailed information on patient demographics, cancer characteristics, treatment information, diagnoses, concomitant medications, and mortality, among other types. The cohort included metastatic melanoma patients who received immune checkpoint inhibtor (ICI) therapy. I investigated the association between pre-specified immune- and inflammatory-related variables (medical conditions and medications) and death at one year from start of ICI therapy, using logistic regression.  The comorbid medical conditions included: multiple sclerosis, rheumatoid arhtritis, systemic lupus erythmatosus, psoriasis, irritable bowel disease (including ulcerative colitis and Crohn's disease), asthma, hypothyroidism, and hyperthyroidism.  The concomitant medications of interest included: antibiotics, antifungals, antivirals, and glucocorticoids.  Medical conditions were captured using ICD-9 and ICD-10 diagnosis codes in the diagnosis file and medications were captured in the medication administration file.  Patients were considered exposed if they were diagnosed with a medical condition of interest anytime before start of ICI  therapy and if they were administered a medication of interest within six weeks before start of ICI therapy.



I first attached the packages used in this project.


```{r, eval = TRUE}
library(dplyr)
library(tidyverse)
```

I then read in the Line of Therapy data file, which includes the cancer treatments of every metastatic melanoma patient included in the dataset.

```{r, eval = TRUE}
mel_lineoftherapy <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/advmel_oral_lot_lineoftherapy.csv", header = TRUE)
```

Next, I created a dataframe containing metastatic melanoma patients who received ICI therapy.  This will be the study population.  This mel_ICI dataframe will also eventually be the final analyzable dataset.

```{r, eval = TRUE}
#Filtering to metastatic melanoma patients who received immune checkpoint inhibitors. If a single patient received more than one line of therapy with an ICI, I will use the start date for their  first line with ICI as the index date.

mel_ICI <- mel_lineoftherapy %>%
  filter(grepl("Pembrolizumab|Nivolumab|Ipilimumab", linename)) %>%
  filter(linesetting=="METASTATIC") %>%
  arrange(patientid, linenumber) %>%
  group_by(patientid) %>%
  slice(1) %>%
  print()

mel_ICI_2 <- mel_ICI %>%
  rename(ICI_startdate = startdate, ICI_enddate = enddate)

mel_ICI_2 <- mel_ICI_2 %>%
  mutate(ICI_startdate = as.Date(ICI_startdate)) %>%
  mutate(ICI_enddate = as.Date(ICI_enddate))
```

I then read in the Mortality file which contains the date of death for each patient who died up until the end of the dataset (July 31st, 2018).

```{r, eval = TRUE}
#reading in data file that contains date of death for each patient.
mel_mortality <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/advmel_oral_lot_enhanced_mortality_v2.csv", header = TRUE)

```

I assigned a default day for each date of death (the 15th), as only month and year are reported.

```{r, eval = TRUE}
#Only the month and year for death date is reported, possibly due to re-identification concerns. Therefore, I will assign a default day of the 15th for each death date.

mel_mortality <- mel_mortality %>%
  mutate(dateofdeath = as.character(dateofdeath))

mel_mortality$dateofdeath2 <- sprintf('%s-15', mel_mortality$dateofdeath)

mel_mortality <- mel_mortality %>%
  mutate(dateofdeath2 = as.Date(dateofdeath2))
```

I added the date of death variable to the main mel_ICI table.  I also dropped the original date of death variable (which does not contain day) to avoid confusion.

```{r, eval = TRUE}
#adding date of death variable to the mel_ICI table with left join.  Also, dropping the original date of death variable (and only including the date with year, month, and day) to avoid confusion.

mel_ICI_3 <- mel_ICI_2 %>%
  left_join(mel_mortality, by = "patientid")

mel_ICI_3 <- select(mel_ICI_3, -c(dateofdeath))

```

I created the binary outcome variable - a '1' represents death within one year from ICI start date, a '0' represents being alive at one year from ICI start date.  Patients who did not have a date of death reported were considered to be alive.

```{r, eval = TRUE}
mel_ICI_4 <- mel_ICI_3 %>%
  mutate(oneyeardeath = ifelse(dateofdeath2 <= (ICI_startdate + 365), 1, 0)) %>%
  mutate(oneyeardeath = ifelse(is.na(oneyeardeath), 0, oneyeardeath))
```

I then read in the data file with patient diagnoses.  These will be used to identify patients with immune-related and inflammatory-related conditions at baseline.  This data file essentially contains one column of all documented ICD-9 and ICD-10 codes for all patients, with each row containing one diagnosis with a diagnosis date.

```{r, eval = TRUE}
#Reading in data file with patient diagnoses.

mel_diagnoses <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/advmel_oral_lot_diagnosis.csv", header = TRUE)

mel_diagnoses <- mel_diagnoses %>%
  mutate(diagnosisdate = as.Date(diagnosisdate))

```


For each condition of interest, I ultimately created a binary variable ('1' meaning the patient is diagnosed with the condition, '0' meaning the patient is not diagnosed with the condition) to be included in the main mel_ICI table.  I first narrow down to diagnoses matched by patientid, and filter to diagnoses made before ICI_startdate with the appropriate ICD-9 and ICD-10 codes.  I did this for each condition.

```{r, eval = TRUE}

mel_multiplesclerosis <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^340|^G35", diagnosiscode))

mel_ICI_4$multiplesclerosis = ifelse(mel_ICI_3$patientid %in% mel_multiplesclerosis$patientid, 1, 0)

mel_rheumatoidarthritis <- mel_diagnoses %>%
  filter(mel_diagnoses$patientid %in% mel_ICI_3$patientid & mel_diagnoses$diagnosisdate <= mel_ICI_3$ICI_startdate & grepl("^714|^M06.9", mel_diagnoses$diagnosiscode))

mel_ICI_4$rheumatoidarthritis = ifelse(mel_ICI_3$patientid %in% mel_rheumatoidarthritis$patientid, 1, 0)

mel_lupus <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^710|^695.4|^M32.9|^L93.2", diagnosiscode))

mel_ICI_4$lupus = ifelse(mel_ICI_3$patientid %in% mel_lupus$patientid, 1, 0)

mel_psoriasis <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^696|^L40.50|^L40.9", diagnosiscode))

mel_ICI_4$psoriasis = ifelse(mel_ICI_3$patientid %in% mel_psoriasis$patientid, 1, 0)

mel_IBD <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^556|^K51|^555|^K50", diagnosiscode))

mel_ICI_4$IBD = ifelse(mel_ICI_3$patientid %in% mel_IBD$patientid, 1, 0)

mel_asthma <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^493|^J45|^E945.7", diagnosiscode))

mel_ICI_4$asthma = ifelse(mel_ICI_3$patientid %in% mel_asthma$patientid, 1, 0)

mel_hypothyroid <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^244|^E89|^E03", diagnosiscode))

mel_ICI_4$hypothyroid = ifelse(mel_ICI_3$patientid %in% mel_hypothyroid$patientid, 1, 0)

mel_hyperthyroid <- mel_diagnoses %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
  filter(diagnosisdate <= ICI_startdate & grepl("^242|^E05", diagnosiscode))

mel_ICI_4$hyperthyroid = ifelse(mel_ICI_3$patientid %in% mel_hyperthyroid$patientid, 1, 0)


```

I then read in the data file with medication administrations.  This file contains a row for each medication administered, along with the administration date.  This will be used to identify patients who had glucocorticoids, antibiotics, antifungals, and antivirals administered within six weeks before ICI start date.

```{r, eval = TRUE}
#Reading in data file with medications.

mel_medications <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/advmel_oral_lot_medicationadministration.csv", header = TRUE)


mel_medications <- mel_medications %>%
  mutate(administereddate = as.Date(administereddate, '%m/%d/%Y'))

```


A similar process as the medical condition diagnoses is used here, this time only filtering to medications administered within six weeks before ICI start date.  I used the detaileddrugcategory column to find glucocorticoids.

```{r, eval = TRUE}

mel_glucocorticoid <- mel_medications %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
 filter(administereddate >= ICI_startdate - 42 & administereddate <= ICI_startdate & detaileddrugcategory == 'glucocorticoid')

mel_ICI_4$glucocorticoid = ifelse(mel_ICI_3$patientid %in% mel_glucocorticoid$patientid, 1, 0)



```

I then read in a data file that maps anti-infective medications into antibiotic, antiviral, and antifungal medications.  This data file was manually created by myself and team members for a previous project.

```{r, eval = TRUE}
#Reading in data file to classify anti-infectives into antibiotic, antiviral, and antifungal.

mel_antiinfective_class <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/melanoma_antiinfective_classification.csv", header = TRUE)

```

I then linked this anti-infective crosswalk dataframe to a file containing all anti-infective administrations.

```{r, eval = TRUE}


mel_antiinfectives <- mel_medications %>%
  filter(detaileddrugcategory == 'anti-infective') %>%
  left_join(mel_antiinfective_class, by = 'commondrugname')

```

Next, I created the binary variables for patients who were administered an antibiotic, antiviral, or antifungal a within six weeks before ICI start date.

```{r, eval = TRUE}
mel_antibiotic <- mel_antiinfectives %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
 filter(administereddate >= ICI_startdate - 42 & administereddate <= ICI_startdate & antiinfectiveclass == 'antibiotic')

mel_ICI_4$antibiotic = ifelse(mel_ICI_3$patientid %in% mel_antibiotic$patientid, 1, 0)

mel_antiviral <- mel_antiinfectives %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
 filter(administereddate >= ICI_startdate - 42 & administereddate <= ICI_startdate & antiinfectiveclass == 'antiviral')

mel_ICI_4$antiviral = ifelse(mel_ICI_3$patientid %in% mel_antiviral$patientid, 1, 0)

mel_antifungal <- mel_antiinfectives %>%
  left_join(mel_ICI_3, by = 'patientid') %>%
 filter(administereddate >= ICI_startdate - 42 & administereddate <= ICI_startdate & antiinfectiveclass == 'antifungal')

mel_ICI_4$antifungal = ifelse(mel_ICI_3$patientid %in% mel_antifungal$patientid, 1, 0)

```


I then read in the demographics data file to obtain age, sex, and race/ethnicity variables. Birthyear is provided, so I calculated age by subtracting birthyear from year of ICI start date.

```{r, eval = TRUE}
#Reading in demographics data file and linking to main table. Also creating age variable based on birthyear and ICI start date

mel_demographics <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/advmel_oral_lot_demographics.csv", header = TRUE)

mel_ICI_5 <- mel_ICI_4 %>%
  left_join(mel_demographics, by = 'patientid') %>%
  mutate(age = as.numeric(format(ICI_startdate, '%Y')) - birthyear)

```


I read in the ECOG data file to obtain ECOG performance status scores. I later found that there is a lot of missing data, thus this was not used in the analysis.

```{r, eval = TRUE}
#Reading in ECOG performance status score data file.  Finding most recent ECOG score before ICI start date for patients with a reported score. Linking ECOG score to main table

mel_ecog <- read.csv("C:/Users/Neil D.000/Documents/UPenn/EPID 600/Final Project/Melanoma_Data/advmel_oral_lot_ecog.csv", header = TRUE)

mel_ecog <- mel_ecog %>%
  mutate(ecogdate = as.Date(ecogdate))

mel_ecog2 <- mel_ecog %>%
  left_join(mel_ICI_5, by = 'patientid') %>%
  filter(!is.na(ICI_startdate)) %>%
  filter(ecogdate <= ICI_startdate) %>%
  group_by(patientid) %>%
  slice(which.max(ecogdate))

mel_ICI_6 <- mel_ICI_5 %>%
  left_join(select(mel_ecog2, ecogdate, ecogvalue), by = 'patientid')
  

```


### Results


I first obtained baseline demographic data.  Below we find that median age is 68 years, and the cohort is majorly male and overwhelming of White race.

```{r eval = TRUE}
mel_ICI_6 %>%
  group_by(linesetting) %>%
  summarise(median = median(age))
```

```{r eval = TRUE}
mel_ICI_6 %>%
  group_by(gender) %>%
  count()
```

```{r eval = TRUE}
mel_ICI_6 %>%
  group_by(race) %>%
  count()
```

I then obtained the number of outcomes. There were 1,017 (35.7%) patients who died within one year.

```{r eval = TRUE}
mel_ICI_6 %>%
  group_by(oneyeardeath) %>%
  count()
```


I then plotted the demographic variables by outcome, to see if there were any notable differences between patients who did and did not experience the outcome.  The plots below show that there were no notable differences.

```{r eval = TRUE}

ggplot(mel_ICI_6, aes(x = as.character(oneyeardeath), y = age)) +
    labs(x="Death at One Year", y="Age (years)") +
    geom_boxplot()
```

```{r eval = TRUE}
ggplot(mel_ICI_6, aes(x = gender, fill = as.character(oneyeardeath))) +
  labs(x="Sex", y="Number of Patients", fill="Death at One Year") +
    geom_bar(position = "dodge")
```


```{r eval = TRUE}
ggplot(mel_ICI_6, aes(x = race, fill = as.character(oneyeardeath))) +
  labs(x="Race/Ethnicity", y="Number of Patients", fill="Death at One Year") +
  scale_x_discrete(labels = c("Asian" = "Asian", "Black or African American" = "Black", "Hispanic or Latino" = "Hispanic", "Other Race" = "Other", "White" = "White")) +
    geom_bar(position = "dodge")
```


Next I counted how many patients are exposed to each factor of interest.  Overall, it seems that exposures were very rare.  This brings concerns of statistical power and potential misclassification.  Also, there were no patients who received antivirals within six weeks before ICI treatment, therefore I could not analyze antivirals in the outcome analysis.

```{r eval = TRUE}
mel_ICI_6 %>%
  group_by(multiplesclerosis) %>%
  count()
mel_ICI_6 %>%
  group_by(rheumatoidarthritis) %>%
  count()
mel_ICI_6 %>%
  group_by(lupus) %>%
  count()
mel_ICI_6 %>%
  group_by(psoriasis) %>%
  count()
mel_ICI_6 %>%
  group_by(IBD) %>%
  count()
mel_ICI_6 %>%
  group_by(asthma) %>%
  count()
mel_ICI_6 %>%
  group_by(hypothyroid) %>%
  count()
mel_ICI_6 %>%
  group_by(hyperthyroid) %>%
  count()
mel_ICI_6 %>%
  group_by(glucocorticoid) %>%
  count()
mel_ICI_6 %>%
  group_by(antibiotic) %>%
  count()
mel_ICI_6 %>%
  group_by(antiviral) %>%
  count()
mel_ICI_6 %>%
  group_by(antifungal) %>%
  count()
```


Lastly, I performed the logistic regression including all of the factors of interest as well as sex, age, race, and line of therapy number (for additional adjustment).  Overall, glucocorticoid use was the only pre-specified factor that was statistically significantly associated with the outcome of death by 1 year from ICI start.  This was unsurprising because of the lack of power due to the sparse number of exposures.  Although other factors did not reach statistical significance, the odds ratios may hint at a potential association (e.g., multiple sclerosis, rheumatoid arthritis, IBD, and antifungal use).


```{r eval = TRUE}
ICI.glm <- glm(oneyeardeath ~ linenumber + gender + age + race + multiplesclerosis + rheumatoidarthritis + lupus + psoriasis + IBD + asthma + hypothyroid + hyperthyroid + glucocorticoid + antibiotic + antifungal, data = mel_ICI_6, family = binomial(logit))
summary(ICI.glm)
exp(cbind(OR = coef(ICI.glm), CI = confint(ICI.glm)))

```


In conclusion, the low number of exposures result in lack of power to detect associations with logistic regression. Glucocorticoid use was the only factor significantly associated with decreased survival.  However, the odds ratios and 95% confidence intervals may indicate that multiple sclerosis, rheumatoid arthritis, IBD, and antifungal use have an association with decreased survival in metastatic melanoma patients treated with ICIs.  This would need to be further investigated in a different data source that has better capture of comorbid condition diagnoses and concomitant medication use.  This is also relevant for other oncology-related projects in which the ascertainment of comorbid conditions and concomitant medication use (e.g., as exposures/outcomes of interest or as important confounders) is essential in addressing the research question.  Substantial effort should be given to understanding the validity of these variables in potential data sources.