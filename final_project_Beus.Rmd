---
title: "Adherence to AAP Guidelines for Treatment Duration for Acute Otitis Media and Implications for Clinical Decision Support"
author: "Jonathan Beus, MD, MS"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
``` 

Note that this chunk can be changed to use sample data to demonstrate code.
```{r setup, include=T}

# Use this for original data, containing PHI
knitr::opts_knit$set(root.dir = normalizePath('../../Final_Project_PHI/01_raw_data'))

# Use this for simulated data to use with github post
# knitr::opts_knit$set(root.dir = normalizePath('./sample_data'))



```


```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  

```{r}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(digest)
library(pROC)
library(knitr) # for table formatting

theme_set(theme_bw())
```

# TO-DO

1. confirm no PHI displayed in report (i.e. str())
1. confirm works with test data - comment out PHI data pulls
  1. add simulated allergy data
1. **finish conclusion**
1. **make sure code is well documented**


#### Abbreviations Used
Abbreviation | 
---|---
AAP | American Academy of Pediatrics
AOM | Acute Otitis Media
ASP | Antimicrobial Stewardship Program
CDS | Clinical Decision Support
ED | Emergency Department
QI | Quality Improvement


### Overview

[Jonathan Beus BMIN503 Final Project](https://github.com/beusj/BMIN503_Final_Project)

This project examines adherence to treatment guidelines for antibiotic duration for [acute otitis media](https://www.healthychildren.org/English/health-issues/conditions/ear-nose-throat/Pages/Middle-Ear-Infections.aspx) (common ear infection) for patients seen and discharged from our emergency department. An American Academy of Pediatrics (AAP) guideline was published in 2013 with soft recommendations regarding treatment duration [AAP Guidleline](https://pediatrics.aappublications.org/content/131/3/e964) which were reflected in a local "Clinical Pathway." Essentially, while 10 days of therapy has classicaly been used, for patients 2 years and older, 7 days of therapy is likely adequate. Our antimicrobial stewardship program (ASP) has asked that we consider implementing clinical decision support to encourage clinicians to follow these guidelines. In preparation for this, we would like to evaluate past rates of adherence to these guidelines and to identify patient and provider characteristics associated with adherence or non-adherence to these guidelines. This information will serve to define the magnitude of the problem and potentially highlight patient or provider populations for additional intervention.

To explore this question, we are using an internal data warehouse, extracted from the Electronic Health Record. We have written SQL queries to extract the pertinent information, identifying patients seen in our ED for Otitis Media from July 2011 through June 2019.

Name | Title | Division/Department | Primary Discussion Points
---|---|---|---
Joe Zorc, MD, MSCE | Professor of Pediatrics, Director of Emergency Information Systems | Department of Emergency Medicine | We discussed which factors were most likely to be associated with adherence to the guidelines, including provider type (trainee, advanced practice provider, attending), calendar year, and use of an Order Set. We also discussed potentially un-intended consequences of our CDS intervention including driving providers away from using the Order Set or encouraging providers to use broader-spectrum antibiotics.
Brandon Ku, MD | Associate Director for ED QI | Department of Emergency Medicine | We primarily discussed post-intervention assessment of the impact of a CDS-based QI intervention. Due to the rapid-cycle nature of improvement, we discussed using control charts for improvement monitoring. With this in mind, we set a goal of an absolute 10% increase in adherence to the guidelines for patients >= 2 years.
Talene Metjian, PharmD | Manager, Antimicrobial Stewardship Program | Antimicrobial Stewardship Program | The majority of non-adherence occurs in patients >= 2 years as the shorter duration was a change from prior practice. The use of 10 days in patients < 2 years was and is the standard duration. As a result, we should focus our analysis on the cohort of patients 2 years and older.



### Introduction 
#### Background and Significance
Antimicrobial resistance is a significant threat to modern healthcare. Antimicrobial resistance is developing more rapidly than new antimicrobials can be discovered. It is generally felt that antibiotic overuse is a major factor driving worsening resistance patterns. Antimicrobial stewardship is a field developed to help providers limit inappropriate antibiotic use. As discussed above, in 2013 an AAP policy guideline noted that, for patients >= 2 years, 7 days of antibiotic therapy was likely as effective as longer durations. The policy was well received, but probably more notable in that it provided guidance to providers about when *not* treating with antibiotics could be appropriate. The discussion about duration seems to have been overshadowed by the more surprising endorsement to not treat in specific cases. For many providers, when the decision was made to treat a patient with antibiotics, they continued to use 10 days of therapy.

When a patient diagnosed with AOM is discharged from our ED, there are several ways that an order for antibiotics can be placed. The provider could go to their "order tab" and enter the name of the antibiotic they would like to prescribe and, subsequently, the dosing and duration. This occurs some in the ED, but most ED providers have become accustomed to using a discharge Order Set. There is such an Order Set that currently exists for ear complaints. Historically, it has provided a list of antibiotics for providers to choose from (in addition to the ability to add a discharge diagnosis, instructions, etc). The antibiotic group is shared with Order Sets for other kinds of problems that might present to the ED and has historically been defaulted to 10 days. This has made ordering 10 days of antibiotics, the easiest thing to do. While outside the scope of the current report, we are implementing some features in the Order Set to help providers choose an appropriate antibiotic and also to guide them to the recommended duration based on age.

The goal of the current analysis and report is preparatory to CDS interventions and assessment of their effectiveness. As discussed above, we are interested in patient and provider factors that influence the selection of antibiotic duration.


#### Interdisciplinary Approach
For this project, we have primarily gathered resources with expertise in Clinical Informatics, Antimicrobial Stewardship (pharmacy), and Quality Improvement. Clinical informatics generally includes clinicians and draws from disciplines including human-computer interaction, decision science, analytics, and computer science. Clinical informatics is a burgeoning field and includes broad definitions, although here, we will generally consider its primary intent to be to help clinicians and patients by supporting quality, timely, efficient, and safe care through the use of information technology. While a software engineer might easily be able to add antibiotics and durations to an Order Set, a clinical informaticist gathers additional information from providers and/or their own clinical experience to think about the workflow by which a process is performed to improve the likelihood that the anticipated goal will be achieved in a way that supports, rather than disrupts, the provider's clinical activities. The clinical informaticists involved (JZ and JB) have extensively discussed which dependent-variables are reasonably extracted from our data warehouse and might be informative in targeting CDS.

Our ASP pharmacist (TM) has been crucial to help define which clinical actions are desired and to incoporate the appropriate antibiotics as well as durations for appropriate patients. Our ASP pharmacist and QI expert (BK) have been instrumental in confirming the decision to focus our analysis on patients >= 2 years and to exclude patients prescribed azithromycin. Azithromycin is not a preferred antibiotic for the treatment of AOM, but is sometimes used in patients with sever-allergies to the preferred agents. Unlike other antibiotics used to treat AOM, the duration of azithromycin is dependent on the dose used, not associated with age, and typically just 3 to 5 days. As a result, for patients treated with azithromycin, the prescription would almost always be adherent to the guideline to use 7 days of therapy. Its inclusion would thus artificially inflate the estimate of adherence to the prescribing recommendations.


### Methods

The data is derived from an institutional data warehouse. JB wrote SQL queries to extract the data from the data warehouse. We included data for patients seen in the ED between July 1, 2011 and June 30, 2018. Patients were included if:

1. They were discharged from the ED (not admitted to an inpatient unit)
1. Had a diagnosis (visit diagnosis entered by provider or coded diagnosis for billing) matching 'otitis', but not 'externa'
1. Were less than 21 years at the time of arrival to the ED

The primary analysis shown below depends on a patient having received an antibiotic prescription. The data warehouse provides a unique key for visits, which was used to identify antibiotic prescriptions for patients in the cohort. We did not include antibiotics administered in the ED, only outpatient prescriptions. We primarily identified antibiotics using standardized classifications from the EHR. Identification of a standard antibiotic name was preformed in the database queries. The name can be derived from various fields, none of which are completely reliable (some are missing). The names or descriptions tend to include descriptions of the concentrations and/or the salt of the molecule. A series of regular expressions was used to extract the "base" or generce name such as "amoxicllin).

In general, we use descriptive statistics to examine variables associated with adherence to the recommendations. These variables were chosen based on clinical expertise and suspected to impact adherence to the guidelines. In addition to descriptive statistics, we additionally used logistic regression to examine the contribution of each variable when accounting for the others.


#### Read in Data
```{r}


# Path to PHI data

read_path <- normalizePath('./')


# Path to local non-PHI data

# read_path <- normalizePath('../../github_final_project/BMIN503_Final_Project/sample_data')

# Read Data
cohort <- read_csv(paste0(read_path, '/cohort.csv'))

ccc <- read_csv(paste0(read_path, '/ccc.csv'))

race <- read_csv(paste0(read_path, '/race.csv'))

meds <- read_csv(paste0(read_path, '/meds.csv'))

# Used to associated provider type with medication order
prov_hx <- read_csv(paste0(read_path, '/prov_hx.csv'))

allergy <- read_csv(paste0(read_path, '/allergy.csv'))


```


#### Combine Cohort Tables

```{r}

cohort.cln <- cohort %>%
  # left_join(tx_team.cln, by = 'VISIT_KEY') %>%
  left_join(race, by = 'PAT_KEY') %>%
  left_join(ccc, by = 'PAT_KEY')

```

#### Clean Up Allergies

```{r}

allergy %>%
  group_by(ALRG_DESC) %>%
  summarise(n=n()) %>%
  mutate(
    pcn_all = ifelse(str_detect(ALRG_DESC,pattern = regex('(cillin|augmentin|zosyn)',ignore_case = T)),1,0),
    azith_all = ifelse(str_detect(ALRG_DESC,pattern = regex('(azithro)',ignore_case = T)),1,0),
    cef_all = ifelse(str_detect(ALRG_DESC,pattern = regex('ce(f|ph)',ignore_case = T)),1,0)
  )

abx_all <- allergy %>%
  select(VISIT_KEY, ALRG_DESC) %>%
  filter(!is.na(ALRG_DESC)) %>%
  group_by(VISIT_KEY) %>%
  mutate(
    pcn_all = ifelse(str_detect(ALRG_DESC,pattern = regex('(cillin|augmentin|zosyn)',ignore_case = T)),1,0),
    azith_all = ifelse(str_detect(ALRG_DESC,pattern = regex('(azithro)',ignore_case = T)),1,0),
    cef_all = ifelse(str_detect(ALRG_DESC,pattern = regex('ce(f|ph)',ignore_case = T)),1,0),
  ) %>%
  mutate(
    pcn_all = max(pcn_all),
    azith_all = max(azith_all),
    cef_all = max(cef_all)
  ) %>%
  select(-ALRG_DESC) %>%
  arrange(VISIT_KEY) %>%
  filter(sum(pcn_all, azith_all, cef_all) > 0) %>%
  distinct()


```

#### Add Allergies to Cohort Data

```{r}

cohort.cln <- cohort.cln %>%
  left_join(abx_all, by = 'VISIT_KEY') %>%
  mutate_at(vars(pcn_all, azith_all, cef_all), function(x) ifelse(is.na(x), 0, x))

```



#### Join Provider Type to Medications

The provider type history is stored in a different database, so it is not possible to join in initial query.
```{r}

meds.cln <- meds

# join to provider type at appropriate time (provider types can change as providers progress in training/etc)
prov_hx.meds <- meds.cln %>%
  select(MED_ORD_KEY, MED_ORD_CREATE_DT, PROV_ID) %>%
  left_join(prov_hx, by = 'PROV_ID') %>%
  filter(MED_ORD_CREATE_DT >= CONTACT_DATE, MED_ORD_CREATE_DT < EFF_TO_DATE) %>%
  select(MED_ORD_KEY, PROV_TYPE)

prov_hx.meds %>%
  summarise(n_distinct(MED_ORD_KEY))

meds.cln <- meds.cln %>%
  left_join(prov_hx.meds, by = 'MED_ORD_KEY')


# determined these classifications by manual review of provider names
meds.cln <- meds.cln %>%
  mutate(
    PROV_TYPE = ifelse(PROV_ID %in% c(18941,19355,8743), 'Resident', PROV_TYPE),
    PROV_TYPE = ifelse(PROV_ID %in% c(21864), 'Physician', PROV_TYPE)
         ) %>%
  select(-contains(('PROV_ID')))


```

#### Cohort Cleaning

Create variables from cohort data that will be used for exploration and modeling.

```{r}

cohort.cln <- cohort.cln %>%
  filter(AGE_AT_VISIT < 21) %>% # include only patients < 21 as we are interested in pediatric patients
  mutate(
         ACUITY = factor(ACUITY),
         sex_f = factor(SEX),
         arr_yr = year(ARRIVE_ED_DT), #extract year from date for grouping
         arr_mo = month(ARRIVE_ED_DT), #extract month from date
         fy_yr = ifelse(arr_mo < 7, arr_yr, arr_yr + 1),
         arr_yr_mo = floor_date(ARRIVE_ED_DT,'month'), # keep year-month
         arr_yr_qtr = floor_date(ARRIVE_ED_DT, unit = 'quarter'), # keep year-quarter
         arr_yr_wk = floor_date(ARRIVE_ED_DT, unit = 'week'),
  ) %>%
  mutate(
          age_ge_2 = ifelse(AGE_AT_VISIT >= 2, 1, 0), #binary age over 2 - this will be primary population
          age_ge_2 = factor(age_ge_2, levels = c('0', '1'), labels = c('Age < 2 yrs', 'Age >= 2 yrs')),
          age_f = cut(floor(AGE_AT_VISIT), breaks = c(0,6/12,1,2,5,12,Inf), labels = c('0-6 months','6-12 months','1-2 years','2-5 years','5-12 years','12+ years'), right = F), #splint into reasonable ages ranges based on clinical reasoning
          age_yr = floor(AGE_AT_VISIT) # essentially round age to first digit for use as continuous variable (little interest in more precision than this)
  ) %>%
  select(-AGE_AT_VISIT, -ARRIVE_ED_DT) %>% # don't need this anymore
  mutate(
      race_f = factor(RACE),
      ethn_f = factor(ETHNICITY)
  ) %>% # factor these for use in models
  select(-RACE, -ETHNICITY, SEX) %>%
  mutate(
    MED_COMPLEX_IND = factor(MED_COMPLEX_IND, levels = c(0,1), labels = c('No CCC','CCC Present'))
  )


```

#### Extract Dates Important to Medications

```{r}

meds.cln <- meds.cln %>%
  mutate(med_yr = year(MED_ORD_CREATE_DT),
         med_mo = month(MED_ORD_CREATE_DT),
         med_hr = hour(MED_ORD_CREATE_DT),
         med_hr_cut = cut(med_hr,breaks = seq(0, 24, 3),right = F),
         med_dow = wday(MED_ORD_CREATE_DT, label = T),
         med_dow_fri_sat = ifelse(med_dow %in% c('Fri','Sat'), 1, 0)
         ) %>%
  mutate(abx_name = factor(GEN_NM_CLN_SUB)) %>%
  select(-GEN_NM_CLN_SUB)


```


#### Medication Order Cleaning
Here we only include outpatient prescriptions (not antibiotics administered in the emergency department). The data is a prefiltered in the SQL queries to contain only medications classified as "Anti-Infective Agents" (which is mutually exclusive of topical antimicrobial products). We also exclude anti-infective agents that are not Antibacterial.


```{r}
meds.cln.op <- meds.cln %>%
  filter(D_ORD_MODE == 'Outpatient') %>%
  filter(D_ORD_CLASS != 'Historical Med') %>%
  filter(!D_PHARM_CLASS %in% c('Antiviral','Anthelmintic','Antifungals','Antimalarial','Antimycobacterial agents'))

length(unique(meds.cln.op$VISIT_KEY))
```


We need to align how dates/times are coded. DISCONT_DT is stored in UTC, while ARR_ED_DT is stored in local timezone, so need to adjust DISCONT_DT in order to assess time to discontinuation of an order.

```{r}

meds.cln.op <- meds.cln.op %>%
  mutate(
        med_disc_dt = DISCONT_DT - hours(4),
        disc_min = time_length(med_disc_dt - MED_ORD_CREATE_DT, unit = 'minutes')
        ) %>%
  select(-DISCONT_DT) %>%
  mutate(
    ss_used_med = factor(MED_ORD_SS, levels = c(0, 1), labels = c('No Order Set','Used Order Set'))
  ) %>%
  select(-MED_ORD_SS)

```


If there are multiple antibiotic orders we include only the most recent one. Some medication discontinuations occur at follow-up visits with primary care docotors or ED re-visits. Others reflect a change to the plan of care. We look at the distribution of discontinuation times to select a cutoff which is likely to represent a balance between these two possibilities.

```{r}
meds.cln.op <- meds.cln.op %>%
  arrange(VISIT_KEY,med_disc_dt) %>%
  group_by(VISIT_KEY) %>%
  # group_by(VISIT_KEY,GEN_NM_CLN_SUB) %>%
  mutate(vk_abx_ct = n(),
         any_disc = ifelse(any(!is.na(med_disc_dt)),1,0), # any order discontinued
         all_disc = ifelse(all(!is.na(med_disc_dt)),1,0), # all orders discontinued
         ord_seq = row_number()) 

# majority of discontinuations happen in first 2-3 hours

meds.cln.op %>%
  filter(all_disc == 1) %>%
  ggplot(aes(disc_min/60)) + 
  geom_histogram(binwidth = 1) +
  xlim(0,24) +
  xlab('Hours to Discontinuation')

nrow_pre <- nrow(meds.cln.op)

meds.cln.op <- meds.cln.op %>%
  ungroup() %>%
  filter(is.na(med_disc_dt) | disc_min >= 120) %>%
  filter(vk_abx_ct == ord_seq)

paste0('Rows Dropped: ',nrow_pre - nrow(meds.cln.op))
  
```


#### Medication Duration Cleanup

To assess guidelines adhrenece, we need to know the duration for which the antibiotic was prescribed. The information is not recorded in an easily accessible discrete way. 

```{r}

table(meds.cln.op$FREQ_NM,useNA = 'always')

# Use ordered frequency from a discrete field to determine number of doses per day
times_daily <- meds.cln.op %>%
  filter(FREQ_NM != 'EVERY 4 HOURS PRN') %>%
  mutate(daily_or_once = ifelse(FREQ_NM %in% c("DAILY","ONCE"),1,0),
         times_daily = as.numeric(str_extract(FREQ_NM,regex('\\b\\d(?=( times daily))',ignore_case = T))),
         every_x_hrs = as.numeric(str_extract(FREQ_NM,regex('(?<=every )\\d{1,2}(?= hours)',ignore_case = T)))) %>%
  mutate(times_daily = ifelse(is.na(times_daily) & daily_or_once == 1, 1, times_daily),
        times_daily = ifelse(is.na(times_daily) & !is.na(every_x_hrs),(24/every_x_hrs),times_daily)) %>%
    group_by(FREQ_NM,daily_or_once,times_daily,every_x_hrs) %>%
    summarise(n())

# create lookup table for frequency
times_daily <- times_daily %>%
  group_by(FREQ_NM, times_daily) %>%
  select(FREQ_NM,times_daily)

# combine with lookup table
meds.cln.op <- meds.cln.op %>%
  left_join(times_daily, by='FREQ_NM')


```


The "SIG" is the historically hand-written and now, free-text part of the medication prescription indicating the instructions for the patient. The prescription duration is not available as a discrete field in our database, so we need to do some cleaning work to extract it from the text.

```{r}

set.seed(12345) # for sample to display below

# show examples of SIGs that we will be cleaning
meds.cln.op %>%
  group_by(abx_name) %>%
  mutate(abx_wt = 1/n()) %>%
  ungroup() %>%
  sample_n(size = 10, weight = abx_wt) %>%
  select(abx_name, SIG) %>% 
  kable()


# regex pattern used in one of the cleaning steps below
patt <- paste0('\\b(for|X)\\s+(the|next|\\s+)*(\\d+|','four|',')\\s+(more\\s+)?(day(s)?|dose(s)?)\\b')

# Parse sig, primarily using regular expressions
tmp <- meds.cln.op %>%
  select(MED_ORD_KEY, abx_name, FREQ_NM, SIG, times_daily, MED_ORD_QTY, MED_ORD_QTY_VAL) %>%
  mutate(sig_ext_1st = str_extract(SIG,regex(patt,ignore_case = T)), #first pass gets at the majority of cases
         sig_num = str_extract(sig_ext_1st,regex('\\b\\d+\\b',ignore_case = T)), # number of doses or days
         sig_unit = str_extract(sig_ext_1st,regex('\\b(dose|day)(s)?\\b',ignore_case = T)), # doses versus days
         sig_then = str_extract(SIG,regex(paste0('\\b(?<=then)[\\w\\.\\s\\(\\)\\,]+',patt),ignore_case = T)), # case when there are two sets of instructions
         sig_then_form = str_extract(sig_then,regex(patt,ignore_case = T)),
         sig_then_num = str_extract(sig_then_form,regex('\\b\\d+|four\\b',ignore_case = T)),
         sig_then_num = ifelse(sig_then_num == 'four',4,sig_then_num),
         sig_then_unit = str_extract(sig_then_form,regex('\\b(dose|day)(s)?\\b',ignore_case = T)),
         ed_1st = str_extract(SIG,regex('\\b(1st|first)\\s+(dose)\\s+(given in ED)\\b',ignore_case = T))) %>%
  mutate(rx_days = ifelse(sig_unit %in% c('day','days') & sig_num != 1, sig_num,NA),
         rx_days = ifelse(sig_unit %in% c('dose','doses') & !is.na(times_daily) & is.na(rx_days),as.numeric(sig_num)/as.numeric(times_daily),rx_days),
         rx_days = ifelse(!is.na(sig_then_num) & abx_name != 'Azithromycin',as.numeric(sig_num) + as.numeric(sig_then_num), rx_days),
         rx_days = ifelse(!is.na(sig_then_num) & sig_num == 1, as.numeric(sig_num) + as.numeric(sig_then_num), rx_days),
         rx_days = ifelse(is.na(rx_days) & !is.na(sig_num),sig_num,rx_days),
         rx_days = ifelse(abx_name == 'Azithromycin' &  rx_days %in% c(2,4) & !is.na(ed_1st),as.numeric(rx_days) + 1, rx_days), #azithromycin tends to be 3 or 5 days
         rx_days = ifelse(is.na(rx_days) & !is.na(str_extract(SIG,regex('\\bday(s)?[\\s\\-\\#]+\\d+\\b',ignore_case = T))),5,rx_days), #capture remaining azithromycin 2-5 days
         rx_days = as.numeric(rx_days)
  ) %>% # sig dose extraction
  mutate(
    sig_dose = str_extract(SIG, regex('\\b[\\d\\.(TWO)]+\\s+(capsule\\(s\\)|tablet\\(s\\)|mL)+',ignore_case = T)),
    sig_dose = str_replace(sig_dose,'TWO','2'), # very specific to this data, in future could generalize if needed
    sig_dose_num = str_extract(sig_dose,regex('\\b[\\d\\.]+\\b',ignore_case = T)),
    ord_qty_num = str_extract(MED_ORD_QTY_VAL,regex('\\b[\\d\\.]+\\b',ignore_case = T)),
    ord_qty_unit = str_extract(MED_ORD_QTY_VAL,regex('(day|mL|bottle|capsule|tablet)',ignore_case = T)),
    fill_est_days = as.numeric(ifelse(ord_qty_unit == 'day', ord_qty_num, NA)),
    fill_est_days = (ifelse(is.na(fill_est_days) & ord_qty_unit %in% c('mL','capsule','tablet'), as.numeric(ord_qty_num)/(as.numeric(sig_dose_num)*as.numeric(times_daily)), fill_est_days)),
    fill_est_days = ifelse(MED_ORD_QTY_VAL == '30', 30/times_daily,fill_est_days), #edge case
    fill_est_days = ifelse(fill_est_days <= 1, NA, round(fill_est_days)),
    rx_days = ifelse(is.na(rx_days),fill_est_days,rx_days)
  )

set.seed(123) # for sample to display below

# Show examples of duration extracted from sig
tmp %>%
  group_by(abx_name) %>%
  mutate(abx_wt = 1/n()) %>%
  ungroup() %>%
  sample_n(size = 10, weight = abx_wt) %>%
  select(Antibiotic = abx_name, Rx_Sig = SIG, Duration = rx_days) %>%
  kable()

# when we look at examples where no duration was extracted, there are only a few cases where there is not enough information available to infer it (~ 8 cases)

# we also looked at additional subsets, such as unusual durations, and use of "doses" rather than "days", all of which yielded expected results.


meds.cln.op <- tmp %>%
  select(MED_ORD_KEY, rx_days) %>%
  left_join(meds.cln.op,by='MED_ORD_KEY') %>%
  select(VISIT_KEY, rx_days, abx_name, ss_used_med, PROV_TYPE, med_hr, med_hr_cut, med_dow) # drop variables that are no longer needed
```


```{r}

# Condense provider type to sensical values.
meds.cln.op <- meds.cln.op %>%
  mutate(
         prov_rx = ifelse(PROV_TYPE %in% c('Medical Student','Resident'), PROV_TYPE, NA),
         prov_rx = ifelse(PROV_TYPE %in% c('FELLOW','FELLOW-CRNA'), 'Fellow', prov_rx),
         prov_rx = ifelse(PROV_TYPE %in% c('Nurse Practitioner','Physician Assistant'), 'NP/PA', prov_rx),
         prov_rx = ifelse(PROV_TYPE %in% c('Physician', 'Physician with Sedation'), 'Attending', prov_rx),
         prov_rx = factor(prov_rx)
         ) %>%
  select(-PROV_TYPE)

```


#### Join medication to cohort data
```{r}


meds.coh <- cohort.cln %>%
  left_join(meds.cln.op, by='VISIT_KEY') %>%
  filter(!is.na(rx_days)) %>%
  mutate(
         dur_compl = 0,
         dur_compl = ifelse(age_ge_2 == 'Age >= 2 yrs' & rx_days <= 7, 1, dur_compl),
         dur_compl = ifelse(age_ge_2 == 'Age < 2 yrs' & rx_days <= 10, 1, dur_compl),
         dur_compl = ifelse(abx_name == 'Azithromycin' & rx_days <= 5, 1, dur_compl),
         dur_compl = factor(dur_compl, levels = c('0','1'), labels = c( 'Prolonged Duration' , 'Guideline Followed'))
         ) %>%
  mutate(
    abx_name = factor(abx_name) # refactor to drop NAs induced by joining to cohort
  ) %>%
  select(-VISIT_KEY, -PAT_KEY) %>%
  filter(arr_yr_mo >= '2011-07-01' & arr_yr_mo <= '2019-06-30')


```

After cleaning, there are `r nrow(meds.coh)` unique visits. This indicates that `r 100*round(nrow(meds.coh)/nrow(cohort.cln),2)` % of ED patients had a matching antibiotic. On review of a sample (20) of cases without a match, either no antibiotic was prescribed or the patient received an antibiotic by injection in the ED. 

Our primary focus will be on patients >= 2 years old, since this is the group in which the guidelines and our clinical pathway specify a different duration than has been standard. Additionally, we really only are interested in the most frequently used antibiotics. Finally, azithromcyin is not informative, since the duration is almost always 5 days, regardless of the indication (and is not addressed by the guidelines that are referenced).

```{r}

# primary cohort subset
coh.sub <- meds.coh %>%
    filter(age_yr >= 2)

```

We examine the frequency with which each antibiotic has been prescribed.

```{r}

coh.sub %>%
  group_by(abx_name) %>%
  summarise(n_visits = n()) %>%
  arrange(desc(n_visits)) %>%
  rename(Antibiotic = abx_name) %>%
  mutate(Antibiotic = fct_reorder(Antibiotic, n_visits, .desc = T)) %>%
  ggplot(aes(x = Antibiotic, y = n_visits)) +
  geom_col() +
  geom_text(aes(label=n_visits), nudge_y = .25) +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.05)) +
  ylab('# Visits')

```

Based on review of the data, we will only include cases where the antibiotic was used > 10 times. This is somewhat arbitrary, although we don't want to focus our efforts on rare cases. We will also exclude azithromycin.

```{r}

abx.inc <- coh.sub %>%
  group_by(abx_name) %>%
  summarise(n_visits = n()) %>%
  filter(n_visits > 10 & !(abx_name == 'Azithromycin')) %>%
  select(abx_name) %>%
  pull()

coh.sub <- coh.sub %>%
  filter(abx_name %in% abx.inc)

```


### Results

Adherence to the guidelines is much lower in patients >= 2 years of age.

```{r}

meds.coh %>%
 group_by(
   age_ge_2, dur_compl
 ) %>%
  summarise(n = n()) %>%
  mutate(age_sum = sum(n),
         pct_compl = 100*n/age_sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  ggplot(aes(x = age_ge_2, y = pct_compl)) +
  geom_col(position = 'dodge') +
  geom_text(aes(y = pct_compl + 3, label = round(pct_compl, 1))) +
  xlab('Age') +
  ylab('Percent Adherent to Guidelines') +
  theme(legend.title = element_blank()) 

```

#### Demographics

Examine the distribution of ages - patients tend to be on the young side with an approximately exponential distribution.

```{r}

coh.sub %>%
  ggplot(aes(age_yr)) +
  geom_histogram(binwidth = 0.5) + 
  xlab('Age') +
  ylab('Case Count')

```

There are more males than females in the cohort.

```{r}
coh.sub %>%
  mutate(var = SEX) %>%
  group_by(var) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  arrange(desc(n)) %>%
  mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0('n = ',n,' (',round(100*prop, 2),'%)')), nudge_y = .02) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=0)) +
  xlab('Sex') +
  ylab('Proportion') 
```

The majority of patients are "Black or African American."

```{r}

coh.sub %>%
  mutate(var = race_f) %>%
  group_by(var) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  arrange(desc(n)) %>%
  mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(angle = 0, label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .15) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Race') +
  ylab('Proportion') +
  ylim(0,1)
  # scale_fill_brewer(type = 'qualitative', palette = 'Set1')

```

There is some variation in volume from year to year.

```{r}


coh.sub %>%
  ggplot(aes(fy_yr)) +
  geom_histogram(binwidth = 0.5) + 
  xlab('Fiscal Year') +
  ylab('Case Count')

```

Only a small fraction of patients had a complex chronic condition ("CCC"). This feature is defined by a variety of diagnoses on a patient's problem list or their dependence on technologic interventions (i.e. chronic need for ventilator).

```{r}

coh.sub %>%
  mutate(var = MED_COMPLEX_IND) %>%
  group_by(var) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  arrange(desc(n)) %>%
  mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0('n = ',n,' (',round(100*prop, 2),'%)')), nudge_y = .05) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
    xlab('Complex Chronic Condition') +
  ylab('Proportion') 

```


#### Medication Attributes

Summary of antibiotics prescribed after filtering above. Amoxicillin represents a significant majority of cases.

```{r}

coh.sub %>%
  mutate(var = abx_name) %>%
  group_by(var) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  arrange(desc(n)) %>%
  mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col(aes(fill = var)) +
  geom_text(aes(label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .1) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Antibiotic') +
  ylab('Proportion') +
  ylim(0,1) +
  scale_fill_brewer(type = 'qualitative', palette = 'Set1') +
  theme(legend.position = 'none') 


```

A histogram of prescribed antibiotic duration providers more granular detail than the binary classifer of adherence to recommendations. The majority of prescriptions were written for 7 or 10 days with small numbers written for 5, 9, or 14 days.

```{r}

coh.sub %>%
  ggplot(aes(x=rx_days)) +
  geom_histogram(binwidth = 1) +
  # scale_y_log10() + 
  xlab('Prescribed Duration') +
  ylab('# Cases')

```

Antibiotic prescriptions were fairly evenly distributed throughout the week with slightly more prescriptions on weekends.

```{r}

coh.sub %>%
  group_by(med_dow) %>%
  summarise(n = n()) %>%
  mutate(
    sum = sum(n),
    prop =  n/sum
         ) %>%
  ggplot(aes(x=med_dow, y=prop)) +
  geom_col() +
  xlab('Day of the Week') + 
  ylab('Proportion')

```

When we look at prescriptions by time of day, we see a pattern that generally resembles patient flow throughout the day. Volume is lowest in the early morning hours to mid-morning and busiest late in the evening.

```{r}

coh.sub %>%
  group_by(med_hr) %>%
  summarise(n = n()) %>%
  mutate(
    sum = sum(n),
    prop =  n/sum
         ) %>%
  ggplot(aes(x=med_hr, y=prop)) +
  geom_line() +
  xlab('Hour of the Day') + 
  ylab('Proportion of Cases')

```

The majority of prescriptions were written by attending providers (ED or Urgent care) with other significant proportions written by residents and advanced practice providers.

```{r}

coh.sub %>%
  mutate(var = prov_rx) %>%
  group_by(var) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  arrange(desc(n)) %>%
  mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col(aes(fill=var)) +
  geom_text(aes(label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .1) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Prescriber Type') +
  ylab('Proportion') +
  ylim(0,1) +
  scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  theme(legend.position = 'none') 

```

The majority of antibiotic orders were placed using the Order Set, which supports targeting this method as an intervention to improve adherence. Still, nearly 15% of orders were placed outside of the Order Set.

```{r}

coh.sub %>%
  mutate(var = ss_used_med) %>%
  group_by(var) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  arrange(desc(n)) %>%
  mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .1) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Order Set Use') +
  ylab('Proportion') +
  ylim(0,1)
```

#### Explore Adherence to Recommendations by Covariates

The guideline was more more likely to be followed as patients get older.
```{r}

coh.sub %>%
  mutate(var = age_yr) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_line() +
  # geom_text(aes(label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .1) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Patient Age') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

Sex does not appear to affect adherence to the guideline.

```{r}

coh.sub %>%
  mutate(var = SEX) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  # theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Sex') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

Race has a small effect on guideline adherence, although many races are quite under-represented. When we look at the most frequent races from above (black, other, white), adherence to the guideline seemed to be quite similar.
```{r}

coh.sub %>%
  mutate(var = race_f) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed' & !is.na(var)) %>%
  arrange(desc(n)) %>%
  ungroup() %>%
  mutate(var = fct_reorder(var, prop, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Race') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

Adherence to the guideline has improved over time, although still remains relatively low.
```{r}

coh.sub %>%
  mutate(var = arr_yr_mo) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_line() +
  # geom_text(aes(label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .1) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('ED Visit Month') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

The presence of a "complex chronic condition" does not appear to influence adherence to the guidelines.

```{r}
coh.sub %>%
  mutate(var = MED_COMPLEX_IND) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  # theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  
```

There is some variation in adherence to the guidelines by which antibiotic was prescribed.

```{r}

coh.sub %>%
  mutate(var = abx_name) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed' & !is.na(var)) %>%
  arrange(desc(n)) %>%
  ungroup() %>%
  mutate(var = fct_reorder(var, prop, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Race') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

There is some slight variation in adherence based on day of the week.

```{r}

coh.sub %>%
  mutate(var = med_dow) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Day of Week') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

There does not seem to be significant variation in adherence to the guidelines by time of day. We initially hypothesized that adherence might be worse during busier times of day as changing the prescribed duration required extra work.

```{r}

coh.sub %>%
  mutate(var = med_hr) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_line() +
  # geom_text(aes(label=paste0('n = ',n,' \n(',round(100*prop, 2),'%)')), nudge_y = .1) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Arrival Hour') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

There seems to be some significant variation in adherence to guidelines based on provider type, noting that medical students are quite underpresented (only 3 in the cohort).

```{r}

coh.sub %>%
  mutate(var = prov_rx) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed' & !is.na(var)) %>%
  arrange(desc(n)) %>%
  ungroup() %>%
  mutate(var = fct_reorder(var, prop, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('Provider Type') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  # scale_color_discrete('Adherence to Guidelines')
  # scale_fill_brewer(type = 'qualitative', palette = 'Paired') +
  # theme(legend.position = 'none')

```

There was slightly better adherence to the guidelines when the Order Set was **not** used. This is perhaps not surprising since the Order Set defaulted to 10 days.

```{r}
coh.sub %>%
  mutate(var = ss_used_med) %>%
  group_by(var, dur_compl) %>%
  summarise(n = n()) %>%
  mutate(sum = sum(n), 
         prop = n/sum) %>%
  filter(dur_compl == 'Guideline Followed') %>%
  # arrange(desc(n)) %>%
  # ungroup() %>%
  # mutate(var = fct_reorder(var, n, .desc = T)) %>%
  ggplot(aes(x = var, y = prop)) +
  geom_col() +
  geom_text(aes(label=paste0(round(100*prop, 2),'%')), nudge_y = .05) +
  # scale_y_log10() +
  # theme(axis.text.x = element_text(angle=-60, hjust = 0.1)) +
  xlab('') +
  ylab('Guideline Followed - Proportion') +
  ylim(0,1)
  
```

#### Logistic Regression

With all variables included in the model, several features remained significant. As might be expected from univariable analyses above, these included:

* Year of Visit - more adherence with later (more recent years)
* Patient Age - better adherence for older patients
* Provider Type - relative to attending physicians, residents and fellows were more likely to prescribe adherent durations, while advanced-practice providers were less likely to prescribe adherent durations
* Whether the order set was used - use of the Order Set was associated with worse adherence to the Order Set (possibly because of the default, longer duration)
* Time of day - late morning prescriptions were more likely to be adherent
* Day of the week - prescriptions on Friday and Saturday were more likely to be adherent (the reason for this is unclear)
* Prescriptions for Amoxicillin/Clav (Augmentin) were less likely to be adherent to the guideline

```{r}

coh.mod_var <-
  coh.sub %>%
  select(dur_compl, abx_name , race_f, age_yr, sex_f, MED_COMPLEX_IND, med_hr_cut, med_dow, arr_yr, ss_used_med, prov_rx) %>%
  drop_na() %>%
  mutate(race_f = factor(race_f), # to account for dropped NA
         med_dow = factor(med_dow, ordered = F) # so that it displays correctly
         ) 

f.full <- glm(dur_compl ~ ., family = binomial, data = coh.mod_var)
summary(f.full)
full.sum <- broom::tidy(f.full, conf.int = T, exponentiate =T)
# full.sum

lr.full <- full.sum %>%
  select(term, OR = estimate , conf.2.5 = conf.low, conf.97.5 = conf.high, p.value) %>%
  filter(!term %in% c('(Intercept)')) %>%
  mutate_at(vars(c(OR:conf.97.5)), function(x) round(x,2)) %>%
  mutate_at(vars(p.value), function(x) round(x,3)) %>%
  mutate(p.value = ifelse(p.value < 0.001,0.001, p.value))
  
lr.full %>%
  arrange(p.value, OR) %>%
  filter(p.value <= 0.05)


```

Although the primary goal of this analysis was to determine factors associated with adherence to the guideline, we can also evaluate the model performance and whether it would effectively predict adherence to the guidelines. As shown in this ROC curve, the model is able ot explain some variance in the outcome, but has relatively middling performance with an AUC of ~ 0.73.

```{r}

library(pROC)
roc(coh.mod_var$dur_compl ~ predict(f.full, type='response'), plot=T, print.auc=T)

```

### Prediction Model for Antibiotic Choice

Although not a primary outcome, we were interested in whether the chosen covariates could be used to predict which antibiotic would be prescribed. We used several machine learning models to explore this - penalized multinomial regression, naive Bayes, and random forest.

#### Training and Test Samples
```{r}
library(caret)
library(randomForest)
library(doParallel)
library(pROC) #used for multiclass roc
library(DMwR) # used for SMOTE resampling


# choose most common antibiotics
top.meds <- meds.coh %>%
  group_by(abx_name) %>%
  summarise(n = n()) %>%
  filter(n > 25) %>%
  pull(abx_name)

# select covariates of interest
abx.coh <- meds.coh %>%
  filter(abx_name %in% top.meds) %>%
  select(abx_name , race_f, age_yr, sex_f, MED_COMPLEX_IND, arr_yr, ss_used_med, prov_rx, pcn_all, azith_all, cef_all) %>%
  drop_na() %>%
  mutate(race_f = factor(race_f), # to account for dropped NA
         abx_name = factor(abx_name) # account for dropped names
         ) 


# create dummy variables for multi-level factors
dummies <- dummyVars(abx_name ~ ., data=abx.coh)
# head(predict(dummies, abx.coh), 10)

dummies <- as_tibble(predict(dummies, abx.coh))

abx.coh <- cbind(abx_name = abx.coh$abx_name, dummies)

# use caret package to split data into test and training sets (70%/30%)
set.seed(54321)
idxtrain <- createDataPartition(y = abx.coh$abx_name, p = 0.7, list =F)
train <- abx.coh[idxtrain,]
testing <- abx.coh[-idxtrain,]

train <- UBL::SmoteClassif(abx_name ~ ., dat = train, C.perc = "balance", dist = "HEOM")
# balance results in balancing classes of antibiotics
# HEOM allwos for both numeric and nominal values in data (default is Euclidian)

# scale and center continuous variables
pp <- preProcess(train %>% select(age_yr, arr_yr), c('scale','center','nzv')) 

transformed <- predict(pp, newdata = train)

# scale and center continuous variables
trans.test <- predict(pp, newdata = testing)
```


```{r}
# Initiate multicore processing to decrease time required to fit models - particularly RF
cl <- makeCluster(parallel::detectCores())
registerDoParallel(cl)

```

Here we define parameters that control model training and resampling. There is significant class imbalance in the outcome variable (antibiotic) as amoxicillin is by far the most commonly prescribed. To deal with this, we will use resampling methods so that the models don't just predict the over-represented class (amoxicillin).

```{r cache=F}


# https://topepo.github.io/caret/subsampling-for-class-imbalances.html#subsampling-during-resampling
# smote.cust <- list(name = "SMOTE with more upsampling",
#                 func = function (x, y) {
#                   library(DMwR)
#                   # library(UBL)
#                   dat <- if (is.data.frame(x)) x else as.data.frame(x)
#                   dat$.y <- y
#                   dat <- SMOTE(.y ~ ., data = dat, perc.over = 500, perc.under = 100)
#                   # dat <- SmoteClassif(.y ~ ., data = dat, C.perc = C.perc)
#                   list(x = dat[, !grepl(".y", colnames(dat), fixed = TRUE)],
#                        y = dat$.y)
#                   },
#                 first = TRUE)
# 
# 
# tr_control <- trainControl(## 10-fold CV
#                            method = "repeatedcv",
#                            number = 10,
#                            repeats = 3,
#                            verboseIter = T,
#                            sampling = smote.cust) 

tr_control <- trainControl(## 10-fold CV
                           method = "cv",
                           number = 10,
                           verboseIter = T)
```

#### Penalized Multinomial Regression

```{r cache=T}

# set seed as random samples are used for cross-validation
set.seed(1234)

# fit model
system.time(
pmr.abx <- train(
            abx_name ~ ., 
            data = transformed, 
            method = "multinom",
            trControl = tr_control,
            tuneLength = 10,
            metric = 'Kappa'
            )
)

# show confusion matrix for penalized multinomial regression
(pmr.test <- confusionMatrix(predict(pmr.abx, trans.test), testing$abx_name))

```


#### Naive Bayes
```{r cache=T}

# Grid of model parameters for optimizing fit
tunegrid <- expand.grid(
  usekernel = c(TRUE, FALSE),
  laplace = 0:3,
  adjust = c(0,0.5,1,2,3)
)

# seed for random sampling in CV
set.seed(1234)

# Fit naive bayes model
system.time(
nb.abx <- train(
            abx_name ~ ., 
            data = transformed, 
            method = "naive_bayes",
            trControl = tr_control,
            metric = 'Kappa',
            tuneGrid = tunegrid
            )
)

# show confusion matrix for naive bayes for test data
(nb.test <- confusionMatrix(predict(nb.abx, trans.test), testing$abx_name))

```


#### Random Forest
**This could take a while to run!**

```{r cache=T}

# set seed for random forest
set.seed(1234)

# tuning model parameters
tunegrid <- expand.grid(.mtry = (1:10)) 

# fit random forest
system.time(
rf.abx <- train(
            abx_name ~ ., 
            data = transformed, 
            method = "rf",
            trControl = tr_control,
            ntree = 500,
            metric = 'Kappa',
            tuneGrid = tunegrid
            )
)

# demonstrate which variables had the highest "importance" in random forest model
varImp(rf.abx)

# confusion matrix for random forest model
(rf.test <- confusionMatrix(predict(rf.abx, trans.test), testing$abx_name))

```

```{r}

# Compare accuracy and Kappa for training data
# resamps <- resamples(list(PMR = pmr.abx,
#                           NB = nb.abx,
#                           RF = rf.abx))
# 
# summary(resamps)

# Accuracy and Kappa for Test data

bind_rows(c(
pmr = pmr.test$overall[c('Accuracy','Kappa')],
nb = nb.test$overall[c('Accuracy','Kappa')],
rf = rf.test$overall[c('Accuracy','Kappa')]
)
)

```

```{r}

# Release multicore cluster.

stopCluster(cl)
rm(cl)

```

#### Multiclass ROC Curves for Models Above

```{r}

# Prep Names for multiroc
prefix <- c('amox','aug','azi','cef')

roc_true <- sapply(prefix,function(x) paste0(x,'_true'))
roc_pred <- sapply(prefix,function(x) paste0(x,'_pred'))
roc_pmr <- sapply(roc_pred,function(x) paste0(x,'_pmr'))
roc_nb <- sapply(roc_pred,function(x) paste0(x,'_nb'))
roc_rf <- sapply(roc_pred,function(x) paste0(x,'_rf'))

roc_names <- c(roc_pred, roc_pmr, roc_nb, roc_rf)
names(roc_names) <- NULL
roc_names

# Transform abx vector into one-hot vectors
tmp <- caret::dummyVars('~ abx_name', data=trans.test)
abx_hot <- as_tibble(predict(tmp,trans.test))
names(abx_hot) <- roc_true
str(abx_hot)

# extract probablities for each class for each method
pmr_pred <- predict(pmr.abx,trans.test,type = 'prob')
nb_pred <- predict(nb.abx,trans.test,type = 'prob')
rf_pred <- predict(rf.abx,trans.test,type = 'prob')

names(pmr_pred) <- roc_pmr
names(nb_pred) <- roc_nb
names(rf_pred) <- roc_rf

# combine data into format expected for multiROC
mroc_data <- cbind(abx_hot, pmr_pred, nb_pred, rf_pred)


mroc_out <- multiROC::multi_roc(mroc_data)

plot_data <- multiROC::plot_roc_data(mroc_out)
```

Here, we summarise AUC values by model and type.
```{r}
# AUC Values
plot_data %>%
  select(Group, Method, AUC) %>%
  distinct() %>%
  pivot_wider(
              names_from = Method, 
              values_from = AUC)

# make nicer labels
plot_data <- plot_data %>%
  mutate(
    Group = factor(Group,levels = c('amox','aug','azi','cef','Micro','Macro'), labels=c('Amoxicillin','Amox/Clav','Azithromycin','Cefdinir','Micro','Macro')),
    Method = factor(Method, levels = c('pmr','nb','rf'), labels = c('Penalized Multinomial','Naive Bayes','Random Forest'))
  )

# plot just micro and macro ROC curves
plot_data %>%
  filter(Group %in% c('Micro','Macro')) %>%
  ggplot() +
  geom_line(aes(y = Sensitivity, x = 1-Specificity, color = Group), size = 1.5) +
  geom_abline() +
  facet_wrap(~ Method, ncol =2)

# Macro ROC takes the average of each class ROC (is less affected by class imbalance because each class contributes equally)

# plot ROC curves for each class
plot_data %>%
  filter(!Group %in% c('Micro','Macro')) %>%
  ggplot() +
  geom_line(aes(y = Sensitivity, x = 1-Specificity, color = Group), alpha = 0.75, size = 1.5) +
  geom_abline() +
  facet_wrap(~ Method,ncol = 2) + 
  scale_color_brewer('Antibiotic', type = 'qual', palette = 'Set1')

```


#### Discussion of Classification Models
Initially, models were trained on unbalanced training data. Accuracies of 80%+ were obtained, but essentially the models always predicted the majority class (amoxicillin). To address this, we took two appraoches: 1) we used sampling methods (SMOTE) to improve class balance and 2) hyper-parameter selection was based on kappa rather than accuracy. SMOTE resulted in better results than pure downsampling. Upsampling was too inefficient to tune hyper-parameters and did not result in significant-enough improvements to justify the addditional time spent training models. Overall, despite attempts at optimization, model performance remained relatively poor for antibiotic class-prediction. It would potentially be nearly as useful to predict patients which were prescribed any antibiotic other than amoxicillin (resulting in a binary classification). In this case, we might be better able to address the problem with class-imbalance. Alternatively, we could consider whether there are additional features that me helpful. Although there are many, they might include specific co-morbidities (immunodeficiency, chronic serous otitis, history of ear tubes), recent visits to the ED or primary care provider (as an indicator or previously failed treatment), or documented antibiotic allergies.


### Conclusions
Several features [(noted above)](#logistic-regression) were found to be associated with adherence to the recommended guidelines. Most importantly given our intent to best target clinical decision support, was the fact that most providers used an Order Set to order antibiotics. Similarly, the association with age was important, both with respect to different guidelines by age and the fact that older patients were likely to receive shorter durations. If our change to the CDS system is not effective, we might need to evaluate the differential adherence between provider types.

While not shown here, we used the baseline evaluation to support a decision to provide age-based CDS for antibiotics in the Order Set for ear complaints from the ED. In just a few weeks, we have observed an increase in adherence to the guidelines for patients >= 2 years to 70-80%. Ongoing analyses will determine whether this change has had any unintended consequences such as driving providers away from using the Order Set or to using broader spectrum (non-amoxicillin) antibiotics.

As noted [above](#discussion-of-classification-models), we attempted to learn whether we could predict which antibiotic a patient was likely to receive. We had limited success in doing so based on currently available features (covariates). To improve these models, additional features will likely be required.
