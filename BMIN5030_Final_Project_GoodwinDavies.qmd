---
title: "Another comparison of two area-level socioeconomic deprivation indices: SVI  (Social Vulnerability Index) and ADI (Area Deprivation Index) and their associations with asthma and smoking outcomes from survey data"
subtitle: "BMIN503/EPID600 Final Project"
author: "Amy Goodwin Davies"
date: today
format: 
  html:
    toc: true
    toc-depth: 6
    theme: minty
editor: source
number-sections: true
embed-resources: true
execute: 
  warning: false
---

------------------------------------------------------------------------

::: callout-caution
This report is still under construction
:::

#### Packages

```{r packages}
library(haven)
library(tidyverse)
library(readxl)
library(tigris)
library(tidycensus)
library(sf)
library(leaflet)
library(gridExtra)
library(RColorBrewer)
library(kableExtra)
library(broom.mixed)
library(modelsummary)
library(gtsummary)
library(cowplot)
library(lme4)
options(tigris_use_cache = TRUE)
options(progress_enabled = FALSE)
```

#### Functions

```{r functions}
my_theme <- function() {
  theme_half_open() +
    theme(
      panel.grid = element_line(color = "white"),
      legend.key.size = unit(0.4, "cm"),
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 12),
      plot.title = element_text(size = 16)
    )
}

my_point_plot <- function(df,
                          variable_x,
                          variable_y) {
  df |>
    ggplot(aes(x = {{variable_x}}, y = {{variable_y}})) +
    geom_point(alpha = 0.8, colour = "darkgrey") +
    geom_smooth(
      method = 'lm',
      formula = y ~ poly(x, 2),
      aes(color = 'polynomial'),
      se = FALSE
    ) +
    geom_smooth(
      method = 'lm',
      formula = y ~ x,
      aes(color = 'linear'),
      se = FALSE
    ) +
    my_theme() +
    theme(legend.position = "none")
}

my_box_plot <- function(df,
                        variable_x,
                        variable_y){
  df |>
    ggplot(aes(x = {{variable_x}}, y = {{variable_y}})) +
    my_theme() +
    geom_violin(fill = "#95ccbb",
                colour = NA,
                alpha = 0.8) +
    geom_boxplot(alpha = 0)
}

# from https://rdrr.io/github/bradisbrad/olfatbones/src/R/get_tri.R
#' Triangularize a Correlation Matrix
#' @description Takes a correlation matrix and removes the redundant information
#' @param cormat Correlation Matrix
#' @param lower Lower or upper half (default = T) select F for upper half
#'
#' @return Matrix
#' @export get_tri
#'
#' @examples
#' cormat <- round(cor(mtcars), 2)
#' get_tri(cormat)
#'
get_tri <- function(cormat, lower = T){
  if(lower){
    cormat[upper.tri(cormat)] <- NA
  } else {
    cormat[lower.tri(cormat)] <- NA
  }
  cormat
}


get_corr_plot <- function(df) {
  combined_corrs <- df |>
    cor(use = "complete.obs", method = "spearman") |>
    as.matrix() |>
    get_tri() |>
    reshape2::melt(na.rm = TRUE) |>
    rename(variable_1 = Var1,
           variable_2 = Var2)
  
  combined_corrs |>
    ggplot(aes(x = variable_2, y = variable_1, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradient2(
      low = "blue",
      high = "red",
      mid = "grey100",
      # midpoint = 0.5,
      limit = c(-1, 0.999),
      space = "Lab",
      name = "Spearman\nCorrelation"
    ) +
  geom_text(aes(label = round(value, 2))) +
    my_theme() +
    theme(
      axis.text.x = element_text(
        angle = 45,
        vjust = 1,
        size = 10,
        hjust = 1
      ),
      axis.text.y = element_text(size = 10)
    ) +
    coord_fixed() +
    coord_flip()

}

get_mmsa_survey_means <- function(smart_df,
                                  smart_survey,
                                  variable_name){
  # get unweighted means by mmsa (uw_)
  uw_mmsa_tbl <- smart_df |>
    select(d_mmsa, mmsaname, {{variable_name}}) |>
    group_by(d_mmsa, mmsaname) |>
    summarise(across(starts_with(variable_name), ~ mean(.x, na.rm = TRUE), .names = "uw_{.col}"))
  
  # get weighted means by mmsa using svyby (w_)
  w_mmsa_tbl <- svyby(
    ~ temp_var_name,
    ~ d_mmsa,
    design = smart_survey |> rename(temp_var_name = {{variable_name}}),
    FUN = svymean,
    na.rm = TRUE
  ) |>
    rename_with( ~ str_replace(.x, "temp_var_name", paste0("w_", variable_name)))
  # combine
  ever_smoker_mmsa_tbl <- uw_mmsa_tbl |>
    inner_join(w_mmsa_tbl, by = "d_mmsa") |>
    rename_with( ~ str_replace(.x, "w_d_", "w_")) |> 
    select(- se)
}
```

<!-- Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required. -->

## Overview {#sec-overview}

The goal of this project is to compare the Agency for Toxic Substances and Disease Registry Social Vulnerability Index (SVI) and the University of Wisconsin-developed Area Deprivation Index (ADI) in their association with asthma and smoking outcomes from the Behavioral Risk Factor Surveillance System (BRFSS) CDC dataset.

For SVI, the most recent available dataset is from 2020. For this project, national ranking at the county level will be used. The most recent ADI dataset is from 2021. National ranking for ADI is provided at the census block group level. For the asthma and smoking outcomes in the BRFSS CDC dataset, the 2021 Selected Metropolitan/Micropolitan Area Risk Trends (SMART) subset will used. The SMART BRFSS dataset provides the CBSA (Core-based statistical area), which "consist of the county or counties (or equivalent entities) associated with at least one core (urban area) of at least 10,000 population, plus adjacent counties having a high degree of social and economic integration with the core as measured through commuting ties." <https://www.census.gov/programs-surveys/metro-micro/about/glossary.html>

<!-- MMSAs were selected in the SMART BRFSS MMSA data if there were 500 or more respondents -->

<!-- in the 2021 BRFSS combined landline telephone and cellular telephone data.  -->

<!-- Give a brief a description of your project and its goal(s), what data you are using to complete it, and what two faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository. -->

## Introduction {#sec-introduction}

As Rollings et al 2023 discuss, there exist several area-level socioeconomic deprivation indices without consensus within healthcare research and policy fields about which indices should be used for a variety of analyses. In comparing two frequently used indices, SVI and ADI, in their associations with SMART BRFSS dataset, this project has the potential to inform selection of the appropriate index for future work. This project is interdisciplinary in that it spans data science, social science, and biomedical informatics.

A challenge for this project, as with many projects which incorporate geospatial variables, is differing geographic units. For this project, SVI is at the county level, ADI is at the census block group level, and the BRFSS outcomes are at the CBSA level. Fortunately, all of these geographic units are census-defined and are supersets or subsets of each other. For area-level analyses, datasets will be linked by county. Based on guidance from Dr. Sherrie Xie, ADI will be aggregated to the county-level using a weighted average that incorporates census counts for census block groups. The BRFSS smoking and asthma outcomes will be aggregated at the CBSA level. CBSAs and CBSA level smoking and asthma outcomes will be mapped to counties.

The smoking status variable `_SMOKER3` and the variable for lifetime asthma prevalence `_LTASTH1` will be aggregated at the CBSA level using survey weights. More information about the smoking and asthma variables available in the SMART BRFSS dataset is provided in @sec-app.

For individual-level analyses, datasets will be linked at the CBSA-level. ADI and SVI can be aggregated to the CBSA-level using weighted averages that incorporate census counts for census block groups and counties, respectively. The smoking status variable `_SMOKER3` and the variable for lifetime asthma prevalence `_LTASTH1`are provided at the individual-level.

Once the linked datasets are prepared, regression models will be used to compare SVI and ADI as predictors of the aggregated smoking and asthma outcomes.

There are several limitations of the project. One clear limitation is that the analyses will be restricted to areas of the US which are included in a CBSA grouping included in the SMART BRFSS dataset. As well as posing a methodological challenge, the differing geographic units introduce limitations for interpretation.

For example, for the individual-level analyses, aggregating at the CBSA level collapses across variation that may be predictive Interesting question of whether area-level predict individual-level, discussed a Xie reference

<!-- Describe the problem addressed, its significance, and some background to motivate the problem. This should extend what is in the @sec-overview. -->

<!-- Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff. -->

## Methods {#sec-methods}

<!-- Describe the data used and general methodological approach used to address the problem described in the @sec-introduction. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. -->

### SMART BRFSS CDC dataset

<!-- The SMART BRFSS CDC dataset was retrieved from -->

```{r loadmmsa}
# MMSA2021.xpt retrieved from https://www.cdc.gov/brfss/smart/smart_2021.html
# Accompanying documentation available at https://www.cdc.gov/brfss/annual_data/2021/pdf/2021_smart_brfss_mmsa_methodology-508.pdf
MMSA2021 <- read_xpt("data/input_data/mmsa/MMSA2021_XPT/MMSA2021.xpt") |> 
  mutate(`_resp_id` = str_pad(row_number(), pad = 0, width = 6)) # add respondent id
```

```{r glimpsemmsa}
#| eval: FALSE
MMSA2021 |> glimpse()
```

```{r mmsalabels}
# construct table of variable names and labels
mmsa_colname_labels <- MMSA2021 |>
  map_dfc(attr, "label") |>
  pivot_longer(everything(),
               names_to = "colname",
               values_to = "label")
# include variable names without labels
mmsa_colnames_all <- MMSA2021 |>
  colnames() |>
  as_tibble() |>
  rename(colname = value) |>
  left_join(mmsa_colname_labels, by = join_by(colname))
# add missing labels documented in https://www.cdc.gov/brfss/annual_data/2021/pdf/2021_smart_brfss_mmsa_methodology-508.pdf
attr(MMSA2021[["_MMSA"]], "label") <- toupper("the code of metropolitan or micropolitan statistical area where the respondent lives")
attr(MMSA2021[["MMSANAME"]], "label") <- toupper("the MMSA name")
attr(MMSA2021[["_MMSAWT"]], "label") <- toupper("the MMSA-level weight that is used when generating MMSA-level estimates for variables in the data set")
attr(MMSA2021[["_resp_id"]], "label") <- toupper("respondent ID")
mmsa_colnames_all <- MMSA2021 |>
  map_dfc(attr, "label") |>
  pivot_longer(everything(),
               names_to = "colname",
               values_to = "label")
```

```{r renamemmsa}
# rename columns to make them easier to work with using R (not requiring ``)
# underscore prefix indicates derived or computed, replace with d_
smart_2021 <- MMSA2021 |> 
  rename_with(~ tolower(str_replace(.x, "^_", "d_")))
smart_2021 |> colnames()
```

```{r glimpserenamemmsa}
#| eval: FALSE
smart_2021 |> glimpse()
```

```{r mmsatocounty}
# https://www.cdc.gov/brfss/annual_data/2021/pdf/2021_smart_brfss_mmsa_methodology-508.pdf
# Typically, BRFSS data are used to produce state-level estimates; however, for the SMART
# project, BRFSS data were used to produce small area-level estimates for MMSAs as defined by
# the US Census Bureau. On June 6, 2003, OMB issued new definitions for MMSA and
# metropolitan divisions. OMB periodically updates the list of MMSAs. The list of areas used for this
# analysis can be found here: https://www.census.gov/geographies/reference-files/timeseries/demo/metro-micro/delineation-files.html. The March 2020 release was used for defining
# the MMSAs in the 2021 SMART data set.
# retrieved from https://www.census.gov/geographies/reference-files/time-series/demo/metro-micro/historical-delineation-files.html
delin_2020 <- read_xls("data/input_data/mmsa/list1_2020.xls",
                       range = "A3:L1919") |>
  rename_with(~ tolower(gsub(" ", "_", .x, fixed = TRUE))) |> 
  rename_with(~ tolower(gsub("/", "_", .x, fixed = TRUE)))


delin_2020_cbsa_join <- delin_2020 |> filter(is.na(metropolitan_division_code)) # TODO explore why this is necessary
delin_2020_mdc_join <- delin_2020 |> filter(!is.na(metropolitan_division_code)) # TODO explore why this is necessary

# TODO check this
mmsa_county_mapping_cbsa <- smart_2021 |> 
  mutate(d_mmsa_char = as.character(d_mmsa)) |>
  distinct(d_mmsa, d_mmsa_char, d_mmsa_char, mmsaname) |> 
  inner_join(delin_2020_cbsa_join, by = c("d_mmsa_char" = "cbsa_code"))  |> 
  distinct(d_mmsa, d_mmsa_char, csa_title, county_county_equivalent, fips_state_code, fips_county_code)
mmsa_county_mapping_mdc <- smart_2021 |> 
  mutate(d_mmsa_char = as.character(d_mmsa)) |>
  distinct(d_mmsa, d_mmsa_char, d_mmsa_char, mmsaname) |> 
  inner_join(delin_2020_mdc_join, by = c("d_mmsa_char" = "metropolitan_division_code"))  |> 
  distinct(d_mmsa, d_mmsa_char, csa_title, county_county_equivalent, fips_state_code, fips_county_code)
mmsa_county_mapping <- mmsa_county_mapping_cbsa |> 
  dplyr::union(mmsa_county_mapping_mdc) |> 
  distinct()
```

```{r dqmmsatocounty}
#| eval: FALSE
# check mmsas retained
smart_2021 |> summarize(n_distinct(d_mmsa)) |> pull() == mmsa_county_mapping |> summarize(n_distinct(d_mmsa)) |> pull()

# check for issues with leading zeros
smart_2021 |>
  filter(nchar(d_mmsa) != 5)
smart_2021 |>
  mutate(d_mmsa_char = as.character(d_mmsa)) |>
  filter(nchar(d_mmsa_char) != 5)
mmsa_county_mapping |>
  filter(nchar(d_mmsa_char) != 5)
delin_2020 |>
  filter(nchar(cbsa_code) != 5)
```

```{r plotmmsacounties}
# download US counties shapefile 
tigris_counties <- counties() 

# join mmsa county mapping with  counties shapefile
mmsa_county_mapping_geoid <- mmsa_county_mapping |>
  mutate(smart = TRUE) |> 
  inner_join(tigris_counties, by = c("fips_state_code"= "STATEFP", "fips_county_code" = "COUNTYFP")) |>
  mutate(smart = replace_na(smart, FALSE))

# check mmsas retained
# mmsa_county_mapping_geoid |> filter(smart == TRUE) |> nrow() == mmsa_county_mapping |> nrow()

mmsa_county_mapping_geoid_sf <- mmsa_county_mapping_geoid |>
  filter(!fips_state_code %in% c("02",
                         "15", "60",
                         "66", "69",
                         "72", "78")) |> # limit to contiguous states and DC
  st_as_sf()
```

```{r convertsmart1}
#| eval: false
# Change the CRS (Coordinate Reference System) to 4326 because leaflet expects the data provided to it to be in WGS84 (EPSG:4326)
mmsa_county_mapping_geoid_sf_4326 <- st_transform(mmsa_county_mapping_geoid_sf, crs = 4326)
mmsa_county_mapping_geoid_sf_4326 |> saveRDS("data/intermediate_data/mmsa_county_mapping_geoid_sf_4326.rds")
```

```{r convertsmart2}
mmsa_county_mapping_geoid_sf_4326 <- readRDS("data/intermediate_data/mmsa_county_mapping_geoid_sf_4326.rds")
```

```{r smartleaflet}
pal_fun <- colorFactor("orange", mmsa_county_mapping_geoid_sf_4326$smart)

# leaflet plot of of counties within mmsas included in smart brfss
mmsa_county_mapping_geoid_sf_4326  |>
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,# remove polygon borders
    fillColor = ~ pal_fun(smart),
    fillOpacity = 0.5,
    smoothFactor = 0.5,
    popup = mmsa_county_mapping_geoid_sf_4326$county_county_equivalent
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addScaleBar()
```

#### Aggregating smoking and asthma variables at CBSA level

```{r addsmokingasthma}
smart_2021 <- smart_2021 |>
  mutate(
    # categorize as 1 for ever smoker is smoking status is current or former smoke, else 0 (including don't know/refused/missing) 
    d_ever_smoker = if_else(d_smoker3 %in% c(1, 2, 3), 1, 0),
        # categorize as 1 for yes for lifetime prevalence, else 0 (including don't know/refused/missing) 
    d_ever_asthma = if_else(d_ltasth1 == 2, 1, 0)
  )
```

##### `_SMOKER3`

```{r dsmoker3}
# https://www.r-bloggers.com/2020/02/dem-7283-example-1-survey-statistics-using-brfss-data/
library(survey)
library(srvyr)
# https://stackoverflow.com/questions/55975478/problems-due-to-having-too-many-single-psus-at-stage-one
options(survey.adjust.domain.lonely=TRUE)
options(survey.lonely.psu="adjust")
# TODO check this
# use provided survey weights
smart_2021_surv <- smart_2021 |>
  as_survey_design(ids = 1,
                   strata = d_ststr,
                   weights = d_mmsawt)
```

```{r wtkg3}
#| eval: FALSE
# Investigate survey weighting use wtkg3 as can apply general expectations about distributions

# WEIGHT IN KG [2 implied decimal places]

# TODO investigate "only one PSU at stage 1" warnings / confirm approach
wtkg3_mmsa_tbl <- get_mmsa_survey_means(smart_df = smart_2021,
                                        smart_survey = smart_2021_surv,
                                        variable_name = "wtkg3")

wtkg3_mmsa_tbl |>
  pivot_longer(cols = c("w_wtkg3", "uw_wtkg3"),
               values_to = "wtkg3") |>
  ggplot(aes(x = wtkg3 / 100, colour = name)) + # divide by 100 for 2 implied decimal places
  geom_density() +
  my_theme()

wtkg3_mmsa_tbl |>
  arrange(desc(w_wtkg3)) |>
  head(5)

wtkg3_mmsa_tbl |>
  arrange(w_wtkg3) |>
  head(5)

pal_fun_weight <- colorNumeric("BuPu", NULL) 

mmsa_county_mapping_geoid_sf_4326  |>
  left_join(wtkg3_mmsa_tbl, by = "d_mmsa") |> 
  mutate(weight_kg = w_wtkg3/100) |> 
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_fun_weight(weight_kg),
    fillOpacity = 0.5,
    smoothFactor = 0.5,
    # increase opacity and resolution
    popup = mmsa_county_mapping_geoid_sf_4326$county_county_equivalent
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_fun_weight,
    # palette function
    values = ~ weight_kg,
    # variable to pass to palette function
    title = 'Mean weight (kg)',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

```{r eversmoker}
#| warning: false
ever_smoker_mmsa_tbl <- get_mmsa_survey_means(smart_df = smart_2021,
                                        smart_survey = smart_2021_surv,
                                        variable_name = "d_ever_smoker")
```

```{r eversmoker2}
#| eval: false
ever_smoker_mmsa_tbl |>
  arrange(desc(w_ever_smoker)) |> 
  head(5)

ever_smoker_mmsa_tbl |>
  arrange(w_ever_smoker) |> 
  head(5)


```

```{r eversmokerleaflet}
pal_fun_smoker <- colorNumeric("plasma", NULL, reverse = TRUE) 

mmsa_county_mapping_geoid_sf_4326  |>
  left_join(ever_smoker_mmsa_tbl, by = "d_mmsa") |> 
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_fun_smoker(w_ever_smoker),
    fillOpacity = 0.5,
    smoothFactor = 0.5,
    # increase opacity and resolution
    popup = mmsa_county_mapping_geoid_sf_4326$county_county_equivalent
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_fun_smoker,
    # palette function
    values = ~ w_ever_smoker,
    # variable to pass to palette function
    title = 'Proportion smoker',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

##### `_LTASTH1`

```{r everasthma}
#| warning: false
ever_asthma_mmsa_tbl <- get_mmsa_survey_means(smart_df = smart_2021,
                                        smart_survey = smart_2021_surv,
                                        variable_name = "d_ever_asthma")
```

```{r everasthma2}
#| eval: false
ever_asthma_mmsa_tbl |>
  arrange(desc(w_ever_asthma)) |> 
  head(5)

ever_asthma_mmsa_tbl |>
  arrange(w_ever_asthma) |> 
  head(5)
```

```{r everasthmaleaflet}
pal_fun_asthma <- colorNumeric("viridis", NULL, reverse = TRUE) 

mmsa_county_mapping_geoid_sf_4326  |>
  left_join(ever_asthma_mmsa_tbl, by = "d_mmsa") |> 
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_fun_asthma(w_ever_asthma),
    fillOpacity = 0.5,
    smoothFactor = 0.5,
    # increase opacity and resolution
    popup = mmsa_county_mapping_geoid_sf_4326$county_county_equivalent
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_fun_asthma,
    # palette function
    values = ~ w_ever_asthma,
    # variable to pass to palette function
    title = 'Proportion asthma',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

### SVI dataset

<!-- 1 indicates highest vulnerability -->

<!-- At county level -->

+--------------+---------------------------------------------------------------------------------------------------------------------------------------+
| Field name   | Description                                                                                                                           |
+==============+=======================================================================================================================================+
| RPL_THEME1   | Socioeconomic Status, incorporating information such as                                                                               |
|              |                                                                                                                                       |
|              | -   Below 150% Poverty                                                                                                                |
|              |                                                                                                                                       |
|              | -   Unemployed                                                                                                                        |
|              |                                                                                                                                       |
|              | -   Housing Cost Burden                                                                                                               |
|              |                                                                                                                                       |
|              | -   No High School Diploma                                                                                                            |
|              |                                                                                                                                       |
|              | -   No Health Insurance                                                                                                               |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------+
| RPL_THEME2   | Household Characteristics, incorporating information such as                                                                          |
|              |                                                                                                                                       |
|              | -   Aged 65 & Older                                                                                                                   |
|              |                                                                                                                                       |
|              | -   Aged 17 & Younger                                                                                                                 |
|              |                                                                                                                                       |
|              | -   Civilian with a Disability                                                                                                        |
|              |                                                                                                                                       |
|              | -   Single-Parent Households                                                                                                          |
|              |                                                                                                                                       |
|              | -   English Language Proficiency                                                                                                      |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------+
| RPL_THEME3   | Racial & Ethnic Minority Status                                                                                                       |
|              |                                                                                                                                       |
|              | *Percentile percentage minority (Hispanic or Latino (of any                                                                           |
|              | race); Black and African American,Not Hispanic or                                                                                     |
|              | Latino; American Indian and Alaska Native, Not Hispanic or Latino;                                                                    |
|              | Asian, Not Hispanic or Latino; Native Hawaiian and Other Pacific Islander, Not Hispanic or Latino; Two or More Races, Not Hispanic or |
|              | Latino; Other Races, Not Hispanic or Latino) estimate*                                                                                |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------+
| RPL_THEME4   | Housing Type & Transportation, incorporating information such as                                                                      |
|              |                                                                                                                                       |
|              | -   Multi-Unit Structures                                                                                                             |
|              |                                                                                                                                       |
|              | -   Mobile Homes                                                                                                                      |
|              |                                                                                                                                       |
|              | -   Crowding                                                                                                                          |
|              |                                                                                                                                       |
|              | -   No Vehicle                                                                                                                        |
|              |                                                                                                                                       |
|              | -   Group Quarters                                                                                                                    |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------+
| RPL_THEMES   | Overall summary ranking                                                                                                               |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------+

: SVI measures, from [CDC/ATSDR SVI 2020 Documentation - 8/5/2022](https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2020Documentation_08.05.22.pdf)

```{r loadsvi}
# retrieved from https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html
# documentation here https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/pdf/SVI2020Documentation_08.05.22.pdf
svi2020 <- read_csv("data/input_data/svi/SVI_2020_US_county.csv")
```

```{r glimpsesvi}
#| eval: FALSE
svi2020 |> glimpse()

svi2020 |>
  select(starts_with("RPL")) |>
  summary()

svi2020 |>
  select(starts_with("RPL")) |>
  get_corr_plot()
```

```{r mapsvi1}
#| eval: FALSE
svi2020_sf <- svi2020 |>
  # select summary theme ranking variables
select(starts_with("RPL_"), FIPS)
  # join with county shapefile
  left_join(tigris_counties, by = c("FIPS" = "GEOID")) |> 
  # convert to sf
  st_as_sf()

svi2020_sf_4326 <- st_transform(svi2020_sf, crs = 4326)
svi2020_sf_4326 |> saveRDS("data/intermediate_data/svi2020_sf_4326.rds")
```

```{r mapsvi2}
svi2020_sf_4326 <-
  readRDS("data/intermediate_data/svi2020_sf_4326.rds")   |>
  filter(!STATEFP %in% c("02",
                         "15", "60",
                         "66", "69",
                         "72", "78"))  # limit to contiguous states and DC
```

```{r leafletsvi}
pal_svi <- colorNumeric("inferno", NULL, reverse = TRUE)

svi2020_sf_4326  |>
  filter(!is.na(FUNCSTAT)) |> # TODO explore why this is necessary
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_svi(RPL_THEMES),
    fillOpacity = 0.5,
    smoothFactor = 0.5
    # increase opacity and resolution
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_svi,
    # palette function
    values = ~ RPL_THEMES,
    # variable to pass to palette function
    title = 'SVI',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

#### SVI at MMSA level

<!-- SVI is provided at the county level. For individual-level analyses, we aggregate at MMSA level. -->

```{r}
#| eval: false
# get 2020 census counts by county for computing weighted average
county_cts <- get_decennial(
  geography = "county",
  variables = "P1_001N",
  year = 2020,
  output = "wide"
) |>
  rename(county_ct = P1_001N)
county_cts |> saveRDS("data/intermediate_data/county_cts.RDS")

# computed county mmsa weights for county level
county_mmsa_wts <- tigris_counties |>
  select(STATEFP, COUNTYFP , GEOID) |>
  st_drop_geometry() |>
  inner_join(county_cts, by = "GEOID") |>
  right_join(
    mmsa_county_mapping,
    by = c("STATEFP" = "fips_state_code",
           "COUNTYFP" = "fips_county_code")
  ) |>
  group_by(d_mmsa) |>
  # mmsa_pop
  mutate(mmsa_pop = sum(county_ct)) |> 
  ungroup() |> 
  # county_ct pop / mmsa_pop
  mutate(county_mmsa_wt = county_ct/mmsa_pop) |>
  arrange(GEOID)

county_mmsa_wts |> saveRDS("data/intermediate_data/county_mmsa_wts.RDS")
```

```{r cbg_mmsacounts3}
#| eval: false
county_mmsa_wts <- readRDS("data/intermediate_data/county_mmsa_wts.RDS")
svi2020_sf_4326 <- readRDS("data/intermediate_data/svi2020_sf_4326.rds")

# compute weighted average for svi at county level
mmsa_svi1 <- svi2020_sf_4326 |>
  st_drop_geometry() |>
  select(starts_with("RPL"), FIPS) |>
  inner_join(county_mmsa_wts, by = c("FIPS" = "GEOID")) |> 
  mutate(across(starts_with("RPL"), as.numeric)) |>
  # RPL theme ranking * county_mmsa_wt
  mutate(across(starts_with("RPL"), ~ (.x * county_mmsa_wt), .names = "{.col}_wts"))
# unique(mmsa_svi1$RPL_THEME1 * mmsa_svi1$county_mmsa_wt == mmsa_svi1$RPL_THEME1_wts) # check matches 
# unique(mmsa_svi1$RPL_THEMES * mmsa_svi1$county_mmsa_wt == mmsa_svi1$RPL_THEMES_wts) # check matches  
mmsa_svi2 <- mmsa_svi1 |> 
  group_by(d_mmsa) |>
  # weighted average sum of weighted svis
  summarize(across(ends_with("_wts"), sum, .names = "mmsa_{.col}")) |>
  rename_with(~ str_remove(.x, "_wts"))
  
mmsa_svi2 |> saveRDS("data/intermediate_data/mmsa_svi.RDS")
```

```{r cbg_mmsa_mmsacounts4}
#| eval: FALSE
mmsa_svi <- readRDS("data/intermediate_data/mmsa_svi.RDS")

# join mmsa county mapping with mmsa level svi
svi2021_mmsa_sf_4326 <- mmsa_county_mapping_geoid_sf_4326 |> 
  left_join(mmsa_svi, by = "d_mmsa")

svi2021_mmsa_sf_4326 |> saveRDS("data/intermediate_data/svi2021_mmsa_sf_4326.rds")
```

```{r leafletsvi2}
svi2021_mmsa_sf_4326 <- readRDS("data/intermediate_data/svi2021_mmsa_sf_4326.rds")

pal_svi <- colorNumeric("inferno", NULL, reverse = TRUE)

svi2021_mmsa_sf_4326  |>
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_svi(mmsa_RPL_THEMES),
    fillOpacity = 0.5,
    smoothFactor = 0.5
    # increase opacity and resolution
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_svi,
    # palette function
    values = ~ mmsa_RPL_THEMES,
    # variable to pass to palette function
    title = 'svi',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

### ADI dataset

<!-- https://www.neighborhoodatlas.medicine.wisc.edu/ -->

<!-- About the Area Deprivation Index (ADI) -->

<!-- The Area Deprivation Index (ADI) is based on a measure created by the Health Resources & Services Administration (HRSA) over three decades ago, and has since been refined, adapted, and validated to the Census block group neighborhood level by Amy Kind, MD, PhD and her research team at the University of Wisconsin-Madison. It allows for rankings of neighborhoods by socioeconomic disadvantage in a region of interest (e.g., at the state or national level). It includes factors for the theoretical domains of income, education, employment, and housing quality. It can be used to inform health delivery and policy, especially for the most disadvantaged neighborhood groups. -->

<!-- "Neighborhood" is defined as a Census block group. -->

<!-- Limitations -->

<!-- The ADI is limited insofar as it uses American Community Survey (ACS) 5-Year Data for its construction. For example, the 2018 ADI uses the ACS Data for 2018, which represent a five-year "period" from 2014-2018. All limitations of the source data will persist throughout the ADI - results are subject to the accuracy and errors contained within the American Community Survey data release. -->

<!-- The choice of geographic units will also influence the ADI value. In the case of the ADI the Census block group is the geographic unit of construction, as the Census block group is considered the closest approximation to a "neighborhood". As such, we can only recommend linking the ADI to census block groups as other geographic units (including 5-digit ZIP Codes, ZCTA, and others) will not be valid. Please see the FAQ below for additional download and linkage guidance. -->

<!-- At census block group level -->

<!-- 100 is highest deprivation -->

-   ADI_NATRANK: National percentile of block group ADI score Numeric Ranking (1-100) or Suppression Codes:

    -   GQ (Group Quarters) - Greater than 33.3% of Housing Units are Group Quarters

    -   PH (Population/Housing) - Population less than 100 and/or fewer than 30 housing units

    -   GQ-PH (Group Quarters and Population Housing) - Both GQ and PH conditions are met (see above)

    -   QDI (Questionable Data Integrity) - Block Groups missing a key demographic factor for ADI construction

```{r loadadi}
# TODO scale ADI to match SVI
# retrieved from https://www.neighborhoodatlas.medicine.wisc.edu/
adi2021 <- read_csv("data/input_data/adi/adi-download/US_2021_ADI_Census_Block_Group_v4_0_1.csv")
tigris_cbg <- block_groups(cb = TRUE)  |>
  filter(!STATEFP %in% c("02",
                         "15", "60",
                         "66", "69",
                         "72", "78"))
```

```{r glimpseadi}
#| eval: FALSE
adi2021 |> glimpse()
```

```{r mapadi1}
#| eval: false

adi2021_sf <- adi2021 |>
  inner_join(tigris_cbg, by = c("FIPS" = "GEOID")) |>
  st_as_sf()

adi2021_cbg_sf_4326 <- st_transform(adi2021_sf, crs = 4326)
adi2021_cbg_sf_4326 |> saveRDS("data/intermediate_data/adi2021_cbg_sf_4326.rds")
```

```{r dqadi}
adi_no_cbg <- adi2021 |>
  anti_join(tigris_cbg, by = c("FIPS" = "GEOID"))

cbg_no_adi <- tigris_cbg |>
  anti_join(adi2021, by = c("GEOID" = "FIPS"))

# When a Census block group falls into one or more of the suppression criteria mentioned above the ADI rank is replaced with a code describing the suppression reason. Three possible codes will appear in the ADI field: "PH" for suppression due to low population and/or housing, "GQ" for suppression due to a high group quarters population, and "PH-GQ" for suppression due to both types of suppression criteria. A code of "QDI" designates block groups without an ADI due to Questionable Data Integrity, stemming from missing data in the source ACS data.
```

```{r cbgcounts1}
#| eval: false
contig_state_vctr <- datasets::state.abb |>
  setdiff(c("AK", "HI"))
# https://walker-data.com/umich-workshop-2022/intro-2020-census/#1
# get cbg counts to compute cbg weights for aggregating adi at county level
cbg_counts <- list()
for (contig_state in contig_state_vctr) {
  cbg_counts[[contig_state]] <- get_decennial(
    geography = "block group",
    variables = "P1_001N",
    state = contig_state,
    year = 2020,
    output = "wide"
  ) |>
    mutate(state_abb = contig_state)
}
cbg_counts |> saveRDS("data/intermediate_data/cbg_counts.RDS")
```

```{r cbgcounts2}
#| eval: false
cbg_counts <- readRDS("data/intermediate_data/cbg_counts.RDS") |> 
  bind_rows()

# computed cbg weights for county level
cbg_wts <- tigris_cbg |> 
  select(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, GEOID) |>
  st_drop_geometry() |> 
  inner_join(cbg_counts, by = "GEOID") |> 
  group_by(STATEFP, COUNTYFP) |>
  # county pop
  mutate(county_pop = sum(P1_001N)) |> 
  ungroup() |> 
  # cbg pop / county pop
  mutate(cbg_wt = P1_001N/county_pop) |>
  arrange(GEOID)

cbg_wts |> saveRDS("data/intermediate_data/cbg_wts.RDS")
```

```{r cbgcounts3}
#| eval: false
cbg_wts <- readRDS("data/intermediate_data/cbg_wts.RDS")
adi2021_cbg_sf_4326 <- readRDS("data/intermediate_data/adi2021_cbg_sf_4326.rds")

# compute weighted average for adi at county level
county_adi <- adi2021_cbg_sf_4326 |>
  st_drop_geometry() |> 
  select(-STATEFP, -COUNTYFP, -TRACTCE, -BLKGRPCE, -NAME) |> 
  inner_join(cbg_wts, by = c("FIPS" = "GEOID")) |>
  mutate(ADI_NATRANK = as.numeric(ADI_NATRANK)) |>
  filter(!is.na(ADI_NATRANK)) |>
  # national adi rank * cbg wt
  mutate(adi_wts = ADI_NATRANK * cbg_wt) |>
  group_by(STATEFP, COUNTYFP) |>
  # weighted average sum of weighted adis
  summarize(county_adi_value = sum(adi_wts)) |> 
  ungroup()

county_adi |> saveRDS("data/intermediate_data/county_adi.RDS")

# cbg_counts_comb <- cbg_counts |> 
#   bind_rows()
# cbg_counts_comb |> ggplot(aes(x = P1_001N)) + geom_histogram()
```

```{r cbgcounts4}
#| eval: FALSE
county_adi <- readRDS("data/intermediate_data/county_adi.RDS") |>
  mutate(FIPS = paste0(STATEFP, COUNTYFP)) |>
  select(-STATEFP,-COUNTYFP) |>
  left_join(tigris_counties, by = c("FIPS" = "GEOID")) |>
  st_as_sf()

adi2021_county_sf_4326 <- st_transform(county_adi, crs = 4326)
adi2021_county_sf_4326 |> saveRDS("data/intermediate_data/adi2021_county_sf_4326.rds")
```

```{r leafletadi}
adi2021_county_sf_4326 <- readRDS("data/intermediate_data/adi2021_county_sf_4326.rds")


pal_adi <- colorNumeric("inferno", NULL, reverse = TRUE)

adi2021_county_sf_4326  |>
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_adi(county_adi_value),
    fillOpacity = 0.5,
    smoothFactor = 0.5
    # increase opacity and resolution
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_adi,
    # palette function
    values = ~ county_adi_value,
    # variable to pass to palette function
    title = 'adi',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

#### ADI at MMSA level

```{r adicbsarollup}
#| eval: false
cbg_counts <- readRDS("data/intermediate_data/cbg_counts.RDS") |> 
  bind_rows()

# computed cbg weights for mmsa level
cbg_mmsa_wts <- tigris_cbg |> 
  select(STATEFP, COUNTYFP, TRACTCE, BLKGRPCE, GEOID) |>
  st_drop_geometry() |> 
  inner_join(cbg_counts, by = "GEOID") |> 
  right_join(mmsa_county_mapping, by = c("STATEFP" = "fips_state_code", 
                                             "COUNTYFP" = "fips_county_code")) |> 
  group_by(d_mmsa) |>
  # mmsa pop
  mutate(mmsa_pop = sum(P1_001N)) |> 
  ungroup() |> 
  # cbg pop / mmsa pop
  mutate(cbg_mmsa_wt = P1_001N/mmsa_pop) |>
  arrange(GEOID)

cbg_mmsa_wts |> saveRDS("data/intermediate_data/cbg_mmsa_wts.RDS")
```

```{r cbgmmsacounts}
#| eval: false
cbg_mmsa_wts <- readRDS("data/intermediate_data/cbg_mmsa_wts.RDS")
adi2021_cbg_sf_4326 <- readRDS("data/intermediate_data/adi2021_cbg_sf_4326.rds")

# compute weighted average for adi at county level
mmsa_adi <- adi2021_cbg_sf_4326 |>
  st_drop_geometry() |> 
  select(-STATEFP, -COUNTYFP, -TRACTCE, -BLKGRPCE, -NAME) |> 
  inner_join(cbg_mmsa_wts, by = c("FIPS" = "GEOID")) |>
  mutate(ADI_NATRANK = as.numeric(ADI_NATRANK)) |>
  filter(!is.na(ADI_NATRANK)) |>
  # national adi rank * cbg_mmsa wt
  mutate(adi_wts = ADI_NATRANK * cbg_mmsa_wt) |>
  group_by(d_mmsa) |>
  # weighted average sum of weighted adis
  summarize(mmsa_adi_value = sum(adi_wts, na.rm = TRUE))

mmsa_adi |> saveRDS("data/intermediate_data/mmsa_adi.RDS")

# cbg_mmsa_counts_comb <- cbg_mmsa_counts |> 
#   bind_rows()
# cbg_mmsa_counts_comb |> ggplot(aes(x = P1_001N)) + geom_histogram()
```

```{r cbgmmsacounts2}
#| eval: FALSE
mmsa_adi <- readRDS("data/intermediate_data/mmsa_adi.RDS")

adi2021_mmsa_sf_4326 <- mmsa_county_mapping_geoid_sf_4326 |> 
  left_join(mmsa_adi, by = "d_mmsa")

adi2021_mmsa_sf_4326 |> saveRDS("data/intermediate_data/adi2021_mmsa_sf_4326.rds")
```

```{r leafletadimmsa}
adi2021_mmsa_sf_4326 <- readRDS("data/intermediate_data/adi2021_mmsa_sf_4326.rds")


pal_adi <- colorNumeric("inferno", NULL, reverse = TRUE)

adi2021_mmsa_sf_4326  |>
  st_simplify(dTolerance = 1e3)  |>
  leaflet() |>
  addPolygons(
    stroke = FALSE,
    # remove polygon borders
    fillColor = ~ pal_adi(mmsa_adi_value),
    fillOpacity = 0.5,
    smoothFactor = 0.5
    # increase opacity and resolution
  ) |>
  addProviderTiles(providers$CartoDB.Voyager) |> # add third party provider tile
  addLegend(
    "bottomright",
    # location of legend
    pal = pal_adi,
    # palette function
    values = ~ mmsa_adi_value,
    # variable to pass to palette function
    title = 'adi',
    # legend title
    opacity = 1 # legend opacity (1 = completely opaque)
  ) |>
  addScaleBar()
```

```{r}
county_adi <- readRDS("data/intermediate_data/county_adi.RDS")
# compare SVI and ADI across entire US
svi_adi_county <- county_adi |>
  mutate(FIPS = paste0(STATEFP, COUNTYFP)) |> 
  select(FIPS, county_adi_value) |>
  st_drop_geometry() |>
  inner_join(svi2020_sf_4326 |> st_drop_geometry(),
             by = "FIPS") |>
  select(FIPS, county_adi_value, starts_with("RPL_"), NAME)

svi_adi_county_corr_plot <- svi_adi_county |>
  select(-NAME, -FIPS) |>
  select(RPL_THEME1,
         RPL_THEME2,
         RPL_THEME3,
         RPL_THEME4,
         RPL_THEMES,
         county_adi_value) |>
  get_corr_plot()
svi_adi_county_corr_plot
ggsave(filename = "local/svi_adi_county_corr_plot.png",
       width = 6,
       height = 4)

svi_adi_county |>
  my_point_plot(RPL_THEME3, county_adi_value)

```

### Combining datasets

#### For area-level analyses

```{r combinedataset}
#| eval: FALSE
# incorporate county counts for Poisson regression analyses
county_cts <- readRDS("data/intermediate_data/county_cts.RDS")

area_combined_dataset <- mmsa_county_mapping_geoid_sf_4326 |>
  select(d_mmsa, county_county_equivalent, fips_state_code, fips_county_code) |>
  left_join(select(ever_asthma_mmsa_tbl, -mmsaname), by = "d_mmsa") |> 
  left_join(select(ever_smoker_mmsa_tbl, -mmsaname), by = "d_mmsa") |>
  mutate(GEOID = paste0(fips_state_code, fips_county_code)) |>
  left_join(county_cts, by = "GEOID") |>
  st_join(select(svi2020_sf_4326, starts_with("RPL")),
          left = TRUE,
          join = st_equals) |> 
  st_join(select(adi2021_county_sf_4326, county_adi_value),
          left = TRUE,
          join = st_equals) |>
  mutate(
    n_w_ever_smoker = floor(w_ever_smoker * county_ct),
    n_uw_ever_smoker = floor(uw_ever_smoker * county_ct),
    n_w_ever_asthma = floor(w_ever_asthma * county_ct),
    n_uw_ever_asthma = floor(uw_ever_asthma * county_ct),
    county_adi_value = county_adi_value/100 # divide by 100 to match scale of SVI
  ) |> 
  rename(svi_t1_ses = RPL_THEME1, # Socioeconomic Status - RPL_THEME1
         svi_t2_household = RPL_THEME2, # Household Characteristics - RPL_THEME2
         svi_t3_raceethnicity = RPL_THEME3, # Racial & Ethnic Minority Status - RPL_THEME3
         svi_t4_housingtransport = RPL_THEME4, # Housing Type & Transportation - RPL_THEME4
         svi_overall = RPL_THEMES)






area_combined_dataset |> saveRDS("data/final_data/area_combined_dataset.rds")
```

#### For individual-level analyses

```{r combinedataset2}
#| eval: FALSE
mmsa_adi <- readRDS("data/intermediate_data/mmsa_adi.RDS")
mmsa_svi <- readRDS("data/intermediate_data/mmsa_svi.RDS")

indiv_combined_dataset <- smart_2021 |>
  mutate(
    # NA for missing ever smoker (different than area-level approach)
    d_ever_smoker = factor(case_when(d_smoker3 %in% c(1, 2, 3) ~ 1,
                               d_smoker3 == 4 ~ 0,
                               TRUE ~ NA)),
    d_ever_asthma = factor(case_when(d_ltasth1 == 1 ~ 0,
                               d_ltasth1 == 2 ~ 1,
                               TRUE ~ NA)),
    # NA for missing ever asthma (different than area-level approach)
    d_sex = factor(if_else(d_sex == 1, "male", "female")),
    d_race_eth = factor(
      case_when(
        d_race == 1 ~ "White only, non-Hispanic",
        d_race == 2 ~ "Black only, non-Hispanic",
        d_race == 3 ~ "American Indian or Alaskan Native only",
        d_race == 4 ~ "Asian only, non-Hispanic",
        d_race == 5 ~ "Native Hawaiian or other Pacific Islander only",
        d_race == 6 ~ "Other race only, non-Hispanic",
        d_race == 7 ~ "Multiracial, non-Hispanic",
        d_race == 8 ~ "Hispanic",
        d_race == 9 ~ "Don’t know/Not sure/Refused",
        TRUE ~ NA
      ),
      levels = c(
        "White only, non-Hispanic",
        "Black only, non-Hispanic",
        "American Indian or Alaskan Native only",
        "Asian only, non-Hispanic",
        "Native Hawaiian or other Pacific Islander only",
        "Other race only, non-Hispanic",
        "Multiracial, non-Hispanic",
        "Hispanic",
        "Don’t know/Not sure/Refused"
      )
    ),
    d_imput_age_group = factor(
      case_when(
        d_age_g == 1 ~ "18–24",
        d_age_g == 2 ~ "25–34",
        d_age_g == 3 ~ "35–44",
        d_age_g == 4 ~ "45–54",
        d_age_g == 5 ~ "55–64",
        d_age_g == 6 ~ "65–99",
        TRUE ~ NA
      )
    )
  ) |>
  select(d_resp_id,
         d_ever_smoker,
         d_ever_asthma,
         d_sex,
         d_race_eth,
         d_imput_age_group,
         d_mmsa,
         d_ststr,
         d_mmsawt) |>
  left_join(mmsa_adi, by = "d_mmsa") |>
  left_join(mmsa_svi, by = "d_mmsa") |> 
  mutate(d_mmsa = factor(d_mmsa),
    mmsa_adi_value = mmsa_adi_value/100 # divide by 100 to match scale of SVI
    ) |> 
  rename(mmsa_svi_t1_ses = mmsa_RPL_THEME1, # Socioeconomic Status - RPL_THEME1
         mmsa_svi_t2_household = mmsa_RPL_THEME2, # Household Characteristics - RPL_THEME2
         mmsa_svi_t3_raceethnicity = mmsa_RPL_THEME3, # Racial & Ethnic Minority Status - RPL_THEME3
         mmsa_svi_t4_housingtransport = mmsa_RPL_THEME4, # Housing Type & Transportation - RPL_THEME4
         mmsa_svi_overall = mmsa_RPL_THEMES)

# TODO should survey design be used here?
indiv_combined_dataset_surv <- indiv_combined_dataset |>
  as_survey_design(ids = 1,
                   strata = d_ststr,
                   weights = d_mmsawt)

# check contrasts for intercepts
contrasts(indiv_combined_dataset$d_sex)
contrasts(indiv_combined_dataset$d_imput_age_group)
contrasts(indiv_combined_dataset$d_race_eth)

indiv_combined_dataset |> saveRDS("data/final_data/indiv_combined_dataset.rds")
```

## Results {#sec-results}

### Area-level analyses

#### Correlations

```{r correlations}
area_combined_dataset <-
  readRDS("data/final_data/area_combined_dataset.rds") |>
  st_drop_geometry()

# benefited from approach here https://rpubs.com/cqj_00/785193

area_combined_corr_plot <- area_combined_dataset |>
  select(
    w_ever_asthma,
    w_ever_smoker,
    svi_t1_ses,
    svi_t2_household,
    svi_t3_raceethnicity,
    svi_t4_housingtransport,
    svi_overall,
    county_adi_value,
    county_ct
  ) |>
  get_corr_plot()
area_combined_corr_plot
ggsave(filename = "local/area_combined_corr_plot.png",
       width = 6, height = 4)
area_combined_corr_plot2 <- area_combined_dataset |>
  select(
    svi_t1_ses,
    svi_t2_household,
    svi_t3_raceethnicity,
    svi_t4_housingtransport,
    svi_overall,
    county_adi_value
  ) |>
  get_corr_plot()
ggsave(filename = "local/area_combined_corr_plot2.png",
       width = 6, height = 4)

# area_combined_dataset |>
#   my_point_plot(svi_t3_raceethnicity,
#                 county_adi_value)
```

#### Relationship between ADI and SVI at county level

```{r}
svi_adi_model <-
  glm(county_adi_value ~ svi_t1_ses + svi_t2_household + svi_t3_raceethnicity + svi_t4_housingtransport + county_ct,
      family = gaussian(),
      data = area_combined_dataset)


modelsummary(
  list(
    "svi_adi_model" = svi_adi_model
  ),
  coef_omit = "Intercept",
  statistic = c("p = {p.value}"),
  estimate = "{estimate} [{conf.low}, {conf.high}]"
)
```

#### Smoking

```{r}
area_combined_dataset |> 
  ggplot(aes(x = w_ever_smoker)) +
  geom_density()  +
  my_theme()

plot_grid(
  area_combined_dataset |>
    my_point_plot(w_ever_smoker,
                  county_adi_value),
  
  area_combined_dataset |>
    my_point_plot(w_ever_smoker,
                  svi_t1_ses),
  
  area_combined_dataset |>
    my_point_plot(w_ever_smoker,
                  svi_t2_household),
  
  area_combined_dataset |>
    my_point_plot(w_ever_smoker,
                  svi_t3_raceethnicity),
  
  area_combined_dataset |>
    my_point_plot(w_ever_smoker,
                  svi_t4_housingtransport),
  
  area_combined_dataset |>
    my_point_plot(w_ever_smoker,
                  svi_t2_household)
)
```

```{r}
# remove outliers
smoking_dataset_cleaned <- area_combined_dataset |> 
  filter(w_ever_smoker >= 0.2)
# exploring modelling approaches..
# benefited from https://rpubs.com/kaz_yos/poisson
smoking_quasibinom_adi_only <-
  glm(w_ever_smoker ~ county_adi_value,
      family = quasibinomial(),
      data = smoking_dataset_cleaned)

smoking_quasipoisson_adi_only <-
  glm(
    n_w_ever_smoker ~ county_adi_value,
    offset = log(county_ct),
    family = quasipoisson(link = "log"),
    data = smoking_dataset_cleaned
  )

smoking_quasibinom <-
  glm(w_ever_smoker ~ svi_t1_ses + svi_t2_household + svi_t3_raceethnicity + svi_t4_housingtransport + county_adi_value,
      family = quasibinomial(),
      data = smoking_dataset_cleaned)

smoking_quasipoisson <-
  glm(
    n_w_ever_smoker ~ svi_t1_ses + svi_t2_household + svi_t3_raceethnicity + svi_t4_housingtransport + county_adi_value,
    offset = log(county_ct),
    family = quasipoisson(link = "log"),
    data = smoking_dataset_cleaned
  )

modelsummary(
  list(
    "smoking_quasibinom" = smoking_quasibinom,
    "smoking_quasibinom_adi_only" = smoking_quasibinom_adi_only,
    "smoking_quasipoisson" = smoking_quasipoisson,
    "smoking_quasipoisson_adi_only" = smoking_quasipoisson_adi_only
  ),
  coef_omit = "Intercept",
  statistic = c("p = {p.value}"),
  estimate = "{estimate} [{conf.low}, {conf.high}]",
  exponentiate = TRUE
)
```

```{r}
tbl_regression(smoking_quasipoisson, exponentiate = TRUE) |>
  bold_p(t = 0.05) |>
  bold_labels() |>
  italicize_levels()
```

#### Asthma

```{r}
area_combined_dataset |> 
  ggplot(aes(x = w_ever_asthma)) +
  geom_density()  +
  my_theme()

plot_grid(
  area_combined_dataset |>
    my_point_plot(w_ever_asthma,
                  county_adi_value),
  
  area_combined_dataset |>
    my_point_plot(w_ever_asthma,
                  svi_t1_ses),
  
  area_combined_dataset |>
    my_point_plot(w_ever_asthma,
                  svi_t2_household),
  
  area_combined_dataset |>
    my_point_plot(w_ever_asthma,
                  svi_t3_raceethnicity),
  
  area_combined_dataset |>
    my_point_plot(w_ever_asthma,
                  svi_t4_housingtransport),
  
  area_combined_dataset |>
    my_point_plot(w_ever_asthma,
                  svi_t2_household)
)
```

```{r}
# remove outliers
asthma_dataset_cleaned <- area_combined_dataset
# exploring modelling approaches..
# benefitted from https://rpubs.com/kaz_yos/poisson
asthma_quasibinom <-
  glm(w_ever_asthma ~ svi_t1_ses + svi_t2_household + svi_t3_raceethnicity + svi_t4_housingtransport + county_adi_value,
      family = quasibinomial(),
      data = asthma_dataset_cleaned)

asthma_quasipoisson <-
  glm(
    n_w_ever_asthma ~ svi_t1_ses + svi_t2_household + svi_t3_raceethnicity + svi_t4_housingtransport + county_adi_value,
    offset = log(county_ct),
    family = quasipoisson(link = "log"),
    data = asthma_dataset_cleaned
  )

asthma_quasibinom_adi_only <-
  glm(w_ever_asthma ~ county_adi_value,
      family = quasibinomial(),
      data = asthma_dataset_cleaned)

asthma_quasipoisson_adi_only <-
  glm(
    n_w_ever_asthma ~ county_adi_value,
    offset = log(county_ct),
    family = quasipoisson(link = "log"),
    data = asthma_dataset_cleaned
  )

modelsummary(
  list(
    "asthma_quasibinom" = asthma_quasibinom,
    "asthma_quasibinom_adi_only" = asthma_quasibinom_adi_only,
    "asthma_quasipoisson" = asthma_quasipoisson,
    "asthma_quasipoisson_adi_only" = asthma_quasipoisson_adi_only
  ),
  coef_omit = "Intercept",
  statistic = c("p = {p.value}"),
  estimate = "{estimate} [{conf.low}, {conf.high}]",
  exponentiate = TRUE
)
```

```{r}
tbl_regression(asthma_quasipoisson, exponentiate = TRUE) |>
  bold_p(t = 0.05) |>
  bold_labels() |>
  italicize_levels()
```

### Individual-level analyses

Given the absence of some of the expected relationships with asthma, try analyzing at individual-level with area-level measurements rolled up to CBSA

#### Correlations

```{r}
indiv_combined_dataset <- readRDS("data/final_data/indiv_combined_dataset.rds")
# benefited from approach here https://rpubs.com/cqj_00/785193
indiv_combined_corr_plot <- indiv_combined_dataset |>
  select(-d_sex, -d_race_eth, -d_imput_age_group, -d_mmsa, -d_ever_smoker, -d_ever_asthma, -d_resp_id) |> 
  get_corr_plot()
indiv_combined_corr_plot
ggsave(filename = "local/indiv_combined_corr_plot.png",
       width = 6, height = 4)
```

#### Relationship between ADI and SVI at MMSA level

```{r}
svi_adi_model <-
  glm(mmsa_adi_value ~ mmsa_svi_t1_ses + mmsa_svi_t2_household + mmsa_svi_t3_raceethnicity + mmsa_svi_t4_housingtransport,
      family = gaussian(),
      data = indiv_combined_dataset)

# TODO check these relationship hold across the US (not just MMSAs)
modelsummary(
  list(
    "svi_adi_model" = svi_adi_model
  ),
  coef_omit = "Intercept",
  statistic = c("p = {p.value}"),
  estimate = "{estimate} [{conf.low}, {conf.high}]"
)
```

#### Smoking

```{r}
smoking_individual_dataset_cleaned <- indiv_combined_dataset |>
  filter(!is.na(d_ever_smoker))

plot_grid(smoking_individual_dataset_cleaned |>
  my_box_plot(d_ever_smoker,
              mmsa_adi_value) +
    ylab("ADI"),
  
  smoking_individual_dataset_cleaned |>
  my_box_plot(d_ever_smoker,
              mmsa_svi_t1_ses) +
    ylab("SVI 1 (SES)"),
  
  smoking_individual_dataset_cleaned |>
  my_box_plot(d_ever_smoker,
              mmsa_svi_t2_household) +
    ylab("SVI 2 (Household)"),
  
  smoking_individual_dataset_cleaned |>
  my_box_plot(d_ever_smoker,
              mmsa_svi_t3_raceethnicity) +
    ylab("SVI 3 (Race/Eth)"),
  
  smoking_individual_dataset_cleaned |>
  my_box_plot(d_ever_smoker,
              mmsa_svi_t4_housingtransport) +
    ylab("SVI 4 (Housing/Transp)"),
  
  smoking_individual_dataset_cleaned |>
  my_box_plot(d_ever_smoker,
              mmsa_svi_overall) +
    ylab("SVI Overall")
)
ggsave(filename = "local/smoking_plot_grid.png")
```

```{r}
# smoking_individual_dataset_cleaned |> summarize(n_distinct(d_resp_id)) == smoking_individual_dataset_cleaned |> nrow()
# smoking_individual_dataset_cleaned |> summarize(n_distinct(d_resp_id)) == smoking_individual_dataset_cleaned |> nrow()

# smoking_individual_dataset_cleaned |>
#   group_by(d_sex) |>
#   summarize(n_ever_smoker = sum(d_ever_smoker == 1),
#   n_total = n_distinct(d_resp_id)) |>
#   ungroup() |>
#   mutate(prop = n_ever_smoker / n_total) |>
#   ggplot(aes(
#     x = fct_reorder(d_sex, prop),
#     y = prop,
#     label = round(prop, digits = 2),
#     fill = d_sex)) +
#   geom_col() +
#   coord_flip() +
#   my_theme() +
#   theme(legend.position = "bottom")
# 
# smoking_individual_dataset_cleaned |>
#   group_by(d_race_eth) |>
#   summarize(n_ever_smoker = sum(d_ever_smoker == 1),
#   n_total = n_distinct(d_resp_id)) |>
#   ungroup() |>
#   mutate(prop = n_ever_smoker / n_total) |>
#   ggplot(aes(
#     x = fct_reorder(d_race_eth, prop),
#     y = prop,
#     label = round(prop, digits = 2),
#     fill = d_race_eth)) +
#   geom_col() +
#   geom_label(fill = "white") +
#   coord_flip() +
#   my_theme() +
#   theme(legend.position = "bottom")

smoking_individual_dataset_cleaned |>
  group_by(d_race_eth, d_sex) |>
  summarize(n_ever_smoker = sum(d_ever_smoker == 1),
  n_total = n_distinct(d_resp_id)) |>
  ungroup() |>
  mutate(prop = n_ever_smoker / n_total) |>
  ggplot(aes(
    x = fct_reorder(d_race_eth, prop),
    y = prop,
    label = round(prop, digits = 2),
    fill = d_sex,
    group = d_sex)) +
  geom_col(position = position_dodge()) +
  my_theme() +
  theme(legend.position = "bottom") +
  coord_flip() +
  xlab("d_race_eth") +
  ylab("proportion d_ever_smoker") +
  scale_fill_manual(values = c("female" = "#eb6223", male = "#512892"))
ggsave(filename = "local/smoking_sex_raceeth.png",
       width = 6, height = 4)

smoking_individual_dataset_cleaned |>
  group_by(d_sex, d_imput_age_group) |>
  summarize(n_ever_smoker = sum(d_ever_smoker == 1),
  n_total = n_distinct(d_resp_id)) |>
  ungroup() |>
  mutate(prop = n_ever_smoker / n_total) |>
  ggplot(aes(
    x = d_imput_age_group,
    y = prop,
    label = round(prop, digits = 2),
    colour = d_sex,
    group = d_sex
  )) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 2) +
  my_theme() +
  theme(legend.position = "none") +
  xlab("d_imput_age_group") +
  ylab("proportion d_ever_smoker") +
  scale_colour_manual(values = c("female" = "#eb6223", male = "#512892"))
ggsave(filename = "local/smoking_sex_age.png",
       width = 8, height = 3)

# smoking_individual_dataset_cleaned |>
#   group_by(d_race_eth, d_imput_age_group) |>
#   summarize(n_ever_smoker = sum(d_ever_smoker == 1),
#   n_total = n_distinct(d_resp_id)) |>
#   ungroup() |>
#   mutate(prop = n_ever_smoker / n_total) |>
#   ggplot(aes(
#     x = d_imput_age_group,
#     y = prop,
#     label = round(prop, digits = 2),
#     colour = d_race_eth,
#     group = d_race_eth
#   )) +
#   geom_line() +
#   geom_point() +
#   theme_minimal()
```

```{r}
smoking_binomial_adi_only <-
  glm(
    d_ever_smoker ~  d_sex * d_race_eth + d_imput_age_group + mmsa_adi_value,
    family = binomial(),
    data = smoking_individual_dataset_cleaned
  )

smoking_binomial <-
  glm(
    d_ever_smoker ~ d_sex * d_race_eth + d_imput_age_group + mmsa_svi_t1_ses + mmsa_svi_t2_household + mmsa_svi_t3_raceethnicity + mmsa_svi_t4_housingtransport  + mmsa_adi_value,
    family = binomial(),
    data = smoking_individual_dataset_cleaned
  )

modelsummary(
  list(
    "smoking_binomial_adi_only" = smoking_binomial_adi_only,
    "smoking_binomial" = smoking_binomial
  ),
  coef_omit = "Intercept",
  statistic = c("p = {p.value}"),
  estimate = "{estimate} [{conf.low}, {conf.high}]",
  exponentiate = TRUE
)
```

```{r}
tbl_regression(smoking_binomial, exponentiate = TRUE) |>
  bold_p(t = 0.05) |>
  bold_labels() |>
  italicize_levels()
```

<!-- Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required. -->

#### Asthma

```{r}
asthma_individual_dataset_cleaned <- indiv_combined_dataset |>
  filter(!is.na(d_ever_asthma),!is.na(d_ever_asthma))

plot_grid(asthma_individual_dataset_cleaned |>
  my_box_plot(d_ever_asthma,
              mmsa_adi_value) +
    ylab("ADI"),
  
  asthma_individual_dataset_cleaned |>
  my_box_plot(d_ever_asthma,
              mmsa_svi_t1_ses) +
    ylab("SVI 1 (SES)"),
  
  asthma_individual_dataset_cleaned |>
  my_box_plot(d_ever_asthma,
              mmsa_svi_t2_household) +
    ylab("SVI 2 (Household)"),
  
  asthma_individual_dataset_cleaned |>
  my_box_plot(d_ever_asthma,
              mmsa_svi_t3_raceethnicity) +
    ylab("SVI 3 (Race/Eth)"),
  
  asthma_individual_dataset_cleaned |>
  my_box_plot(d_ever_asthma,
              mmsa_svi_t4_housingtransport) +
    ylab("SVI 4 (Housing/Transp)"),
  
  asthma_individual_dataset_cleaned |>
  my_box_plot(d_ever_asthma,
              mmsa_svi_overall) +
    ylab("SVI Overall")
)
ggsave(filename = "local/asthma_plot_grid.png")
```

```{r}
# asthma_individual_dataset_cleaned |> summarize(n_distinct(d_resp_id)) == asthma_individual_dataset_cleaned |> nrow()

# asthma_individual_dataset_cleaned |>
#   group_by(d_sex) |>
#   summarize(n_ever_asthma = sum(d_ever_asthma == 1),
#   n_total = n_distinct(d_resp_id)) |>
#   ungroup() |>
#   mutate(prop = n_ever_asthma / n_total) |>
#   ggplot(aes(
#     x = fct_reorder(d_sex, prop),
#     y = prop,
#     label = round(prop, digits = 2),
#     fill = d_sex)) +
#   geom_col() +
#   coord_flip() +
#   my_theme() +
#   theme(legend.position = "bottom")
# 
# asthma_individual_dataset_cleaned |>
#   group_by(d_race_eth) |>
#   summarize(n_ever_asthma = sum(d_ever_asthma == 1),
#   n_total = n_distinct(d_resp_id)) |>
#   ungroup() |>
#   mutate(prop = n_ever_asthma / n_total) |>
#   ggplot(aes(
#     x = fct_reorder(d_race_eth, prop),
#     y = prop,
#     label = round(prop, digits = 2),
#     fill = d_race_eth)) +
#   geom_col() +
#   geom_label(fill = "white") +
#   coord_flip() +
#   my_theme() +
#   theme(legend.position = "bottom")

asthma_individual_dataset_cleaned |>
  group_by(d_race_eth, d_sex) |>
  summarize(n_ever_asthma = sum(d_ever_asthma == 1),
  n_total = n_distinct(d_resp_id)) |>
  ungroup() |>
  mutate(prop = n_ever_asthma / n_total) |>
  ggplot(aes(
    x = fct_reorder(d_race_eth, prop),
    y = prop,
    label = round(prop, digits = 2),
    fill = d_sex,
    group = d_sex)) +
  geom_col(position = position_dodge()) +
  my_theme() +
  theme(legend.position = "bottom") +
  coord_flip() +
  xlab("d_race_eth") +
  ylab("proportion d_ever_asthma") +
  scale_fill_manual(values = c("female" = "#eb6223", male = "#512892"))
ggsave(filename = "local/asthma_sex_raceeth.png",
       width = 6, height = 4)

asthma_individual_dataset_cleaned |>
  group_by(d_sex, d_imput_age_group) |>
  summarize(n_ever_asthma = sum(d_ever_asthma == 1),
  n_total = n_distinct(d_resp_id)) |>
  ungroup() |>
  mutate(prop = n_ever_asthma / n_total) |>
  ggplot(aes(
    x = d_imput_age_group,
    y = prop,
    label = round(prop, digits = 2),
    colour = d_sex,
    group = d_sex
  )) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 2) +
  my_theme() +
  theme(legend.position = "none") +
  xlab("d_imput_age_group") +
  ylab("proportion d_ever_asthma") +
  scale_colour_manual(values = c("female" = "#eb6223", male = "#512892"))
ggsave(filename = "local/asthma_sex_age.png",
       width = 8, height = 3)

# asthma_individual_dataset_cleaned |>
#   group_by(d_race_eth, d_imput_age_group) |>
#   summarize(n_ever_asthma = sum(d_ever_asthma == 1),
#   n_total = n_distinct(d_resp_id)) |>
#   ungroup() |>
#   mutate(prop = n_ever_asthma / n_total) |>
#   ggplot(aes(
#     x = d_imput_age_group,
#     y = prop,
#     label = round(prop, digits = 2),
#     colour = d_race_eth,
#     group = d_race_eth
#   )) +
#   geom_line() +
#   geom_point() +
#   theme_minimal()
```

```{r}
asthma_binomial_adi_only <-
  glm(
    d_ever_asthma ~ d_ever_smoker + d_sex + d_race_eth + d_imput_age_group + d_sex:d_race_eth + d_sex:d_imput_age_group + mmsa_adi_value,
    family = binomial(),
    data = asthma_individual_dataset_cleaned
  )

asthma_binomial <-
  glm(
    d_ever_asthma ~ d_ever_smoker + d_sex + d_race_eth + d_imput_age_group + d_sex:d_race_eth + d_sex:d_imput_age_group + mmsa_svi_t1_ses + mmsa_svi_t2_household + mmsa_svi_t3_raceethnicity + mmsa_svi_t4_housingtransport  + mmsa_adi_value,
    family = binomial(),
    data = asthma_individual_dataset_cleaned
  )

modelsummary(
  list(
    "asthma_binomial_adi_only" = asthma_binomial_adi_only,
    "asthma_binomial" = asthma_binomial
  ),
  coef_omit = "Intercept",
  statistic = c("p = {p.value}"),
  estimate = "{estimate} [{conf.low}, {conf.high}]",
  exponentiate = TRUE
)
```

```{r}
tbl_regression(asthma_binomial, exponentiate = TRUE) |>
  bold_p(t = 0.05) |>
  bold_labels() |>
  italicize_levels()
```

## Conclusion

<!-- area level race correlated with?? collapses across relationships in differing directions -->


<!-- This the conclusion. The @sec-results can be invoked if you'd like. -->

## References

<!-- Need to figure out how to properly manage references -->

*Centers for Disease Control and Prevention (CDC). Behavioral Risk Factor Surveillance System Survey Questionnaire. Atlanta, Georgia: U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, 2021.*

*Centers for Disease Control and Prevention (CDC). Behavioral Risk Factor Surveillance System Survey Data. Atlanta, Georgia: U.S. Department of Health and Human Services, Centers for Disease Control and Prevention, 2021.*

*Centers for Disease Control and Prevention/ Agency for Toxic Substances and Disease Registry/ Geospatial Research, Analysis, and Services Program. CDC/ATSDR Social Vulnerability Index 2020 Database US. https://www.atsdr.cdc.gov/placeandhealth/svi/data_documentation_download.html. Accessed on 2023/11/04.*

*Kind AJH, Buckingham W. Making Neighborhood Disadvantage Metrics Accessible: The Neighborhood Atlas. New England Journal of Medicine, 2018. 378: 2456-2458. DOI: 10.1056/NEJMp1802313. PMCID: PMC6051533.*

*Lotfata A, Moosazadeh M, Helbich M, Hoseini B. Socioeconomic and environmental determinants of asthma prevalence: a cross-sectional study at the U.S. County level using geographically weighted random forests. Int J Health Geogr. 2023 Aug 10;22(1):18. doi: 10.1186/s12942-023-00343-6. PMID: 37563691; PMCID: PMC10413687.*

*Rollings KA, Noppert GA, Griggs JJ, Melendez RA, Clarke PJ. Comparison of two area-level socioeconomic deprivation indices: Implications for public health research, practice, and policy. PLoS One. 2023 Oct 5;18(10):e0292281. doi: 10.1371/journal.pone.0292281. PMID: 37797080; PMCID: PMC10553799.*

*Tipirneni R, Schmidt H, Lantz PM, Karmakar M. Associations of 4 Geographic Social Vulnerability Indices With US COVID-19 Incidence and Mortality. Am J Public Health. 2022 Nov;112(11):1584-1588. doi: 10.2105/AJPH.2022.307018. Epub 2022 Sep 15. PMID: 36108250; PMCID: PMC9558191.*

*University of Wisconsin School of Medicine and Public Health. 2021 Area Deprivation Index v4.0.1. Downloaded from https://www.neighborhoodatlas.medicine.wisc.edu/ 2023/11/04*

*Xie S, Himes BE. Approaches to Link Geospatially Varying Social, Economic, and Environmental Factors with Electronic Health Record Data to Better Understand Asthma Exacerbations. AMIA Annu Symp Proc. 2018 Dec 5;2018:1561-1570. PMID: 30815202; PMCID: PMC6371292.*

*Xie S, Hubbard RA, Himes BE. Neighborhood-level measures of socioeconomic status are more correlated with individual-level measures in urban areas compared with less urban areas. Ann Epidemiol. 2020 Mar;43:37-43.e4. doi: 10.1016/j.annepidem.2020.01.012. Epub 2020 Feb 11. PMID: 32151518; PMCID: PMC7160852.*

## Appendices {#sec-app}

### Session Info

```{r sessioninfo}
sessionInfo()
```

### SMART BRFSS CDC dataset {#sec-smartcols}

```{r}
mmsa_colnames_all |> 
  kable()
```

### Asthma and smoking BRFSS variables

```{r}
# TODO add race, sex, age to this table
```

The table below summarizes the variables of interest, combining information from <https://www.cdc.gov/brfss/annual_data/2021/summary_matrix_21.html> and <https://www.cdc.gov/brfss/annual_data/2021/pdf/2021-calculated-variables-version4-508.pdf>

+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Output Variables\   | **Description or Result\                                                                                                                                                          | **Values**                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| (In Final Data Set)** | of Calculation**                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| \_LTASTH1             | CV for lifetime asthma prevalence / Calculated variable for adults who have ever been told they have asthma.                                                                      | +--------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                                                                                                       |
|                       |                                                                                                                                                                                   | | **1**  | No                                     | *Respondents who have not been told by a doctor, nurse, or health professional that they had asthma.*                                                                                                                                                                                   |                                                                                                       |
|                       | \_LTASTH1 is derived from ASTHMA3.                                                                                                                                                | +--------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                                                                                                       |
|                       |                                                                                                                                                                                   | | **2**  | Yes                                    | *Respondents who have been told by a doctor, nurse, or health professional that they had asthma.*                                                                                                                                                                                       |                                                                                                       |
|                       |                                                                                                                                                                                   | +--------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                                                                                                       |
|                       |                                                                                                                                                                                   | | **9**  | Don't know/Not Sure or Refused/Missing | *Respondents who reported they did not know if they had been told by a doctor, nurse, or health professional that they had asthma, those who refused to answer if they had been told by a doctor, nurse. or health professional that they had asthma, or those with missing responses.* |                                                                                                       |
|                       |                                                                                                                                                                                   | +--------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                                                                                                       |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| \_CASTHM1             | CV for current asthma prevalence / Calculated variable for adults who have been told they currently have asthma.                                                                  | +-------+----------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ |
|                       |                                                                                                                                                                                   | | **1** | No                                     | *Respondents who have not been told by a doctor, nurse, or health professional that they had asthma or do not still have asthma.*                                                                                                                                                                                                                                                              | |
|                       | \_CASTHM1 is derived from ASTHMA3 and ASTHNOW.                                                                                                                                    | +-------+----------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ |
|                       |                                                                                                                                                                                   | | **2** | Yes                                    | *Respondents who have been told by a doctor, nurse, or health professional that they had asthma and that they still have asthma.*                                                                                                                                                                                                                                                              | |
|                       |                                                                                                                                                                                   | +-------+----------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ |
|                       |                                                                                                                                                                                   | | **9** | Don't know/Not Sure or Refused/Missing | *Respondents who reported they did not know if they had been told by a doctor, nurse, or health professional that they had asthma, those who refused to answer if they had been told by a doctor, nurse, or health professional that they had asthma, those who did not know if they still had asthma, those who refused to answer if they still had asthma, or those with missing responses.* | |
|                       |                                                                                                                                                                                   | +-------+----------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+ |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| \_ASTHMS1             | Computed asthma status / Calculated variable for computed asthma status.                                                                                                          | +-------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  |
|                       |                                                                                                                                                                                   | | **1** | Current                                | *Respondents who have been told by a doctor, nurse, or health professional that they had asthma and that they still have asthma.*                                                                                                                                                                                                                                                             |  |
|                       | \_ASTHMS1 is derived from ASTHMA3 and ASTHNOW                                                                                                                                     | +-------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  |
|                       |                                                                                                                                                                                   | | **2** | Former                                 | *Respondents who have been told by a doctor, nurse, or health professional that they had asthma but do not still have asthma.*                                                                                                                                                                                                                                                                |  |
|                       |                                                                                                                                                                                   | +-------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  |
|                       |                                                                                                                                                                                   | | **3** | Never                                  | *Respondents who have not been told by a doctor, nurse, or health professional that they had asthma.*                                                                                                                                                                                                                                                                                         |  |
|                       |                                                                                                                                                                                   | +-------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  |
|                       |                                                                                                                                                                                   | | **9** | Don't know/Not Sure or Refused/Missing | *Respondents who reported they didn't know if they had been told by a doctor, nurse, or health professional that they had asthma, those who refused to answer if they had been told by a doctor, nurse, or health professional that they had asthma, those who didn't know if they still had asthma, those that refused to answer if they still had asthma, or those with missing responses.* |  |
|                       |                                                                                                                                                                                   | +-------+----------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| \_SMOKER3             | Smoking Status: Everyday smoker, someday smoker, former smoker and non smoker / Calculated variable for four-level smoker status: everyday smoker, someday smoker, former smoker, | +-------+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+               |
|                       |                                                                                                                                                                                   | | **1** | Current smoker--now smokes every day | *Respondents who reported having smoked at least 100 cigarettes in their lifetime and now smoke every day.*                                                                                                                                                                                                                                                                        |               |
|                       | non-smoker. \_SMOKER3 is derived from SMOKE100 and SMOKDAY2.                                                                                                                      | +-------+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+               |
|                       |                                                                                                                                                                                   | | **2** | Current smoker--now smokes some days | *Respondents who reported having smoked at least 100 cigarettes in their lifetime and now smoke some days.*                                                                                                                                                                                                                                                                        |               |
|                       |                                                                                                                                                                                   | +-------+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+               |
|                       |                                                                                                                                                                                   | | **3** | Former smoker                        | *Respondents who reported having smoked at least 100 cigarettes in their lifetime and currently do not smoke.*                                                                                                                                                                                                                                                                     |               |
|                       |                                                                                                                                                                                   | +-------+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+               |
|                       |                                                                                                                                                                                   | | **4** | Never smoked                         | *Respondents who reported they had not smoked at least 100 cigarettes in their lifetime.*                                                                                                                                                                                                                                                                                          |               |
|                       |                                                                                                                                                                                   | +-------+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+               |
|                       |                                                                                                                                                                                   | | **9** | Don't know/Refused/Missing           | *Respondents who reported they didn't know if they had smoked 100 cigarettes in their lifetime, those who refused to answer if they had smoked 100 cigarettes in their lifetime, those who didn't know if they now smoked every day, some days or not at all, those who refused to answer if they now smoked every day, some days or not at all, or those with missing responses.* |               |
|                       |                                                                                                                                                                                   | +-------+--------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+               |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| \_RFSMOK3             | CV for current smoking status / \_RFSMOK3 Calculated variable for adults who are current smokers. \_RFSMOK3 is derived from \_SMOKER3.                                            | +-------+----------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                        |
|                       |                                                                                                                                                                                   | | **1** | No                         | *Respondents who reported they had not smoked at least 100 cigarettes in their lifetime, those who reported having smoked 100 cigarettes in their lifetime but do not currently smoke.*                                                                                                                                                                                             |                        |
|                       |                                                                                                                                                                                   | +-------+----------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                        |
|                       |                                                                                                                                                                                   | | **2** | Yes                        | *Respondents who reported having smoked at least 100 cigarettes in their lifetime and currently smoke.*                                                                                                                                                                                                                                                                             |                        |
|                       |                                                                                                                                                                                   | +-------+----------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                        |
|                       |                                                                                                                                                                                   | | **9** | Don't know/Refused/Missing | *Respondents who reported they did not know if they had smoked 100 cigarettes in their lifetime, those who refused to answer if they had smoked 100 cigarettes in their lifetime, those who didn't know if they now smoked every day, some days or not at all, those who refused to answer if they now smoked every day, some days or not at all, or those with missing responses.* |                        |
|                       |                                                                                                                                                                                   | +-------+----------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                        |
|                       |                                                                                                                                                                                   | |       |                            |                                                                                                                                                                                                                                                                                                                                                                                     |                        |
|                       |                                                                                                                                                                                   | +-------+----------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+                        |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| \_CURECI1             | CV for current e-cigarette smoker status / Calculated variable for adults who are current e-cigarette users.                                                                      | +-------+----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+    |
|                       |                                                                                                                                                                                   | | **1** | Not currently using E-cigarettes | *Respondents who reported they had not used E-cigarettes in their lifetime, those who reported having used E-cigarettes in their lifetime but do not currently use E-cigarettes.*                                                                                                                                                                                                                 |    |
|                       | \_CURECI1 is derived from ECIGNOW1.                                                                                                                                               | +-------+----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+    |
|                       |                                                                                                                                                                                   | | **2** | Current E-cigarette user         | *Respondents who reported having used E-cigarettes in their lifetime and currently use E-cigarettes.*                                                                                                                                                                                                                                                                                             |    |
|                       |                                                                                                                                                                                   | +-------+----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+    |
|                       |                                                                                                                                                                                   | | **9** | Don't know/Refused/Missing       | *Respondents who reported they did not know if they had used E-cigarettes in their lifetime, those who refused to answer if they had used E-cigarettes in their lifetime, those who didn't know if they now used E-cigarettes every day, some days or not at all, those who refused to answer if they now used E-cigarettes every day, some days or not at all, or those with missing responses.* |    |
|                       |                                                                                                                                                                                   | +-------+----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+    |
+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
