---
title: "COVID-19 Outcomes After mRNA SARS-CoV-2 Vaccination"
author: "Sameh Saleh"
output: 
  prettydoc::html_pretty:
    toc: true
    theme: cayman 
    highlight: default
    number_sections: TRUE
editor_options: 
  chunk_output_type: inline
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  


# Overview
<!--Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.-->

Breakthrough COVID-19 infections in fully vaccinated individuals have been reported. The objective of this project is to assess clinical outcomes including 30-day emergency department (ED) visits, hospitalizations, intensive care unit (ICU) stays, and death in fully vaccinated (BNT162b2 or mRNA-1273) patients with subsequent breakthrough SARS-CoV-2 infection and compare them to unvaccinated individuals with SARS-CoV-2 infection. I will be using the Optum de-identified COVID-19 Electronic Health Record (EHR) dataset which captures data for approximately 7 million patients across 700 hospitals and 7,000 clinics that have been tested for (positive or negative) or diagnosed with COVID-19.

Please find my Github Repository for the final project [here](https://github.com/ssaleh2/BMIN503_Final_Project).


# Introduction 
<!--Describe the problem addressed, its significance, and some background to motivate the problem.-->

With the continued global spread of the COVID-19 pandemic, the morbidity and mortality attributed to the Severe Acute Respiratory Syndrome Coronavirus 2 (SARS-CoV-2) virus have been devastating. There were nearly 250 million cases and over 5 million deaths (reported case fatality rate of 2.0%) globally as of November 5, 2021 (1). Despite an early start at vaccination, the United States has been disproportionately affected with approximately 18.6% of cases and 15.0% of all deaths worldwide despite only representing 4.3% of the world’s population by the same date. Large-scale deployment of the SARS-CoV-2 vaccines is crucial to curtail further spread of the virus and its more dangerous variants (2). The three vaccines currently approved for administration in the US (Pfizer’s BNT162b2, Moderna’s mRNA-1273, and Johnson and Johnson’s Ad26.COV2.S) have shown high efficacy in preventing severe COVID-19, including hospitalizations, and intensive care unit (ICU) utilization in randomized control trials (3,4). However, trials were limited in their ability to separately compare categories of severe outcomes as these were often combined due to the size of trials and the rarity of outcomes. 

Since then, with the wide scale distribution and administration of vaccines, there have been reports of breakthrough COVID-19 in fully vaccinated individuals (4–7). In May 2021, the CDC reported more than 10,000 cases of breakthrough infections after at least one dose of vaccine. Infections were predominately in females (63%) with 10% of patients requiring hospitalization and 2% dying (5). In June 2021, the CDC redefined definitions of breakthrough infection to include only people who developed COVID-19 ≥14 days after the completion of all recommended doses. This reduced the number of reported breakthrough infections to 4,115 with 608 (15%) deaths related to COVID-19 (7). A recent study from Israel comparing the effectiveness of the BNT162b2 vaccine in individuals 14 to 20 days after vaccination demonstrated an estimated 72% (95% CI, 19 to 100) effectiveness preventing death from COVID-19 (8). Estimating the number of breakthrough infections, severity of outcomes, and the identification of patients at risk for developing breakthrough infections is crucial to the development of preventive strategies. In this study, I determined the rate of clinical outcomes in patients that have been fully vaccinated with BNT162b2 or mRNA-1273 compared to unvaccinated individuals using a US database of individuals evaluated for SARS-CoV-2 infection. Due to the nature of our data source, I was able to explore factors associated with emergency department (ED) visits, hospitalization, ICU use, and death. 

This project requires a multidisciplinary approach as it integrates public health and infectious disease and requires data science, epidemiology, and statistics insights for study design and to arrive at the final conclusions. 

# Methods
<!--Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.-->

## Data Source

The Optum® de-identified COVID-19 Electronic Health Record (EHR) dataset was used for analysis. The dataset is a national low-latency data pipeline that leverages EHR data generated by providers across the continuum of care, including acute inpatient stays and outpatient visits. Optum’s COVID-19-specific database captures approximately 6 million patients to date sourced from Optum’s longitudinal EHR repository, which is derived from dozens of healthcare provider organizations in the United States, including more than 700 hospitals and 7,000 clinics. The data are certified as de-identified by an independent statistical expert following HIPAA statistical de-identification rules and managed according to Optum® customer data use agreements. The COVID-19 dataset incorporates a wide swath of raw clinical data, including new, unmapped COVID-specific clinical data points from both inpatient and ambulatory EHRs, practice management systems, and numerous other internal systems. The COVID-19 data capture point of care diagnostics specific to the COVID-19 patient during initial presentation, acute illness, and convalescence, with over 500 mapped labs and bedside observations, including COVID-19 specific testing.

The Optum® COVID-19 data elements include demographics, encounter information, laboratory results, vital signs and measurements, diagnoses, procedures, and information derived from unstructured clinical notes using natural language processing. The data are comprised of multiple tables linked by a common patient identifier (anonymous, randomized string of characters). The COVID-19 EHR database includes patients who have a documented clinical care encounter as early as January 2007 through the most current monthly data release (latest data released through September 16, 2021) with a documented diagnosis of COVID-19 after February 1, 2020, or documented SARS-CoV-2 polymerase chain reaction (PCR) or antigen testing result. All vaccination and outcome data were sourced from EHRs that informed this database. 

## Methodological Approach

An EHR-based retrospective cohort study of adult patients with or without COVID-19 vaccination who were diagnosed with SARS-CoV-2 infection for the first time between December 11th, 2020, and August 16th, 2021 (which was chosen as the cutoff date to allow for a 30-day follow-up period after infection since September 16, 2021 was the final date of the current database update). A case of SARS-CoV-2 infection was defined as on the first instance of a COVID-19-specific ICD-10 diagnosis or the first positive SARS-CoV-2 PCR or antigen test for a patient. The first administration date of a COVID-19 vaccine was defined as the date of the first dose and the second administration date (if one existed) of a COVID-19 vaccine ≥14 days from the first dose for a given patient as the date of the second dose. To avoid including vaccine trial doses (and thereby, possible placebo doses), only vaccinations on or after December 10, 2020 (date of FDA's first Emergency Use Authorization in the United States). Only patient's that received either BNT162b2 (Pfizer) or mRNA-1273 (Moderna) were included in the study. 

Patients were categorized into two groups. Group 1 included patients who were diagnosed with SARS-CoV-2 infection ≥14 days after the second dose of vaccination and were considered fully vaccinated per CDC definition(7). Group 2 included patients who had SARS-CoV-2 infection but did not receive any vaccination prior to infection or within 3 months from infection. The main outcome of interest was all-cause mortality within 30 days from documented infection. Secondary outcomes included all-cause emergency department visits, hospitalizations, and intensive care unit stays within 30 days from documented infection. Statistical approach is discussed with each code block. 

I'll load in all the necessary libraries first.
```{r, eval = TRUE, message = FALSE}

library(tidyverse)
library(dplyr)
library(ggplot2)

library(logistf)
library(caTools)
library(stringr)
library(lubridate) #for dates
library(glue) #for string formatting
library(gtsummary) # for nice tables
library(data.table)
library(reshape2)
library(RPostgres) #for connected to PostgreSQL database
library(DBI)
library(mltools)
library(gridExtra)
library(jtools) #for nice table model output
library(incidence)

```

First, I established a connection to the PostgreSQL database.

```{r, eval = TRUE, message = FALSE}

con<-dbConnect(RPostgres::Postgres(), 
               dbname = 'coviddb',
               host = 'greenplum01.corral.tacc.utexas.edu',
               port = 5432,
               user = 'ssaleh2',
               password = rstudioapi::askForPassword("Database password"))
```

I started by getting an overview of demographics within the database stratified by vaccination status (i.e., received at least one vaccine). 
```{r, eval = TRUE, message = FALSE}
pt = dbGetQuery(con, "SELECT pt.ptid, pt.gender, pt.birth_yr, pt.race, pt.ethnicity, pt.region, pt.deceased_indicator, pt.date_of_death, vacc.first_dose_date FROM opt_20210916.pt LEFT JOIN g823429.sns_cov_vacc_by_pt_0916 vacc ON vacc.ptid = pt.ptid")

pt %>%
  dplyr::mutate(vacc_flag =  ifelse(is.na(first_dose_date), 'Not Vaccinated', 'Vaccinated')) %>%
  dplyr::mutate(age = ifelse(birth_yr == '1932 and Earlier', 89, 2021 - as.integer(birth_yr))) %>%
  dplyr::mutate(age = ifelse(deceased_indicator == "0", age, as.integer(substr(date_of_death, 1, 4)) - as.integer(birth_yr))) %>%
  dplyr::select(c(age, gender, race, ethnicity, region, vacc_flag)) %>%
  tbl_summary(by = vacc_flag,
    statistic = list(all_continuous() ~ "{mean} ({sd})",
              all_categorical() ~ "{n} / {N} ({p}%)"),
              digits = all_continuous() ~ 2,
              # label = vacc_flag ~ 'Vaccination Status',
              missing_text = "(Missing)") %>%
  add_overall() %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Database Patient Characteristics by Vaccination Status**") %>%
  modify_footnote(
    update = all_stat_cols() ~ "Vaccinated group represents all those that have received at least a dose of any COVID-19 vaccination"
  ) %>%
  bold_labels()

```

Next, I defined the groups and evaluated the incidence of vaccinations and COVID-19 cases over time. The pattern follows expected changes over time when comparing to the Johns Hopkins COVID-19 Dashboard that was previously cited.

```{r, eval = TRUE, message = FALSE}

# Group 2 - Excluding those that were vaccinated within 3 months of COVID+ date.
sql <- 'SELECT * FROM g823429.sns_proj2_coh2_0916 coh WHERE coh.covid_pos_date > \'2020-12-10\';'
coh2 <- dbGetQuery(con, sql) 

coh2 <- coh2 %>% 
  dplyr::filter(is.na(coh2$first_imm_date) | (coh2$first_imm_date > coh2$covid_pos_date + days(90))) %>%
  dplyr::mutate(cohort = 'Unvaccinated')

#Group 1 are those that have received both vaccinations and were infected after 14 days from second dose (considered fully vaccinated)
sql = 'SELECT * FROM g823429.sns_proj2_coh1_0916;'
coh1 <- dbGetQuery(con, sql)

coh1 <- coh1 %>%
  dplyr::filter(days_second_imm_to_infxn > 14) %>%
  dplyr::mutate(cohort = 'Fully Vaccinated')

#Bind together groups into one dataframe
all_cohorts <- dplyr::bind_rows(coh1, coh2)
all_cohorts$cohort = factor(all_cohorts$cohort)

#Get quick counts of groups
table(all_cohorts$cohort)

#Visualize the number of infections over time by day
covid_by_week <- incidence::incidence(all_cohorts$covid_pos_date, interval = 7, groups = c(all_cohorts$cohort))
first_vacc_by_week <- incidence::incidence(all_cohorts$first_imm_date, interval = 7)

str(all_cohorts$cohort)

plot(covid_by_week, border = 'grey') +
  labs(title="Incident COVID-19 per Week by Vaccination Group",x="Week", y = "Weekly incidence")+
 theme_classic()

plot(first_vacc_by_week, color = 'light blue') +
  labs(title="First Dose of Vaccination per Week",x="Week", y = "Weekly incidence")+
  theme_classic()
```
# Results
<!--Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.-->

## Variable Summary Statistics

I started by getting demographics, explored the data visually, and then created the table summary of the demographics stratified by vaccination status. Patients are older in the vaccinated group and are proportionally more female gender. The percentage of patients of Asian race was higher in vaccinated groups than in the unvaccinated group, but the percentage of patients of Black race was lower. Compared to the unvaccinated group, the vaccinated groups also had proportionally more patients in the West and fewer patients in the South. 

```{r, eval = TRUE, message = FALSE}

# Query for getting dems
dem_query <- "SELECT coh.ptid, p.birth_yr, p.gender, p.race, p.ethnicity, p.region 
FROM g823429.sns_proj2_cohall_0916 coh 
LEFT OUTER JOIN opt_20210916.pt p
on coh.ptid = p.ptid
where coh.covid_pos_date > \'2020-12-10\'"

dems <- dbGetQuery(con, dem_query)

#Join with all groups and get age and month of infection
dems <- all_cohorts %>%
  select(c(ptid,cohort,covid_pos_date)) %>%
  dplyr::inner_join(dems, by='ptid') %>%
  dplyr::mutate(age = ifelse(birth_yr == '1932 and Earlier', 89, 2021 - as.integer(birth_yr))) %>%
  dplyr::mutate(month_infxn = lubridate::month(covid_pos_date,label = TRUE))

#Violin plot for age
dems %>%
  ggplot(aes(x=cohort, y=age)) + 
  geom_violin(trim=FALSE, fill="light blue") +
  labs(title="Age by Vaccination Group",x="Vaccination Group", y = "Age")+
  geom_boxplot(width=0.1) + 
  theme_classic()

# #Bar graphs for categorical variables
# dems %>%
# ggplot(aes(x=gender, group = cohort)) +
#   geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") + 
#   labs(y = "Percent", fill = 'Gender') + 
#   geom_text(aes( label = scales::percent(..prop..),
#                    y= ..prop.. ), stat= "count", vjust = -.5) +
#   facet_grid(~cohort) +
#   scale_y_continuous(labels = scales::percent) +
#   theme_classic()

#Bar graphs for categorical variables
dems %>%
ggplot(aes(x=cohort, fill = gender)) +
  geom_bar(position='dodge') + 
  labs(title="Gender by Vaccination Group",x="Vaccination Group", y = "Gender") + 
  theme_classic()

dems %>%
ggplot(aes(x=cohort, fill = region)) +
  geom_bar(position='dodge') + 
  labs(title="Region by Vaccination Group",x="Vaccination Group", y = "Region") + 
  theme_classic()

dems %>%
ggplot(aes(x=cohort, fill = race)) +
  geom_bar(position='dodge') + 
  labs(title="Race by Vaccination Group",x="Vaccination Group", y = "Race") + 
  theme_classic()

dems %>%
ggplot(aes(x=cohort, fill = ethnicity)) +
  geom_bar(position='dodge') + 
  labs(title="Ethnicity by Vaccination Group",x="Vaccination Group", y = "Ethnicity") + 
  theme_classic()

#Create table for gender, race, ethnicity, and region, and month of infection and stratify by vaccination status
dems %>% 
  select(cohort, age, gender, race, ethnicity, region, month_infxn) %>%
  tbl_summary(by = cohort, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
              all_categorical() ~ "{n} / {N} ({p}%)"),
              digits = all_continuous() ~ 2,
              label = list(cohort ~ 'Group', month_infxn ~ "Month of infection"),
              missing_text = "(Missing)") %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 1. Patient Characteristics**") %>%
  bold_labels()
```

I used the same approach for the insurance status. Unvaccinated patients had a higher percentage of Uninsured and Medicaid status and a lower percentage of Medicare status compared to the vaccinated group.

```{r, eval = TRUE, message = FALSE}

# Query for getting insurances in last 6 months or within 1 month after infection
ins_query = "SELECT coh.ptid, i.ins_type
FROM g823429.sns_proj2_cohall_0916 coh
LEFT OUTER JOIN opt_20210916.ins i
ON coh.ptid = i.ptid
WHERE i.insurance_date >= coh.covid_pos_date - INTERVAL \'180 days\' AND
    i.insurance_date <= coh.covid_pos_date + INTERVAL \'30 days\' AND
    coh.covid_pos_date > '2020-12-10'
"

ins <- dbGetQuery(con, ins_query) %>%
  distinct() %>% #remove duplicates
  filter(ins_type != 'Unknown') #remove unknown

#Join with all groups
ins <- all_cohorts %>%
  select(c('ptid','cohort')) %>%
  dplyr::left_join(ins, by='ptid') 

#Bar graph for insurances
ins %>%
ggplot(aes(x=cohort, fill = ins_type)) +
  geom_bar(position='dodge') + 
  labs(title="Insurance Type by Vaccination Group",x="Vaccination Group", y = "Insurance") + 
  theme_classic()

#Pivot wider to keep one row per patient
ins <- ins %>%
  mutate(flag = 1) %>% #adds flag of 1 to each row
  pivot_wider(names_from = ins_type, values_from = flag, values_fill = 0) %>% #pivots to wide view with column for each insurance type (note that patient can have multiple valid insurance types at same time)
  rename(Unknown = 'NA')

ins %>%
  select(-ptid) %>%
  tbl_summary(by = cohort, 
              statistic = list(all_continuous() ~ "{mean} ({sd})",
              all_categorical() ~ "{n} / {N} ({p}%)"),
              digits = all_continuous() ~ 2,
              label = cohort ~ 'Group',
              missing_text = "(Missing)") %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 2. Patient Insurance**") %>%
  bold_labels()

```
Next, I explored the comorbidity data. The vaccinated group had a higher percentage of all comorbidites with the largest percentage difference in conditions that are thought to cause an immunosupressed state.

```{r eval=TRUE, message=FALSE, fig.height=5}

# Query for getting charlson comorbidity index scores 
cci_query = "SELECT coh.ptid, cci_score
FROM g823429.sns_proj2_cohall_0916 coh
left outer join g823429.sns_charlson_scores_0916 score on score.ptid=coh.ptid"

comorbidity_scores <- dbGetQuery(con, cci_query) %>%
  dplyr::distinct() #remove duplicates

#Join with all groups. Those that did not have a CCI score were given a score of 0
comorbidity_scores <- all_cohorts %>%
  select(ptid, cohort) %>%
  dplyr::left_join(comorbidity_scores, by = 'ptid') %>%
  dplyr::mutate(cci_score = replace_na(cci_score, 0))
  
comorbidity_scores$cci_score <- replace_na(comorbidity_scores$cci_score, 0)
comorbidity_scores$cci_score <- as.integer(comorbidity_scores$cci_score)

#Violin plot for those that have at least one comorbidity
comorbidity_scores %>%
  dplyr::filter(cci_score >0) %>%
  ggplot(aes(x=cohort, y=cci_score)) + 
  geom_violin(trim=FALSE, fill="light blue") +
  labs(title="Charlson Comorbidity Index (CCI) by Vaccination Group",x="Vaccination Group", y = "CCI")+
  geom_boxplot(width=0.1) + 
  theme_classic()

# Query for getting particular comorbidities
cci_query_2 = "SELECT coh.ptid, dis.comorbidities
FROM g823429.sns_proj2_cohall_0916 coh
LEFT OUTER JOIN g823429.sns_charlson_icd_codes_0916 dis
ON coh.ptid = dis.ptid" 

comorbidites <- dbGetQuery(con, cci_query_2) %>%
  dplyr::distinct() #remove duplicates

#Convert from long to wide format to maintain granularity of patient
comorbidites <- all_cohorts %>%
  select(ptid, cohort) %>%
  dplyr::left_join(comorbidites, by='ptid') %>%
  mutate(flag = 1)

comorbidites %>%
ggplot(aes(x = cohort, fill = comorbidities)) +
  geom_bar(position='dodge') + 
  coord_flip() + 
  labs(title="Comorbidites Type by Vaccination Group",x="Vaccination Group", y = "Comorbidities") + 
  theme_classic() +
  theme(legend.position = "bottom", legend.text=element_text(size=6)) +
  guides(fill=guide_legend(nrow=6,byrow=TRUE))
  

comorbidites <- comorbidites %>%
  pivot_wider(names_from = comorbidities, values_from = flag, values_fill = 0) %>%
  rename('No Known Comorbidities' = 'NA')


comorbidites %>%
  select(-ptid) %>%
  # select(cohort, comorbidities) %>%
  tbl_summary(by = cohort,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
              all_categorical() ~ "{n} / {N} ({p}%)"),
              digits = all_continuous() ~ 2,
              label = cohort ~ 'Group',
              missing_text = "(Missing)") %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 3. Patient Comorbidities**") %>%
  bold_labels()

```
Lastly, I queried for the outcomes, explored the data visually, and then created the table summary of the outcomes stratified by vaccination status. Note that all outcomes include corresponding dates except death which is only recorded by month. I also explored the incidence of outcomes over time by week or month as appropriate. The vaccinated group had lower proportion of all outcomes compared to the unvaccinated group.

```{r, eval = TRUE, message = FALSE}

# Query for getting ED outcomes
emer_query = "SELECT coh.ptid, coh.covid_pos_date, e.interaction_date, 
e.interaction_date - coh.covid_pos_date AS timeelapsed
FROM g823429.sns_proj2_cohall_0916 coh
LEFT OUTER JOIN opt_20210916.enc e
ON coh.ptid = e.ptid
WHERE 
	e.interaction_date >= coh.covid_pos_date AND
	e.interaction_date <= coh.covid_pos_date + INTERVAL \'30 days\' AND
	e.interaction_type = 'Emergency patient' AND
    coh.covid_pos_date > \'2020-12-10\'"

emer <- dbGetQuery(con, emer_query)

#Join with all cohorts
emer <- all_cohorts %>%
  select(c(ptid,cohort,covid_pos_date)) %>%
  dplyr::inner_join(emer, by='ptid') %>%
  dplyr::mutate(emer_flag = 1) %>%
  dplyr::group_by(ptid) %>%
  dplyr::summarise(ED_count = n(),
                   cohort = first(cohort),
                   emer_flag = first(emer_flag),
                   time_to_ED = median(timeelapsed, na.rm = TRUE))

# Query for getting hospitalization outcomes
hosp_query = "SELECT coh.ptid, coh.covid_pos_date, v.visit_start_date, v.visit_end_date, 
v.visit_end_date - v.visit_start_date AS LOS, v.visit_start_date - coh.covid_pos_date AS timeelapsed
FROM g823429.sns_proj2_cohall_0916 coh
LEFT OUTER JOIN opt_20210916.vis v
ON coh.ptid = v.ptid
WHERE 
	v.visit_start_date >= coh.covid_pos_date AND
	v.visit_start_date <= coh.covid_pos_date + INTERVAL \'30 days\' AND
	(v.visit_type = 'Inpatient') AND-- OR v.visit_type = 'Observation patient') AND
    coh.covid_pos_date > \'2020-12-10\'"

hosp <- dbGetQuery(con, hosp_query)

#Join with all cohorts
hosp <- all_cohorts %>%
  select(c(ptid,cohort,covid_pos_date)) %>%
  dplyr::inner_join(hosp, by='ptid') %>%
  mutate(hosp_flag = 1)

#Get incident hospitalizations per week
hosp_by_week <- incidence::incidence(hosp$visit_start_date, interval = 7, groups = c(hosp$cohort))

#Visualize hospitalizations over time stratified by Vaccination Status
plot(hosp_by_week, border = 'grey') +
  labs(title="Incident COVID-19 Hospitalizations per Week by Vaccination Group",x="Week", y = "Weekly Incidence")+
 theme_classic()

#Violin + box plot for length of stay
hosp %>%
  ggplot(aes(x=cohort, y=los)) + 
  geom_violin(trim=FALSE, fill="beige") +
  labs(title="Length of Stay (LOS) by Vaccination Group",x="Vaccination Group", y = "LOS (days)")+
  geom_boxplot(width=0.1) + 
  theme_classic()

hosp <- hosp %>%
  dplyr::group_by(ptid) %>%
  dplyr::summarise(hosp_count = n(),
                   cohort = first(cohort),
                   hosp_flag = first(hosp_flag),
                   time_to_hosp = median(timeelapsed, na.rm = TRUE),
                    los = median(los, na.rm = TRUE))

# Query for getting ICU outcomes
icu_query = "SELECT coh.ptid, coh.covid_pos_date, c.carearea_date, 
c.carearea_date - coh.covid_pos_date AS timeelapsed
FROM g823429.sns_proj2_cohall_0916 coh
JOIN opt_20210916.carearea c
ON coh.ptid = c.ptid
WHERE 
	c.carearea_date >= coh.covid_pos_date AND
	c.carearea_date <= coh.covid_pos_date + INTERVAL \'30 days\' AND
	c.carearea = \'CRITICAL CARE UNIT (CCU) / INTENSIVE CARE UNIT (ICU)\' AND
    coh.covid_pos_date > \'2020-12-10\'"

icu <- dbGetQuery(con, icu_query)

icu <- all_cohorts %>%
  select(c(ptid,cohort,covid_pos_date)) %>%
  dplyr::inner_join(icu, by='ptid') %>%
  mutate(icu_flag = 1)

#Get incident ICU stays per week
icu_by_week <- incidence::incidence(icu$carearea_date, interval = 7, groups = c(icu$cohort))

#Visualize ICU stays over time stratified by Vaccination Status
plot(icu_by_week, border = 'grey') +
  labs(title="Incident COVID-19 ICU Stays per Week by Vaccination Group",x="Week", y = "Weekly Incidence")+
 theme_classic()

icu <- icu %>%
  dplyr::group_by(ptid) %>%
  dplyr::summarise(icu_count = n(),
                   cohort = first(cohort),
                   icu_flag = first(icu_flag),
                   time_to_icu = median(timeelapsed, na.rm = TRUE))

# Query for getting death outcomes
death_query="SELECT 
    CASE
		WHEN (deathInfo.time_to_death > 15 AND deathInfo.time_to_death <= 30) THEN 'After'
		WHEN (deathInfo.time_to_death >= -31 AND deathInfo.time_to_death <= 15) THEN 'Before' -- -31 b/c rounding with death date (may still be same month)
		ELSE NULL
	END AS est_time_elapsed, *
	FROM (
		SELECT coh.ptid AS ptid, coh.covid_pos_date,
			TO_DATE(p.date_of_death, \'YYYYMM\') AS death_date, 
			(TO_DATE(p.date_of_death, \'YYYYMM\') - coh.covid_pos_date ) AS time_To_death
			--*
		FROM g823429.sns_proj2_cohall_0916 coh
		JOIN opt_20210916.pt p
		ON coh.ptid = p.ptid
		WHERE
			p.date_of_death IS NOT NULL AND
            coh.covid_pos_date > \'2020-12-10\'
	) AS deathInfo"

death <- dbGetQuery(con, death_query)

#Join with all cohorts
death <- all_cohorts %>%
  select(c(ptid,cohort,covid_pos_date)) %>%
  dplyr::inner_join(death, by='ptid') %>%
  dplyr::filter(!is.na(est_time_elapsed)) %>%
  mutate(death_flag = 1)

#Get deaths per week
deaths_by_week <- incidence::incidence(death$death_date, interval = "1 month", groups = c(death$cohort))

#Visualize deaths over time stratified by Vaccination Status. Grouped by month since exact day of death is not available. Only the month.
plot(deaths_by_week, border = 'grey') +
  labs(title="COVID-19 Deaths per Month by Vaccination Group",x="Month", y = "Monthly Count")+
 theme_classic()

#Bring together as one outcome dataframe
outcomes <- all_cohorts %>%
  select(c(ptid, covid_pos_date, cohort, days_first_imm_to_infxn, days_second_imm_to_infxn)) %>%
  dplyr::left_join(death %>% select(c(ptid, death_flag)), by='ptid') %>%
  dplyr::left_join(icu %>% select(c(ptid, time_to_icu, icu_flag)), by='ptid') %>%
  dplyr::left_join(hosp %>% select(c(ptid, time_to_hosp, los, hosp_flag)), by='ptid') %>%
  dplyr::left_join(emer %>% select(c(ptid, time_to_ED, emer_flag)), by='ptid') %>%
  dplyr::mutate(death_flag = replace_na(death_flag, 0)) %>%
  dplyr::mutate(icu_flag = replace_na(icu_flag, 0)) %>%
  dplyr::mutate(hosp_flag = replace_na(hosp_flag, 0)) %>%
  dplyr::mutate(emer_flag = replace_na(emer_flag, 0))
  
outcomes %>%
  select(-c(ptid, covid_pos_date, time_to_ED, time_to_hosp, time_to_icu)) %>%
  tbl_summary(by = cohort,
              statistic = list(all_continuous() ~ "{median} ({p25}, {p75})",
              all_categorical() ~ "{n} / {N} ({p}%)"),
              digits = all_continuous() ~ 2,
              label = list(cohort ~ 'Cohort', emer_flag ~ 'Emergency Visit', hosp_flag ~ 'Hospitalization', los ~ 'Hospital length of stay', icu_flag ~ 'ICU Stay', death_flag ~ 'Death'),
              missing = 'no') %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 4. Patient Outcomes**") %>%
  bold_labels() 

```
I'll then create the final dataframe for modeling including consolidating certain categories, dropping some rows, converting categorical variables to factors and finally proceeding with one hot encoding.

```{r, eval = TRUE, message = FALSE}

#Combine race and ethnicity to reduce number of variables/predictors 
combine_race_ethnicity <- function(row){
    if (row['race'] == 'African American'){
        return('African American')}
    else if (row['race'] == 'Caucasian' & row['ethnicity'] == 'Not Hispanic'){
        return('Non-Hispanic White')}
    else if (row['race'] == 'Caucasian' & row['ethnicity'] == 'Hispanic'){
        return('Hispanic')}
    else if (row['race'] == 'Asian'){
        return('Asian')}
    else{
        return('Other')}}

dems$race_ethnicity <- apply(dems, 1, combine_race_ethnicity)

#Filter out Unknown gender due to volume
dems <- dems %>% dplyr::filter(gender != 'Unknown')

#Combine Medicare and Medicaid as well as Unknown an Uninsured as Other to reduce number of variables/predictors 
ins$Medicare_Medicaid <- ifelse((ins$Medicaid==1 | ins$Medicare==1), 1 , 0)
ins$Other <- ifelse((ins$Unknown==1 | ins$Uninsured==1), 1 , 0)

#Create final DF
final_df <- dems %>%
  dplyr::select(c(ptid, cohort, age, gender, region, race_ethnicity, age, month_infxn)) %>%
  left_join(ins %>% select(c(ptid, Commercial, Medicare_Medicaid, Other)), by = 'ptid') %>%
  left_join(comorbidity_scores %>% select(c(ptid, cci_score)), by = 'ptid') %>%
  left_join(outcomes %>% select(c(ptid, emer_flag, hosp_flag, icu_flag, death_flag)), by ='ptid') %>%
  mutate(gender = factor(gender)) %>%
  mutate(region = factor(region)) %>%
  mutate(race_ethnicity = factor(race_ethnicity)) %>%
  mutate(cohort = factor(cohort))
  
#Rename some columns for clarity and ease of access of columns moving forward for modeling
model_df <- model_df %>%
  rename(region_Other = 'region_Other/Unknown') %>%
  rename(Ins_Other = 'Other') %>%
  rename(race_ethnicity_African_American = 'race_ethnicity_African American')

#Add month of infection
# model_df <- model_df %>%
#   inner_join(dems %>% select(c(ptid, month_infxn)), by='ptid')

#Consolidate months into 3 time periods to reduce number of variables/predictors 
consolidate_months_to_periods <- function(row){
    if (row['month_infxn'] %in% c('Dec', 'Jan', 'Feb')){
        return('Winter')}
    else if (row['month_infxn'] %in% c('Mar','Apr', 'May')){
        return('Spring')}
    else{
        return('Summer')}}

model_df$time_period <- apply(model_df, 1, consolidate_months_to_periods)

#Change to factor
model_df$time_period <-factor(model_df$time_period)

#One hot encoding for categorical variables
model_df <- one_hot(as.data.table(final_df))


```

I saved the model dataframe for easier future access, but it is commented out for the final version. Lastly, I drop reference columns for the regression analysis. This could have been done with the regression itself as well. 

```{r, eval = TRUE, message = FALSE}
#Save model DF for quick access later
# saveRDS(model_df, file ="model_df.Rda")
# #Read model DF 
# model_df <- readRDS(file = "model_df.Rda")

#Drop reference columns
model_df_final <- model_df %>% select(c(death_flag, icu_flag, hosp_flag, emer_flag, cohort_1a, cohort_1b, cohort_1c, age, gender_Female, cci_score, time_period_Spring, time_period_Summer, region_Northeast, region_Other, region_South, region_West, race_ethnicity_African_American, race_ethnicity_Asian, race_ethnicity_Hispanic, race_ethnicity_Other, Medicare_Medicaid, Ins_Other))

```

As a visual check for colinearilty, I add a heat map for the corelation matrix among the different outcomes and predictors. Overall, most variables are not colinear. Those that have some degree of positively correlated relationships are expected like age with the Charlson Comorbidity Index or Medicare/Medicaid status. As expected, the primary and secondary outcomes also have correlated relationships.

```{r, eval = TRUE, message = FALSE, fig.width=8,fig.height=8}
cormat <- cor(model_df)
get_upper_tri <- function(cormat){
    cormat[lower.tri(cormat)]<- NA
    return(cormat)
 }
 
upper_tri <- get_upper_tri(cormat)

melted_cormat <- melt(upper_tri, na.rm = TRUE)

# Heatmap
ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 1),
  legend.position = "bottom",
  legend.title=element_text(size=12),
  legend.text=element_text(size=12),
  legend.direction = "horizontal",
  axis.text.y = element_text(size = 12), 
  axis.text.x = element_text(angle = 45, vjust = 1, size = 12, 
    hjust = 1))+
 coord_fixed()
```



```{r, eval = TRUE, message = FALSE}
start_time <- Sys.time()
# Run logistic model for death
lf_death <- logistf(formula = death_flag ~ cohort_1a + cohort_1b + cohort_1c + age + gender_Female + cci_score + time_period_Spring + time_period_Summer + region_Northeast + region_Other + region_South + region_West + race_ethnicity_African_American + race_ethnicity_Asian + race_ethnicity_Hispanic + race_ethnicity_Other + Medicare_Medicaid + Ins_Other, data=model_df)#, plconf = c(2,3,4))
end_time <- Sys.time()
end_time - start_time

summary(lf_death)

death_or <- exp(cbind(Odds=coef(lf_death), confint(lf_death)))

death_or

```

```{r, eval = TRUE, message = FALSE}
start_time <- Sys.time()

# Run logistic model for ICU
lf_icu <- logistf(formula = icu_flag ~ age + gender_Female + cci_score + cohort_1a + cohort_1b + cohort_1c + time_period_Spring + time_period_Summer + region_Northeast + region_Other + region_South + region_West + race_ethnicity_African_American + race_ethnicity_Asian + race_ethnicity_Hispanic + race_ethnicity_Other + Medicare_Medicaid + Ins_Other, data=model_df)
end_time <- Sys.time()
end_time - start_time

summary(lf_icu)

icu_or <- exp(cbind(Odds=coef(lf_icu), confint(lf_icu)))

icu_or

summ(lf_icu,confint = TRUE, digits = 3, vifs = TRUE) 

```

```{r, eval = TRUE, message = FALSE}
start_time <- Sys.time()

# Run logistic model for hospitalizations
lf_hosp <- logistf(formula = hosp_flag ~ age + gender_Female + cci_score + cohort_1a + cohort_1b + cohort_1c + time_period_Spring + time_period_Summer + region_Northeast + region_Other + region_South + region_West + race_ethnicity_African_American + race_ethnicity_Asian + race_ethnicity_Hispanic + race_ethnicity_Other + Medicare_Medicaid + Ins_Other, data=model_df)
end_time <- Sys.time()
end_time - start_time

summary(lf_hosp)

hosp_or <- exp(cbind(Odds=coef(lf_hosp), confint(lf_hosp)))

hosp_or
```

```{r, eval = TRUE, message = FALSE}
start_time <- Sys.time()

# Run logistic model for ED visits
lf_ed <- logistf(formula = emer_flag ~ age + gender_Female + cci_score + cohort_1a + cohort_1b + cohort_1c + time_period_Spring + time_period_Summer + region_Northeast + region_Other + region_South + region_West + race_ethnicity_African_American + race_ethnicity_Asian + race_ethnicity_Hispanic + race_ethnicity_Other + Medicare_Medicaid + Ins_Other, data=model_df)
end_time <- Sys.time()
end_time - start_time

summary(lf_ed)

ed_or <- exp(cbind(Odds=coef(lf_ed), confint(lf_ed)))

ed_or

```

```{r, eval = TRUE, message = FALSE}

install.packages('forestplot')
library(forestplot)


hosp_or <- as.data.frame(hosp_or)

hosp_or$Index <- c(seq(1,nrow(hosp_or)))
hosp_or$Labels <- rownames(hosp_or)
hosp_or <- hosp_or %>%
  dplyr::rename(LL = 'Lower 95%', UL = 'Upper 95%')

hosp_or$CI <- paste('(', round(hosp_or$LL, digit = 2), ', ', round(hosp_or$UL, digit=2), ')', sep='')

hosp_OR_limited <- subset(hosp_or, rownames(hosp_or) %in% c('cohort_1a', 'cohort_1b', 'cohort_1c'))

hosp_OR_limited$Index <- c(seq(1, nrow(hosp_OR_limited)))

plot1 <- ggplot(hosp_OR_limited, aes(y = Index, x = Odds)) + 
  geom_point(shape = 18, size = 5) +  
  geom_errorbarh(aes(xmin = LL, xmax = UL), height = 0.25) +
  geom_vline(xintercept = 1, color = "gray", linetype = "dashed", cex = 1, alpha = 0.5) +
  scale_y_continuous(name = "", breaks=1:3, labels = hosp_OR_limited$Labels, trans = "reverse") +
  xlab("Odds Ratio (95% CI)") + 
  ylab(" ") + 
  theme_bw() +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.text.y = element_text(size = 12, colour = "black"),
        axis.text.x.bottom = element_text(size = 12, colour = "black"),
        axis.title.x = element_text(size = 12, colour = "black"))

table_base <- ggplot(hosp_OR_limited, aes(y=Labels)) +
  ylab(NULL) + xlab("  ") + 
  theme(plot.title = element_text(hjust = 0.5, size=12), 
        axis.text.x = element_text(color="white", hjust = -3, size = 25), ## This is used to help with alignment
        axis.line = element_blank(),
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(),
        axis.title.y = element_blank(), 
        legend.position = "none",
        panel.background = element_blank(), 
        panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        plot.background = element_blank())

## OR point estimate table
tab1 <- table_base + 
  labs(title = "space") +
  geom_text(aes(y = rev(Index), x = 1, label = sprintf("%0.2f", round(Odds, digits = 2))), size = 4) + ## decimal places
  ggtitle("OR")

## 95% CI table
tab2 <- table_base +
  geom_text(aes(y = rev(Index), x = 1, label = CI), size = 4) + 
  ggtitle("95% CI")

lay <-  matrix(c(1,1,1,1,1,1,1,1,1,1,2,3,3), nrow = 1)
grid.arrange(plot1, tab1, tab2, layout_matrix = lay)
```

# Conclusions

Limitations: study is looking at outcomes among vaccinated and unvaccinated individuals who tested positive for COVID-19, which may be very different from outcomes among all vaccinated and unvaccinated individuals infected with COVID-19.


# References
1.  Dong E, Du H, Gardner L. An interactive web-based dashboard to track COVID-19 in real time. The Lancet Infectious Diseases. 2020;20(5):533-534. doi:10.1016/S1473-3099(20)30120-1
2. 	Sridhar D, Gurdasani D. Herd immunity by infection is not an option. Science. 2021;371(6526):230-231. doi:10.1126/science.abf7921
3. 	Sadoff J, Gray G, Vandebosch A, et al. Safety and Efficacy of Single-Dose Ad26.COV2.S Vaccine against Covid-19. N Engl J Med. 2021;384(23):2187-2201. doi:10.1056/NEJMoa2101544
4. 	Tenforde MW, Olson SM, Self WH, et al. Effectiveness of Pfizer-BioNTech and Moderna Vaccines Against COVID-19 Among Hospitalized Adults Aged ≥65 Years - United States, January-March 2021. MMWR Morb Mortal Wkly Rep. 2021;70(18):674-679. doi:10.15585/mmwr.mm7018e1
5. 	CDC COVID-19 Vaccine Breakthrough Case Investigations Team, CDC COVID-19 Vaccine Breakthrough Case Investigations Team, Birhane M, et al. COVID-19 Vaccine Breakthrough Infections Reported to CDC — United States, January 1–April 30, 2021. MMWR Morb Mortal Wkly Rep. 2021;70(21):792-793. doi:10.15585/mmwr.mm7021e3
6. 	Keehner J, Horton LE, Pfeffer MA, et al. SARS-CoV-2 Infection after Vaccination in Health Care Workers in California. N Engl J Med. 2021;384(18):1774-1775. doi:10.1056/NEJMc2101927
7. 	COVID-19 Vaccine Breakthrough Case Investigation and Reporting. Centers for Disease Control and Prevention Accessed June 28, 2021. https://www.cdc.gov/vaccines/covid-19/health-departments/breakthrough-cases.html.
8. 	Dagan N, Barda N, Kepten E, et al. BNT162b2 mRNA Covid-19 Vaccine in a Nationwide Mass Vaccination Setting. N Engl J Med. 2021;384(15):1412-1423. doi:10.1056/NEJMoa2101765
