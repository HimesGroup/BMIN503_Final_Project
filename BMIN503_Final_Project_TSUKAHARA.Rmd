---
title: "The Childhood Interstitial Lung Disease (chILD) Registry: A Key Instrument in the Study of Rare Childhood Lung Disease"
author: "Katie Tsukahara"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
bibliography: BMIN503_Final_bib.bib
csl: american-medical-association.csl
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.


>OVERVIEW:<br>Childhood interstitial lung disease (chILD) is a heterogeneous group of rare childhood lung diseases affecting the interstitial region of the lung, leading to abnormal gas exchange and a range of morbidity and mortality. Research and development of therapies is challenging due to the low prevalence and heterogeneity of disease, thus the CHILD Research Network and Registry was established to collect data from multiple centers across the United States. Our goal is to compare patient demographics across subsets of chILD subjects by diagnosis, and to examine the diagnostic and clinical factors that contribute to diagnosis.

Link to my Final Project Repo is [here](https://github.com/ktsukah/BMIN503_Final_Project).

### Introduction 
Childhood interstitial lung disease (chILD) encompasses a variety of lung diseases that manifest via changes to the pulmonary interstitium. The pulmonary interstitium is, simply put, the lung tissue between the airspace and the pulmonary blood vessels, and excludes other lung structures such as the airways. These diseases are grouped together owing to similarities in the area of the lung affected and in clinical presentation. While both children and adults can develop interstitial lung disease (ILD), many causes of chILD are seen only in the pediatric age group. These diseases can be genetic in origin, or associated with abnormal lung development, immunologic dysfunction, rheumatologic disease, or infectious history. Some cases do not have a clear etiology. Certain diagnoses confer a poor prognosis of early lung transplant or mortality. Other diagnoses confer a more positive prognosis, including clinical improvement and resolution of disease over early childhood.
<br><br>To study this group of diseases, the Children’s Interstitial and Diffuse Lung Disease Research Network (ChILDRN) established a national registry in 2016, with participation by 13 sites across the United States. The original registry contains 436 subjects, enrolled from 2016 to 2020, with data on demographics, medical history, diagnostics, management and outcomes. With this project, we aim to examine differences in patient demographics, including age of onset and severity of presentation, among the more common chILD diagnoses. We also aim to examine the diagnostic and clinical factors that contribute to diagnosis, if possible examining the role that different diagnostic tests play in diagnosis and whether invasive testing can be avoided in these patients that are at higher risk for procedures due to their underlying pulmonary disease. The database and this subsequent project use the skills and expertise of clinicians across many fields (Pulmonology, Radiology, Pathology, Rheumatology, and others), clinical researchers, basic science researchers, and biomedical informaticians to collect, manage, and interpret data on this complex group of patients.



### Methods
The Children’s Interstitial and Diffuse Lung Disease Research Network (ChILDRN) established a national registry for chILD under an IRB for a longitudinal observational study with the participation of 13 centers across the United States [@YoungOA3786]. This has since expanded to 20 centers, with over 400 enrolled subjects. The IRB allows for both retrospective enrollment as well as prospective data collect, including clinical characteristics as well as diagnostic testing, longitudinal results, and outcomes such as supplemental oxygen use, mechanical ventilation or death. The data is housed by the REDCap (Research Electronic Data Capture) data platform. [@HARRIS2019103208; @HARRIS2009377] For the purposes of this project, data of interest was filtered using the REDCap Report feature, then de-identified and date-shifted data was exported for analysis, in accordance with the IRB. A CSV file contained the raw data, and the R file contained R code to read in the CSV, and appropriately label columns, data type, and factor levels using the *Hmisc* package. Further data cleaning was performed using the *tidyr* and *dplyr* packages.

```{r, include=TRUE, warning = FALSE, message = FALSE}
# Loading RedCAP data
setwd("C:/Users/tsukaharak/Documents/R files/BMIN503_Final_Project")
source("CHOPChildhoodILDNati-110620BMIN_R_2020-11-27_1739.R", local = knitr::knit_global())

# A cursory check for duplicate entries, showing that all entries have a unique chILD Registry ID
length(data$child_registry_id)
length(unique(data$child_registry_id))

# Copying the data frame to create a working version, so that if going back to the original data is required, 
# it will not require reloading in all of the data
child <- data

```

After loading in the data, basic enrollment demographics were examined. This included center where the child was enrolled, age at enrollment, age at diagnosis, race and ethnicity. Graphics were built using *ggplot2*, *cowplot*, *maps* and *mapproj*.


```{r, echo = FALSE, warning = FALSE, message = FALSE}
# loading libraries for data cleaning and graphics
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)

```

In order to create a visualization of enrollment by center, a new data frame was created with with city and chILD Registry ID prefix corresponding to the enrollment center. Latitude and longitude were retrieved from the us.cities data frame in the *maps* package. Due to two centers being located in New York city boroughs, these coordinates were added manually as they were not included in the us.cities data frame. These were then plotted on a map of the continental United States. These geographic locations are representative only of the location of enrollment. It is not uncommon for children with rare disease to travel to a specialized center for, thus, it is difficult to infer any geographic distribution of the patient's location of residence from these numbers.

```{r, warning = FALSE, message = FALSE, eval = TRUE}
library(maps)
library(mapproj)

DAG.df <- data.frame(
  name = c("Boston MA", "Atlanta GA", "Philadelphia PA", "Cleveland OH", "Queens NY", "Aurora CO", "Indianapolis IN", "Kansas City MO", "Chicago IL", "Ann Arbor MI", "Columbia MO", "Bronx NY", "Portland OR", "Pittsburgh PA", "San Diego CA", "Seattle WA", "Palo Alto CA", "Chapel Hill NC", "Nashville TN", "Saint Louis MO"),
  prefix = c(704,720,712,709,702,703,718,711,717,716,715,708,713,705,706,710,707,719,701,714),
  stringsAsFactors = FALSE
)

DAG.df <- DAG.df %>% 
  arrange(prefix) %>%
  left_join(us.cities, by = "name") %>%
  mutate(prefix = as.character(prefix))

# Latitude and longitude for NY boroughs:
# Queens 40.728, -73.795
# Bronx 40.845, -73.865
DAG.df[which(grepl("Queens",DAG.df$name)), ]$lat <- 40.7282
DAG.df[which(grepl("Queens",DAG.df$name)), ]$long <- -73.7949
DAG.df[which(grepl("Bronx",DAG.df$name)), ]$lat <- 40.8448
DAG.df[which(grepl("Bronx",DAG.df$name)), ]$long <- -73.8648

# Grouping the subjects by enrollment center using the registry ID prefix, then joining with the geographic location data frame 
DAG.child <- child %>%
  select(child_registry_id) %>%
  mutate(prefix = substr(child_registry_id, 0, 3)) %>%
  count(prefix) %>%
  mutate(prefix = as.character(prefix)) %>%
  left_join(DAG.df, by = "prefix")

# Build the map using United States map data from the _maps_ package
USA <- map_data("world") %>% filter(region=="USA")
mybreaks <- c(20,40,60,80,100)
ggplot() +
    geom_polygon(data = USA, aes(x=long, y = lat, group = group), fill="grey", alpha=0.4) +
    geom_point(data = DAG.child, aes(x=long, y=lat, size=n), color = "#2b8cbe", shape=20, stroke=FALSE) +
    scale_size_continuous(name="Number of Enrolled \nSubjects", trans="identity", range=c(0,12), breaks = mybreaks) +
    theme_void() +
    coord_map() + ylim(25,50) + xlim(-130, -60) +
    guides(colour = guide_legend()) +
    ggtitle("Subject Enrollment by Center in the chILD Registry") +
    theme(
      legend.position = c(0.85, 0.15),
      text = element_text(color = "#22211d"),
      plot.title = element_text(size= 16, hjust=0.1, color = "#4e4d47", margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")),
    )

```

This study allowed for retrospective enrollment as well as prospective data collection. Using summary statistics and histograms, the age at enrollment in the Registry and age at diagnosis were examined. When the Registry was first established, it was expected that many subjects would be enrolled retrospectively. 

```{r, warning = FALSE, message = FALSE}
# Age at enrollment
summary(child$age_studyentry)
ggplot(data = child, aes(x = age_studyentry)) + 
  geom_histogram(color = "black", fill = "white", binwidth=3) +
  labs(x = "Age (in months)", title = "Age at Study Entry in the chILD Registry")
# Age at diagnosis
summary(child$age_diagnosis)
ggplot(data = child, aes(x = age_diagnosis)) + 
  geom_histogram(color = "black", fill = "white", binwidth=3) +
  labs(x = "Age (in months)", title = "Age at Diagnosis in the chILD Registry")
```

We were also interested to see if subjects are being enrolled closer to their time of diagnosis now that the Registry is more established. This was plotted as a scatter plot below, and showed that there continues to be a significant amount of retrospective enrollment, with many subjects being enrolled up to several years after their diagnosis. The reasons for this are unclear, and may reflect a growing awareness of the chILD Registry, a move towards providing care for chILD at specialized centers, or the need for further resources devoted to recruitment.

```{r, warning = FALSE, message = FALSE}
time.to.enroll <- child %>% 
  select(age_studyentry, age_diagnosis, cons_date) %>%
  mutate(age.diff = age_studyentry - age_diagnosis)
time.to.enroll <- time.to.enroll %>%
  mutate(cons_date = as.Date(time.to.enroll$cons_date))
ggplot(time.to.enroll, aes(x=cons_date, y=age.diff)) +
  geom_point() +
  ggtitle("Time Intervals between Diagnosis and Enrollment in the chILD Registry") +
  ylab("Time from Diagnosis to Enrollment (in Months)") +
  xlab("Approximate Time of Enrollment (Date-Shifted)") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")

```

Due to how the database was structured regarding race, significant data rearrangement was necessary in order to summarize the data. The database contained 6 race categories, each with a possible yes or no answer. This was synthesized into individual races, "two or more races," "other," or "unknown." 

```{r}
# Race across the registry - rearranging and cleaning data to better summarize racial characteristics
child.race <- child %>%
  select(child_registry_id, race___1:race___6, race___1.factor:race___6.factor, diagnosis.factor)
child.race <- child.race %>%
  mutate(race.sum = rowSums(select(child.race, race___1:race___6), na.rm = TRUE)) %>%
  mutate(race.text = NA)

table(child.race$race.sum)

N = nrow(child.race)
for(i in 1:N){
  if(child.race[i,"race.sum"] == 0){
    child.race[i,"race.text"] <- "Unknown"
  }else if(child.race[i,"race.sum"] == 2){
    child.race[i,"race.text"] <- "Two or more races"
  }else{
    if(child.race[i,"race___1"] == 1){
      child.race[i,"race.text"] <- "White"
    }else if(child.race[i,"race___2"] == 1){
      child.race[i,"race.text"] <- "Black"
    }else if(child.race[i,"race___3"] == 1){
      child.race[i,"race.text"] <- "Asian"
    }else if(child.race[i,"race___4"] == 1){
      child.race[i,"race.text"] <- "Native Hawaiian/Pacific Islander"
    }else if(child.race[i,"race___5"] == 1){
      child.race[i,"race.text"] <- "American Indian or Alaska Native"
    }else if(child.race[i,"race___6"] == 1){
      child.race[i,"race.text"] <- "Other"
    }else{print(i)}
  }
}
child.race <- child.race %>%
  mutate(race.text = factor(race.text, levels = c("White", "Black", "Asian", "Native Hawaiian/Pacific Islander", "American Indian or Alaska Native", "Other", "Two or more races", "Unknown")))
```


Overall demographic and clinical characteristics of the registry are shown below. Further analysis was then performed to compare clinical characteristics across diagnoses. 

```{r, warning = FALSE, message = FALSE}
# Table 1 - summarizing select demographic and clinical characteristics
# Was not able to download ethnicity data, so this is not included. Due to how the data is structured, race is difficult to summarize in this format, so will be summarized below
library(gtsummary)
library(gt)

table.data <- child %>%
  dplyr::select(child_registry_id, age_studyentry, age_diagnosis, patient_gender.factor,  relative_in_registry.factor, fibrosis.factor, airway.factor, home_o2.factor, mech_vent___1.factor, mech_vent___2.factor, transplant_yn.factor) 
levels(table.data$mech_vent___1.factor)=c("No","Yes")
levels(table.data$mech_vent___2.factor)=c("No","Yes")

table.data <- table.data %>%
  rename("Patient Gender" = patient_gender.factor) %>%
  rename("Relative in Registry" = relative_in_registry.factor) %>%
  rename("Pulmonary Fibrosis" = fibrosis.factor) %>%
  rename("Airway Disease" = airway.factor) %>%
  rename("Past or Current Home Supplemental Oxygen" = home_o2.factor) %>%
  rename("Past or Current Noninvasive Ventilation (>3 weeks)" = mech_vent___1.factor) %>%
  rename("Past or Current Invasive Ventilation (>3 weeks)" = mech_vent___2.factor) %>%
  rename("Lung Transplant" = transplant_yn.factor) %>%
  mutate(Death = ifelse(!is.na(child$death_age), "Yes", "No"))

table.data.race <- left_join(table.data, select(child.race, child_registry_id, race.text), by = "child_registry_id") %>%
  relocate(race.text, .after = "Patient Gender") %>%
  rename("Subject race" = race.text)

table.two <- tbl_summary(select(table.data.race, -child_registry_id),  missing = "no") %>%
as_gt() %>%
gt::tab_header("Table 1. Summary of Clinical Characteristics of the Study Cohort") %>%
opt_align_table_header(align = "left") %>%
gt::tab_options(table.font.size = '11px', table_body.hlines.style = "none", data_row.padding = px(1))
table.two

```
### Results
Childhood interstitial lung disease includes a large number of disorders. Often, these children present similarly, with respiratory distress or failure, and failure to thrive (inadequate weight gain). However, different diagnoses confer very different prognoses, thus the workup is critical. After examining overall registry enrollment, I wanted to examine differences in demographics and clinical characteristics across primary diagnoses. The distribution of primary diagnoses is shown below.

```{r, warning = FALSE, message = FALSE}
# Distribution of primary diagnoses
ggplot(data = child, aes(x = diagnosis.factor)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Number of Subjects", title = "Primary Diagnoses in chILD Registry")
```

The overall database showed a small male predominance (56%), which had significant variability across diagnoses.

```{r, warning = FALSE, message = FALSE}
# Analysis of gender across diagnoses - chi square test and visualization
p1chi <- chisq.test(table(child$diagnosis.factor, child$patient_gender.factor))
p1chi

ggplot(data = child, aes(x = diagnosis.factor, fill = patient_gender.factor)) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Proportion of Total", title = "Gender by Diagnosis in chILD Registry", fill = "Gender",subtitle = paste("Chi-squared p value =", format(p1chi$p.value, digits = 3)))

```


The predominant race of the registry is white (72%), which holds true across all diagnoses. This may be related to recruitment bias mores than true differences in disease prevalence, however, for the purposes of this project we do not have a comparison group to assess recruitment. Interestingly, for patients with pulmonary hemorrhage, there appears to be an increase in the proportion of black patients. The reasons for this are unclear.

```{r, echo = TRUE, warning = FALSE, message = FALSE}
# Analysis of race across diagnoses
# Adding the race as factor column if it has not already been added
if(!"race.text" %in% colnames(child)){
child <- left_join(child, select(child.race, child_registry_id, race.text), by = "child_registry_id")
}
head(child$race.text)

ggplot(data = child, aes(x = diagnosis.factor, fill = race.text)) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Proportion of Total", title = "Race by Diagnosis in chILD Registry", fill = "Race")

```



As is known from the literature, certain diagnoses are prevalent at different ages. Disorders of growth or development, neuroendocrine cell hyperplasia of infancy (NEHI), pulmonary interstitial glycogenolysis (PIG), and surfactant dysfunction disorder tend to present early in life, as is shown below.

```{r, echo = TRUE, warning = FALSE, message = FALSE}
# Age across diagnosis
summary(data$age_diagnosis, na.rm = TRUE)

ggplot(data = filter(child, child$diagnosis < 10), aes(x = diagnosis.factor, y = age_diagnosis)) + 
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Age (in Months)", title = "Age at Diagnosis in chILD Registry")

```

After characterizing differences in patient demographics among diagnoses, I was interested in the factors contributing to making the diagnosis. In childhood ILD, once a clinical suspicion is established, the next step is typically chest computed tomography (CT), which provides a much higher level of imaging resolution that chest radiograph (X-ray). From there, flexible bronchoscopy with bronchoalveolar lavage (BAL) is often performed to evaluate for certain disease processes, such as pulmonary hemorrhage or pulmonary alveolar proteinosis, and to rule out other causes. From there, the decision is made to proceed with genetic testing or lung biopsy or both. However, though there are  American Thoracic Society Clinical Practice Guidelines,[@Kurland23905526] this workup is not strictly standardized, and can be affected by many factors, including patient age, disease severity, and available resources.

The graphic below demonstrates which diagnostic modality made the diagnosis. Many patients required multiple diagnostic modalities to obtain the diagnosis, which, as the workup is often a stepwise process, is not surprising. Characteristic chest CT findings have been established for NEHI, which is consistent with the large number of cases the required only chest CT to make the diagnosis. It is interesting that there are also many cases that underwent multiple diagnostic modalities. It is possible that these represent earlier cases when lung biopsy with bombesin staining was the gold standard.[@OConnor26540427] The ATS clinical practice guidelines now recommend diagnosis of NEHI by imaging only.

```{r, warning = FALSE, message = FALSE}
# Looking at diagnostic modality by diagnosis

child.mod <- select(child, child_registry_id:diagnosis, fibrosis.factor:diagnosis.factor)
child.mod <- child.mod %>%
  mutate(modality = ifelse(child.mod$child_dia2___1 == 1 & child.mod$child_dia2___2 == 0 & child.mod$child_dia2___3 == 0 & child.mod$child_dia2___4 == 0, "CT only", NA)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___2 == 1 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___3 == 0 & child.mod$child_dia2___4 == 0, "Biopsy only", modality)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___3 == 1 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___2 == 0 & child.mod$child_dia2___4 == 0, "Genetic only", modality)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___2 == 0 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___3 == 0 & child.mod$child_dia2___4 == 0, "No Diagnostic Modality Listed", modality)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___4 == 1 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___2 == 0 & child.mod$child_dia2___3 == 0, "Other", modality)) %>%
  mutate(modality = ifelse(is.na(modality) == "TRUE", "Multiple", modality)) %>%
  mutate(modality.factor = as.factor(modality))
child.mod <- rename(child.mod, "Modality" = modality.factor)

tbl_summary(select(child.mod, "Modality"),  missing = "no") %>%
as_gt() %>%
gt::tab_header("Table 2. How was the diagnosis made?") %>%
opt_align_table_header(align = "left") %>%
gt::tab_options(table.font.size = '11px', table_body.hlines.style = "none", data_row.padding = px(1), table.width = px(300))


ggplot(data = filter(child.mod, !is.na(diagnosis)), aes(x = diagnosis.factor, fill = Modality)) +
  geom_bar(position = position_dodge(preserve = "single")) + 
  theme(plot.title = element_text(size=14, vjust=3),
  axis.text.x = element_text(angle = 45, hjust = 1, size = 8), 
  legend.title = element_text(size = 10), 
  legend.text = element_text(size = 8)) +
  labs(x = "Primary Diagnosis", fill = "Diagnostic Modality", title = "The chILD Registry: How was the diagnosis made?")

```


This project has several limitations. As this study is voluntary and requires each center to recruit patients, there is risk of recruitment biases. As each center is responsible for entering data in the database, there may be limitations to the availability of data, as it is not possible to go into the EMR or patient chart to verify or collect more data. There may be some variability in data entry, as each center is doing this individually. For example, when is a patient considered to have their diagnosis? This could be when they are determined to have ILD, or when they undergo BAL and discover pulmonary hemorrhage, or it could be weeks to months later when they undergo a lung biopsy to determine whether there is capillaritis; the choice of date may be center- or provider-dependent. The database is fairly granular, however, many fields are unstructured data and thus present a challenge when trying to synthesize data on a large scale. There are certain areas of data collection that may be beneficial to study that have not been included, for example, administration of systemic steroids, which can affect outcomes in certain disease processes. As chILD is a rapidly changing area of study, diagnostic tools and classification systems continue to evolve, which introduces increased variance in the dataset. Nevertheless, this is a large dataset on a group of diseases with significant morbidity and mortality, and it proves an invaluable tool in gaining further insight into workup and management.

The chILD Registry offers many future directions for study. Given concerns about recruitment biases, it would be interesting to do a single-center study comparing demographics of children diagnosed with ILD at our institution (likely pulled from the EMR) with those that have been enrolled in the registry. To further guide the workup algorithm, it would be helpful to develop a prediction model based on clinical characteristics to determine whether a patient needs to undergo invasive studies such as lung biopsy, or whether these can be avoided as our genetic testing capabilities continue to improve.


*Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.*

### References
<div id="refs"></div>
