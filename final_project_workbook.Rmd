---
title: "BMIN503/EPID600 Project Template"
author: "Katie Tsukahara"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.


>OVERVIEW:<br>Childhood interstitial lung disease (chILD) is a heterogeneous group of rare childhood lung diseases affecting the interstitial region of the lung, leading to abnormal gas exchange and a range of morbidity and mortality. Research and development of therapies is challenging due to the low prevalence and heterogeneity of disease, thus the CHILD Research Network and Registry was established to collect data from multiple centers across the United States. Our goal is to compare patient demographics across subsets of chILD subjects by diagnosis, and to examine the diagnostic and clinical factors that contribute to diagnosis.


### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

><br><br>INTRODUCTION:  
Childhood interstitial lung disease (chILD) encompasses a variety of lung diseases that manifest via changes to the pulmonary interstitium. The pulmonary interstitium is, simply put, the lung tissue between the airspace and the pulmonary blood vessels, and excludes other lung structures such as the airways. These diseases are grouped together owing to similarities in the area of the lung affected and in clinical presentation. While both children and adults can develop interstitial lung disease (ILD), many causes of chILD are seen only in the pediatric age group. These diseases can be genetic in origin, or associated with abnormal lung development, immunologic dysfunction, rheumatologic disease, or infectious history. Some cases do not have a clear etiology. Certain diagnoses confer a poor prognosis of early lung transplant or mortality. Other diagnoses confer a more positive prognosis, including clinical improvement and resolution of disease over early childhood.
<br><br>To study this group of diseases, the Children’s Interstitial and Diffuse Lung Disease Research Network (ChILDRN) established a national registry in 2016, with participation by 13 sites across the United States. The original registry contains 436 subjects, enrolled from 2016 to 2020, with data on demographics, medical history, diagnostics, management and outcomes. With this project, we aim to examine differences in patient demographics, including age of onset and severity of presentation, among the more common chILD diagnoses. We also aim to examine the diagnostic and clinical factors that contribute to diagnosis, if possible examining the role that different diagnostic tests play in diagnosis and whether invasive testing can be avoided in these patients that are at higher risk for procedures due to their underlying pulmonary disease. The database and this subsequent project use the skills and expertise of clinicians across many fields (Pulmonology, Radiology, Pathology, Rheumatology, and others), clinical researchers, basic science researchers, and biomedical informaticians to collect, manage, and interpret data on this complex group of patients.



### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 


```{r, include=FALSE, echo = FALSE}
# loading RedCAP data
setwd("C:/Users/tsukaharak/Documents/R files/BMIN503_Final_Project")
source("CHOPChildhoodILDNati-110620BMIN_R_2020-11-15_1000.R", local = knitr::knit_global())
# or sys.source("your-script.R", envir = knitr::knit_global())

# checking for duplicate entries
str(unique(data$child_registry_id))
str(data$child_registry_id)

child <- data
```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
# loading libraries
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)

```



### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.


```{r, warning = FALSE, message = FALSE}
# enrollment statistics
summary(child$age_studyentry)
ggplot(data = child, aes(x = age_studyentry)) + 
  geom_histogram(color = "black", fill = "white", binwidth=3) +
  labs(x = "Age (in months)", title = "Age at Study Entry in chILD Registry")
ggplot(data = child, aes(x = age_diagnosis)) + 
  geom_histogram(color = "black", fill = "white", binwidth=3) +
  labs(x = "Age (in months)", title = "Age at Diagnosis")

ggplot(child, aes(age_diagnosis, age_studyentry)) + 
  geom_jitter() +
  labs(x = "Age at Diagnosis (in months)", y = "Age at Study Entry (in months)", title = "chILD Regsitry: Timing of Diagnosis vs Study Entry")


```



```{r, warning = FALSE, message = FALSE}
# gender across diagnosis


ggplot(data = child, aes(x = diagnosis.factor)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Number of Subjects", title = "Primary Diagnoses in chILD Registry")

ggplot(data = child, aes(x = diagnosis.factor, fill = patient_gender.factor)) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Proportion of Total", title = "Gender by Diagnosis in chILD Registry", fill = "Gender")


p1chi <- chisq.test(table(child$diagnosis.factor, child$patient_gender.factor))
p1chi

ggplot(data = child, aes(x = diagnosis.factor, fill = patient_gender.factor)) + 
  geom_bar(position = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Proportion of Total", title = "Gender by Diagnosis in chILD Registry", fill = "Gender",subtitle = paste("Chi-squared p value =", format(p1chi$p.value, digits = 3)))



```



```{r, echo = TRUE, warning = FALSE, message = FALSE}
# age across diagnosis

summary(data$age_diagnosis)
mean(data$age_diagnosis, na.rm = TRUE)

ggplot(data = filter(child, child$diagnosis < 10), aes(x = diagnosis.factor, y = age_diagnosis)) + 
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", y = "Age (in Months)", title = "Age at Diagnosis in chILD Registry")

```




```{r, warning = FALSE, message = FALSE}
# looking at age at diagnosis and diagnostic modality

child.mod <- select(child, child_registry_id:diagnosis, fibrosis.factor:diagnosis.factor)
child.mod <- child.mod %>%
  mutate(modality = ifelse(child.mod$child_dia2___1 == 1 & child.mod$child_dia2___2 == 0 & child.mod$child_dia2___3 == 0 & child.mod$child_dia2___4 == 0, "CT only", NA)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___2 == 1 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___3 == 0 & child.mod$child_dia2___4 == 0, "Biopsy only", modality)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___3 == 1 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___2 == 0 & child.mod$child_dia2___4 == 0, "Genetic only", modality)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___2 == 0 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___3 == 0 & child.mod$child_dia2___4 == 0, "No Diagnositc Modality Listed", modality)) %>%
  mutate(modality = ifelse(child.mod$child_dia2___4 == 1 & child.mod$child_dia2___1 == 0 & child.mod$child_dia2___2 == 0 & child.mod$child_dia2___3 == 0, "Other", modality)) %>%
  mutate(modality = ifelse(is.na(modality) == "TRUE", "Multiple", modality)) %>%
  mutate(modality.factor = as.factor(modality)) 
  

table(child.mod$modality)


ggplot(data = filter(child.mod, !is.na(diagnosis)), aes(x = diagnosis.factor, fill = modality.factor)) +
  geom_bar(position = position_dodge(preserve = "single")) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Primary Diagnosis", fill = "Diagnostic Modality", title = "The chILD Registry: How was the diagnosis made?")

```

```{r, warning = FALSE, message = FALSE}
child.surf <- filter(child, diagnosis.factor == "Surfactant dysfunction disorder")
print(paste0("In the chILD Registry, there are ", nrow(child.surf), " entries with a primary diagnosis of surfactant dysfunction disorder"))

ggplot(data = filter(child.mod, diagnosis.factor == "Surfactant dysfunction disorder"), aes(x = modality.factor)) +
  geom_bar() + 
  scale_x_discrete(drop=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Diagnostic Modality", title = "The chILD Registry: Diagnosis of Surfactant Dysfunction Disorders")

ggplot(data = filter(child.mod, diagnosis.factor == "Surfactant dysfunction disorder"), aes(x = modality.factor)) +
  geom_bar() + 
  scale_x_discrete(drop=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Diagnostic Modality", title = "The chILD Registry: Diagnosis of Surfactant Dysfunction Disorders")

# colSums(select(child.surf, child_dia2___1:child_dia2___4), na.rm = TRUE)
# head(filter(child.surf, child_dia2___4 == 1) %>% select(child_registry_id:child_dia2___4)) - shows only 1 entry

library(VennDiagram)
library(magick)

venn.ct <- child.surf %>% filter(child_dia2___4 == 0) %>% select(child_registry_id, child_dia2___1) %>% filter(child_dia2___1 == 1) %>% mutate(venn.modality = "CT") %>% select(child_registry_id, venn.modality)
venn.bx <- child.surf %>% filter(child_dia2___4 == 0) %>% select(child_registry_id, child_dia2___2) %>% filter(child_dia2___2 == 1) %>% mutate(venn.modality = "Biopsy") %>% select(child_registry_id, venn.modality)
venn.gen <- child.surf %>% filter(child_dia2___4 == 0) %>% select(child_registry_id, child_dia2___3) %>% filter(child_dia2___3 == 1) %>% mutate(venn.modality = "Genetic Testing") %>% select(child_registry_id, venn.modality)
venn <- rbind(venn.ct, venn.bx, venn.gen)

#child.surf %>% filter(child_dia2___4 == 0 & child_dia2___1 == 0 & child_dia2___3 == 0) %>% head()
#child.surf %>% filter(child_dia2___4 == 0 & child_dia2___2 == 0 & child_dia2___3 == 0) %>% head()
#child.surf %>% filter(child_dia2___4 == 0 & child_dia2___1 == 0 & child_dia2___3 == 0) %>% head()

venn.diagram(
  x = list(
    venn %>% filter(venn.modality == "CT") %>% select(child_registry_id) %>% unlist() , 
    venn %>% filter(venn.modality == "Biopsy")  %>% select(child_registry_id) %>% unlist() , 
    venn %>% filter(venn.modality == "Genetic Testing") %>% select(child_registry_id) %>% unlist()
    ),
  category.names = c("Chest Computed Tomography (CT)" , "Lung Biopsy" , "Genetic Testing"),
  filename = 'venn.png',
  output = TRUE ,
          imagetype="png" ,
          height = 480 , 
          width = 480 , 
          resolution = 300,
          compression = "lzw",
          lwd = 1,
          col=c("#440154ff", '#21908dff', '#fde725ff'),
          fill = c(alpha("#440154ff",0.3), alpha('#21908dff',0.3), alpha('#fde725ff',0.3)),
          cex = 0.5,
          fontfamily = "sans",
          cat.cex = 0.3,
          cat.default.pos = "outer",
          cat.pos = c(-27, 27, 120),
          cat.dist = c(0.085, -0.055, 0.055),
          cat.fontfamily = "sans",
          cat.col = c("#440154ff", '#21908dff', '#fde725ff'),
          rotation = 1
        )

img <- magick::image_read('C:/Users/tsukaharak/Documents/R files/BMIN503_Final_Project/venn.png')
plot(img) # or print(img)

```


### Acknowledgements
We would like to thank the Children’s Interstitial and Diffuse Lung Disease Research Network (chILDRN) and Dr. Lisa Young for the opportunity to work on this project.
