---
title: "Project Template"
author: "Shufan Lin"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but keep the headers.

### Overview

The goal of my project is to explore the potential relationship between alcohol consumption and geographic/economic causes, such as median income and unemployment. I use the dataset from GHDx named [United States Alcohol Use Prevalence by County 2002-2012](http://ghdx.healthdata.org/record/ihme-data/united-states-alcohol-use-prevalence-county-2002-2012) to get information of the alcohol pattern across the U.S. (by year and sex). Additionally, I will use a map shapefile from the US Census Bureau to create map plots, and data from the American Community Survey (ACS) to get the information of median income/unemployment/poverty rate.

[Github Repository](https://github.com/Slin94/BMIN503_Final_Project)

In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

### Introduction

Alcohol consumption is the 7th leading risk factor for both death and disability all over the world. It led to 2.8 million deaths in 2016. Although several previous research suggests that moderate level of alcohol consumption brings benefit to humans, this finding has resently been questioned. 
As a matter of fact, a new study published in 2018 (Griswold et al. 2018) states that the level of alcohol consumption which minimize harm on human health is zero. Additionally, negative effect of alcohol on health outcomes raise with the increase in the level of consumption. Therefore, while it is impossible to fully stop populational alcohol use, analyzing potential causes which affect alcohol consumption helps develop preventive strategies.

Faculty/Staff:
Dr. Bomyi Lim, Sherrie Xie (Graduate student), Dr. Blanca Himes
In the first paragraph, describe the problem addressed, its significance, and some background to motivate the problem.
In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.
  
  
### Methods
+I use the dataset from GHDx named [United States Alcohol Use Prevalence by County 2002-2012](http://ghdx.healthdata.org/record/ihme-data/united-states-alcohol-use-prevalence-county-2002-2012) to get information of the alcohol pattern across the U.S. (by year and sex). Additionally, I use a map shapefile from the US Census Bureau to create map plots, and data from the American Community Survey (ACS) to get the information of median income/unemployment/poverty rate.

In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

```{r, eval=TRUE}
install.packages("readxl", repos = "http://cran.us.r-project.org")
install.packages("tmap", repos = "http://cran.us.r-project.org")

library(ggplot2)      # For plotting
library(tidycensus)   # For downloading Census data
library(tmap)         # For creating tmap
library(tmaptools)    # For reading and processing spatial data related to tmap
library(dplyr)        # For data wrangling
library(RColorBrewer)
library(tidyverse)
library(sf)
library(tidycensus)
library(leaflet)
library(maptools)
library(reshape2)
library("readxl")
```
 +Import and clean up alcohol consumption data preliminarily
```{r, eval=TRUE}
#load data
alcohol_any <- read_excel("alcohol_2002_2012.xlsx", sheet = "Any")
alcohol_heavy <- read_excel("alcohol_2002_2012.xlsx", sheet = "Heavy")
alcohol_binge <- read_excel("alcohol_2002_2012.xlsx", sheet = "Binge")

str(alcohol_any)
str(alcohol_heavy)
str(alcohol_binge)

#merge dataframe (alcohol_heavy lack the data from 2002-2004)
alcohol_any <- mutate(alcohol_any, Degree = "Any")
alcohol_binge <- mutate(alcohol_binge, Degree = "Binge")
alcohol_heavy <- mutate(alcohol_heavy, Degree = "Heavy", "2002 Both Sexes" = NA, "2003 Both Sexes" = NA, "2004 Both Sexes" = NA, "2002 Males" = NA, "2003 Males" = NA, "2004 Males" = NA, "2002 Females" = NA, "2003 Females" = NA, "2004 Females" = NA, "Percent Change 2002-2012, Both Sexes" = NA, "Percent Change 2002-2012, Females" = NA, "Percent Change 2002-2012, Males" = NA)
combine_alcohol <- rbind(alcohol_any, alcohol_heavy, alcohol_binge)
```
 +First, I compare national change of alcohol use (by sexes)
```{r, eval=TRUE}
#compare national change of alcohol consumption by sexes (2002 vs. 2012, any vs. binge (2002-2004 heavy data is missing))
#extract data
c_ten <- c(36, 37, 38, 42)
ten_years <- combine_alcohol%>%
  filter(State == "National")%>%
  filter(Degree == "Any"|Degree =="Binge")

#clean up
ten_years <- ten_years[c_ten] %>%
  rename(Both = "Percent Change 2002-2012, Both Sexes", Males = "Percent Change 2002-2012, Males", Females = "Percent Change 2002-2012, Females")
ten_years <- melt(ten_years, id.vars = "Degree")

#plot
ggplot(ten_years, aes(x = Degree, y = value, fill = variable)) +
  geom_col(stat = "identity", position = "dodge") +
  scale_fill_manual("Sexes", values = c("Both" = "green3", "Females" = "coral1", "Males" = "cornflowerblue")) +
  ylab("Change between 2002 and 2012 (%)")

#compare national change of alcohol consumption by sexes (2005 vs. 2012, any vs. heavy vs. binge)
#extract data
eight_years <- combine_alcohol%>%
  filter(State == "National")

#clean up
eight_years <- eight_years[39:42] %>%
  rename(Both = "Percent Change 2005-2012, Both Sexes", Males = "Percent Change 2005-2012, Males", Females = "Percent Change 2005-2012, Females")
eight_years <- melt(eight_years, id.vars = "Degree")

#plot
ggplot(eight_years, aes(x = Degree, y = value, fill = variable)) +
  geom_col(stat = "identity", position = "dodge") +
  scale_fill_manual("Sexes", values = c("Both" = "green3", "Females" = "coral1", "Males" = "cornflowerblue")) +
  ylab("Change between 2005 and 2012 (%)")
```
 + Given that the data of heavy alcohol use is not available from 2002-2004, I use data from 2005-2012 in later analyzation. The bar plots show that the change in alcohol prevalence differs by sex and time (2005 vs. 2012). Therefore, I make a box plot to analyze this difference in 2005 and 2012.
```{r, eval=TRUE}
#clean up data: heavy 2005 vs. 2012 percent change at state level
alcohol_heavy_state_change <- alcohol_heavy%>%
  filter(State == Location)%>%
  rename(Both = "Percent Change 2005-2012, Both Sexes", Males = "Percent Change 2005-2012, Males", Females = "Percent Change 2005-2012, Females")%>%
  select(State, Both, Males, Females)

#transform dataframe for box plot
box_heavy_state_change <- alcohol_heavy_state_change%>%
  select(Males, Females)
box_heavy_state_change <- melt(box_heavy_state_change)%>%
  rename(Sexes = "variable", Prevalence = "value")

heavy_vs_sex <- glm(Sexes ~ Prevalence, data = box_heavy_state_change, family = binomial())
summary(heavy_vs_sex)
confint(heavy_vs_sex)
exp(cbind(OR = coef(heavy_vs_sex), CI = confint(heavy_vs_sex)))

#plot 
ggplot(data = box_heavy_state_change, aes(x= Sexes, y=Prevalence)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#ff7256", "#6495ed")) +
  ylab("Prevalence Change (%)") +
  xlab("Gender") +
  ggtitle("Heavy Male vs. Female percent change") +
  theme(plot.title = element_text(hjust = 0.5))

#clean up data: binge 2005 vs. 2012 percent change at state level
alcohol_binge_state_change <- alcohol_binge%>%
  filter(State == Location)%>%
  rename(Both = "Percent Change 2005-2012, Both Sexes", Males = "Percent Change 2005-2012, Males", Females = "Percent Change 2005-2012, Females")%>%
  select(State, Both, Males, Females)

#transform dataframe for box plot
box_binge_state_change <- alcohol_binge_state_change%>%
  select(Males, Females)
box_binge_state_change <- melt(box_binge_state_change)%>%
  rename(Sexes = "variable", Prevalence = "value")

binge_vs_sex <- glm(Sexes ~ Prevalence, data = box_binge_state_change, family = binomial())
summary(binge_vs_sex)
confint(binge_vs_sex)
exp(cbind(OR = coef(binge_vs_sex), CI = confint(binge_vs_sex)))

#plot 
ggplot(data = box_binge_state_change, aes(x= Sexes, y=Prevalence)) +
  geom_boxplot() +
  ylab("Prevalence Change (%)") +
  xlab("Gender") +
  ggtitle("Heavy Male vs. Female percent change") +
  theme(plot.title = element_text(hjust = 0.5))
```

 +Given that there is a large gap between 2002/2005 vs. 2012 alcohol consomption in heavy & binge, I check how they change over the ten years
```{r, eval=TRUE}
#get national alcohol use values (2002-2012)
changes_national <- combine_alcohol%>%
  filter(State == "National")
changes_national <- changes_national[3:35]

#clean up
any_changes <- as.data.frame(matrix(as.numeric(changes_national[1,]), nrow = 3, ncol = 11))
heavy_changes <- as.data.frame(matrix(as.numeric(changes_national[2,]), nrow = 3, ncol = 11))
binge_changes <- as.data.frame(matrix(as.numeric(changes_national[3,]), nrow = 3, ncol = 11))
combine_changes_national <- rbind(any_changes, heavy_changes, binge_changes)
combine_changes_national$Degree <-c(rep("Any", 3), rep("Heavy", 3), rep("Binge",3))
combine_changes_national <- combine_changes_national%>%
  rename("2002" = "V1", "2003" = "V2", "2004" = "V3", "2005" = "V4", "2006" = "V5", "2007" = "V6", "2008" = "V7", "2009" = "V8", "2010" = "V9", "2011" = "V10", "2012" = "V11")

#Plot change in heavy alcohol use from 2002 to 2012
#clean up
combine_changes_national <- melt(combine_changes_national, id.vars = "Degree")%>%
  rename("Year" = "variable")
combine_changes_national$Sexes <- rep(c("Both", "Females", "Males"), 33)
combine_changes_national_heavy <- combine_changes_national%>%
  filter(Degree == "Heavy")
  #can use drop_na() to drop N/A data from 2002-2005

#plot
ggplot(combine_changes_national_heavy, aes(x = Year, y = value, colour = Sexes)) + 
  geom_line(aes(x = Year, y = value, group = Sexes)) +
  scale_color_manual("Sexes", values = c("Both" = "green3", "Females" = "coral1", "Males" = "cornflowerblue")) +
  ylab("Change in heavy alcohol use from 2002 to 2012 (%)")

#Change in binge alcohol use from 2002 to 2012 (%)
#clean up
combine_changes_national_binge <- combine_changes_national%>%
  filter(Degree == "Binge")

#plot
ggplot(combine_changes_national_binge, aes(x = Year, y = value, colour = Sexes)) + 
  geom_line(aes(x = Year, y = value, group = Sexes)) +
  scale_color_manual("Sexes", values = c("Both" = "green3", "Females" = "coral1", "Males" = "cornflowerblue")) +
  ylab("Change in binge alcohol use from 2002 to 2012 (%)")

```

### Results
  +To analyze whether geographic location (different states) has impact on alcohol consumption level, I make 2X3 (heavy/binge vs. both/females/males) maps to visualize geographic impact
```{r, eval=TRUE}
#import US map shapefile
US_sf <- st_read("acs_2012_2016_county_us_B27001/acs_2012_2016_county_us_B27001.shp",
               stringsAsFactors = FALSE) %>%
  select(GEOID, geometry)%>%
  mutate(Code = stringr::str_sub(GEOID, 1, 2))

#See the changes at state level
#import state code, clean up
State_code <- read_excel("State Code.xlsx")
Code.update <- State_code$Code
Code.new <- str_pad(Code.update, 2, pad = "0")
State_code <- State_code%>%
  mutate(Code = as.character(Code.new))

#join state code to alcohol_heavy_state_change
alcohol_heavy_state_change <- inner_join(alcohol_heavy_state_change, State_code, by = "State")

#join state code to alcohol_binge_state_change
alcohol_binge_state_change <- inner_join(alcohol_binge_state_change, State_code, by = "State")

#aggregate map information by state, join to cleaned heavy/binge data
US_states <- US_sf%>%
  dplyr::select(geometry)%>%
  aggregate(by = list(US_sf$Code), FUN = mean)%>%
  rename(Code = "Group.1")%>%
  mutate(Code = as.character(Code))
US_states_heavy <- inner_join(US_states, alcohol_heavy_state_change, by = "Code")
US_states_binge <- inner_join(US_states, alcohol_binge_state_change, by = "Code")

#plot
#set min&max for heavy
prev_h_both_min <- sort(US_states_heavy$Both)[1]
prev_h_both_max <- sort(US_states_heavy$Both, decreasing = TRUE)[1]
prev_h_male_min <- sort(US_states_heavy$Males)[1]
prev_h_male_max <- sort(US_states_heavy$Males, decreasing = TRUE)[1]
prev_h_female_min <- sort(US_states_heavy$Females)[1]
prev_h_female_max <- sort(US_states_heavy$Females, decreasing = TRUE)[1]

#set min&max for binge
prev_b_both_min <- sort(US_states_binge$Both)[1]
prev_b_both_max <- sort(US_states_binge$Both, decreasing = TRUE)[1]
prev_b_male_min <- sort(US_states_binge$Males)[1]
prev_b_male_max <- sort(US_states_binge$Males, decreasing = TRUE)[1]
prev_b_female_min <- sort(US_states_binge$Females)[1]
prev_b_female_max <- sort(US_states_binge$Females, decreasing = TRUE)[1]

#set theme
my_theme <- function() {
  theme_minimal() +                                  
  theme(axis.line = element_blank(),                 
        axis.text = element_blank(),                 
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  
        legend.key.size = unit(0.6, "cm"),          
        legend.text = element_text(size = 12),       
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 16))      
}

#set color for both, males, and females
myPalette_both <- colorRampPalette(brewer.pal(9, "Greens"))
myPalette_male <- colorRampPalette(brewer.pal(9, "Blues"))
myPalette_female <- colorRampPalette(brewer.pal(9, "Reds"))

#plot:heavy&binge, both
ggplot() + 
  geom_sf(data = US_states_heavy, aes(fill = Both), lwd = 0) +
  my_theme() +
  ggtitle("Change in Age-standardized Prevalence of Heavy Drinking\n 2005 to 2012, Both Sexes") +
  scale_fill_gradientn(name = "Prevalence\nChange (%)", colours = myPalette_both(100),
                       limit = range(prev_h_both_min, prev_h_both_max)) 

ggplot() + 
  geom_sf(data = US_states_binge, aes(fill = Both), lwd = 0) +
  my_theme() +
  ggtitle("Change in Age-standardized Prevalence of Binge Drinking\n 2005 to 2012, Both Sexes") +
  scale_fill_gradientn(name = "Prevalence\nChange (%)", colours = myPalette_both(100),
                       limit = range(prev_b_both_min, prev_b_both_max)) 

#plot:heavy&binge, males
ggplot() + 
  geom_sf(data = US_states_heavy, aes(fill = Males), lwd = 0) +
  my_theme() +
  ggtitle("Change in Age-standardized Prevalence of Heavy Drinking\n 2005 to 2012, Males") +
  scale_fill_gradientn(name = "Prevalence\nChange (%)", colours = myPalette_male(100),
                       limit = range(prev_h_male_min, prev_h_male_max)) 

ggplot() + 
  geom_sf(data = US_states_binge, aes(fill = Males), lwd = 0) +
  my_theme() +
  ggtitle("Change in Age-standardized Prevalence of Binge Drinking\n 2005 to 2012, Males") +
  scale_fill_gradientn(name = "Prevalence\nChange (%)", colours = myPalette_male(100),
                       limit = range(prev_b_male_min, prev_b_male_max)) 

#plot:heavy&binge, females
ggplot() + 
  geom_sf(data = US_states_heavy, aes(fill = Females), lwd = 0) +
  my_theme() +
  ggtitle("Change in Age-standardized Prevalence of Heavy Drinking\n 2005 to 2012, Females") +
  scale_fill_gradientn(name = "Prevalence\nChange (%)", colours = myPalette_female(100),
                       limit = range(prev_h_female_min, prev_h_female_max)) 

ggplot() + 
  geom_sf(data = US_states_binge, aes(fill = Females), lwd = 0) +
  my_theme() +
  ggtitle("Change in Age-standardized Prevalence of Binge Drinking\n 2005 to 2012, Females") +
  scale_fill_gradientn(name = "Prevalence\nChange (%)", colours = myPalette_female(100),
                       limit = range(prev_b_female_min, prev_b_female_max)) 

```
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
