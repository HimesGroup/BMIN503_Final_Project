---
title: "Razzo_Final Project Outline"
output: html_document
date: "2022-10-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###OVERVIEW: 
This study aims to identify any associations between excess body weight and ISS risk at diagnosis, adverse cytogenetics, RNA expression and telomere length. We will use BMI as a surrogate marker for excess body weight, recognizing this is an imperfect measure of adiposity.

***The overview consists of 2-3 sentences summarizing the project and goals.*** 

###INTRODUCTION:
Multiple myeloma (MM) is the second most common blood cancer diagnosis, with over 20,000 cases diagnosed each year in the United States. Age, race and genetic factors are known predisposing risk factors, but obesity is the only modifiable characteristic consistently implicated in the development of both MGUS and MM (Carson, Bates, and Tomasson 2014; Landgren et al. 2010; Wallin and Larsson 2011). Persons with excess body weight are 10-20% more likely to develop multiple myeloma, with an estimated number of 12,480 cases attributed to excess body weight in the United States between 2011-2015 (Islami et al. 2019).The pathophysiological basis of this association is not fully understood with systemic and marrow immune dysfunction as putative driver mechanisms. 

This is an intrinsically multidisciplinary project because it incorporates elements of hematology-oncology, pathology, endocrinology, radiology and population genetics. My mentors have been introduced by experts to these respective fields in order to enrich my studies. 

***For the introduction, the first paragraph describes the problem addressed, its significance, and some background to motivate the problem. In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.*** 

##METHODS/RESULTS:
***Start working on the Methods/Results section, which consists of code and its output along with text describing what you are doing (Note: we will not check your code now, but you should have something in place before Assignment 6 is distributed).***

#Descriptive Analyses of the population:

```{r, eval = TRUE}
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(tibble)
library(readr)

MMRFfull <- read.csv("~/Documents/BMIN 5030/Final Project/Raw Files/Razzo_MMRF raw csv.csv", header = T, fill = TRUE, row.name = NULL)
MMRFfull <- rename(MMRFfull, Patient_ID = Patient)

MMRFclean <- read.csv("~/Documents/BMIN 5030/Final Project/Raw Files/Razzo_MMRF clean csv.csv", header = T, fill = TRUE, row.name = NULL)
MMRFclean <- rename(MMRFclean, Sex = D_Gender, Race = D_Race, AgeDx = D_Age, BMIDx = BMI, ISSDx = D_ISS) %>%
  mutate(BMI_cat_4 = factor(BMI_cat_4, levels = c(0,1,2,3), labels = c("BMI <18.5", "BMI 18.5-25", "BMI 25-30", "BMI >30"))) %>%
  mutate(BMI_cat_6 = factor(BMI_cat_6, levels = c(0,1,2,3,4,5), labels = c("BMI <18.5", "BMI 18.5-25", "BMI 25-30", "BMI 30-35", "BMI 35-40", "BMI >40"))) %>%
  mutate(FU_status = factor(FU_status, levels = c(0,1), labels = c("Not censored", "Censored"))) %>%
  mutate(OS_status = factor(OS_status, levels = c(0,1), labels = c("Alive", "Dead"))) %>%
  mutate(ISSDx = factor(ISSDx, level = c(1,2,3)))

MMRFclean$Translocation_Summary <- as.factor(MMRFclean$Translocation_Summary)
MMRFclean$HRD <- as.factor(MMRFclean$HRD)

#Baseline Patient Characteristics, BMI 4 categories
patientcharacteristics <- MMRFclean %>% gtsummary::tbl_summary()
MMRFclean %>% 
  dplyr::select(c(Sex, Race, AgeDx, BMI_cat_4, ISSDx, IMWG_Risk, Translocation_Summary)) %>%
  gtsummary::tbl_summary(by = BMI_cat_4) %>%
  gtsummary::add_p()

#Baseline Patient Characteristics, BMI 6 categories
patientcharacteristics <- MMRFclean %>% gtsummary::tbl_summary()
MMRFclean %>% 
  dplyr::select(c(Sex, Race, AgeDx, BMI_cat_6, ISSDx, IMWG_Risk, Translocation_Summary)) %>%
  gtsummary::tbl_summary(by = BMI_cat_6) %>%
  gtsummary::add_p()

#Graphs representing this summary table - 
library(RColorBrewer)
mycolors=brewer.pal(8,"Set2")
mycolors
hist(1:10, col=mycolors)

#BMI distribution by Sex - ?HOW TO I REMOVE THE NAS - NA.RM = TRUE IS NOT WORKING*****
ggplot(data = MMRFclean, aes(x = BMIDx, color = Sex, na.rm = TRUE)) + 
    geom_histogram(aes(y= ..density.., color=Sex), na.rm=TRUE, Male = "blue", Female = "red", fill = "white", alpha = 0.7)+
    geom_density(Male = "blue", Female = "red", na.rm=TRUE)
ggsave("BMI histogram by sex.pdf")

```


```{r, eval = FALSE}
#Hidden section where I save all my output as files and figures
patientcharacteristicstibble <- MMRFclean %>% gtsummary::tbl_summary()
MMRFclean %>% 
  dplyr::select(c(Sex, Race, AgeDx, BMI_cat_4, ISSDx, IMWG_Risk, Translocation_Summary)) %>%
  gtsummary::tbl_summary(by = BMI_cat_4) %>%
  gtsummary::add_p()%>%
  as_tibble()

write.csv(patientcharacteristicstibble, "./Patient Characteristics.csv")

ggsave("Ex.pdf") #Default plot to save is last plot
ggsave("Ex.tiff", plot = fig)

```

#Describing the relationship between age at diagnosis (AgeDx), BMI at diagnosis (BMIDx), Sex and Race

AGE. The scatter plot slope is small but statistically significant: BMI at diagnosis declines with age. A linear model appears to be an appropriate fit. Later analyses will need to take this relationship into account.
```{r, eval = TRUE}
ggplot(BMIagelm, aes(x = MMRFclean$AgeDx, y = MMRFclean$BMIDx)) +
    geom_point(color = "darkseagreen3") + 
    geom_smooth(method = "lm", color = "green4") +
    labs(title = "BMI by age of diagnosis") +
    labs(x = "Age at diagnosis", y = "BMI at diagnosis")
ggsave("BMI by Age.pdf")
cor(MMRFclean$AgeDx, MMRFclean$BMIDx, use = "complete.obs")  

BMIagelm <- lm(MMRFclean$AgeDx ~ MMRFclean$BMIDx) 
summary(BMIagelm)
coef(BMIagelm) 
confint(BMIagelm)
```

SEX. A linear model integrating age and BMI data again demonstrates the relationship with age but does not demonstrate a relationship with BMI as a continuous variable. However, when BMI is split in 4 or 6 discreet categories, there is a small but statistically significant difference in the distribution of biological sex. Whether these differences will be relevant in the following analysis will be determined on a case to case basis. 
```{r, eval = TRUE}
#Barplots of discreet data distribution, histogram as shown above
ggplot(data = MMRFclean, aes(x = BMI_cat_4, fill = factor(Sex))) + 
    geom_bar(position = "dodge")

ggplot(data = MMRFclean, aes(x = BMI_cat_6, fill = factor(Sex))) + 
    geom_bar(position = "dodge")

#LM of BMI as continuous variable
library(modelsummary)
lm1 <- lm(BMIDx ~ AgeDx + Sex, data = MMRFclean)
modelsummary(list(lm1), coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             estimate = "{estimate} [{conf.low}, {conf.high}]") 

#Chi-Sq using discreet BMI categories
chisq.test(table(MMRFclean$BMI_cat_4, MMRFclean$Sex))
chisq.test(table(MMRFclean$BMI_cat_6, MMRFclean$Sex))

```

RACE: By lm, there are statistically signficant differences in BMI distribution. ***ANOVA NOT WORKING...*** 
```{r, eval = TRUE}
ggplot(data = MMRFclean, aes(x = factor(Race), y = BMIDx)) +
    geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
    stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red")

lm2<- lm(BMIDx ~ Race, data = MMRFclean)
modelsummary(list(lm2), coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             estimate = "{estimate} [{conf.low}, {conf.high}]") 

###ANOVA IS NOT WORKING ~~~
aov1 <- aov(MMRFclean$BMI_cat_4 ~ MMRFclean$Sex, data = MMRFclean, na.rm=TRUE)
summary(aov1)


```


#Characterization of BMI at diagnosis and t(4;14), HRD and ISS [MONDAY]

Visually there is no difference in presenting ISS according to BMI. ***IS THE SAME TRUE WHETHER ACCOUNTING FOR AGE DIFFERENCES? PROBABLY...*** This is confirmed by a non-statistically significant Chi-Sq test.

In regards to the weight distribution of the most common MM related translocations, none appear to seggregate with BMI (though t(8;14) did appear to be statistically significant, it is a rare translocation so this is unlikely to be a clinically significant finding).

Finally, the BMI distribution is exactly the same accross individuals with and without high risk RNA risk profiling (defined as GEP70 score > ***) EILEEN: IS THIS CORRECT THAT IT IS THE GEP70?***). 

```{r, eval = TRUE}

#BMI and presenting ISS
ggplot(data = MMRFclean, aes(x = BMIDx, color = ISSDx, na.rm = TRUE, position = "dodge")) + 
    geom_histogram(aes(y= ..density.., color=ISSDx), na.rm=TRUE, fill = "white", alpha = 0.7)+
    geom_density()

chisq.test(table(MMRFclean$BMI_cat_4, MMRFclean$ISSDx))

#Translocation Summary - NA, t(4;14), t(11;14), t(14;20), t(4;14), t(6;14), t(8;14)
ggplot(data = MMRFclean, aes(x = factor(Translocation_Summary), y = BMIDx)) +
    geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
    stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") +
    geom_jitter(shape=16, position=position_jitter(0.2))

lm4<- lm(BMIDx ~ Translocation_Summary, data = MMRFclean)
modelsummary(list(lm4), coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             estimate = "{estimate} [{conf.low}, {conf.high}]") 

#RNA risk status
MMRFclean$RNA_high_risk <- as.factor(MMRFclean$RNA_high_risk)
ggplot(data = MMRFclean, aes(x = BMIDx, color = RNA_high_risk, na.rm = TRUE)) + 
    geom_histogram(aes(y= ..density.., color=RNA_high_risk), na.rm=TRUE, fill = "white", alpha = 0.7)+
    geom_density(na.rm=TRUE)

```

#Interrogating variables above for "weightedness" in a glm [MONDAY]

```{r, eval = TRUE}
#GLM for BMI vs all: as continuous variable due to likelihood of age and sex as confounding factors; will also check for any unbalance in risk - PENDING

```

#Survival Analyses: [MONDAY]

```{r, eval = TRUE}

km_fit_all <- survfit(Surv(OS_time, OS_status) ~ 1, data=MMRFclean)
summary(km_fit_all, OS_time = c(1,2,3,4,5,6))
autoplot(km_fit_all)

#Survival by BMI cat 4 - PENDING
#Survival by BMI cat 6 - PENDING
#Survival by Age - PENDING
#Survival by Sex - PENDING
#Survival adjusted by age and by sex - PENDING
#Survival by t(4;14) and by HRD by BMI 4, adjusted by age - PENDING


head(survival)
km <- with(veteran, Surv(time, status))
km_fit <- survfit(Surv(time, status) ~ 1, data=veteran)
summary(km_fit, times = c(1,30,60,90*(1:10)))

#Raw
#Corrected for age, sex and ***

```

```{r, eval = FALSE}

#Hidden section where I save all my output as workable files and figures

```

#DGE -- high vs non-elevated BMI groups:

```{r cars}

#Best way to represent this?

```

```{r, eval = FALSE}

#Hidden section where I save all my output as workable files and figures

```

#NMF for Apobec signatures [MONDAY EILEEN EMAIL]
Why NMF versus other method for GSEA? Should I compare these?

```{r, eval = TRUE}


```

```{r, eval = FALSE}

#Hidden section where I save all my output as workable files and figures

```

#GSEA -- looking at other pathways?
Some form of metabolomics and immune profiles would be interesting...

```{r, eval = TRUE}



```

```{r, eval = FALSE}

#Hidden section where I save all my output as workable files and figures

```

#Other Ideas?

+SEER data?
+BRFSS data?

#Basic scripts from Eileen and other script dumps:

```{r cars, include = TRUE}

install.packages("dplyr")
install.packages("RColorBrewer")
install.packages("PairedData")
install.packages("ggplot2")
library("RColorBrewer")
library("dplyr")
library("PairedData")
library("ggplot2")

#Define a list of colors
mycolors=brewer.pal(8,"Set2")
mycolors
hist(1:10, col=mycolors)

#Calculate averages and SD. e.g. HRD
group_by(my_data, HRD ) %>%
  summarise(
    count = n(),
    mean = mean(HRD , na.rm = FALSE),
    sd = sd(HRD , na.rm = FALSE))

#Remove all the NA from your table. Be careful, you shouldn't do in on all your data
my_data=na.omit(my_data)

##BOXPLOTS:
##Version two: try replacing FALSE by TRUE
boxplot(Shannon~HRD, data=my_data,  col=mycolors, outline=FALSE)

##Statistics, to separate out value and chi-squared lines 52 and 53
mytest=kruskal.test(Shannon~Risk, my_data)
mytest$p.value
mytest$statistic

##Add the p-value to the plot
boxplot(Shannon~Risk, data=my_data,  col=c("red","green"), outline=FALSE)
mylabel1 = bquote(p == .(format(mytest$p.value, digits = 5)))
mylabel2 = bquote(Chi2==.(format(mytest$statistic, digits = 2)))
text(x=1.5, y=1.9, mylabel2)
text(x=1.5, y=1.85, mylabel1)

##PAIRED VARIABLES:
##Load the "weight" Obesity data"
###Subset the tables
# Subset weight data before treatment
before <- subset(poisson,  Study_ID == "before", BMI_dx,
                 drop = TRUE)
# subset weight data after treatment
after <- subset(poisson,  Study_ID == "after", BMI_dx,
                drop = TRUE)
# Plot paired data
pd <- paired(before, after)Study_ID
plot(pd, type = "profile", color= c("#00AFBB", "#E7B800")) + 
  theme_light()

##BARPLOTS:
# create a datase
d2 <- my_data %>% 
  group_by(Progressed,HRD) %>% 
  summarise(count=n())%>% 
  mutate(perc=count/sum(count))

d2=na.omit(d2)


#Create barplots
ggplot(d2, aes(fill=factor(HRD), y=perc, x=Progressed))+ 
  #add a barplot
  geom_bar(position="fill", stat="identity")+
  #choose the colors to fill
   scale_fill_manual(values=mycolors)+
  #remove the grey backgroung
  theme_light(base_size = 14)+
  #add test
  geom_text(aes(label=round(perc, digits = 2)), position=position_dodge(width=0.9), vjust=-0.25, colour="white")+
  labs(x = "Progression status", y = "Percent cats", fill = "Hyperdiploidy" )
  

gt(patientcharacteristics)


install.packages("huxtable")
huxtable::quick_xlsx()

install.packages("flextable")
library(flextable)
library(gt)
patientcharacteristics %>%
  as_flex_table() %>%
  flextable::save_as_docx()

patientcharacteristics %>%
  gt::as_gt() %>%
  gt::gtsave(filename = ".")

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
