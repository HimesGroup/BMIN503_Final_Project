---
title: "BMIN503/EPID600 Project - Change Title"
author: "Katrina Bazemore"
output: 
  prettydoc::html_pretty:
    toc: true
    number_sections: true
  theme: cayman
  highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***
# Overview
***

Cognitive resilience has been theorized to explain variation in cognitive function between individuals with the same level of dementia pathology, with higher cognitive resilience delaying onset of dementia symptoms. Cognitive resilience is difficult to measure, with level of education and cognitive activity functioning as key proxies. Other experiences, such as childhood adversity and stressful events in later life have been associated with worse physical and mental health and may decrease the positive effects of education and cognitive activity. Using data from the RUSH Religious Orders Study Memory and Aging Project, which I learned about from Dr. Adam Naj (Assistant Professor of Epidemiology, DBEI), I will investigate the association between childhood adversity / later life stressful events and diagnosis of cognitive impairment. The Memory and Aging Project sub study enrolled over 2,000 older adults with no cognitive impairment at enrollment and conducted yearly follow up until mortality. Approaches to prepare the data and conduct analyses are informed by Dr. Blanca Himes (Assistant Professor of Informatics, DBEI).

>[https://github.com/KSBazemore/BMIN503_Final_Project]


# Introduction 
***

An estimated 6.5 million people in the United States have Alzheimerâ€™s Dementia (AD) in 2022. Women and racial minorities are disproportionately affected by AD and other Dementias. This condition presents a substantial public health, economic, and emotional burden for those affected and their communities and is among the leading causes of death in older adults (1-3). Treatments for AD and dementia are limited, though delay in disease onset through reduction and control of risk factors has the potential to reduce prevalence of these conditions (4). One actionable way to delay disease onset may be through cognitive resilience. Many older adults do not exhibit clinical symptoms of dementia, despite substantial pathology (5). Cognitive resilience is thought to explain variations in functioning between those with similar levels of pathology, with greater resilience protecting against cognitive decline (6). Measures of cognitive resilience have been associated with reduced susceptibility to cognitive insults, including dementia and traumatic brain injury (7, 8). Results from the Adult Changes in Thought study showed adults with a college education had two times the odds of being classified as resilient based on comparisons of cognitive function prior to death, and pathology determined at autopsy (9). However, cognitive resilience is difficult to measure and define in life with key proxies including education level and participation in mentally engaging activities in later life (10, 11). 

In contrast, negative life experiences such as depression and affective loss have been associated with earlier age of AD onset (12). Stressful life events, particularly early stressful life events have previously been associated with greater susceptibility to poor mental health (13). In mouse models, exposure to stress in early life was linked to decreased adult cognitive ability (14). This evidence suggests a possible relationship between early childhood / lifetime stressors and increased risk of dementia. I plan to explore the relationship between onset of cognitive impairment and childhood adversity / later life stressors. I hypothesize that among older adults at risk of cognitive impairment, those who have experienced greater childhood adversity or who are experiencing more stressful events in their later life will be at higher risk of developing cognitive impairment, independent of common measures of cognitive resilience. 


# Methods
***

## Data Source

For this project I used data from the RUSH Religious Orders Study Memory and Aging Project. This is a prospective cohort study that enrolled older adults beginning in 1997 from retirement communities and senior housing in Chicago and North Eastern Illinois who had no signs of dementia or cognitive impairment at enrollment. This study focused on chronic conditions common in aging individuals with a special focus on cognitive decline. Participants agreed to yearly visits, which included collection of survey information, clinical assessments, bloodwork, and neuropsychological testing. Participants also agreed to organ donation for research after death. Data available includes demographic, life course, medical diagnoses, cognitive function, and genotypes. 

## Methodological Approach

I used baseline and longitudinal follow up data to determine 5 year risk of incident cognitive impairment by experience with childhood adversity. No participants had cognitive impairment at the start of their follow up, so any cognitive impairment diagnosed is incident impairment. Childhood adversity is defined a summary measure of participant response to multiple domains including financial need during childhood, emotional neglect, and parental violence. A greater value in the summary measure and individual domains indicates greater / more frequent experience with adversity. Proxy variables related to cognitive resilience include respondent education, cognitive resources and activity across the lifespan (childhood, young adulthood, late adulthood, and total), and socioeconomic status in early life. Respondents were classed as having cognitive impairment if they had any diagnosis of mild cognitive impairment, Alzheimer's Disease, or other Dementia, and were classed as having no cognitive impairment if they did not receive any of those diagnoses by the 5th year of follow up. For subjects who were lost to follow up or were deceased prior to either the 5th year of follow up or experiencing cognitive impairment, multiple imputation was used to determine their most likely outcome. 

To determine the impact of stressful life events in later life on risk of cognitive impairment, I used longitudinal data. At each follow up visit, participants were asked if in the past year they experienced stressful events including divorce, hospitalization, loss of a close family member, and taking on substantial caregiving activites. MORE LATER. 

***

First, I will load in necessary libraries. 

```{r}
#Loading in libraries
library(gtsummary)
library(ggplot2)
library(ggdag)
library(dagitty)
library(ggplot2)
library(readxl)
library(dplyr)
library(gee)
library(mice)
library(survival)
library(ggsurvfit)
```
I use a directed acyclic graph (DAG) to determine important covariates to control for in adjusted analyses. Variables are included in the DAG based on my conceptualization of the factors related to exposure (adversity / stressful life events) and outcome (cognitive impairment). GGDAG tools are used to determine the minimally sufficient set of covariates to include to reduce confounding of the exposure and outcome relationship. 
```{r}
#Conceptualization of variable relationships using ggdag
coord_dag <- list (
  x = c(ApoE = 0, sex = 0, race = 0, c_cog = 1, e_SES = 1, edu = 2, stress = 3, a_SES = 4, occ_ach = 5, age = 4, bmi = 4, stroke = 5, tbi = 5, p_act = 6, htn = 6, dm = 6, vasc = 6, depress = 7, a_cog = 7, dx = 8, soc = 7),
  y = c(ApoE = 11, sex = 10, race = 9, c_cog = 4, e_SES = 3, edu = 8, stress = 4, a_SES = 1, occ_ach = 0, age = 8, bmi = 7, stroke = 3, tbi = 2, p_act = 8, htn = 7, dm = 6, vasc = 5, depress = 1, a_cog = 9, dx = 4, soc = 2)
)
my_dag <- ggdag::dagify(dx ~ stress,
                        dx ~ a_cog, 
                        dx ~ sex,
                        dx ~ race,
                        dx ~ ApoE, 
                        dx ~ occ_ach,
                        dx ~ soc,
                        dx ~ depress,
                        dx ~ a_SES,
                        dx ~ edu, #10
                        stress ~ sex,
                        stress ~ race, 
                        stress ~ e_SES,
                        stress ~ a_SES,
                        stress ~ edu, #15
                        c_cog ~ race,
                        c_cog ~ e_SES,
                        edu ~ sex, 
                        edu ~ race, 
                        edu ~ c_cog,
                        a_SES ~ e_SES,
                        a_SES ~ occ_ach,
                        bmi ~ stress,
                        bmi ~ age,
                        bmi ~ p_act,
                        stroke ~ bmi,
                        stroke ~ htn,
                        stroke ~ age,
                        stroke ~ dm,
                        stroke ~ vasc,
                        tbi ~ age, 
                        occ_ach ~ e_SES,
                        p_act ~ age,
                        htn ~ p_act,
                        htn ~ bmi, 
                        dm ~ bmi, 
                        dm ~ p_act, 
                        vasc ~ bmi,
                        vasc ~ p_act,
                        depress ~ stress,
                        depress ~ p_act, 
                        a_cog ~ race,
                        a_cog ~ edu, 
                        soc ~ depress,
                        exposure = 'stress',
                        outcome = 'dx',
                        labels = c('dx' = 'Diagnosis of MCI / Dementia', 'stress' = 'Childhood Adversity and Stressful Life Events', 'edu' = 'Education', 'a_cog' = 'Adult Cognitive Resources', 'sex' = 'Sex', 'race' = "Race", 'ApoE' = 'ApoE Genotype', 'occ_ach' = 'Occupational Achievement', 'soc' = 'Social Engagement', 'depress' = 'Depression', 'a_SES' = 'Adult SES', 'e_SES' = 'Early Life SES', 'c_cog' = 'Childhood Cognitive Resources', 'bmi' = 'BMI', 'p_act' = 'Physical Activity', 'stroke' = 'Stroke', 'htn' = 'Hypertension', 'dm' = 'Diabetes Mellitus', 'vasc' = 'Vascular Disease Risk', 'tbi' = 'Traumatic Brain Injury'), coords = coord_dag)

ggdag::ggdag(my_dag, text = FALSE, use_labels = "label", node_size = 6, text_size = 3) +
  expand_plot() +
  theme_void()

#All the pathways between exposure and outcome
ggdag_paths(my_dag, text_col = 'black', text_size = 2, node_size = 4)

#Highlighting the direct parents of dx
ggdag_parents(my_dag, 'dx', text = FALSE, use_labels = "label", node_size = 6, text_size = 3)


#Options of minimum set needed to control for confounding
ggdag_adjustment_set(my_dag, text_col = 'black', text = FALSE, use_labels = "label", text_size = 3, node_size = 12)
```

Next I will read in the data shared by RUSH. 
```{r}
#File with repeated measures across follow up
lmap <- read_excel("dataset_1205_long_11-09-2022.xlsx", 
    col_types = c("text", "text", "numeric", 
        "text", "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"))

#File with constant measures across follow up
bmap <- read_excel("dataset_1205_basic_11-09-2022.xlsx")

```
Here I clean and rename variables in each of these datasets. I also create variables to simplify cognitive impairment diagnoses. 
```{r}
#Data cleaning for constant variables
bmap <- dplyr::rename(bmap, id = projid, consensus_cogdx = cogdx, apoe = apoe_genotype, edu = educ, marital_bl = marital_now_bl, sex = msex, race = race7, ethnicity = spanish, c_cogA = chd_cogact_freq, life_cogA = lifetime_cogact_freq_bl, a_cogA = ma_adult_cogact_freq, y_cogA = ya_adult_cogact_freq, c_cogR = cog_res_age12, a_cogR = cog_res_age40, t_cogR = tot_cog_res, e_SES = early_hh_ses, sub_SES = ladder_composite, m_edu = mateduc, p_edu = pareduc, f_edu = pateduc) %>%
  mutate(apoe = factor(apoe, levels = c(22, 23,24, 33, 34, 44), labels = c('E2E2', 'E2E3', 'E2E4', 'E3E3', 'E3E4', 'E4E4'))) %>%
  mutate(consensus_cogdx = factor(consensus_cogdx, levels = c(1, 2, 3, 4, 5, 6), labels = c('NCI', 'MCI_no_external', 'MCI_external', 'AD_no_external', 'AD_external', 'Other Dementia'))) %>%
  mutate(consensus_simple = case_when(consensus_cogdx == 'NCI' ~ 'NCI', consensus_cogdx == 'MCI_no_external' | consensus_cogdx == 'MCI_external' ~ 'MCI', consensus_cogdx == 'AD_no_external' | consensus_cogdx == 'AD_external' ~ 'AD', consensus_cogdx == 'Other Dementia' ~ 'Dementia')) %>%
  mutate(marital_bl = factor(marital_bl, levels = c(1, 2, 3, 4, 5), labels = c('Never married', 'married', 'widowed', 'divorced', 'separated'))) %>%
  mutate(sex = factor(sex, levels = c(0, 1), labels = c('Female', 'Male'))) %>%
  mutate(race = factor(race, levels = c(1, 2, 3, 4, 5, 6, 7), labels = c('white', 'black or african american', 'american indian / alaska native', 'native hawaiian / pacific islander', 'asian', 'other', 'unknown'))) %>%
  mutate(ethnicity = factor(ethnicity, levels = c(1, 2), labels = c('hispanic', 'not hispanic'))) %>%
  mutate(q40inc = factor(q40inc, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10), labels = c('0-4,999', '5,000-9,999', '10,000 - 14,999', '15,000 - 19,999', '20,000 - 24,999', '25,000 - 29,999', '30,000 - 34,999', '35,000 - 49,999', '50,000 - 74,999', '75,000+'))) %>%
  mutate(income_bl = factor(income_bl, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10), labels = c('0-4,999', '5,000-9,999', '10,000 - 14,999', '15,000 - 19,999', '20,000 - 24,999', '25,000 - 29,999', '30,000 - 34,999', '35,000 - 49,999', '50,000 - 74,999', '75,000+')))

#Data cleaning for longitudinal set
lmap <- dplyr::rename(lmap, id = projid, dx_cog = dcfdx, park = r_pd, age_vist = age_at_visit, depress = r_depres, late_cogA = late_life_cogact_freq, p_act = phys5itemsum, discrim = discrim_cnt, late_soc = late_life_soc_act, isolation = social_isolation, support = social_support, htn = hypertension_cum, dm = dm_cum, stroke = stroke_cum, vasc_burden = vasc_4dis_sum, vasc_risk = vasc_risks_sum, neg_events = neglifeevents,) %>%
  mutate(dx_cog = factor(dx_cog, levels = c(1, 2, 3, 4, 5, 6) , labels = c('NCI', 'MCI_no_external', 'MCI_external', 'AD_no_external', 'AD_external', 'Other Dementia'))) %>%
   mutate(dx_sum = case_when(dx_cog == 'NCI' ~ 'NCI', dx_cog == 'MCI_no_external' | dx_cog == 'MCI_external' ~ 'MCI', dx_cog == 'AD_no_external' | dx_cog == 'AD_external' ~ 'AD', dx_cog == 'Other Dementia' ~ 'Dementia')) %>%
  mutate(simp_cogdx = case_when(dx_cog == 'NCI' ~ 0, TRUE ~ 1)) %>%
  mutate(park = factor(park, levels = c(1, 2, 3, 4), labels = c('Highly Probably', 'Probable', 'Possible', 'Not Present'))) %>%
  mutate(depress = factor(depress, levels = c(1, 2, 3, 4), labels = c('Highly probable', 'Probable', 'Possible', 'Not present'))) %>%
  mutate(htn = factor(htn, levels = c(0, 1), labels = c('No history of HTN', 'History of HTN'))) %>%
  mutate(dm = factor(dm, levels = c(0, 1), labels = c('No history of diabetes', 'History of diabetes'))) %>%
  mutate(stroke = factor(stroke, levels = c(0, 1), labels = c('No history of stroke', 'History of stroke'))) 
```

Looking roughly at missing responses and number of subjects followed at each follow up visit.
```{r}
#Missing in baseline
colSums(is.na(bmap))
colSums(is.na(lmap))

#Looking at number of subjects present at each follow up visit
table(lmap$fu_year)
```

There is a high degree of missing in variables related to childhood adversity and income at age 40 (~17%), additionally 19% missing ApoE genoype. Total childhood adverse experience has less missing. Other measures with a high degree of missing will likely not impact my analysis such as age at death, and age at first AD diagnosis. 

Merging the datasets so I have baseline information for each subject alongside longitudinal measures. I also create a status variable at each follow up point designating whether the respondent is enrolled, deceased, or lost to follow up before the next visit. 
```{r}
#Merging the datasets 
merge_map <- merge(bmap, lmap, by = c('id'))

#How many subjects are lost to follow up across visits
merge_map <- dplyr::mutate(merge_map, years_to_death = age_death-age_vist)

merge_map <- dplyr::mutate(merge_map, death_before_next_FU = case_when(years_to_death < 1.0 ~ 1, TRUE ~ 0))

#Creating a variable that specifies if this is the last visit for a specific subject
merge_map <- dplyr::mutate(merge_map, id_next = lead(id)) %>%
  mutate(last_visit = case_when(id != id_next ~ 1, TRUE ~ 0))

merge_map <- dplyr::mutate(merge_map, status = case_when(last_visit == 0 ~ 'enrolled', last_visit == 1 & death_before_next_FU == 1 ~ 'deceased', last_visit == 1 & death_before_next_FU == 0 ~ 'LTF'))

#Creating a detailed status variable - we are not worried about LTF if the subject experienced the outcome of interest (MCI/AD/Other Dementia)

#Creating a simplified variable for cognitive diagnosis
merge_map <- dplyr::mutate(merge_map, simple_cogdx = case_when(dx_cog == 'NCI' ~ 'Absent', TRUE ~ 'Present')) %>%
  mutate(simp_cogdx = case_when(dx_cog == 'NCI' ~ 0, TRUE ~ 1))

  
merge_map <- dplyr::mutate(merge_map, status_detail = case_when(status == 'enrolled' ~ simple_cogdx, status == 'deceased' & simple_cogdx == 'Absent' ~ 'dead_absent', status == 'deceased' & simple_cogdx == 'Present' ~ 'dead_present', status == 'LTF' & simple_cogdx == 'Present' ~ 'LTF_present', status == 'LTF' & simple_cogdx == 'Absent' ~ 'LTF_Absent'))
  
#Those who are deceased/LTF absent any cognitive impairment are missing outcome information
table(merge_map$status_detail, merge_map$fu_year)

```
I am interested in the 5 year risk of MCI/AD/Dementia, so I need to filter out the follow up visits occurring past year 5. Focusing on follow up through year 5 also reduces the amount of missing outcomes due to respondent death or loss to follow up over the 24 years of follow up included in this data. I determine respondent cognitive outcome by cognitive impairment diagnosis at the fifth year of follow up. If the respondent did not have 5 years of follow up their outcome was either impairment or missing depending on whether they had a cognitive impairment diagnosis while being followed. 
```{r}
map5 <- dplyr::filter(merge_map, fu_year < 6)

#Extracting the year 5 outcome or last outcome per respondent, whichever comes first
disp5 <-  group_by(map5, id) %>% 
  slice(c(which.max(fu_year))) %>% 
  select(id, status, status_detail, simple_cogdx, dx_cog, dx_sum, simp_cogdx, fu_year)
head(disp5)

table(disp5$status_detail) 
  #this gives status on whether they were deceased/LTF before the next visit, which includes visit 6 for those who are still enrolled at visit 5

#Status variable at 5 year visit: including missing category for those w/o impairment and w/o 5 year follow up 
disp5 <- dplyr::mutate(disp5, enroll5 = case_when(fu_year < 5 ~ '0', TRUE ~ '1')) %>%
  mutate(simp_cogdx = as.character(simp_cogdx))

disp5 <- dplyr::mutate(disp5, yr_5_impairment = case_when(enroll5 == '1' & simp_cogdx == '1' ~ '1', enroll5 == '1' & simp_cogdx == '0' ~ '0', enroll5 == '0' & simp_cogdx == '1' ~ '1', enroll5 == '0' & simp_cogdx == '0' ~ NA_character_)) %>%
  mutate(yr_5_cognitive_dx = case_when(enroll5 == '1' ~ dx_sum, enroll5 == '0' & simp_cogdx == '1' ~ dx_sum, enroll5 == '0' & simp_cogdx == '0' ~ NA_character_))

```
Merging 5 year outcome information with the baseline file to get outcomes and data on childhood adversity together.
```{r} 
#merging outcomes at last visit with bmap file
bmap_out <- dplyr::left_join(bmap, disp5, by = 'id')

```

Using the mice package for multiple imputation to address problems with missing data. 
```{r}
#Determining percent missing across the data
p_missing <- unlist(lapply(bmap_out, function(x) sum(is.na(x))))/nrow(bmap_out)
sort(p_missing[p_missing >0], decreasing = TRUE)

#Removing variables with percent missing greater than 30% from the dataset, those collinear with the variable of interest, and those I created
mice:::find.collinear(bmap_out)

bmap_imp <- dplyr::select(bmap_out, -c(age_first_ad_dx, sub_SES, consensus_cogdx, consensus_simple, age_death, simp_cogdx, yr_5_cognitive_dx, simple_cogdx, dx_sum, dx_cog, enroll5, status, status_detail)) %>% mutate(yr_5_impairment = as.factor(yr_5_impairment))

#Viewing mice-specified distributions for variables to be imputed
imp <- mice(bmap_imp, maxit=0)
predM <- imp$predictorMatrix
meth <-imp$method

meth

#Multiple imputation
imp2 <- mice(bmap_imp, maxit = 3, #will increase this later
             predictorMatrix = predM,
             method = meth, print = FALSE)

#Viewing imputation for the outcome variable
tail(imp2$imp$yr_5_impairment)

bmap_imp1 <- mice::complete(imp2, 1)

```

Next I prepare a longitudinal dataframe for modeling with Cox Proportional Hazards
```{r}
#Missing for the longitudinal data 
test <- dplyr::group_by(lmap, id)
p_missing1 <- unlist(lapply(test, function(x) sum(is.na(x))))/nrow(lmap)
sort(p_missing1[p_missing1 >0], decreasing = TRUE)

#Need to code an outcome/status variable NCI, CI, deceased/LTF
merge_map <- dplyr::mutate(merge_map, status2 = case_when(status == 'enrolled' ~ 1, status != 'enrolled' ~ 0)) %>%
                           mutate(outcome = case_when(status2 == 1 & simp_cogdx == 1 ~ 1, status2 == 1 & simp_cogdx == 0 ~ 0, TRUE ~ 2))

merge_map$outcome <- as.factor(merge_map$outcome)

#Outcome with only 2 levels (competing risk as missing)
merge_map <- dplyr::mutate(merge_map, outcome2 = case_when(outcome == 0 ~ 0, outcome == 1 ~ 1, outcome ==2 ~ NaN))

#Creating an end time variable
merge_map <- dplyr::mutate(merge_map, time2 = fu_year + 1)


```


# Results
***

## Summary Statistics 

```{r}
#Descriptive Summary of Constant Characteristics
    #This is split by dx_sum which is the last cognitive diagnosis a person received either at year 10 or before they died / LTF - need to deal with missing data for those that did not reach year 10
table(bmap_out$yr_5_impairment)
table(bmap_out$yr_5_cognitive_dx)



#Demographics etc
bmap_out %>% dplyr::select(-c(id, dx_sum, dx_cog, consensus_cogdx, study, income_bl, e_SES, sub_SES, q40inc, emotional_neglect, family_pro_sep, financial_need, parental_intimidation, parental_violence, tot_adverse_exp, c_cogA:t_cogR, income_bl:q40inc)) %>%
  tbl_summary(by = yr_5_impairment, statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} / {N} ({p}%)"), digits = all_continuous() ~ 2, missing_text = "Missing") %>%
  modify_caption("**Demographic and Baseline Characteristics by 5 Year Cognitive Impairment**") %>%
  add_overall() %>%
  bold_labels()

#Variables related to cognitive resilience
bmap_out %>% dplyr::select(yr_5_impairment, edu, c_cogA, life_cogA, a_cogA, y_cogA, c_cogR:t_cogR, e_SES, income_bl, m_edu, f_edu, p_edu, q40inc) %>%
  gtsummary::tbl_summary(by = yr_5_impairment, statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n}, / {N} ({p}%)"), digits = all_continuous() ~ 2, missing_text = "Missing") %>%
  modify_caption("**Cognitive Resilience Characteristics by 5 Year Cognitive Impairment**") %>%
  add_overall() %>%
  bold_labels()

#Descriptive of adverse experience vs outcome
ggplot(data = subset(bmap_out, !is.na(emotional_neglect) & !is.na(yr_5_impairment)), aes(x = yr_5_impairment, fill = factor(emotional_neglect))) +
    geom_bar(position = "dodge") +
  labs(title = "Childhood Emotional Neglect by 5 Year Cognitive Impairment", x = "5 Year Cognitive Impairment", y = "Count", fill = "Emotional Neglect") +
  theme_bw()

ggplot(data = subset(bmap_out, !is.na(family_pro_sep) & !is.na(yr_5_impairment)), aes(x = yr_5_impairment, fill = factor(family_pro_sep))) +
    geom_bar(position = "dodge") +
  labs(title = "Childhood Family Separation by 5 Year Cognitive Impairment", x = "5 Year Cognitive Impairment", y = "Count", fill = "Family Separation") +
  theme_bw()

ggplot(data = subset(bmap_out, !is.na(financial_need) & !is.na(yr_5_impairment)), aes(x = yr_5_impairment, fill = factor(financial_need))) +
    geom_bar(position = "dodge") +
  labs(title = "Childhood Financial Need by 5 Year Cognitive Impairment", x = "5 Year Cognitive Impairment", y = "Count", fill = "Financial Need") +
  theme_bw()


ggplot(data = subset(bmap_out, !is.na(parental_intimidation) & !is.na(yr_5_impairment)), aes(x = yr_5_impairment, fill = factor(parental_intimidation))) +
    geom_bar(position = "dodge") +
  labs(title = "Childhood Parental Intimidation by 5 Year Cognitive Impairment", x = "5 Year Cognitive Impairment", y = "Count", fill = "Parental Intimidation") +
  theme_bw()

ggplot(data = subset(bmap_out, !is.na(parental_violence) & !is.na(yr_5_impairment)), aes(x = yr_5_impairment, fill = factor(parental_violence))) +
    geom_bar(position = "dodge") +
  labs(title = "Childhood Parental Violence by 5 Year Cognitive Impairment", x = "5 Year Cognitive Impairment", y = "Count", fill = "Parental Violence") +
  theme_bw()

#Box plot for summary measure of childhood adversity
ggplot(data = bmap_out, aes(yr_5_impairment, tot_adverse_exp)) +
    geom_boxplot(color = "blue", fill = "blue", alpha = 0.2, width = 0.2) +
    geom_violin(colour = "lightblue", fill = "lightblue", alpha = 0.7) +
  labs(title = "Childhood Adversity by 5 Year Cognitive Impairment", x = "5 Year Cognitive Impairment", y = "Childhood Adversity") +
  theme_bw()




```

```{r}
#Descriptive Summary of Longitudinal Characteristics


```

## Summary stats on outcomes

## Building Regression Models

```{r}
#Logistic regression for childhood adversity and any MCI/AD/Dementia - ignoring missing for now, will update later
#Use simple_cogdx

#Unadjusted model
summary((glm(factor(simp_cogdx) ~ tot_adverse_exp, data = bmap_out, family = binomial())))

#Adjusted model

#logisic regression on the imputed set 
fitimp <- with(imp2, glm(yr_5_impairment ~ tot_adverse_exp, family = binomial()))

summary(pool(fitimp))

#Potentially using mipred package to do k-fold cross validation with multiple imputation - need to explore this a little more
#install.packages('remotes')
#remotes::install_github("BartJAMertens/mipred")
library(mipred)

#output <- mipred.cv(yr_5_impairment ~ tot_adverse_exp, family=binomial, data = bmap_imp, nimp = 2, folds = 3, mice.options = list(predictorMatrix = predM, method = meth, print = FALSE))

#head(output)

```

```{r}
#Kaplan Meier Curve: Cognitive Impairment Free survival

survfit(formula = (Surv(merge_map$fu_year, merge_map$time2, merge_map$outcome2) ~ merge_map$apoe)) %>%
  ggsurvfit() +
  labs(x = "Years of Follow Up", y = "Survival Probability", title = "Cognitive Impairment Free Survival by ApoE Genotype") +
  add_confidence_interval()

```



```{r}
#Survival without competing risks
cfit <- coxph(Surv(fu_year, time2, outcome2) ~ neg_events, id = id, merge_map)
cph.pred <- predict(cfit, data = merge_map, type = 'risk')
head(cbind(merge_map$outcome2, cph.pred)) #problem here with vectors being different lengths

print(cfit, digits = 1)

summary(cfit)

#K-fold Cross Validation
N = nrow(merge_map)
K = 10
set.seed(1234)
s = sample(1:K, size = N, replace = T)
pred.outputs.cph <- vector(mode = "numeric", length = N)
obs.outputs <- vector(mode = "numeric", length = N)
offset <- 0
for (i in 1:K) {
  train <- filter(merge_map, s !=i)
  test <- filter(merge_map, s == i)
  obs.outputs[1:length(s[s == i]) + offset] <- test$outcome2
  
  cfit <- coxph(Surv(fu_year, time2, outcome2) ~ neg_events, id = id, merge_map)
  cph.pred.curr <- predict(cfit, data = test, type = 'risk')
  pred.outputs.cph[1:length(s[s == i]) + offset] <- cph.pred.curr
  
  offset <- offset + length(s[s == i])
}

head(cbind(pred.outputs.cph, obs.outputs))
```

```{r}
#Cox Model with competing risk - pre cross validation
cfit <- coxph(Surv(fu_year, time2, outcome) ~ neg_events, id = id, merge_map)
cph.pred <- predict(cfit, data = merge_map, type = 'risk')
head(cbind(merge_map$outcome, cph.pred)) #problem here with vectors being different lengths

print(cfit, digits = 1)

summary(cfit)

#K-fold Cross Validation
N = nrow(merge_map)
K = 10
set.seed(1234)
s = sample(1:K, size = N, replace = T)
pred.outputs.cph <- vector(mode = "numeric", length = N)
obs.outputs <- vector(mode = "numeric", length = N)
offset <- 0
for (i in 1:K) {
  train <- filter(merge_map, s !=i)
  test <- filter(merge_map, s == i)
  obs.outputs[1:length(s[s == i]) + offset] <- test$outcome
  
  cfit <- coxph(Surv(fu_year, time2, outcome) ~ neg_events, id = id, merge_map)
  cph.pred.curr <- predict(cfit, data = test, type = 'risk')
  pred.outputs.cph[1:length(s[s == i]) + offset] <- cph.pred.curr
  
  offset <- offset + length(s[s == i])
}

head(cbind(pred.outputs.cph, obs.outputs))

```

```{r}
#Plotting ROC curves for the different models 
library(pROC)
plot.roc(obs.outputs, pred.outputs.cph)
#plot.roc(merge_map$outcome, cph.pred, na.rm = TRUE) 
  #vectors different lengths

```



# Conclusions

# References
***
>1.	Matthews KA, Xu W, Gaglioti AH, et al. Racial and ethnic estimates of alzheimer's disease and related dementias in the united states (2015-2060) in adults aged â‰¥65 years. Alzheimers Dement. 2019;15(1):17-24. Accessed Oct 6, 2022. doi: 10.1016/j.jalz.2018.06.3063.
2.  Rajan KB, Weuve J, Barnes LL, McAninch EA, Wilson RS, Evans DA. Population estimate of people with clinical Alzheimer's disease and mild cognitive impairment in the United States (2020-2060). Alzheimers Dement. 2021;17(12):1966-1975. doi:10.1002/alz.12362
3.	Wimo A, Guerchet M, Ali G, et al. The worldwide costs of dementia 2015 and comparisons with 2010. Alzheimers Dement. 2017;13(1):1-7. Accessed Oct 6, 2022. doi: 10.1016/j.jalz.2016.07.150.
4. Brookmeyer R, Johnson E, Ziegler-Graham K, Arrighi HM. Forecasting the global burden of alzheimer's disease. Alzheimers Dement. 2007;3(3):186-191. Accessed Oct 6, 2022. doi: 10.1016/j.jalz.2007.04.381.
5.	Schneider JA, Aggarwal NT, Barnes L, Boyle P, Bennett DA. The neuropathology of older persons with and without dementia from community versus clinic cohorts. J Alzheimers Dis. 2009;18(3):691-701. Accessed Oct 5, 2022. doi: 10.3233/JAD-2009-1227.
6.	Stern Y. Cognitive reserve. Neuropsychologia. 2009;47(10):2015-2028. Accessed Oct 6, 2022. doi: 10.1016/j.neuropsychologia.2009.03.004.
7.	Fay TB, Yeates KO, Taylor HG, et al. Cognitive reserve as a moderator of postconcussive symptoms in children with complicated and uncomplicated mild traumatic brain injury. J Int Neuropsychol Soc. 2010;16(1):94-105. Accessed Oct 6, 2022. doi: 10.1017/S1355617709991007.
8.	Poletti M, Emre M, Bonuccelli U. Mild cognitive impairment and cognitive reserve in parkinson's disease. Parkinsonism Relat Disord. 2011;17(8):579-586. Accessed Oct 6, 2022. doi: 10.1016/j.parkreldis.2011.03.013.
9.  Aiello Bowles EJ, Crane PK, Walker RL, et al. Cognitive Resilience to Alzheimer's Disease Pathology in the Human Brain. J Alzheimers Dis. 2019;68(3):1071-1083. doi:10.3233/JAD-180942
10.	 Wilson RS, Scherr PA, Schneider JA, Tang Y, Bennett DA. Relation of cognitive activity to risk of developing alzheimer disease. Neurology. 2007;69(20):1911-1920. Accessed Oct 5, 2022. doi: 10.1212/01.wnl.0000271087.67782.cb.
11.	Bennett DA, Wilson RS, Schneider JA, et al. Education modifies the relation of AD pathology to level of cognitive function in older persons. Neurology. 2003;60(12):1909-1915. Accessed Oct 5, 2022. doi: 10.1212/01.wnl.0000069923.64550.9f.
12.	MejÃ­a S, Giraldo M, Pineda D, Ardila A, Lopera F. Nongenetic factors as modifiers of the age of onset of familial alzheimer's disease. Int Psychogeriatr. 2003;15(4):337-349. Accessed Oct 5, 2022. doi: 10.1017/s1041610203009591.
13.	Bale TL, Baram TZ, Brown AS, et al. Early life programming and neurodevelopmental disorders. Biol Psychiatry. 2010;68(4):314-319. Accessed Oct 5, 2022. doi: 10.1016/j.biopsych.2010.05.028.
14.	Sierksma ASR, Prickaerts J, Chouliaras L, et al. Behavioral and neurobiological effects of prenatal stress exposure in male and female APPswe/PS1dE9 mice. Neurobiol Aging. 2013;34(1):319-337. Accessed Oct 5, 2022. doi: 10.1016/j.neurobiolaging.2012.05.012.
