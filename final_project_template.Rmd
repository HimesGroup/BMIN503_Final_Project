---
title: "Indicators of Wound Complication Risk in Patients with Thoracic Insufficiency Syndrome"
author: "Lia McNeely, CRNP"
output: 
  html_document:
    toc: true 
    depth: 3 
    theme: paper 
    highlight: tango
editor_options: 
  chunk_output_type: console
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
```{r eval=TRUE}
#load all libraries needed to complete data cleaning and analysis
library(tidyverse)
library(GGally)
library(ggdendro)
library(randomForest)
library(glmnet)
library(pROC)
library(boot)
library(childsds)
library(lubridate)


```
### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.
### Overview:
The Center for Thoracic Insufficiency Syndrome (CTIS) at the Childrenâ€™s Hospital of Philadelphia (CHOP) treats patients who have early onset scoliosis and associated compromised growth of the thoracic cavity.  An article currently in review for publication, attempted to determine if there are risk factors that are predictive for wound related complications for patients undergoing implantation of rib-based distraction devices.  Many patients with wound complications, however, are patients undergoing the serial expansions of their rib-based distraction after the initial implantation.  The purpose of this project is to do an exploratory analysis of data from the Patient Safety Registry of the Center for Thoracic Insufficiency Syndrome to determine whether or not risk factors can be identified for wound complications in patients with early onset scoliosis undergoing serial rib distraction expansions. If a risk factor can be identified, then we may begin using this in clinical care as part of an informatics project we are working on for the CTIS program.

### Introduction 
In the first paragraph, describe the problem addressed, its significance, and some background to motivate the problem.

In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.


### Introduction:
The vertical elastic prosthetic titanium rib (VEPTR) is a rib-based distraction device that was invented by the late Dr. Robert Campbell, in the late 1980s.  Dr. Campbell came to the Children's Hospital of Philadelphia in 2008 to start a center for patients with Thoracic Insufficiency Syndrome.  He developed an intradisciplinary team of orthopaedic surgeons, pulmonologists, general surgeons, neurosurgeons, radiologists, and researchers to help treat patients with severe Early Onset Scoliosis (EOS).  He theorized that EOS, particularly severe EOS, led to a decrease in the body's ability to develop normal lung capacity. By providing strutural support that could both maintan, or even grow, the thoracic cavity and keep progressive scoliosis in check, Dr. Campbell's device has helped thousands of children around the world.  Unfortunately, due to the recurrent nature of the surgery for lengthenings, and the structure of the device in relation to the patients chest wall, patients with VEPTR are at an increased risk of complications including surgical site infections (SSI), skin slough, and hardware failure. In order to track his complication rates, Dr. Campbell started a prospective patient safety registry.  This registry contains at last some data on all of his patient's surgeries and any complications that arose.  

For many in orthopaedic surgery, predicting which patients are at risk for complication is increasingly important in an era of medicine that involves shared decision making with patients and families.  This project will attempt to determine whether or not a risk factor can be identified for patients with EOS that might predict whether or not a patient is at risk for a complication during the 90 days post-op from a serial expansion surgery. To begin the project, I reviewed some of the current literature and met with Dr. Patrick Cahill at CHOP. Dr. Cahill took over for Dr. Campbell as the director of the Center for Thoracic Insufficiency Syndrome upon the death of Dr. Campbell in July 2018. Dr. Cahill recommended I focus on complications after expansions since his team had already reviewed and were about to publish on the risk factors for complications after initial implant of the device.  I then met with Dr. Jeffery Pennington and Joy Payton.  Dr. Pennington is the Chief Informatics officer for the Department of Biomedical and Health Informatics at CHOP, and Joy Payton runs the education group within the DBHI that is helping to connect clinicians with their data through the ARCUS program at CHOP.  Finally, I met with Dr. John Holmes regarding the heterogenity of the patients within the data set. 


### Methods
The data for this project was retrieved from the CTIS Patient Safety Registry and the CHOP Data Warehouse (CDW). Since the CTIS registry is known to be missing a signficant amount of data, in order to get a more complete dataset, I asked a data analyst within the DBHI to retrieve a dataset using SQL queries from the CDW with some of the same variables to try and create a more complete dataset. Since a significant amount of the data in the registry is not captured discretely in the EHR, however, the data analyst would not have been able to retrieve the entire data set, and thus the registry data was still used. To retrieve the CTIS data, a report was created in REDCap that incorporated 166 variables from the over 700 variables found within the registry.  Using domain knowledge, the variables were narrowed down based on potential clinical relevance.  Patients were immediately excluded if they did not have data for a birthdate, gender, or were not treated surgically.  The initial CTIS dataset contained 2,626 observations of 166 variables.  The CDW data came to me in multiple tables.  The primary CDW table contained 1,945 observations of 16 variables.  

In order to create a master table that contained all of the data that I wanted for this project, I first imported the CDW tables and then the CTIS tables.  I adjusted the columns containing dates and times using the "lubridate"" package, and then selected columns I needed from the various tables.  The Data Dictionary for the REDCap database was used to rename factor variables with the correct terms and columns were renamed to improve the readibility of the table.  Since the CDW data only went back as far as May 2013, I excluded all patients prior to May 1, 2013, and then joined the CTIS demographic data to the CDW surgery data based on both the patient id and the surgery date.  Once the CDW Surgery and CTIS Demographics and Surgery tables were combined, I excluded procedures where there was no data on ASA classification, weight on the day of surgery, or Asssisted Ventilation Rate (AVR).  I also removed variables where there was less than 50% of the data present in the column.  At this point, I had 1,204 observations of 92 variables.   


```{r Bringing in Initial Datasets}
#CDW Surgery Data
Surgery1 <- read_csv("demog_implantsx.csv") %>% 
    mutate(PAT_MRN_ID = as.integer(PAT_MRN_ID)
           , BIRTH_DATE = dmy(BIRTH_DATE)
           , SURGERY_DATE = dmy(SURGERY_DATE)
           , PAT_IN_ROOM_DATETIME_FMT = mdy_hm(PAT_IN_ROOM_DATETIME_FMT)
           , PAT_OUT_ROOM_DATETIME_FMT = mdy_hm(PAT_OUT_ROOM_DATETIME_FMT)
           , HOSP_ADMSN_TIME = dmy(HOSP_ADMSN_TIME)
           , HOSP_DISCH_TIME = dmy(HOSP_DISCH_TIME)
           , SURG_LINE = as.integer(SURG_LINE)) %>% 
     select(patid = PAT_MRN_ID, BIRTH_DATE, GENDER, PATIENT_STATUS, RACE, ETHNICITY, OR_PROC_ID, SURG_LINE, SURGERY_DATE, CPT_CODE, PROC_NAME, PRIMARY_PROV_NAME, IN_RM = PAT_IN_ROOM_DATETIME_FMT, OUT_ROOM = PAT_OUT_ROOM_DATETIME_FMT, HOSP_ADMSN_TIME, HOSP_DISCH_TIME) 

#CDW data on Ambulatory Status at the time of each surgery
Ambulatory_status <- read_csv("ambulation_status.csv") %>% 
    mutate(PAT_MRN_ID = as.integer(PAT_MRN_ID)
           , SURGERY_DATE = dmy(SURGERY_DATE)
           , DATE_OF_SERVICE_FMT = mdy_hm(DATE_OF_SERVICE_FMT)) %>% 
    select(patid = PAT_MRN_ID, SURGERY_DATE, AMBULATION_STATUS)

#CDW data on whether or not a patient went on to have an Incision and Debridement procedure for a complication
ID_proc <- read_csv("ID_proc.csv") %>% 
    mutate(PAT_MRN_ID = as.integer(PAT_MRN_ID)
           , SURGERY_DATE = dmy(SURGERY_DATE)
           , CPT_CODE = as.integer(CPT_CODE)
           , SURG_LINE = as.integer(SURG_LINE)) %>% 
    select(patid = PAT_MRN_ID, SURG_LINE_ID = SURG_LINE, SURGERY_DATE_ID = SURGERY_DATE, OR_PROC_ID_ID = OR_PROC_ID, CPT_CODE_ID = CPT_CODE, PROC_NAME_ID = PROC_NAME, PRIMARY_PROV_NAME_ID = PRIMARY_PROV_NAME)

#Initial pull of the CTIS data
Ctis_initial <- read_csv("CTISFinalProjectData2018.csv") %>% 
     mutate(patid = as.integer(patid)
            , surg_dt_1 = mdy(surg_dt_1)
            , demog_dob = mdy(demog_dob)
            , adm_admit_date_1 = mdy(adm_admit_date_1)
            , adm_dc_date_1 = mdy(adm_dc_date_1)
            , surg_timeinor_1 = hm(surg_timeinor_1)
            , surg_timeofinc_1 = hm(surg_timeofinc_1)
            , surg_time_proc_end = hm(surg_time_proc_end)
            , surg_timeout_1 = hm(surg_timeout_1)
            , trk_days_after = mdy(trk_days_after)
            , anti_start = mdy(anti_start)
            , tl_caseinf = as.factor(tl_caseinf)
            , tl_inf = as.factor(tl_inf)
            , tl_pod_ssi = as.numeric(tl_pod_ssi)
            , trk_days_after = mdy(trk_days_after)
            , char_trach_cann = mdy(char_trach_cann)
            , char_trach_decan = mdy(char_trach_decan)) %>% 
    mutate_if(is.character, as.factor)

dd <- Ctis_initial %>% 
    select(patid, trk_days_after) #for some reason the data that is in the column isn't coming into r

#since mutliple variables are not in every row due to the nature of the data coming out of the REDCap, the following code will set us up to help us bring them back in later.    

get_spinal_class <-
    Ctis_initial %>% 
    distinct(patid, char_spinal_class_def) %>% 
    filter(complete.cases(.)) %>% 
    mutate(char_spinal_class_def = factor(char_spinal_class_def, levels = c(0,1,2,3,4,5,6,8,7), labels =  
            c("Idiopathic"
              , "Syndromic"
              , "Neuromuscular Low Tone"
              , "Neuromuscular High Tone"
              , "Congenital/Structural" 
              , "Kyphosis"
              , "Lordosis"
              , "Other"
              , "None")))

#Join the spinal class column to the CDW surgery dataframe so that we have the spinal class for each patient.
Surgery2 <- Surgery1 %>% 
    left_join(get_spinal_class) %>% 
    group_by(patid)

```

```{r Demographic Data}
#Using the REDCap registry data, I created a data frame with each patient's ID number and selected the columns that include demographic and diagnosis information on each patient
Ctis_demog1 <- Ctis_initial %>%
    mutate(char_nmd_des = factor(char_nmd_des, levels = c(0,18,2,4,5,6,8,9,10,12,14,16,19,17,20,50), labels = c("None"
            , "Arthrogyposis"
            , "Cerebral palsy"
            , "Muscular dystrophy"
            , "Duchenne muscular dystrophy"
            , "Spina bifida"
            , "SMA Type 1"
            , "SMA Type 2" 
            , "SMA Type 3"
            , "Spinal-bulbar muscular atrophy" 
            , "Myasthenic syndrome"
            , "Nemaline myopathy"  
            , "Syndromic hypotonia"
            , "Suspected but unknown"
            , "Acquired" 
            , "Other"))) %>% 
    select(patid, demog_dob, demog_english, res_facility = lg_term_res, skill_nursing = test_skrn, demog_mort_stat,demog_gender, demog_country, demog_state
           , Spine_class = char_spinal_class_def
           , Central_Core_myo = trkr_prim_diag___0 
           , Cong_Hered_MuscDys = trkr_prim_diag___1
           , Cong_Scoli = trkr_prim_diag___2
           , Fused_ribs = trkr_prim_diag___3
           , Hemi_vertebrae = trkr_prim_diag___4
           , Kyphoscoliosis = trkr_prim_diag___5
           , Neuro_kypho_scoli = trkr_prim_diag___6
           , Neuromuscular_scoli = trkr_prim_diag___7
           , Prog_Inf_Idio_scoli = trkr_prim_diag___8
           , Rib_agenesis = trkr_prim_diag___9
           , Kyphosis = trkr_prim_diag___10
           , SMA = trkr_prim_diag___11
           , Syndromic_scoli = trkr_prim_diag___12
           , Hypoplastic_thorax = trkr_prim_diag___13
           , Other = trkr_prim_diag___100
           , cardiac
           , No_MDRO = mdro___0
           , MRSA = mdro___1
           , MSSA = mdro___2
           , VRE = mdro___3
           , Pulm_hypertension = dx_of_pulmonary_hypertensi
           , Poor_cover = char_prtis
           , Neuromuscular_dx = char_nmd_des
           , Hemivertebrae = ortho_prim_hemi_vertebra
           , Fusedribs = ortho_prim_fused_ribs
           , Hypothorax = ortho_prim_hypo_thorax
           , Kyphoscoli = ortho_prim_kyphoscoliosis
           , Pelvic_oblique = ortho_prim_pelv_obliq
           , Ribagenesis = ortho_prim_rib_agenesis
           , Syndrome = surg_synd_yesno
           , Broncho_pulm_dysp = secon_dx_bpd
           , Cervical_stenosis = secon_dx_cerv_steno
           , Cor_pulmonalae = secon_dx_cor_pulmon
           , Develop_delayRC = secon_dx_devel_delay
           , Diaphram_hernia = secon_dx_diaphram_hernia
           , Reflux = secon_dx_gastro_reflux
           , Heart_anomaly = secon_dx_heart_anatom
           , Neurogenic_bld = secon_dx_neurogen_bladder
           , Omphalocele = secon_dx_omphalocoele
           , CNS_anomaly = secon_dx_struc_cns
           , Torticollis = secon_dx_torticollis
           , Tracheosphfist = secon_dx_tef
           , MRSA_hx = demog_mrsahx
           , MRSA_current = demog_mrsacurr
           , Airway_abnorm = secon_dx_air_abnorm
           , Cannulated = char_trach_cann
           , Decannulated = char_trach_decan
           ) %>%
    distinct() 
Ctis_demog_final <- Ctis_demog1[!is.na(Ctis_demog1$demog_dob), ]

#Joined the surgery dataframe from the CDW with the CTIS dataframe from the registry.  
Ctis_Surgery_comb <- Surgery2 %>% 
    left_join(Ctis_demog_final) %>% 
    group_by(patid)


``` 

```{r Surgery Data}
#This joins the above cleaned data frames with the data from the registry that involes how long patients are on antibiotics post-op and whether or not there was a wound concern after the surgery along with some details about the wound concern.
CTIS_CDW_combined <- Ctis_initial %>%
    select(patid
           , Discharge_AVR = adm_avr_dc
           , SURGERY_DATE = surg_dt_1
           , Primary_procedure = surg_proc_1
           , Surgery_site = surg_proc_1_site
           , ASA = surg_asa
           , Weight_DOS = surg_wgt_1
           , Diapered = surg_diapers
           , Gtube = surg_pre_rf_gtube
           , Tracheostomy = surg_pre_rf_trach
           , MRSA_hxDOS = surg_pre_rf_mrsa_hist
           , MRSA_curDOS = surg_pre_rf_mrsa_active
           , Preadmit4wk = surg_pre_rf_admin_4week
           , Weight_und_5th = surg_pre_rf_underweight
           , Day_wound_noted = trk_days_after
           , Abx_started = anti_start
           , CDC_confirm = tl_inf
           ) %>% 
    left_join(Ctis_Surgery_comb) %>% 
    group_by(patid, SURGERY_DATE) %>% 
    mutate(Surgery_site = factor(Surgery_site, levels = c(0,2,4,6), labels = c("Bilateral", "Left", "Right", "Center"))
        , Primary_procedure = factor(Primary_procedure, levels = c(0,1,2,3,4,5,6,7,8,10,11,12,13,14,15,16,20,22,26,28,29,30,31,38,39,40,41,98,100), labels =
        c("VEPTR Implant Virgin Chest"                                                                  
            ,"MAGEC VEPTR Implant Virgin Chest"
            ,"New Full VEPTR Implant"
            , "New Full MAGEC VEPTR Implant"
            , "VETPR Expansion"
            , "Clinic MAGEC VEPTR Expansion"
            , "VEPTR Revision/Reinsert/Removal"
            , "MAGEC VEPTR Revision/Removal"
            , "MAGEC VEPTR Expansion Surg"
            , "GR Placement"
            , "MAGEC- GR Placement"
            , "GR Expansion"
            , "Clinic MAGEC GR Expansion"
            , "GR Revision"
            , "MAGEC GR Revision"
            , "I & D"
            , "Aborted procedure"
            , "Delayed primary closure"
            , "Exploration"
            , "General surgical procedure"
            , "MAGEC GR Expansion surgery"
            , "Other Orthopaedic Procedure"
            , "ENT procedure"
            , "Pre-Orthopaedic Procedure"
            , "Full Spine fusion"
            , "Plastic Surgery Closure"
            , "Partial Spine Fusion"
            , "Expansion Thoracoplasty"
            , "Other")))

CTIS_CDW_combined2013 <- CTIS_CDW_combined %>% 
    group_by(patid) %>% 
    filter(SURGERY_DATE >= "2013-5-1") %>% 
    arrange(SURGERY_DATE) %>% 
    mutate(ord = row_number()) %>% 
    ungroup()

CTIS_combo2013 <- CTIS_CDW_combined2013 %>% 
    mutate(Age_on_DOS = as.numeric(difftime(SURGERY_DATE, BIRTH_DATE, units = "days")/365.25 * 12)
               , Time_in_OR = as.numeric(difftime(OUT_ROOM, IN_RM, units = "mins"))
               , Admit_LOS = as.numeric(difftime(HOSP_DISCH_TIME, HOSP_ADMSN_TIME, units = "mins"))
           , Wound_days_postop = as.numeric(difftime(Day_wound_noted, SURGERY_DATE, units = "mins"))) %>% 
    filter(Discharge_AVR != "NA", Weight_DOS != "NA", ASA != "NA")
#Discharge AVR, Weight_DOS, and ASA are all items that I wanted to be sure that I had complete data on.  This lowered the number of procedures from 2133 to 1204 observations, however.
    
```
Upon further review of the data, there was still a significant amount of missing data.  Rather than review the data in R, I wrote a new .csv file using "write_csv" and downloaded the data in order to review the missingness of the data. For the vast majority of the diagnosis and comorbidity variables, there was about 40% of the data missing.  Since all of these columns had the option of "unknown" within the data dictionary for the CTIS registry, and no procedure contained an "unknown" for any of the variables, I decided to replace the null values in the data with "unknown."  I then further excluded patients who did not have any data for MRSA history or current, there was no data on developmental delay, and no data on whether or not the patient's family spoke english as these were all variables that are were thought to contribute to patient wound complication risk. I then imported the data set back into r, and re-cleaned the data to make sure that dates and factors were there as appropriate so that I could set myself up for my statistical analysis.  At this time, I also filtered the data for patients who had a VEPTR Expansion as their procedure.  This left me with 571 procedures on 151 patients.  There was a significant range in the number of expansion procedures these patients had undergone.  The max was 9, the min was 1, and the mean was 3.78 while the median was 3.  Of the 571 procedures, 50 procedures went on to require antibiotics within 90 days of the surgery.  The 50 procedures that went on to require antibiotics included 44 unique patients. One patient accounted for 3 procedures, four patients accounted for 2 procedures, and the remainder of the patients were represented only once in the data.  

```{r Patients with Wound Concerns}

#In order to do a principle component analysis of the variables that could be indicative of risk for wound complications, I needed make sure the the character variables are numeric or integer, or factor, and then run and visualise the PCA. 

CTIS_CDW <- read_csv("CTIS_combo2013.csv") %>% 
    mutate(SURGERY_DATE = mdy(SURGERY_DATE)
           , BIRTH_DATE = mdy(BIRTH_DATE)
           , IN_RM = mdy_hm(IN_RM)
           , OUT_ROOM = mdy_hm(OUT_ROOM)
           , HOSP_ADMSN_TIME = mdy(HOSP_ADMSN_TIME)
           , HOSP_DISCH_TIME = mdy(HOSP_DISCH_TIME)) %>% 
    mutate_if(is.character, as.factor) %>% 
    filter(PROC_NAME == "VEPTR, EXPANSION")

Dist_patid <- CTIS_CDW %>% 
    group_by(patid) %>% 
    summarize(count=n()) %>% 
    ungroup()

Dist_patid %>% 
    summarise(max = max(count)
              , min = min(count)
              , mean = mean(count)
              , median = median(count))

Abx_needed <- CTIS_CDW %>% 
    filter(Abx_started == 1)

Dist_patid_abx <- Abx_needed %>% 
    group_by(patid) %>% 
    summarize(count=n()) %>% 
    ungroup()

Dist_patid_abx %>% 
    summarise(max = max(count)
              , min = min(count)
              , mean = mean(count)
              , median = median(count))

```
Since the variables are a mix of categorical and continuous data, principle component analysis was not possible over the entire data set. I performed a PCA on the continuous variables of Weight on DOS, Age on DOS, Time in OR, and Admission length of stay.  


```{r}
#PCA analysis with all of the patients
CTIS_CDW_numeric <- CTIS_CDW %>% 
    select(Weight_DOS, Age_on_DOS, Time_in_OR, Admit_LOS)

CTISCDW_PCA <- prcomp(CTIS_CDW_numeric, center = TRUE, scale. = TRUE)
summary(CTISCDW_PCA)

#PCA analysis with only the patients who required anitbiotics
CTIS_CDW_numeric_abx <- Abx_needed %>% 
    select(Weight_DOS, Age_on_DOS, Time_in_OR, Admit_LOS)

CTISCDW_PCA <- prcomp(CTIS_CDW_numeric_abx, center = TRUE, scale. = TRUE)
summary(CTISCDW_PCA)

lapply(DF, levels)

t.test(CTIS_CDW$Time_in_OR~CTIS_CDW$Abx_started)


CTISCDW_expnodates <- CTIS_CDW %>% 
    select(-SURGERY_DATE, -BIRTH_DATE, -IN_RM, -OUT_ROOM, -HOSP_ADMSN_TIME, -HOSP_DISCH_TIME, - demog_dob, -demog_country, -demog_state) 


p.values <- numeric()
var <- colnames(CTISCDW_expnodates)[1:84]
for (i in 2:ncol(CTISCDW_expnodates)){
    x = as.numeric(CTISCDW_expnodates$Abx_started)
    y = CTISCDW_expnodates[[i]]
    p.values[i] = t.test(y~x)$p.value
}
cbind(var[p.values<0.05], p.values[p.values<0.05])


#At this time I exported the data to a csv file "CTIS_combo2013.csv" and reviewed the missing data.  Where I knew 
CTISCDW_PCA <- prcomp(CTISCDW_nodates, center = TRUE, scale. = TRUE)
summary(CTISCDW_PCA)



Cor_data <- CTIS_combo2013 %>% 
    select(ASA, Diapered, Gtube, Tracheostomy, MRSA_hxDOS, MRSA_curDOS, Preadmit4wk, Weight_und_5th, )
corr_matrix <-cor()
round(corr_matrix, 2)

```
### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required. 

#I'm not far enough along in my analysis to have any results at this time.
