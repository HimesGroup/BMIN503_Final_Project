---
title: "BMIN503/EPID600 Project Template-Xueying"
author: "Xueying Lyu"
output: 
  html_document:
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.

### Overview
The goal of the project is to study the vulnerability and resilience of AD patients by partitioning them into phenotypes. To achieve this, we will model regional tau (T) and neurodegeneration (N) dissociation in vivo, and then apply data-driven algorithm based on their regional T-N mismatch for clustering. 


### Introduction 
Alzheimer’s disease (AD) is heterogenous in the age of onset, course, cognitive and behavior phenotype, and the present of underlying additional pathology. In particular, other latent pathologies have become evident in vast majority of individuals with AD pathology, such as cerebrovascular disease and/or other degenerative pathologies (e.g. TDP43). The heterogeneity of AD makes it challenging towards diagnosis and treatment, especially because in vivo imaging markers do not exist for mixed pathologies. Developing tools that can disentangle the heterogeneity of AD has been demanded.

The accumulation of Amyloid plaques (Aβ) and tau neurofibrillary tangles (NFT) are major biomarkers of AD. With the availability of tau PET imaging, tau (T) has been vastly studied as the primary driver of downstream neurodegeneration (N) and causing cognitive impairment. Indeed, neurodegeneration is not specific to tau since other pathologies can also contribute to neurodegeneration. On the other hand, brain resilience due to protective factors may help individuals coping with effects of brain aging and pathology. In this project, we aim to evaluate T-N mismatch clustering in vivo on both A+ and A- symptomatic patients to explore the potential vulnerability and resilience. Our hypothesis is that the vulnerable phenotypes may harbor non-tau pathology thereby causing higher neurodegeneration than expected in specific patterns; the resilient groups on the other hand may be associated with protective factors so that they are resilient to Alzheimer’s pathology



### Methods
```{r}
#Establish T-N Linear Relationships
library(dplyr)
library(tidyverse)
library(toolboxR)
setwd("/Users/Xueying Lyu/Desktop/merge")
```

```{r}
#The Tau (T) and neurodegeneration (N) relationship was modeled by robust linear regression between regional tau SUVR and cortical thickness, respectively. The bi-square weighting function was used to mitigate the effect of outliers. A natural log transformation was applied on tau SUVR as the independent variable to mitigate the effects of potentially skewed SUVR distribution. The regression residuals were discretized into a two-element binary vector based on whether they were more than 1.5 standard deviations away from the regression line. These binarized vectors obtained from 104 bilateral regions of interest were entered into ward’s D2 hierarchy clustering16 to generate data-driven grouping of subjects. 
attach(Try)
roi<-Try
str(roi)
thickness<-c()
for (i in 1:312){
  if (i%%3==0)
  {thickness<-c(thickness, roi[i])}
}  
thickness<-data.frame(thickness)
write.table(thickness, file = "thickness", row.names = F, sep =" ")
tau<-c()
start<-1
step<-3
n<-seq(start, 312, by=step)
for (i in n){
  
  tau<-c(tau,roi[i])
}
tau<-data.frame(tau)


library('MASS')
m<-rlm(unlist(thickness[104])~unlist(tau[104]))
resid(m)
resid(rlm(Left_TTG_transverse_temporal_gyrus_thickness ~ log(Left_TTG_transverse_temporal_gyrus_tau)))
print(mod<-rlm(unlist(thickness[104])~(log10(unlist(tau[104])))))
print(resid(mod))
l<-matrix(0, nrow=343, ncol=104)
for (i in 1:104){
  print(i)
  filename=i
  mod<-rlm(unlist(thickness[i])~(log10(unlist(tau[i]))), psi=psi.bisquare)
  l[,i]<-(resid(mod))
  #write.table(scale(resid(mod)), paste(i, ".text", sep =" "), row.names = F)
}

re<-data.frame(l)


bin<-matrix(0,nrow=343, ncol=104)
for (i in 1:104){
  for (num in 1:343){
    if (re[num,i]< -1.5*(sd(re[,i]))){
      bin[num,i]=-1
    }
    else if (re[num,i]>1.5*(sd(re[,i]))){
      bin[num,i]=1
    }
    else {bin[num,i]=0}
  }
}
b<-matrix(0, nrow=343, ncol=208)
for (i in 1:104){
  for (num in 1:343){
    if (bin[num, i]==1){
      b[num, 2*i-1]<-1
      b[num, 2*i]<-0}
    else if (bin[num, i]==-1){
      b[num, 2*i-1]<-0
      b[num, 2*i]<-1}
    else{ b[num, 2*i-1]<-0
    b[num, 2*i]<-0}
  }
}

binaa<-data.frame(b)
C<-hclust(dist(binaa), method='ward.D2', members = NULL) 
plot(C)

library('dendextend')
library('dplyr')
library('pvclust')

n.cluster<-sapply(6, function(n.cluster)table(cutree(C,n.cluster)))
n.cluster

c_cutree<-cutree(C, k=6)

plot(C, hang=-1)
rect.hclust(C , k = 6, border = 2:6)
c_mutate<- mutate(binaa,cluster=c_cutree)
writexl::write_xlsx(c_mutate, 'mutate4.xlsx')

library('pvclust')
library('NbClust')
library('factoextra')
fviz_nbclust(binaa, FUNcluste=hcut, method='wss')

library('ClustTools')
sse=vector()
for (i in 1:12)sse[i]<-SSE(binaa, cutree(C, i))$sumWithin
plot(1:12,
     sse, 
     main=paste('Thordike'))


library('NbClust')
nbclust_out <- NbClust(data = binaa, distance = "euclidean",min.nc = 2, max.nc = 9, method = 'ward.D') 

if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

BiocManager::install("ELBOW")

library('GMD')
elbow(C)



# mojen
x.clfl<-C$height
x.clm<-mean(x.clfl)
x.cls<-sqrt(var(x.clfl))
print((x.clfl-x.clm)/x.cls)
print(x.clfl[251])
x.clmojena<-cutree(C, h=x.clfl[251])
c_m<- mutate(binaa,cluster=x.clmojena)
```



### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
