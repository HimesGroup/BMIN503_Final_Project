---
title: "Toward the Improvement of the Lung Allocation Score"
author: "Erin Schnellinger"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.

### Overview

The goal of this project is to investigate the prevalence and risk factors of lung transplantation in the United States using publicly available data from the United Network for Organ Sharing (UNOS). We will also investigate how the coefficients of the lung allocation score (LAS; a prediction model used to prioritize patients for lung transplant) have changed over time. Finally, we will assess how well the current LAS model predicts post-transplant survival, and compare its performance to that of a logistic regression model which allows the coefficients of important predictors to vary with time.

Given the interdisciplinary nature of this project, I sought advice from representatives from the fields of epidemiology (Dr. Stephen Kimmel, MD, MSCE), statistics (Dr. Alisa Stephens-Shields, PhD), sociology (Dr. Julia Szymczak, PhD), and lung transplant surgery (Dr. Edward Cantu III, MD, MSCE). As explained further in the introduction, these individuals helped me focus my project on examining how the coefficients of the LAS model might change over time, and whether allowing for such changes improves this model's performance. All information contained in this report is available on my [final project GitHub repository](https://github.com/eschnell/BMIN503_Final_Project). 

**Please note that while the UNOS data is publicly available, researchers must submit a [Data Request](https://optn.transplant.hrsa.gov/data/) prior to using it. I have obtained access to this data through my advisor, Dr. Stephen Kimmel. For the purposes of this project, however, I have provided a simulated data set on my [GitHub repository](https://github.com/eschnell/BMIN503_Final_Project). This data set was simulated based on the observed UNOS data. The Rmd file that appears on my final project repository will run using this simulated data set.**


### Introduction 

In May 2005, the Organ Procurement and Transplantation Network (OPTN) modified their lung transplantation policy from one in which potential recipients were prioritized based on the amount of time spent on the waiting list to one in which donor lungs were allocated to recipients based on a lung allocation score (LAS). The LAS essentially compares patients' transplant benefit to their waiting list urgency, assigning individuals with higher values greater priority for transplant. Since the adoption of the LAS, studies have shown that the mortality rate for patients on the lung transplant waiting list has decreased. However, resource use and geographic and gender disparities in lung allocation have increased. Additionally, while the statistical models used to construct the LAS control for patientsâ€™ demographics, diagnoses, and laboratory values, the model itself is static in nature. That is, a derivation cohort is assembled, model coefficients are estimated based on this cohort, and then those coefficients are applied to individuals outside the cohort. To date, the LAS coefficients have been updated using three different cohorts at three different times: 2005, 2010, and 2015. Yet no one has investigated how LAS coefficients have changed over time, or whether such changes impact the predictive accuracy of the LAS. 

In this project, we aim to explore the prevalence and risk factors of lung transplantation in the United States using publicly available  data from the United Network for Organ Sharing (UNOS) collected between 2007 and 2015. We will also investigate how the coefficients of the lung allocation score (LAS; a prediction model used to prioritize patients for lung transplant) have changed over time. Finally, we will assess how well the current LAS model predicts post-transplant survival, and compare its performance to that of a logistic regression model which allows the coefficients of important predictors to vary with time.

This problem is relevant to many different stakeholders, including epidemiologists, statisticians, clinicians, and sociologists. Epidemiologists are interested in characterizing how both the pre- and post-transplant mortality rate of individuals with chronic lung diseases changes over time, as well as identifying whether certain risk factors are associated with mortality. Statisticians are interested in developing tools that allow prediction models (such as the LAS) to be updated more easily and frequently, as "dynamic" modeling strategies might improve the performance of prediction models in real-world settings. Clinicians are interested in predicting pre- and post-transplant survival accurately so that donor lungs are allocated to the appropriate patients in the appropriate order. Finally, sociologists are interested in understanding the role such prediction models play in clinical decision making. 

Given the interdisciplinary nature of this project, I sought advice from representatives from each of these fields: Dr. Stephen Kimmel, MD, MSCE, a cardiovascular epidemiologist with experience in the development and validation of clinical prediction models; Dr. Alisa Stephens-Shields, PhD, a biostatistician with expertise in observational studies, longitudinal data, and causal inference methods; Dr. Julia Szymczak, PhD, a medical sociologist with expertise in using qualitative methods to understand medical culture and practice; and Dr. Edward Cantu III, MD, MSCE, a lung transplant surgeon at the Hospital of the University of Pennsylvania. Together, these individuals have suggested that I: 1) compare the observed mortality outcomes for patients who received lung transplants to the mortality outcomes that were predicted by the existing lung allocation score (LAS) algorithm; 2) compare the observed mortality outcomes to those predicted by a logistic regression model which allows for coefficients to change over time; 3) think beyond traditional measures of predictive accuracy, such as calibration and discrimination, to consider the target parameter that the LAS algorithm purports to estimate versus the target parameter that the LAS algorithm actually estimates; 4) think about how the current LAS model is used in clinical practice, and whether modifications to this model would influence how it is used; and 5) consider looking into disparities in transplantation among different patient populations (e.g., patients with different ages, race/ethnicity, or diagnoses). 


### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 
#### Data Source
  The United Network for Organ Sharing (UNOS) is a private organization charged by the Organ Procurement and Transplantation Network (OPTN) to coordinate the allocation of donor organs in the United States. Toward this end, UNOS has developed a database to keep track of all potential transplant recipients. By law, every patient who would like to receive a transplant is required to be registered on the UNOS waiting list. UNOS then follows these patients until they either 1) receive transplant; 2) die; or 3) are removed from the waiting list (i.e., censored) due to illness or loss to follow up. The database contains information on patients' lab values, demographic characteristics, and any predictive scores used to aid the allocation process (e.g., the Lung Allocation Score (LAS) for allocating lungs; the Model for End Stage Liver Disease (MELD) score for allocating livers). This data is publicly available, although researchers must submit a [Data Request](https://optn.transplant.hrsa.gov/data/) prior to using it. (As an aside, I have obtained access to this data through my advisor, Dr. Stephen Kimmel. For the purposes of this project, however, I have provided a simulated data set on my [GitHub repository](https://github.com/eschnell/BMIN503_Final_Project).)

#### Patient Population
  In this study, we are most interested in examining how well the current Lung Allocation Score (LAS) predicts post-transplant survival among adults who actually receive transplant. Thus, our study population consists of all patients 18 years or older who are listed for and received a single or bi-lateral lung transplantation in the United States between January 1, 2007 and December 31, 2015. This date range was chosen because it ensures that no patient experiences any person-time prior to the implementation of the LAS (i.e., prior to May 2005); it also guarantees that individuals experience enough follow-up time to power our analyses. Furthermore, while the analyses presented here are restricted to the post-transplant population, future research will explore the effect of the LAS among the full population of all individuals regsitered on the UNOS waiting list.

#### Data Cleaning
  The post-transplant portion of the LAS aims to estimate the 1 year post-transplant survival probability for patients who receive transplant. The predictors of this model include: age at transplant (\(years\)), cardiac index (\(L/min/m^2\)), use of mechanical ventilation (\(yes/no\)), serum creatinine (\(mg/dL\)), creatinine increase of at least 150%, diagnosis group (i.e., obstructive diseases, pulmonary hypertension, cystic fibrosis, and pulmonary fibrosis), functional status (i.e., requires assistance to perform daily tasks, \(yes/no\)), oxygen requirement (\(L/min\)), and six-minute walk distance (\(feet\)). The outcome of this model is a binary indicator of mortality (i.e., \(1=died, 0=alive\)). Some of these variables are already present in the UNOS data, while others must be calculated. Thus, we begin by loading the (simulated) post-transplant UNOS data and center, truncate, and/or recode variables as appropriate. More specifically, we:
  
1. Restrict our population to only include data falling between 2007 and 2015 (note that the post-transplant data set has already been restricted to adults awaiting lung transplant).

2. Center the _age_ and _six-minute walk distance_ variables.

3. Convert _age_ into a spline variable such that individuals less than 46 years old receive a value of 0, while individuals aged 46 years or older receive a value of (\(age-45.9972602\)), consistent with the guidance provided in the UNOS manual for the LAS.

4. Trim _cardiac index_, _creatinine_, and _six-minute walk_ values above the 99th percentile to mitigate the impact of extreme values.

5. Compute the _creatinine increase_ variable.

6. Dichotomize the _mechanical ventilation_ and _functional status_ variables.

```{r}
## PASTE CODE FROM "VARIABLE CLEANING" SECTION OF SUMMARIES FOR SIMULATIONS 4.RMD HERE!!
```


#### Analyses: Part 1
  Next, we conduct exploratory analyses to address the following questions:
  
1. How has the post-transplant mortality risk changed over time?
2. How has the prevalence of different risk factors changed over time?
3. How have the coefficient estimates for LAS parameters changed over time?

Mortality risk was estimated by fitting a null (intercept-only) logistic regression model with binary mortality as the outcome (1=dead within one year post-transplant, 0=alive). For comparison, we also display the Kaplan-Meier estimated survival for each year under study. 

```{r}
## INSERT CODE FROM OBSERVED MORTALITY AND NULL LOGISTIC SECTION OF SUMMARIES FOR SIMULATIONS 4.RMD HERE!!
```

Prevalence of risk factors was visualized via stacked bar charts or violin plots with boxplots overlaid, as appropriate. 

```{r}
## INSERT CODE FROM RISK FACTOR PREVALENCE SECTION OF SUMMARIES FOR SIMULATIONS 4.RMD HERE!!
```

Changes in LAS coefficient estimates were examined by fitting adjusted logistic regression models with binary mortality as the outcome and the covariates included in the current LAS model as predictors. All models also include variable-by-year interaction terms, with 2007 being treated as the reference year. In each case, we first identify which interaction terms are significant, and then plot the actual coefficient estimates for these significant variables over time. Coefficient estimates for variables with non-significant interactions with time are not plotted.

```{r}
## INSERT CODE FROM ADJUSTED LOGISTIC REGRESSION SECTION OF SUMMARIES FOR SIMULATIONS 4.RMD HERE!!
```

#### Analyses: Part 2
  Next, we assessed the calibration and and discrimination of the current post-transplant LAS model. Note that for transplants occurring between 2005 and 2011, we use the coefficients from the 2005 LAS model, whereas for transplants occurring beetween 2012 and 2015, we use the coefficients from the 2010 LAS model. These coefficients were chosen because in clinical practice, the 2005 LAS was used during the years 2005-2011, while the 2010 LAS was used during the years 2012-2015.
  Calibration was assessed by obtaining predicted probabilities of death from the fitted LAS model, and then comparing these predicted probabilities to the observed proportion of deaths across deciles of predicted probabilities. Discrimination was assessed by plotting ROC curves, both overall, and separately by year.
  
```{r}
## INSERT CODE FROM LAS SECTION OF PREDICTED VS OBSERVED.RMD HERE!!
```
  
  For comparison, we also assessed the calibration and discrimination of a multivariable logistic regression model which contained the same main effects as the current LAS, but which additionally included interactions between key predictors and time (as identified in Analyses: Part 1). 

```{r}
## INSERT CODE FROM LOGISTIC REGRESSION SECTION OF PREDICTED VS OBSERVED.RMD HERE!!
```


### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. 


### Conclusions
The analyses shown here suggest that the post-transplant mortality rate decreases over time, the prevalnce of risk factors varies over time, and the LAS coefficient values change over time. None of these changes are accounted for by the current LAS. Additionally, when comparing observed versus predicted mortality for both the LAS and our basic prediction model, we found that the former model exhibits worse calibration and worse discrimination than the latter. More specifically, the LAS tended to underestimate the probability of death.

Taken together, these results are consistent with the notion that the LAS is "broken" [REF], and provide support for a dynamic prediction modelling strategy. This DPM strategy, however, will likely need to be more nuanced than simply allowing top predictors to vary with time, as our naive prediction model which included age-by-time, mechanical ventilation-by-time, and diagnosis-by-time interaction terms did not perform substantially better than the existing LAS.