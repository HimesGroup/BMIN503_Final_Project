---
title: "BMIN503/EPID600 Project Template"
author: "Erin Kennedy "
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
### Overview
*Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.*

Over the last decade, hospital readmissions have become a major focus area of healthcare policy and research, and many initiatives to understand, reduce, and prevent future readmissions have emerged. While these initiatives have helped decrease readmissions in certain groups like Medicare patients, readmission rates have remained stable among Medicaid and privately insured patients, and even increased among uninsured patients (Bailey et al, 2019). To date, most prediction models for hospital readmissions have focused on important clinical factors like medications, lab values, and comorbidities (Zhou et al, 2016). Newer research suggests that social determinants of health impact hospital readmissions (CDC, 2020), so the goals of this project are to describe characteristics of readmitted patients and explore factors associated with 30-day readmissions with an emphasis on social factors. 

####Aims:
* Conduct an exploratory analysis comparing patients with 30-day readmissions to those wtihout
* Identify factors early in the hospitalization associated with readmission 

This project will use MIMIC-III, an openly available dataset developed by MIT with de-identified data for approximately 60,000 intensive care unit hospitalizations including demographics, vital signs, laboratory data, medications, and unstructured notes. I would like to acknowledge this wonderful database. 

[Github Repository](https://github.com/erinken/BMIN503_Final_Project)
[MIMIC-III](https://mimic.physionet.org/)

I would also like to acknowledge the contributions of several experts who assisted with the design and analysis process
* Danielle Mowery: study design, MIMIC data extraction, formulating processes of data wrangling, interpretation of results 
* Blanca Himes: Identifying a dataset and data extraction procedures 
* Anahita Davoudi and Sy Hwang: expertise in extracting and analyzing MIMIC data
* Emily Schriver: expertise in biostatistics using R. Assisted with several packages including ggplot and elixhauser comorbidity
* Gary Weissman: Expertise in wrangling MIMIC data 

### Introduction 
*Describe the problem addressed, its significance, and some background to motivate the problem.Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.*

In 2017 alone, 3.5 million potentially preventable readmissions cost 33.7 billion (McDermott & Jiang, 2020). Implementation of readmission-risk prediction models at the point of care is an evidence-based strategy to reduce readmissions, but only 34% of hospitals enrolled in the National Hospital-to-Home quality initiative formally estimate patients' readmission risk (Bradley et al, 2014). In 2019, the president of the American Hospital association encouraged policymakers to dedicate more resources towards understanding the discharge planning process and post-acute care trajectory (Pollack, 2019).According to a recent systematic review of readmission prediction models, most existing models have focused on important acute clinical data to predict readmission risk (Zhou et al, 2016). Recent literature suggests that social determinants of health could play an important role in hospital readmissions, and this information is starting to become more prevalent in structured EHR data (CDC, 2020). Therefore, the aim of this project is to explore the role of social factors in prediction of 30-day hospital readmissions.

A recent human factors study found that most patients have 1-6 different people involved in the discharge planning process, making it a truly interdisciplinary endeavor as different specialties bring different expertise to the team (Prusaczyk et al, 2019). Groups interested in building readmission prediction models should include a holistic mix of both technical and clinical experts such as biostatisticians, informaticians, data scientists, physicians, nurses, case managers, and even other ancillary clinicians like physical therapists. Since I come from a clinical background, my goal was to connect with the technical experts so my main collaborators included a biostatistician (Emily Schriver) and informaticians (Danielle Mowery, Sy Hwang, Anahita Davoudi). Danielle Mowery assisted me with overall study design and workflow for my data cleaning. Sy Hwang and Anahita Davoudi have experiences with general databases and the MIMIC database and helped me determine the appropriate way to extract data and join tables. Emily Schriver has extensive experience analyzing EHR data in R and pointed me to some helpful packages for my analysis. 


### Methods
*Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.* 

The dataset used for this project was obtained from MIMIC-III, an openly available dataset of nearly 60,000 intensive care admissions including demographics, vital signs, laboratory data, medications, and notes. The database can be accessed [here](https://mimic.physionet.org/). Although there are a myriad of tables available in MIMIC, this dataset will focus on the patients, admissions, services, diagnoses, and diagnoses_icd tables. More information about the tables and schema can be found [here](https://mimic.physionet.org/mimicdata/schema/). These tables contain important demographic, comorbidity, and what types of services the patients received during their hospitalization.

The main goal is to define a readmissions cohort and analyze the data with exploratory analysis to build a simple readmissions prediction model. 


First, packages will be loaded for organizational purposes
```{r}
# load packages

library(tidyverse) 
library(ggplot2) # For graphs
library(lubridate) # For manipulating dates
library(gtsummary) #Summary statistics
library(bbplot) # For BBC formatted plots
library(RColorBrewer) # For coloring the plots
library(ggpubr) # Combining multiple graphs into one figure 
library(pROC) # For cross-validation
library(dplyr) # For data cleaning

```

##Preprocessing
The MIMIC-III database offers several strategies for pulling the data including SQL, google cloud platform, and I chose to download the csv files of the tables I was interested them and pre-process the data using the dplyr package. 

First, read in the necessary tables and perform some basic cleaning to focus on the variables of interest. 
```{r}
# admissions table
admissions <- read.csv(file = 'ADMISSIONS.csv.gz')

# selecting only variables of interest
admissions <- admissions %>%
  select(SUBJECT_ID, HADM_ID, ADMITTIME, DISCHTIME, ADMISSION_TYPE, ADMISSION_LOCATION, DISCHARGE_LOCATION, INSURANCE, LANGUAGE, RELIGION, MARITAL_STATUS, ETHNICITY, DIAGNOSIS, HOSPITAL_EXPIRE_FLAG)

# patients table 
patients <- read.csv(file = 'PATIENTS.csv.gz')

# selecting only variables of interest
patients <- patients %>%
  select(SUBJECT_ID, GENDER, DOB)

#services
#services <- read.csv(file = 'SERVICES.csv.gz')

# selecting only variables of interest
#services <- services %>%
#  select(SUBJECT_ID, HADM_ID, TRANSFERTIME, PREV_SERVICE, CURR_SERVICE)

#head(services$HADM_ID)
#diagnoses_icd

#d_icd_diagnoses

```

Merging the tables
```{r}
# Joining the Admission and patients table into the larger mimic table on the SUBJECT_ID
mimic <- inner_join(patients, admissions, by = "SUBJECT_ID")

#Joining the services table onto the mimic table on the HADM_ID
#mimic <- inner_join(mimic, services, by = "HADM_ID")


```

Next, identifying patients discharged ALIVE 
```{r}
#code to filter out those with disposition death and non-newborn 
mimic <- mimic %>%
  filter(HOSPITAL_EXPIRE_FLAG == 0 & DISCHARGE_LOCATION != "DEAD/EXPIRED")

#confirming exclusion of patients who died in the hospital
table(mimic$DISCHARGE_LOCATION)

#extra step to confirm that the hospital expire flag = 0 
table(mimic$HOSPITAL_EXPIRE_FLAG)

unique(admissions$DISCHARGE_LOCATION)
unique(admissions$hospital_expire_flag)
```
Next, calculating age and excluding those over 90 because their DOBs have been shifted, as well as those <18. For creating the age variable I found this [Stack Overflow Thread](https://stackoverflow.com/questions/31126726/efficient-and-accurate-age-calculation-in-years-months-or-weeks-in-r-given-b) very helpful. I also created a length of stay (in days) variable in this step
```{r}
# Clearing dataframes we no longer need
rm(admissions)
rm(patients)

head(mimic$DOB)
# converting the dob, admittime, and dischargetime to dates
mimic <- mimic %>%
  mutate(DOB = as.Date(DOB, format = "%Y-%m-%d")) %>%
  mutate(ADMITTIME = as.Date(ADMITTIME, format = "%Y-%m-%d")) %>%
  mutate(DISCHTIME = as.Date(DISCHTIME, format = "%Y-%m-%d"))

head(mimic$DOB)

# checking to make sure the conversion worked
class(mimic$DOB)
class(mimic$ADMITTIME)
class(mimic$DISCHTIME)

# calculating age and length of stay
mimic <- mimic %>%
  mutate(AGE = as.period(interval(start = DOB, end = ADMITTIME))$year) %>%
  mutate(LOS = as.period(interval(start = ADMITTIME, end = DISCHTIME))$day)

summary(mimic$AGE)
summary(mimic$LOS)

#Checking to see the number of patients <55 or >89
sum(mimic$AGE > 90)
sum(mimic$AGE < 55)

#filtering age to only those who are 55-90 (a limitation of the study with the upper age limit). Now we can see there are substantially less patients in the dataset
mimic <- mimic %>%
  filter(between(AGE, 55, 89))

# Checking to make sure age is properly filtered
summary(mimic$AGE)
```

Next, we will sort the dataframe by patient ID and ADMITTIME to determine the times to readmission and create a flag to identify the 30-day readmission cohort.  

**How I created time_to_readmission:** new variable subtracts NEXT admission date minus CURRENT discharge date  
**How I created readmitted_30:** new variable coded as 1 (readmission within 30 days) or 0 (no readmission or future admission beyond 30 days)

*Note: I also created 7- and 14- day readmissions variables for future analysis*

Although I chose a slightly different method, I found this stack overflow [thread](https://stackoverflow.com/questions/44508585/calculate-readmission-rate) helpful. 
```{r}
mimic <- mimic %>% 
  arrange(SUBJECT_ID, ADMITTIME, by_group = TRUE) %>% 
  group_by(SUBJECT_ID) %>%
  mutate(count=1:n()) %>% #added a counter variable so I can see how many times each patient was hospitalized
  mutate(time_to_readmission = as.numeric(lead(ADMITTIME, 1) - DISCHTIME)) %>%
  mutate(readmitted_30 = if_else(time_to_readmission<=30, 1,0)) %>%
  mutate(readmitted_14 = if_else(time_to_readmission<=14, 1,0)) %>%
  mutate(readmitted_7 = if_else(time_to_readmission<=7, 1,0))

table(mimic$count)

# Converting all of the NA's to 0, because those patients only had 1 admission in the entire dataset and weren't captured by that mutate command
mimic[["readmitted_30"]][is.na(mimic[["readmitted_30"]])] <- 0
mimic[["readmitted_14"]][is.na(mimic[["readmitted_14"]])] <- 0
mimic[["readmitted_7"]][is.na(mimic[["readmitted_7"]])] <- 0

#Checking to see the number of readmissions in each group
table(mimic$readmitted_30)
table(mimic$readmitted_14)
table(mimic$readmitted_7)

#Changing readmitted_30 to factor since this will be important
mimic$readmitted_30 <- factor(mimic$readmitted_30, levels = c(0,1), labels = c("Non-Readmission", "Readmission"))

#Creating a new readmission categories variable for nice visualizations in the exploratory analysis part
mimic$readmission_cat <-cut(mimic$time_to_readmission, c(-Inf,7,14,30))



#Checking to see if this new categorical variable aligns with 
table(mimic$readmission_cat)

```
Collapsing the ethnicity categories, religion categories, marriage categories, and discharge disposition categories. Credit to this person on [github](https://github.com/MIT-LCP/mimic-code/blob/master/tutorials/dplyr-frontend/intro.md)
```{r}
# Starting with Ethnicity
table(mimic$ETHNICITY) # Before

unknown_ethnicity <- c("UNKNOWN/NOT SPECIFIED", "PATIENT DECLINED TO ANSWER", "UNABLE TO OBTAIN", "OTHER")

mimic <- mimic %>%
  mutate(ethnicity_categories = case_when(
    str_detect(ETHNICITY, "^ASIAN") ~ "ASIAN",
    str_detect(ETHNICITY, "^BLACK") ~ "BLACK",
    str_detect(ETHNICITY, "^HISPANIC") ~ "HISPANIC",
    str_detect(ETHNICITY, "^WHITE") ~ "WHITE",
    ETHNICITY %in% unknown_ethnicity ~ "OTHER/UNKNOWN"
  ))

#Changing to factor to make analysis easier
mimic$ethnicity_categories <- as.factor(mimic$ethnicity_categories)

table(mimic$ethnicity_categories) # After

# Next, Religion 
table(mimic$RELIGION) # Before

christian <- c("CHRISTIAN SCIENTIST", "EPISCOPALIAN", "BAPTIST", "LUTHERAN", "PROTESTANT QUAKER", "METHODIST", "Unknown")
unknown_religion <-c("NOT SPECIFIED", "UNOBTAINABLE", "7TH DAY ADVENTIST", "OTHER", "HEBREW", "ROMANIAN EAST. ORTH", "GREEK ORTHODOX", "UNITARIAN-UNIVERSALIST", "JEHOVAH'S WITNESS")


mimic <-mimic %>%
  mutate(religion_categories = case_when(
    str_detect(RELIGION, "^JEWISH") ~ "JEWISH",
    str_detect(RELIGION, "^BUDDHIST") ~ "BUDDHIST",
    str_detect(RELIGION, "^CATHOLIC") ~ "CATHOLIC",
    str_detect(RELIGION, "^HINDU") ~ "HINDU",
    str_detect(RELIGION, "^MUSLIM") ~ "MUSLIM",
    RELIGION %in% christian ~ "CHRISTIAN",
    RELIGION %in% unknown_religion ~ "OTHER/UNKNOWN",
    TRUE ~ "OTHER/UNKNOWN"
  ))

table(mimic$religion_categories) # After

# Marital status categories - This is more for the regression
table(mimic$MARITAL_STATUS) #before

married <- c("MARRIED", "LIFE PARTNER")
not_married <- c(" ", "DIVORCED", "SEPARATED", "SINGLE", "UNKNOWN(DEFAULT)", "WIDOWED")

mimic <- mimic %>%
  mutate(marital_dichotomous = case_when(
    MARITAL_STATUS %in% married ~ "MARRIED/LIFE PARTNER",
    MARITAL_STATUS %in% not_married ~ "NOT MARRIED/UNKNOWN/OTHER"
  ))

table(mimic$marital_dichotomous) # After

# Discharge disposition categories
table(mimic$DISCHARGE_LOCATION)

home <- c("HOME")
home_health <- c("HOME HEALTH CARE", "HOME WITH HOME IV PROVIDR")
transfer <- c("DISC-TRAN CANCER/CHILDRN H", "DISC-TRAN TO FEDERAL HC", "DISCH-TRAN TO PSYCH HOSP")
hospice <- c("HOSPICE-HOME", "HOSPICE-MEDICAL FACILITY")
ama <- c("LEFT AGAINST MEDICAL ADVI")
snf <- c("SNF", "SNF-MEDICAID ONLY CERTIF")
rehab<- c("REHAB/DISTINCT PART HOSP")
other_facility <- c("ICF", "LONG TERM CARE HOSPITAL", "OTHER FACILITY", "SHORT TERM HOSPITAL")

mimic <- mimic %>%
  mutate(discharge_categories = case_when(
    DISCHARGE_LOCATION %in% home ~ "HOME",
    DISCHARGE_LOCATION %in% home_health ~ "HOME HEALTH",
    DISCHARGE_LOCATION %in% transfer ~ "TRANSFER TO ANOTHER HOSPITAL",
    DISCHARGE_LOCATION %in% hospice ~ "HOSPICE (HOME OR FACILITY)",
    DISCHARGE_LOCATION %in% ama ~ "AGAINST MEDICAL ADVICE",
    DISCHARGE_LOCATION %in% snf ~ "SKILLED NURSING FACILITY",
    DISCHARGE_LOCATION %in% rehab ~ "REHABILITATION",
    DISCHARGE_LOCATION %in% other_facility ~ "OTHER FACILITY",
  ))

table(mimic$discharge_categories)
```

Filtering to index admission only 
```{r}
mimic <- mimic %>%
  filter(count<2) %>%
  ungroup()

```
Picking the Color Palate-- These tell me which colors to select when I make my graphs 
```{r}
colors <- brewer.pal(9, "RdBu")
colors

```
Descriptive Statistics overall (See details on the [gtsummary package](http://www.danieldsjoberg.com/gtsummary/))
```{r}
mimic_summary <- mimic %>%
  select(GENDER, AGE, INSURANCE, religion_categories, MARITAL_STATUS, ethnicity_categories, ADMISSION_TYPE, LOS, discharge_categories, time_to_readmission, readmission_cat, readmitted_30)

table1<- tbl_summary(
  mimic_summary, 
  missing = "no",
) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels()
#insurance, language, religion, marital_status, ethnicity, gender, discharge disposition, procedure?, diagnosis?

# Gender
table(mimic$GENDER)
      
gender_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = GENDER, y = ..prop.., group = 1), stat = "count", fill = "#4393C3") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Gender") 

# Admission Type
table(mimic$ADMISSION_TYPE)

admission_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = ADMISSION_TYPE, y = ..prop.., group = 1), stat = "count", fill = "#92C5DE") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Admission Type") 

# Discharge Location
table(mimic$discharge_categories)

discharge_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = discharge_categories, y = ..prop.., group = 1), stat = "count", fill = "#4393C3") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Discharge Disposition")
  theme(axis.text = element_text(angle = 90, size =4))


# Insurance
table(mimic$INSURANCE)

insurance_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = INSURANCE, y = ..prop.., group = 1), stat = "count", fill = "#D6604D") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Insurance") 

# Religion
table(mimic$religion_categories)

religion_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = religion_categories, y = ..prop.., group = 1), stat = "count", fill = "#4393C3") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Religion")+
  theme(axis.text = element_text(angle = 90, size =8))
  
# Marital Status
table(mimic$marital_dichotomous)

marital_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = marital_dichotomous, y = ..prop.., group = 1), stat = "count", fill = "#92C5DE") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Relationship Status")+
  theme(axis.text = element_text(angle = 0, size =10))

# Ethnicity
table(mimic$ethnicity_categories)

ethnicity_total <- ggplot(data = mimic) +
  geom_bar(mapping = aes(x = ethnicity_categories, y = ..prop.., group = 1), stat = "count", fill = "#F4A582") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Ethnicity")+
  theme(axis.text = element_text(angle = 0, size =10))


# Age 
summary(mimic$AGE)
age_total <- ggplot(data = mimic, aes(y=AGE)) + 
  geom_boxplot(fill = "#D6604D") +
  labs(title = "Age") 

# LOS
summary(mimic$LOS)
los_total <- ggplot(data = mimic, aes(y=LOS)) + 
  geom_boxplot(fill = "#D6604D") +
  labs(title = "Length of Stay") 

# Summary Graphs 1
ggarrange(admission_total, age_total, discharge_total, ethnicity_total + rremove("x.text"),
          ncol = 2, nrow = 2)

# Summary Graphs 2
ggarrange(gender_total, insurance_total, los_total, marital_total + rremove("x.text"),
          ncol = 2, nrow = 2)
```

Descriptive statistics comparing readmissions cohort to non-readmissions cohort
```{r}
# Summary table (by group)
table2<- tbl_summary(
  mimic_summary,
  by = readmitted_30,
  missing = "no",
) %>%
  add_n() %>%
  modify_header(label = "**Variable**") %>%
  bold_labels()
table2

# Gender
table(mimic$GENDER, mimic$readmitted_30)

gender_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(GENDER))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Gender") +
  scale_fill_brewer(palette = "Paired")

# Admission Type
table(mimic$ADMISSION_TYPE, mimic$readmitted_30)

admission_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(ADMISSION_TYPE))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Admission Type") +
  scale_fill_brewer(palette = "Paired")

# Discharge Location
table(mimic$discharge_categories, mimic$readmitted_30)

discharge_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(discharge_categories))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Discharge Disposition") +
  scale_fill_brewer(palette = "Paired")

# Insurance
table(mimic$INSURANCE, mimic$readmitted_30)

insurance_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(INSURANCE))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Insurance") +
  scale_fill_brewer(palette = "Paired")

# Religion
table(mimic$religion_categories, mimic$readmitted_30)

religion_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(religion_categories))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Insurance") +
  scale_fill_brewer(palette = "Paired")
  
# Marital Status
table(mimic$marital_dichotomous, mimic$readmitted_30)

marital_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(marital_dichotomous))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Insurance") +
  scale_fill_brewer(palette = "Paired")

# Ethnicity
table(mimic$ethnicity_categories, mimic$readmitted_30)

ethnicity_split <- ggplot(data = mimic, aes(x = readmitted_30, fill = factor(ethnicity_categories))) + 
  geom_bar(position = "dodge", stat = "count") +
  scale_y_continuous(labels = scales::percent_format())+
  labs(title = "Insurance") +
  scale_fill_brewer(palette = "Paired")

# Age 
tapply(mimic$AGE, mimic$readmitted_30, summary)

age_split <- ggplot(data = mimic, aes(readmitted_30, AGE)) +
  geom_boxplot(fill=c("#D6604D", "#B2182B")) +
  labs(title = "Age") 


# LOS
tapply(mimic$LOS, mimic$readmitted_30, summary)
los_split <- ggplot(data = mimic, aes(readmitted_30, LOS)) +
  geom_boxplot(fill=c("#D6604D", "#B2182B")) +
  labs(title = "Length of Stay") 

# Summary Graphs 1
ggarrange(admission_split, age_split, discharge_split, ethnicity_split + rremove("x.text"),
          ncol = 2, nrow = 2)

# Summary Graphs 2
ggarrange(gender_split, insurance_split, los_split, marital_split + rremove("x.text"),
          ncol = 2, nrow = 2)
```

Some preliminary dichotomization to use as comparison
```{r}
unknown_ethnicity <- c("UNKNOWN/NOT SPECIFIED", "PATIENT DECLINED TO ANSWER", "UNABLE TO OBTAIN", "OTHER")

mimic <- mimic %>%
  mutate(ethnicity_categories = case_when(
    str_detect(ETHNICITY, "^ASIAN") ~ "ASIAN",
    str_detect(ETHNICITY, "^BLACK") ~ "BLACK",
    str_detect(ETHNICITY, "^HISPANIC") ~ "HISPANIC",
    str_detect(ETHNICITY, "^WHITE") ~ "WHITE",
    ETHNICITY %in% unknown_ethnicity ~ "OTHER/UNKNOWN"
  ))

# Admission Type
table(mimic$ADMISSION_TYPE)
emergency_other <- c("EMERGENCY", "URGENT")

mimic <- mimic %>%
  mutate(admission_dichotomous = case_when(
    str_detect(ADMISSION_TYPE, "^ELECTIVE") ~ "ELECTIVE",
    ADMISSION_TYPE %in% emergency_other ~ "EMERGENCY/URGENT"
  ))
table(mimic$admission_dichotomous)

# Discharge Disposition
table(mimic$discharge_categories)
non_home <- c("AGAINST MEDICAL ADVICE", "HOSPICE(HOME OR FACILITY", "OTHER FACILITY", "REHABILITATION", "SKILLED NURSING FACILITY", "TRANSFER TO ANOTHER HOSPITAL")

mimic <- mimic %>%
  mutate(discharge_dichotomous = case_when(
    str_detect(discharge_categories, "^HOME") ~ "HOME",
    discharge_categories %in% non_home ~ "NON-HOME"
  ))
table(mimic$discharge_dichotomous)

# Insurance
table(mimic$INSURANCE)
gov_insurance <- c("Government", "Medicaid", "Medicare")

mimic <- mimic %>%
  mutate(insurance_categories = case_when(
    str_detect(INSURANCE, "^Private") ~ "Private",
    str_detect(INSURANCE, "Self Pay") ~ "Self Pay",
    INSURANCE %in% gov_insurance ~ "Public"
  ))
table(mimic$insurance_categories)

# Ethnicity
table(mimic$ethnicity_categories)
non_white <- c("ASIAN", "BLACK", "HISPANIC", "OTHER/UNKNOWN")

mimic <- mimic %>%
  mutate(ethnicity_dichotomous = case_when(
    str_detect(ethnicity_categories, "^WHITE") ~ "WHITE",
    ethnicity_categories %in% non_white ~ "NON-WHITE"
  ))
mimic$ethnicity_dichotomous<- as.factor(mimic$ethnicity_dichotomous)

table(mimic$ethnicity_dichotomous)

# Age - Splitting at the median and mean (both 70)
summary(mimic$AGE)
mimic$age_dichotomous <-cut(mimic$AGE, c(54,70,89))
table(mimic$age_dichotomous)

# LOS - dichotomizing at the median (7 days)
summary(mimic$LOS)
mimic$los_dichotomous <- cut(mimic$LOS, c(-Inf, 7, 30))
table(mimic$los_dichotomous)
```

Chi-Squared Tests of Variables to look at univariate significance
```{r}
# Gender
chisq.test(table(mimic$readmitted_30, mimic$GENDER)) 

# Admission Type
chisq.test(table(mimic$readmitted_30, mimic$ADMISSION_TYPE)) 
chisq.test(table(mimic$readmitted_30, mimic$admission_dichotomous))

# Discharge Location (not going to be in the model but interesting to look at)
chisq.test(table(mimic$readmitted_30, mimic$discharge_categories)) 
chisq.test(table(mimic$readmitted_30, mimic$discharge_dichotomous))

# Insurance
chisq.test(table(mimic$readmitted_30, mimic$INSURANCE)) 
chisq.test(table(mimic$readmitted_30, mimic$insurance_categories)) 

# Religion
chisq.test(table(mimic$readmitted_30, mimic$religion_categories)) 

# Marital Status
chisq.test(table(mimic$readmitted_30, mimic$marital_dichotomous)) 

# Ethnicity
chisq.test(table(mimic$readmitted_30, mimic$ethnicity_categories)) 
chisq.test(table(mimic$readmitted_30, mimic$ethnicity_dichotomous)) 

# Age
chisq.test(table(mimic$readmitted_30, mimic$AGE)) 
chisq.test(table(mimic$readmitted_30, mimic$age_dichotomous)) 

# LOS - 
chisq.test(table(mimic$readmitted_30, mimic$LOS)) 
chisq.test(table(mimic$readmitted_30, mimic$los_dichotomous)) 

```
Univariate Logistic Regression
```{r}
# Gender
summary((glm(readmitted_30 ~ GENDER, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ GENDER, data = mimic, family = binomial()))) #gives us the coefficients

# Admission Type
summary((glm(readmitted_30 ~ ADMISSION_TYPE, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ ADMISSION_TYPE, data = mimic, family = binomial())))

summary((glm(readmitted_30 ~ admission_dichotomous, data = mimic, family = binomial()))) #dichotomous
exp(coef(glm(readmitted_30 ~ admission_dichotomous, data = mimic, family = binomial())))

# Discharge Location (not going to be in the model but interesting to look at)
summary((glm(readmitted_30 ~ discharge_categories, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ discharge_categories, data = mimic, family = binomial())))

summary((glm(readmitted_30 ~ discharge_dichotomous, data = mimic, family = binomial()))) #dichotomous
exp(coef(glm(readmitted_30 ~ discharge_dichotomous, data = mimic, family = binomial())))

# Insurance
summary((glm(readmitted_30 ~ INSURANCE, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ INSURANCE, data = mimic, family = binomial())))

summary((glm(readmitted_30 ~ insurance_categories, data = mimic, family = binomial()))) #categorized
exp(coef(glm(readmitted_30 ~ insurance_categories, data = mimic, family = binomial())))

# Marital Status
summary((glm(readmitted_30 ~ marital_dichotomous, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ marital_dichotomous, data = mimic, family = binomial())))

# Ethnicity
mimic$ethnicity_categories = relevel(mimic$ethnicity_categories, ref = 5) #making white the reference category
summary((glm(readmitted_30 ~ ethnicity_categories, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ ethnicity_categories, data = mimic, family = binomial()))) 

mimic$ethnicity_dichotomous = relevel(mimic$ethnicity_dichotomous, ref = 2) #making white the reference category
summary((glm(readmitted_30 ~ ethnicity_dichotomous, data = mimic, family = binomial()))) #dichotomous
exp(coef(glm(readmitted_30 ~ ethnicity_dichotomous, data = mimic, family = binomial())))

# Age
summary((glm(readmitted_30 ~ AGE, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ AGE, data = mimic, family = binomial())))

summary((glm(readmitted_30 ~ age_dichotomous, data = mimic, family = binomial()))) #dichotomous
exp(coef(glm(readmitted_30 ~ age_dichotomous, data = mimic, family = binomial())))

# LOS - 
summary((glm(readmitted_30 ~ LOS, data = mimic, family = binomial())))
exp(coef(glm(readmitted_30 ~ LOS, data = mimic, family = binomial())))

summary((glm(readmitted_30 ~ los_dichotomous, data = mimic, family = binomial()))) #dichotomous
exp(coef(glm(readmitted_30 ~ los_dichotomous, data = mimic, family = binomial())))
```

Combined logistic model of variables (pre-categorization)
```{r}
model1 <- glm(readmitted_30 ~ GENDER + ADMISSION_TYPE + discharge_categories + INSURANCE + marital_dichotomous + ethnicity_categories + AGE + LOS, data = mimic, 
                  family = binomial())
summary(model1)
exp(coef(model1)) #Odds ratios.
confint(model1) #Confidence intervals for fit
exp(cbind(OR = coef(model1), CI = confint(model1))) #OR and 95%CI

# Creating a nice summary table
t3 <- tbl_regression(model1, exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
t3
```
Logistic Model (Post-Dichotomization)
```{r}

model2 <- glm(readmitted_30 ~ GENDER + admission_dichotomous + discharge_dichotomous + insurance_categories + marital_dichotomous + ethnicity_dichotomous + age_dichotomous + los_dichotomous, data = mimic, 
                  family = binomial())
summary(model2)
#For more detailed Information
#exp(coef(model2)) #Odds ratios.(need to exponentiate for LR)
#confint(model2) #Confidence intervals for fit
#exp(cbind(OR = coef(model1), CI = confint(model2))) #OR and 95%CI

# Creating a nice summary table
t4 <- tbl_regression(model2, exponentiate = TRUE) %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
t4
```


Some type of cross validation?? I might just have to identify factors 
```{r}
#K Fold Cross Validation
N = nrow(mimic)
K = 10
set.seed(48585)
s = sample(1:K, size = N, replace = T)
pred.outputs.glm <- vector(mode = "numeric", length = N)
obs.outputs <- vector(mode = "numeric", length = N)
offset<- 0 

for (i in 1:K){
  train <- filter(mimic, s != i)
  test <- filter(mimic, s != i)
  obs.outputs[1:length(s[s == i]) + offset] <- mimic$readmitted_30
  
  # GLM train/test
  glm <- glm(readmitted_30 ~ GENDER + admission_dichotomous + discharge_dichotomous + insurance_categories + marital_dichotomous + ethnicity_dichotomous + age_dichotomous + los_dichotomous, data = train, family = binomial(logit))
  glm.pred.curr <- predict(glm, test, type = "response")
  pred.outputs.glm[1:length(s[s == i]) + offset] <- glm.pred.curr
  
  offset <- offset + length(s[s == i])
}
```

ROC Curve
```{r}
library(pROC)
roc(mimic$readmitted_30, glm.pred, ci = TRUE)

plot.roc(mimic$readmitted_30, glm.pred, ci = TRUE)
plot.roc(obs.outputs, pred.outputs.glm, col = "red", add = TRUE)
legend("bottomright", legend = c("Training", "Cross-Validation"), col = c("black", "red"), lwd = 2)
```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

Table comparing readmission to non-readmission cohort
```{r}

```

Table comparing levels within readmission
```{r}

```

Table showing the logistic regression model and the performance details
```{r}

```

Training vs cross validation Table
```{r}

```

AUC
```{r}

```

Calibration?
```{r}

```

References:
Bailey, M. K., Weiss, A. J., Barret, M. L., & Jiang, H. J. (2019). Statistical Brief #248: Characteristics of 30-Day All-Cause Hospital Readmissions, 2010-2016. Retrieved from https://www.hcup-us.ahrq.gov/reports/statbriefs/sb248-Hospital-Readmissions-2010-2016.pdf

BBC (2020). BBPlot. Github Repository. Retrieved from https://github.com/bbc/bbplot/. 

Bradley, E. H., Sipsma, H., Horwitz, L. I., Curry, L., & Krumholz, H. M. (2014). Contemporary Data About Hospital Strategies to Reduce Unplanned Readmissions: What Has Changed? JAMA Internal Medicine, 174(1), 154-156. doi:10.1001/jamainternmed.2013.11574

Healthy People 2020. (2020). Social Determinants of Health. Retrieved from https://www.healthypeople.gov/2020/topics-objectives/topic/social-determinants-of-health

McDermott, K. W., & Jiang, H. J. (2020). Characteristics and Costs of Potentially Preventable Inpatient Stays, 2017. Retrieved from https://www.hcup-us.ahrq.gov/reports/statbriefs/sb259-Potentially-Preventable-Hospitalizations-2017.pdf

MIMIC-III, a freely accessible critical care database. Johnson AEW, Pollard TJ, Shen L, Lehman L, Feng M, Ghassemi M, Moody B, Szolovits P, Celi LA, and Mark RG. Scientific Data (2016). DOI: 10.1038/sdata.2016.35. Available from: http://www.nature.com/articles/sdata201635

Pollack, R. (2019). Perspective: Post-acute care is a vital part of health care delibery. Retrieved from https://www.aha.org/news/perspective/2019-07-12-perspective-post-acute-care-vital-part-health-care-delivery

Prusaczyk, B., Kripalani, S., & Dhand, A. (2019). Networks of hospital discharge planning teams and readmissions. Journal of Interprofessional Care, 33(1), 85-92. doi:10.1080/13561820.2018.1515193

Zhou, H., Della, P. R., Roberts, P., Goh, L., & Dhaliwal, S. S. (2016). Utility of models to predict 28-day or 30-day unplanned hospital readmissions: an updated systematic review. BMJ Open, 6(6), e011060. doi:10.1136/bmjopen-2016-011060

