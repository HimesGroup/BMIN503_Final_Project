---
title: "BMIN503/EPID600 Project Template - CHANGE TO PROJECT TITLE"
author: "Jacqueline Soegaard, MD"
output: 
  html_document:
    toc: TRUE 
    toc_depth: 5
    toc_float: 
        collapsed: true
        smooth_scroll: true
    depth: 3 
    theme: paper 
    highlight: tango
    df_print: paged
    fig_width: 8

---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

My initial project goals were to evaluate the patterns of thyroid nodule management at Penn Medicine. My main faculty mentor from this project was Dr. Heather Wachtel from Endocrine Surgery. After discussing with her, I better understand the clinical context of health system management of thyroid nodules, particularly concerns for overdiagnosis and overmanagement. I also spoke with Yulia Borovskiy from the Penn Data Access Center to better understand the ways in which users/clinicians can request data from the Penn Data Access center for research purposes. We identified that we would need a IRB or QI IRB exemption to obtain the data request and are in the process of submitting the request. Given their timelines, we determined that the process of obtaining IRB review and then having our data request completed by the DAC would take too long for the timeline of this class project. In discussing this challenge with Dr. Wachtel, she and Abigail Doucette (one of the PSOM senior data analysts) were able to give me access to an existing database of deidentified patient and tumor data for patients within our health system with medullary thyroid cancer (MTC). 

Given that the initial goals of this project cannot be met with the existing database, I nevertheless believe we can gain new insights from this data regarding the characteristics of patients and tumors with MTC. Specifically, we will look at summary statistics for this population and their tumors, evaluate parameters for location and timing of evaluation and treatment, and identify characteristics associated with tumor upstaging, tumor recurrence, and death. Further, familiarity with this data—which contains similar variables to those we expect for our thyroid nodule management dataset— will be useful in defining the variable library and analysis code for the future project. 

Jacqueline Soegaard Final Project GitHub Repository: <https://github.com/jsoegaard/BMIN503_Final_Project>

### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

Thyroid cancer is a relatively uncommon cancer, with an estimated incidence of 52,890 cases per year in the United States [American Cancer Society: Cancer Facts and Figures 2020]. It carries a favorable prognosis, with a disease-related 5-year survival of 98% overall and of 56% in patients with distant disease at the time of diagnosis. Thyroid cancer can be divided into several pathologic subtypes. The epithelial subtypes comprise three main categories: papillary (85% of cases), follicular (12%), and anaplastic or undifferentiated cancer (<3%). Medullary thyroid cancer (MTC) is another, rare malignancy— a neuroendocrine tumor arising from the parafollicular or C cells of the thyroid glands. It only accounts for 1-2 percent of thryoid cancers in the Unites States [CITATION: Revised American Thyroid Association guidelines for the management of medullary thyroid carcinoma. Wells SA Jr, Asa SL, et al, American Thyroid Association Guidelines Task Force on Medullary Thyroid Carcinoma]. While most cases are sporadic, around 25% of cases are familial as part of the multiple endocrine neoplasia type 2 (MEN2) syndrome. Management includes total thyroidectomy and cervical lymph node dissection. While central neck dissections are always recommended, there is controversy as to whether prophylactic lateral neck dissections are warranted. 

While it is a relatively rare tumor, at Penn Medicine we have a large amount of experience and tumor registry data for patients with this disease. Given our local experience, we wish to examine our dataset to understand summary statistics for our local MTC population and their tumors, evaluate parameters for location and timing of evaluation and treatment, and identify characteristics associated with tumor upstaging, tumor recurrence, and death. Given that the MTC patient population is managed by endocrinology, endocrine surgery, at times medical oncology, and at times medical genetics, the multimodal management of these patients is by definition interdisciplinary. 

<https://www.uptodate.com/contents/medullary-thyroid-cancer-clinical-manifestations-diagnosis-and-staging?search=thyroid%20cancer&topicRef=7838&source=see_link>
<https://www.uptodate.com/contents/medullary-thyroid-cancer-surgical-treatment-and-prognosis?search=thyroid%20cancer&topicRef=7848&source=see_link> 

> Medullary thyroid cancer is a relatively uncommon cancer type. However, at Penn we have a large amount of experience and have a pathologic dataaset. Evaluate risk factors for recurrence. 


### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

Data used: "Extent of MTC dataset" obtained from Penn Medicine disease registries. 
  + Dataset contains data from 5351 tumors from 5127 patients with thyroid cancer
  + Data was extracted for patients/tumors for two years, between 01/02/2013 and 12/31/2015
  + Other selection criteria: PrimarySiteCode == C73.9, PrimarySiteCategory == Endocrine, PrimarySiteDesc == thyroid gland. 
  + The data has been stripped of PHI. Patients in the dataset are identified by a PatientSystemId specific to this dataset. 

General Methodological Approach: 
  + Demographics table (age at dx, sex, race, site of treatment, class of diagnosis/management site, date of first contact, vital status)
  + Subgroup demographics or additional characteristics (lag time from first contact to surgery)
  + Outcome of interest (subgroup if applicable): upstaging, recurrence, death
  + Additional outcomes of interests or results of statistical modeling: prediction of upstaging (regression, supervised machine learning), prediction of recurrence 
  
First, load all necessary packages: 
```{r global options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

#Data manipulation packages 
library(tidyverse)
library(stringr)
library(dplyr)
library(forcats)

#Table package
library(table1)

#Plotting and color pallete packages
library(RColorBrewer)
library(ggplot2)
library(ggsci)

#Load machine learning packages
library(randomForest)
library(ggdendro)

#AUC/ROC packages
library(pROC)

#Load geospatial and census packages 
#library(sf)
#library(tidycensus)
#library(leaflet)

#Create general theme for plots 
mytheme <- theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15), hjust = 0.5), 
             legend.title = element_text(colour = "steelblue",  face = "bold.italic", family = "Helvetica"), 
             legend.text = element_text(face = "italic", colour="steelblue4",family = "Helvetica"), 
              axis.title = element_text(face = "bold", family = "Helvetica", size = (10), colour = "steelblue4"),
              axis.text = element_text(family = "Courier", colour = "steelblue4", size = (10)))

``` 

Next, load the dataset into a two dataframe - one called `patients` and another called `tumors`. All missing/empty values will be set to NA

```{r, eval=TRUE}

patients <- read.csv("~/Documents/LocalFiles/503_MTC_FinalProject/20232020_ThyroidCancer_RegistryData_2011to2018_Patients_deidentified.csv", na.strings=c("","NA"))
tumors.sep <- read.csv("~/Documents/LocalFiles/503_MTC_FinalProject/20232020_ThyroidCancer_RegistryData_2011to2018_Tumors_deidentified.csv", na.strings=c("","NA"))

```

Clean the data to facilitate manipulation and analysis. 

```{r, eval=TRUE}

#Merge the two datasets based on Patient id - add the patient data to the rows of "tumors" 

tumors <- tumors.sep %>% left_join(patients, by = "PatientSystemId") #add the patient-level data to the appropriate columns in the tumors file, by PatientSystemID

#Clean the data - remove unnecessary columns, convert data types as needed

#Remove uneccessary columns (which have the same value for all entries in dataset)
tumors3 <- tumors %>% 
  select(-c(AnalyticYn, PrimarySiteCode, PrimarySiteDesc, PrimarySiteCategory, PrimarySiteSubcategory.x, PrimarySiteSubcategory.y)) 

#Convert specific columns into factors
factor_cols <- c("ReportingHospital", "PrimarySequence", "ClassCaseDesc", "HistologyCode", "HistologyDesc", "Laterality", "Grade", "LvInvasion", 
                     "ClinT", "ClinN", "ClinM", "ClinStage", "PathT", "PathN", "PathM", "PathStage", "SummaryStage", "SurgeryDesc", "RtDesc", "RtModalityDesc",
                     "RtVolumeDesc", "ChemoDesc", "HormoneDesc", "HUP_YN", "PAH_YN", "MCP_YN", "PPMC_YN", "CCH_YN", "LGH_YN", "Sex", "Race", "VitalStatus") 

tumors3[,factor_cols] <- lapply(tumors3[,factor_cols], factor)

#Convert date columns from character to date object 

date_cols <- c("DateFirstContact.x", "DateDx.x", "MstDefSurgeryDate", "MstDefRtDate", "MstDefChemoDate", "MstDefHormoneDate", "MstDefImmunoDate", "FirstRecurrenceDate","DateFirstContact.y", "DateDx.y", "LastContactDate", "DeathDate")

tumors3[,date_cols] <- lapply(tumors3[,date_cols], function(x) as.Date(x, "%m/%d/%Y"))

sapply(tumors3, class)

#Extract some subsets of data
mtc <- tumors3 %>% filter(HistologyDesc == "Medullary Carcinoma, NOS") # extract patients with MTC
nonvital <- tumors3 %>% filter(!is.na(DeathDate)) #extract patients from dataset who have died
recurred <- tumors3 %>% filter(!is.na(FirstRecurrenceDate)) #extract patients from dataset who have recurred

#Make a histogram to identify the distribution of histologies in the dataset 
histology <- ggplot() + geom_bar(data=tumors3, aes(sort(HistologyDesc)))

#Upstaging - extract cases with know clinical and pathologic staging, then look at cases where upstaging

tumors.staged <- tumors %>% 
  filter(ClinStage != "Unknown") %>% 
  filter(ClinStage != "NA") %>%
  filter(PathStage != "Unknown") %>%
  filter(PathStage != "NA")

tumors.stageMigration <- tumors.staged %>%
  filter(tumors.staged$PathStage != tumors.staged$ClinStage) %>%
  select(c(PatientSystemId, TumorId, HistologyDesc, ClinT, PathT, ClinN, PathN, ClinM, PathM, ClinStage, PathStage))

#Look at the tumors with stage migration by histology type
table(tumors.staged$HistologyDesc)

#make a histogram of the ages in the dataset
ages <- ggplot() + geom_histogram(data=tumors3, aes(AgeAtDx.x))
ages_mtc <- ggplot() + geom_histogram(data=mtc, aes(AgeAtDx.x))

#Create lag time variables? 
surgLagTime <- tumors3$MstDefSurgeryDate - tumors3$DateDx.x
surgLagTime_2 <- tumors3$MstDefSurgeryDate - tumors3$DateFirstContact.x
rtLagTime <- tumors3$MstDefRtDate - tumors3$MstDefSurgeryDate

```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

Table of descriptive statistics
```{r, eval=TRUE}
table1::label(tumors3$AgeAtDx.x) <- "Age at Diagnosis"
table1::label(tumors3$Sex) <- "Sex"
table1::label(tumors3$Race) <- "Race"
table1::label(tumors3$ReportingHospital) <- "Reporting Hospital"
table1::label(tumors3$HistologyDesc) <- "Histologic diagnosis"
table1::label(tumors3$Grade) <- "Tumor Grade"
table1::label(tumors3$ClinStage) <- "Clinical Stage"
table1::label(tumors3$PathStage) <- "Pathologic Stage"
table1::label(tumors3$SurgeryDesc) <- "Surgery" 
table1::label(tumors3$RtDesc) <- "Radiation Therapy"
table1::label(tumors3$HormoneDesc) <- "Hormone Therapy"
table1::label(tumors3$ChemoDesc) <- "Chemotherapy"


tumors_summarytable <- table1::table1(~AgeAtDx.x + Sex + Race + ReportingHospital + HistologyDesc + Grade + ClinStage + PathStage + SurgeryDesc + RtDesc | HistologyDesc == "Medullary Carcinoma, NOS", data = tumors3)

tumors_summarytable

```

### Conclusion

### References

Revised American Thyroid Association guidelines for the management of medullary thyroid carcinoma. Wells SA Jr, Asa SL, et al, American Thyroid Association Guidelines Task Force on Medullary Thyroid Carcinoma

American Cancer Society: Cancer Facts and Figures 2020
