---
title: "BMIN503/EPID600 Final Project"
author: "Jason Grey Faulkenberry"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r echo=FALSE, cache=FALSE, include=FALSE}
options(width = 400)
graphics.off()
#Load libraries
library(dplyr)
library(ggplot2)
library(knitr)
library(data.table)
library(stringr)
library(car)
library(sjmisc)
library(Hmisc)
library(ggplotify)
library(tibble)
library(kableExtra)
options(knitr.table.format = "html")
```  
### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

Final Project on Github: [https://github.com/Dokotela/BMIN503_Final_Project](https://github.com/Dokotela/BMIN503_Final_Project)


### Introduction 
+In the first paragraph, describe the problem addressed, its significance, and some background to motivate the problem.
It is well-known that obesity is a problem in our society. This is not just true for adults, but also for children. It is estimated that 18.5% of chldren 2-19 years old were overweight as of 2016^1^. The rate of overweight is over 30%^2^. Hispanics and Non-Hispanic blacks had a higher rate of obesity than Non-Hispanic whites, and those in a lower socio-economic class. The outcomes of this are many, varied and can be severe, including a myriad of health problems along with a wide-range of socio-emotional consequences. Pediatricians are typically not familiar with the best ways to counsel and educate families about nutrition and exercise, and typically have enough time to do so. One possible solution is telehealth interventions. There have already been a few studies demonstrating improvement in adolescent physical activity or increase in fruit and vegetable consumption through telehealth interventions^3,4^.

+In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.
In order for these interventions to be effective, multiple different groups will need to be involved. Patients typically see their primary pediatrician as responsible for their health information, so it would be reasonable to base such an intervention out of an outpatient clinic. However, as above, pediatricians don't generally have the expertise or time to do such counseling. One could involve psychologists, pediatricians, endocrinologists, eating disorder specialists, socail workers, other behavioral health specialists, coaches, and to do such a telehealth intervention would require some technicians to assist with setup, tech support and similar issues. We worked with nutritionists, pediatricians, and psychologists to develop our intervention, which questionnaires would be appropriate, and how to properly use motivational interviewing techniques. One of the concerns, and I'm not sure that we did this as well as we should have with the interventions, was to focus on health (eating nutritious foods and getting regular exercise) instead of focusing on weight in children. 


### Methods
+In the first paragraph, describe the data used and general methodological approach. 
#####Participants
Patients were recruited from a local Federally Qualified Health Center. Inclusion criteria were age five through 17, inclusive, with a diagnosis of asthma (requiring medication) or overweight (greater than or equal to 85% for age). All study subjects had to be fluent in English or Spanish. Parents/Guardians were also required to be fluent in English or Spanish. This was determined by their own assessment.

#####Procedures
Prior to the study, it underwent and gained IRB approval and also an MOU and letter of support from the clinical medical director.

The clinic staff identified patients meeting the inclusion criteria. They then asked the patient's permission to be contacted about the study. There were also fliers in the waiting room allowing the patient to contact the study team directly, and signed a release of information to allow review of medical history pertinent to the study. If the patient gave consent to contact, they were called by the study team, given an explanation of the study, and if interested were scheduled for their initial appointment. 

All patients who meet the study inclusion criteria were offered an integrated approach to chronic condition management with a specialist team (a chronic condition specialist and a behavior specialist). Initially the goal was to recruit and have two arms, one with a technology component and the other without. As recruitment was more difficult than anticipated, it was changed to a single arm study. 

At the initial visit the full study was explained, and signed forms for consent and assent were obtained. the patients’ history, including medical, family, genetic considerations and social history was evaluated, including a chart review. Data from the medical charts that will be extracted include: ER and hospital visits, type, frequency and dose of medications used, blood pressure, heart
rate, weight, height, diet history and exercise patterns. At the initial visit for overweight children, the patients will be assessed for their behaviors and attitudes regarding eating, physical activity,
sedentary time and motivation. If the patient has asthma, the pediatrician will assess understanding of
the disease. At the first and last visit there were pre- and post-intervention assessment points, adherence to medical regimen, physical activity and dietary habits that were gathered. During the 4 intervening visits in addition to the first and last, quality of life of assessed. At the final visit data was also gathered aboutt he patient and parent perceptions of the program. All surveys were completed in REDCap (internet-based, secure, encrypted, HIPAA-compliant software), whether in person or online, to allow easier data analysis.

During the course of the study, the chronic condition pediatrician and behavior specialist will see patients in a consult capacity for their chronic condition, but the patient will continue
to see their regular pediatrician for primary care needs. At every visit the pediatrician will review changes since the last visit, including a chart review. For overweight children the specialist will also provide education about what is considered healthy eating,
physical activity and motivation. For children with asthma, the pediatrician will provide education
about the disease itself, including symptoms, precipitating, risk and preventive factors, its natural
history and proper management. The behavior health specialists will then work with the patients to
develop a plan on how to follow their treatment plan and achieve healthy behaviors. Problem-solving,
goal-setting, and motivational interviewing techniques will be used.
Each patient enrolled in the study will be given access to technology in the form of a tablet computer. The
tablets will be installed with software to help educate patients and their families about asthma and
overweight/obesity and track progress in managing them. In addition to educational apps, each tablet will be
preloaded with Fuze, a secure, HIPAA compliant teleconferencing app. The first and last visits will be done in
person at the clinic, but the four follow-up visits will be conducted as a “virtual” visit via online
teleconferencing. On the date of each “virtual” visit, the study participant will be called 3 times to try and meet.
For this group regular service and usage fees during the course of the study will be covered as part of the study
and will not be billed. For the group selected to receive a tablet, they will be required to complete and sign an
Equipment Check-Out Form and an End-User agreement form from Verizon, and will be required to return the
tablet at the end of the study.
All participants will be called 1 week before each appointment, then again 72 hours before the appointment.
At each visit attended, every participant will receive a $10.00 gift certificate.
For each participant that is already enrolled that has not received a tablet, they will be called and alerted to the
change in the study protocol. If they are would still like to continue being involved in the study, they will be
seen in clinic for their next scheduled appointment in person, and at that visit they will be given a tablet. After
that all of their visits will be via teleconferencing until the final visit.

+Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 
```{r}
#Get the data

#Read Data
data=read.csv('data.csv')

#delete the test patient
data <- data[-which(data$redcap_id == 'ce0b1de0534e326798805670fd231294'),]

#not sure why this one variable is coded differently, but this fixes it
data <- data %>% mutate(pedsqlparent_01 = factor(pedsqlparent_01, levels = c("", 0, 1, 2, 3, 4), labels = c(NA, 0, 1, 2, 3, 4)))
data$pedsqlparent_01 <- as.numeric(as.character(data$pedsqlparent_01))

#Allow some functions
source('functions.r')

#Trying to clean the data up a little, grouping some differently, changing column names, etc.
source('cleaning.r')

#Set factors and levels
source('naming.r')

#make dataframe for those that completed a final visit
complete <- subset(data, data$redcap_id %in% data$redcap_id[which(data$redcap_event_name=="visit6")])

#make dataframe from above of just the first visit (to evaluate demographics)
completeFirst <- droplevels(subset(complete, complete$redcap_event_name=="visit1"))
completeLast <- droplevels(subset(complete, complete$redcap_event_name=="visit6"))

#merging the first and last dataset to make one that can be more easily compared (variables end in .x and .y)
combined <- merge(completeFirst, completeLast, by="redcap_id")

#Table with similar data as above, but formatted differently
firstLast <- complete[complete$redcap_event_name %in% c('visit1', 'visit6'),]
firstLast <- droplevels(firstLast)
```

```{r warning = FALSE}
#making some tables of basic descriptive data
list1 <- c("Obese?", "Asthma?", "dem_gender", "dem_grade", "Ethnicity", "dem_language_pref", "tech_kid_device_time", "tech_kid_brand___1", "tech_kid_os___1", "dem_language_home", "dem_parent_habitants", "dem_parent_sex", "dem_parent_ethnicity", "dem_parent_language_pref", "dem_parent_marital", "dem_parent_us", "dem_parent_income", "dem_parent_job", "dem_parent_school")

#select those columns
demotable <- completeFirst[which(colnames(completeFirst) %in% list1)][, list1]

list2 <- c("Is child obese", "Does child have asthma", "Gender of child", "Grade of child", "Ethnicity of child", "Child's preferred language", "Time child spends on device", "Technology brand used", "Technology OS used", "Language spoken at home", "Number of people living at home", "Gender of parent", "Ethnicity of parent", "Parent's preferred language", "Parent's Marital Status", "How long has parent been in US", "Parent's Income", "Parent's Employment", "Parent's highest school completed")

#rename the columns something nicer for Table 1
colnames(demotable) <- list2

tablelist <- c('<table><tr>')

tablelist <- c(tablelist, '<td valign="top" width="25%"><table>')
for(i in 1:7){ tablelist <- c(tablelist, '<tr><td>', kable(demotable %>% group_by_at(list2[i]) %>% summarise(" " = n()) %>% as.data.frame(.), format='html', escape = TRUE, position="centered") %>% kable_styling(full_width = TRUE), '</td></tr>') }

tablelist <- c(tablelist, '</table></td><td valign="top" width="25%"><table>')
for(i in 8:11){ tablelist <- c(tablelist, '<tr><td>', kable(demotable %>% group_by_at(list2[i]) %>% summarise(" " = n()) %>% as.data.frame(.), format='html', escape = TRUE, position="centered") %>% kable_styling(full_width = TRUE), '</td></tr>') }

tablelist <- c(tablelist, '</table></td><td valign="top" width="25%"><table>')
for(i in 12:16){ tablelist <- c(tablelist, '<tr><td>', kable(demotable %>% group_by_at(list2[i]) %>% summarise(" " = n()) %>% as.data.frame(.), format='html', escape = TRUE, position="centered") %>% kable_styling(full_width = TRUE), '</td></tr>') }

tablelist <- c(tablelist, '</table></td><td valign="top" width="25%"><table>')
for(i in 17:19){ tablelist <- c(tablelist, '<tr><td>', kable(demotable %>% group_by_at(list2[i]) %>% summarise(" " = n()) %>% as.data.frame(.), format='html', escape = TRUE, position="centered") %>% kable_styling(full_width = TRUE), '</td></tr>') }

tablelist <- c(tablelist, '</table></td></tr></table>')
```

```{r}
#get list of significant results for pedsql from patient, then plot
sig <- applying("qlPtTotal.x", "qlPtSchool.x", combined)
pqlpatientplot <- lapply(colnames(select(complete, "qlPtTotal":"qlPtSchool")), boxy, info = complete, sig = sig)

#plot list of significant results for pedsql by parent, then plot
sig <- applying("qlParTotal.x", "qlParSchool.x", combined)
pqlparentplot <- lapply(colnames(select(complete, "qlParTotal":"qlParSchool")), boxy, info = complete, sig = sig)

#get significant results for first and last visit for activity and nutrition surveys
sig <- applying("act_nutri_kids01.x", "act_nutri_kids27.x", combined)
actNutriKids <- lapply(gsub(".f", "", sig$Name), boxy, info = firstLast, sig = sig)

#get significant results for first and last visit for activity and nutrition surveys from parents
sig <- applying("act_nutri_parent01.x", "act_nutri_parent31.x", combined)
actNutriParents <- lapply(gsub(".f", "", sig$Name), boxy, info = firstLast, sig = sig)

#get significant results for first and last visit for weight surveys from patient
sig <- applying("weight_01.x", "weight_16.x", combined)
weightPts <- lapply(gsub(".f", "", sig$Name), boxy, info = firstLast, sig = sig)
```

```{r warning = FALSE}
weights=read.csv('weights.csv')
weights$date <- as.Date(as.character(weights$date))
colnames(weights)[ncol(weights)] <- "days"
weights$days <- weights$date - as.Date("2014-01-01")
prestudy <- subset(weights, date < "2015-09-01")
poststudy <- subset(weights, date >= "2015-09-01")
prestudy <- droplevels(prestudy)
poststudy <- droplevels(poststudy)

#collect the groups, get linear regression lines, store coefficients
measures <- merge(lining(prestudy), lining(poststudy), by = "redcap_id", all.y=TRUE)
measures$group <- if_else(grepl("Control", measures$redcap_id), "control", "study")
studyprepost <- subset(measures, group=="study")
controlprepost <- subset(measures, group=="control")

#create graphs for patient weights, fit segments of trend lines to weights before and after study started
wtplots <- lapply(levels(weights$redcap_id), plotting, pre=prestudy, post=poststudy)
```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

```{r results="asis"}
#this displays table1 for the patients
cat(tablelist, sep = '')
```
```{r}
#perform ttests on the different groups
t.test(studyprepost$slope.x, studyprepost$slope.y, alternative = "two.sided")$p.value
t.test(controlprepost$slope.x, controlprepost$slope.y, alternative = "two.sided")$p.value
t.test(studyprepost$slope.x, controlprepost$slope.x, alternative = "two.sided")$p.value
t.test(studyprepost$slope.y, controlprepost$slope.y, alternative = "two.sided")$p.value
```
```{r warning=FALSE, fig.height=20, fig.width=20}
#display the plots created above of the patients survey information
gridExtra::grid.arrange(grobs = pqlpatientplot, ncol=2) #patients pedsql survey results over 6 visits
gridExtra::grid.arrange(grobs = pqlparentplot, ncol=2) #parents pedsql survey results over 6 visits
```
```{r warning=FALSE, fig.height=10, fig.width=20}
gridExtra::grid.arrange(grobs = actNutriKids, ncol=2) #child's answers to activity and nutrition survey, first and last visits
gridExtra::grid.arrange(grobs = actNutriParents, ncol=2) #parent's answers to activity and nutrition survey, first and last visits
```
```{r warning=FALSE, fig.height=5, fig.width=20}
gridExtra::grid.arrange(grobs = weightPts, ncol=2) #patient's answers to weight questionnaire, first and last visits
```
```{r warning=FALSE, fig.height=20, fig.width=20}
#plot the weight changes for each participant and control
gridExtra::grid.arrange(grobs = wtplots, ncol=4)
```
