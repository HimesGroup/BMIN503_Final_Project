---
title: "BMIN503/EPID600 Project"
author: "Nik Padmanabhan"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.

### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

This project aims to find associations between white matter content and CSF biomarker levels in Alzheimer's patients, using ADNI data. Although Alzheimer's disease primarily affects grey matter, results of this work could improve characterization of the disease. 

### Introduction 
In the first paragraph, describe the problem addressed, its significance, and some background to motivate the problem.

In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

Alzheimer's disease, which is a progressive, chronic, neurodegenerative disease, affects more than 3 million people in the US each year. There is currently no cure or method to stop its progression. After diagnosis, the life expectancy of patients generally ranges from 3-10 years. The disease, characterized by extracellular amyloid beta deposits and neurofibrillary tangles, primarily affects grey matter in the brain. However, white matter abnormalities also exist, although these changes take place prior to the neurodegenerative process. Patients with preclinical Alzheimer's disease, before substantial changes of the grey matter have happened, have been shown to have similar levels of white matter abnormalities as patients in later stages. Assiciations between white matter content and and cerebrospinal fluid biomarkers could improve the understanding of the pathogenesis of Alzheimer's disease, which could improve and expedite the development of treatments. 

This analysis would not be possible without the Alzheimer's disease neuroimaging initiative (ADNI), in which multiple types of data, including clinical, imaging, and biospecimen data, were collected from both affected and control populations. As a result, imaging data must be treated differently than the other data types, and quantitative values must be extracted for comparison. The R packages oro.dicom and oro.nifti facilitate analyzing MRI data, such as estimating white matter content. In addition, toolkits in R such as ANTs and FSL enable image preprocessing procedures such as image registration, brain extraction, and inhomogeneity correction. Once numerical values have been extracted from the image data, statistical models can be developed to better understand the characteristics Alzheimer's disease. Ideally, machine learning algrithms will be able to predict disease progression of patients in early stages. This work will hopefully impact the understanding of the disease over time, and therefore improve the development of treatments. 

### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

```{r eval=TRUE}
library(devtools)
library(oro.dicom)
library(oro.nifti)
#Visualize individual slice
setwd("C:/Users/Nik/Documents/ADTest/ADNI/011_S_0003/Axial_PD-T2_TSE/2005-09-01_10_46_12.0/S9126")
slice = readDICOM("ADNI_011_S_0003_MR_Axial_PD-T2_TSE__br_raw_20050901115113886_94_S9126_I7062.dcm")
class(slice)

d=dim(t(slice$img[[1]]))
image(1:d[1],1:d[2], t(slice$img[[1]]),col=gray(0:64/64))
```
```{r eval=TRUE}
setwd("C:/Users/Nik/Documents/ADTest/ADNI/011_S_0003/Axial_PD-T2_TSE/2005-09-01_10_46_12.0/")
all_slices = readDICOM("S9126")

dim(all_slices$img[[36]])

nii=dicom2nifti(all_slices)
d=dim(nii); 
d

#Visualize single NIfTI image
class(nii)
image(1:d[1], 1:d[2], nii[,,36], col=gray(0:64/64), xlab="",ylab="")

#Visualize entire stack
image(nii)
```


```{r}
slice$img[[1]][101:105,121:125]
hist(slice$img[[1]][,],breaks=50, xlab="Intensity", prob=T, col=rgb(0,0,1,1/4), main="")
```

```{r eval=TRUE}
#Define a different transfer function
lin.sp<-function(x,knots,slope){
    knots<-c(min(x),knots,max(x))
    slopeS<-slope[1]
 for(j in 2:length(slope)){
   slopeS<-c(slopeS,slope[j]-sum(slopeS))}
   rvals<-numeric(length(x))
 for(i in 2:length(knots)){
   rvals<-ifelse(x>=knots[i-1], slopeS[i-1]*(x-knots[i-1])+rvals,rvals)}
 return(rvals)}
#Define a spline with three knots and four slopes
knot.vals<-c(.25,.5,.74)
slp.vals<-c(2,1,.5,.25)

#Plot the Spline Transfer Function
par(new = TRUE)
curve(lin.sp(x,knot.vals,slp.vals),axes=FALSE,xlab="",ylab="",col=2,lwd=3)
axis(side=4,at = pretty(range(im_hist$mids))/max(T1),labels=pretty(range(im_hist$mids)))
mtext("Transformed Intensity", side=4, line=2) 

trans<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(nii,z=36,plot.type='single', main="Original Image")
image(trans,z=36,plot.type='single',main="Transformed Image") 
```


```{r eval=TRUE}
#Original Image Histogram
s2 <- nii[,,36]
hist(s2[s2>0],breaks=100, xlab="FLAIR", prob=T, col=rgb(0,0,1,1/4), main="")

#Transformed Image Histogram
s3 <- trans[,,36]
hist(s3[s3>0],breaks=100, xlab="FLAIR", prob=T, col=rgb(0,0,1,1/4), main="")


#setwd("C:/Users/Nik/Documents/ADTest/ADNI/011_S_0003/Axial_PD-T2_TSE/2005-09-01_10_46_12.0/S9126")
#fname="Test_nifti_File"
#writeNIfTI(nim=trans,filename=fname)
```

```{r eval=TRUE}
#Brain extraction using FSLR from a virtual machine
#bet_img = fslbet(infile=nii, retimg=TRUE)

setwd("C:/Users/Nik/Documents/ADTest/ADNI/011_S_0003/Axial_PD-T2_TSE/2005-09-01_10_46_12.0/")
sstrip = readNIfTI("newimg.nii.gz")
image(sstrip)
```

```{r eval=TRUE}
#Original Image
is_btw_400_600<- ((nii>400) & (nii<600)) #1 or 0 for each voxel
nii_mask<-nii
nii_mask[!is_btw_400_600]=NA
overlay(nii,nii_mask,z=36,plot.type="single") 

#Transformed Image
is_btw_700_1150<- ((trans>700) & (trans<1150)) #1 or 0 for each voxel
trans_mask<-trans
trans_mask[!is_btw_700_1150]=NA
overlay(trans,trans_mask,z=36,plot.type="single") 

#Transformed and Brain-extracted Image
is_btw_700_1150<- ((sstrip>700) & (sstrip<1150)) #1 or 0 for each voxel
sstrip_mask<-sstrip
sstrip_mask[!is_btw_700_1150]=NA
overlay(sstrip,sstrip_mask,z=36,plot.type="single") 

#Goes up the brain
overlay(nii,nii_mask) 
overlay(trans,trans_mask)
overlay(sstrip,sstrip_mask)

is_positive<- ((sstrip>0)) #1 or 0 for each voxel
#Total:
sum(table(sstrip[is_positive]))
#White Matter:
sum(table(sstrip_mask[is_btw_700_1150]))
#Ratio
sum(table(sstrip_mask[is_btw_700_1150]))/sum(table(sstrip[is_positive]))
```
### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

AD Patients
```{r eval=TRUE}
#3:
setwd("C:/Users/Nik/Documents/AD/ADNI/003/Axial_PD-T2_TSE/2005-09-01_10_46_12.0")
all_slices = readDICOM("S9126")
nii=dicom2nifti(all_slices)
trans003<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans003,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans003,filename="trans003")
#10:
setwd("C:/Users/Nik/Documents/AD/ADNI/010/Axial_PD-T2_TSE/2005-11-07_08_40_20.0")
all_slices = readDICOM("S8798")
nii=dicom2nifti(all_slices)
trans010<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans010,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans010,filename="trans010")
#29:
setwd("C:/Users/Nik/Documents/AD/ADNI/029/Axial_PD-T2_TSE/2005-10-14_09_00_42.0")
all_slices = readDICOM("S9903")
nii=dicom2nifti(all_slices)
trans029<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans029,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans029,filename="trans029")
#76:
setwd("C:/Users/Nik/Documents/AD/ADNI/076/Axial_PD-T2_TSE/2005-12-06_11_49_09.0")
all_slices = readDICOM("S10467")
nii=dicom2nifti(all_slices)
trans076<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans076,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans076,filename="trans076")
#83:
setwd("C:/Users/Nik/Documents/AD/ADNI/083/Axial_PD-T2_TSE/2005-12-14_08_44_38.0")
all_slices = readDICOM("S10567")
nii=dicom2nifti(all_slices)
trans083<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans083,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans083,filename="trans083")
#84:
setwd("C:/Users/Nik/Documents/AD/ADNI/084/Axial_PD-T2_TSE/2006-01-04_09_05_52.0")
all_slices = readDICOM("S10763")
nii=dicom2nifti(all_slices)
trans084<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans084,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans084,filename="trans084")
#91:
setwd("C:/Users/Nik/Documents/AD/ADNI/091/ADNI_______DOUBLE_TSE/2005-12-23_07_21_22.0")
all_slices = readDICOM("S10707")
nii=dicom2nifti(all_slices)
trans091<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans091,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans091,filename="trans091")
#93: 
setwd("C:/Users/Nik/Documents/AD/ADNI/093/Axial_PD-T2_TSE/2006-01-03_09_09_25.0")
all_slices = readDICOM("S10734")
nii=dicom2nifti(all_slices)
trans093<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans093,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans093,filename="trans093")
#94: 
setwd("C:/Users/Nik/Documents/AD/ADNI/094/ADNI_______DOUBLE_TSE/2005-12-28_16_22_23.0")
all_slices = readDICOM("S10711")
nii=dicom2nifti(all_slices)
trans094<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans094,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans094,filename="trans094")
#129: 
setwd("C:/Users/Nik/Documents/AD/ADNI/129/Axial_PD-T2_TSE/2006-02-06_12_11_17.0")
all_slices = readDICOM("S11486")
nii=dicom2nifti(all_slices)
trans129<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans129,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans129,filename="trans129")
#139: 
setwd("C:/Users/Nik/Documents/AD/ADNI/139/Axial_PD-T2_TSE/2006-01-24_11_27_40.0")
all_slices = readDICOM("S11077")
nii=dicom2nifti(all_slices)
trans139<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans139,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans139,filename="trans139")
#147: 
setwd("C:/Users/Nik/Documents/AD/ADNI/147/ADNI_______Double_TSE/2006-01-26_12_08_00.0")
all_slices = readDICOM("S11185")
nii=dicom2nifti(all_slices)
trans147<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans147,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans147,filename="trans147")
#213: 
setwd("C:/Users/Nik/Documents/AD/ADNI/213/Axial_PD-T2_TSE/2006-03-22_13_45_15.0")
all_slices = readDICOM("S12385")
nii=dicom2nifti(all_slices)
trans213<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans213,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans213,filename="trans213")
#221: 
setwd("C:/Users/Nik/Documents/AD/ADNI/221/Axial_PD_T2_FSE/2006-02-22_10_28_39.0")
all_slices = readDICOM("S11955")
nii=dicom2nifti(all_slices)
trans221<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans221,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans221,filename="trans221")
#266 
setwd("C:/Users/Nik/Documents/AD/ADNI/266/FSE_PD_T2/2006-03-22_10_40_28.0")
all_slices = readDICOM("S12380")
nii=dicom2nifti(all_slices)
trans266<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans266,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans266,filename="trans266")
#286: 
setwd("C:/Users/Nik/Documents/AD/ADNI/286/Double_TSE_/2006-03-23_13_31_56.0")
all_slices = readDICOM("S12432")
nii=dicom2nifti(all_slices)
trans286<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans286,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans286,filename="trans286")
#300: 
setwd("C:/Users/Nik/Documents/AD/ADNI/300/Axial_PD_T2_FSE/2006-05-09_15_01_31.0")
all_slices = readDICOM("S14135")
nii=dicom2nifti(all_slices)
trans300<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans300,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans300,filename="trans300")
#310: 
setwd("C:/Users/Nik/Documents/AD/ADNI/310/FSE_PD_T2/2006-03-24_11_48_44.0")
all_slices = readDICOM("S12467")
nii=dicom2nifti(all_slices)
trans310<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans310,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans310,filename="trans310")
#316: 
setwd("C:/Users/Nik/Documents/AD/ADNI/316/Axial_PD_T2_FSE/2006-03-29_15_23_42.0")
all_slices = readDICOM("S12586")
nii=dicom2nifti(all_slices)
trans316<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans316,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans316,filename="trans316")
#341: 
setwd("C:/Users/Nik/Documents/AD/ADNI/341/Axial_PD-T2_TSE/2006-04-06_10_41_52.0")
all_slices = readDICOM("S12950")
nii=dicom2nifti(all_slices)
trans341<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans341,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans341,filename="trans341")
#374: 
setwd("C:/Users/Nik/Documents/AD/ADNI/374/Axial_PD-T2_TSE/2006-04-10_11_43_19.0")
all_slices = readDICOM("S13029")
nii=dicom2nifti(all_slices)
trans374<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans374,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans374,filename="trans374")
#400: 
setwd("C:/Users/Nik/Documents/AD/ADNI/400/Double_TSE/2006-04-17_12_07_36.0")
all_slices = readDICOM("S13237")
nii=dicom2nifti(all_slices)
trans400<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans400,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans400,filename="trans400")
#426: 
setwd("C:/Users/Nik/Documents/AD/ADNI/426/Axial_PD_T2_FSE/2006-05-16_16_08_56.0")
all_slices = readDICOM("S14579")
nii=dicom2nifti(all_slices)
trans426<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans426,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans426,filename="trans426")
#457: 
setwd("C:/Users/Nik/Documents/AD/ADNI/457/Axial_PD_T2_FSE/2006-05-03_14_44_29.0")
all_slices = readDICOM("S13974")
nii=dicom2nifti(all_slices)
trans457<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans457,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans457,filename="trans457")
#470: 
setwd("C:/Users/Nik/Documents/AD/ADNI/470/Axial_PD-T2_TSE/2006-05-10_13_56_45.0")
all_slices = readDICOM("S14221")
nii=dicom2nifti(all_slices)
trans470<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans470,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans470,filename="trans470")
#474: 
setwd("C:/Users/Nik/Documents/AD/ADNI/474/Axial_PD-T2_TSE/2006-05-03_14_45_46.0")
all_slices = readDICOM("S13989")
nii=dicom2nifti(all_slices)
trans474<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans474,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans474,filename="trans474")
#543: 
setwd("C:/Users/Nik/Documents/AD/ADNI/543/Axial_PD-T2_TSE/2006-05-22_09_41_00.0")
all_slices = readDICOM("S14848")
nii=dicom2nifti(all_slices)
trans543<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans543,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans543,filename="trans543")
#577: 
setwd("C:/Users/Nik/Documents/AD/ADNI/577/Axial_PD-T2_TSE/2006-05-26_12_24_57.0")
all_slices = readDICOM("S14973")
nii=dicom2nifti(all_slices)
trans577<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans577,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans577,filename="trans577")
#606: 
setwd("C:/Users/Nik/Documents/AD/ADNI/606/Axial_PD_T2_FSE_-_48_slices/2006-07-20_11_51_16.0")
all_slices = readDICOM("S17189")
nii=dicom2nifti(all_slices)
trans606<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans606,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans606,filename="trans606")
#627:
setwd("C:/Users/Nik/Documents/AD/ADNI/627/FSE_PD_T2/2006-07-06_13_45_45.0")
all_slices = readDICOM("S16311")
nii=dicom2nifti(all_slices)
trans627<-lin.sp(nii, knot.vals*max(nii), slp.vals)
image(trans627,z=36,plot.type='single',main="Transformed Image") 
setwd("C:/Users/Nik/Documents/AD/Transformed/")
writeNIfTI(nim=trans627,filename="trans627")
```











