---
title: "Indicators of Wound Complication Risk in Patients with Thoracic Insufficiency Syndrome"
author: "Lia McNeely, CRNP"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.
### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.
> Overview:
The Center for Thoracic Insufficiency Syndrome (CTIS) at the Childrenâ€™s Hospital of Philadelphia (CHOP) treats patients who have early onset scoliosis and associated compromised growth of the thoracic cavity.  An article currently in review for publication, attempted to determine if there are risk factors that are predictive for wound related complications for patients undergoing implantation of rib-based distraction devices.  Many patients with wound complications, however, are patients undergoing the serial expansions of their rib-based distraction after the initial implantation.  The purpose of this project is to do an exploratory analysis of data from the Patient Safety Registry of the Center for Thoracic Insufficiency Syndrome to determine whether or not risk factors can be identified for wound complications in patients with early onset scoliosis undergoing serial rib distraction expansions. If a risk factor can be identified, then we may begin using this in clinical care as part of an informatics project we are working on for the CTIS program.

### Introduction 
In the first paragraph, describe the problem addressed, its significance, and some background to motivate the problem.

In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.


>Introduction:
The vertical elastic prosthetic titanium rib (VEPTR) is a rib-based distraction device that was invented by the late Dr. Robert Campbell, in the late 1980s.  Dr. Campbell came to the Children's Hospital of Philadelphia in 2008 to start a center for patients with Thoracic Insufficiency Syndrome.  He developed an intradisciplinary team of orthopaedic surgeons, pulmonologists, general surgeons, neurosurgeons, radiologists, and researchers to help treat patients with severe Early Onset Scoliosis (EOS).  He theorized that EOS, particularly severe EOS, led to a decrease in the body's ability to develop normal lung capacity. By providing strutural support that could both maintan, or even grow, the thoracic cavity and keep progressive scoliosis in check, Dr. Campbell's device has helped thousands of children around the world.  Unfortunately, due to the recurrent nature of the surgery for lengthenings, and the structure of the device in relation to the patients chest wall, patients with VEPTR are at an increased risk of complications including surgical site infections (SSI), skin slough, and hardware failure. In order to track his complication rates, Dr. Campbell started a prospective patient safety registry.  This registry contains at last some data on all of his patient's surgeries and any complications that arose.  

>For many in orthopaedic surgery, predicting which patients are at risk for complication is increasingly important in an era of medicine that involves shared decision making with patients and families.  This project will attempt to determine whether or not a risk factor can be identified for patients with EOS that might predict whether or not a patient is at risk for a complication during the 90 days post-op from a serial expansion. To begin the project, I reviewed some of the current literature and met with Dr. Patrick Cahill at CHOP.  Dr. Cahill took over for Dr. Campbell as the director of the Center for Thoracic Insufficiency Syndrome upon the death of Dr. Campbell in July 2018. Dr. Cahill recommended I focus on complications after expansions since his team had already reviewed and were about to publish on the risk factors for complications after initial implant of the device.  I then met with Dr. Jeffery Pennington, the Chief Informatics officer for the Department of Biomedical and Health Informatics at CHOP.  (My meeting is set for 11/16; I'm also still trying to nail down a date to meet with Dr. Holmes about the data, but I may need to find someone else within CHOP if I am unable to get a time to meet with Dr. Holmes.) 



### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 
```{r eval=TRUE}
#load all libraries needed to complete data cleaning and analysis
library(tidyverse)
library(GGally)
library(ggdendro)
library(randomForest)
library(glmnet)
library(pROC)
library(boot)
library(childsds)
library(lubridate)


``` 

```{r eval=TRUE}

BMI_age <- read_csv("bmiagerev.csv") %>% 
    mutate_all(as.numeric) %>% 
    mutate(Sex = Sex-1) %>% 
    select(demog_gender = Sex, Agemos, P5)

ctis <- read_csv("CTISFinalProjectData2018.csv") %>% 
     mutate(patid = as.integer(patid)
           , surg_proc_1 = as.factor(surg_proc_1)
           , surg_anti_dur = as.factor(surg_anti_dur)
           , surg_proc_1_site = as.factor(surg_proc_1_site)
           , surg_dt_1 = mdy(surg_dt_1)
           , demog_dob = mdy(demog_dob)
           , adm_admit_date_1 = mdy(adm_admit_date_1)
           , adm_dc_date_1 = mdy(adm_dc_date_1)
     ) 
head(ctis)
    
DOB <- ctis %>% distinct(patid, demog_dob, demog_gender) %>% 
    filter(!is.na(demog_dob))
SMA <- ctis %>% distinct(patid, trkr_prim_diag___11) %>% 
    filter(trkr_prim_diag___11 == 1)

   #AgemosDOS = as.numeric(difftime(surg_dt_1, demog_dob, units = "days")/365.25 * 12)
#then need to flip the data so that it's long and then you will have a column for the percentile 
```

```{r eval=TRUE}
#creates a data frame with each patient's ID number and selects the columns that include demographic and diagnosis information on each patient
ctis_demog1 <- ctis %>%
    select(patid, demog_dob, demog_english, res_facility = lg_term_res, skill_nursing = test_skrn, demog_mort_stat,demog_gender, demog_country, demog_state
           , Spine_class = char_spinal_class_def
           , Central_Core_myo = trkr_prim_diag___0 
           , Cong_Hered_MuscDys = trkr_prim_diag___1
           , Cong_Scoli = trkr_prim_diag___2
           , Fused_ribs = trkr_prim_diag___3
           , Hemi_vertebrae = trkr_prim_diag___4
           , Kyphoscoliosis = trkr_prim_diag___5
           , Neuro_kypho_scoli = trkr_prim_diag___6
           , Neuromuscular_scoli = trkr_prim_diag___7
           , Prog_Inf_Idio_scoli = trkr_prim_diag___8
           , Rib_agenesis = trkr_prim_diag___9
           , Kyphosis = trkr_prim_diag___10
           , SMA = trkr_prim_diag___11
           , Syndromic_scoli = trkr_prim_diag___12
           , Hypoplastic_thorax = trkr_prim_diag___13
           , Other = trkr_prim_diag___100
           , cardiac
           , No_MDRO = mdro___0
           , MRSA = mdro___1
           , MSSA = mdro___2
           , VRE = mdro___3
           , Pulm_hypertension = dx_of_pulmonary_hypertensi
           , Poor_soft_tiss_cover = char_prtis
           ) %>%
    distinct() 
#removes the duplicate rows in the data where patient's have no data, but for some reason the rows were still in the data set after the above code.
ctis_demog_clean <- ctis_demog1[!is.na(ctis_demog1$demog_dob), ]


``` 

```{r}
#creates a table of variables for each surgery and changes patid into an integer and allows items that should be factors according to the data dictionary to be treated as factors.
ctis_surgery1 <- ctis %>%
    select(patid
           , demog_gender
           , Admit_date = adm_admit_date_1
           , Discharge_date = adm_dc_date_1
           , LOS = adm_hosp_los
           , Abx_duration = surg_anti_dur
           , Discharge_AVR = adm_avr_dc
           , Surg_date = surg_dt_1
           , Primary_procedure = surg_proc_1
           , Surgery_site = surg_proc_1_site
           , BMI = surg_bmi_1
           , Wound_watch = trk_con_inc_yes
           ,
           ) %>% 
    left_join(DOB) %>% 
    mutate(Agemos = as.integer(difftime(Surg_date, demog_dob, units = "days")/365.25 * 12) + 0.5) %>% 
    left_join(BMI_age) %>% 
    mutate(BMI_diff = BMI - P5) %>% 
    group_by(patid) %>% 
    arrange(Surg_date) %>% 
    mutate(ord = row_number()) %>% 
    ungroup()

#ctis_surgery2 <- ctis_surgery1 %>% 
    #select(patid, demog_gender, Surg_date, BMI_diff) %>% 
    #filter(complete.cases(.)) %>% 
    #group_by(patid, . = if_else()) %>% 
    #arrange(Surg_date) %>% 
    #mutate(ord = row_number()) %>% 
    #filter(ord %in% c(1, max(ord))) %>% 
    #ungroup()
#need min and max record to show the first surgery and the last surgery



ctis_surgery_clean <- ctis_surgery1 %>%
    mutate(Primary_procedure = factor(Primary_procedure, levels = c(0,1,2,3,4,5,6,7,8,10,11,12,13,14,15,16,20,22,26,28,29,30,31,38,39,40,41,98,100), labels =
        c("VEPTR Implant Virgin Chest"                                                                  
            ,"MAGEC VEPTR Implant Virgin Chest"
            ,"New Full VEPTR Implant"
            , "New Full MAGEC VEPTR Implant"
            , "VETPR Expansion"
            , "Clinic MAGEC VEPTR Expansion"
            , "VEPTR Revision/Reinsert/Removal"
            , "MAGEC VEPTR Revision/Removal"
            , "MAGEC VEPTR Expansion Surg"
            , "GR Placement"
            , "MAGEC- GR Placement"
            , "GR Expansion"
            , "Clinic MAGEC GR Expansion"
            , "GR Revision"
            , "MAGEC GR Revision"
            , "I & D"
            , "Aborted procedure"
            , "Delayed primary closure"
            , "Exploration"
            , "General surgical procedure"
            , "MAGEC GR Expansion surgery"
            , "Other Orthopaedic Procedure"
            , "ENT procedure"
            , "Pre-Orthopaedic Procedure"
            , "Full Spine fusion"
            , "Plastic Surgery Closure"
            , "Partial Spine Fusion"
            , "Expansion Thoracoplasty"
            , "Other"))
        , Abx_duration = factor(Abx_duration, levels = c(1,2,3,10), labels = c("24hrs", "Under 10d", "Over 10d", "Other"))
        , Surgery_site = factor(Surgery_site, levels = c(0,2,4,6), labels = c("Bilateral", "Left", "Right", "Center")))

ctis_diff <-
	ctis_surgery_clean %>%
	distinct(patid, demog_gender, Surg_date, Primary_procedure, Agemos, BMI, BMI_diff, P5) %>%
	filter(complete.cases(.)) %>%
	group_by(patid) %>%	
	filter(Surg_date %in% c(min(Surg_date), max(Surg_date))) %>%
	mutate(ord = row_number()) %>%
	ungroup() %>%
	mutate(period = ifelse(ord == 1, "First BMI", "Last BMI"))
	   
ggplot(ctis_diff, aes(BMI_diff, fill = period, colour = period)) +
	geom_density(alpha = 0.2) +
	geom_vline(xintercept = 0)
sapply(ctis_surgery1, class)

```


```{r eval=TRUE}
#implant surgeries only (VEPTR, GR, and MAGEC)
ctis_implant_surgery_bmi <- ctis_diff %>% 
    filter(Primary_procedure == c("VEPTR Implant Virgin Chest","MAGEC VEPTR Implant Virgin Chest","GR Placement"))
              
nrow(ctis_implant_surgery_bmi)
#number with a BMI less than the 5th percentile
implant_low_bmi <- filter(ctis_implant_surgery_bmi, ctis_implant_surgery_bmi$BMI < ctis_implant_surgery_bmi$P5)
nrow(implant_low_bmi)/nrow(ctis_implant_surgery_bmi)

#VEPTR Implant and Expansion
ctis_VEPTR_surgery_bmi <- ctis_diff %>% 
    filter(Primary_procedure == c("VEPTR Implant Virgin Chest","VETPR Expansion"))
nrow(ctis_VEPTR_surgery_bmi)
#VEPTR Expansion Procedures
ctis_VEPTR_EXP_surgery_bmi <- ctis_surgery_clean %>% 
    filter(Primary_procedure == "VETPR Expansion")
nrow(ctis_VEPTR_EXP_surgery_bmi)

#issue is using ctis srugery clean since it doesn't have DOB
VEPTR_EXP_low_bmi <- ctis_VEPTR_EXP_surgery_bmi %>% 
    filter(ctis_VEPTR_EXP_surgery_bmi$BMI < ctis_VEPTR_EXP_surgery_bmi&P5)

nrow(VEPTR_EXP_low_bmi)
nrow(VEPTR_EXP_low_bmi)/nrow(ctis_VEPTR_EXP_surgery_bmi)
#Growing Rod Implant and Expansion
ctis_GR_surgery_bmi <- ctis_surgery_clean %>% 
    filter(Primary_procedure == c("GR Placement","GR Expansion")
               , BMI != 0)

ggplot(data = ctis_VEPTR_surgery_bmi , aes(x=Primary_procedure, y=BMI)) +
    geom_boxplot()+
    expand_limits(y = 0)+
    labs(title = "VEPTR Patient BMI")+
    coord_flip()
#difference between expansion and first implant and then plot that
ggplot(data = ctis_GR_surgery_bmi , aes(x=Primary_procedure, y=BMI)) +
    geom_boxplot()

ggplot(data = ctis_implant_surgery_bmi , aes(x=Primary_procedure, y=BMI)) +
    geom_boxplot()
```
### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
