---
title: "BMIN503/EPID600 Project Template"
author: "Arnab Chowdhury"
output: 
  html_document:
    theme: paper 
    highlight: tango
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, but this is not required.

### Overview

> > This project aims to study the impact of the COVID-19 pandemic on solid organ transplantation in the United States using UNOS OPTN data.

### Introduction

> > The SARS-CoV-2 (COVID-19) pandemic has significantly impacted solid organ transplant programs across the United States. At the height of the pandemic, transplant centers adjusted guidelines for donor selection, management of patients with a positive COVID-19 diagnosis, and prevention of transmission of COVID-19 to transplant recipients and healthcare workers. The COVID-19 pandemic gave rise to a new subset of patients being referred for lung transplantation as well. The aim of this project is to understand the impact of the COVID-19 pandemic on the lung transplantation program using publically available UNOS OPTN data and local COVID-19 incidence rates.
>
> > Lung transplantation involves multiple disciplines that include the coordination of multiple disciplines including transplant pulmonology, cardiothoracic surgery, critical care medicine, nursing, respiratory therapy and organ procurement teams among many others teams that closely coordinate to make transplants a success. Data from the effects of COVID-19 pandemic and understanding its impact will help us better prepare for future pandemics.
>

### Methods

Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

> Data was obtained from the OPTN (Organ Procurement and Transplant Network) after completing a data request. The data obtained involved STAR files that contain de-identified individual transplant records. These include patients who have ever been placed on a transplant waiting list. The original files were stored in a password protected computer. 

> The original files were in SAS format and the thoracic_data file that contained records regarding heart and lung transplant were read using the package "haven". 

```{r eval = TRUE}
# Reading SAS files provided by UNOS OPTN. Reading thoracic data. 
library(haven)
thoracic_data <- read_sas("/Users/work/Downloads/SAS Dataset 202209/Thoracic/thoracic_data.sas7bdat")
```

> Subsequently, patients waitlisted for lung transplantation were filtered and the data was furthermore filtered by year. The relevant characteristics of this population was then selected. 

```{r eval = TRUE}
# Cleaning data to filter transplanted patients and lung transplants and filter by year
library(gtsummary)
library(tidyverse)
library(dplyr)
library(ggplot2)

head(thoracic_data)
dim(thoracic_data)

thoracic_data_subset_all <- thoracic_data %>% 
  dplyr::select(WL_ID_CODE, TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, GENDER, PERM_STATE, TXLNG, TX_YEAR, DIAG, INIT_AGE, TCR_DGN, ETHCAT) %>% dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), GENDER = factor(GENDER), PERM_STATE = factor(PERM_STATE))
thoracic_data_subset_all

thoracic_data_subset_all %>%
  filter(WL_ORG == "LU" & TXED == "yes")

# Filter patients from 2015 to 2021 who were "activated" for lung transplant
thoracic_data_subset_lung_activation <- thoracic_data %>% 
  dplyr::select(WL_ID_CODE, TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, GENDER, PERM_STATE, TXLNG, TX_YEAR, INIT_AGE, TCR_DGN, ETHCAT) %>%
  dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), GENDER = factor(GENDER), PERM_STATE = factor(PERM_STATE), TCR_DGN = (factor(TCR_DGN)), ETHCAT = (factor(ETHCAT, levels = c(1, 2, 4, 5, 6, 7, 9, 998), labels =c("White", "Black", "Hispanic", "Asian", "American Indian", "Native Hawaiian", "Multiracial", "Unknown")))) %>%
  dplyr::filter(ACTIVATE_DATE >= "2015-01-01" & ACTIVATE_DATE < "2022-01-01") %>%
  dplyr::filter(WL_ORG == "LU")

library(table1)
label(thoracic_data_subset_lung_activation$TXED) <- "Received Lung Transplant"
label(thoracic_data_subset_lung_activation$DAYSWAIT_CHRON) <- "Days on the wait list"
label(thoracic_data_subset_lung_activation$GENDER) <- "Gender"
label(thoracic_data_subset_lung_activation$ETHCAT) <- "Race"
label(thoracic_data_subset_lung_activation$INIT_AGE) <- "Recipient Age"
label(thoracic_data_subset_lung_activation$PERM_STATE) <- "Recipient State of Residence"

table1(~ DAYSWAIT_CHRON + GENDER + INIT_AGE + ETHCAT + PERM_STATE| TXED, data=thoracic_data_subset_lung_activation)
```

> Group by states, make tables of proportion of patients transplanted vs not transplanted. 


```{R eval = TRUE}

lungtxstate <- thoracic_data %>% 
  dplyr::select(TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, PERM_STATE, TX_YEAR, INIT_AGE) %>%
  dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), PERM_STATE = factor(PERM_STATE)) %>%
  dplyr::filter(ACTIVATE_DATE >= "2015-01-01" & ACTIVATE_DATE < "2022-01-01") %>%
  dplyr::filter(WL_ORG == "LU") %>% group_by(PERM_STATE, TXED) %>% tally()

lungtxstate.yes <- lungtxstate %>% filter(TXED == "yes") %>% mutate(nyes = n) %>% select(PERM_STATE, nyes)
lungtxstate.no <- lungtxstate %>% filter(TXED == "no") %>% mutate(nno = n) %>% select(PERM_STATE, nno)

lungtxstate_join <- left_join(lungtxstate.yes, lungtxstate.no) %>% select(PERM_STATE, nyes, nno) %>% mutate(proptxed = (nyes/(nno + nyes))*100) %>% mutate(state = PERM_STATE)

library(usmap)
library(ggplot2)

plot_usmap(
  data = lungtxstate_join, values = "proptxed", lines = "red"
) + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Proportion Transplanted (%)", label = scales::comma
  ) + 
  labs(title = "US States, Proportion of patients transplanted") +
  theme(legend.position = "right")

```

> The above table describes the baseline characteristics of the patients who were placed on a waitlist. Now, we focus our attention to the patients who ended up receiving a lung transplant. A new subset of patients will be created below to select this population of patients who received a lung transplant between 01/01/2015 to 12/31/2021. 

```{R eval = TRUE}
# Filter patients from 2015 to 2021 who received a lung transplant
thoracic_data_subset_lung <- thoracic_data %>% 
  dplyr::select(WL_ID_CODE, TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, GENDER, PERM_STATE, TXLNG, TX_YEAR, DIAG, INIT_AGE, ETHCAT, TCR_DGN) %>% dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), GENDER = factor(GENDER), PERM_STATE = factor(PERM_STATE), TCR_DGN = (factor(TCR_DGN)), ETHCAT = (factor(ETHCAT, levels = c(1, 2, 4, 5, 6, 7, 9, 998), labels =c("White", "Black", "Hispanic", "Asian", "American Indian", "Native Hawaiian", "Multiracial", "Unknown")))) %>% dplyr::filter(TX_DATE >= "2015-01-01" & TX_DATE < "2022-01-01") %>% dplyr::filter(WL_ORG == "LU")
head(thoracic_data_subset_lung)

```

> The following table will characterize the baseline demographics of patients who received a lung transplantation. 

```{R eval = TRUE}
library(table1)
label(thoracic_data_subset_lung$TXED) <- "Received Lung Transplant"
label(thoracic_data_subset_lung$DAYSWAIT_CHRON) <- "Days on the wait list"
label(thoracic_data_subset_lung$GENDER) <- "Gender"
label(thoracic_data_subset_lung$ETHCAT) <- "Race"
label(thoracic_data_subset_lung$INIT_AGE) <- "Recipient Age"
label(thoracic_data_subset_lung$PERM_STATE) <- "Recipient State of Residence"

table1(~ DAYSWAIT_CHRON + GENDER + INIT_AGE + ETHCAT + PERM_STATE, data=thoracic_data_subset_lung)
```

> Now it was important to select an appropriate interval to further analyze the data. One thing to note is that there is inherent baseline variability in the data. We will visualize the total number of lung transplants and plots the number of lung transplants that occured daily, weekly and monthly. We cast a wide net and started the visualization from 2015 to see the trend but will narrow the data further in subsequent codes.  


```{R eval = TRUE}

# Daily lung transplants
lungtx2015_2021 <- thoracic_data_subset_lung %>%
  dplyr::filter(TX_DATE >= "2015-01-01" & TX_DATE <= "2021-12-31") %>% count(TX_DATE) %>% rename("Number.Transplants" = n) 
daily <- ggplot(lungtx2015_2021, aes(x = TX_DATE, y = Number.Transplants)) +
  geom_point(size=0.5) + labs(x = "Date") +
  labs(y = "Number of Lung Transplants") + 
  labs(title = "Daily Lung Transplants Performed (2015-2021)")

# Weekly
weekly <- ggplot(thoracic_data_subset_lung, aes(TX_DATE, fill = TXED)) + 
  geom_histogram(binwidth = 7) + 
  labs(title = "Weekly Lung Transplants Performed (2015-2021)") +
  labs(x = "Year") +
  labs(y = "Number of Lung Transplants")

# Monthly
monthly <- ggplot(thoracic_data_subset_lung, aes(TX_DATE, fill = TXED)) + 
  geom_histogram(binwidth = 30) + 
  labs(title = "Monthly Lung Transplants Performed (2015-2021)") +
  labs(x = "Year") +
  labs(y = "Number of Lung Transplants")

library(cowplot) 
plot_grid(daily, weekly, monthly)

```

> In the graphs above we see that the inherent variability is very pronounced when plotting daily data, decreases slightly with weekly data and is the least with monthly data. Hence, we will utilize monthly data for further analysis of the data. Visualizing roughly, there was a steady increase in lung transplants starting in 2016 until 2020 and then transplant may have taken a dip in March 2020, further dips are seen late 2020/early 2021 and possible another in the last quarter of 2021. 




```{R eval = TRUE}
# Total number of transplants from 2018 to 2021
lungtx2018_2021 <- thoracic_data_subset_lung %>%
  dplyr::filter(TX_DATE >= "2018-01-01" & TX_DATE <= "2021-12-31") %>% count(TX_DATE) %>% rename("Number.Transplants" = n) 
```

```{R eval = TRUE}
library(dplyr)
library(lubridate)

# Using monthly data rather than daily data
lungtx2018_2021.ym <- lungtx2018_2021 %>% mutate(
    TX_DATE = ymd(TX_DATE),
    TX_YEAR_MONTH = format_ISO8601(TX_DATE, precision = "ym")
  )
lungtx2018_2021.ym <- lungtx2018_2021.ym %>% group_by(TX_YEAR_MONTH) %>% 
  summarise(total_transplants=sum(Number.Transplants)) 

lungtx2018_2021.ym$TX_YEAR_MONTH <- as.Date(paste(lungtx2018_2021.ym$TX_YEAR_MONTH, "-01", sep=""))

# Rough plot of lung transplants from 2018-2021. Monthly transplants
library(ggplot2)
ggplot(data = lungtx2018_2021.ym, aes(x = TX_YEAR_MONTH, y = total_transplants)) +
  geom_point() +
  geom_line() +
  geom_smooth() +
  labs(title = "Monthly transplants",
       subtitle = "2018-2021",
       x = "Date", y = "Monthly Transplants")
```

+ Using causal impact package to see if there was a cumulative decrease in transplants after start of the pandemic. 
```{r eval = TRUE}
lungtx <- thoracic_data_subset_lung %>%
  filter(TXED == 'yes') %>%
  group_by(TX_DATE) %>%
  count(TX_DATE)
lungtx

library(CausalImpact)

lungtx <- lungtx

time.points <- seq.Date(as.Date("2015-01-05"), by=1, length.out=2803)
number <- ts(lungtx$n)
data <- zoo(number, time.points)
pre.period=as.Date(c("2016-01-05", "2020-02-29"))
post.period=as.Date(c("2020-03-01", "2020-12-31"))
impact <- CausalImpact(data, pre.period, post.period)
impact
plot(impact)
```

```{R eval = TRUE}
summary(impact, "report")
```
> Appears to have a cumulative decrease in transplant since the pandemic began. 


+ Regression analysis to see if decrease in transplants corelated to number of COVID-19 cases. 

```{R EVAL + TRUE}
#   Obtain monthly COVID-19 new cases in US
owid_url <- "https://github.com/owid/covid-19-data/blob/master/public/data/owid-covid-data.csv?raw=true"
country <- "United States"
covid <- read_csv(owid_url)
covid_cases <- covid %>% 
  filter(location == country) %>% 
  select(date, total_cases, new_cases, hosp_patients, icu_patients) %>% 
  arrange(date) %>% mutate(total_cases = as.integer(total_cases), new_cases = as.integer(new_cases), hosp_patients = as.integer(hosp_patients), icu_patients = as.integer(icu_patients))

library(ggplot2)
covid.cases <- ggplot(data=covid_cases, aes(x=date, y=new_cases)) + 
  geom_point(size=0.005) + geom_line()
  
covid.hosp <- ggplot(data=covid_cases, aes(x=date, y=hosp_patients)) + 
  geom_point(size=0.005) + geom_line()

covid.icu <- ggplot(data=covid_cases, aes(x=date, y=icu_patients)) + 
  geom_point(size=0.005) + geom_line()

library(cowplot)
plot_grid(covid.cases, covid.hosp, covid.icu)

covid_cases.ym <- covid_cases %>% mutate(
    date = ymd(date),
    TX_YEAR_MONTH = format_ISO8601(date, precision = "ym")
  )
covid_cases.ym <- covid_cases.ym %>% group_by(TX_YEAR_MONTH) %>% 
  summarise(total_cases2=sum(total_cases), total_new_cases=sum(new_cases), total_hosp=sum(hosp_patients), total_icu=sum(icu_patients)) 

covid_cases.ym$TX_YEAR_MONTH <- as.Date(paste(covid_cases.ym$TX_YEAR_MONTH, "-01", sep=""))

lungtx_covid_join <- left_join(lungtx2018_2021.ym, covid_cases.ym) %>% filter (TX_YEAR_MONTH >= "2020-02-01")

```

```{r eval = TRUE}
#Daily Data
# ggplot(lungtx_covid_join_daily, aes(x = new_cases, y = Number.Transplants)) +
# geom_point(color = "darkseagreen3") +
# geom_smooth(method="lm")
```

```{r eval = TRUE}
#Monthly Data

transplant.totalcases <- ggplot(lungtx_covid_join, aes(x = total_cases2, y = total_transplants, )) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
transplant.newcases <- ggplot(lungtx_covid_join, aes(x = total_new_cases, y = total_transplants,)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
transplant.totalhosp <- ggplot(lungtx_covid_join, aes(x = total_hosp, y = total_transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
transplant.icu <- ggplot(lungtx_covid_join, aes(x = total_icu, y = total_transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")

plot_grid(transplant.totalcases, transplant.newcases, transplant.totalhosp, transplant.icu)

```

```{r eval = TRUE}

```


```{r eval = TRUE}

```


```{r eval = TRUE}

```


```{r eval = TRUE}

```


```{r eval = TRUE}
# lungtx_covid_join_daily_complete <- tidyr::drop_na(lungtx_covid_join_daily)
# head(lungtx_covid_join_daily_complete)
# plot(lungtx_covid_join_daily_complete$Number.Transplants, # lungtx_covid_join_daily_complete$total_cases)
```

```{r eval = TRUE}
# lungtx_covid_daily_lm <- lm(Number.Transplants ~ total_cases + new_cases + # hosp_patients + icu_patients, data = lungtx_covid_join_daily_complete)
# summary(lungtx_covid_daily_lm)
```


```{r eval = TRUE}
lungtx_covid_join_complete <- tidyr::drop_na(lungtx_covid_join)
head(lungtx_covid_join_complete)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_cases2, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_new_cases, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_hosp, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_icu, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)


```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_new_cases + total_hosp + total_icu, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

> Appears to have a significant corelation. 



### Results

Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
