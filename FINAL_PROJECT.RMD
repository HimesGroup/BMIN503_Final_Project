---
title: "BMIN503/EPID600 Project Template"
author: "Your Name"
output: 
  html_document:
    theme: paper 
    highlight: tango
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, but this is not required.

### Overview

> > This project aims to study the impact of the COVID-19 pandemic on solid organ transplantation in the United States using UNOS OPTN data.

### Introduction

> > The SARS-CoV-2 (COVID-19) pandemic has significantly impacted solid organ transplant programs across the United States. At the height of the pandemic, transplant centers adjusted guidelines for donor selection, management of patients with a positive COVID-19 diagnosis, and prevention of transmission of COVID-19 to transplant recipients and healthcare workers. The COVID-19 pandemic gave rise to a new subset of patients being referred for lung transplantation as well. The aim of this project is to understand the impact of the COVID-19 pandemic on the lung transplantation program using publically available UNOS OPTN data and local COVID-19 incidence rates.
>
> > Lung transplantation involves multiple disciplines that include the coordination of multiple disciplines including transplant pulmonology, cardiothoracic surgery, critical care medicine, nursing, respiratory therapy and organ procurement teams among many others teams that closely coordinate to make transplants a success. Data from the effects of COVID-19 pandemic and understanding its impact will help us better prepare for future pandemics.
>

### Methods

Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

UNOS OPTN database

De-identified data request was submitted to UNOS.

Data was received in the SAS format

Project Question: Impact of COVID-19 on Organ Transplant Organs:

> Decrease in transplantation during COVID-19?

> Corelated with COVID-19 cases in United States?

> Increase in waitlist mortalist? (Is there a way to find this out?)

## Thoracic Data


```{r eval = TRUE}
# Reading SAS files provided by UNOS OPTN. Reading thoracic data. 
library(haven)
thoracic_data <- read_sas("/Users/work/Downloads/SAS Dataset 202209/Thoracic/thoracic_data.sas7bdat")
```

```{r eval = TRUE}

# Cleaning data to filter transplanted patients and lung transplants and filter by year
library(gtsummary)
library(tidyverse)
library(dplyr)
library(ggplot2)

head(thoracic_data)
dim(thoracic_data)

thoracic_data_subset_all <- thoracic_data %>% 
  dplyr::select(WL_ID_CODE, TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, GENDER, PERM_STATE, TXLNG, TX_YEAR, DIAG, INIT_AGE, TCR_DGN, ) %>% dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), GENDER = factor(GENDER), PERM_STATE = factor(PERM_STATE))
thoracic_data_subset_all

thoracic_data_subset_all %>%
  filter(WL_ORG == "LU" & TXED == "yes")

# Filter patients from 2015 to 2021 who were "activated" for lung transplant
thoracic_data_subset_lung_activation <- thoracic_data %>% 
  dplyr::select(WL_ID_CODE, TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, GENDER, PERM_STATE, TXLNG, TX_YEAR, DIAG, TCR_DGN) %>% dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), GENDER = factor(GENDER), PERM_STATE = factor(PERM_STATE)) %>% dplyr::filter(ACTIVATE_DATE >= "2015-01-01" & ACTIVATE_DATE < "2022-01-01") %>% dplyr::filter(WL_ORG == "LU")
head(thoracic_data_subset_lung_activation)
```

```{R eval = TRUE}
# Table 1 of patients who were transplanted and their characteristics
thoracic_data_subset_lung_activation %>% dplyr::select(TXED, DAYSWAIT_CHRON, GENDER, ACTIVATE_DATE, TX_DATE, PERM_STATE) %>%
  tbl_summary(by = TXED) %>% add_p() %>% add_overall()
```

```{R eval = TRUE}
# Filter patients from 2015 to 2021 who received a lung transplant
thoracic_data_subset_lung <- thoracic_data %>% 
  dplyr::select(WL_ID_CODE, TXED, WL_ORG, DAYSWAIT_CHRON, ACTIVATE_DATE, TX_DATE, GENDER, PERM_STATE, TXLNG, TX_YEAR, DIAG, TCR_DGN) %>% dplyr::mutate(TXED = (factor(TXED, levels = c(0, 1), labels = c("no", "yes"))), GENDER = factor(GENDER), PERM_STATE = factor(PERM_STATE)) %>% dplyr::filter(TX_DATE >= "2015-01-01" & TX_DATE < "2022-01-01") %>% dplyr::filter(WL_ORG == "LU")
thoracic_data_subset_lung
```

```{R eval = TRUE}
# Rough visualization of weekly transplant activation data
ggplot(thoracic_data_subset_lung, aes(TX_DATE, fill = TXED)) + 
      geom_histogram(binwidth = 30)
```

```{R eval = TRUE}
# Table 2: Characteristics of patients who received a lung transplant
thoracic_data_subset_lung %>% dplyr::select(TXED, DAYSWAIT_CHRON, GENDER, ACTIVATE_DATE, TX_DATE, PERM_STATE) %>%
  tbl_summary()
```

```{R eval = TRUE}
# Create a subset of lung transplants from 2018-2021
lungtx2018_2021 <- thoracic_data_subset_lung %>%
  dplyr::filter(TX_DATE >= "2018-01-01" & TX_DATE <= "2021-12-31") %>% count(TX_DATE) %>% rename("Number.Transplants" = n) 
head(lungtx2018_2021)
```

```{R eval = TRUE}
# Rough plot of daily lung transplants from 2018 to 2022
plot(lungtx2018_2021)
```

```{R eval = TRUE}
# Total number of transplants from 2018 to 2021
lungtx2018_2021.total <- summarise(lungtx2018_2021, "2018 - 2021" = sum(Number.Transplants))
head(lungtx2018_2021.total)
```

```{R Eval = TRUE}


```


```{R eval = TRUE}
library(dplyr)
library(lubridate)

# Using monthly data rather than daily data
lungtx2018_2021.ym <- lungtx2018_2021 %>% mutate(
    TX_DATE = ymd(TX_DATE),
    TX_YEAR_MONTH = format_ISO8601(TX_DATE, precision = "ym")
  )
lungtx2018_2021.ym <- lungtx2018_2021.ym %>% group_by(TX_YEAR_MONTH) %>% 
  summarise(total_transplants=sum(Number.Transplants)) 

lungtx2018_2021.ym$TX_YEAR_MONTH <- as.Date(paste(lungtx2018_2021.ym$TX_YEAR_MONTH, "-01", sep=""))

# Rough plot of lung transplants from 2018-2021. Monthly transplants
library(ggplot2)
ggplot(data = lungtx2018_2021.ym, aes(x = TX_YEAR_MONTH, y = total_transplants)) +
  geom_point() +
  geom_line() +
  geom_smooth() +
  labs(title = "Monthly transplants",
       subtitle = "2018-2021",
       x = "Date", y = "Monthly Transplants")
```

> Visualizing roughly, there was a steady increase in lung transplants until 2020 and then transplant may have taken a dip.

+ Using causal impact package to see if there was a cumulative decrease in transplants after start of the pandemic. 
```{r eval = TRUE}
lungtx <- thoracic_data_subset_lung %>%
  filter(TXED == 'yes') %>%
  group_by(TX_DATE) %>%
  count(TX_DATE)
lungtx

library(CausalImpact)

lungtx <- lungtx

time.points <- seq.Date(as.Date("2015-01-05"), by=1, length.out=2803)
number <- ts(lungtx$n)
data <- zoo(number, time.points)
pre.period=as.Date(c("2016-01-05", "2020-02-29"))
post.period=as.Date(c("2020-03-01", "2021-12-31"))
impact <- CausalImpact(data, pre.period, post.period)
impact
plot(impact)
```
> Appears to have a cumulative decrease in transplant since the pandemic began. 


+ Regression analysis to see if decrease in transplants corelated to number of COVID-19 cases. 

```{R EVAL + TRUE}
#   Obtain monthly COVID-19 new cases in US
owid_url <- "https://github.com/owid/covid-19-data/blob/master/public/data/owid-covid-data.csv?raw=true"
country <- "United States"
covid <- read_csv(owid_url)
covid_cases <- covid %>% 
  filter(location == country) %>% 
  select(date, total_cases, new_cases, hosp_patients, icu_patients) %>% 
  arrange(date)

library(ggplot2)
ggplot(data=covid_cases, aes(x=date, y=new_cases)) + 
  geom_point()
  
ggplot(data=covid_cases, aes(x=date, y=hosp_patients)) + 
  geom_point()

ggplot(data=covid_cases, aes(x=date, y=icu_patients)) + 
  geom_point()

covid_cases.ym <- covid_cases %>% mutate(
    date = ymd(date),
    TX_YEAR_MONTH = format_ISO8601(date, precision = "ym")
  )
covid_cases.ym <- covid_cases.ym %>% group_by(TX_YEAR_MONTH) %>% 
  summarise(total_cases2=sum(total_cases), total_new_cases=sum(new_cases), total_hosp=sum(hosp_patients), total_icu=sum(icu_patients)) 

covid_cases.ym$TX_YEAR_MONTH <- as.Date(paste(covid_cases.ym$TX_YEAR_MONTH, "-01", sep=""))

lungtx_covid_join <- left_join(lungtx2018_2021.ym, covid_cases.ym) %>% filter (TX_YEAR_MONTH >= "2020-02-01")

#daily data
lungtx_covid_join_daily <- left_join(lungtx2018_2021, covid_cases, by = c("TX_DATE" = "date")) %>% filter (TX_DATE >= "2020-02-01")
```

```{r eval = TRUE}
#Daily Data
ggplot(lungtx_covid_join_daily, aes(x = new_cases, y = Number.Transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
```

```{r eval = TRUE}
#Monthly Data
ggplot(lungtx_covid_join, aes(x = total_new_cases, y = total_transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
```
```{r eval = TRUE}
ggplot(lungtx_covid_join_daily, aes(x = hosp_patients, y = Number.Transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
```

```{r eval = TRUE}
ggplot(lungtx_covid_join, aes(x = total_hosp, y = total_transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
```
```{r eval = TRUE}
ggplot(lungtx_covid_join_daily, aes(x = icu_patients, y = Number.Transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
```

```{r eval = TRUE}
ggplot(lungtx_covid_join, aes(x = total_icu, y = total_transplants)) +
  geom_point(color = "darkseagreen3") +
  geom_smooth(method="lm")
```


```{r eval = TRUE}

```


```{r eval = TRUE}

```


```{r eval = TRUE}

```


```{r eval = TRUE}
lungtx_covid_join_daily_complete <- tidyr::drop_na(lungtx_covid_join_daily)
head(lungtx_covid_join_daily_complete)
plot(lungtx_covid_join_daily_complete$Number.Transplants, lungtx_covid_join_daily_complete$total_cases)
```

```{r eval = TRUE}
lungtx_covid_daily_lm <- lm(Number.Transplants ~ total_cases + new_cases + hosp_patients + icu_patients, data = lungtx_covid_join_daily_complete)
summary(lungtx_covid_daily_lm)
```


```{r eval = TRUE}
lungtx_covid_join_complete <- tidyr::drop_na(lungtx_covid_join)
head(lungtx_covid_join_complete)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_cases2, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_new_cases, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_hosp, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_icu, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

```{r eval = TRUE}
lungtx_covid_lm <- lm(total_transplants ~ total_hosp + total_icu, data = lungtx_covid_join_complete)
summary(lungtx_covid_lm)
```

> Appears to have a significant corelation. 



### Results

Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
