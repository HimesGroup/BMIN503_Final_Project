---
title: "State-Level Dynamics and Predictors of Opioid Overdose in the United States (2015-2021)"
author: "Chris Miller"
output:
  html_document:
    theme: paper 
    highlight: tango
    fig_height: 12
    fig_width: 12
---

***

### Overview
The association between region-specific prescription opioid prescribing and the rate of opioid overdose death was well documented during the time periods when prescription opioids were the primary cause of overdose deaths. However, the role of regional prescribing practices on overdose deaths has been less studied since illicit opioids became the primary causes of opioid-related deaths. The goal of this project is to characterize the dynamics of opioid overdose deaths in the United States from 2015 to 2021 and to evaluate state-level predictors of opioid overdose including prescription opioid prescribing and social determinants of health (e.g., depression, obesity, lack of health insurance, smoking, binge drinking, self-reported poor mental health).

### Introduction 
The opioid overdose epidemic in the United States has transitioned over the past two decades from being primarily driven by misuse and abuse of prescription opioid analgesics in the early 2000s to one driven by heroin in the mid 2010s and by illicit fentanyl and fentanyl analogs after 2016. In recognition of the crisis, federal agencies and professional associations modified recommendations and practice guidelines to minimize the use of prescription opioids for acute and chronic pain. Since 2010, the morphine milligram equivalents (MMEs) of opioids dispensed per person has declined nationally by more than 40%. However, there remains substantial regional variation across the country in opioid prescribing and the rate of overdose deaths attributable to commonly prescribed opioids has not declined since its peak in 2010. 

Previous studies have demonstrated that the regional rate of opioid prescribing per capita was highly associated with the regional rate of opioid overdose deaths when prescription opioids were the primary cause of overdose deaths. But with the dramatic increase in heroin- and fentanyl-related overdose deaths, the relationship between regional patterns in prescription opioid prescribing and all-cause opioid overdose death (i.e, due to prescription or illicit opioids) have not continued to be well characterized. This is despite the fact that one of the primary pathways to illicit opioid use continues to be misuse of prescription opioids. While there are many paths to the development of an opioid use disorder, many individuals initiate the misuse or abuse of opioids due to psychological factors (e.g., depression, anxiety, social isolation) and commonly misuse or abuse other substances (e.g., alcohol, marijuana). The Centers for Disease Control and Prevention (CDC) maintains publicly available databases that report cause-specific opioid overdose death rates by state (Vital Statistics Rapid Release [VSRR]), county-level opioid dispensing rates (IQVIA Xponent), county-level drug overdose mortality rates (National Center for Health Statistics [NCHS]), and county-specific data on several social determinants of health (PLACES). This collection of data sources facilitates an updated evaluation of the relationships between opioid overdose deaths, prescription opioid prescribing, and community-level health issues.

### Methods
Changes in opioid overdose rates by drug (i.e., prescription opioid, heroin, synthetic opioid) from 2015 to 2020 were characterized using [VSRR data](https://data.cdc.gov/NCHS/VSRR-Provisional-Drug-Overdose-Death-Counts/xkb8-kh2a/) on drug overdose deaths. I generated line plots of the number of individuals who died of an overdose by drug type. The state-level increases in overdose rates from 2015 to 2020 by drug were also characterized.

To evaluate changes in the dynamics of recent opioid prescribing, I imported the county-level opioid dispensing tables reported on the [CDC website](https://www.cdc.gov/drugoverdose/rxrate-maps/index.html) into Excel files by year. I merged these files with county-level geometry data by FIPS code to create static chloropleth maps by year. 

County-level data on opioid-specific overdose mortality are not publicly available. However, the preponderance of drug overdose deaths in the US are attributable to prescription or illicit opioids. For example, in 2020 there were 95,452 drug overdose deaths of which 71,487 (74.9%) were due to opioids. Therefore, I used county-level drug overdose deaths to evaluate the relationship between drug overdose mortality rates, prescription opioid prescribing, and social determinants of health in 2020. I evaluated the relationships between these variables in bivariate linear regression models and built a multivariable model to evaluate the relative contribution of various factors in county-level drug overdose mortality rates. The specific county-level health indicators I evaluated included the following variables in adults: binge drinking prevalence, depression prevalence, current smoking status, lack of health insurance, obesity prevalence, self-reported lack of leisure time, and self-reported poor recent physical health.

```{r eval = TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:\\Users\\cjm2718\\Dropbox\\Penn\\BMIN 5030\\Final Project Data\\")
library(tidyverse)
library(ggplot2)
library(GGally)
library(sf)
library(tidycensus)
library(leaflet)
library(RColorBrewer)
library(readxl)
library(gridExtra)
library(grid)
library(clinUtils)

# import county-level prescription opioid dispensing rates by year
county.disp.2015 <- read_excel("county_dispensing_rates_2015.xlsx")
county.disp.2016 <- read_excel("county_dispensing_rates_2016.xlsx")
county.disp.2017 <- read_excel("county_dispensing_rates_2017.xlsx")
county.disp.2018 <- read_excel("county_dispensing_rates_2018.xlsx")
county.disp.2019 <- read_excel("county_dispensing_rates_2019.xlsx")
county.disp.2020 <- read_excel("county_dispensing_rates_2020.xlsx")


# merge all county-level prescription opioid dispensing datasets
county.disp <- full_join(county.disp.2015, county.disp.2016, by = "FIPS.code") %>% 
  full_join(., county.disp.2017, by = "FIPS.code") %>% 
  full_join(., county.disp.2018, by = "FIPS.code") %>% 
  full_join(., county.disp.2019, by = "FIPS.code") %>% 
  full_join(., county.disp.2020, by = "FIPS.code") %>% 
  mutate(disp.rate.2015 = as.numeric(gsub("-", "", disp.rate.2015))) %>% 
  mutate(disp.rate.2016 = as.numeric(gsub("-", "", disp.rate.2016))) %>% 
  rename("county" = "county.y.y.y") %>% 
  rename("state" = "state.y.y.y") %>% 
  select(c("state", "county", "FIPS.code", "disp.rate.2015", "disp.rate.2016", "disp.rate.2017", "disp.rate.2018",
           "disp.rate.2019", "disp.rate.2020")) %>% 
  drop_na("county")

# import county-level geometry data
counties <- readRDS(gzcon(url(
  "https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds")))

# create FIPS.code for merge with county-level opioid dispensing data
counties <- counties %>% 
  mutate(FIPS.code = as.numeric(paste0(STATE, COUNTY)))
county.disp.map <- merge(county.disp, counties, by.x = "FIPS.code", by.y = "FIPS.code") %>% 
  mutate(disp.rate.2015.gt100 = ifelse(disp.rate.2015 > 100, 1, 0)) %>% 
  mutate(disp.rate.2020.gt100 = ifelse(disp.rate.2020 > 100, 1, 0))

# import VSRR on state-level opioid overdose death data by drug type
vsrr <- read.csv("VSRR_Provisional_Drug_Overdose_Death_Counts.csv")

# import NCHS data on county-level data on drug overdose death rates overall
nchs <- read.csv("NCHS_-_Drug_Poisoning_Mortality_by_County__United_States.csv")

# import PLACES data on county-level health indicators
places <- read.csv("PLACES__Local_Data_for_Better_Health__County_Data_2022_release.csv")
```

### Results
The static chloropleth maps illustrate how the rates of opioid prescribing fell precipitously between 2015 and 2020. In 2015, opioid prescribing rates exceeded 100 prescriptions per 100 people 29.1% of counties reporting data. The counties with the highest rate of opioid prescribing were in Virginia, Kentucky, and Alabama. By 2020, the proportion of counties where opioid prescribing rates exceeded 100 prescriptions per 100 people fell nearly 10-fold to 3.7%. Virginia and Kentucky still represented the counties with the highest rates of opioid prescribing.


```{r eval = TRUE, message = FALSE, warning = FALSE}
#  color palette and theme elements
myPalette <- colorRampPalette(brewer.pal(6, "Reds"))
my_theme <- function() {
  theme_minimal() +                                  
  theme(axis.line = element_blank(),                 
        axis.text = element_blank(),                 
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  
        legend.key.size = unit(0.4, "cm"),           
        legend.text = element_text(size = 12),       
        legend.title = element_text(size = 12))      
}

# static chloropleth map of opioid prescribing rates (2015)
disp.2015 <- ggplot() +
  geom_sf(data = county.disp.map, aes(geometry = geometry, fill = disp.rate.2015), lty=0) +
  my_theme() +                                          
  ggtitle("2015") + 
  scale_fill_gradientn(name = "Prescriptions Rx \nper 100 people",      
                    colours = myPalette(100), limits=c(0, 150)) + 
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))

# static chloropleth map of opioid prescribing rates (2016)
disp.2016 <- ggplot() +
  geom_sf(data = county.disp.map, aes(geometry = geometry, fill = disp.rate.2016), lty=0) +
  my_theme() +                                          
  ggtitle("2016") + 
  scale_fill_gradientn(name = "Prescriptions \nper 100 people",      
                    colours = myPalette(100), limits=c(0, 150)) + 
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))

# static chloropleth map of opioid prescribing rates (2017)
disp.2017 <- ggplot() +
  geom_sf(data = county.disp.map, aes(geometry = geometry, fill = disp.rate.2017), lty=0) +
  my_theme() +                                          
  ggtitle("2017") + 
  scale_fill_gradientn(name = "Prescriptions \nper 100 people",      
                    colours = myPalette(100), limits=c(0, 150)) + 
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))

# static chloropleth map of opioid prescribing rates (2018)
disp.2018 <- ggplot() +
  geom_sf(data = county.disp.map, aes(geometry = geometry, fill = disp.rate.2018), lty=0) +
  my_theme() +                                          
  ggtitle("2018") + 
  scale_fill_gradientn(name = "Prescriptions \nper 100 people",      
                    colours = myPalette(100), limits=c(0, 150)) + 
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))

# static chloropleth map of opioid prescribing rates (2019)
disp.2019 <- ggplot() +
  geom_sf(data = county.disp.map, aes(geometry = geometry, fill = disp.rate.2019), lty=0) +
  my_theme() +                                          
  ggtitle("2019") + 
  scale_fill_gradientn(name = "Prescriptions \nper 100 people",      
                    colours = myPalette(100), limits=c(0, 150)) + 
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))

# static chloropleth map of opioid prescribing rates (2020)
disp.2020 <- ggplot() +
  geom_sf(data = county.disp.map, aes(geometry = geometry, fill = disp.rate.2020), lty=0) +
  my_theme() +                                          
  ggtitle("2020") + 
  scale_fill_gradientn(name = "Prescriptions \nper 100 people",      
                    colours = myPalette(100), limits=c(0, 150)) + 
  theme(legend.title = element_text(size = 7), 
               legend.text = element_text(size = 7))

grid.arrange(disp.2015, disp.2016, disp.2017, disp.2018, disp.2019, disp.2020, 
             top = textGrob("Opioid Dispensing Rates per 100 People",
             gp = gpar(fontsize=18, font=2)))

county.disp.map %>% 
  summarize(Counties2015_GT_100 = sum(disp.rate.2015.gt100, na.rm = TRUE),
            Per_Counties2015_GT_100 = mean(disp.rate.2015.gt100, na.rm = TRUE))

county.disp.map %>% 
  select(county, state, disp.rate.2015) %>% 
  arrange(-disp.rate.2015) %>% 
  slice(1:20)

county.disp.map %>% 
  summarize(Counties2020_GT_100 = sum(disp.rate.2020.gt100, na.rm = TRUE),
            Per_Counties2020_GT_100 = mean(disp.rate.2020.gt100, na.rm = TRUE))

county.disp.map %>% 
  select(county, state, disp.rate.2020) %>% 
  arrange(-disp.rate.2020) %>% 
  slice(1:20)
```

