---
title: "BMIN503/EPID600 Final Project"
author: "Sarah Cohen"
output: 
html_document:
theme: paper 
highlight: tango
---
  ```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
  Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.

### Overview
My final project will be using the CHDB Southeastern Pennsylvania Household Health Survey to investigate the relationship between mental health outcomes and social predictors in adults living in the greater Philadelphia area. Another layer of this project will examine whether the strength of these relationships differs between geographical areas such as county.

>Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.


### Introduction 
The problem I am focusing on is how the quality and perception of belonging in oneâ€™s neighborhood can be reflected in the occurrence of a mental disorder diagnosis and whether mental health treatment is sought out. There have been many publications showing increased odds of certain mental disorders in children living in neighborhoods with poor conditions (both physically and socially), but not much research has focused on this relationship in adults (Butler et al., 2012; Dahal et al., 2018; Kemp et al., 2016; Plybon & Kliewer, 2001; Reuben et al., 2020). A similar analysis was conducted in Philadelphia, investigating the relationship between neighborhood characteristics and serious mental illness diagnosis in adults (Byrne et al., 2013). However, my analysis will be using the entire Philadelphia population as a whole, whereas the Bynre et al. analysis only included adults already being treated for serious mental illness. My project will also offer another layer to analysis with breakdowns of relationships by geographic regions.

This project will involve a few fields of knowledge to understand the problems, create appropriate analyses and visuals, and interpret the results and relationships. Firstly, this problem presents as an issue in the field of mental health; we can better understand what factors may predict poorer mental health outcomes. It is also a major issue for public health because the analysis will be at the population level. Revealing what neighborhoods are showing the greatest risks of neighborhood estrangement and associated mental health outcomes will educate public health entities in the Philadelphia area, and could even be a jumping-off point for geographically-targeted mental health interventions. Lastly, data science is an important field that will contribute to this project. The use of data tools to analyze, manipulate, and map these variables will be able to describe and visualize the relationships I aim to explore.


### Methods

# INSTALL NECESSARY PACKAGES
``` {r}
library(dplyr)
library(haven)
library(ggplot2)
library(leaflet)
library(tidyverse)
library(zipcodeR)
library(maps)


```

# DATA READ-IN AND CLEAN
# READ IN DATA, CURRENTLY IN STATA
# CREATE SEPARATE DATASET FOR POPULATION THAT HAS EVER BEEN DIAGNOSED WITH MENTAL HEALTH CONDITION
# CREATE NEW DATASET WITH DESIRED VARIABLE AND LABEL VARIABLE VALUES SO THEY MAKE SENSE
``` {r}

chdb <- read_dta('H:\\MBMI\\Data Science\\Final Project\\HHS18AR.dta')

head(chdb)

chdb[is.na(chdb)] <- 0

chdb[,c('MENTAL3A','tretmnta', 'NEIGHBOR_FA', 'IMPROVE_FA', 'BELONG_FA','TRUST_FA','HAVEPARK2_FA','SOCCAP_2CAT_FA','SOCCAP_3CAT_FA')] <- lapply(chdb[,c('MENTAL3A','tretmnta', 'NEIGHBOR_FA', 'IMPROVE_FA', 'BELONG_FA','TRUST_FA','HAVEPARK2_FA','SOCCAP_2CAT_FA','SOCCAP_3CAT_FA')], as.character)


dat1 <- data.frame()



for (i in 1:nrow(chdb)) {
  if(chdb[i, 'MENTAL3A']=="1") {
    dat1[i, 'mh_dx'] <- "Yes"
  } else if(chdb[i, 'MENTAL3A']=="2") {
  dat1[i, 'mh_dx'] <- "No"
  } else  {
  dat1[i, 'mh_dx'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'tretmnta']=="1") {
    dat1[i, 'mh_trt'] <- "Yes"
  } 
  else if(chdb[i, 'tretmnta']=="2") {
  dat1[i, 'mh_trt'] <- "No"
  } 
  else  {
  dat1[i, 'mh_trt'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'NEIGHBOR_FA']=="1") {
    dat1[i, 'neigh_help'] <- "Always"
  } else if(chdb[i, 'NEIGHBOR_FA']=="2") {
  dat1[i, 'neigh_help'] <- "Often"
  }
  else if(chdb[i, 'NEIGHBOR_FA']=="3") {
  dat1[i, 'neigh_help'] <- "Sometimes"
  }
  else if(chdb[i, 'NEIGHBOR_FA']=="4") {
  dat1[i, 'neigh_help'] <- "Rarely"
  }
  else if(chdb[i, 'NEIGHBOR_FA']=="5") {
  dat1[i, 'neigh_help'] <- "Never"
  }
  else  {
  dat1[i, 'neigh_help'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'IMPROVE_FA']=="1") {
    dat1[i, 'neigh_toget'] <- "Yes"
  } else if(chdb[i, 'IMPROVE_FA']=="2") {
  dat1[i, 'neigh_toget'] <- "No"
  }
  else  {
  dat1[i, 'neigh_toget'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'BELONG_FA']=="1") {
    dat1[i, 'belong'] <- "Strongly Agree"
  } else if(chdb[i, 'BELONG_FA']=="2") {
  dat1[i, 'belong'] <- "Agree"
  }
  else if(chdb[i, 'BELONG_FA']=="3") {
  dat1[i, 'belong'] <- "Disagree"
  }
  else if(chdb[i, 'BELONG_FA']=="4") {
  dat1[i, 'belong'] <- "Strongly Disagree"
  }
  else  {
  dat1[i, 'belong'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'TRUST_FA']=="1") {
    dat1[i, 'trust'] <- "Strongly Agree"
  } else if(chdb[i, 'TRUST_FA']=="2") {
  dat1[i, 'trust'] <- "Agree"
  }
  else if(chdb[i, 'TRUST_FA']=="3") {
  dat1[i, 'trust'] <- "Disagree"
  }
  else if(chdb[i, 'TRUST_FA']=="4") {
  dat1[i, 'trust'] <- "Strongly Disagree"
  }
  else  {
  dat1[i, 'trust'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'HAVEPARK2_FA']=="1") {
    dat1[i, 'park'] <- "Yes"
  } else if(chdb[i, 'HAVEPARK2_FA']=="2") {
  dat1[i, 'park'] <- "No, no park"
  }
  else if(chdb[i, 'HAVEPARK2_FA']=="3") {
  dat1[i, 'park'] <- "No, not comfortable"
  }
  else  {
  dat1[i, 'park'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'SOCCAP_2CAT_FA']=="1") {
  dat1[i, 'soc_2cat'] <- "Low"
  } 
  else if(chdb[i, 'SOCCAP_2CAT_FA']=="2") {
  dat1[i, 'soc_2cat'] <- "Medium or High"
  }
  else  {
  dat1[i, 'soc_2cat'] <- "Unknown"
  }
}


for (i in 1:nrow(chdb)) {
  if(chdb[i, 'SOCCAP_3CAT_FA']=="1") {
    dat1[i, 'soc_3cat'] <- "Low"
  } 
  else if(chdb[i, 'SOCCAP_3CAT_FA']=="2") {
  dat1[i, 'soc_3cat'] <- "Medium"
  } 
  else if(chdb[i, 'SOCCAP_3CAT_FA']=="3") {
  dat1[i, 'soc_3cat'] <- "High"
  }
  else  {
  dat1[i, 'soc_3cat'] <- "Unknown"
  }
}



dat1$zip <- chdb$zipcode

dat1[dat1=="Unknown"] <- NA



dat1_mh <- dat1 %>%
           filter(mh_dx=="Yes")

```


# EXAMINE VARIABLES OF INTEREST (GEOGRAPHIC, MENTAL HEALTH, AND SOCIAL) WITH BASIC FREQUENCIES AND PLOTS
``` {r}

dat1 %>%
  group_by(mh_dx) %>%
  summarize(n())

ggplot(data=dat1, aes(x=mh_dx)) +
  geom_bar()

dat1_mh %>%
  group_by(mh_trt) %>%
  summarize(n())

ggplot(data=dat1_mh, aes(x=mh_trt)) +
  geom_bar()

dat1 %>%
  group_by(neigh_help) %>%
  summarize(n())

ggplot(data=dat1, aes(x=neigh_help)) +
  geom_bar()

dat1 %>%
  group_by(neigh_help) %>%
  summarize(n())

ggplot(data=dat1, aes(x=neigh_toget)) +
  geom_bar()

dat1 %>%
  group_by(belong) %>%
  summarize(n())

ggplot(data=dat1, aes(x=belong)) +
  geom_bar()

dat1 %>%
  group_by(trust) %>%
  summarize(n())

ggplot(data=dat1, aes(x=trust)) +
  geom_bar()

dat1 %>%
  group_by(park) %>%
  summarize(n())

ggplot(data=dat1, aes(x=park)) +
  geom_bar()

dat1 %>%
  group_by(soc_2cat) %>%
  summarize(n())

ggplot(data=dat1, aes(x=soc_2cat)) +
  geom_bar()

dat1 %>%
  group_by(soc_3cat) %>%
  summarize(n())

ggplot(data=dat1, aes(x=soc_3cat)) +
  geom_bar()


```


# GEOGRAPHICAL DATA EXPLORATION
``` {r}

# GET COORDINATES FOR ZIP CODES IN DATASET
dat1_geocodes <- geocode_zip(dat1$zip)
dat1_geocodes <- rename(dat1_geocodes, zip=zipcode)

dat1 <- merge(dat1, dat1_geocodes, by='zip')
dat1_zip <- dat1 %>%
            filter(!is.na(lat) & !is.na(lng))


# CREATE BASE MAP OF PHILADELPHIA AREA
phl_map <- map("county", "pennsylvania", xlim=c(-77,-74), ylim=c(39,41))

phl_map2 <- map_data("phl_map")

# PLOT EACH RESPONSE ON BASE MAP 

ggplot(phl_map2, aes(x, y, group=names)) +
  geom_point(data=dat1_zip, aes(x=lng, y=lat))


```


# SOCIAL SCALE AND INDIVIDUAL SOCIAL VARIABLES BY MENTAL HEALTH DIAGNOSIS
``` {r}


table(dat1$soc_2cat, dat1$mh_dx)
chisq.test(dat1$soc_2cat, dat1$mh_dx)
# p<0.00001

dat1 %>%
  filter(!is.na(mh_dx), !is.na(soc_2cat)) %>%
  ggplot(aes(x=mh_dx, fill=soc_2cat)) +
  geom_bar()


table(dat1$soc_3cat, dat1$mh_dx)
chisq.test(dat1$soc_3cat, dat1$mh_dx)
# p<0.00001

dat1 %>%
  filter(!is.na(mh_dx), !is.na(soc_3cat)) %>%
  ggplot(aes(x=mh_dx, fill=soc_3cat)) +
  geom_bar()




table(dat1$neigh_help, dat1$mh_dx)
chisq.test(dat1$neigh_help, dat1$mh_dx)
# p=0.001545

table(dat1$neigh_toget, dat1$mh_dx)
chisq.test(dat1$neigh_toget, dat1$mh_dx)
# p=0.06143

table(dat1$belong, dat1$mh_dx)
chisq.test(dat1$belong, dat1$mh_dx)
# p<0.00001

table(dat1$trust, dat1$mh_dx)
chisq.test(dat1$trust, dat1$mh_dx)
# p<0.00001

table(dat1$park, dat1$mh_dx)
chisq.test(dat1$park, dat1$mh_dx)
# p=0.006208

```


# SOCIAL SCALE AND INDIVIDUAL SOCIAL VARIABLES BY MENTAL HEALTH TREATMENT
``` {r}


table(dat1_mh$soc_2cat, dat1_mh$mh_trt)
chisq.test(dat1_mh$soc_2cat, dat1_mh$mh_trt)
# p=0.6645

dat1_mh %>%
  filter(!is.na(mh_trt), !is.na(soc_2cat)) %>%
  ggplot(aes(x=mh_trt, fill=soc_2cat)) +
  geom_bar()


table(dat1_mh$soc_3cat, dat1_mh$mh_trt)
chisq.test(dat1_mh$soc_3cat, dat1_mh$mh_trt)
# p=0.8656

dat1_mh %>%
  filter(!is.na(mh_trt), !is.na(soc_3cat)) %>%
  ggplot(aes(x=mh_trt, fill=soc_3cat)) +
  geom_bar()




table(dat1_mh$neigh_help, dat1_mh$mh_trt)
chisq.test(dat1_mh$neigh_help, dat1_mh$mh_trt)
# p=0.5604

table(dat1_mh$neigh_toget, dat1_mh$mh_trt)
chisq.test(dat1_mh$neigh_toget, dat1_mh$mh_trt)
# p=0.2028

table(dat1_mh$belong, dat1_mh$mh_trt)
chisq.test(dat1_mh$belong, dat1_mh$mh_trt)
# p=0.6033

table(dat1_mh$trust, dat1_mh$mh_trt)
chisq.test(dat1_mh$trust, dat1_mh$mh_trt)
# p=0.6915

table(dat1_mh$park, dat1_mh$mh_trt)
chisq.test(dat1_mh$park, dat1_mh$mh_trt)
# p=0.6587

```

> It appears that mental health treatment is not associated with any social determinants measured by this survey.


# PERFORM LOGISTIC REGRESSION ON OUTCOME OF MENTAL HEALTH DIAGNOSIS VERSUS SOCIAL DETERMINANT VARIABLES


### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
