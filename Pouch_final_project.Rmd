---
title: "Predition of Low Fetal Birth Weight from 3D Ultrasound of the Placenta"
author: "Alison Pouch"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
    fig_width: 6
    fig_height: 4
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***

### Overview

Advances in 3D ultrasound imaging technology have revealed associations between early placental volume and growth outcomes. However, a more detailed evaluation of placental shape remains elusive and could potentially lead to new quantitative metrics for fetal growth and outcome prediction. The goal of this project is to determine if 3D ultrasound-derived morphological characteristics of the placenta in the first trimester of pregnancy are predictive of whether a baby will be characterized as "small for gestational age" (in the 10th percentile for fetal birth weight). We explore new custom 3D metrics of placenta morphology beyond the volume estimates and 2D measurements that are currently available on commercial scanners.

#### Faculty Member Consultants

Nadav Schwartz, M.D., Associate Professor of Maternal Fetal Medicine - Dr. Schwartz is clinically trained in maternal fetal medicine and has expertise in the area of 3D ultrasound imaging in obstetrics. He is leading a large U01-funded project whose goal is to develop new multi-modal imaging techniques for analyzing human placental morphology and perfusion in vivo. The U01 includes interdisciplinary teams in computational image analysis, ultrasound, MRI, and optical imaging. Dr. Schwartz provided education in the clinical motivation for this project, suggested placenta shape metrics that may potentially be associated with growth outcomes, and coordinated the image acquisition and verification of manual image segmentations performed for this project.

Paul Yushkevich, Ph.D., Associate Professor of Radiology - Dr. Yushkevich is trainined in mathematics and computer science and specializes in computational shape and image analysis. He developed the framework for deformable medial modeling that was adapted to 3D shape analysis of the placenta implemented in this project. He provided insight into derivation of placenta shape metrics and the machine learning methods that were used to create predictive models for low fetal birth weight. His specific suggestions were related to feature selection and use of logistic regression and random forest classifiers, cautioning against "double dipping" in the feature selection and model evaluation steps. He also provided advice related to working with small datasets. 

James Gee, Ph.D., Associate Professor of Radiology and Computer and Information Science - Dr. Gee is trained in computer science and specializes in computational image analysis and machine learning for diverse medical imaging applications. He provided insight into potential sources of the discrepancy in placenta volume measurements that were observed in this project, and made recommendations related to combining maternal and fetal characteristics and image-derived features into predictive models. 

#### Link to GitHub repository

https://github.com/apouch/BMIN503_Final_Project

### Introduction 

The placenta serves many critical functions in maintaining a healthy pregnancy, including nutritional, immune, and hormonal support. Previous work indicates that placental size is significantly associated with perinatal outcomes such as birth weight, fetal growth disorders, preeclampsia and fetal demise. However, research related to in vivo placental morphology has been limited in terms of validation and rudimentary shape indices. The goal of this project is to determine if there are 3D morphological features of the placenta, in combination with maternal and fetal characteristics, that are predictive of low fetal birth weight. The objective is to analyze these features during the first trimester of pregnancy when processes critical to placenta pathophysiology are believed to occur.

This project is an interdisciplinary collaboration between the Departments of Maternal Fetal Medicine and Radiology, and combines expertise in maternal fetal medicine, computer and information science, ultrasound imaging, and statistics. It requires clinical expertise for image acquisition and knowledge of pregnancy and placenta development, and technical expertise for extracting image features and generating predictive models from image, maternal, and fetal characteristics. 

The data set used in this study was acquired by the Department of Maternal Fetal Medicine at Penn and includes first-trimester placenta measurements and patient characteristics of 60 subjects with an outcome variable related to low fetal birth weight. We recognize that this is an extremely small dataset to develop and evaluate a predictive algorithm, but expect that the number of available datasets will increase by a factor of 10 when automated image segmentation algorithms have been validated. (We currently have ~600 cases but are currently limited by the need to manually segment the placenta in 3D ultrasound images in order to extract custom shape metrics.)

### Methods
This section gives an overview of image analysis performed, exploratory analysis of non-placenta features, feature selection based on importance and correlation analysis, and methods of model creation and evaluation. 

#### Image Analysis
3D ultrasound images were collected from 600 patients during the first trimester of pregnancy. The volume of the placenta in each image had been previously estimated using GE's VOCAL software package. Of these cases, the placenta was manually segmented in 60 images that were associated with a primary outcome variable related to low fetal birth weight. A trained researcher manually traced each placenta in ITK-Snap, an open-source software package for 3D medical image segmentation. An expert clinicial (Dr. Schwartz) verified the accuracy of each segmentation. The placenta segmentations were individually modeled using 3D deformable modeling using continuous medial axis representation (cm-rep), which establishes a shape-based coordinate system on each image segmentation such that standardized morphological features can be automatically computed. 25 measurements were automically derived from these models using custom Matlab functions, which included volume of the manual image segmentation, maternal and fetal surface areas of the placenta, maximum and mean placenta thickness, and the minumim/mean/maximum of the placenta diameter implemented three different ways. These shape features are individually defined in the data dictionary in the following section.

[Include figures]

#### Data
The data used in this study include maternal and fetal characteristics of the 60 subjects who underwent a 3D ultrasound exam during the first trimester of pregnancy at Penn, as well as morphological features that were obtained by manual image segmentation and deformable modeling of the placenta in the 3D ultrasound images. In addition, the data include placenta volume estimates that were made with a GE commercial software package called VOCAL. The latter were included to compare placental volumes that were obtained by manual image segmentation in ITK-Snap. The primary outcome variable is referred to as sga_10th, which indicates membership to the 10th percentile of the "small for gestational age" group, which relates to a measurement of birth weight relative to the gestational age.

The data is read from three spreadsheets: 
- The first is assigned to a data frame _df.clinical_ and contains maternal and fetal characteristics such as maternal race, weight, and height and the fetal sex, gestational age, and sga_10th outcome variable.
- The second is assigned to the data frame _df.vocal_ and contains placenta volume estimates that were made using the GE commercial software package VOCAL.
- The third is assigned to a data frame _df.morph3D_ and contains custom morphological measurements that were generated by 3D ultrasound image segmentation and shape modeling. These include placenta volume measurements calculated from manual image segmentations, as well as surface areas and measurements of placenta thickness and symmetry that are derived from deformable modeling of the manual image segmentations.

Relevant variables are converted to numeric data or factors and renamed as necessary. An inner join is performed based on the study_id variable and assigned to the data frame _df.merge_. Below is a list of variables contained in _df.merge_. In the description of placenta shape features, the "least-squares plane" refers to the best-fit plane through the rim of the placenta.

<font size ="1">

Non-Placenta Variable | Description
--------------|----------------------------------------------------------------
model_id      | model ID number (cm-rep model of the placenta)
study_id      | study ID number
race          | race (1 - white, 2 - black, 3 - asian)
wtscrn        | maternal weight at 1st screening visit (kg)
height        | maternal height (in)
sbpscrn       | maternal systolic blood pressure at 1st screening visit (bpm)
crl           | crown rump length of the fetus, measured in 2D ultrasound (mm)
pappamom      | concentration of the maternal serum marker PAPP-A measured measured during the first trimester of pregnancy, related to fetal Down syndrome (mIU/mL)  
fetal_sex     | fetal sex (0 = ?, 1 = ?)
maternal_age_US1  | maternal age at the first ultrasound exam (years)
gest_age_US1      | gestational age at the first ultrasound exam (days)
sga_10th      | membership to the 10th percentile of birth weight normalized to gestational age (primary outcome variable)

Placenta Shape Variable | Description 
--------------|----------------------------------------------------------------
Vsnap | placenta volume measured by manual 3D ultrasound image segmentation in ITK-Snap (cc)
SA_fetal | area of the chorionic (fetal) surface of the placenta (mm2)
SA_maternal | area of the maternal surface of the placenta (mm2)
SA_f2m | ratio of the fetal and maternal surface areas of the placenta 
SA_maternal_nga | SA_maternal divided by gestational age (mm2/days)
SA_fetal_nga | SA_maternal divided by gestational age (mm2/days)
Tcmrep_max | maximum placenta thickness (mm)
Tcmrep_mean | mean placenta thickness (mm)
circumference | length of the edge of the placenta (mm)
edge_maxheight | maximum distance of the placenta edge from a least-squares plane fit to the placenta edge (mm)
edge_minheight | minimum distance of the placenta edge from a least-squares plane fit to the placenta edge (mm)
diameter_2D_mean | mean diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane (mm)
diameter_2D_max | maximum diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane (mm)
diameter_2D_min | maximum diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane (mm)
diameter_2D_std | standard deviation of the diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane (mm)
surf_diameter_mean | mean placenta diameter, where diameter is measured from edge-to-edge across across the maternal surface of the placenta (mm)
surf_diameter_max | maximum placenta diameter, where diameter is measured from edge-to-edge across  across the maternal surface of the placenta (mm)
surf_diameter_min | minimum placenta diameter, where diameter is measured from edge-to-edge across across the maternal surface of the placenta (mm)
surf_diameter_std | standard deviation of the placenta diameter, where diameter is measured from edge-to-edge across the maternal surface of the placenta (mm)
diameter_3D_mean | mean 3D placenta diameter (mm)
diameter_3D_max | maximum 3D placenta diameter (mm)
diameter_3D_min | minimum 3D placenta diameter (mm)
diameter_3D_std | standard deviation in 3D placenta diameter (mm)
medial_surface_height_mean | mean height of the medial surface from the least-squares plane (mm)
medial_surface_height_max | maximum height of the medial surface from the least-squares plane (mm)
medial_surface_height_min | minimum height of the medial surface from the least-squares plane (mm)
sphericity | ratio of placenta volume to the volume of a sphere with the same diameter
<font size>

Below is the script used for data import into R:

``` {r eval=TRUE, warning=FALSE}
library(readxl, quietly = TRUE, warn.conflicts = FALSE)
library(tidyverse, quietly = TRUE, warn.conflicts = FALSE)
setwd("/Users/alison/BMIN503_placenta")

# Read in the entire clinical sheet
df.clinical.vars=read_xlsx("/Users/alison/Desktop/BMIN_503/final_project/placenta_subject_data.xlsx")

# Select variables wanted
df.clinical.vars <- df.clinical.vars %>%
    select(model_id = "Model number", 
           study_id = "Study ID", 
           race = "RACE", 
           wtscrn = "WTSCRN (kg)", 
           height = "HT (in)", 
           sbpscrn = "SBPSCRN", 
           crl = "CRL (mm)", 
           pappamom = "PAPPAMOM", 
           fetal_sex = "FETSEX1", 
           maternal_age_US1 = "Maternal Age at US1", 
           gest_age_US1 = "GA US1",
           sga_10th = "SGA<10th%") 

# List of maternal and fetal characteristics
clinical.vars.wanted = c('wtscrn','height','race','sbpscrn','crl','pappamom','fetal_sex','maternal_age_US1','gest_age_US1')

# Convert relevant columns to numeric
variables.numeric <- c("race","wtscrn","height","sbpscrn","crl","pappamom","fetal_sex","maternal_age_US1","sga_10th")
df.clinical.vars[,names(df.clinical.vars) %in% variables.numeric] <- sapply(lapply(df.clinical.vars[,names(df.clinical.vars) %in% variables.numeric],as.character),as.numeric)

# Read VOCAL measurements
df.vocal=read_xlsx("/Users/alison/Desktop/BMIN_503/final_project/placenta_vocal_measures.xlsx") 
df.vocal <- df.vocal %>%
  mutate(study_id=as.numeric(`Study ID`)) %>%
  rename(Vvocal=VolumeA) %>%
  select(c(study_id, Vvocal)) 

# Read 3DUS measurements and convert units if necessary
measures3D.wanted = c('Vsnap','SA_fetal','SA_maternal','Tcmrep_max','Tcmrep_mean','circumference','edge_maxheight','edge_minheight','diameter_2D_mean','diameter_2D_min','diameter_2D_max','diameter_2D_std','surf_diameter_mean','surf_diameter_min','surf_diameter_max','surf_diameter_std','diameter_3D_mean','diameter_3D_min','diameter_3D_max','diameter_3D_std','medial_surface_height_max','medial_surface_height_mean','medial_surface_height_min','SA_f2m','SA_maternal_nga','SA_fetal_nga','sphericity')

df.morph3D=read.csv("/Users/alison/Desktop/BMIN_503/final_project/sga_study_allsubjects.csv") 
df.morph3D <- df.morph3D %>%
  rename(model_id=Model) %>%
  mutate(Vsnap=Vmanual/1000) %>%
  mutate(Tcmrep_mean=thickness_mean/10) %>%
  mutate(Tcmrep_max=thickness_max/10) %>%
  mutate(SA_f2m=Fetal.to.maternal.SA) %>%
  mutate(SA_maternal_nga=GA.norm.Maternal.SA) %>%
  mutate(SA_fetal_nga=GA.norm.Fetal.SA) %>%
  select(c('model_id',measures3D.wanted))

# Merge clinical data, vocal measurements, and 3DUS measurements
df.merge <- inner_join(df.clinical.vars,df.vocal,by="study_id") %>%
  filter(model_id %in% seq(1,60,1)) %>%
  inner_join(df.morph3D,by="model_id") %>%
  mutate(race = factor(race, levels=c(1,2,3), labels=c("white","black","asian"))) %>%
  mutate(fetal_sex = factor(fetal_sex, levels=c(0,1), labels=c("male","female"))) %>%
  mutate(sga_10th = factor(sga_10th, levels=c(0,1), labels=c("no","yes"))) 

```

#### Exploratory Data Analysis - Non-placenta features

Exploratory data analysis is performed on the material and fetal (non-placenta) characteristics. Plots of each characteristic are made with respect to the dependent variable, sga_10th.

``` {r eval=TRUE, warning=FALSE}
library(GGally, quietly = TRUE, warn.conflicts = FALSE)
library(ggplot2, quietly = TRUE, warn.conflicts = FALSE)
library(cowplot, quietly = TRUE, warn.conflicts = FALSE)
library(ggthemes, quietly = TRUE, warn.conflicts = FALSE)
library(plotly, quietly = TRUE, warn.conflicts = FALSE)

# Maternal characteristics relative to sga_10th
m1 <- ggplot(data=df.merge, aes(x=race, fill=sga_10th)) +
        geom_bar(position="stack") +
        labs(x="sga_10th",y="race") +
        theme(legend.position="none")
m2 <- ggplot(data=df.merge, aes(x=sga_10th,y=sbpscrn, fill=sga_10th)) +
        geom_boxplot() +
        labs(x="sga_10th",y="SBP (bpm)") +
        theme(legend.position="none")
m3 <- ggplot(data=df.merge, aes(x=sga_10th,y=height, fill=sga_10th)) +
        geom_boxplot() +
        labs(x="sga_10th",y="maternal height (in)") +
        theme(legend.position="none")
m4 <- ggplot(data=df.merge, aes(x=sga_10th,y=wtscrn, fill=sga_10th)) +
        geom_boxplot() +
        labs(x="sga_10th",y="maternal weight (kg)") +
        theme(legend.position="none")
m5 <- ggplot(data=df.merge, aes(x=sga_10th,y=maternal_age_US1, fill=sga_10th)) +
        geom_boxplot() +
        labs(x="sga_10th",y="maternal age (years)") +
        theme(legend.position="none")
m6 <- ggplot(data=df.merge, aes(x=sga_10th,y=pappamom, fill=sga_10th)) +
        geom_boxplot() +
        labs(x="sga_10th",y="PAPP-A level (mIU/mL)") +
        theme(legend.position="none")

plot_grid(m1, m2, m3, m4, m5, m6, ncol = 3, labels=NULL)

# fetal characteristics relative to sga_10th
f1 <- ggplot(data=df.merge, aes(x=fetal_sex, fill=sga_10th)) +
        geom_bar(position="stack") +
        labs(x="fetal sex",y="count")
f2 <- ggplot(data=df.merge, aes(x=sga_10th,y=gest_age_US1,fill=sga_10th)) +
        geom_boxplot() + 
        labs(x="sga_10th",y="gestational age (days)")
f3 <- ggplot(data=df.merge, aes(x=sga_10th,y=crl,fill=sga_10th)) +
        geom_boxplot() +
        labs(x="sga_10th",y="crown rump length (mm)")

plot_grid(f1, f2, f3, ncol = 2, labels=NULL)

```

Since two outliers are noted in the maternal systolic blood pressure (SBP), the data frame _df.merge_ is updated to change the value of this outlier to NA.

``` {r eval=TRUE, warning=FALSE}

df.merge$sbpscrn <- sapply(df.merge$sbpscrn,function(x){if (x > 750) NA else x})

m <- ggplot(data=df.merge, aes(x=sga_10th,y=sbpscrn)) +
        geom_boxplot() +
        labs(x="sga_10th",y="SBP") +
        theme(legend.position="none") 
plot(m)

```

#### Placenta feature selection 

We expect many of the placenta shape measurements to be correlated since they are various ways of measuring morphological features of the placenta. For example, placenta diameter can be measured multiple ways (from a 2D projection, from edge-to-edge in 3D, or across the maternal surface of the placenta), and it is not known which technique is most clinically meaningful. We also suspect that surface area measurements may be highly correlated with placenta volume, so the next step is to reduce the number of morphological measurements to those that are likely most important. We first eliminate shape features based on importance metrics, and then further eliminate features that are significantly correlated and have low variance. The importance metrics are evaluated first because reducing features based on correlation analysis alone was less straightforward.

It is important to note that we perform shape feature selection by evaluating the relationships between the predictor and the outcome variable based on all available training data. This is not ideal and may be considered "double dipping" since we are using knowledge of each outcome to tailor the predictive model. In this project, shape feature selection on a subset of the entire data set would be difficult because of the small sample size. In the future expanded data set, this feature selection step will be performed excluding all test data.

The variable names of all the placenta shape features are given in the vector _measures3D.wanted_. These measurements are first normalized since they have different units and scales. The measurements are then ranked with respect to importance by creating (1) univariate linear regression models between each measurement and the sga_10th outcome variable and (2) a random forest model using all measurements as features. The p-values from linear regression are listed in ascending order and compared to the Gini importance scores listed in descending order. The list of shape measurements is reduced based on these lists and the variable names are stored in the vector _shape.imp.reduce_.

``` {r eval=TRUE}
library(randomForest, quietly = TRUE, warn.conflicts = FALSE)
library(knitr)
library(kableExtra)

# First all variables are normalized
normalize <- function(x) {
    return ((x - min(x,na.rm=TRUE)) / (max(x,na.rm=TRUE) - min(x,na.rm=TRUE)))
  }
df.merge[measures3D.wanted] <- as.data.frame(sapply(df.merge[measures3D.wanted], normalize))

# List p-values for univariate analyses
pvals <- vector()
frm <- sga_10th ~ v
for(i in 1:length(measures3D.wanted)){
  frm <- as.formula(paste("sga_10th ~",measures3D.wanted[i]))
  v.glm <- glm(formula=frm, data=df.merge, family=binomial())
  pvals[i] <- coef(summary(v.glm))[2,4]
}
pvals.glm <- data.frame("LM variable"=measures3D.wanted[measures3D.wanted!="sga_10th"],"pvals"=pvals) %>%
  arrange(desc(1-pvals))

# Gini values from random forest classifier
measures.rf.all <- randomForest(sga_10th ~ ., data=df.merge[c(measures3D.wanted,'sga_10th')], ntree=100, importance=TRUE)
rf.pred <- predict(measures.rf.all, df.merge[c(measures3D.wanted,'sga_10th')], type="response")
rf.pred.binary <- ifelse(rf.pred == "yes",2,1)
df.gini <- data.frame("RF variable"=c(measures3D.wanted),"MeanDecreaseGini"=measures.rf.all$importance[,4],row.names=NULL) %>%
  arrange(desc(MeanDecreaseGini))

df.imp <- cbind(pvals.glm,df.gini)
kable(df.imp, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 11)

# List of measurements reduced based on p-values and Gini scores
shape.imp.reduce <- c('surf_diameter_min','surf_diameter_max','surf_diameter_mean','sphericity','edge_maxheight', 'edge_minheight','Tcmrep_max','medial_surface_height_max','SA_fetal','Vsnap')

```

Statistically significant pairwise correlations between shape variables are identified by creating a correlogram and eliminating variables that are significantly correlated and have low variance. This reduced set of measurements are given in the vector _shape.cor.reduce_.

``` {r eval=TRUE}
library(Hmisc, quietly = TRUE, warn.conflicts = FALSE)
library(corrplot, quietly = TRUE, warn.conflicts = FALSE)

# correlation of shape features
cor.shape.reduce <- cor(as.matrix(df.merge[shape.imp.reduce]))

# test for significant correlation between variables
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

# matrix of correlation p-values
p.mat.shape <- cor.mtest(as.matrix(df.merge[shape.imp.reduce]))

# correlogram of placenta shape features
corrplot(cor.shape.reduce, method="circle",type="upper",tl.col="black", tl.srt=45,p.mat = as.matrix(p.mat.shape), sig.level = 0.01, title="Correlation of Placenta Shape Features")

# significantly correlated shape features
shape.vars.sig.cor = c("surf_diameter_min","surf_diameter_mean","surf_diameter_max","medial_surface_height_max","edge_minheight","edge_maxheight","SA_fetal","Vsnap","Tcmrep_max")

# variance of each variable 
shape.vars.variance <- vector()
for(i in 1:length(shape.vars.sig.cor)){
  shape.vars.variance[i] <- var(df.merge[shape.vars.sig.cor[i]])
}
df.shape.variance <- data.frame(cbind(shape.vars.sig.cor,shape.vars.variance)) %>% 
  arrange(desc(shape.vars.variance))
names(df.shape.variance) <- c("placenta measure","variance")

kable(df.shape.variance,align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),full_width = FALSE, font_size = 11)

# list of shape measurements selected based on importance level and correlation analysis
shape.cor.reduce <- c('surf_diameter_max','sphericity','edge_maxheight','Tcmrep_max','medial_surface_height_max')

```

The non-placenta features are likewise normalized and reduced by generating a correlogram of the fetal and maternal characteristics listed in the vector _vars.clinical.wanted_. The reduced set of non-placenta features are listed in the vector _vars.clinical.reduce_.

``` {r eval=TRUE}

# normalize non-placenta features
df.merge[clinical.vars.wanted][!sapply(df.merge[clinical.vars.wanted],is.factor)] <- as.data.frame(sapply(df.merge[clinical.vars.wanted][!sapply(df.merge[clinical.vars.wanted],is.factor)], normalize))

# correlation of fetal and maternal characteristics
cor.clinical <- cor(data.matrix(df.merge[clinical.vars.wanted]),use="na.or.complete")

# matrix of correlation p-values
p.mat.clinical <- cor.mtest(data.matrix(df.merge[clinical.vars.wanted]))

# correlogram for fetal and maternal characteristics
corrplot(cor.clinical, method="circle",type="upper",tl.col="black", tl.srt=45,p.mat = as.matrix(p.mat.clinical), sig.level = 0.01)

# significantly correlated maternal and fetal characteristics
clinical.vars.sig.cor = c("crl","gest_age_US1")

# variance of each correlated variable 
clinical.vars.variance <- vector()
for(i in 1:length(clinical.vars.sig.cor)){
  clinical.vars.variance[i] <- var(df.merge[clinical.vars.sig.cor[i]])
}
print(data.frame("non-placenta feature"=clinical.vars.sig.cor,"variance"=clinical.vars.variance) %>%
      arrange(desc(variance)))

# reduced set of non-placenta features
clinical.vars.cor.reduce = c("wtscrn","height","race","sbpscrn","pappamom","fetal_sex","crl","maternal_age_US1")

# combined set of shape and non-shape features (reduced)
vars.all.cor.reduce = c(shape.cor.reduce,clinical.vars.cor.reduce)

```

#### Model Creation and Evaluation

The following models are evaluated, each of which uses sga_10th as the primary outcome variable:
- Logistic regression and random forest models with only the reduced set of placenta shape measurements as predictors
- Logistic regression and random forest models with only the reduced set of non-placenta shape features (uncorrelated maternal and fetal characteristics) as predictors
- Logistic regression and random forest models with the reduced set of placenta and non-placenta features as predictors

For each of the three models above, the model is first trained using all variables and then using 5-fold cross-validation. Because of the small sample size, 5-fold cross validation is used to ensure that several examples of sga_10th positive cases are sampled in test data. ROC analysis is performed for each of the models created. The function for model evaluation is referred to as _model.eval_ below.

``` {r eval=TRUE}
library(pROC, quietly = TRUE, warn.conflicts = FALSE)
library(boot, quietly = TRUE, warn.conflicts = FALSE)

model.eval <- function(df.vars.model){
  
  glm.reduce.alltrain <- glm(sga_10th ~ ., data=df.vars.model, family=binomial(logit))
  glm.reduce.alltrain.pred <- predict.glm(glm.reduce.alltrain, df.vars.model, type="response")
  glm.reduce.alltrain.binary <- ifelse(glm.reduce.alltrain.pred < 0.5,1,2)
  
  rf.reduce.alltrain <- randomForest(as.formula("sga_10th ~."),data=df.vars.model, ntree=100, na.action=na.omit, importance=TRUE)
  rf.reduce.alltrain.pred <- predict(rf.reduce.alltrain, df.vars.model, type="response")
  rf.reduce.alltrain.binary <- ifelse(rf.reduce.alltrain.pred == "yes",2,1)
  
  #K-Fold Cross Validation
  N = nrow(df.vars.model)
  K = 5
  set.seed(1234)
  s = sample(1:K, size=N, replace=T)
  pred.outputs.glm <- vector(mode="numeric", length=N)
  pred.outputs.rf <- vector(mode="numeric", length=N)
  obs.outputs <- vector(mode="numeric", length=N)
  offset <- 0
  for(i in 1:K){
  	train <- filter(df.vars.model, s != i)
  	test <- filter(df.vars.model, s == i)
    obs.outputs[1:length(s[s==i]) + offset] <- test$sga_10th

    #GLM train/test
  	glm <- glm(sga_10th ~ ., data=train, family=binomial(logit),na.action=na.omit)
    glm.pred.curr <- predict(glm, test, type="response")
    pred.outputs.glm[1:length(s[s==i]) + offset] <- glm.pred.curr

    #set.seed(222)
    #train.imputed <- rfImpute(sga_10th ~ .,data=train)
    #set.seed(333)
    #rf <- randomForest(sga_10th ~ ., data=train.imputed, ntree=60, na.action=na.omit)
  	#rf.pred.curr <- predict(rf, newdata=test, type="prob")
  	#pred.outputs.rf[1:length(s[s==i]) + offset] <- rf.pred.curr[,2]

    # original
    rf <- randomForest(sga_10th ~ ., data=train, ntree=100, na.action=na.omit)
    rf.pred.curr <- predict(rf, newdata=test, type="prob")
    pred.outputs.rf[1:length(s[s==i]) + offset] <- rf.pred.curr[,2]

  	offset <- offset + length(s[s==i])
  }

  # Logistic regression
  roc.training.glm <- roc(df.vars.model$sga_10th, glm.reduce.alltrain.binary, ci=TRUE)
  roc.cv.glm <- roc(obs.outputs, pred.outputs.glm, ci=TRUE)
  plot.roc(df.vars.model$sga_10th, glm.reduce.alltrain.binary, col="black", ci=TRUE)
  plot.roc(obs.outputs, pred.outputs.glm, col="red", add=TRUE)
   
  #Random Forest
  roc.training.rf <- roc(as.numeric(df.vars.model$sga_10th), rf.reduce.alltrain.binary, ci=TRUE)
  roc.cv.rf <- roc(obs.outputs, pred.outputs.rf, ci=TRUE)
  plot.roc(df.vars.model$sga_10th,rf.reduce.alltrain.binary, col="blue", add=TRUE)
  plot.roc(obs.outputs, pred.outputs.rf, ci=TRUE, col="darkgreen", add=TRUE)

  legend("bottomright", legend=c(
    "GLM Training",
    "GLM Cross-Validation",
    "RF Training",
    "RF Cross-Validation"),
    col=c("black","red","blue","darkgreen"), lwd=2)
  
  # AUCs
  print(paste("GLM training AUC:",roc.training.glm$auc))
  print(paste("GLM cross-validation AUC:",roc.cv.glm$auc))
  print(paste("RF training AUC:",roc.training.rf$auc))
  print(paste("RF cross-validation AUC:",roc.cv.rf$auc))
  
}

```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

#### Results of exploratory data analysis (non-placenta characteristics)
Exploratory data analysis (figures below) did not reveal signifance between any individual maternal/fetal characteristic and the sga_10th outcome variable. However, several points that were noted:
- Fetal sex is disproportionately male in the sga_10th negative category. This may be related to small sample size or could mean that fetal sex is a predictor of normal fetal birth weight. Since this is not a well-known association, it is more likely related to sampling.
- Two outliers were observed in the SBPCRN variable, and these values were changed to NA.

##### Feature selection (placenta and non-placenta characteristics)
The tables below list the p-values and Gini scores associated with each placenta measurement resulting from the pairwise regression and random forest analyses, respectively. No measurement was found to be statistically significant  (p < 0.05) and there was no clear transition in importance level using either modeling method. Nonetheless, it was interesting that the measurements with the lowest p-values and highest Gini scores included diameter measurements that were made across the maternal surface (rather than edge-to-edge 2D and 3D diameter measurements). Based on these list of top variables we included the following variables, which are listed next to the component of placenta morphology that they represent:

Variable | Morphological feature type
---------|------------
surf_diameter_min       | maternal surface size
surf_diameter_max       | maternal surface size
surf_diameter_mean      | maternal surface size
Tcmrep_mean             | placenta thickness
Tcmrep_max              | placenta thickness
edge_max_height         | flatness of the placenta rim
edge_min_height         | flatness of the placenta rim
sphericity              | placenta convexity
medial_surface_height_max | placenta convexity

Several measurements had statistically significant pairwise associations (table below), many of which were expected. For example, the 2D and 3D edge-to-edge diameter measurements were highly correlated, as was fetal surface area and placenta volume. The following measurements were selected based on importance level and low pairwise correlation. The pairwise correlations between these selected measurements is shown in the following figure.



'surf_diameter_min','surf_diameter_max','sphericity','edge_maxheight','Tcmrep_max','medial_surface_height_max'


#### Model Evaluation

The ROC analysis of the logistic regression and random forest models are shown below. Predition of membership to the SGA_10th category based on the selected placenta measurements was somewhat poor (AUC < 0.7 in 5-fold cross-validation experiments). When the selected placenta measurements were combined with the maternal and fetal characteristics listed below, AUC metric of both the logistic regression and random forest models increased to 0.77 (ROC curves shown below). 

```{r eval=TRUE}
df.vars.shape.only <- df.merge[c(shape.cor.reduce,'sga_10th')]
df.vars.clinical.only <- df.merge[c(clinical.vars.cor.reduce,'sga_10th')]
df.vars.shape.plus.clinical <- df.merge[c(vars.all.cor.reduce,'sga_10th')]

model.shape.only <- model.eval(df.vars.model=df.vars.shape.only)
model.clinical.only <- model.eval(df.vars.model=df.vars.clinical.only)
model.shape.plus.clinical <- model.eval(df.vars.model=df.vars.shape.plus.clinical)

```

#### Evaluation of placenta volume 
Since some of the measures (placenta volume) are given twice -- one measurement made with the GE VOCAL software and the second measurement made from manual image segmentation -- we compare the two measurements to determine consistency. An interactive plot is made...

``` {r eval=TRUE}

#glm.vvocal = glm(sga_10th ~ Vvocal, data=df.merge,family=binomial())


# Volume analysis 
gvol <- ggplot(data=df.merge, aes(x=Vvocal,y=Vsnap)) +
    geom_smooth(method = "lm", color="black",size=0.1) + 
    geom_point(aes(shape=sga_10th,text=paste("Study ID:",study_id)),color="black",size=2) +
    scale_shape_manual(values=c(1,3)) +
    labs(x="Vvocal (cc)",y="Vsnap (cc)") 
ggplotly(gvol)

glm.vol = glm(Vvocal~Vsnap,data=df.merge)
summary(glm.vol)

# Thickness analysis
# tmean <- ggplot(data=df.merge, aes(x=Tvocal,y=Tcmrep_mean)) +
#          geom_smooth(method = "lm", color="black",size=0.1) + 
#          geom_point(aes(shape=sga_10th,text=paste("Model ID:",model_id)),color="black",size=2) +
#          scale_shape_manual(values=c(1,3)) 
# ggplotly(tmean)
# 
# glm.thickness_mean = glm(Tvocal~Tcmrep_mean,data=df.merge)
# summary(glm.thickness_mean)
# 
# tmax <- ggplot(data=df.merge, aes(x=Tvocal,y=Tcmrep_max)) +
#          geom_smooth(method = "lm", color="black",size=0.1) + 
#          geom_point(aes(shape=sga_10th,text=paste("Model ID:",model_id)),color="black",size=2) +
#          scale_shape_manual(values=c(1,3)) 
# ggplotly(tmax)
# 
# glm.thickness_max = glm(Tvocal~Tcmrep_max,data=df.merge)
# summary(glm.thickness_max)

```
### Discussion