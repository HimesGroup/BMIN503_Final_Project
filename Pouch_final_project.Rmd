---
title: "BMIN503/EPID600 Project Template"
author: "Alison Pouch"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.

### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

Advances in 3D ultrasound imaging technology have revealed associations between early placental volume and growth outcomes. However, a more detailed evaluation of placental shape remains elusive and could potentially lead to new quantitative metrics for fetal growth and outcome prediction. The goal of this project is to determine if 3D ultrasound-derived morphological characteristics of the placenta in the first trimester of pregnancy are predictive of whether a baby will be characterized as "small for gestational age" (in the 10th percentile for fetal birth weight). 

### Introduction 

The placenta serves many critical functions in maintaining a healthy pregnancy, including nutritional, immune, and hormonal support. Previous work indicates that placental size is significantly associated with perinatal outcomes such as birth weight, fetal growth disorders, preeclampsia and fetal demise. However, research related to in vivo placental morphology has been limited in terms of validation and rudimentary shape indices. The goal of this project is to determine if there are 3D morphological features of the placenta, in combination with maternal and fetal characteristics, that are predictive of low fetal birth weight. The objective is to analyze these features during the first trimester of pregnancy when processes critical to placenta pathophysiology are believed to occur.

This project is an interdisciplinary collaboration between the Departments of Maternal Fetal Medicine and Radiology, and combines expertise in maternal fetal medicine, computer and information science, ultrasound imaging, and statistics. It requires clinical expertise for image acquisition and knowledge of pregnancy and placenta development, and technical expertise for extracting image features and generating predictive models from image, maternal, and fetal characteristics. The data set used in this study was acquired by the Department of Maternal Fetal Medicine at Penn and includes first-trimester placenta measurements and patient characteristics of 60 subjects with an outcome variable related to low fetal birth weight. 

### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

## Data
The data used in this study include maternal and fetal characteristics of 60 subjects who underwent a 3D ultrasound exam during the first trimester of pregnancy at Penn, as well as morphological features that were obtained by manual image segmentation and deformable modeling of the placenta in the 3D ultrasound images. In addition, the data include placenta volume estimates that were made with a GE commercial software package called VOCAL. The latter were included to compare placental volumes that were obtained by manual image segmentation.

The data is read from three spreadsheets: 
- The first is assigned to a data frame _df.clinical_ and contains maternal and fetal characteristics such as maternal race, weight, and height and the fetal sex, gestational age, and SGA category (membership 10th percentile of the "small for gestational age" metric, which is a measurement of birthweight relative to the gestational age at birth). 
- The second is assigned to the data frame _df.vocal_ and contains placenta volume estimates that were made using the GE commercial software package VOCAL. 
- The third is assigned to a data frame _df.morph3D_ and contains custom morphological measurements that were generated by 3D ultrasound image segmentation and shape modeling. These include placenta volume measurements calculated from manual image segmentations, as well as surface areas and measurements of placenta thickness and symmetry that are derived from deformable modeling of the manual image segmentations.

Relevant variables are converted to numeric data or factors and renamed as necessary. An inner join is performed based on the study_id variable and assigned to the data frame _df.merge_. Below is a list of variables contained in _df.merge_.

Variable Name | Description
--------------|------------
model_id      | model ID number (cm-rep model of the placenta)
study_id      | study ID number
race          | race (7,44,1,2,3)
wtscrn        | 
height        | maternal height (in)
sbpscrn       |
crl           | crown rump length (mm)
pappamom      | 
fetal_sex     | fetal sex (0 = ?, 1 = ?)
maternal_age_US1  | maternal age at first ultrasound exam (years)
gest_age_US1      | gestational age at first ultrasound exam (days)
sga_10th      | membership to the 10th percentile of birthweight normalized to gestational age (primary outcome variable)

Vsnap | placenta volume measured by manual 3D ultrasound image segmentation in ITK-Snap (cc)
SA_fetal | area of the chorionic (fetal) surface of the placenta (mm3)
SA_maternal | area of the maternal surface of the placenta (mm3)
SA_f2m | ratio of the fetal and maternal surface areas of the placenta 
SA_maternal_nga | SA_maternal divided by gestational age (mm3/days)
SA_fetal_nga | SA_maternal divided by gestational age (mm3/days)
Tcmrep_max | maximum placenta thickness (mm)
Tcmrep_mean | mean placenta thickness (mm)
circumference | length of the edge of the placenta (mm)
edge_maxheight | maximum distance of the placenta edge from a least-squares plane fit to the placenta edge (mm)
edge_minheight | minimum distance of the placenta edge from a least-squares plane fit to the placenta edge (mm)
diameter_2D_mean | mean diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane
diameter_2D_max | maximum diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane
diameter_2D_min | maximum diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane
diameter_2D_std | standard deviation of the diameter of the placenta, measured from a 2D projection of the placenta onto the least-squares plane
surf_diameter_mean | mean placenta diameter, where diameter is measured from edge-to-edge across across the maternal surface of the placenta
surf_diameter_max | maximum placenta diameter, where diameter is measured from edge-to-edge across  across the maternal surface of the placenta
surf_diameter_min | minimum placenta diameter, where diameter is measured from edge-to-edge across across the maternal surface of the placenta
surf_diameter_std | standard deviation of the placenta diameter, where diameter is measured from edge-to-edge across the maternal surface of the placenta
diameter_3D_mean | mean 3D placenta diameter
diameter_3D_max | maximum 3D placenta diameter
diameter_3D_min | minimum 3D placenta diameter
diameter_3D_std | standard deviation in 3D placenta diameter
medial_surface_height_mean | mean height of the medial surface from the least-squares plane (mm)
medial_surface_height_max | maximum height of the medial surface from the least-squares plane (mm)
medial_surface_height_min | minimum height of the medial surface from the least-squares plane (mm)
sphericity | ratio of placenta volume to the volume of a sphere with the same diameter


``` {r eval=TRUE, warning=FALSE}
library(readxl)
library(tidyverse)
setwd("/Users/alison/BMIN503_placenta")

# Read in the entire clinical sheet
df.clinical=read_xlsx("/Users/alison/Desktop/BMIN_503/final_project/placenta_subject_data.xlsx")

# Select variables wanted
df.clinical.vars <- df.clinical %>%
    select(model_id = "Model number", 
           study_id = "Study ID", 
           race = "RACE", 
           wtscrn = "WTSCRN (kg)", 
           height = "HT (in)", 
           sbpscrn = "SBPSCRN", 
           crl = "CRL (mm)", 
           pappamom = "PAPPAMOM", 
           fetal_sex = "FETSEX1", 
           maternal_age_US1 = "Maternal Age at US1", 
           gest_age_US1 = "GA US1",
           sga_10th = "SGA<10th%") 

clinical.vars.wanted = c('race','wtscrn','height','sbpscrn','crl','pappamom','fetal_sex','maternal_age_US1','gest_age_US1')

# Convert relevant columns to numeric
variables.numeric <- c("race","wtscrn","height","sbpscrn","crl","pappamom","fetal_sex","maternal_age_US1","sga_10th")
df.clinical.vars[,names(df.clinical.vars) %in% variables.numeric] <- sapply(lapply(df.clinical.vars[,names(df.clinical.vars) %in% variables.numeric],as.character),as.numeric)

# Read VOCAL measurements (AIUM data)
df.vocal=read_xlsx("/Users/alison/Desktop/BMIN_503/final_project/placenta_vocal_measures.xlsx") 
df.vocal <- df.vocal %>%
  mutate(study_id=as.numeric(`Study ID`)) %>%
  rename(Vvocal=VolumeA) %>%
  select(c(study_id, Vvocal)) 

# Read 3DUS measurements
measures3D.wanted = c('Vsnap','SA_fetal','SA_maternal','Tcmrep_max','Tcmrep_mean','circumference','edge_maxheight','edge_minheight','diameter_2D_mean','diameter_2D_min','diameter_2D_max','diameter_2D_std','surf_diameter_mean','surf_diameter_min','surf_diameter_max','surf_diameter_std','diameter_3D_mean','diameter_3D_min','diameter_3D_max','diameter_3D_std','medial_surface_height_max','medial_surface_height_mean','medial_surface_height_min','SA_f2m','SA_maternal_nga','SA_fetal_nga','sphericity')

df.morph3D=read.csv("/Users/alison/Desktop/BMIN_503/final_project/sga_study_allsubjects.csv") 
df.morph3D <- df.morph3D %>%
  rename(model_id=Model) %>%
  mutate(Vsnap=Vmanual/1000) %>%
  mutate(Tcmrep_mean=thickness_mean/10) %>%
  mutate(Tcmrep_max=thickness_max/10) %>%
  mutate(SA_f2m=Fetal.to.maternal.SA) %>%
  mutate(SA_maternal_nga=GA.norm.Maternal.SA) %>%
  mutate(SA_fetal_nga=GA.norm.Fetal.SA) %>%
  select(c('model_id',measures3D.wanted))

# Merge clinical data, vocal measurements, and 3DUS measurements
df.merge <- inner_join(df.clinical.vars,df.vocal,by="study_id") %>%
  filter(model_id %in% seq(1,60,1)) %>%
  inner_join(df.morph3D,by="model_id") %>%
  mutate(race = factor(race, levels=c(1,2,3), labels=c("white","black","asian"))) %>%
  mutate(fetal_sex = factor(fetal_sex, levels=c(0,1), labels=c("male","female"))) %>%
  mutate(sga_10th = factor(sga_10th, levels=c(0,1), labels=c("no","yes"))) 

```

## Exploratory Data Analysis

Next, exploratory data analysis is performed. Maternal and fetal characteristics are ...

``` {r eval=TRUE, warning=FALSE}
library(GGally)
library(ggplot2)
library(cowplot)
library(ggthemes)
library(plotly)

# Maternal characteristics relative to sga_10th
m1 <- ggplot(data=df.merge, aes(x=race, fill=sga_10th)) +
        geom_bar(position="stack")
m2 <- ggplot(data=df.merge, aes(x=sga_10th,y=sbpscrn)) +
        geom_boxplot()
m3 <- ggplot(data=df.merge, aes(x=sga_10th,y=height)) +
        geom_boxplot()
m4 <- ggplot(data=df.merge, aes(x=sga_10th,y=wtscrn)) +
        geom_boxplot()
m5 <- ggplot(data=df.merge, aes(x=sga_10th,y=maternal_age_US1)) +
        geom_boxplot()
m6 <- ggplot(data=df.merge, aes(x=sga_10th,y=pappamom)) +
        geom_boxplot()

plot_grid(m1, m2, m3, m4, m5, m6, ncol = 2, labels="AUTO")

# fetal characteristics relative to sga_10th
f1 <- ggplot(data=df.merge, aes(x=fetal_sex, fill=sga_10th)) +
        geom_bar(position="stack")
f2 <- ggplot(data=df.merge, aes(x=sga_10th,y=gest_age_US1)) +
        geom_boxplot()
f3 <- ggplot(data=df.merge, aes(x=sga_10th,y=crl)) +
        geom_boxplot()

plot_grid(f1, f2, f3, ncol = 2, labels="AUTO")

```


## Feature selection (correlation analysis)
We expect many of the placenta morphology measurements to be correlated since they are various ways of measuring morphological features of the placenta. For example, placenta diameter can be measured multiple ways (from a 2D projection, from edge-to-edge in 3D, or across the maternal surface of the placenta), and it is not known which technique is most clinically meaningful. We also suspect that surface area measurements may be highly correlated with placenta volume, so the next step is to reduce the number of morphological measurements to those that are likely most important. 

The variable names of the placenta morphology features are given in the vector _measures3D.wanted_. These measurements are first normalized since they have different units and scales. The measurements are then ranked with respect to importance by creating (1) bivariate linear regression models between each measurement and the SGA_10th outcome variable and (2) a random forest model using all measurements as features. The p-values from linear regression are listed in ascending order and compared to the Gini importance scores listed in descending order. In addition, statistically significant pairwise correlations are listed in order of descending correlation coefficient. The most important measurements are determined to be those that are ranked most highly in importance and are not strongly correlated (i.e., have a Pearson correlation coefficient < 0.75). These measurements are given in the vector _measures.cor.reduce_.

``` {r eval=TRUE}
library(randomForest)
library(Hmisc)
library(glmnet)

normalize <- function(x) {
    return ((x - min(x)) / (max(x) - min(x)))
  }

df.merge[measures3D.wanted] <- as.data.frame(lapply(df.merge[measures3D.wanted], normalize))

# List p-values for bivariate analyses
pvals <- vector()
frm <- sga_10th ~ v
for(i in 1:length(measures3D.wanted)){
  frm <- as.formula(paste("sga_10th ~",measures3D.wanted[i]))
  v.glm <- glm(formula=frm, data=df.merge, family=binomial())
  pvals[i] <- coef(summary(v.glm))[2,4]
}
pvals.glm <- data.frame("measure3D"=measures3D.wanted[measures3D.wanted!="sga_10th"],"pvals"=pvals)
print(pvals.glm %>% arrange(desc(1-pvals,row.names=FALSE)))

# Gini values from random forest classifier
measures.rf.all <- randomForest(sga_10th~., data=df.merge[c(measures3D.wanted,'sga_10th')], ntree=100, importance=TRUE)
rf.pred <- predict(measures.rf.all, df.merge[c(measures3D.wanted,'sga_10th')], type="response")
rf.pred.binary <- ifelse(rf.pred == "yes",2,1)
df.gini <- data.frame("variable"=c(measures3D.wanted),"MeanDecreaseGini"=measures.rf.all$importance[,4],row.names=NULL)
print(df.gini %>% arrange(desc(MeanDecreaseGini)),row.names = FALSE)

#Kmeans
#measures.kmeans <- kmeans(df.merge[,measures3D.wanted],2)
#measures.kmeans
#table(df.merge$sga_10th, measures.kmeans$cluster)
#centers <- as.data.frame(measures.kmeans$centers)

# Lasso
#set.seed(1234)
#lasso <- cv.glmnet(x=as.matrix(df.merge[c(measures3D.wanted)]), y=df.merge$sga_10th, alpha=1, family="binomial",nfolds=5)
#lasso$lambda.min
#plot(lasso)
#lasso.coef <- coef(lasso, s="lambda.min")
#titanic.lasso.pred <- predict(titanic.lasso, x, s="lambda.min", type="response")
#head(titanic.lasso.pred)

#null.model=lm(df.merge$sga_10th ~ 1, data=df.merge[c(measures3D.wanted)])
#full.model=lm(df.merge$sga_10th ~ ., data=df.merge[c(measures3D.wanted)])
#step(full.model, direction="backward", data=df.merge[c(measures3D.wanted,'sga_10th')])

# correlation between measurements
rcorr.measures <- rcorr(as.matrix(df.merge[measures3D.wanted]))
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
df.measures.cor <- flattenCorrMatrix(rcorr.measures$r, rcorr.measures$P) %>%
  filter(abs(cor) > 0.75) %>%
  filter(p < 0.05)
print(df.measures.cor %>% arrange(desc(cor)),row.names = FALSE)

measures.cor.reduce <- c('surf_diameter_min','surf_diameter_max','sphericity','edge_maxheight','Tcmrep_max','medial_surface_height_max',"wtscrn","height","sbpscrn","crl","pappamom",'fetal_sex',"maternal_age_US1")
res.reduce <- rcorr(as.matrix(df.merge[measures.cor.reduce]))

rtest <- rcorr(as.matrix(df.merge[,names(df.merge) %in% c('wtscrn','height','sbpscrn','crl')]))

```

The relationship between the selected shape measurements and SGA_10th outcome variable are evaluated with logistic regression and random forest models. First the models are trained using all measurement variables and then using 5-fold cross-validation. Because of the small sample size, 5-fold cross validation is used to ensure that several examples of SGA_10th positive cases are sampled in test data. ROC analysis is performed for each of the four models created.

``` {r eval=TRUE}
library(pROC)
library(boot)

df.vars.model <- df.merge[c(measures.cor.reduce,'sga_10th')]

glm.reduce.alltrain <- glm(sga_10th ~ ., data=df.vars.model, family=binomial(logit))
glm.reduce.alltrain.pred <- predict.glm(glm.reduce.alltrain, df.vars.model, type="response")
glm.reduce.alltrain.binary <- ifelse(glm.reduce.alltrain.pred < 0.5,1,2)

rf.reduce.alltrain <- randomForest(sga_10th ~ ., data=df.vars.model, ntree=100, importance=TRUE)
rf.reduce.alltrain.pred <- predict(rf.reduce.alltrain, df.vars.model, type="response")
rf.reduce.alltrain.binary <- ifelse(rf.reduce.alltrain.pred == "yes",2,1)

#K-Fold Cross Validation
N = nrow(df.vars.model)
K = 5
set.seed(1234)
s = sample(1:K, size=N, replace=T)
pred.outputs.glm <- vector(mode="numeric", length=N)
pred.outputs.rf <- vector(mode="numeric", length=N)
obs.outputs <- vector(mode="numeric", length=N)
offset <- 0
for(i in 1:K){
	train <- filter(df.vars.model, s != i)
	test <- filter(df.vars.model, s == i)
  obs.outputs[1:length(s[s==i]) + offset] <- test$sga_10th
    
  #GLM train/test
	glm <- glm(sga_10th ~ ., data=train, family=binomial(logit))
  glm.pred.curr <- predict(glm, test, type="response")
  pred.outputs.glm[1:length(s[s==i]) + offset] <- glm.pred.curr
  
  #RF train/test
  rf <- randomForest(sga_10th ~ ., data=train, ntree=100)
	rf.pred.curr <- predict(rf, newdata=test, type="prob") 
	pred.outputs.rf[1:length(s[s==i]) + offset] <- rf.pred.curr[,2]

	offset <- offset + length(s[s==i])
}

# Logistic regression
roc.training.glm <- roc(df.vars.model$sga_10th, glm.reduce.alltrain.binary, ci=TRUE)
roc.cv.glm <- roc(obs.outputs, pred.outputs.glm, ci=TRUE)
plot.roc(df.vars.model$sga_10th, glm.reduce.alltrain.binary, col="black", ci=TRUE)
plot.roc(obs.outputs, pred.outputs.glm, col="red", add=TRUE)

#Random Forest
roc.training.rf <- roc(as.numeric(df.vars.model$sga_10th), rf.reduce.alltrain.binary, ci=TRUE)
roc.cv.rf <- roc(obs.outputs, pred.outputs.rf, ci=TRUE)
plot.roc(df.vars.model$sga_10th,rf.reduce.alltrain.binary, col="blue", add=TRUE)
plot.roc(obs.outputs, pred.outputs.rf, ci=TRUE, col="darkgreen", add=TRUE)

legend("bottomright", legend=c("GLM Training","GLM Cross-Validation", "RF Training", "RF Cross-Validation"), col=c("black","red","blue","darkgreen"), lwd=2)

# AUCs
print(paste("GLM training AUC:",roc.training.glm$auc))
print(paste("GLM cross-validation AUC:",roc.cv.glm$auc))
print(paste("RF training AUC:",roc.training.rf$auc))
print(paste("RF cross-validation AUC:",roc.cv.rf$auc))

```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

# Exploratory data analysis
Exploratory data analysis (figures below) did not reveal signifance between any individual maternal/fetal characteristic and the SGA_10th outcome variable. However, several points that were noted:
- Fetal sex is disproportionately male in the SGA_10th negative category. This may be related to small sample size or could mean that fetal sex is a predictor of normal fetal birth weight. Since this is not a well-known association, it is more likely related to sampling.
- An extreme outlier was observed in the SBPCRN variable, and this was changed to NA.

# Feature selection
The tables below list the p-values and Gini scores associated with each placenta measurement resulting from the pairwise regression and random forest analyses, respectively. No measurement was found to be statistically significant  (p < 0.05) and there was no clear transition in importance level using either modeling method. Nonetheless, it was interesting that the measurements with the lowest p-values and highest Gini scores included diameter measurements that were made across the maternal surface (rather than edge-to-edge 2D and 3D diameter measurements). Several measurements had statistically significant pairwise associations (table below), many of which were expected. For example, the 2D and 3D edge-to-edge diameter measurements were highly correlated, as was fetal surface area and placenta volume. The following measurements were selected based on importance level and low pairwise correlation. The pairwise correlations between these selected measurements is shown in the following figure.

'surf_diameter_min','surf_diameter_max','sphericity','edge_maxheight','Tcmrep_max','medial_surface_height_max'

The ROC analysis of the logistic regression and random forest models are shown below. Predition of membership to the SGA_10th category based on the selected placenta measurements was somewhat poor (AUC < 0.7 in 5-fold cross-validation experiments). When the selected placenta measurements were combined with the maternal and fetal characteristics listed below, AUC metric of both the logistic regression and random forest models increased to 0.77 (ROC curves shown below). 

"wtscrn","height","sbpscrn","crl","pappamom",'fetal_sex',"maternal_age_US1"



# Evaluation of placenta volume 
Since some of the measures (placenta volume) are given twice -- one measurement made with the GE VOCAL software and the second measurement made from manual image segmentation -- we compare the two measurements to determine consistency. An interactive plot is made...

``` {r eval=TRUE}

# Volume analysis 
gvol <- ggplot(data=df.merge, aes(x=Vvocal,y=Vsnap)) +
    geom_smooth(method = "lm", color="black",size=0.1) + 
    geom_point(aes(shape=sga_10th,text=paste("Model ID:",model_id,"Study ID:",study_id)),color="black",size=2) +
    scale_shape_manual(values=c(1,3)) 
ggplotly(gvol)

glm.vol = glm(Vvocal~Vsnap,data=df.merge)
summary(glm.vol)

# Thickness analysis
tmean <- ggplot(data=df.merge, aes(x=Tvocal,y=Tcmrep_mean)) +
         geom_smooth(method = "lm", color="black",size=0.1) + 
         geom_point(aes(shape=sga_10th,text=paste("Model ID:",model_id)),color="black",size=2) +
         scale_shape_manual(values=c(1,3)) 
ggplotly(tmean)

glm.thickness_mean = glm(Tvocal~Tcmrep_mean,data=df.merge)
summary(glm.thickness_mean)

tmax <- ggplot(data=df.merge, aes(x=Tvocal,y=Tcmrep_max)) +
         geom_smooth(method = "lm", color="black",size=0.1) + 
         geom_point(aes(shape=sga_10th,text=paste("Model ID:",model_id)),color="black",size=2) +
         scale_shape_manual(values=c(1,3)) 
ggplotly(tmax)

glm.thickness_max = glm(Tvocal~Tcmrep_max,data=df.merge)
summary(glm.thickness_max)

```
