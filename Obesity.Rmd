---
title: "Analysis of Obesity in the Philadelphia Region"
author: "Joyce Wang"
output:
  html_document:
    depth: 3
    highlight: tango
    theme: paper
    toc: no
  pdf_document:
    toc: no
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
### Overview
Obesity is a growing problem in America and the goal of my project is to focus on obesity in the Philadelphia region and to try to determine what factors influence obesity. I will be applying statistical and machine learning analysis to the Southeastern Pennsylvania Household Survey results from 2015 to determine what factors are the greatest predictors for obesity. You can get access to my Github repository [here](https://github.com/joycehelenwang/BMIN503_Final_Project).

I conceptualized my project after speaking with three faculty members: Andria Johnson, Rebecca Hubbard, and Ariana Chao. Andria Johnson is a Professor in the Department of History and Sociology of Science and recommended that I look at health disparities in the local Philadelphia region. Rebecca Hubbard is an Associate Professor of Biostatistics in the Department of Biostatistics, Epidemiology and Informatics and suggested using machine learning techniques to create a model to predict health outcomes and determine source variability. Ariana Chao is an Assistant Professor of Nursing and reccomended some datasets and discussed the impact of mental health on BMI and other health outcomes as a possibile route.

### Introduction 
The obesity epidemic in America is getting worse and current initiatives are not as effective as we'd hope. As of 2015-2016, about four in 10 U.S. adults were obese, up from 37.7 percent during 2013-2014. The news for children and teens isn’t much better. Overall, nearly 19 percent were obese in 2015-2016, up from about 17 percent during the previous two years. Obesity a serious concern because it’s a risk factor for many health conditions, such as diabetes, heart disease, stroke and even some kinds of cancer. Federal, state and local health policymakers need to continue campaigns that promote good nutrition and exercise, the food and beverage industry need to increase the supply of affordable, healthy, nutritious foods and fewer sugary drinks, and consumers need to demand healthier products and policies in their communities. I'm interested in looking at obesity in the Philadelphia region and used the Southeastern Pennsylvania Household Survey results from 2015 to determine what factors are the greatest predictors for obesity in hopes of influencing health initiatives and directing effects to subpopulations that are affected the most.

This problem interdiciplinary as it spans several fields. There is a large data science aspect since the analysis is performed through coding in R. The problem itself draws insights from epidemiology, public health and policy, and sociology. Since healthcare policies are so influential, it's vital that we have adequate data and effective analysis in order to inform these decisions. Datasets will need to be properly cleaned and transformed, making note of missing values. Additionally, being able to apply context to the obtained results and drawing the correct conclusions is crucial in best representing the population.

### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

The data I am analyzing is from the 2014-2015 Southeastern Pennsylvania Household Health Survey with results from adults and children combined. After loading in the data, variables will be converted to factor or numeric accordingly. Finally, interesting variables will be filtered and cleaned up for analysis.

``` {r, eval = TRUE, message = FALSE, warning = FALSE}
library(haven)
library(tidyverse)

# read in raw data
raw.data <- read_sav(url("https://raw.githubusercontent.com/joycehelenwang/BMIN503_Final_Project/master/HS15COM1b.sav"))

# convert to factors
data <- as_factor(raw.data)

# clean up variables
data$NUMADULT <- as.numeric(as.character(data$NUMADULT))

table(data$RACE2)
levels(data$RACE2) <- c("White", "Black", "Latino", "Asian", "Multi", "Native American", "Other")
```

### Results
``` {r, eval = TRUE}
# obesity
obesity <- data %>%
  select(Obesity = OBESITY2) %>%
  na.omit
ggplot(obesity, aes(Obesity)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")

## demographics
# county
county <- data %>%
  select(Obesity = OBESITY2, County = COUNTY) %>%
  na.omit
ggplot(county, aes(County)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")
ggplot(county, aes(County)) +
  geom_bar(position = "fill", aes(fill = Obesity)) + 
  labs(y = "Proportion")

# income
income <- data %>%
  select(Income = INCOME) %>%
  na.omit
ggplot(income, aes(Income)) +
  geom_bar(aes(fill=Income)) +
  labs(y = "Count") +
  theme(legend.text=element_text(size=5), 
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
income2 <- data %>%
  select(Obesity = OBESITY2, Income = INCOME) %>%
  na.omit
ggplot(income2, aes(Obesity)) +
  geom_bar(position = "fill", aes(fill = Income)) +
  labs(y = "Proportion") +
  theme(legend.text=element_text(size=4))

# sex and age
age <- data %>%
  select(Obesity = OBESITY2, Age = AGE) %>%
  na.omit
ggplot(age, aes(Obesity, Age)) +
  geom_boxplot(fill = "skyblue2")
ggplot(age, aes(Age)) +
  geom_bar(aes(fill = Obesity), position = "fill") + 
  labs(y = "Proportion")

sex <- data %>%
  select(Obesity = OBESITY2, Sex = SEX) %>%
  na.omit
ggplot(sex, aes(Sex)) +
  geom_bar(aes(fill = Obesity))

# race
race <- data %>%
  select(Obesity = OBESITY2, Race = RACE2) %>%
  na.omit
ggplot(race, aes(Race)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")
ggplot(race, aes(Race)) +
  geom_bar(aes(fill = Obesity), position = "fill") + 
  labs(y = "Proportion")

# household size
kids <- data %>%
  select(Obesity = OBESITY2, Kids = TOTKIDS) %>%
  na.omit
ggplot(kids, aes(Kids)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")

adults <- data %>%
  select(Obesity = OBESITY2, Adults = NUMADULT) %>%
  na.omit
ggplot(adults, aes(Adults)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")

size <- data %>%
  select(Obesity = OBESITY2, Kids = TOTKIDS, Adults = NUMADULT) %>%
  na.omit %>%
  mutate(Household = Kids + Adults)
ggplot(size, aes(Household)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")
ggplot(size, aes(Obesity, Household)) +
  geom_boxplot(fill = "skyblue2") +
  labs(y = "Count")

# employment
employment <- data %>%
  select(Obesity = OBESITY2, Employment = MAINEMPL) %>%
  na.omit
ggplot(employment, aes(Employment)) +
  geom_bar(fill = "skyblue2") +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  labs(y = "Count")
ggplot(employment, aes(Employment)) +
  geom_bar(aes(fill = Obesity), position = "fill") +
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle=90, hjust=1))

# education
education <- data %>%
  select(Obesity = OBESITY2, Education = RSPGRAD2) %>%
  na.omit
ggplot(education, aes(Education)) +
  geom_bar(fill = "skyblue2") +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  labs(y = "Count")
ggplot(education, aes(Education)) +
  geom_bar(aes(fill = Obesity), position = "fill") +
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle=90, hjust=1))

# marital status
marital <- data %>%
  select(Obesity = OBESITY2, Marital = RESPMAR) %>%
  na.omit
ggplot(marital, aes(Marital)) +
  geom_bar(fill = "skyblue2") +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  labs(y = "Count")
ggplot(marital, aes(Marital)) +
  geom_bar(aes(fill = Obesity), position = "fill") +
  labs(y = "Proportion") +
  theme(axis.text.x = element_text(angle=90, hjust=1))

# sexual identity
sexident <- data %>%
  select(Obesity = OBESITY2, SexIdent = SEXIDENT) %>%
  na.omit
ggplot(sexident, aes(SexIdent)) +
  geom_bar(fill = "skyblue2") +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  labs(x = "Sexual Idendity", y = "Count")
ggplot(sexident, aes(SexIdent)) +
  geom_bar(aes(fill = Obesity), position = "fill") +
  labs(x = "Sexual Identity", y = "Proportion") +
  theme(axis.text.x = element_text(angle=90, hjust=1))

```
```{r, eval = TRUE, message = FALSE, warning = FALSE}
library(reshape2)

# insurance rate
insurance.data <- data %>%
  select(Obesity = OBESITY2, Insured = INSURED) %>%
  na.omit
ggplot(insurance.data, aes(Obesity)) +
  geom_bar(aes(fill = Insured), position = "fill") +
  labs(y = "Proportion")

# usual go
usual <- data %>%
  select(Obesity = OBESITY2, Usual = USUALGO) %>%
  na.omit
ggplot(usual, aes(Usual)) +
  geom_bar(fill = "skyblue2") +
  theme(axis.text.x = element_text(angle=90, hjust=1)) +
  labs(y = "Count")
ggplot(usual, aes(Usual)) +
  geom_bar(aes(fill = Obesity), position = "fill") +
  labs(y = "Proportion") + 
  theme(axis.text.x = element_text(angle=90, hjust=1))

# types of insurance - count number of yes
work <- data %>%
  group_by(OBESITY2) %>%
  count(WORKCOM) %>%
  na.omit %>%
  filter(WORKCOM == "Yes") %>%
  select(Obesity = OBESITY2, Work = n)

self <- data %>%
  group_by(OBESITY2) %>%
  count(SELFCOM) %>%
  na.omit %>%
  filter(SELFCOM == "Yes") %>%
  select(Obesity = OBESITY2, Self = n)

meda <- data %>%
  group_by(OBESITY2) %>%
  count(MEDACOM) %>%
  na.omit %>%
  filter(MEDACOM == "Yes") %>%
  select(Obesity = OBESITY2, MedA = n)

medb <- data %>%
  group_by(OBESITY2) %>%
  count(MEDBCOM) %>%
  na.omit %>%
  filter(MEDBCOM == "Yes") %>%
  select(Obesity = OBESITY2, MedB = n)

ma <- data %>%
  group_by(OBESITY2) %>%
  count(MACOM) %>%
  na.omit %>%
  filter(MACOM == "Yes") %>%
  select(Obesity = OBESITY2, MA = n)

va <- data %>%
  group_by(OBESITY2) %>%
  count(VACOM) %>%
  na.omit %>%
  filter(VACOM == "Yes") %>%
  select(Obesity = OBESITY2, VA = n)

other <- data %>%
  group_by(OBESITY2) %>%
  count(OTHERCOM) %>%
  na.omit %>%
  filter(OTHERCOM == "Yes") %>%
  select(Obesity = OBESITY2, Other = n)

insurance.type <- list(work, self, meda, medb, ma, va, other) %>% 
  reduce(full_join, by = "Obesity")
insurance <- melt(insurance.type, id.vars='Obesity')

ggplot(insurance, aes(Obesity, value)) +
  geom_bar(stat = "identity", position = "fill", aes(fill=variable)) +
  labs(y = "Proportion") +
  scale_fill_discrete(name = "Insurance Type")

ggplot(insurance, aes(variable, value)) +
  geom_bar(stat = "identity", fill = "skyblue2") +
  labs(x = "Insurance Type", y = "Count") +
  scale_fill_discrete(name = "Obesity")

ggplot(insurance, aes(variable, value)) +
  geom_bar(stat = "identity", position = "fill", aes(fill=Obesity)) +
  labs(x = "Insurance Type", y = "Proportion") +
  scale_fill_discrete(name = "Obesity")
```
``` {r, eval = TRUE}
## health outcomes
# overall health
health <- data %>%
  select(Obesity = OBESITY2, Health = HEALTH) %>%
  na.omit
ggplot(health, aes(Health)) +
  geom_bar(fill = "skyblue2") +
  labs(y = "Count")
ggplot(health, aes(Health)) +
  geom_bar(aes(fill = Obesity), position = "fill") +
  labs(y = "Proportion")

# dentist
dentist <- data %>%
  select(Obesity = OBESITY2, Dentist = DENTIST) %>%
  na.omit
ggplot(dentist, aes(Obesity)) +
  geom_bar(position = "fill", aes(fill = Dentist)) + 
  labs(y = "Proportion")

# smoking
smoke <- data %>%
  select(Obesity = OBESITY2, Smoking = SMOKHOME) %>%
  na.omit
ggplot(smoke, aes(Obesity)) +
  geom_bar(position = "fill", aes(fill = Smoking)) + 
  labs(y = "Proportion")

# asthma
asthma <- data %>%
  group_by(OBESITY2) %>%
  count(EVRASTH) %>%
  na.omit %>%
  rename(Obesity = OBESITY2, Asthma = EVRASTH, Count = n)
ggplot(asthma, aes(Obesity, Count)) +
  geom_bar(stat = "identity", position = "fill", aes(fill = Asthma)) +
  labs(y = "Proportion")

```
``` {r, eval = TRUE, message = FALSE}
library(randomForest)
library(pROC)
library(data.table)

# select relevant data (demographics, access to care, health outcomes)
obesity.data <- data %>%
  select(Obesity = OBESITY2, County = COUNTY, Sex = SEX, Age = AGE, Kids = TOTKIDS, Adults = NUMADULT, Health = HEALTH, Asthma = EVRASTH, Usual = USUALGO, Work = WORKCOM, Self = SELFCOM, MedA = MEDACOM, MedB = MEDBCOM, MA = MACOM, VA = VACOM, Other = OTHERCOM, Insured = INSURED, Dentist = DENTIST, Obesity = OBESITY2, Smoking = SMOKHOME, Employment = MAINEMPL, Education = RSPGRAD2, Marital = RESPMAR, SexIdent = SEXIDENT, Race = RACE2, Income = INCOME) %>%
  filter(complete.cases(.)) %>%
  mutate(Obesity = fct_recode(Obesity, "Non-Obese" = "Underweight")) %>%
  mutate(Obesity = fct_recode(Obesity, "Non-Obese" = "Normal")) %>%
  mutate(Obesity = fct_recode(Obesity, "Non-Obese" = "Overweight"))

# random forest
obesity.rf <- randomForest(Obesity ~ ., data = obesity.data, importance = TRUE)
importance <- data.frame(obesity.rf$importance)
gini <- importance %>%
  rownames_to_column("variable") %>%
  arrange(desc(MeanDecreaseGini))
head(gini, n = 10)

obesity.rf.top <- randomForest(Obesity ~ Income + Age + Health + Education + County + Marital + Adults + Kids + Employment + Race, data = obesity.data, importance = TRUE)

rf.pred <- predict(obesity.rf.top, obesity.data, type="prob")

# glm 
obesity.glm <- glm(Obesity ~ ., data = obesity.data, family = binomial(logit))
summary(obesity.glm)

coef <- summary(obesity.glm)[12]
coef.sort <- as.data.frame(coef)
coef.sort <- setDT(coef.sort, keep.rownames = TRUE)[]
names(coef.sort) <- c("Variable", "Estimate","SE","tval","pval")
coef.sort <- arrange(coef.sort, pval)
head(coef.sort, n = 20)

# Health, Asthma, Age, Race, Dentist, Employment, MedA, Marital, Education, SexIdent

glm.pred <- predict(obesity.glm, obesity.data, type="response")

N = nrow(obesity.data)
K = 10
set.seed(1234)
s = sample(1:K, size=N, replace=T)
pred.outputs.glm <- vector(mode="numeric", length=N)
pred.outputs.rf <- vector(mode="numeric", length=N)
obs.outputs <- vector(mode="numeric", length=N)
offset <- 0
for(i in 1:K){
    train <- filter(obesity.data, s != i)
    test <- filter(obesity.data, s == i)
    obs.outputs[1:length(s[s==i]) + offset] <- test$Obesity
    
    #GLM train/test
    glm <- glm(Obesity ~ Health + Asthma + Age + Race + Dentist + Employment + MedA + Marital + Education + SexIdent, data=train, family=binomial(logit))
    glm.pred.curr <- predict(glm, test, type="response")
    pred.outputs.glm[1:length(s[s==i]) + offset] <- glm.pred.curr

    #RF train/test
    rf <- randomForest(Obesity ~ Age + Income + Health + County + Education + Marital + Kids + Adults + Race + Employment, data=train, ntree=100)
    rf.pred.curr <- predict(rf, newdata=test, type="prob") 
    pred.outputs.rf[1:length(s[s==i]) + offset] <- rf.pred.curr[,2]

    offset <- offset + length(s[s==i])
}

roc(obesity.data$Obesity, glm.pred, ci = TRUE)
roc(obs.outputs, pred.outputs.glm, ci = TRUE)

roc(obesity.data$Obesity, rf.pred[,1], ci = TRUE)
roc(obs.outputs, pred.outputs.rf, ci = TRUE)

plot.roc(obesity.data$Obesity, glm.pred, col = "coral")
plot.roc(obs.outputs, pred.outputs.glm, col = "deepskyblue", add = TRUE)
plot.roc(obesity.data$Obesity, rf.pred[,1], col="darkorchid", add = TRUE)
plot.roc(obs.outputs, pred.outputs.rf, col="mediumseagreen", add=TRUE)
legend("bottomright", 
       legend=c("GLM Training", "GLM Cross-Validation", "RF Training", "RF Cross-Validation"),
       col=c("coral", "deepskyblue", "darkorchid", "mediumseagreen"), lwd=1)
```

