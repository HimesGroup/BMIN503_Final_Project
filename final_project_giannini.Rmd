---
title: "BMIN503/EPID600 FINAL PROJECT: Analysis of Clinical and Proteomic associated with Biomarker-Based ARDS Subphenotypes"
author: "Heather Giannini"
output: 
  html_document:
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(width = 400)
```  
***
### Overview
Acute respiratory distress syndrome (ARDS) is a high morbid condition of respiratory failure, resulting from a myriad of insults, including infection (most notably recently, COVID19), trauma, and other underlying etiologies. We are investigating a recently described parsimonious model for identifying subphenotypes in this disease, as ARDS patients can be highly divergent clinically, and yet we do not have a clear understanding of the biological basis for vastly different outcomes and clinical trajectories. This project will compare the results of applying two similar but slightly different biomarker-based algorithms. We will investigate clinical features and outcomes and test for protein associations.
This work was done in consultation with Dr. Nuala Meyer and Dr. Pratik Sinha, both Pulmonary and Critical Care and Dr. John Reilly.

three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

Final Project GitHub Repository: <https://github.com/gianninh/BMIN503_Final_Project>

### Introduction 
Acute respiratory distress syndrome (ARDS) is a devastating pulmonary condition with high patient-level variability that has extremely high mortality and long-term morbidity in survivors. In clinical trials and observational studies for ARDS, two clinical subphenotypes - distinguished by plasma levels of inflammatory proteins and correlating with 30-d mortality - have been consistently identified by latent class analysis (LCA). These two classes are termed “Hyperinflammatory” and “Hypoinflammatory”. These phenotypes demonstrate heterogeneous treatment response to multiple ARDS therapies. Although iterations of parsimonious models for assigning these LCA classes based on biomarker combinations have similar operating characteristics, their agreement at the patient level has not been directly compared. We hypothesized that the performance of these models may vary in the context of clinical factors that disproportionately affect expression of the plasma proteins used for subphenoytype assignment

This project will evaluate these biomarker-based Parsimonious Models for ARDS subphenotypes. We will apply the models to our ARDS cohort, a subcohort of the Molecular Epidemiology of Sepsis in the ICU (MESSI) sepsis cohort. We will then test associations of these class assignments with various clinical characteristics, including medical comorbidities, biomarker protein levels, laboratory values (ie. white blood cell count). Importantly, we will compare the assignments of two different models, which may vary based on the biomarker used, either IL6 or IL8, two similar cytokines that are typically congruent but may be proportionally different in certain clinical circumstances.


### Methods
471 critically ill patients with ARDS were enrolled in the study within 24 hours of admission to the intensive care unit. Laboratory values and clinical features were extracted from the EHR and input into a redcap data repository. ARDS was defined per Berlin criteria. Protein biomarkers (IL6, IL8, soluble TNFr1) were measured with electrochemiluminescence and bicarbonate level was pulled from study day 0 available in the electronic health record.

Our collaborators at UCSF (authors of the paper described below) recieved the above data and applied two of the parsimonious algorithms described for assignment of subphenotypes Hyperinflammatory and Hypoinflammatory. The model probabilities were such that >0.5 would assign Hyperinflammatory. The features required for subphenotype assignment, according to these 
<https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7543720/>
Development and Validation of Parsimonious Algorithms to Classify ARDS Phenotypes: Secondary Analyses of Randomised Controlled Trials

We subsequently had assignments for two biomarker-based classifiers, and pursued a comparison of the results to assess both reliability and precision of assignment.

```{r, echo=F}
# load necessary libraries
library(tidyverse)
library(visdat)
library(naniar)
library(readr)
library(haven)
library(gtsummary)
library(readxl)
library(pheatmap)
library(Hmisc)
library(kableExtra)
library(summarytools)
library(cowplot)
library(dlookr)
library(ggpubr)
library(rstatix)
library(knitr)
```
## Comparing the IL6- and IL8- Model Assignments

First, we will look at descriptive characteristics of the IL6 and
IL8-based models for distribution of probabilities and IL6/IL8 levels.
Here we will also calculate an IL6:IL8 ratio, and test the association
of this ratio (continuous variable) with the categorical assignments.

```{r}
## Comparing Performance of IL6 vs IL8 models
# read in results from both models
il6mod <- read_excel("~/R_Projects/MESSI_Gene_Exp/ards pars model/ards_model2_calc_done.xlsx")
il8mod <- read_excel("~/R_Projects/MESSI_Gene_Exp/ards pars model/ards_model3_calc_done.xlsx")

# remove bicarb/sTNFR1 so they aren't dupiclicated in the join
il8mod <- il8mod %>% select(-Bicarbonate, -sTNFR1)

#il6prob <- il6mod %>% select(IL6, Probability, Class)
#il8prob <- il8mod %>% select(IL8, Probability, Class)

# combine the model 2 and model 3 data
mod_join <- left_join(il6mod, il8mod, by="messi_id")
mod_join <- mod_join %>% select(-Model.x, -Model.y) %>%
  rename("IL6_Model"=Class.x, "IL8_Model"=Class.y) %>%
  rename("IL6_Probability"=Probability.x, "IL8_Probability"=Probability.y) %>%
  mutate("IL6:IL8"=IL6/IL8)

mod_join %>% 
  select(IL6_Model, IL8_Model, IL6_Probability, IL8_Probability, IL6, IL8)%>% 
  tbl_summary(by=IL6_Model)%>%
  modify_caption("by IL6 Model Class Assignments")
```

## Evaluating discordance in Model Probabilities
We will use a heatmap representing the probabilities for each
model to demonstrate that while the models tend to agree most of the time,
there are some samples which clearly diverge depending on IL6 vs IL8
analyte.

```{r}
mat <- mod_join %>% select(IL6_Probability, IL8_Probability)
mat <- as.matrix(mat)
pheatmap(mat, cluster_cols = F)
```

We can see there is a group of patients at the top which were low
Probability in IL6, but clearly very high in IL8. and a group in the
middle which were low IL8, but high IL6.

## Cohort that demonstrates class switching

There are 98 patients that switch classes between IL6- and IL8-based
models.

```{r}
# now make a new variables coding the dual-class assignments to evaluate groups
mod_join <- mod_join %>% 
  mutate(a = case_when(IL6_Probability >= 0.5 ~ "hyperIL6", IL6_Probability <= 0.5 ~ "hypoIL6"))%>% 
  mutate(b = case_when(IL8_Probability >= 0.5 ~ "hyperIL8", IL8_Probability <= 0.5 ~ "hypoIL8"))%>%
  unite("combined_models", a:b, remove = TRUE)

mod_join %>% select(-messi_id, -IL6_Model, -IL8_Model) %>% 
  tbl_summary(by="combined_models") %>%
  modify_caption("Both Model Assignments")

p1 <- ggplot(mod_join, aes(x=combined_models, y=IL6_Probability)) + geom_boxplot() + theme_bw()
p2 <- ggplot(mod_join, aes(x=combined_models, y=IL8_Probability)) + geom_boxplot() + theme_bw()
plot_grid(p1,p2)
```
It does appear that the probabilities - particularly for IL6 Model - are
less extreme, from 0.88 - 0.68 for Hyper and 0.05 - 0.22 for Hypo. IL8
probabilities mellow a bit as well, but maybe not as much.

The more interesting thing here is that the IL8 values are **higher** in
the hypoinflammatory group per IL6 model, which is likely why the IL8
Model tends to put them in hyperinflamm.

**So who are these patients who have relatively higher IL8, despite a
lower IL6 value?**

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
