---
title: "Sociodemographic Disparities in Pediatric Emergency Department Revisit Rates"
subtitle: "BMIN503/EPID600 Final Project"
author: "Casey E. Pitts"
format: 
  html:
    theme: flatly
    fontsize: smaller
    code-overflow: wrap
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

## Overview {#sec-overview}

**Area of Interest:\
**Are there sociodemographic disparities in the rate of pediatric emergency room short-term revisits (re-presenting to the ED within 72 hours)?

**Mentors:**\
Joseph Zorc, MD, MSCE. Professor of Pediatrics, Mark Fishman Endowed Chair in Genomics and Computational Science, and Director of Emergency Information Systems. Division of Emergency Medicine, Department of Pediatrics, Children's Hospital of Philadelphia.

-   Reviewed key factors of interest, including demographics, language proficiency, acuity, admission status, as well as clearly defining the "revisit" variable

Brandon C. Ku, MD. Associate Professor of Pediatrics, Associate Medical Director of Clinical Pathways Program, and Associate Director of Quality Improvement. Divison of Emergency Medicine, Department of Pediatrics, Children's Hospital of Philadelphia.

-   Discussed primary and secondary outcome measures of the project as well as the optimal visualizations of the variables of interest.

## Introduction {#sec-introduction}

Pediatric emergency care (PEC) is a complex and fast-paced environment that treats patients across the healthcare and socio-demographic spectrums. Recently, there has been increasing focus on overall care quality and disparities in PEC. Disparities are known to exist in timely pain management by patient race and that those with non-English language proficiency have an increased risk of adverse medical events. Revisits, or returning to the emergency department within 72 hours, are an important marker of care quality and performance indicator of a department. While patients represent to the emergency room following a visit for various reasons, including progression of disease or repeat medication administration, it may signal incomplete ED care or insufficient anticipatory guidance. Revisits are also associated with increased healthcare costs, over-crowding and system stress, and decreased satisfaction of both families and staff.

Understanding the disparities associated with increased revisit rates and discovering modifiable factors is needed to offer solutions. This study will examine the association of sociodemographic and visit-specific factors that are associated with revisits that result either in a repeat discharge or hospitalization.

## Methods {#sec-methods}

This is a retrospective study of patients, between 0-18 years old, presenting to a urban, tertiary, academic pediatric emergency department between November 01, 2021 to November 01, 2023. We calculated rates of 72 hour revisits resulting in repeat discharge or hospital admission. Both patient and visit-level factors were included for exploratory analysis. Visit-level factors include daily volume, daily average acuity, daily average wait time, and ED location. Patient-level factors include age, sex, race, ethnicity, preferred language, individual triage acuity, history of complex medical conditions, chief complaint, insurance status, COI, distance from the ED, and green space access.

Data was accessed through the institutional data warehouse, extracted from patient and encounter-level tables and downloaded as a CSV file.

### Install Packages

```{r}
#| eval: FALSE
install.packages("tidyverse")
install.packages("expss")
install.packages("tidymodels")
install.packages("ggplot2")
install.packages("cowplot")
install.packages("lubridate")
install.packages("gtsummary")
install.packages("dplyr")
install.packages("paletteer")
install.packages("ggthemes")
install.packages("pROC")
```

### Load Packages

```{r}
#| include: false
library(tidyverse)
library(expss)
library(tidymodels)
library(ggplot2)
library(lubridate)
library(gtsummary) 
library(cowplot) 
library(dplyr)
library(gifski)
library(paletteer)
library(ggthemes)
library(pROC)
```

### Read in & Clean the Data

```{r}
#Read in CSV File
data<- read.csv("./EDRevisits.csv")

#Convert data types as needed
data[data=='']<-NA
data$ENCOUNTER_DATE <- mdy(data$ENCOUNTER_DATE)
data$WAITTIME<- period_to_seconds(hms(data$WAITTIME))
data$ARRIVALTIME<- lubridate::hms(data$ARRIVALTIME)
data$DAILYVISITS<- as.numeric(as.integer(data$DAILYVISITS))

#Convert Wait Time from HMS to Minutes
data<- data|>
  mutate(waitmin = WAITTIME/60)
```

#### Additional Cleaning

```{r}
#Race/Ethnicity Category Collapse & Factor
data<- data|> 
  mutate (eth_cat = (case_when(
    str_detect(RACE_ETHNICITY, "White") ~ "White",
    str_detect(RACE_ETHNICITY, "Black") ~ "Black",
    str_detect(RACE_ETHNICITY, "Asian") ~ "Other",
    str_detect(RACE_ETHNICITY, "Latino") ~ "Hispanic/Latino",
    str_detect(RACE_ETHNICITY, "Multi") ~ "Other",
    str_detect(RACE_ETHNICITY, "Other") ~ "Other",
    str_detect(RACE_ETHNICITY, "Native") ~ "Other",
    str_detect(RACE_ETHNICITY, "nknown") ~ "Other",
    str_detect(RACE_ETHNICITY, "Refused") ~ "Other",
    str_detect(RACE_ETHNICITY, "disclose") ~ "Other",
      )))|>
  mutate (eth_cat = factor(eth_cat, levels = c("White", "Black", "Hispanic/Latino", "Other"), labels = c("White", "Black", "Hispanic/Latino", "Other")))

#Convert ED Volume to Categorical
data<- data |>
  mutate (volume = case_when(
    CAMPUS == "Main" & DAILYVISITS <=244 ~ "Low",
    CAMPUS == "Main" & DAILYVISITS <=277 ~ "Medium-Low",
    CAMPUS == "Main" & DAILYVISITS <=307 ~ "Medium-High",
    CAMPUS == "Main" & DAILYVISITS >307 ~ "High",
    CAMPUS == "Community" & DAILYVISITS <=90 ~ "Low",
    CAMPUS == "Community" & DAILYVISITS <=103 ~ "Medium-Low",
    CAMPUS == "Community" & DAILYVISITS <=114 ~ "Medium-High",
    CAMPUS == "Community" & DAILYVISITS >296 ~ "High"))

#Collapse Arrival Times to 3 Categories
data<- data |>
  mutate (Arrival = case_when(
    hour(ARRIVALTIME) >= 23 ~ "Overnight",
    hour(ARRIVALTIME) >= 15 ~"Evening",
    hour(ARRIVALTIME) >=7 ~ "Daytime",
    hour(ARRIVALTIME) < 7 ~ "Overnight"
  ))

#Age to Dichotomous
data<- data |>
  mutate (age_cat = case_when(
    AGE_AT_VISIT < 1 ~ "Infant",
    AGE_AT_VISIT >=1 ~ "Child/Teen"))

#ED Disposition to Dichotomous
data<- data |>
  mutate (ED_DISPOSITION = case_when(
    str_detect(ED_DISPOSITION, "Discharge") ~ "Discharge",
    str_detect(ED_DISPOSITION, "AMA") ~ "AMA/Eloped",
    str_detect(ED_DISPOSITION, "Left Before Discharge (Eloped)") ~ "AMA/Eloped"))

#Acuity to Dichotomous
data<- data |>
  mutate (esigp = case_when(
    ACUITY >= 1 & ACUITY <= 3  ~ "Acute",
    ACUITY >=4 & ACUITY <= 5 ~ "Non-Urgent"))

#Factor
data<- data |>
  mutate(REVISIT_72_HR = factor(REVISIT_72_HR, levels = c(0,1), 
                                labels = c("No Revisit", "Revisit")))|>
  mutate(LANGIND = factor(LANGIND, levels = c(1,0),
                          labels = c("English","Other")))|>
  mutate(PCP_VISIT_72_HR = factor(PCP_VISIT_72_HR, levels = c(0,1), 
                            labels = c("No PCP Visit", "PCP Visit"))) |>
  mutate(READMIT_72_HR = factor(READMIT_72_HR, levels = c(0, 1),
                         labels = c("Re-discharged", "Admitted"))) |>
  mutate(SEX = factor(SEX, levels = c("M", "F"), 
                      labels = c("Male", "Female"))) |>
  mutate(COMPLEX_CHRONIC_CONDITION_IND = factor(COMPLEX_CHRONIC_CONDITION_IND,
                      levels = c(0,1),
                      labels = c("None", "Chronic/Complex"))) |>
  mutate(ACUITY = factor(ACUITY)) |>
  mutate(ED_DISPOSITION = factor(ED_DISPOSITION, levels = c("Discharge", "AMA/Eloped"), labels = c("Discharge", "AMA/Eloped")))|>
  mutate(CAMPUS = factor(CAMPUS, levels = c("Main", "Community"), 
                         labels = c("Main", "Community")))|>
  mutate(age_cat = factor(age_cat))|>
  mutate(Arrival = factor(Arrival))|>
  mutate(PAYOR_GROUP = factor(PAYOR_GROUP, levels = c("COMMERCIAL", "GOVERNMENT", "CHARITY CARE", "SELF PAY"),
                              labels = c("Commercial", "Government", "Charity Care", "Self Pay")))|>
  mutate(SVI_CATEGORY = factor(SVI_CATEGORY))|>
  mutate(esigp = factor(esigp))|>
  mutate(volume = factor(volume))

#Rename Columns
data <- data|>
  apply_labels(
          ENCOUNTER_DATE = "Date",
          SEX = "Sex",
          DAILYVISITS = "Total Daily Visits",
          AVGESI = "Average Daily Acuity",
          WAITTIME = "Average Daily Wait Time",
          AGE_AT_VISIT = "Age",
          RACE_ETHNICITY = "Race & Ethnicity",
          LANGIND = "Language",
          PAYOR_GROUP = "Insurance Type",
          SVI_CATEGORY = "Vulnerability Score",
          PATIENT_ADDRESS_ZIP_CODE = "Zip Code",
          ED_LOS = "Length of Stay",
          REVISIT_72_HR = "Revisit within 72 Hours",
          READMIT_72_HR = "Admission within 72 Hours",
          COMPLEX_CHRONIC_CONDITION_IND = "Complex or Chronic History",
          ED_DISPOSITION = "Disposition from ED",
          PCP_VISIT_72_HR = "PCP Visit within 72 Hours",
          eth_cat = "Race/Ethnicity",
          CAMPUS = "Campus",
          waitmin = "Average Daily Wait Time (in minutes)",
          ACUITY = "Acuity",
          age_cat = "Age (Categorical)",
          esigp = "Acuity (Dichotomized)",
          volume = "ED Volume (Categorical)"
          )
```

## Results {#sec-results}

### Summary Statistics

```{r}
#Overall Emergency Department Summary
tbl_summary(data, include = c(DAILYVISITS, AVGESI, waitmin),
      statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    ),
            by = CAMPUS,
    missing = "no")|>
  modify_caption ("**Table 1: Emergency Department Characteristics**") |>
  modify_header (label = "") |>
  bold_labels()

#Plot Average Daily Volume by Month 
VisitsbyMonth <- data |>
  group_by(CAMPUS, Year = as.character(year(ENCOUNTER_DATE)), month = month(ENCOUNTER_DATE, label = TRUE)) |>
      summarise(avg = mean(DAILYVISITS))

ggplot(VisitsbyMonth, aes(x =month, y = avg, color = Year)) +
  geom_line(aes(group = Year)) +
  geom_point(size = 3) +
  facet_grid(~CAMPUS) +
  theme_few() +
  ggtitle("Daily Volume by Month") +
  theme(plot.title =element_text(face = "bold"),
        strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x  = element_text(angle=90, vjust=0.8)) +
  labs(x = "Month", y = "Daily Visit Count") +
  scale_color_paletteer_d("futurevisions::jupiter")

#Plot Average Wait Time by Month 
WaitbyMonth <- data |>
  group_by(CAMPUS, Year = as.character(year(ENCOUNTER_DATE)), month = month(ENCOUNTER_DATE, label = TRUE)) |>
      summarise(avg = mean(waitmin))

ggplot(WaitbyMonth, aes(x =month, y = avg, color = Year)) +
  geom_line(aes(group = Year)) +
  geom_point(size = 3) +
  facet_grid(~CAMPUS) +
  theme_few() +
  ggtitle("Average Daily Wait Time by Month") +
  theme(plot.title =element_text(face = "bold"),
        strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x  = element_text(angle=90, vjust=0.8)) +
  labs(x = "Month", y = "Avg Daily Wait Time") +
  scale_color_paletteer_d("futurevisions::jupiter")

#Plot Average Daily Acuity by Month
AcuitybyMonth <- data |>
  group_by(CAMPUS, Year = as.character(year(ENCOUNTER_DATE)), month = month(ENCOUNTER_DATE, label = TRUE)) |>
      summarise(avg = mean(AVGESI))

ggplot(AcuitybyMonth, aes(x =month, y = avg, color = Year)) +
  geom_line(aes(group = Year)) +
  geom_point(size = 3) +
  facet_grid(~CAMPUS) +
  theme_few() +
  ggtitle("Average Daily Acuity by Month") +
  theme(plot.title =element_text(face = "bold"),
        strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x  = element_text(angle=90, vjust=0.8)) +
  theme(plot.title =element_text(face = "bold"))+
  labs(x = "Month", y = "Avg Daily Acuity") +
  ylim (low = 2.5, high = 3.5)+
  scale_color_paletteer_d("futurevisions::jupiter")
```

```{r}
#Descriptive Statistics
data|>
  select(SEX, AGE_AT_VISIT, eth_cat, LANGIND, PAYOR_GROUP, SVI_CATEGORY, ACUITY, COMPLEX_CHRONIC_CONDITION_IND, CAMPUS, ED_LOS, Arrival, ED_DISPOSITION, READMIT_72_HR, REVISIT_72_HR)|>
  tbl_strata2(
    strata = CAMPUS,
    .tbl_fun = 
    ~.x |>
tbl_summary(missing_text = "NA",
            by = REVISIT_72_HR,
            missing = "no") |>
  modify_caption ("**Table 2: Patient Characteristics**") |>
  modify_header (label = "**Variable**") |>
  bold_labels()
)
```

```{r}
# Sex
sexplot <- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = SEX)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Sex")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
  theme(plot.title =element_text(face = "bold"),
        #strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=8), 
        axis.title.x = element_text(size=8),
       legend.title = element_blank(),
        legend.text = element_text(size=8),
        axis.title.y = element_text(size=10))

# Language
langplot <- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = factor(LANGIND))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Language")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
  theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))


# Insurance
insuranceplot<- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = PAYOR_GROUP)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Insurance")+
  scale_color_paletteer_d("futurevisions::jupiter")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
        #strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))

# Acuity (Categorical)
acuityplot<- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = factor(ACUITY))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Acuity")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
        #strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))+
  scale_fill_paletteer_d("futurevisions::jupiter")

#Acuity(Dichotomous)
esigpplot<- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = factor(esigp))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Acuity")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))

# Vulnerability Status
sviplot<- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = SVI_CATEGORY)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Vulnerability Status")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))+
  scale_fill_paletteer_d("futurevisions::jupiter")


# Race/Ethnicity
ethnicityplot <- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = eth_cat)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Ethnicity")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))+
  scale_fill_paletteer_d("futurevisions::jupiter")

# Chronic Conditions
chronicplot <- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = factor(COMPLEX_CHRONIC_CONDITION_IND))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Chronic/Complex History")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))

# PCP Visit within 72 Hours
pcpplot <- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = factor(PCP_VISIT_72_HR))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "PCP Visit Within 72 Hours")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))

# Age 
ageplot <- ggplot(data, aes(x = factor(REVISIT_72_HR),y = AGE_AT_VISIT, fill = REVISIT_72_HR)) +
  geom_boxplot() +
  facet_wrap(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  labs(title = "Age") +
  ylab("Years")+
  xlab("")+
  theme_minimal()+
  theme( legend.title = element_blank())

# Age (Dichotomous)
agecatplot <- ggplot(data, aes(x = factor(REVISIT_72_HR), fill = factor(age_cat))) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "Infant vs Child/Teen")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))

#ED Disposition
dispoplot <- ggplot(data, aes(x = REVISIT_72_HR, fill = ED_DISPOSITION)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percentage")+
  xlab("")+
  labs(title = "ED Disposition")+
  theme_minimal()+
  facet_grid(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
       # strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  theme(axis.text.x = element_text(size=6), 
        axis.title.x = element_text(size=10),
        legend.title = element_blank(),
        legend.text = element_text(size=4),
        axis.title.y = element_text(size=10))

# LOS
LOSplot <- ggplot(data, aes(factor(REVISIT_72_HR), ED_LOS)) +
  geom_boxplot() +
  facet_wrap(~CAMPUS) +
    theme(plot.title =element_text(face = "bold"),
        #strip.text.x = element_text(size = 14),
        panel.grid = element_line(color = "lightgrey",linetype = "dotted"))+
  labs(title = "Length of Stay") +
  ylab("Minutes")+
  xlab("")+
  theme_minimal()+
  theme(legend.title = element_blank())


# Summary Graphs 1: Demographics between group comparison
ggdraw() +
  draw_plot(sexplot, x=0, y=0.5, width = 0.5, height = 0.5)+
  draw_plot(ageplot, x=0.5, y=0.5, width = 0.5, height = 0.5)+
  draw_plot(langplot, x=0, y=0, width = 0.5, height = 0.5)+
  draw_plot(ethnicityplot, x=0.5, y=0, width = 0.5, height = 0.5)+
  theme_minimal()

ggdraw() +
  draw_plot(acuityplot, x=0, y=0.5, width = 0.5, height = 0.5)+
  draw_plot(esigpplot, x=0.5, y=0.5, width = 0.5, height = 0.5)+
  draw_plot(sviplot, x=0, y=0, width = 0.5, height = 0.5)+
  draw_plot(agecatplot, x=0.5, y=0, width = 0.5, height = 0.5)+
  theme_minimal()

ggdraw() +
  draw_plot(dispoplot, x=0, y=0.5, width = 0.5, height = 0.5)+
  draw_plot(LOSplot, x=0.5, y=0.5, width = 0.5, height = 0.5)+
  draw_plot(chronicplot, x=0, y=0, width = 0.5, height = 0.5)+
  draw_plot(pcpplot, x=0.5, y=0, width = 0.5, height = 0.5)+
  theme_minimal()
```

### Preliminary Analysis

*Categorical/Continuous Variables*

Race/Ethnicity (p\<.001)\
Insurance type (p\<.0012)\
Vulnerability Status (p\<.001)\
Acuity (p\<.001)\
Arrival time (categorical) (p\<.001)

*Dichotomous Variables*

Age (p\<.001)\
Acuity (Dichotomous) (p\<.001)\
Complex Condition (p\<.001)\
PCP within 72 Hours (p\<.001)\
Campus (p\<.001)\
Disposition type (p\<.001)

```{r}
#Categorical/Continuous Variables
#Race/Ethnicity:
chisq.test(table(data$REVISIT_72_HR, data$eth_cat))
#Language
chisq.test(table(data$REVISIT_72_HR, data$LANGIND))
#Insurance
chisq.test(table(data$REVISIT_72_HR, data$PAYOR_GROUP)) 
#Vulnerability
chisq.test(table(data$REVISIT_72_HR, data$SVI_CATEGORY)) 
#Acuity (Categorical)
chisq.test(table(data$REVISIT_72_HR, data$ACUITY))
#Arrival
chisq.test(table(data$REVISIT_72_HR, data$Arrival))
#ED Volume
chisq.test(table(data$REVISIT_72_HR, data$volume))


#Dichtomous Variables
#Sex: *Dichotomous for ease of analysis and 2/2 lack of reliable gender identity data
chisq.test(table(data$REVISIT_72_HR, data$SEX))
#Age(Dichotomous)
chisq.test(table(data$REVISIT_72_HR, data$age_cat))
#Acuity (Dichotomous)
chisq.test(table(data$REVISIT_72_HR, data$esigp))
#Complex/Chronic
chisq.test(table(data$REVISIT_72_HR, data$COMPLEX_CHRONIC_CONDITION_IND))
#PCP Visit
chisq.test(table(data$REVISIT_72_HR, data$PCP_VISIT_72_HR)) 
#Campus
chisq.test(table(data$REVISIT_72_HR, data$CAMPUS))
#ED Disposition
chisq.test(table(data$REVISIT_72_HR, data$ED_DISPOSITION))
```

#### Univariable Logistic Regression

*Categorical/Continuous*

Age (Continuous) (p\<.001)\
Length of Stay (p\<.001)\
Race/Ethnicity: Black (p\<.001)\
Insurance: Commercial (p\<.05)\
Insurance: Self-Pay (p\<.001)\
Vulnerability Scale: Lowest (p\<.001)\
Vulnerability Scale: Medium-Low (p\<.001)\
Vulnerability Scale: Medium-High (p\<.01)\
Arrival: Overnight (p\<.001)

*Dichotomous Variables*

Age: Infant (p\<.001)\
Acuity: Non-Urgent (p\<.001)\
Chronic/Complex (p\<.001)\
PCP Visit w/in 72hrs (p\<.001)\
ED Disposition: AMA/Eloped (p\<.001)\
Campus: Community (p\<.001)

```{r}
#Categorical/Continuous Variables
#Age (Continuous)
summary((glm(REVISIT_72_HR ~ AGE_AT_VISIT, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ AGE_AT_VISIT, data = data, family = binomial()))) 
#Length of Stay (Continuous)
summary((glm(REVISIT_72_HR ~ ED_LOS, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ ED_LOS, data = data, family = binomial()))) 
#Race:
summary((glm(REVISIT_72_HR ~ eth_cat, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ eth_cat, data = data, family = binomial()))) 
#Insurance
summary((glm(REVISIT_72_HR ~ PAYOR_GROUP, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ PAYOR_GROUP, data = data, family = binomial()))) 
#Vulnerability
summary((glm(REVISIT_72_HR ~ SVI_CATEGORY, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ SVI_CATEGORY, data = data, family = binomial())))  
#Acuity (categorical)
summary((glm(REVISIT_72_HR ~ ACUITY, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ ACUITY, data = data, family = binomial()))) 
#Arrival
summary((glm(REVISIT_72_HR ~ Arrival, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ Arrival, data = data, family = binomial()))) 
#Volume
summary((glm(REVISIT_72_HR ~ volume, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ volume, data = data, family = binomial()))) 

#Dichtomous Variables

#Sex: *Dichotomous for ease of analysis and 2/2 lack of reliable gender identity data
summary((glm(REVISIT_72_HR ~ SEX, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ SEX, data = data, family = binomial()))) 
#Age(Dichotomous)
summary((glm(REVISIT_72_HR ~ age_cat, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ age_cat, data = data, family = binomial())))
#Acuity(Dichotomous)
summary((glm(REVISIT_72_HR ~ esigp, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ esigp, data = data, family = binomial())))
#Language
summary((glm(REVISIT_72_HR ~ LANGIND, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ LANGIND, data = data, family = binomial()))) 
#Complex/Chronic
summary((glm(REVISIT_72_HR ~ COMPLEX_CHRONIC_CONDITION_IND, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ COMPLEX_CHRONIC_CONDITION_IND, data = data, family = binomial()))) 
#PCP Visit
summary((glm(REVISIT_72_HR ~ PCP_VISIT_72_HR, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ PCP_VISIT_72_HR, data = data, family = binomial())))
#ED Disposition
summary((glm(REVISIT_72_HR ~ ED_DISPOSITION, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ ED_DISPOSITION, data = data, family = binomial())))
#Campus
summary((glm(REVISIT_72_HR ~ CAMPUS, data = data, family = binomial())))
exp(coef(glm(REVISIT_72_HR ~ CAMPUS, data = data, family = binomial()))) 

```

```{r}
m1 <- glm(REVISIT_72_HR ~ SEX + age_cat + eth_cat + LANGIND + ED_LOS + PAYOR_GROUP + SVI_CATEGORY + esigp + COMPLEX_CHRONIC_CONDITION_IND + Arrival + ED_DISPOSITION + CAMPUS + PCP_VISIT_72_HR + volume, data = data, family = binomial())
```

```{r}
t3 <- tbl_regression(m1, exponentiate = TRUE) %>%
  bold_p(t = 0.05) %>%
  bold_labels() %>%
  italicize_levels()
t3
```

```{r}
glm.pred <- predict(m1, data, type = "response")
head(glm.pred)
```

```{r}
#K Fold Cross Validation
N = nrow(data)
K = 10
set.seed(1234)
s = sample(1:K, size = N, replace = T)
pred.outputs.glm <- vector(mode = "numeric", length = N)
obs.outputs <- vector(mode = "numeric", length = N)
offset<- 0 

for (i in 1:K){
  train <- filter(data, s != i)
  test <- filter(data, s == i)
  obs.outputs[1:length(s[s == i]) + offset] <- test$REVISIT_72_HR
  
  # GLM train/test
  glm <- glm(REVISIT_72_HR ~ SEX + age_cat + eth_cat + LANGIND + ED_LOS + PAYOR_GROUP + SVI_CATEGORY + esigp + COMPLEX_CHRONIC_CONDITION_IND + Arrival + ED_DISPOSITION + CAMPUS + PCP_VISIT_72_HR + volume, data = data, family = binomial(logit))
  glm.pred.curr <- predict(glm, test, type = "response")
  pred.outputs.glm[1:length(s[s == i]) + offset] <- glm.pred.curr
  
  offset <- offset + length(s[s == i])
}
head(cbind(pred.outputs.glm, obs.outputs))
```

```{r}
roc(data$REVISIT_72_HR, glm.pred, ci = TRUE)

plot.roc(data$REVISIT_72_HR, glm.pred, percent = TRUE, col = "purple", print.auc= TRUE, ci = TRUE) #graph that corresponds to that 

plot.roc(obs.outputs, pred.outputs.glm, percent = TRUE, print.auc = TRUE, print.auc.y = 40, ci = TRUE, col = "forestgreen", add = TRUE) #observed data. cross validation curve is almost the same
```

## Conclusion

*End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required. This the conclusion. The @sec-results can be invoked if you'd like.*
