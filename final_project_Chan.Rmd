---
title: "Combining aggregate food and housing costs with individual factors for BRFSS Health Outcomes"
author: "Alexander Chan"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)

```  


### Overview
  This project aims at identifying predictors of health outcomes using socioeconomic factors. Specifically, income, housing costs, food security, and food costs will be tested for association with surveyed outocmes from Behavioral Risk Factor Surveillance System (BRFSS) epidemiologic data. BRFSS data is tracked at the metropolitan level, and SMART BRFSS 2017 data was downloaded as XPT file [here](https://www.cdc.gov/brfss/smart/Smart_data.htm) 
  Measures of mental and physical health will be analyzed using secondary data from the American Community Survey (ACS), Housing Urban Development (HUD) fair market rent (fmr) data, Feeding America dataset. The main faculty for this project is Blanca Himes who gave project advice and provided a reference paper (Leszinsky et al.) and Sherry Xie, who assisted with geospatial plotting and formatting.  

### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

  Wealth inequality has been increasing in the United States for several decades. One estimate by Congressional Budget Office (CBO) estimates a 20% increase in income inequality between 1980-2016. This is seen as increased wealth accumulation for the high-earning Americans (top 1%) who have seen their share of aggregate income increase by nearly 20% as middle-class americans saw a decreased share. Despite a steady increase in the Gross Domestic Product (GDP), real median income has not risen at a similar rate. This suggests that increased productivity in the United States has not led to increased earnings for most Americans over the past four decades. 
  In addition to wage stagnation, the cost of living in the Country has risen as well. For most people, the largest share of expenses is taken by housing costs, accounting for 30-40% of an average American's monthly budget. According to the Center on Budget and Policy Priorities (CBPP), median rents across the nation have risen by 13% between 2001-2008, far outpacing median household income growth. Thus, on average, a larger proportion of American incomes are being spent on necessities.
  Associations between income and health have been intensly studied across many economic, social policy, and epidmiologic fields. One [study](https://www.brookings.edu/research/money-lightens-the-load/) looked at National Health and Nutrition Examination Survey (NHANES) data which is taken from a survey conducted by the CDC. The authors investigated how survey participants responsed to questions about their general health. The study finds that those in households with high income self-reported "good heath" more frequently than those in middle to low income household. The authors also found that increased income correlates to decreased "stress load" as measured as a weighted average of 5 biomarkers associated with stress such as blood pressure and creatine levels. Overall, it is clear that an individual's economic status strongly correlates to health outcomes. High income individuals have lower stress and better general health. Chronic stressors such as food insecurity, high costs-of-living and lack of access to preventivive/primary care all contribute to health disparities by income. 
  Based on these findings, I wanted to combine individual demographics (including income) with aggregate data to better predict several health outcomes from the BRFSS. I wanted to see how median metropolitan statitics of poverty and income predict outcomes compared to invidiual income statistics and if combining the two increases predicitive power. Additionally, I wanted to include median rent data and food expense data, as these are two of the largest expenses in any given household. Thus, I would expect that health outcomes might vary depending on both income and cost-of-living as a result of increased financial insecurity. 

This project is interdisciplinary because combines economic data with health survey data. I wanted to see if BRFSS data can be combined with metro-level cost-of-living factors to better predict health outcomes compared to individual demographics alone. I will use data from multiple sources including the CDC, BLS, HUD, ACS, and Feeding America to accomplish these goals. 

### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

For exploring growth rate, I looked at change in the consumer price index (CPI) between 2018-2020 for major metropolitan areas in the United States. This data was taken from the Bureau of Labor Statistics (BLS) To look at county-level income and poverty data, I query 5-year ACS data from 2014-2018 for poverty rate and median income. I also collected HUD fmr rate for the past from 2017-2020. Finally I use the  "Map the Gap" calculated county-level meal cost from the non-profit Feeding America to estimate food expense. This cost-of-food index is calculated by applying county-level sales tax rates to Nielsen basket-of-goods based on actual pounds purchased. This "meal cost" value was last calculated in 2010 by Feeding America. Necessary corrections to nominal housing costs for inflation were corrected using CPI values from 2010-2020. BRFSS data is ta

In the first section, I explore economic factors across the country either at a metroplotian level or by county level. Using geospatioal maps, explore income, rent, and percent of rent spent on income across the country. I also looked at how the inflation rate (marker for economic growth) varies by major US cities. I also explore  county-level poverty and income rates. Finally I make some plots checking the assocition between poverty and income as well as poverty and costs-of-living (rent, food expense).

Finally, I load the 2017 BRFSS dataset and clean the dataframe. I check how aggregate factors (by Metro Area) affect health outcomes (general health, COPD history, and history of depression). I also look at how individual income alone affects these same outcomes. For these analyses I use a combination of plots and Chi-squared tests to check for independence. I create a logistic regression model combining BRFSS demographic factors (age, sex, race, income) to predict these outcomes. Finally, I add aggregate "cost-of-living" data to this logistic regression model to see if predictive power improves.


## Results

###
Download and install Rtools40 to use the BLS api: https://cran.r-project.org/bin/windows/Rtools/

### Reading and Cleaning Datasets
```{r, eval=TRUE}
# commonly-used packages
library(ggplot2)
library(dplyr)
library(magrittr)
library(tidyr)
library(gtsummary)

# tools for accessing BLS data
# install_github("mikeasilva/blsAPI", force = TRUE) # Install the blsAPI by Mike Silva
library(devtools)
library(blsAPI)
library(rjson)
library(blsAPI)
```


# Query CPI data from BLS

# The first part of this project is to do some exploratory analyses and visualizations of some key economic and cost-of-living factors in the United States across counties or by metropolitan area.First, queried CPI data between 2018-2020 from the Bureau of Labor Statistics (BLS) to show how economic growth varies by major metropolitan areas. 

```{r, eval=TRUE}
# query data from BLS.gov

# load api key (must have the txt file)
api_key <-  read.csv("bls_api_key.txt", header=FALSE)[[1]]

# signatures to be queried from BLS.gov, 10-year CPI data from major metropolitan areas
signatures <- read.csv("metro_area_cpi_signatures.csv") 

# payload signatures to query BLS 
month_payload <- list('seriesid'= signatures$signature_monthly) #2018-2020 monthly CPI 
annual_payload <- list('seriesid'= signatures$signature_annual) #2018-2020 annual CPI

# query CPI 2018-2020 data from major metropolitan areas from BLS 
months_cpi <- blsAPI(month_payload, return_data_frame = TRUE) # monthly CPI dataframe
annual_cpi <- blsAPI(annual_payload, return_data_frame = TRUE) # annual CPI dataframe
```

# This is just data-wrangling to properly pull CPI data using the BLS api package

```{r, eval=TRUE}

# add columns to join region labels by
months_cpi$signature_monthly <- months_cpi$seriesID
annual_cpi$signature_annual <- annual_cpi$seriesID

# join region and state labels to the cpi data
# complete monthly dataframe for 2018-2020 regional metro cpi data
months_cpi %<>%
  left_join(signatures[, c("signature_monthly","state","area")],by="signature_monthly") %>%
  dplyr::select(-seriesID)

# complete annual dataframe for 2018-2020 regional metro cpi data
annual_cpi %<>%
  left_join(signatures[, c("signature_annual","state","area")],by="signature_annual") %>%
  dplyr::select(-seriesID)

head(months_cpi)
head(annual_cpi)

```

# These data frames are the CPI for major US metropolitan areas by month or by year from 2018-2020 for available data. 

```{r, eval=TRUE}
# Further format dataframes
# pivot data by metro area and years, add column for mean annual CPI

# annual cpi 
a_cpi <- annual_cpi %>% 
  pivot_wider(id_cols = c("area","year"),names_from = "periodName",
              values_from = "value")%>% # pivot on area and year using values from period
  mutate_at(vars(3:4), as.numeric) %>% # change CPI values to numeric
  mutate(annual = rowMeans(select(., c("1st Half", "2nd Half")), na.rm= TRUE))# mean annual cpi

# monthly cpi
m_cpi <- months_cpi %>%
  dplyr::select(-period) %>%
  pivot_wider(id_cols = c("area","year"), names_from = "periodName", 
              values_from = "value") %>% # pivot on area and year using values from period
  mutate_at(vars(2:14), as.numeric) %>% # change CPI values to numeric
  mutate(annual = rowMeans(select(.,-c("area", "year")), na.rm = TRUE)) # mean annual cpi

head(a_cpi)
head(m_cpi)
```

# Now let's visualize economic growth in various metropolitan areas around the US. The average %CPI change (one measure of economic growth) is shown as a red dotted line (~2% from 2018-2020). We see that Growth varies by area. High-growth cities such as San Francisco are experiencing a high rate of inflation, beyond national average, suggesting a surge in costs-of-living. On the other hand of the spectrum, St. Louis, MO, Detroit, MI, and Houston, TX have slowed in in economic growth. 

```{r, eval=TRUE}
a_cpi_growth_rate <- as.data.frame(a_cpi) %>%
  dplyr::select(area, annual) %>%
  dplyr::group_by(area) %>%
  dplyr::summarise(growth = (max(annual)-min(annual))/min(annual)*100) #growth from 2018-2020

ggplot(a_cpi_growth_rate, aes(x = reorder(area, -growth), y = growth))+
  geom_col() + 
  theme(axis.text.x = element_text(angle = 90)) +
  theme(axis.title.x = element_blank())+
  geom_hline(yintercept=2.2, linetype="dashed", color = "red")+
  ylab("Growth (% CPI Change 2018-2020)")

```



### Query Fair market rent (FMR) data from HUD

# In this part of the project, I will query FMR data from the HUD. The FMR is one estimate of fair market rent for a given county. I will use this as a measure of housing costs. Althought not perfect, fmr is thorough, available for all US counties, and tracks relatively well to actual median rents in most places. 


```{r, eval=TRUE}
library(sf)
library(ggsn)
library(stringr)
library(grid)

# function to format the geo id column of FMR dataframes
format_id <- function(df){
  
  df$ID <- str_replace(as.character(df$fips2010),
                       as.character(df$CouSub),"")
  df$ID <- as.numeric(df$ID) + 50000000000
  df$ID <- paste0("0",as.character(df$ID))
  
  return(df)
}

# read in the housing costs: fair market rates (2017-2020)
# format relevent columns into a standard form
fmr_2017 <- read.csv("FY2017_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  dplyr::mutate_at(c("fmr0", "fmr1", "fmr2", "fmr3", "fmr4"), as.numeric)
fmr_2018 <- read.csv("FY2018_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  dplyr::mutate_at(c("fmr_0", "fmr_1", "fmr_2", "fmr_3", "fmr_4"), as.numeric) %>%
  dplyr::rename("CouSub" = "cousub", "fmr0" = "fmr_0","fmr1" = "fmr_1","fmr2" = "fmr_2", 
         "fmr3" = "fmr_3", "fmr4" = "fmr_4", "Metro_code" = "metro_code")
fmr_2019 <- read.csv("FY2019_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  dplyr::mutate_at(c("fmr_0", "fmr_1", "fmr_2", "fmr_3", "fmr_4"), as.numeric) %>%
  dplyr::rename("CouSub" = "cousub","fmr0" = "fmr_0","fmr1" = "fmr_1","fmr2" = "fmr_2", 
         "fmr3" = "fmr_3", "fmr4" = "fmr_4", "Metro_code" = "metro_code") 
fmr_2020 <- read.csv("FY2020_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  dplyr::mutate_at(c("fmr_0", "fmr_1", "fmr_2", "fmr_3", "fmr_4"), as.numeric) %>%
  dplyr::rename("CouSub" = "cousub", "fmr0" = "fmr_0","fmr1" = "fmr_1","fmr2" = "fmr_2", 
         "fmr3" = "fmr_3", "fmr4" = "fmr_4", "Metro_code" = "metro_code") 
fmr_2021 <- read.csv("FY2021_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  dplyr::mutate_at(c("rent50_0", "rent50_1", "rent50_2", "rent50_3", "rent50_4"),
            as.numeric) %>%
  dplyr::rename("CouSub" = "cousub", "fmr0" = "rent50_0",
         "fmr1" = "rent50_1","fmr2" = "rent50_2", 
         "fmr3" = "rent50_3", "fmr4" = "rent50_4",
         "Metro_code" = "cbsasub21", "areaname" = "areaname21",
         "countyname" = "cntyname") 

# read in shape file of US counties
counties <- readRDS(gzcon(url('https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds'))) # decompress  rds file and read in shape file
counties$GEO_ID <- as.character(counties$GEO_ID)#change geo id to characters in counties df
counties$ID <- gsub("US","", counties$GEO_ID)  #remove US from ID

# read in metro area shape file and convert into spatial components
setwd("tl_2017_us_cbsa")
cbsa.sf <- st_read("tl_2017_us_cbsa.shp")
cbsa.sf %<>%
  dplyr::select(GEOID, geometry,NAME, NAMELSAD) %>%
  dplyr::rename(ID2 = GEOID, Metro = NAMELSAD)


# function to merge FMR dataframes with county geometries 
geo_format <- function(geo_df){
  fmr_geo <- counties %>%
    dplyr::select(c("NAME", "ID", "geometry")) %>%
    left_join(geo_df[,c("ID","fmr0", "fmr1", "fmr2", "fmr3", "fmr4",
                        "Metro_code", "areaname", "countyname")], by="ID") %>%
    distinct(Metro_code, .keep_all = TRUE)
}

# function to merge FMR dataframes with metro area geometries 
geo_format2 <- function(geo_df){
  
  geo_df %<>%
    dplyr::select(ID,fmr0,fmr1,fmr2, fmr3, fmr4, Metro_code, areaname, countyname)%>%
    distinct(Metro_code, .keep_all = TRUE) %>% # removed repeated counties
    dplyr::mutate(ID2 = substr(Metro_code, 12,16)) # metro IDs
  
  fmr_geo <- cbsa.sf %>%
    dplyr::select(c("NAME", "ID2", "geometry", "Metro")) %>%
    left_join(geo_df, by="ID2") # join by metro area

}

# format geographical IDs for all FMRs 2017-20201
fmr_2017 <- format_id(fmr_2017)
fmr_2018 <- format_id(fmr_2018)
fmr_2019 <- format_id(fmr_2019)
fmr_2020 <- format_id(fmr_2020)
fmr_2021 <- format_id(fmr_2021)

# add county geographical data to all FMRs 2017-20201
fmr_2017_geo <- geo_format(fmr_2017)
fmr_2018_geo <- geo_format(fmr_2018)
fmr_2019_geo <- geo_format(fmr_2019)
fmr_2020_geo <- geo_format(fmr_2020)
fmr_2021_geo <- geo_format(fmr_2021)

# add metro area geographical data to all FMRs 2017-20201
fmr_2017_geo2 <- geo_format2(fmr_2017)
fmr_2018_geo2 <- geo_format2(fmr_2018)
fmr_2019_geo2 <- geo_format2(fmr_2019)
fmr_2020_geo2 <- geo_format2(fmr_2020)
fmr_2021_geo2 <- geo_format2(fmr_2021)


```

# To visualize housing (rent) expenses I use the sf and ggplot packages to make static chloropleth maps for median 1-bed rent costs across US counties. This is done throuh a function which takes in the year to be visualized (fmr for 2017-2020 available). Additonally, the function adjusts the fmr to 2020 $ using the CPI between that year and the CPI for 2020. As expected, housing costs are high in major coastal cities including New York, Boston, and San Fancisco. I also made a function to plot static maps of 1-bed rents for available metropolitan area data. This data is not completely catalogued like the county-level data, as it only considers major US cities.

```{r, eval=TRUE}
library(RColorBrewer)
library(leaflet)

my_theme <- function() {
  theme_minimal() +                                  # shorthand for white background color
  theme(axis.line = element_blank(),                 # further customization of theme components
        axis.text = element_blank(),                 # remove x and y axis text and labels
        axis.title = element_blank(),
        panel.grid = element_line(color = "white"),  # make grid lines invisible
        legend.key.size = unit(0.8, "cm"),           # increase size of legend
        legend.text = element_text(size = 16),       # increase legend text size
        legend.title = element_text(size = 16),
        plot.title = element_text(hjust = 0.5))      # increase legend title size
}

myPalette <- colorRampPalette(brewer.pal(9, "BuPu"))    # Blue-Purple
myPalette2 <- colorRampPalette(brewer.pal(9, "YlOrRd")) # Yellow-Orange-Red
myPalette3 <- colorRampPalette(brewer.pal(9, "YlGnBu")) # Yellow-Green-Blue

# geographic visualizations of housing costs
cpi_by_year <- read.csv("annual_cpi_us.csv", fileEncoding = "UTF-8-BOM")
cpi_by_year$adjust <- cpi_by_year$cpi/258.2937 # adjustment factor into 2020 dollars

# use the cpi_by_year adjustment to adjust rents to 2010 dollars
# rent in y year = (rent in current year) X (CPI y year/CPI current year)

# Select a color palette with which to run the palette function
pal_fun  <- colorNumeric("BuPu", NULL)      # Blue-Purple from RColorBrewer
pal_fun2 <- colorNumeric("YlOrRd", NULL)    # Yellow-Orange-Red from RColorBrewer

# function to get inflation correction factor for a given year into 2020 dollars
i_factor <- function(year){
  c_factor <- cpi_by_year$adjust[which(cpi_by_year$year == year)]
  return(c_factor)
}

# function to generate static map of rent costs by year across all coutnies in US
map_rent <- function(df, year){
    correction = i_factor(year)
 
  fmr_map = ggplot() +
    geom_sf(data=df,lwd=0, 
            aes(fill = fmr1/correction)) + # adjust factor included
    ggtitle(paste(year, "Median Rent for 1-bed")) + 
    scale_fill_gradientn(name = "Rent (2020 $)", 
                         colours = myPalette2(100),
                         limits = c(0,2000),
                         breaks = c(500,1000,1500,2000)) + # add limits and breaks to normalize scaling between years  
    north(data = df, symbol = 12, location = "bottomright") +
    scalebar(data = df, dist = 500, dist_unit = 'mi', transform = TRUE,
             location = "bottomleft",
             st.dist = 0.1) +
    my_theme()
}

# call static map function and display
fmr1_2017_map <- map_rent(fmr_2017_geo, 2017) # generate static rent map for counties
fmr1_2017_map # display rent map

# call static map function and display
fmr1_2017_map2 <- map_rent(fmr_2017_geo2, 2017) # generate static rent map for metro areas
fmr1_2017_map2 # display rent map

```


# Next I create an interative map of US median rents using the R leaflet package and the same HUDfmr data. Like the previous section, this visualization can plot data for FMRs between 2017-2020 and adjust prices to 2020 dollars. 

```{r, eval=TRUE}
# an interactive map of rent prices
library(htmlwidgets)
library(htmltools)

pal_fun <- colorNumeric("YlOrRd", NULL)  # Yellow-Orange-Red from RColorBrewer


# ------------------------------------------------- #
# HTML code to fix misaligned "na" in map legend
# ------------------------------------------------- #
library(htmlwidgets)
css_fix <- "div.info.legend.leaflet-control br {clear: both;}" # CSS to correct spacing
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML


# Funciton allows to plot interactive leaflet maps of median US rents by year
map_rent_i <- function(df, year){

#---------------------------------------------------#
# HTML code to add title to interactive maps
#---------------------------------------------------#
tag.map.title <- tags$style(HTML("
.leaflet-control.map-title { 
    transform: translate(-50%,20%);
    position: fixed !important;
    left: 50%;
    text-align: center;
    padding-left: 10px; 
    padding-right: 10px; 
    background: rgba(255,255,255,0.75);
    font-weight: bold;
    color: #000000;
    font-size: 20px;
  }
"))

title <- tags$div(
  tag.map.title, HTML(paste(year, "Median Rent:", 1, "Bed"))
)  
    
  correction = i_factor(year)# find correction factor
  
  # Pop-up message
  pu_message <- paste0("County: ", df$countyname,  
                     "<br>Rent: ", "$", floor(df$fmr1/correction)) # in 2010 dollars
  
  # Adding more customization 
  interactive_map <- leaflet(df) %>%
    addPolygons(stroke = FALSE,                        # remove polygon borders
                fillColor = ~pal_fun(fmr1/correction), # in 2010 dollars
                fillOpacity = 0.5, smoothFactor = 0.5, # increase opacity and resolution
                popup = ~pu_message) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%   # add third party provider tile
    #addProviderTiles(providers$Stamen.Toner) %>%
    #addProviderTiles(providers$Esri.NatGeoWorldMap)
    addLegend("bottomright",                           # location of legend
              pal=pal_fun,                             # palette function
              values=~fmr1/correction,                  # variable to be passed to palette function
            title = paste("Rent",1,"bed (2020 $)"),  # legend title
            opacity = 1) %>% # legend opacity (1 = completely opaque)
    addScaleBar() %>%
    addTiles() %>%
    addControl(title, position = "topleft", className="map-title") #add title panel
  
  return(interactive_map %<>% htmlwidgets::prependContent(html_fix))
}

# Call interactive map function and display 
fmr_2020_mapi <- map_rent_i(fmr_2020_geo, 2020) 
fmr_2020_mapi


```


### ACS poverty and income data

# In this part of the project, I gather 5-year American Community Survey (ACS) data from the US census bureau. Namely I am looking for median household income, and poverty rates (calculated as the percent of families falling below poverty threshold over total families surveyed). 

```{r, eval=TRUE}
library(tidycensus)
library(tidyr)

census_key <- read.delim("census_key.txt", header=FALSE)[1,1] # read in api key from local


# census_api_key(census_key,install=TRUE)

```

```{r, eval=TRUE}
acs.data <- get_acs(geography = "county",       # query data at the county level 
                   year = 2018,                 # end year (these will give us ACS 5-year estimates for 2014-2018)
                   variables = c("B17010_002",  # number of families falling below the poverty threshold
                                 "B17010_001",  #total number of families for which poverty was determined
                                 "B19013_001"), # median household income
                   key = census_key) 
acs.data %<>%
  dplyr::select(-moe) #remove the margin of error

# pivot on both estimate and total variables
acs.data <- pivot_wider(data=acs.data, names_from="variable", values_from="estimate")

acs.data %<>%
  dplyr::rename(poverty_total = B17010_001, 
         poverty_estimate = B17010_002,
         med_house_income = B19013_001)  %>% # give vars meaningful names
  dplyr::mutate(ID = paste0("0", as.character(050000000000 + as.numeric(GEOID)))) #create ID column to merge on


```


# I make another static map of median income across the US counties using 5-year ACS data (2014-2018). It is clear that high income is concentrated in coastal cities as expected.

```{r, eval=TRUE}
# geospatial exploration of ACS median income from 2014-2018 by county 

# join acs data
acs.data.geo <- left_join(counties, acs.data[,c("ID", "poverty_total",
                                                "poverty_estimate", "med_house_income")],
                          by = "ID") # merge to counties

acs.data.geo %<>% # clean up the dataframe
  dplyr::select(GEO_ID, ID, COUNTY, poverty_total, poverty_estimate,
         med_house_income,geometry)

# plot income map
income_map <- ggplot() +
  geom_sf(data=acs.data.geo,lwd=0, 
          aes(fill = med_house_income)) + # adjust factor included
  ggtitle("Median Household Income (2014-2018)") + 
  scale_fill_gradientn(name = "Income", 
                       colours = myPalette2(100)) + # add limits and breaks to normalize scaling between years  
  north(data = acs.data.geo, location = "bottomright", symbol = 12) +
  scalebar(data = acs.data.geo, dist = 500, dist_unit = 'mi', transform = TRUE,
           location = "bottomleft",
           st.dist = 0.1) +
  my_theme()

income_map # show the median income map
```


# In this section, I wanted to see if ACS data and fmr data correlate with each other, and how these factors may be used independently or together in future analyses of health outcomes.

```{r, eval=TRUE}
library(ggpubr)
options(scipen=10000)

# joins acs data and fmr data for any given fmr year
acs_join <- function(acs.geo.df, fmr.geo.df){
  acs.df <- dplyr::select(as.data.frame(acs.data.geo), -geometry)
  acs_fmr <- left_join(fmr.geo.df, acs.df, by = "ID")
  return(acs_fmr)
}

# combine acs data with fmr data
acs.fmr.2017 <- acs_join(acs.data.geo, fmr_2017_geo) 
acs.fmr.2018 <- acs_join(acs.data.geo, fmr_2018_geo) 
acs.fmr.2019 <- acs_join(acs.data.geo, fmr_2019_geo) 
acs.fmr.2020 <- acs_join(acs.data.geo, fmr_2020_geo) 
acs.fmr.2021 <- acs_join(acs.data.geo, fmr_2021_geo) 

```

# Here I explore the relationship between poverty rates and median household income as well as median 1-bed rents. Poverty tracks non-linearly with median household income but not as well with median fmr. I then looked at FMR as a percent of median income to see if the amount of one's budget spent on rent might be a better indicator for poverty. In those ggplots, a linear regression fits well, althought it remains unclear to what extend housing costs play into the regression versus income alone.

```{r, eval=TRUE}
# calculate poverty rate and percent spent on housing by county for one year

thresh <- 0 # threshold for filtering poverty estimates

acs.fmr.2017 %<>%
  dplyr::filter(poverty_estimate > thresh) %>%
  dplyr::mutate(poverty_percent = poverty_estimate/poverty_total) %>%
  dplyr::mutate(housing_percent = (fmr1*12)/med_house_income)
acs.fmr.2018 %<>%
  dplyr::filter(poverty_estimate > thresh) %>%
  dplyr::mutate(poverty_percent = poverty_estimate/poverty_total) %>%
  dplyr::mutate(housing_percent = (fmr1*12)/med_house_income)
acs.fmr.2019 %<>%
  dplyr::filter(poverty_estimate > thresh) %>%
  dplyr::mutate(poverty_percent = poverty_estimate/poverty_total) %>%
  dplyr::mutate(housing_percent = (fmr1*12)/med_house_income)
acs.fmr.2020 %<>%
  dplyr::filter(poverty_estimate > thresh) %>%
  dplyr::mutate(poverty_percent = poverty_estimate/poverty_total) %>%
  dplyr::mutate(housing_percent = (fmr1*12)/med_house_income)


# plot map of percentage spent on median 1-bed apartment by median income
rent_income_map <- ggplot() +
  geom_sf(data=acs.fmr.2017,lwd=0, 
          aes(fill = housing_percent)) + # adjust factor included
  ggtitle("Percent of income spent on rent (2017 1-Bed)") + 
  scale_fill_gradientn(name = "% spent on rent", 
                       colours = myPalette2(10)) + # add limits and breaks to normalize scaling between years  
  north(data = acs.fmr.2017, location = "bottomright", symbol = 12) +
  scalebar(data = acs.fmr.2017, dist = 500, dist_unit = 'mi', transform = TRUE,
           location = "bottomleft",
           st.dist = 0.1) +
  my_theme()

rent_income_map # show the median income map

# relationship between amount spent on housing and poverty rate 
# FMR 1-bed data from 2017-2020
# Median income estimated from 2014-2018 ACS data
# generate linear regression fits for the relationship between housing burdern and poverty 

# looking at income alone across US counties

income_2017 <- ggplot(data = acs.fmr.2017, aes(x=med_house_income, y=poverty_percent))+
  geom_point() +
  xlab("Median Income ($)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2017 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))
  

income_2018 <- ggplot(data = acs.fmr.2018, aes(x=med_house_income, y=poverty_percent))+
  geom_point() +
  xlab("Median Income ($)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2018 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

income_2019 <- ggplot(data = acs.fmr.2019, aes(x=med_house_income, y=poverty_percent))+
  geom_point() +
  xlab("Median Income ($)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2019 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

income_2020 <- ggplot(data = acs.fmr.2020, aes(x=med_house_income, y=poverty_percent))+
  geom_point() +
  xlab("Median Income ($)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2020 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

combined_income <- cowplot::plot_grid(income_2017,income_2018,
                                      income_2019,income_2020)

combined_income

# looking at housing cost alone across US counties

housing_2017 <- ggplot(data = acs.fmr.2017, aes(x=fmr1, y=poverty_percent))+
  geom_point() +
  xlab("Median Rent (1-Bed)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2017 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

housing_2018 <- ggplot(data = acs.fmr.2018, aes(x=fmr1, y=poverty_percent))+
  geom_point() +
  xlab("Median Rent (1-Bed)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2018 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

housing_2019 <- ggplot(data = acs.fmr.2019, aes(x=fmr1, y=poverty_percent))+
  geom_point() +
  xlab("Median Rent (1-Bed)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2019 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

housing_2020 <- ggplot(data = acs.fmr.2020, aes(x=fmr1, y=poverty_percent))+
  geom_point() +
  xlab("Median Rent (1-Bed)") + 
  ylab("Poverty Rate %") + 
  ggtitle("2020 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5))

combined_housing <- cowplot::plot_grid(housing_2017, housing_2018,
                                      housing_2019, housing_2020)

combined_housing

# looking at income and housing cost combined across US counties

h_burden_2017 <- ggplot(data = acs.fmr.2017, aes(x=housing_percent, y=poverty_percent))+
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Percent Spent on Rent") + 
  ylab("Poverty Rate %") + 
  ggtitle("2017 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

h_burden_2018 <- ggplot(data = acs.fmr.2018, aes(x=housing_percent, y=poverty_percent))+
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Percent Spent on Rent") + 
  ylab("Poverty Rate %") + 
  ggtitle("2018 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

h_burden_2019 <-ggplot(data = acs.fmr.2019, aes(x=housing_percent, y=poverty_percent))+
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Percent Spent on Rent") + 
  ylab("Poverty Rate %") + 
  ggtitle("2019 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

h_burden_2020 <-ggplot(data = acs.fmr.2020, aes(x=housing_percent, y=poverty_percent))+
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Percent Spent on Rent") + 
  ylab("Poverty Rate %") + 
  ggtitle("2020 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

combined_h_burden <- cowplot::plot_grid(h_burden_2017, h_burden_2018,
                                        h_burden_2019, h_burden_2020) 

combined_h_burden # display the combined graph

```

# mapthegap data
```{r, eval=TRUE}
setwd("Map the Meal Gap data")

# map the gap county data 2010
food <- read.csv("MMG2012_2010Data_ToShare.csv", fileEncoding = "UTF-8-BOM") 

food %<>%
  dplyr::select(FIPS, State,County..State,X2010.Food.Insecurity.Rate,X2010.Cost.Per.Meal) %>%
  dplyr::rename(County = County..State, food_insecure = X2010.Food.Insecurity.Rate, 
         meal_cost = X2010.Cost.Per.Meal) %>%
  dplyr::mutate(ID = paste0("0", as.character(050000000000 + as.numeric(FIPS)))) 
  
food$meal_cost = as.numeric(gsub("[$]","",food$meal_cost))


```

# The final piece of cost-of-living data to be used in this project is food expense data. I downloaded "meal cost" data from Feeding America, a non profit organization studying food costs and food insecurity in the United states. The "price per meal" value was calculated by the organization in 2010 using the local price of a basket of goods defined by the FDA and adjusted for local tax rates. Again, I checked to see if price-per-meal was correlated with poverty rates alone. The ggplots show they do not.

```{r, eval=TRUE}
# join map the gap data to acs/fmr data
acs.fmr.food.2017 <- left_join(acs.fmr.2017, food[,c("ID","food_insecure", 
                                                     "meal_cost")], by = "ID") %>%
  dplyr::mutate(meal_percent = meal_cost*3*365/med_house_income)
acs.fmr.food.2018 <- left_join(acs.fmr.2018, food[,c("ID","food_insecure", 
                                                     "meal_cost")], by = "ID") %>%
  dplyr::mutate(meal_percent = meal_cost*3*365/med_house_income)
acs.fmr.food.2019 <- left_join(acs.fmr.2019, food[,c("ID","food_insecure", 
                                                     "meal_cost")], by = "ID") %>%
  dplyr::mutate(meal_percent = meal_cost*3*365/med_house_income)
acs.fmr.food.2020 <- left_join(acs.fmr.2020, food[,c("ID","food_insecure", 
                                                     "meal_cost")], by = "ID") %>%
  dplyr::mutate(meal_percent = meal_cost*3*365/med_house_income)


# look at food costs in isolation 
food_cost <- ggplot(acs.fmr.food.2017, aes(x=meal_cost, y=poverty_percent))+
  geom_point()+
  xlab("Meal Cost") +
  ylab("Poverty Rate %") +
  ggtitle("Meal Cost") +
  theme(plot.title = element_text(hjust = 0.5)) 


# look at food cost as percent of median income
food_burden <- ggplot(acs.fmr.food.2017, aes(x=meal_percent, y=poverty_percent))+
  geom_point()+  
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Percent Spent on Food") + 
  ylab("Poverty Rate %") + 
  ggtitle("Income spent on Food") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

combined_food_burden <- cowplot::plot_grid(food_cost, food_burden) 

combined_food_burden # display the combined graph


```

# Finally, I combined all housing costs and meal costs as a percentage of median income, plotted them along the poverty rate by county (2017-2020), and fit a linear regression to each plot. There seems to be a predictable linear relationship between these factors. 

```{r, eval=TRUE}
# generate a two-factor cost of living index by adding food and housing costs

acs.fmr.food.2017 %<>%
  mutate(COL = meal_percent + housing_percent)

acs.fmr.food.2018 %<>%
  mutate(COL = meal_percent + housing_percent)

acs.fmr.food.2019 %<>%
  mutate(COL = meal_percent + housing_percent)

acs.fmr.food.2020 %<>%
  mutate(COL = meal_percent + housing_percent)

COL_2017 <- ggplot(acs.fmr.food.2017, aes(x=COL, y=poverty_percent))+
  geom_point()+  
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Combined food and housing costs") + 
  ylab("Poverty Rate %") + 
  ggtitle("2017 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

COL_2018 <- ggplot(acs.fmr.food.2018, aes(x=COL, y=poverty_percent))+
  geom_point()+  
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Combined food and housing costs") + 
  ylab("Poverty Rate %") + 
  ggtitle("2018 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

COL_2019 <- ggplot(acs.fmr.food.2019, aes(x=COL, y=poverty_percent))+
  geom_point()+  
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Combined food and housing costs") + 
  ylab("Poverty Rate %") + 
  ggtitle("2019 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

COL_2020 <- ggplot(acs.fmr.food.2020, aes(x=COL, y=poverty_percent))+
  geom_point()+  
  geom_smooth(method = "lm", formula = y~x) +
  xlab("Combined food and housing costs") + 
  ylab("Poverty Rate %") + 
  ggtitle("2020 US Counties ") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_regline_equation() 

combined_COL <- cowplot::plot_grid(COL_2017,COL_2018,COL_2019,COL_2020) 

combined_COL # display the combined graph

```


Next, I make visualization to see the contribution of such costs alone verses median income. Based on these analyses, poverty rate and income are directly correlated as expected. However, median housing cost and food expenses alone do not seem to be directly associated with the poverty rate. Furthermore, calculated variables such as percent-spent-on-housing and percent-spent-on-food do not seem to give better correlations to poverty rate compared to median income alone, From these results I will use housing costs, food costs, and either poverty rate or median income from aggreate county data to predict health outcomes from BRFSS data. 

```{r, eval=TRUE}
library(gtools)
library(plyr)

pov_quant_2017 <- acs.fmr.food.2017 %>%
  dplyr::mutate(pov_quant = quantcut(poverty_percent, q=4,by=0.25, na.rm=TRUE))

pov_meal_quart <- ggplot(data=pov_quant_2017, aes(x=med_house_income, 
                                                  y=meal_cost,
                                                  color = pov_quant))+
  geom_point() +
  xlab("Median Household Income ($)") +
  ylab("Meal Cost ($)") +
  ggtitle("US Counties 2017") +
  theme(plot.title = element_text(hjust = 0.5)) 

pov_meal_quart

pov_house_quart <- ggplot(data=pov_quant_2017, aes(x=med_house_income, 
                                                  y=fmr1,
                                                  color = pov_quant))+
  geom_point() +
  xlab("Median Household Income ($)") +
  ylab("Median Rent ($)")  +
  ggtitle("US Counties 2017") +
  theme(plot.title = element_text(hjust = 0.5)) 

pov_house_quart

```

# Get BRFSS data
# Finally, I downloaded the BRFSS dataset from 2017 to analyze some health outcomes based on this phone survey.

```{r, eval=TRUE}
library(foreign)
setwd("MMSA2017_XPT")
brfss2017_raw <- read.xport("MMSA2017.xpt")
```

# Data-wrangling to rename, filter, and refactor variables. 
```{r, eval=TRUE}
# select variables of interest
# clean BRFSS 2017 dataframe

brfss2017 <- brfss2017_raw %>%
  dplyr::select('MMSANAME', 'X_MMSA', 'X_RACE', 'SEX', 'X_AGEG5YR','EDUCA','INCOME2',
                'ADDEPEV2', 'CHCCOPD1', 'X_RFHLTH') %>%
  dplyr::rename('Metro Area'='MMSANAME','Metro_ID'='X_MMSA','age'='X_AGEG5YR','race'='X_RACE', 
         'sex'='SEX', 'education'='EDUCA','income'='INCOME2',
         'depression'='ADDEPEV2','copd'='CHCCOPD1', 'health'='X_RFHLTH') %>%
  dplyr::filter(race %in%  c(1,2,3,5,8)) %>%
  dplyr::filter(sex %in% c(1,2)) %>%
  dplyr::filter(age %in% seq(13)) %>%
  dplyr::filter(education %in%  c(1,2,3,4,5,6)) %>%
  dplyr::filter(income %in% c(1,2,3,4,5,6,7,8)) %>%
  dplyr::filter(depression %in%  c(1,2)) %>%
  dplyr::filter(copd %in% c(1,2)) %>%
  dplyr::filter(health %in% c(1,2))

brfss2017 %<>%
  dplyr::mutate('Metro_ID' = as.character(brfss2017$'Metro_ID')) %>%
  dplyr::mutate(race = factor(race, levels = c(1,2,3,5,8), 
                        labels = c( "White", "Black", "American Indian", 
                                    "Asian", "Hispanic"))) %>%
  dplyr::mutate(sex = factor(sex, levels = c(1,2), 
                        labels = c("Male", "Female"))) %>%
  
  dplyr::mutate(age = factor(age, levels = seq(13), 
                        labels = c("18-24","25-29","30-34","35-39","40-44","45-49","50-54",
                                   "55-59","60-64","65-69","70-74","75-29",">79"))) %>%
  dplyr::mutate(education = factor(education, levels = c(1,2,3,4,5,6), 
                        labels = c("None","Elementary", "Some HS", "HS",
                                   "Some College", "College"))) %>%
  dplyr::mutate(income = factor(income, levels = c(1,2,3,4,5,6,7,8), 
                        labels = c("10k","15k", "20k", "25k", "35k", "50k", "75k","> 75k"))) %>%
  dplyr::mutate(depression = factor(depression, levels = c(1,2), 
                        labels = c("yes", "no"))) %>%
  dplyr::mutate(copd = factor(copd, levels = c(1,2), 
                        labels = c("yes", "no"))) %>%
  dplyr::mutate(health = factor(health, levels = c(1,2), 
                        labels = c("good", "poor"))) 

```


Let's look at the summary of the clean 2017 data frame. I am interested in sex, age, income, education, and race as demographic factors. I am interested in previous depression, COPD, and general health as outcomes. From the summary, there is a bias in sex and age. This might be explained by the fact that BRFSS is a phone based survey. It seems that income and education is skewed twoards highly educated, high earning individuals as well. The BRFSS might be biased towards home-owners and landline users over cell-phone users.
```{r, eval=TRUE}
summary(brfss2017, maxsum = 15)

```

# Next, I had to apply the appropriate metro code to previous county-level data for cost-of-living variabes. This is done by assigning all counties associated with one metropolitan area the same metro code, Lumping together multiple US counties into one geographical designation. This must be done because the BRFSS does not record which county participants live in, but rather their metro location.

# Data Wrangling to apply an appropriate metro code to every county
```{r, eval=TRUE}
cbsa2fips <- read.csv("cbsa2fipsxw.csv") 

cbsa2fips %<>%
  dplyr::mutate(fipsstatecode = as.character(cbsa2fips$fipsstatecode)) %>%
  dplyr::mutate(fipscountycode = as.character(cbsa2fips$fipscountycode)) %>%
  dplyr::mutate(fips_state = ifelse(nchar(fipsstatecode) == 1, paste0("0",fipsstatecode),
         fipsstatecode)) %>%
  dplyr::mutate(fips_county = ifelse(nchar(fipscountycode) == 2, paste0("0",fipscountycode),
         ifelse(nchar(fipscountycode) == 1, paste0("00",fipscountycode), fipscountycode))) %>%
  dplyr::mutate(ID = paste0("0", as.character(050000000000 + as.numeric(paste0(fips_state,fips_county))))) %>%
  dplyr::rename('Metro_ID' = cbsacode) %>%
  dplyr::select(ID, 'Metro_ID')

cbsa2fips$`Metro_ID` = as.character(cbsa2fips$`Metro_ID`)

# associate all counties to given metro area
acs.fmr.food.2017 %<>% 
  left_join(cbsa2fips, by="ID")

```


# Combine food, housing, income, and poverty data into one data frame by metro area rather than by county 

```{r, eval=TRUE}
# function to aggregate all acs.fmr.food cost of living data by metro area
# returns mean for all counties in a given metro area
metro_costs <- function(df){
  df %<>%
    dplyr::select(fmr0, fmr1, fmr2, fmr3, fmr4, Metro_ID, poverty_percent,
                  housing_percent, meal_cost, meal_percent, med_house_income)
  
  df = as.data.frame(df) 
  
  df %<>%
    dplyr::select(-geometry) %>%
    group_by(Metro_ID) %>%
    summarise_at(vars('fmr0', 'fmr1', 'fmr2', 'fmr3', 'fmr4', 'poverty_percent',
                  'housing_percent', 'meal_cost', 'meal_percent',
                  'med_house_income'), mean)
  return(df)
}

col_2017 <- metro_costs(acs.fmr.food.2017)

# join 2017 metro cost of living to BRFSS2017 dataframe
brfss2017 %<>%
  left_join(col_2017, by = "Metro_ID")

# remove NAs
brfss2017 %<>%
  na.omit(brfss2017)
```

# Next, I looked at how the cost-of-living and aggregate income variables affected the outcomes of three chosen BRFSS health outcomes (history of depression, history of COPD, general health)



# Look at how aggregate costs/income data and individual income data affect health outcomes

```{r, eval=TRUE}
metro_income_ghealth <- ggplot(data=brfss2017, aes(x=health, y = med_house_income))+
  geom_boxplot() +
  xlab("General Health") +
  ylab("Median Household Income ($)")  +
  ggtitle("BRFSS2017 General Health") +
  theme(plot.title = element_text(hjust = 0.5)) 


metro_income_copd <- ggplot(data=brfss2017, aes(x=copd, y = med_house_income))+
  geom_boxplot() +
  xlab("COPD History") +
  ylab("Median Household Income ($)")  +
  ggtitle("BRFSS2017 COPD History") +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_income_depression <- ggplot(data=brfss2017, aes(x=depression, y = med_house_income))+
  geom_boxplot() +
  xlab("Depression History") +
  ylab("Median Household Income ($)")  +
  ggtitle("BRFSS2017 Depression") +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_income_health_outcomes <- cowplot::plot_grid(metro_income_ghealth,metro_income_copd,
                                                   metro_income_depression) 

metro_income_health_outcomes
```

# Rent effects on health outcomes
```{r, eval=TRUE}
metro_fmr1_ghealth <- ggplot(data=brfss2017, aes(x=health, y = fmr1))+
  geom_boxplot() +
  xlab("General Health") +
  ylab("Median 1-Bed Rent ($)")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_fmr1_copd <- ggplot(data=brfss2017, aes(x=copd, y = fmr1))+
  geom_boxplot() +
  xlab("COPD History") +
  ylab("Median 1-Bed Rent ($)")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_fmr1_depression <- ggplot(data=brfss2017, aes(x=depression, y = fmr1))+
  geom_boxplot() +
  xlab("Depression History") +
  ylab("Median 1-Bed Rent ($)")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_rent_health_outcomes <- cowplot::plot_grid(metro_fmr1_ghealth,metro_fmr1_copd,
                                                   metro_fmr1_depression) 

metro_rent_health_outcomes
```

# aggregate food expenses and health outcomes
```{r, eval=TRUE}
metro_food_ghealth <- ggplot(data=brfss2017, aes(x=health, y = meal_cost))+
  geom_boxplot() +
  xlab("General Health") +
  ylab("Cost of Meal ($)")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_food_copd <- ggplot(data=brfss2017, aes(x=copd, y = meal_cost))+
  geom_boxplot() +
  xlab("COPD History") +
  ylab("Cost of Meal ($)")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_food_depression <- ggplot(data=brfss2017, aes(x=depression, y = meal_cost))+
  geom_boxplot() +
  xlab("Depression History") +
  ylab("Cost of Meal ($)")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_food_health_outcomes <- cowplot::plot_grid(metro_food_ghealth,metro_food_copd,
                                                   metro_food_depression) 

metro_food_health_outcomes

```

# Aggregate poverty effect on health outcomes
```{r, eval=TRUE}
metro_pov_ghealth <- ggplot(data=brfss2017, aes(x=health, y = poverty_percent))+
  geom_boxplot() +
  xlab("General Health") +
  ylab("Poverty Rate")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_pov_copd <- ggplot(data=brfss2017, aes(x=copd, y = poverty_percent))+
  geom_boxplot() +
  xlab("COPD History") +
  ylab("Poverty Rate")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_pov_depression <- ggplot(data=brfss2017, aes(x=depression, 
                                                    y= poverty_percent))+
  geom_boxplot() +
  xlab("Depression History") +
  ylab("Poverty Rate")  +
  theme(plot.title = element_text(hjust = 0.5)) 

metro_pov_health_outcomes <- cowplot::plot_grid(metro_pov_ghealth,metro_pov_copd,
                                                   metro_pov_depression) 

metro_pov_health_outcomes

```

# Unfortunately, in aggregate there does not seem to be a difference in case-control status for any of the chosen health outcomes based on secondary factors including rent, food expense, and median income. This is shown in above boxplots.


# Next, I looked at how individual income associates with the same health outcomes. 
```{r, eval=TRUE}

# income and general health 
ggplot(data=brfss2017, aes(x=income,  fill=health)) + 
  geom_bar(position="dodge") +
  ggtitle('Individual Income and General Health')+
  xlab('Income')+
  ylab('Count')  +
  theme(plot.title = element_text(hjust = 0.5)) 

# income and depression
ggplot(data=brfss2017, aes(x=income,  fill=depression)) + 
  geom_bar(position="dodge") +
  ggtitle('Individual Income and Depression History')+
  xlab('Income')+
  ylab('Count')  +
  theme(plot.title = element_text(hjust = 0.5)) 

# income and COPD
ggplot(data=brfss2017, aes(x=income,  fill=copd)) + 
  geom_bar(position="dodge") +
  ggtitle('Individual Income and COPD History')+
  xlab('Income')+
  ylab('Count')  +
  theme(plot.title = element_text(hjust = 0.5)) 
```


# Now we will run chi-square tests to see if income is indepdent from chosen 
health outcomes.

```{r, eval=TRUE}

# chi-square test for individual income and general health
brfss2017_health_table <- table(brfss2017$health, brfss2017$income)
brfss2017_health_table
chisq.test(brfss2017_health_table)

# chi-square test for individual income and depression history
brfss2017_depression_table <- table(brfss2017$depression, brfss2017$income)
brfss2017_depression_table
chisq.test(brfss2017_depression_table)

# chi-square test for individual income and COPD history
brfss2017_COPD_table <- table(brfss2017$copd, brfss2017$income)
brfss2017_COPD_table
chisq.test(brfss2017_COPD_table)

```

# Based on visualizaitons and chi-squared tests, it seems that there is an association between income and general health and history of both COPD and depression. This is expected based on previous work. Indivdiduals from high earning families are more likely to report better health, have less instances of COPD as well as depression.



# Next, I looked to create explore these health outcomes (depression, COPD, general health) using all individual demographic factors only by logistic regression.

```{r, eval=TRUE}

# Train a logistic regression model using BRFSS2017 data

depression_glm <- glm(formula=depression ~ race + sex + age + education + income,
                      data=brfss2017, family = binomial)

health_glm <- glm(formula=health ~ race + sex + age + education + income, 
                  data=brfss2017, family = binomial(logit))

copd_glm <- glm(formula=copd ~ race + sex + age + education + income, 
                  data=brfss2017, family = binomial(logit))

```


# Check model accuracy using individual demographics alone. Overall, there is decent predictive power using individual demographic data (including income) to all health outcomes. The AUC for depression, general health, and COPD are 0.6702, 0.7512, and 0.7597 respectively. 

```{r, eval=TRUE}
library(PRROC)

# ROC for depression logistic regression
depression_pred <- predict(depression_glm, data=brfss2017, type="response")

depression_glm_roc <- roc.curve(depression_pred[brfss2017$depression == "no"],
                                depression_pred[brfss2017$depression == "yes"], curve=TRUE)

# ROC for general health logistic regression
health_pred <- predict(health_glm, data=brfss2017, type="response")
health_glm_roc <- roc.curve(health_pred[brfss2017$health == "poor"],
                                health_pred[brfss2017$health == "good"], curve=TRUE)

# ROC for COPD logistic regression
copd_pred <- predict(copd_glm, data=brfss2017, type="response")
copd_glm_roc <- roc.curve(copd_pred[brfss2017$copd == "no"],
                                copd_pred[brfss2017$copd == "yes"], curve=TRUE)

plot(depression_glm_roc)
plot(health_glm_roc)
plot(copd_glm_roc)

```

# Finally, I explored these health outcomes (depression, COPD, general health) using both individual demographic factors and aggregate metropolitan factors by logistic regression. I hoped to add predictive power to the model by combining both individual data as well as aggregate secondary data. 

```{r, eval=TRUE}

# Train a logistic regression model using BRFSS2017 data

depression_glm2 <- glm(formula=depression ~ race + sex + age + education + income +
                         med_house_income + fmr1 + meal_cost,
                      data=brfss2017, family = binomial(logit))


health_glm2 <- glm(formula=health ~ race + sex + age + education + income + med_house_income
                      + fmr1 + meal_cost,
                  data=brfss2017, family = binomial(logit))

copd_glm2 <- glm(formula=copd ~ race + sex + age + education + income + med_house_income
                      + fmr1 + meal_cost, 
                  data=brfss2017, family = binomial(logit))


```

# check model accuracy using individual demographics and aggregate metro data


# AUC barely improved (<0.01 increase) with the addition of secondary cost-of-living data. 

```{r, eval=TRUE}
# ROC for depression logistic regression
depression_pred2 <- predict(depression_glm2, data=brfss2017, type="response")

depression_glm_roc2 <- roc.curve(depression_pred2[brfss2017$depression == "no"],
                                depression_pred2[brfss2017$depression == "yes"], curve=TRUE)
head(depression_pred2)
# ROC for general health logistic regression
health_pred2 <- predict(health_glm2, data=brfss2017, type="response")
health_glm_roc2 <- roc.curve(health_pred2[brfss2017$health == "poor"],
                                health_pred2[brfss2017$health == "good"], curve=TRUE)

# ROC for COPD logistic regression
copd_pred2 <- predict(copd_glm2, data=brfss2017, type="response")
copd_glm_roc2 <- roc.curve(copd_pred2[brfss2017$copd == "no"],
                                copd_pred2[brfss2017$copd == "yes"], curve=TRUE)

plot(depression_glm_roc2)
plot(health_glm_roc2)
plot(copd_glm_roc2)
```

# Adding in the additional variables from ACS median income an housing costs only slightly increased AUC, but not enough to merit including them into GLM models. Overall, the value of individual survey data is much more valuable in predicting history of depression, COPD, and general well-being/health.
Overall, this might because the the aggregate data is not granular enough. In order to do this analysis, multiple counties had to be reassigned to one metro label. However, cost-of-living expenses can vary greatly depending not only on which city one is located in but also which county and which part of the county one lives in. Thus, averaging housing and food expenses from multiple geographical areas does not provide fine enough detail to how one's indiviual income might be affect by cost of living. In order to better improve these models, surveys should ask individuals for their housing costs or provide more granular geospatial labelling for individuals. 

# From this project, I have recapitulated previous works describing the associations with increased income and better health outcomes. In addition, I show that ACS/FMR data at the metro-area level is not a good predictor of BRFSS outcomes chosen. While it is thought that having high cost-of-living expenses might negatively health outcomes (due to stress, finanical and food insecurity, and lack of access to adequate primary/preventive healthcare), the secondary data sets could not be adequately applied to the BRFSS dataset to answer these questions. 


















