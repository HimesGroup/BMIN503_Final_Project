---
title: "Title Here"
author: "Alexander Chan"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
# commonly-used packages
library(ggplot2)
library(dplyr)
library(magrittr)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.
```{r, eval=TRUE}

```

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.
```{r, eval=TRUE}

```

### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.
```{r, eval=TRUE}

```

### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

###
Download and install Rtools40 to use the BLS api: https://cran.r-project.org/bin/windows/Rtools/

### Reading and Cleaning Datasets
```{r, eval=TRUE}
# tools for accessing BLS data
library(devtools)
library(blsAPI)
library(rjson)
install_github("mikeasilva/blsAPI", force = TRUE) # Install the blsAPI by Mike Silva
```


```{r, eval=TRUE}
# query data from BLS.gov

# load api key (must have the txt file)
api_key <-  read.csv("bls_api_key.txt", header=FALSE)[[1]]

# signatures to be queried from BLS.gov, 10-year CPI data from major metropolitan areas
signatures <- read.csv("metro_area_cpi_signatures.csv") 

# payload signatures to query BLS 
month_payload <- list('seriesid'= signatures$signature_monthly) #2018-2020 monthly CPI 
annual_payload <- list('seriesid'= signatures$signature_annual) #2018-2020 annual CPI

# query CPI 2018-2020 data from major metropolitan areas from BLS 
months_cpi <- blsAPI(month_payload, return_data_frame = TRUE) # monthly CPI dataframe
annual_cpi <- blsAPI(annual_payload, return_data_frame = TRUE) # annual CPI dataframe
```

```{r, eval=TRUE}

# add columns to join region labels by
months_cpi$signature_monthly <- months_cpi$seriesID
annual_cpi$signature_annual <- annual_cpi$seriesID

# join region and state labels to the cpi data
# complete monthly dataframe for 2018-2020 regional metro cpi data
months_cpi %<>%
  left_join(signatures[, c("signature_monthly","state","area")],by="signature_monthly") %>%
  dplyr::select(-seriesID)

# complete annual dataframe for 2018-2020 regional metro cpi data
annual_cpi %<>%
  left_join(signatures[, c("signature_annual","state","area")],by="signature_annual") %>%
  dplyr::select(-seriesID)

head(months_cpi)
head(annual_cpi)

```
```{r, eval=TRUE}
# Further format dataframes
# pivot data by metro area and years, add column for mean annual CPI

# annual cpi 
a_cpi <- annual_cpi %>% 
  pivot_wider(id_cols = c("area","year"),names_from = "periodName",
              values_from = "value")%>% # pivot on area and year using values from period
  mutate_at(vars(3:4), as.numeric) %>% # change CPI values to numeric
  mutate(annual = rowMeans(select(., c("1st Half", "2nd Half")), na.rm= TRUE))# mean annual cpi

# monthly cpi
m_cpi <- months_cpi %>%
  dplyr::select(-period) %>%
  pivot_wider(id_cols = c("area","year"), names_from = "periodName", 
              values_from = "value") %>% # pivot on area and year using values from period
  mutate_at(vars(2:14), as.numeric) %>% # change CPI values to numeric
  mutate(annual = rowMeans(select(.,-c("area", "year")), na.rm = TRUE)) # mean annual cpi

head(a_cpi)
head(m_cpi)
```


```{r, eval=TRUE}
# function to format the geo id column of FMR dataframes
format_id <- function(df){
  
  df$ID <- str_replace(as.character(df$fips2010),
                       as.character(df$CouSub),"")
  df$ID <- as.numeric(df$ID) + 50000000000
  df$ID <- paste0("0",as.character(df$ID))
  
  return(df)
}

fmr_2017$ID2 <- str_replace(as.character(fmr_2017$fips2000), 
                            as.character(fmr_2017$CouSub),
                            "")

# read in the housing costs: fair market rates (2017-2020)
# format relevent columns into a standard form
fmr_2017 <- read.csv("FY2017_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  mutate_at(c("fmr0", "fmr1", "fmr2", "fmr3", "fmr4"), as.numeric)
fmr_2018 <- read.csv("FY2018_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  mutate_at(c("fmr_0", "fmr_1", "fmr_2", "fmr_3", "fmr_4"), as.numeric) %>%
  rename("CouSub" = "cousub", "fmr0" = "fmr_0","fmr1" = "fmr_1","fmr2" = "fmr_2", 
         "fmr3" = "fmr_3", "fmr4" = "fmr_4")
fmr_2019 <- read.csv("FY2019_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  mutate_at(c("fmr_0", "fmr_1", "fmr_2", "fmr_3", "fmr_4"), as.numeric) %>%
  rename("CouSub" = "cousub","fmr0" = "fmr_0","fmr1" = "fmr_1","fmr2" = "fmr_2", 
         "fmr3" = "fmr_3", "fmr4" = "fmr_4") 
fmr_2020 <- read.csv("FY2020_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  mutate_at(c("fmr_0", "fmr_1", "fmr_2", "fmr_3", "fmr_4"), as.numeric) %>%
  rename("CouSub" = "cousub", "fmr0" = "fmr_0","fmr1" = "fmr_1","fmr2" = "fmr_2", 
         "fmr3" = "fmr_3", "fmr4" = "fmr_4") 
fmr_2021 <- read.csv("FY2021_50_County_FMR.csv", fileEncoding = "UTF-8-BOM") %>%
  mutate_at(c("rent50_0", "rent50_1", "rent50_2", "rent50_3", "rent50_4"),
            as.numeric) %>%
  rename("CouSub" = "cousub", "fmr0" = "rent50_0",
         "fmr1" = "rent50_1","fmr2" = "rent50_0", 
         "fmr3" = "rent50_0", "rent50_0" = "rent50_0") 

# format geographical ids for all FMRs
fmr_2017 <- format_id(fmr_2017)
fmr_2018 <- format_id(fmr_2018)
fmr_2019 <- format_id(fmr_2019)
fmr_2020 <- format_id(fmr_2020)
fmr_2021 <- format_id(fmr_2021)

# read in shape file of US counties
counties <- readRDS(gzcon(url('https://raw.githubusercontent.com/HimesGroup/BMIN503/master/DataFiles/uscounties_2010.rds'))) # decompress  rds file and read in shape file
counties$GEO_ID <- as.character(counties$GEO_ID)#change geo id to characters in counties df
counties$ID <- gsub("US","", counties$GEO_ID)  #remove US from ID

fmr_2017_geo <- counties %>%
  dplyr::select(c("NAME", "ID", "geometry")) %>%
  left_join(fmr_2017[,c("ID","fmr0", "fmr1", "fmr2", "fmr3", "fmr4",
                        "Metro_code", "areaname", "countyname")],
            by="ID")



```

```{r, eval=TRUE}
# geographic visualizations of housing costs
library(sf)
cpi_by_year <- read.csv("annual_cpi_us.csv", fileEncoding = "UTF-8-BOM")
cpi_by_year$adjust <- cpi_by_year$cpi/218.0555 # adjustment factor

# use the cpi_by_year adjustment to adjust rents to 2010 dollars
# rent in y year = (rent in current year) X (CPI y year/CPI current year)

fmr1_2017_map <- ggplot() +
  geom_sf(data=fmr_2017_geo,lwd=0, 
          aes(fill = fmr1/1.124116)) + # adjust factor included
  ggtitle("2017 Median Rent for 1-bed") + 
  scale_fill_gradientn(name = "Rent (2010 $)", 
                       colours = myPalette2(100),
                       limits = c(0,2000),
                       breaks = c(500,1000,1500,2000)) + # add limits and breaks to normalize scaling between years  
  north(data = combined, symbol = 12, anchor = c(x = -25, y = 39.93)) +
  scalebar(data = combined, dist = 500, dist_unit = 'mi', transform = TRUE, location = "bottomleft",
           st.dist = 0.1) +
  my_theme()

fmr1_2017_map
```
```{r, eval=TRUE}
# an interactive map of rent prices

library(leaflet)
library(RColorBrewer)
library(htmlwidgets)

pal_fun <- colorNumeric("YlOrRd", NULL)    # Yellow-Orange-Red from RColorBrewer

# ------------------------------------------------- #
# Code to fix misaligned "na" in map legend
# ------------------------------------------------- #
css_fix <- "div.info.legend.leaflet-control br {clear: both;}" # CSS to correct spacing
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML

# Pop-up message
pu_message <- paste0("County: ", fmr_2017_geo$countyname,  
                     "<br>Rent 1-bed: ", floor(fmr_2017_geo$fmr1/1.124116))


# Adding more customization 
fmr_2017_mapi <- leaflet(fmr_2017_geo) %>%
  addPolygons(stroke = FALSE,                        # remove polygon borders
              fillColor = ~pal_fun(fmr1/1.124116),
              fillOpacity = 0.5, smoothFactor = 0.5, # increase opacity and resolution
              popup = ~pu_message) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%   # add third party provider tile
  #addProviderTiles(providers$Stamen.Toner) %>%
  #addProviderTiles(providers$Esri.NatGeoWorldMap)
  addLegend("bottomright",                           # location of legend
            pal=pal_fun,                             # palette function
            values=~fmr1/1.124116,                 # variable to be passed to palette function
            title = 'Median Rent 1-bed in 2010 $',  # legend title
            opacity = 1) %>%
  addScaleBar()  # legend opacity (1 = completely opaque)

# Insert fix to legend into leaflet HTML code
fmr_2017_mapi %<>% htmlwidgets::prependContent(html_fix)

fmr_2017_mapi # display leaflet map
```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
```{r, eval=TRUE}

```
