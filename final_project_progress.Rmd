---
title: "BMIN503 Final Project_Oppenheimer"
author: "Natalie Oppenheimer"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Replace the title/name above and text below with your own, but keep the headers.

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

This project will attempt to answer the question "what is the risk of a novice driver crashing within a certain number of months since licensure (time-points TBD) by factors like their age, sex, and performance on the on-road licensing exam and in a virtual driving test?"

Faculty input from
1) Dr. Allison Curry, a CHOP Epidemiologist who studies motor vehicle crashes in non-typically developing populations (ex. individuals with ADD, ADHD, and Autism)
2) Dr. Kate McDonald, associate Professor at Penn's School of Nursing who was deeply involved in the evolution of the virtual driving test from a lab-based simulator to a portable assessment tool in the field.
3) Dr. Megan Ryerson, Associate Dean for Research at PennDesign, within the Weitzman School of Design who is a city planning, urban design, and transportation expert.

### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

Motor vehicle crashes remain the leading cause of injury and death among young adults. Research estimates that motor vehicle crashes (MVCs) account for between one in three to one in five adolescent deaths; and we know that lifetime crash risk is highest in the months immediately following independent licensure. We also know, however, that driving is crucial for many adolescents to achieving personal independence, and accessing educational and occupational opportunities and other resources. Therefore, a crucial public health question emerges: how can we increase young driver safety without compromising mobility? One intervention, Graduated Driver Licensing (GDL), has been implemented across the United States. GDL aims to "allow young drivers to safely gain driving experience before obtaining full driving privileges" through a staged approach to driving beginning with learner or permit-ed, supervised driving, followed by intermediate limited license, and finally full privilege license (source: Governors Highway Safety Association, Teen and Novice Drivers). GDL has successfully reduced the number of MVCs among 16- and 17-year olds, but  this policy does not necessarily ensure that new drivers acquire the skills needed to drive safely - as evidenced by the fact that the vast majority of crashes in the months immediately after licensure are due to driver error (as opposed to driver risk-taking). This suggests that the point of licensure is a critical moment for assessing new driver skills to ensure they are ready to safely begin independent driving. Unfortunately, the on-road exam (ORE) for licensure is extremely limited in its ability to test for these key skills due to variability in examiner assessment of applicant readiness to drive, time constraints, the inability to safely expose applicants to common crash risk scenarios, and a host of other factors. To combat some of these limitations, simulated driving assessment can be used to complement the ORE by consistently and safely exposing applicants to common crash risk scenarios, and thoroughly evaluating their driving skills.

Through a partnership between Diagnostic Driving, Inc., a CHOP spin-out company, the Ohio Bureau of Motor Vehicles (OBMV), and the CHOP Neuroscience of Driving (NoD) team, such a simulated driving assessment was implemented in driving test sites across the state of Ohio. Our shared goal: scale and sustain the virtual driving test (VDT) as a screener and skills assessment at the time of licensure to identify applicants with critical skill deficits who 
   a) are at risk of failing the ORE, and 
   b) may be at a higher risk of crashing post-licensure. 
In order to do this, CHOP has recieved, linked, and de-identified 
   a) data from Ohio's state-wide licensing database, 
   b) Ohio's police-reported crash outcomes, 
   c) Diagnostic Driving's VDT process and outcome data. 
Utilizing this rich and unique data source, a crucial research question with potential major policy implications is: How do crash rates vary by personal factors such as sex, age at licensure, time since licensure, and VDT performance? Are these factors (sex, age, time since licensure, VDT performance) related, and if so, what does this tell us about young driver skill development and experience?


### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

```{r eval = TRUE}
# set-up and basic cleaning/formatting

# loading in libraries used
library(dplyr)
library(ggplot2)

# reading in combined VDT, licensing, crash outcomes data set
d <- read.csv(file = 'Research_dataset_HSG.csv')

# checking variable class for cleaning (printing head to save space)
head(lapply(d, class))

# cleaning & re-coding variables
dc <- d %>%
  mutate(TestDateAge = (TestDateAge/365.25)) %>%
  mutate(BMVLocation = as.factor(BMVLocation)) %>%
  mutate(completed_intro_drive = as.factor(completed_intro_drive)) %>%
  mutate(started_comprehension = as.factor(started_comprehension)) %>%
  mutate(completed_comprehension = as.factor(completed_comprehension)) %>%
  mutate(started_assessment_drive = as.factor(started_assessment_drive)) %>%
  mutate(completed_assessment_drive = as.factor(completed_assessment_drive)) %>%
  mutate(passed_comprehension = as.factor(passed_comprehension)) %>%
  mutate(Map = as.factor(Map)) %>%
  mutate(Variant = as.factor(Variant)) %>%
  rename(Total_VDT_Duration = Total_Duration) %>%
  rename(U_ttc_3_10 = U_CE_3_10) %>%
  rename(U_120_over_limit = U_spd_limit_120) %>%
  rename(U_no_scan = U_f2scan_X) %>%
  rename(VDT_score_timeseries = VDT_score_tsc) %>%
  mutate(Sex = as.factor(Sex)) %>%
  mutate(IsManeuverPassing = factor(IsManeuverPassing, levels = c(0, 1),
                                    labels = c("Fail", "Pass"))) %>%
  rename(Maneuvertest_attempt = Maneuvertest_seq) %>%
  mutate(IsDrivingPassing = factor(IsDrivingPassing, levels = c(0, 1),
                                   labels = c("Fail", "Pass"))) %>%
  rename(Drivingtest_attempt = Drivingtest_seq) %>%
  rename(VDTtest_attempt = VDTtest_seq) %>%
  mutate(LicenseType = factor(LicenseType, levels = c("O", "G", "F", "R"),
                              labels = c("Full License", "Temporary Permit", "License Duplicate", "License Renewal"))) %>%
  rename(LicenseClass = ClassNew) %>%
  mutate(DLIssueDateAge = (DLIssueDateAge/365.25)) %>%
  mutate(FirstPermitStartAge = (FirstPermitStartAge/365.25)) %>%
  mutate(CurrentPermitStartAge = (CurrentPermitStartAge/365.25)) %>%
  mutate(AgeAtFirstORE_currentPermit = (AgeAtFirstORE_currentPermit/365.25)) %>%
  mutate(AgeAtLastORE_currentPermit = (AgeAtLastORE_currentPermit/365.25)) %>%
  mutate(AgeAtFirstORE_allPermits = (AgeAtFirstORE_allPermits/365.25)) %>%
  mutate(AgeAtLastORE_allPermits = (AgeAtLastORE_allPermits/365.25)) %>%
  mutate(DrivingSchoolFlag = factor(DrivingSchoolFlag, levels = c(0, 1),
                                    labels = c("Complete", "Not Complete"))) %>%
  mutate(PreExistingDLFlag = factor(PreExistingDLFlag, levels = c(0, 1),
                                    labels = c("PreExisting DL", "No PreExisting DL"))) %>%
  mutate(CrashDateAge = (CrashDateAge/365.25)) %>%
  mutate(Crash_Severity = as.factor(Crash_Severity)) %>%
  mutate(Crash_LightCondition = as.factor(Crash_LightCondition)) %>%
  mutate(Crash_RoadCondition = as.factor(Crash_RoadCondition)) %>%
  mutate(Crash_Weather = as.factor(Crash_Weather)) %>%
  mutate(Crash_Location = as.factor(Crash_Location)) %>%
  mutate(Crash_MannerOfCollision = as.factor(Crash_MannerOfCollision)) %>%
  mutate(Vehicle_type = as.factor(Vehicle_type)) %>%
  mutate(Vehicle_DamageScale = as.factor(Vehicle_DamageScale)) %>%
  mutate(Vehicle_Make = as.factor(Vehicle_Make)) %>%
  mutate(Vehicle_Model = as.factor(Vehicle_Model)) %>%
  mutate(Vehicle_Pre_Crash_Action = as.factor(Vehicle_Pre_Crash_Action)) %>%
  mutate(Vehicle_SequenceOfEvent_1 = as.factor(Vehicle_SequenceOfEvent_1)) %>%
  mutate(Vehicle_SequenceOfEvent_2 = as.factor(Vehicle_SequenceOfEvent_2)) %>%
  mutate(Vehicle_Circumstances = as.factor(Vehicle_Circumstances)) %>%
  mutate(Driver_InjuryType = as.factor(Driver_InjuryType)) %>%
  mutate(Driver_condition = as.factor(Driver_condition)) %>%
  mutate(Driver_Distraction = as.factor(Driver_Distraction)) %>%
  mutate(Driver_InjuryTransportation = as.factor(Driver_InjuryTransportation)) %>%
  mutate(Driver_AirbagDeploy = as.factor(Driver_AirbagDeploy)) %>%
  mutate(Driver_Ejection = as.factor(Driver_Ejection))
```
Now that the variables are reformatted for analysis, the data needs to be cleaned.
```{r eval = TRUE}
# cleaning data based on missingness in key variables
# Age and Sex: has a value for Sex and was at least 16 at time of VDT/ORE
dcl <- dc %>% 
  filter(TestDateAge >= 16) %>%
  filter(Sex != "")
# VDT: completed the entire test/course
dcl <- dcl %>%
  filter(completed_assessment_drive == "y")

# making cohorts
# crashers: experienced a police-reported crash (within available data)
crashers <- dcl %>%
  filter(!is.na(CrashDateAge))
# separating 25 & under from over 25
under25 <- dcl %>%
  filter(TestDateAge <= 25)
plus25 <- dcl %>%
  filter(TestDateAge >= 25.001)
# making sure no records were dropped & these age-based cohorts still add up to dcl total: 34046
length(under25$TestDateAge) + length(plus25$TestDateAge) 

```
Some exploratory plots to see what the population of crashers looks like
```{r eval = TRUE}
# Are there sex differences in crash severity?
sex_sev <- ggplot(data = crashers, aes(x = Sex, fill = Crash_Severity)) +
  geom_bar()
sex_sev + coord_flip()

# Is there an association between age and crash severity?
age_sev <- ggplot(data = crashers, aes(x = Crash_Severity, y = CrashDateAge)) +
  geom_boxplot(outlier.colour = "blue")
age_sev + coord_flip()

# what was the distribution of VDT scores among those who went on to crash?
vdtscore_crash <- ggplot(crashers, aes(x = VDT_score_var)) + 
  geom_histogram(binwidth = .05)
vdtscore_crash

# distribution of ages at the time of crash
agedist_crash <- ggplot(crashers, aes(x = CrashDateAge)) +
  geom_histogram(binwidth = 1)
agedist_crash
```
To Dos:
- re-order Crash_Severity levels
- build age buckets
    - 16.0-16.49
    - 16.5-16.99
    - 17.0-17.49
    - 17.5-17.99
    - 18-19
    - 19-21
    - 21-25
- data dictionary



### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
