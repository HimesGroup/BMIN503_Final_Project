---
title: "determinants of liver fibrosis"
subtitle: "BMIN503/EPID600 Final Project"
author: "Samiran Mukherjee"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required.

## Overview {#sec-overview}

Using NHANES data, we aim to predict the determinants of liver fibrosis (using the publically available fibroscan data). In addition, we will also learn to train a machine learning model to identify variables that can best predict the occurence of fibrosis. .

## Introduction {#sec-introduction}

Non-alcoholic fatty liver disease (NAFLD)  is prevalent in 30% of the US population. It is strongly associated with the presence of co-morbid metabolic risk factors like obesity, type 2 DM, hypertension and hyperlipidemia. Given that 1% patients will end up developing liver cirrhosis (fibroscan liver stiffness cut off \>14.6), it is imperative to identify preventable independent variables that may influence the occurence of the same. 

## Methods {#sec-methods}

We will be using NHANES data to assess the determinants of advanced fibrosis from the link https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?Cycle=2017-2020

From the multiple data sets availabe from 2017-2020, we will be using the following files for the following: 1) demo_data; Demographic data 2) hepq_data; Hepatitis questionnaire data 3) lab_data; Lab data 4) dmq_data; dmq (diabetes questionnaire) data 5) a1c_data; a1c (diabetes lab) data 6) hepb_data; hepatitis b data 7) hepc_data; Hepatitis c data 8) fibroscan_data; Fibroscan (firbous elastography) data 9) insurance_data; insurance data 10)alcohol_data; Alcohol data

The study plan will comprise of

1\) Identifying cases and controls using the fibroscan data

2\) Use logistic regression models to identify variables that are associated with cases

3\) Using parnsip to pass logistic regression through an engine to create a supervised machine learning model to predict the occurence of cirrhosis

4\) Plotting AUC curves for the same

6\) Next, we will use tSNE and PCA to identify possible clustering in an unsupervised approach

Install packages

```{r}
#install.packages("modelsummary")
#install.packages("ggplot2")
#install.packages("dplyr")
#install.packages("haven")
```

Load packages

```{r}
library(tidyverse)
library(modelsummary)
library(dplyr)
library(broom)
library(ggplot2)
library(dplyr)
library(haven) #required to read XPT files
```

```{r}
##read XPT files
demo_data <- read_xpt("P_DEMO.XPT") |> data.frame("P_DEMO.XPT")
hepq_data <- read_xpt("P_HEQ.XPT") |> data.frame("P_HEQ.XPT")
lab_data <- read_xpt("P_BIOPRO.XPT") |> data.frame("P_BIOPRO.XPT")
dmq_data <- read_xpt("P_DIQ.XPT") |> data.frame("P_DIQ.XPT") 
a1c_data <- read_xpt("P_GHB.XPT") |> data.frame("P_GHB.XPT")
hepb_data <- read_xpt("P_HEPBD.XPT") |> data.frame("P_HEPBD.XPT")
hepc_data <- read_xpt("P_HEPC.XPT") |> data.frame("P_HEPC.XPT")
fibroscan_data <- read_xpt("P_LUX.XPT") |> data.frame("P_LUX.XPT")
insurance_data <- read_xpt("P_HIQ.XPT") |> data.frame("P_HIQ.XPT")
alcohol_data <-  read_xpt("P_ALQ.XPT") |> data.frame("P_ALQ.XPT")
bodymeasurements_data <-  read_xpt("P_BMX.XPT") |> data.frame("P_BMX.XPT")

#Merge each of the tables to create one master data sheet. This has to happen step-wise
merged_df <- merge(demo_data, hepq_data, by = "SEQN")
merged_df <- merge(merged_df, hepb_data, by = "SEQN")
merged_df <- merge(merged_df, hepc_data, by = "SEQN")
merged_df <- merge(merged_df, lab_data, by = "SEQN")
merged_df <- merge(merged_df, dmq_data, by = "SEQN")
merged_df <- merge(merged_df, a1c_data, by = "SEQN")
merged_df <- merge(merged_df, fibroscan_data, by = "SEQN")
merged_df <- merge(merged_df, insurance_data, by = "SEQN")
merged_df <- merge(merged_df, alcohol_data, by = "SEQN")
merged_df <- merge(merged_df, bodymeasurements_data, by = "SEQN")

```

Now to modify each of the variables names of interest accordingly

```{r}
#Alcohol 
merged_df$etoh <- merged_df$ALQ151 #1->Y, 2-> No, 7-> refused, 9-> ?, .-> Missing

#biomarkers (continuous variables)
merged_df$alt <- merged_df$LBXSATSI #Values .-> Missing
merged_df$alb <- merged_df$LBXSAL 
merged_df$alp <- merged_df$LBXSAPSI
merged_df$ast <- merged_df$LBXSASSI 
merged_df$urea <- merged_df$LBXSBU
merged_df$cr <- merged_df$LBXSCR
merged_df$ggt <- merged_df$LBXSGTSI
merged_df$ldh <- merged_df$LBXSLDSI
merged_df$na <- merged_df$LBXSNASI
merged_df$tbil <- merged_df$LBXSTB
merged_df$chol <- merged_df$LBXSCH
merged_df$tg <- merged_df$LBXSTR

#HepQ data
merged_df$hb_self_reported <- merged_df$HEQ010 #1 Yes, 2 No, 7 Refused, 9 ?, . missing)
merged_df$hb_self_reported_treated <- merged_df$HEQ020 #Same as above
merged_df$hc_self_reported <- merged_df$HEQ030
merged_df$hc_self_reported_treated <- merged_df$HEQ040

#HepB data
merged_df$hbcore_positive <- merged_df$LBXHBC #1 yes, 2 neg, 3 +/-, . missing
merged_df$hbsag_positive <- merged_df$LBDHBG #1 yes, 2 neg, 3 +/-, . missing

#HepC data
merged_df$hcrna <- merged_df$LBXHCR #1 yes, 2 neg, 3 neg HCAb
merged_df$hcab <- merged_df$LBDHCI # 1 yes, 2 neg, 3 neg screening , 4 pos HCVRNA, . missing
merged_df$hcgenotype <- merged_df$LBXHCG # 1 1a, 2 1b, 3 1a/b?, 4 2, 5 3, 6 4, 7 5, 8, 6, 9 1

#A1c data
merged_df$ha1c <- merged_df$LBXGH #2.8-16.2 

#fibroscan data
merged_df$fibroscan_meanstiffness_kpa <- merged_df$LUXSMED
merged_df$fibroscan_stiffnessiqr <- merged_df$LUXSIQR
merged_df$fibroscan_cap <- merged_df$LUXCAPM
merged_df$hc_self_cpiqr <- merged_df$LUXCPIQR

#Insurance data 
merged_df$insurance_covered <- merged_df$HIQ011 # 1 yes, 2 no, 7 refused, 9 ?, . missing

#Demographic data 
merged_df$demo_gender <- merged_df$RIAGENDR #1 male, 2 female
merged_df$demo_age <- merged_df$RIDAGEYR # 0-79 and >80
merged_df$demo_race <- merged_df$RIDRETH3 # 1 Mexican american, 2 other hisp, 3 NH White, 4 NH black, 6 NH Asian, 7 other race
merged_df$demo_education <- merged_df$DMDEDUC2 #1 <9thgr, 2 9-11th gr, 3 HSGrad, 4 college, 5 college grad

#Body measures
merged_df$body_bmi <- merged_df$BMXBMI

#convert data type to  factors / numerics
merged_df$hb_self_reported <- as.factor(merged_df$hb_self_reported)
merged_df$hb_self_reported_treated <- as.factor(merged_df$hb_self_reported_treated)
merged_df$hc_self_reported <- as.factor(merged_df$hc_self_reported)
merged_df$hc_self_reported_treated <- as.factor(merged_df$hc_self_reported_treated)
merged_df$hbcore_positive <- as.factor(merged_df$hbcore_positive)
merged_df$hbsag_positive <- as.factor(merged_df$hbsag_positive)
merged_df$hcrna <- as.factor(merged_df$hcrna)
merged_df$hcab <- as.factor(merged_df$hcab)
merged_df$hcgenotype <- as.factor(merged_df$hcgenotype )
merged_df$insurance_covered <- as.factor(merged_df$insurance_covered)
merged_df$demo_gender <- as.factor(merged_df$demo_gender)
merged_df$demo_race <- as.factor(merged_df$demo_race)
merged_df$demo_education <- as.factor(merged_df$demo_education)

```

## Definition of Phenotype

***Cases:***

[1) Cirrhosis]{.underline}

We will use a fibroscan mean liver stiffness measurement of \>20 kPA for the definition of cirrhosis https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1856085/ https://journals.lww.com/hep/Fulltext/2023/05000/AASLD_Practice_Guidance_on_the_clinical_assessment.31.aspx\>

[2) Steatosis]{.underline}

Steatosis cut offs using fibroscan (https://pubmed.ncbi.nlm.nih.gov/30689971/) S1 302-331 S2 331-337 S3 \>337

***Controls:***

1\) [Steatosis controls]{.underline}: Fibroscan Stiffness \<7 and ALT\<30 M and \<20 F and CAP \< 288

2\) [Cirrhosis controls]{.underline}: Fibroscan \<8kPA

```{r}





```

```{r}





```

```{r}





```

```{r}





```

```{r}





```

```{r}





```

```{r}





```

## Results {#sec-results}

Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

## Conclusion

This the conclusion. The @sec-results can be invoked if you'd like.
