---
title: "Blood Cultures Utilization at HUP"
author: "Annie Chen"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.

### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

The goal of my project is to characterize the use and effectiveness of blood cultures for detecting bloodstream infections in patients at the Hospital for the University of Pennsylvania (HUP). I will be using data from monthly reports of blood cultures at HUP for FY2015.

### Introduction 
In the first paragraph, describe the problem addressed, its significance, and some background to motivate the problem.

In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

Blood cultures are frequently used and are important for detecting the presence of microbes in the bloodstream. However, excessive use of blood cultures can be detrimental to patients and may not significantly contribute to patient care. Furthermore, there are different guidelines for blood culture utilization, and it is unclear to what extent health professionals are aware of these guidelines. Investigating blood culture utilization is critical for improving the practice of blood cultures, their effectiveness in detecting bloodstream infections, and patient care management. In addition, analyzing blood cultures data may reveal information on the frequency of false positives due to contamination and the prevalence of bacteremia in different patient populations. In addiiton, analysis of blood cultures utilization data may result in the dentification of low-risk populations for bacteremia, which may will help reduce unnecessary use of blood cultures. Finally, analysis of high-utilizers of blood cultures may also be useful for addressing the practice of blood cultures utilization.

This is an interdisciplinary problem that draws knowledge from data science, clinical microbiology, statistics, and data visualization. 



### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

I will be using monthly reports of blood cultures utilization at HUP for FY2015. This is a record that includes information for each patient who had blood drawn for a blood culture test. The report shows the number of sets of blood cultures taken per day, the location by hospital floor, whether a phlebotomist drew the culture, and the final result (ex. no growth or the name of the microbial species isolated). 

I will first use descriptive statistics to look at the distribution of sets of blood cultures taken per patient and by hospital floor. I will also look at the distribution of pathogens isolated. Then, I will analyze the number of follow-up cultures taken after a positive identification to test the hypothesis that the number of sets of blood cultures taken is linked to the organism identified. I will also analyze the high utilizers to see what floors they are coming from and whether there is an association.

```{r Load libraries and read in data}
library(ggplot2)
library(dplyr)
library(magrittr)
library(gdata)
library(lubridate)

getwd()
inFile <- "FY15_deidentified_data-2015-11-22-revised.txt"
FY15_deID <- read.table(inFile,header=T, sep="\t", quote="",na.strings="")

str(FY15_deID)

#change Study_ID from integers to factors
FY15_deID$Study_ID <- factor(FY15_deID$Study_ID)

sum(complete.cases(FY15_deID))
#11 not complete cases. 8 have abnormal results (ex. test reordered). 2 are missing location.
View(FY15_deID[!complete.cases(FY15_deID),])
#1 is aerobic gram pos rods not listeria. Final_report should be "GPR NLIS".

FY15_deID[10875,"Final_Report"] <- "GPR NLIS"

#change Julian date so that day 1 is July 1st.
FY15_deID %<>%
  mutate(Julian = ifelse(Julian >=182,Julian-181,Julian+184))

#sort by Study_ID and then Julian so that it's in chronological order for each patient
FY15_deID %<>% arrange(Study_ID,Julian)
```


### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

I am first looking at the overall distribution of number of blood cultures taken per patient and by location. This is a highly skewed distribution. Of 11,737 patients, the number of sets taken ranges from 1 to 90, with a mean of 3.899 sets. 

```{r Descriptive statistics on entire dataset}
#gives the number of sets of bc/patient and the period of time during which blood cultures were taken during the year.
by_ID <- FY15_deID %>%
  group_by(Study_ID) %>%
  summarise(count=n(),
            Range=diff(range(Julian))) %>%
  arrange(desc(count))

nrow(by_ID)
head(by_ID)

summary(by_ID$count)
summary(by_ID$Range)

ggplot(by_ID, aes(x=count)) +
  geom_histogram(binwidth=1) +
  theme_bw() + 
  scale_y_continuous(expand=c(0,0)) +
  scale_x_continuous(expand=c(0,0)) +
  labs(x="Number of blood cultures/patient", y="Count",
       title="Total number of sets taken per patient") +
  geom_vline(xintercept=median(by_ID$count),colour="red")

#Look at the distribution of total # of bc by location
by_loc <- FY15_deID %>%
  filter(!is.na(Location)) %>%
  group_by(Location) %>%
  summarise(count=n()) %>%
  arrange(desc(count))

nrow(by_loc)
head(by_loc)
summary(by_loc$count)

ggplot(by_loc, aes(x=count)) +
  geom_histogram(binwidth=50) +
  theme_bw() + 
  scale_y_continuous(expand=c(0,0)) +
  scale_x_continuous(expand=c(0,0)) +
  labs(x="Number of blood cultures/location", 
       y="Count",
       title="Total number of sets taken per location") +
  geom_vline(xintercept=median(by_loc$count),colour="red")


```



