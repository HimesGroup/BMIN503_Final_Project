---
title: "<br> Mobility Restrictions and the Spread of COVID-19 in the United States"
subtitle: "BMIN503/EPID600 Final Project"
author: 'Quynh Long Khuong'
date: last-modified
date-format: "MM-DD-YYYY"
title-block-banner: "#011F5B"
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    theme: lumen
    toc: true
    toc-location: left
    toc-title: Summary
    urlcolor: orange
    linkcolor: orange
    df_print: kable
    # code-fold: true
execute:
  warning: false
bibliography: references.bib
csl: nature.csl
css: style.css
---

------------------------------------------------------------------------

```{r}
library(tidyverse)
library(lubridate)
library(urbnmapr)
library(zoo)
library(psych)
library(meta)
```

## Overview {#sec-overview}

In this project, we aim to investigate the impact of mobility restrictions on the spread of COVID-19 in the U.S. The analysis takes into account other factors, including the government response to COVID-19, testing, and vaccination. The main sources of data include: (1) [US COVID-19 cases and deaths by state](https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/) for number of new cases and new deaths of COVID-19 by state, (2) [Google mobility data](https://www.google.com/covid19/mobility/) for mobility information, and (3) [Coronavirus Pandemic (COVID-19)](https://ourworldindata.org/coronavirus) from *Our World in Data*. (See @tbl-table1)


This assignment is conducted with advice of Dr. John H. Holmes, PhD, FACE, FACMI, Professor of Medical Informatics in Epidemiology.

My GitHub repo for this project can be found [here](https://github.com/khuongquynhlong/BMIN503_Final_Project)


## Introduction {#sec-introduction}

Throughout the COVID-19 pandemic, human mobility restrictions were one of the main policies implemented in many countries with the aim of reducing the transmission of SARS-CoV-2. [@flaxman2020estimating; @lancet2020india; @signorelli2020covid] Such restrictions include physical distancing and community containment measures to reduce public transport use, public gatherings, school closures, and encouraging working from home where possible. Prior experiences with the 2009 H1N1 influenza [@chowell2011characterizing] and Ebola [@peak2018population] provided evidence for the effectiveness of these interventions in reducing disease transmission. However, the effectiveness of imposing mobility restrictions as a policy for controlling COVID-19 outbreaks has been controversial. Recent studies found that travel restrictions were effective in the early stages of the outbreak but may be less useful when the disease is widespread.[@kraemer2020effect; @oh2021mobility] Furthermore, these restrictions have also led to enormous economic losses.[@han2020lessons] Estimates suggest that global GDP growth has fallen by as much as 10%, at least part of which can be attributed to these mobility restrictions. [@hatzius2020sudden] Hence, it is critical to quantify the effectiveness of decisions to apply large-scale mobility restrictions in limiting the spread of the pandemic.

This study was conducted to investigate the impact of mobility restrictions on the spread of COVID-19 in the U.S. In fact, the U.S. experienced significant challenges in managing the pandemic in the early stages due to the large population, diverse demographics, and different healthcare settings across states. The findings of this project might not only support the current response but also contribute valuable evidence to the global scientific community, informing future disease control strategies. This evidence guides policymakers in future outbreaks, enabling timely interventions, especially when vaccination is not available.


## Methods {#sec-methods}

### Data sources

| Dataset                                       | Measurement | Temporal coverage  | Source             |
|-----------------------------------------------|-------------|--------------------|--------------------|
| COVID cases                                   | Daily       | Jan 2020-present   | [usafacts.org](https://usafacts.org/visualizations/coronavirus-covid-19-spread-map)       |
| COVID deaths                                  | Daily       | Jan 2020-present   | [usafacts.org](https://usafacts.org/visualizations/coronavirus-covid-19-spread-map)        |
| The U.S. population                           |             |                    | [usafacts.org](https://usafacts.org/visualizations/coronavirus-covid-19-spread-map)        |
| Google Mobility                               | Daily       | Feb 2020-present | [google.com](https://www.google.com/covid19/mobility)         |
| Vaccination, testing, and Government response | Daily       | Jan 2020-present   | [ourworldindata.org](https://ourworldindata.org/coronavirus) |

: Datasets Overview {#tbl-table1}

@tbl-table1 summrizes the data sources used in this study


#### COVID-19 cases and deaths

We obtained the data for COVID-19 cases and deaths from the USAFacts official website (https://usafacts.org/visualizations/coronavirus-covid-19-spread-map). USAFacts is a non-profit civic initiative that aims to provide a data-driven portrait of the American population, U.S. government finances, and the government's impact on society. For COVID-19, USAFacts offers real-time pandemic data from all 50 states [Citation].

#### Google Mobility Dataset

For mobility measures, we used the Google mobility dataset. The data contain information about the daily amount of visitors to a specific place, including (1) groceries and pharmacies, (2) transit stations, (3) retail and recreation venues, (4) workplaces, (5) parks, and (6) residential areas. The measurements were based on mobile device-based global positioning system (GPS) [Citation]. The data were measured from February 15, 2020 to present.

#### Vaccination, testing, and Government responses
We collected data on vaccination, testing policy, and Government responses from Our World in Data (OWID). The OWID is managed by a non-profit organization, providing rich datasets for the COVID-19 pandemic over the globe, including cases, deaths, vaccination, testing, policies, population characteristics, etc [Citation]. 



### Variables

#### Outcomes

The main outcome of this study was the growth rate (GR) of cases. The GR indicates how fast the spread of COVID-19 is. In this study, we defined GR of cases for specific state ith and date tth as the logarithmic rate of change for the new cases (C) in the preceding three days relative to the logarithmic rate of change for the new cases in the preceding seven days.

$$GR_i^t = \frac{log(\sum_{t-2}^{t}\frac{C_i^t}{3})}{log(\sum_{t-6}^{t}\frac{C_i^t}{7})}$$

#### Independent variables

The focal exposure in this study was mobility, derived from the original values of the Google mobility dataset. These mobility values reflect the median change (in percentage) in the number of visitors to specific categories of locations compared to the reference period (between January 3 and February 6, 2020, before the declaration of COVID-19 as a global pandemic). These data were collected at the state level.

#### Covariates

The covariates included 

- Fully vaccination, which was defined as the percentage of the population having fully two required doses of COVID-19 vaccination. 

- Testing policy, which was a categorical variable indicating: 1 "no testing policy," 2 "only those who had symptoms and also met specific criteria (e.g., key workers, admitted to hospital, came into contact with a known case, returned from overseas), 3 "testing of anyone showing COVID-19 symptoms", and 4 "open public testing (e.g., "drive through" testing available to asymptomatic people).

-	Stringency index, which was a composite measure of nine of the response metrics: school closures; workplace closures; cancellation of public events; restrictions on public gatherings; closures of public transport; stay-at-home requirements; public information campaigns; restrictions on internal movements; and international travel controls [Citation]. The values of the stringency index were calculated as the mean scores of the nine metrics, with the range of 0 to 100. A higher value of the stringency index indicates a stricter response.



### Data preparation

::: panel-tabset
#### COVID-19

```{r}
#---------- COVID cases and deaths
df_case <- read_csv("Data/covid_confirmed_usafacts.csv")
df_death <- read_csv("Data/covid_deaths_usafacts.csv")
df_pop <- read_csv("Data/covid_county_population_usafacts.csv")

#----- Case: aggregate at state level
df_case <- df_case |>
  rename(county_name = `County Name`) |>
  gather(-c(countyFIPS, county_name, State, StateFIPS), 
            key = "date", value = "new_cases") |>
  mutate(date = ymd(date)) |> 
  group_by(State, date) |>
  summarise(new_cases_cum = sum(new_cases, na.rm = T)) |>
  ungroup() |>
  group_by(State) |>
  mutate(new_cases_cum_lag1 = lag(new_cases_cum, 1),
         new_cases = new_cases_cum - new_cases_cum_lag1,
         new_cases = ifelse(new_cases < 0, 0, new_cases)) |>
  ungroup()|>
  select(-new_cases_cum_lag1)

#----- Deaths: aggregate at state level
df_death <- df_death |>
  rename(county_name = `County Name`) |>
  gather(-c(countyFIPS, county_name, State, StateFIPS), 
         key = "date", value = "new_deaths") |>
  mutate(date = ymd(date))|> 
  group_by(State, date) |>
  summarise(new_deaths_cum = sum(new_deaths, na.rm = T)) |>
  ungroup()|>
  group_by(State) |>
  mutate(new_deaths_cum_lag1 = lag(new_deaths_cum, 1),
         new_deaths = new_deaths_cum - new_deaths_cum_lag1,
         new_deaths = ifelse(new_deaths < 0, 0, new_deaths)) |>
  ungroup() |>
  select(-new_deaths_cum_lag1)

#----- Population: aggregate at state level
df_pop <- df_pop |> rename(county_name_pop = `County Name`) |>
  group_by(State) |>
  summarise(population = sum(population, na.rm = T)) |>
  ungroup()

#----- Merge new case, death, and population datasets
df_oc <- df_case |> left_join(df_death, by = c("State", "date")) |>
  left_join(df_pop, by = c("State"))

# Get counties shapefile: to get full state name from abbriviation
st_name_full <- urbnmapr::counties |>
  mutate(fips.code = as.numeric(county_fips)) |>
  group_by(state_abbv, state_name) |>
  slice(1) |>
  select(state_abbv, state_name)

# Create full name for state
df_oc <- df_oc |> rename(state_abbv = State) |>
  left_join(st_name_full, by = "state_abbv")
```

#### Mobility data

```{r}
#---------- Google Mobility data
df_mob <- read_csv("Data/Global_Mobility_Report.csv")

df_mob <- df_mob |> filter(country_region == "United States") |> 
  filter(sub_region_1 != "") |>
  rename(
    state_name = sub_region_1,
    grocery_pharm = grocery_and_pharmacy_percent_change_from_baseline,
    retail_recreation = retail_and_recreation_percent_change_from_baseline,
    park = parks_percent_change_from_baseline,
    transit = transit_stations_percent_change_from_baseline,
    workplace = workplaces_percent_change_from_baseline,
    residential = residential_percent_change_from_baseline,
  ) |>
  select(state_name, date, grocery_pharm, retail_recreation, park,
         transit, workplace, residential)

# Aggregated at state level
df_mob <- df_mob |> group_by(state_name, date) |>
  summarise(grocery_pharm = mean(grocery_pharm, na.rm = T)/100,
            retail_recreation = mean(retail_recreation, na.rm = T)/100,
            retail_recreation = mean(retail_recreation, na.rm = T)/100,
            park = mean(park, na.rm = T)/100,
            transit = mean(transit, na.rm = T)/100,
            workplace = mean(workplace, na.rm = T)/100,
            residential = mean(residential, na.rm = T)/100)
```

#### Vaccination

```{r}
#---------- Testing, vaccination
# Data from Our World in Data
df_owid <- read_csv("Data/owid-covid-data.csv") |>
  filter(location == "United States")

df_owid <- df_owid |>
  select(date, reproduction_rate, new_tests_smoothed_per_thousand, tests_per_case,
         total_vaccinations_per_hundred, people_fully_vaccinated_per_hundred,
         stringency_index) |>
  rename(
    test_thousand = new_tests_smoothed_per_thousand,
    vacc_any = total_vaccinations_per_hundred,
    vacc_fully = people_fully_vaccinated_per_hundred,
  )
```

#### Testing policy

```{r}
#---------- Testing policy
# Data from Our World in Data
df_test_pol <- read_csv("Data/covid-19-testing-policy.csv") |>
  filter(Entity == "United States") |>
  select(Day, testing_policy) |>
  rename(date = Day)
```

#### Merging all data

```{r}
#---------- Merge all data
# setdiff(df_oc$state_name, df_mob$state_name)

df <- df_oc |> left_join(df_mob, by = c("state_name", "date")) |> 
  left_join(df_owid, by = "date") |> 
  left_join(df_test_pol, by = "date")

# Exclude Omicron variant
df <- df |>
  filter(date >= ymd("2020-02-15") & date < ymd("2021-12-01"))

# Replace missing values (testing, vaccine were not available)
df <- df |>
  mutate(
    test_thousand = ifelse(is.na(test_thousand), 0, test_thousand),
    tests_per_case = ifelse(is.na(tests_per_case), 0, tests_per_case),
    vacc_any = ifelse(is.na(vacc_any), 0, vacc_any),
    vacc_fully = ifelse(is.na(vacc_fully), 0, vacc_fully),
    testing_policy = as.factor(testing_policy)
  )

dim(df)

head(df, 10) |> knitr::kable()
```

:::


## Statistical analysis 

### Descriptive statistics

For descriptive statistics, we created the interactive choropleth maps to show the GR and six categories of mobilities for all 50 states over time. The scatter plots were used to visualize the relationship between GR and mobilities. 

### Effects of mobility restrictions on spread of COVID-19

To evaluate the effects of mobility restrictions on the spread of COVID-19, we first restricted the data on the date before omicron variant was detected (i.e., November 30, 2021). 
Multiple linear regressions were performed to estimate the relationship of interest. The models were fitted separately for each state. The random effect meta-analysis was used to pool the estimates across 50 states and the capital. The I2 statistic was used to evaluate the heterogeneity in the estimates across states.
As mobility required delayed time to affect the GR of cases of COVID-19, we applied the lag effect of mobility. Based on the previous study, the lag of 11 days was considered as the optimal lag for mobility on GR of cases. Therefore, we selected a lag of 11 days in our main analysis. 

In the main analysis, the composite mobility was obtained by taking the first component of the principal component analysis (PCA), which explained the largest variation of the six mobilities. In the subsequent analysis, each of the six mobilities was analyzed. 

All the models were adjusted for full vaccination, testing policy, and stringency index. All these confounders were applied with the lag effects of two weeks.

### Stratified analysis

We assume that the effects of mobility restrictions on the spread of COVID-19 are different across the periods of COVID-19. Therefore, we conducted the analysis stratified by two periods: (1) from February 15, 2020 (when the first mobility measure was available) to the date of 10% of the population received fully vaccination (before vaccine period), (2) after the date of 10% of the population received fully vaccination (after vaccine period).

### Sensitivity analysis
We did sensitivity analysis to evaluate the relationship of interest under different lag effects. Therefore, we redo the analyses with different lag of mobility, from 1 day to 21 days prior to the GR.


::: panel-tabset

#### Outcome

```{r}
#---------- Outcome
#===============================================================================
df <- df |> 
  group_by(state_name) |>
  mutate(
    GR_case_num = lag(rollapply(new_cases, 3, mean, fill = NA), 1),
    GR_case_den = lag(rollapply(new_cases, 7, mean, fill = NA), 3),
    GR_case = log(GR_case_num)/log(GR_case_den)
  ) |> ungroup() 


df <- df |>
  mutate(GR_case = ifelse(is.nan(GR_case), 0, GR_case)) |>
  mutate(GR_case = ifelse(is.infinite(GR_case), NA, GR_case))


df |> select(state_name, new_cases, GR_case_num, GR_case_den, GR_case) |> 
  head(10) |>
  knitr::kable()
```

#### Mobility

```{r}
#---------- Composite mobility (PCA analysis)
#===============================================================================
# % missing is very small, We imputed by the mean, for PCA
sapply(df[, c(9:14)], function(x){sum(is.na(x))})

df_PCA <- df[, c(9:14)] |>
  mutate(
    park = ifelse(is.na(park), mean(park, na.rm = T), park),
    transit = ifelse(is.na(transit), mean(transit, na.rm = T), transit)
  )

pc <- prcomp(df_PCA, center = TRUE, scale. = TRUE)
pc_sum <- summary(pc)

# The 1st component explains 66.4% variation of six mobility parameters
pc_sum$importance[2, ]
```

```{r}
# Merge the composite mobility (PCA analysis) to dataset
PCA_pred <- predict(pc, df_PCA)
df$mobi_comp <- PCA_pred[, 1]
```
:::


## Results {#sec-results}

### Descriptive statistics


### Effects of mobility restrictions on spread of COVID-19

::: panel-tabset

#### Groceries & pharmacies

```{r}
st_name <- df$state_name |> unique()
lag_name <- paste0(rep(c("beta", "se"), 15), rep(c(7:21), each = 2))

gro_pharm_mat_earl <- matrix(ncol = 30, nrow = length(st_name))
gro_pharm_mat_late <- matrix(ncol = 30, nrow = length(st_name))

for (i in seq(length(st_name))) {
  # Data for each state
  df_sub <- df |>
    filter(state_name == st_name[i]) |>
    mutate(vacc_fully_lag = lag(vacc_fully, 14),
           stringency_index_lag = lag(stringency_index, 14),
           testing_policy_lag = lag(testing_policy, 14))
  
  # Apply different lags
  for (j in 1:15) {
    df_sub <- df_sub |>
      mutate(grocery_pharm_lag = lag(grocery_pharm, j+6))
    # Early period
    m1 <- lm(GR_case ~ grocery_pharm_lag + vacc_fully_lag + stringency_index_lag, 
             data = df_sub |> 
               filter(vacc_fully_lag < 10))
    
    # Late period
    m2 <- lm(GR_case ~ grocery_pharm_lag + vacc_fully_lag + stringency_index_lag, 
             data = df_sub |> 
               filter(vacc_fully_lag >= 10))
    
    m1_summ <- summary(m1)
    m2_summ <- summary(m2)
    
    # Store results to 3 matrices
    gro_pharm_mat_earl[i, j*2-1] <- m1_summ$coefficients[2, 1]
    gro_pharm_mat_earl[i, j*2] <- m1_summ$coefficients[2, 2]
    
    gro_pharm_mat_late[i, j*2-1] <- m2_summ$coefficients[2, 1]
    gro_pharm_mat_late[i, j*2] <- m2_summ$coefficients[2, 2]
  }
}

# Convert to dataframes
gro_pharm_mat_earl <- gro_pharm_mat_earl |> as.data.frame()
gro_pharm_mat_late <- gro_pharm_mat_late |> as.data.frame()

names(gro_pharm_mat_earl) <- lag_name
names(gro_pharm_mat_late) <- lag_name

gro_pharm_mat_earl$state_name <- st_name
gro_pharm_mat_late$state_name <- st_name
```




**Main analysis: Before vaccine period**

```{r, fig.height=12, fig.width=8}
gro_pharm_earl_meta <- metagen(TE = beta11,
                          seTE = se11,
                          studlab = state_name,
                          method.tau = "REML",
                          common = FALSE,
                          data = gro_pharm_mat_earl,
                          title = "Effect of mobility of groceries & pharmacies on growth rate, before vaccine")
forest(gro_pharm_earl_meta)
```


**Main analysis: After vaccine period**

```{r, fig.height=12, fig.width=8}
gro_pharm_late_meta <- metagen(TE = beta11,
                          seTE = se11,
                          studlab = state_name,
                          method.tau = "REML",
                          common = FALSE,
                          data = gro_pharm_mat_late,
                          title = "Effect of mobility of groceries & pharmacies on growth rate, after vaccine")
forest(gro_pharm_late_meta)
```


**Sensitivity analysis**

```{r}
gro_pharm_ear_sen_mat <- matrix(ncol = 2, nrow = 15)
gro_pharm_late_sen_mat <- matrix(ncol = 2, nrow = 15)
  
for (i in 4:15) {
  gro_pharm_meta_i <- metagen(TE = gro_pharm_mat_earl[, i*2-1],
                          seTE = gro_pharm_mat_earl[, i*2],
                          common = FALSE)
  gro_pharm_meta_i_late <- metagen(TE = gro_pharm_mat_late[, i*2-1],
                                   seTE = gro_pharm_mat_late[, i*2],
                                   common = FALSE)
  # Store result to matrices
  gro_pharm_ear_sen_mat[i, 1] <- gro_pharm_meta_i$TE.random
  gro_pharm_ear_sen_mat[i, 2] <- gro_pharm_meta_i$seTE.random
  
  gro_pharm_late_sen_mat[i, 1] <- gro_pharm_meta_i_late$TE.random
  gro_pharm_late_sen_mat[i, 2] <- gro_pharm_meta_i_late$seTE.random
}

gro_pharm_ear_sen_mat <- as.data.frame(gro_pharm_ear_sen_mat)
gro_pharm_late_sen_mat <- as.data.frame(gro_pharm_late_sen_mat)

names(gro_pharm_ear_sen_mat) <- c("pooled_beta", "se")
gro_pharm_ear_sen_mat$lag <- 7:21

names(gro_pharm_late_sen_mat) <- c("pooled_beta", "se")
gro_pharm_late_sen_mat$lag <- 7:21

gro_pharm_sen_mat <- rbind(gro_pharm_ear_sen_mat, gro_pharm_late_sen_mat) |>
  mutate(low = pooled_beta - 1.96*se,
         high = pooled_beta + 1.96*se)

gro_pharm_sen_mat$period <- rep(c("Before vaccine", "After vaccine"), each = 15)

# Forest plot
dodge <- position_dodge(width = 0.5)

gro_pharm_sen_mat |> na.omit() |>
  ggplot(aes(as.factor(lag), y = pooled_beta, ymin = low, ymax = high, 
             color = period)) +
  geom_errorbar(width = 0.5, size = 1, position = dodge) +
  geom_point(size = 2, shape = 21, fill="white", position = dodge) +
  geom_hline(yintercept = 0, linetype = 2, col = "gray10", size = 1) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  scale_y_continuous(limits = c(-0.3, 0.3)) +
  theme_bw() + 
  theme(legend.position = "top") +
  labs(
    x = "Lag of mobility, day",
    y = "Effect of monility on growth rate",
    color = NULL
  )
```

#### Transit station

#### Retail and recreation venues

#### Workplaces

#### Parks

#### Residential areas

:::



## Conclusion

## References
