---
title: "The effects of COVID-19 on rabies dynamics in Arequipa, Peru"
author: "Brinkley Raynor"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***

### Overview

+ Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

Over the summer of 2020, I worked to create a compartmental SEIR model of rabies in Arequipa, Peru investigating how COVID-19 control measures effected canine rabies dynamics. As an extension of the project, I am implementing a stochastic model as well as streamlining my old code using dplyr. 

Data was collected from several sources. Information on positive cases comes from collaboration with the Peru Ministry of Health. Demographic data used to paramaterize the model comes from 5 years worth of survey data collected after the vaccination campaign by the Castillo team. 

Ricardo Castillo-Neyra is a veterinarian and epidemiologist who is an expert in canine rabies in Peru. From Ricardo, I learned a lot about the social context of rabies in Arequipa, about the types of restrictions that occured due to COVID and about rabies dynamics.

Mike Levy is an epidemiologist who has worked in Arequipa for years. From Mike, I learned a lot about Arequipa. He is also an expert in mathematical modelling and I have worked closely with him to create the models. 

Julianna Shinnick is a nurse and staff member in the Castillo lab. Julianna has been investigating how public health emergency (such as SARS-CoV-1, SARS-CoV-2, Ebola, Zika) has disrupted established disease control efforts. 

Final project link: 

### Introduction 

+Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

COVID-19 has been devestating world-wide; the media has extensively covered case counts, death rates, the lagging economy, and peoples fears and low morals. However, less understood and explored are how measures to fight COVID-19 are effecting other public health initiatives. One example is canine rabies in Arequipa, Peru. When SARS-CoV-2 arrived to Peru in early March, 2020 mandates including orders to social distance, curfews and work from home were implemented. Due to this, several vital canine rabies control measures were impacted.  

To understand how rabies dynamics may be impacted, several social and biological factors must be considered. We identified 2 main areas were COVID-19 measures have effected rabies control programs. First, every summer annually a mass vaccination campaign is held city wide to offer free rabies vaccinations to peoples pets. With COVID-19,t the campaign was delayed and there were even talks of cancelling it. Second, many surveillance activities were halted as public health officials were unable to leave home.

Peru, and the rest of Latin America, has made enormous strides towards the OIE goal of eliminating canine mediated human rabies by 2030. However, we are worried that COVID-19 and the resulting control measures may disrupt and endanger the progress towards this goal. To explore, possible effects we create a mathematical model to examine rabies dynamics with surveillance and vaccination coverage impacted. 

### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 


#### Data
Data files will not be made publically available as they contain confidential information.

1. Load libraries needed to clean and analyze data.
```{r}
#Load libaries
suppressMessages(suppressWarnings(library(deSolve)))
suppressMessages(suppressWarnings(library(ggplot2)))
suppressMessages(suppressWarnings(library(dplyr)))
suppressMessages(suppressWarnings(library(stringr)))
suppressMessages(suppressWarnings(library(rgdal)))
suppressMessages(suppressWarnings(library(MASS)))
#suppressMessages(suppressWarnings(library(data.table)))
```

2. Read in and clean data on rabies cases. Data come from collaborators at the Ministry of Health and from case reports from Elvis working in the field. 
```{r}
#Load data
df      <- read.csv("~/Rabies/models/Data/RabiesCaseData_7May2020.csv")  #Rabies case report
df <- df %>%
  rename(LabID = Ã¯..LabID) %>%
  mutate(
    Symptoms_date         = as.Date(Symptoms_date,         "%d/%m/%Y"),
    Complaint_date        = as.Date(Complaint_date,        "%d/%m/%Y"),
    Death_date            = as.Date(Death_date,            "%d/%m/%Y"),
    Obtained_date         = as.Date(Obtained_date,         "%d/%m/%Y"),
    Received_date         = as.Date(Received_date,         "%d/%m/%Y"),
    Result_date           = as.Date(Result_date,           "%d/%m/%Y"),
    ContainmentStart_date = as.Date(ContainmentStart_date, "%d/%m/%Y"),
    ContainmentOther_date = as.Date(ContainmentOther_date, "%d/%m/%Y"),
    MedicalAttention_date = as.Date(MedicalAttention_date, "%d/%m/%Y"),
    DateCaseBitten        = as.Date(DateCaseBitten,        "%d/%m/%Y"), 
    NumDogsCaseBit        = as.numeric(as.character(NumDogsCaseBit)),
    Month                 = as.numeric(as.character(Month)), #Format as number
    Years                 = as.numeric(as.character(Years)), #Format as number
    Age                   = Years*365.25 + Month*30.4375     #Calculate age in days
  )

rabies  <- read.csv("~/Rabies/models/Data/Rabies_IncidenceTable.csv")   #Rabies incidence table
```

3. Read in and clean data dog population data from 4 years of longitudinal surveys conducted by the team in Arequipa
```{r}
dogs1   <- read.csv("~/Rabies/rabia_ASA_encuesta_2017/resultados/dogs2016_2017_10Abr18.csv") #2016 & 2017 data

#2016 survey data
df_2016 <- subset(dogs1, !is.na(dogs1$EDAD_M16)) %>%
  dplyr::select(UNICODE, NOMBRE, SEXO, EDAD_A16, EDAD_M16, VACUNADO16, FECHA_VAC16, ACCESO_CALLE16) %>%
  rename(Unicdoe = UNICODE,
         Name = NOMBRE,
         Sex = SEXO,
         Years = EDAD_A16,
         Months = EDAD_M16,
         Vaccine = VACUNADO16,
         Date = FECHA_VAC16,
         Restriction = ACCESO_CALLE16) %>%
  mutate(Date= str_sub(Date, end=-6),
         Date= as.Date(Date, "%d/%m/%y"))

#2017 survey data
df_2017 <- subset(dogs1, !is.na(dogs1$EDAD_MESES17))%>%
  dplyr::select(UNICODE, NOMBRE, SEXO, EDAD_ANIO17, EDAD_MESES17, ESTE_ANIO_VACUNARON17, FECHA17) %>%
  rename(Unicdoe = UNICODE,
         Name = NOMBRE,
         Sex = SEXO,
         Years = EDAD_ANIO17,
         Months = EDAD_MESES17,
         Vaccine = ESTE_ANIO_VACUNARON17,
         Date = FECHA17) 

#2018 survey data
df_2018 <- read.csv("~/Rabies/rabia_ASA_encuesta_2018/resultados/PERRO_CLEAN_2018-08-31.csv") #2018 data
df_2018 <-df_2018%>%
  dplyr::select(PERRO_UNICODE, PERRO_NOMBRE, PERRO_SEXO, PERRO_EDAD_ANIO, 
                PERRO_EDAD_MES, PERRO_ESTE_ANIO_VACUNARON, PERRO_COMO_PERMANECE_CASA, PERRO_DATETIME) %>%
  rename(Unicode = PERRO_UNICODE, 
         Name = PERRO_NOMBRE, 
         Sex = PERRO_SEXO, 
         Years = PERRO_EDAD_ANIO, 
         Months = PERRO_EDAD_MES, 
         Vaccine = PERRO_ESTE_ANIO_VACUNARON, 
         Restriction = PERRO_COMO_PERMANECE_CASA,
         Date = PERRO_DATETIME) %>%
  mutate(Date = substr(as.character(Date), 1, 10))


#2019 survey data
df_2019 <- read.csv("~/Rabies/rabia_ASA_encuesta_2019/resultados/PERRO2019VANCAN_CLEAN_2019-12-10.csv") 
df_2019 <-df_2019%>%
  dplyr::select(PERRO_UNICODE, PERRO_NOMBRE, PERRO_SEXO, PERRO_EDAD_ANIO, 
                PERRO_EDAD_MES, PERRO_ESTE_ANIO_VACUNARON, PERRO_COMO_PERMANECE_CASA, PERRO_DATETIME) %>%
  rename(Unicode = PERRO_UNICODE, 
         Name = PERRO_NOMBRE, 
         Sex = PERRO_SEXO, 
         Years = PERRO_EDAD_ANIO, 
         Months = PERRO_EDAD_MES, 
         Vaccine = PERRO_ESTE_ANIO_VACUNARON, 
         Restriction = PERRO_COMO_PERMANECE_CASA,
         Date = PERRO_DATETIME) %>%
  mutate(Date = substr(as.character(Date), 1, 10),
         Months = as.numeric(as.character(Months)),
         Years = as.numeric(as.character(Years)))
```

#### Parameters
1. Known parameters
```{r}
DOG_POPN= 264550.2646 #Peru Ministry of Health estimate
GAMMA= 1/50 #Hampson 2009
NU2 = 1/365 #vaccine label
ETA = 0 #initial vaccination coverage, setting to 0 for simplicity and will have first vancan on day 1
RHO = 0.1 #assumption- reporting rate
MODEL_TYPE= 1 #frequeny dependent
```

2. $\mu$ (background death rate)
```{r}
df_2019 <- df_2019 %>% 
  mutate(Age = Years*365.25 + Months*30.4375)
MU <- 1/t.test(df_2019$Age)$estimate[[1]] #Mean: 1099.203 [1063.346, 1135.060] 
```

3. $\alpha$	(infectious period)
```{r}
df$Infectious <- df$Death_date - df$Symptoms_date
ALPHA <- 1/t.test(df$Infectious)$estimate[[1]] #2.534247 [1.931721, 3.136772]
#Infectious dates reasonable, faily good data, matches with Katie Hampson's findings
```

4. $\nu$ vaccination coverage
```{r}
# #2016 
# plyr::count(df_2016$Vaccine) #0.6147823
# plyr::count(df_2016$Date) #Mode= June 12
# 
# #2017
# plyr::count(df_2017$Vaccine) #0.4989594
# plyr::count(df_2017$Date) #Mode= September 22
# 
# #2018
# plyr::count(df_2018$Vaccine) #0.5285256
# plyr::count(df_2018$Date) #Mode= August 6
# 
# #2019
# plyr::count(df_2019$Vaccine) #0.5850053
# plyr::count(df_2019$Date) #Mode= October 2

#Build table
NU1 <- data.frame(year=c(2016,2017,2018,2019), 
                 date=as.Date(c("2016-06-12", "2017-09-22", "2018-08-06", "2019-10-02")),
                 vax=c(0.615, 0.499, 0.529, 0.585))

```

5. $R_{0}$
```{r}
#fit to epidemic data
R_NAUGHT=1.44 #Ref paper
```

#### Deterministic Model
```{r}
#Parameters
params <- c(R0= R_NAUGHT, #Bite: 1.366061, #Age:2.487201
            m = MU,#mu (normal death rate)
            g = GAMMA, #gamma (latency rate)
            a = ALPHA, #alpha (death rate attributable to rabies)
            u = NU2, #1 yr vaccine
            eta= ETA, #initial vaccine coverage --- (have vancan start at d1)
            N =DOG_POPN, #2645.503, #Do we want this to be density (per km2) or total
            rho = RHO, #Reporting rate
            d2= 1) #delta2, density dependency weight [1 (freq), 0 (dens)] 
params["d"] <- 1/params["N"] + params["d2"]*((params["N"]-1)/params["N"]) #model type weight: frequency vs density dependent
params["beta"] <-params["R0"]*params["d"]*(params["g"]+params["m"])*(params["a"]+params["m"])/params["g"]

#Initial conditions
init <- NULL # popn initial values
init["S"] <- (params["N"]-1)*(1-params["eta"]) 
init["E"] <- 1
init["I"] <- 0
init["R"] <- (params["N"]-1)*params["eta"]
init["H"] <- 0 #Accumulator variable

#Time dependent vaccination pulses for the yearly vaccination campaign
times <- seq(0, 2557, by = 1) #time series for model
signal <- data.frame(times = times, vax = rep(0, length(times))) #artificial time series

#####FIX THIS PART######
#specify vaccination coverage
signal$vax[1]    <- -log(1-0.4898) #2014-03-16 ***Earliest year we have data from Sergio
signal$vax[366]  <- -log(1-0.4898) #2015-03-16 ***Reproted 92.54% coverage ---> don't believe, using 2014
signal$vax[820]  <- -log(1-0.6148) #2016-06-12
signal$vax[1287] <- -log(1-0.4990) #2017-09-22
signal$vax[1605] <- -log(1-0.5285) #2018-08-06
signal$vax[2049] <- -log(1-0.5850) #2019-10-24
########################
input <- approxfun(signal)#Interpolating fx

#deterministic model description
disease_dynamics <- function(times, state, params) {
  with(
    as.list(c(state, params)), {
      vax <- input(times)
      
      ##Equations (easy to read)
      dS <- (m*N + a*I) - beta*I*S/(d*N) - m*S -vax*S + u*R
      dE <- beta*S*I/(d*N) - g*E - m*E
      dI <- g*E -a*I - m*I
      dR <- vax*S - u*R - m*R
      dH <- beta*S*I/(d*N) #Acummulator variable- just a count of all cases moving into I
      return(list(c(dS, dE, dI, dR, dH), signal=vax))
    }
  )
}

#Run model
out <- as.data.frame(ode(y = init, times = times, func = disease_dynamics, parms = params))
RESULTS<-data.frame(out$S, out$E, out$I, out$R, out$H) #results
RESULTS$date <-seq(as.Date("2014/03/16"), as.Date("2021/03/16"), "days")

#Convert model results to accumulated incidence
RESULTS <- RESULTS %>%
  mutate(diffH = out.H - lag(out.H))
RESULTS$diffH[is.na(RESULTS$diffH)] <- 0 #set dates don't have date for as 0 (I.e beginning and end)
RESULTS$Date <- seq(as.Date("2014/03/16"), as.Date("2021/03/16"), "days") #Create ref of days
rabies.stim <- data.table::setDT(RESULTS)[, .(Incidence = sum(diffH)), by = .(yr = data.table::year(Date), mon = months(Date))] #count incidence by month
rabies$stim <- rabies.stim$Incidence #Match stim incidence with actual incidence df
rabies$stim_reports <- rabies$stim#*params["rho"] #scale down stim reports by reporting percent


```

#### Stochastic model

1. code based on: https://daphnia.ecology.uga.edu/drakelab/wp-content/uploads/2016/07/sismid-stochastic-lecture.pdf

TO DO:
- adjust models to fit rabies system
-

```{r}
#function to calculate one step of stochastic SIR
SIR.onestep <- function (x, params) { 
  X <- x[2] #local variable for susceptibles
  Y <- x[3] #local variable for infecteds
  Z <- x[4] #local variable for recovereds
  N <- X+Y+Z #total population size (subject to demographic change) 
  with( #use with as in deterministic model to simplify code
    as.list(params),
      {
      total.rate <- mu*N+beta*X*Y/N+mu*X+mu*Y+gamma*Y+mu*Z #calculate ``total rate''
      tau <- rexp(n=1,rate=total.rate) #inter-event time
      new.xyz <- c(X,Y,Z) #initialize a local variable at previous state variable values
      U <- runif(1) #uniform random deviate
      new.xyz<-c(X,Y,Z-1) #death of recovered id ``default''
      if (U<=(mu*N+beta*X*Y/N+mu*X+gamma*Y+mu*Y)/total.rate) new.xyz<-c(X,Y-1,Z) #death of infected
      if (U<=(mu*N+beta*X*Y/N+mu*X+gamma*Y)/total.rate) new.xyz<-c(X,Y-1,Z+1) #recovery of infected
      if (U<=(mu*N+beta*X*Y/N+mu*X)/total.rate) new.xyz<-c(X-1,Y,Z) #death of a susceptible
      if (U<=(mu*N+beta*X*Y/N)/total.rate) new.xyz<-c(X-1,Y+1,Z) #transmission event
      if (U<=(mu*N/total.rate)) new.xyz<-c(X+1, Y, Z) #birth of susceptible
      c(tau,new.xyz) #store result
    }
  )
}

#function to simulate stochastic SIR
SIR.model <- function (x, params, nstep) { 
  output <- array(dim=c(nstep+1,4)) #set up array to store results
  colnames(output) <- c("time","X","Y","Z") #name variables
  output[1,] <- x #first record of output is initial condition
  for (k in 1:nstep) { #iterate for nstep steps
    output[k+1,] <- x <- SIR.onestep(x,params)
  }
output #return output
}

#Call SIR model to simulate
set.seed(1234) #set seed

nsims <- 10 #number of simulations
pop.size <- 10000 #total population size
Y0 <- 50 #initial number infected
X0 <- round(0.98*pop.size) #initial number suscepitlble (~98% of population)

nstep <- 16000 #number of events to simulate
xstart <- c(time=0,X=X0,Y=Y0,Z=pop.size-X0-Y0) #initial conditions
params <- list(mu=0.00001,beta=60,gamma=365/13)#parameters
data <- vector(mode='list',length=nsims) #initialize list to store the output
for (k in 1:nsims) { #simulate nsims times
  data[[k]] <- as.data.frame(SIR.model(xstart,params,nstep))
  data[[k]]$cum.time <- cumsum(data[[k]]$time)
}
max.time<-data[[1]]$cum.time[max(which(data[[1]]$Y>0))] #maximum time in first simulation
max.y<-1.8*max(data[[1]]$Y) #find max infected in run 1 and increase by 80% for plot

```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

#### Epidemiologic  data exploration
```{r}
fig1 <- ggplot() +
  theme_classic()+
  geom_col(data = rabies, aes(x=month, y=reports))+
  scale_x_discrete(breaks=seq(0, max(rabies$month)+1, 1),
                   limits=seq(0, max(rabies$month)+1, 4))+
  scale_y_discrete(breaks=seq(0, max(rabies$reports)+1, 1),
                   limits=seq(0, max(rabies$reports)+1, 1))+
  xlab("Month") + ylab("New rabies cases")+
  ggtitle("Arequipa rabies epi curve")
fig1

```

#### Deterministic model results
```{r}
#plot whole system dynamics
p1 <- ggplot()+
  theme_classic()+ #white background w/ out grid
  geom_line(data=RESULTS, aes(x=date, y=out.S, color="Susceptible"))+
  geom_line(data=RESULTS, aes(x=date, y=out.E, color="Exposed"))+
  geom_line(data=RESULTS, aes(x=date, y=out.I, color="Infectious"))+
  geom_line(data=RESULTS, aes(x=date, y=out.R, color="Vaccinated"))+
  scale_x_date(date_breaks= "1 year", date_labels="%Y", limits=c(as.Date("2014-03-16", "%Y"), as.Date("2020", "%Y")))+
   scale_y_continuous(labels = function(l) {
     trans = l / 1000
     paste0(trans, "k")
     })+
  ggtitle(" ") + #title label
  scale_color_manual(values = c(
    'Susceptible' = 'gold',
    'Exposed' = 'pink',
    'Infectious' = 'red',
    'Vaccinated' = 'blue'),
    name= "Diease state") +
  labs(y= "Number of dogs", x = "Time (days)") #axis labels
p1

#Plot of incidence real vs stim
p2 <- ggplot()+
  theme_classic()+ #white background w/ out grid
  geom_col(data = rabies, aes(x=month, y=reports, fill="Reported rabies cases", alpha="Reported rabies cases"), width=0.75)+
  geom_col(data = rabies, aes(x=month, y=stim_reports, fill="Simulated cases reported", alpha="Simulated cases reported"),  width= 0.75)+
  ggtitle("Rabies cases") + #title label
  #scale_x_date(date_breaks= "2 months", date_labels="%Y", limits=c(as.Date("2014-03-16", "%Y"), as.Date("2020", "%Y")))+
  scale_fill_manual(values = c(
      'Reported rabies cases' = 'red',
      'Simulated cases reported' = 'blue'),
       name= "Reported cases") +
  scale_alpha_manual(values = c(
    'Reported rabies cases' = 0.5,
    'Simulated cases reported' = 0.5),
    name= "Reported cases") +
  labs(y= "Number of reports", x = "Time (month)") #axis labels
p2


```

#### Stochastic model results

TO DO:
-convert plots to ggplot
-add in background incidence 


```{r}
#plot
plot(Y~cum.time,data=data[[1]],xlab='Time',ylab='Incidence',col=1,xlim=c(0,max.time),ylim=c(0,max.y), type='l', axes=FALSE)
box()
axis(2, cex.axis=0.8, las=2)
for (k in 1:nsims) { #add multiple epidemics to plot
  lines(Y~cum.time,data=data[[k]],col=k,type='l')
}

```